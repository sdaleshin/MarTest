// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function zlibBuffer(e,t,n){function s(){var t;while(null!==(t=e.read()))r.push(t),i+=t.length;e.once("readable",s)}function o(t){e.removeListener("end",u),e.removeListener("readable",s),n(t)}function u(){var e=Buffer.concat(r,i);r=[],n(null,e)}var r=[],i=0;e.on("error",o),e.on("end",u),e.end(t),s()}function Deflate(e){if(!(this instanceof Deflate))return new Deflate(e);Zlib.call(this,e,binding.DEFLATE)}function Inflate(e){if(!(this instanceof Inflate))return new Inflate(e);Zlib.call(this,e,binding.INFLATE)}function Gzip(e){if(!(this instanceof Gzip))return new Gzip(e);Zlib.call(this,e,binding.GZIP)}function Gunzip(e){if(!(this instanceof Gunzip))return new Gunzip(e);Zlib.call(this,e,binding.GUNZIP)}function DeflateRaw(e){if(!(this instanceof DeflateRaw))return new DeflateRaw(e);Zlib.call(this,e,binding.DEFLATERAW)}function InflateRaw(e){if(!(this instanceof InflateRaw))return new InflateRaw(e);Zlib.call(this,e,binding.INFLATERAW)}function Unzip(e){if(!(this instanceof Unzip))return new Unzip(e);Zlib.call(this,e,binding.UNZIP)}function Zlib(e,t){this._opts=e=e||{},this._chunkSize=e.chunkSize||exports.Z_DEFAULT_CHUNK,Transform.call(this,e),this._readableState.chunkSize=null;if(e.chunkSize)if(e.chunkSize<exports.Z_MIN_CHUNK||e.chunkSize>exports.Z_MAX_CHUNK)throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits)if(e.windowBits<exports.Z_MIN_WINDOWBITS||e.windowBits>exports.Z_MAX_WINDOWBITS)throw new Error("Invalid windowBits: "+e.windowBits);if(e.level)if(e.level<exports.Z_MIN_LEVEL||e.level>exports.Z_MAX_LEVEL)throw new Error("Invalid compression level: "+e.level);if(e.memLevel)if(e.memLevel<exports.Z_MIN_MEMLEVEL||e.memLevel>exports.Z_MAX_MEMLEVEL)throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=exports.Z_FILTERED&&e.strategy!=exports.Z_HUFFMAN_ONLY&&e.strategy!=exports.Z_RLE&&e.strategy!=exports.Z_FIXED&&e.strategy!=exports.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!Buffer.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._binding=new binding.Zlib(t);var n=this;this._hadError=!1,this._binding.onerror=function(e,t){n._binding=null,n._hadError=!0;var r=new Error(e);r.errno=t,r.code=exports.codes[t],n.emit("error",r)},this._binding.init(e.windowBits||exports.Z_DEFAULT_WINDOWBITS,e.level||exports.Z_DEFAULT_COMPRESSION,e.memLevel||exports.Z_DEFAULT_MEMLEVEL,e.strategy||exports.Z_DEFAULT_STRATEGY,e.dictionary),this._buffer=new Buffer(this._chunkSize),this._offset=0,this._closed=!1,this.once("end",this.close)}var Transform=require("./lib/_stream_transform.js"),binding=process.binding("zlib"),util=require("util"),assert=require("assert").ok;binding.Z_MIN_WINDOWBITS=8,binding.Z_MAX_WINDOWBITS=15,binding.Z_DEFAULT_WINDOWBITS=15,binding.Z_MIN_CHUNK=64,binding.Z_MAX_CHUNK=Infinity,binding.Z_DEFAULT_CHUNK=16384,binding.Z_MIN_MEMLEVEL=1,binding.Z_MAX_MEMLEVEL=9,binding.Z_DEFAULT_MEMLEVEL=8,binding.Z_MIN_LEVEL=-1,binding.Z_MAX_LEVEL=9,binding.Z_DEFAULT_LEVEL=binding.Z_DEFAULT_COMPRESSION,Object.keys(binding).forEach(function(e){e.match(/^Z/)&&(exports[e]=binding[e])}),exports.codes={Z_OK:binding.Z_OK,Z_STREAM_END:binding.Z_STREAM_END,Z_NEED_DICT:binding.Z_NEED_DICT,Z_ERRNO:binding.Z_ERRNO,Z_STREAM_ERROR:binding.Z_STREAM_ERROR,Z_DATA_ERROR:binding.Z_DATA_ERROR,Z_MEM_ERROR:binding.Z_MEM_ERROR,Z_BUF_ERROR:binding.Z_BUF_ERROR,Z_VERSION_ERROR:binding.Z_VERSION_ERROR},Object.keys(exports.codes).forEach(function(e){exports.codes[exports.codes[e]]=e}),exports.Deflate=Deflate,exports.Inflate=Inflate,exports.Gzip=Gzip,exports.Gunzip=Gunzip,exports.DeflateRaw=DeflateRaw,exports.InflateRaw=InflateRaw,exports.Unzip=Unzip,exports.createDeflate=function(e){return new Deflate(e)},exports.createInflate=function(e){return new Inflate(e)},exports.createDeflateRaw=function(e){return new DeflateRaw(e)},exports.createInflateRaw=function(e){return new InflateRaw(e)},exports.createGzip=function(e){return new Gzip(e)},exports.createGunzip=function(e){return new Gunzip(e)},exports.createUnzip=function(e){return new Unzip(e)},exports.deflate=function(e,t){zlibBuffer(new Deflate,e,t)},exports.gzip=function(e,t){zlibBuffer(new Gzip,e,t)},exports.deflateRaw=function(e,t){zlibBuffer(new DeflateRaw,e,t)},exports.unzip=function(e,t){zlibBuffer(new Unzip,e,t)},exports.inflate=function(e,t){zlibBuffer(new Inflate,e,t)},exports.gunzip=function(e,t){zlibBuffer(new Gunzip,e,t)},exports.inflateRaw=function(e,t){zlibBuffer(new InflateRaw,e,t)},util.inherits(Zlib,Transform),Zlib.prototype.reset=function(){return this._binding.reset()},Zlib.prototype._flush=function(e,t){var n=this._readableState,r=this;this._transform(null,e,function(e){if(e)return t(e);n.length&&n.length<n.lowWaterMark&&!n.ended&&n.needReadable&&r.emit("readable"),t()})},Zlib.prototype.flush=function(e){var t=this._writableState,n=this._transformState;if(t.writing){t.needDrain=!0;var r=this;this.once("drain",function(){r._flush(n.output,e)});return}this._flush(n.output,e||function(){})},Zlib.prototype.close=function(e){e&&process.nextTick(e);if(this._closed)return;this._closed=!0,this._binding.close();var t=this;process.nextTick(function(){t.emit("close")})},Zlib.prototype._transform=function(e,t,n){function h(i,s,o){if(c._hadError)return;var l=a-s;assert(l>=0,"have should not go down");if(l>0){var p=c._buffer.slice(c._offset,c._offset+l);c._offset+=l,t(p)}if(s===0||c._offset>=c._chunkSize)a=c._chunkSize,c._offset=0,c._buffer=new Buffer(c._chunkSize);if(s===0){f+=u-i,u=i;var d=c._binding.write(r,e,f,u,c._buffer,c._offset,c._chunkSize);d.callback=h,d.buffer=e;return}n()}var r,i=this._writableState,s=i.ending||i.ended,o=s&&(!e||i.length===e.length);if(e!==null&&!Buffer.isBuffer(e))return n(new Error("invalid input"));o?r=binding.Z_FINISH:e===null?r=binding.Z_FULL_FLUSH:r=binding.Z_NO_FLUSH;var u=e&&e.length,a=this._chunkSize-this._offset,f=0,l=this._binding.write(r,e,f,u,this._buffer,this._offset,a);l.buffer=e,l.callback=h;var c=this},util.inherits(Deflate,Zlib),util.inherits(Inflate,Zlib),util.inherits(Gzip,Zlib),util.inherits(Gunzip,Zlib),util.inherits(DeflateRaw,Zlib),util.inherits(InflateRaw,Zlib),util.inherits(Unzip,Zlib);