function Form(e){var t=this;stream.Writable.call(t),e=e||{},t.error=null,t.finished=!1,t.autoFields=!!e.autoFields,t.autoFiles=!!e.autoFields,t.maxFields=e.maxFields||1e3,t.maxFieldsSize=e.maxFieldsSize||2097152,t.uploadDir=e.uploadDir||os.tmpDir(),t.encoding=e.encoding||"utf8",t.hash=e.hash||!1,t.bytesReceived=0,t.bytesExpected=null,t.openedFiles=[],t.totalFieldSize=0,t.totalFieldCount=0,t.flushing=0,t.backpressure=!1,t.writeCbs=[],e.boundary&&setUpParser(t,e.boundary),t.on("newListener",function(e){e==="file"?t.autoFiles=!0:e==="field"&&(t.autoFields=!0)})}function flushWriteCbs(e){e.writeCbs.forEach(function(e){process.nextTick(e)}),e.writeCbs=[],e.backpressure=!1}function getBytesExpected(e){var t=e["content-length"];return t?parseInt(t,10):e["transfer-encoding"]==null?0:null}function beginFlush(e){e.flushing+=1}function endFlush(e){e.flushing-=1,maybeClose(e)}function maybeClose(e){!e.flushing&&e.finished&&!e.error&&e.emit("close")}function handleFile(e,t){beginFlush(e);var n={fieldName:t.name,originalFilename:t.filename,path:uploadPath(e.uploadDir,t.filename),headers:t.headers};n.ws=fs.createWriteStream(n.path),e.openedFiles.push(n),t.pipe(n.ws);var r=new StreamCounter;t.pipe(r);var i,s=null;e.hash&&(i=stream.Writable(),s=crypto.createHash(e.hash),i._write=function(e,t,n){s.update(e),n()},t.pipe(i)),n.ws.on("error",function(t){e.error||e.handleError(t)}),n.ws.on("close",function(){s&&(n.hash=s.digest("hex")),n.size=r.bytes,e.emit("file",t.name,n),endFlush(e)})}function handleField(e,t){var n="",r=new StringDecoder(e.encoding);beginFlush(e),t.on("readable",function(){var i=t.read();if(!i)return;e.totalFieldSize+=i.length;if(e.totalFieldSize>e.maxFieldsSize){e.handleError(new Error("maxFieldsSize "+e.maxFieldsSize+" exceeded"));return}n+=r.write(i)}),t.on("end",function(){e.emit("field",t.name,n),endFlush(e)})}function clearPartVars(e){e.partHeaders={},e.partName=null,e.partFilename=null,e.partTransferEncoding="binary",e.destStream=null,e.headerFieldDecoder=new StringDecoder(e.encoding),e.headerField="",e.headerValueDecoder=new StringDecoder(e.encoding),e.headerValue=""}function setUpParser(e,t){e.boundary=new Buffer(t.length+4),e.boundary.write("\r\n--",0,t.length+4,"ascii"),e.boundary.write(t,4,t.length,"ascii"),e.lookbehind=new Buffer(e.boundary.length+8),e.state=START,e.boundaryChars={};for(var n=0;n<e.boundary.length;n++)e.boundaryChars[e.boundary[n]]=!0;e.index=null,e.partBoundaryFlag=!1,e.lastBoundaryFlag=!1,e.on("finish",function(){e.state===HEADER_FIELD_START&&e.index===0||e.state===PART_DATA&&e.index===e.boundary.length?e.onParsePartEnd():e.state!==END&&e.handleError(new Error("stream ended unexpectedly")),e.finished=!0,maybeClose(e)})}function uploadPath(e,t){var n=path.extname(t).replace(FILE_EXT_RE,"$1"),r=process.pid+"-"+(Math.random()*4294967296+1).toString(36)+n;return path.join(e,r)}function parseFilename(e){var t=e.match(/\bfilename="(.*?)"($|; )/i);if(!t)return;var n=t[1].substr(t[1].lastIndexOf("\\")+1);return n=n.replace(/%22/g,'"'),n=n.replace(/&#([\d]{4});/g,function(e,t){return String.fromCharCode(t)}),n}function lower(e){return e|32}exports.Form=Form;var stream=require("readable-stream"),util=require("util"),fs=require("fs"),crypto=require("crypto"),path=require("path"),os=require("os"),StringDecoder=require("string_decoder").StringDecoder,StreamCounter=require("stream-counter"),START=0,START_BOUNDARY=1,HEADER_FIELD_START=2,HEADER_FIELD=3,HEADER_VALUE_START=4,HEADER_VALUE=5,HEADER_VALUE_ALMOST_DONE=6,HEADERS_ALMOST_DONE=7,PART_DATA_START=8,PART_DATA=9,PART_END=10,END=11,LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,CONTENT_TYPE_RE=/^multipart\/(form-data|related);\s*boundary=(?:"([^"]+)"|([^;]+))$/i,FILE_EXT_RE=/(\.[_\-a-zA-Z0-9]{0,16}).*/,LAST_BOUNDARY_SUFFIX_LEN=4;util.inherits(Form,stream.Writable),Form.prototype.parse=function(e,t){function l(){n.emit("aborted"),c(new Error("Request aborted"))}function c(t){var r=!n.error;r&&(n.error=t,e.removeListener("aborted",l),e.unpipe&&e.unpipe(n)),n.openedFiles.forEach(function(e){e.ws.destroy(),fs.unlink(e.path,function(e){})}),n.openedFiles=[],r&&n.emit("error",t)}var n=this;t&&(n.autoFields=!0,n.autoFiles=!0),n.handleError=c,n.bytesExpected=getBytesExpected(e.headers),e.on("error",c),e.on("aborted",l);var r=e.headers["content-type"];if(!r){c(new Error("missing content-type header"));return}var i=r.match(CONTENT_TYPE_RE);if(!i){c(new Error("unrecognized content-type: "+r));return}var s=i[2]||i[3];setUpParser(n,s),e.pipe(n);if(t){var o={},u={},a=[],f=[];n.on("error",function(e){t(e)}),n.on("field",function(e,t){o[e]=t,a.push({name:e,value:t})}),n.on("file",function(e,t){u[e]=t,f.push(t)}),n.on("close",function(){t(null,o,u,a,f)})}},Form.prototype._write=function(e,t,n){var r=this,i=0,s=e.length,o=r.index,u=r.index,a=r.state,f=r.lookbehind,l=r.boundary,c=r.boundaryChars,h=r.boundary.length,p=h-1,d=e.length,v,m;for(i=0;i<s;i++){v=e[i];switch(a){case START:u=0,a=START_BOUNDARY;case START_BOUNDARY:if(u===h-2){if(v!==CR)return r.handleError(new Error("Expected CR Received "+v));u++;break}if(u===h-1){if(v!==LF)return r.handleError(new Error("Expected LF Received "+v));u=0,r.onParsePartBegin(),a=HEADER_FIELD_START;break}v!==l[u+2]&&(u=-2),v===l[u+2]&&u++;break;case HEADER_FIELD_START:a=HEADER_FIELD,r.headerFieldMark=i,u=0;case HEADER_FIELD:if(v===CR){r.headerFieldMark=null,a=HEADERS_ALMOST_DONE;break}u++;if(v===HYPHEN)break;if(v===COLON){if(u===1){r.handleError(new Error("Empty header field"));return}r.onParseHeaderField(e.slice(r.headerFieldMark,i)),r.headerFieldMark=null,a=HEADER_VALUE_START;break}m=lower(v);if(m<A||m>Z){r.handleError(new Error("Expected alphabetic character, received "+v));return}break;case HEADER_VALUE_START:if(v===SPACE)break;r.headerValueMark=i,a=HEADER_VALUE;case HEADER_VALUE:v===CR&&(r.onParseHeaderValue(e.slice(r.headerValueMark,i)),r.headerValueMark=null,r.onParseHeaderEnd(),a=HEADER_VALUE_ALMOST_DONE);break;case HEADER_VALUE_ALMOST_DONE:if(v!==LF)return r.handleError(new Error("Expected LF Received "+v));a=HEADER_FIELD_START;break;case HEADERS_ALMOST_DONE:if(v!==LF)return r.handleError(new Error("Expected LF Received "+v));var g=r.onParseHeadersEnd(i+1);if(g)return r.handleError(g);a=PART_DATA_START;break;case PART_DATA_START:a=PART_DATA,r.partDataMark=i;case PART_DATA:o=u;if(u===0){i+=p;while(i<d&&!(e[i]in c))i+=h;i-=p,v=e[i]}if(u<h)l[u]===v?(u===0&&(r.onParsePartData(e.slice(r.partDataMark,i)),r.partDataMark=null),u++):u=0;else if(u===h)u++,v===CR?r.partBoundaryFlag=!0:v===HYPHEN?r.lastBoundaryFlag=!0:u=0;else if(u-1===h)if(r.partBoundaryFlag){u=0;if(v===LF){r.partBoundaryFlag=!1,r.onParsePartEnd(),r.onParsePartBegin(),a=HEADER_FIELD_START;break}}else r.lastBoundaryFlag?v===HYPHEN?(r.onParsePartEnd(),r.end(),a=END):u=0:u=0;u>0?f[u-1]=v:o>0&&(r.onParsePartData(f.slice(0,o)),o=0,r.partDataMark=i,i--);break;case END:break;default:r.handleError(new Error("Parser has invalid state."));return}}r.headerFieldMark!=null&&(r.onParseHeaderField(e.slice(r.headerFieldMark)),r.headerFieldMark=0),r.headerValueMark!=null&&(r.onParseHeaderValue(e.slice(r.headerValueMark)),r.headerValueMark=0),r.partDataMark!=null&&(r.onParsePartData(e.slice(r.partDataMark)),r.partDataMark=0),r.index=u,r.state=a,r.bytesReceived+=e.length,r.emit("progress",r.bytesReceived,r.bytesExpected),r.backpressure?r.writeCbs.push(n):n()},Form.prototype.onParsePartBegin=function(){clearPartVars(this)},Form.prototype.onParseHeaderField=function(e){this.headerField+=this.headerFieldDecoder.write(e)},Form.prototype.onParseHeaderValue=function(e){this.headerValue+=this.headerValueDecoder.write(e)},Form.prototype.onParseHeaderEnd=function(){this.headerField=this.headerField.toLowerCase(),this.partHeaders[this.headerField]=this.headerValue;var e;if(this.headerField==="content-disposition"){if(e=this.headerValue.match(/\bname="([^"]+)"/i))this.partName=e[1];this.partFilename=parseFilename(this.headerValue)}else this.headerField==="content-transfer-encoding"&&(this.partTransferEncoding=this.headerValue.toLowerCase());this.headerFieldDecoder=new StringDecoder(this.encoding),this.headerField="",this.headerValueDecoder=new StringDecoder(this.encoding),this.headerValue=""},Form.prototype.onParsePartData=function(e){this.partTransferEncoding==="base64"?this.backpressure=!this.destStream.write(e.toString("ascii"),"base64"):this.backpressure=!this.destStream.write(e)},Form.prototype.onParsePartEnd=function(){if(this.destStream){flushWriteCbs(this);var e=this.destStream;process.nextTick(function(){e.end()})}clearPartVars(this)},Form.prototype.onParseHeadersEnd=function(e){var t=this;switch(t.partTransferEncoding){case"binary":case"7bit":case"8bit":t.partTransferEncoding="binary";break;case"base64":break;default:return new Error("unknown transfer-encoding: "+t.partTransferEncoding)}t.totalFieldCount+=1;if(t.totalFieldCount>=t.maxFields)return new Error("maxFields "+t.maxFields+" exceeded.");t.destStream=new stream.PassThrough,t.destStream.on("drain",function(){flushWriteCbs(t)}),t.destStream.headers=t.partHeaders,t.destStream.name=t.partName,t.destStream.filename=t.partFilename,t.destStream.byteOffset=t.bytesReceived+e;var n=t.destStream.headers["content-length"];t.destStream.byteCount=n?parseInt(n,10):t.bytesExpected-t.destStream.byteOffset-t.boundary.length-LAST_BOUNDARY_SUFFIX_LEN,t.emit("part",t.destStream),t.destStream.filename==null&&t.autoFields?handleField(t,t.destStream):t.destStream.filename!=null&&t.autoFiles&&handleFile(t,t.destStream)};