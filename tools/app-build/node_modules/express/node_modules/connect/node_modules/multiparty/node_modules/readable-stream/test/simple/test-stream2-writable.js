// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function TestWriter(){W.apply(this,arguments),this.buffer=[],this.written=0}function test(e,t){count++,tests.push([e,t])}function run(){var e=tests.shift();if(!e)return console.error("ok");var t=e[0],n=e[1];console.log("# %s",t),n({same:assert.deepEqual,equal:assert.equal,end:function(){count--,run()}})}var common=require("../common.js"),W=require("../../").Writable,D=require("../../").Duplex,assert=require("assert"),util=require("util");util.inherits(TestWriter,W),TestWriter.prototype._write=function(e,t,n){setTimeout(function(){this.buffer.push(e.toString()),this.written+=e.length,n()}.bind(this),Math.floor(Math.random()*10))};var chunks=new Array(50);for(var i=0;i<chunks.length;i++)chunks[i]=(new Array(i+1)).join("x");var tests=[],count=0;process.on("exit",function(){assert.equal(count,0)}),process.nextTick(run),test("write fast",function(e){var t=new TestWriter({highWaterMark:100});t.on("finish",function(){e.same(t.buffer,chunks,"got chunks in the right order"),e.end()}),chunks.forEach(function(e){t.write(e)}),t.end()}),test("write slow",function(e){var t=new TestWriter({highWaterMark:100});t.on("finish",function(){e.same(t.buffer,chunks,"got chunks in the right order"),e.end()});var n=0;(function r(){t.write(chunks[n++]),n<chunks.length?setTimeout(r,10):t.end()})()}),test("write backpressure",function(e){var t=new TestWriter({highWaterMark:50}),n=0;t.on("finish",function(){e.same(t.buffer,chunks,"got chunks in the right order"),e.equal(n,17),e.end()}),t.on("drain",function(){n++});var r=0;(function i(){do var e=t.write(chunks[r++]);while(e!==!1&&r<chunks.length);r<chunks.length?(assert(t._writableState.length>=50),t.once("drain",i)):t.end()})()}),test("write bufferize",function(e){var t=new TestWriter({highWaterMark:100}),n=["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le",undefined];t.on("finish",function(){e.same(t.buffer,chunks,"got the expected chunks")}),chunks.forEach(function(e,r){var i=n[r%n.length];e=new Buffer(e),t.write(e.toString(i),i)}),e.end()}),test("write no bufferize",function(e){var t=new TestWriter({highWaterMark:100,decodeStrings:!1});t._write=function(e,t,n){return assert(typeof e=="string"),e=new Buffer(e,t),TestWriter.prototype._write.call(this,e,t,n)};var n=["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le",undefined];t.on("finish",function(){e.same(t.buffer,chunks,"got the expected chunks")}),chunks.forEach(function(e,r){var i=n[r%n.length];e=new Buffer(e),t.write(e.toString(i),i)}),e.end()}),test("write callbacks",function(e){var t=chunks.map(function(e,n){return[n,function(r){t._called[n]=e}]}).reduce(function(e,t){return e["callback-"+t[0]]=t[1],e},{});t._called=[];var n=new TestWriter({highWaterMark:100});n.on("finish",function(){process.nextTick(function(){e.same(n.buffer,chunks,"got chunks in the right order"),e.same(t._called,chunks,"called all callbacks"),e.end()})}),chunks.forEach(function(e,r){n.write(e,t["callback-"+r])}),n.end()}),test("end callback",function(e){var t=new TestWriter;t.end(function(){e.end()})}),test("end callback with chunk",function(e){var t=new TestWriter;t.end(new Buffer("hello world"),function(){e.end()})}),test("end callback with chunk and encoding",function(e){var t=new TestWriter;t.end("hello world","ascii",function(){e.end()})}),test("end callback after .write() call",function(e){var t=new TestWriter;t.write(new Buffer("hello world")),t.end(function(){e.end()})}),test("end callback called after write callback",function(e){var t=new TestWriter,n=!1;t.write(new Buffer("hello world"),function(){n=!0}),t.end(function(){e.equal(n,!0),e.end()})}),test("encoding should be ignored for buffers",function(e){var t=new W,n="018b5e9a8f6236ffe30e31baf80d2cf6eb";t._write=function(t,r,i){e.equal(t.toString("hex"),n),e.end()};var r=new Buffer(n,"hex");t.write(r,"binary")}),test("writables are not pipable",function(e){var t=new W;t._write=function(){};var n=!1;t.on("error",function(e){n=!0}),t.pipe(process.stdout),assert(n),e.end()}),test("duplexes are pipable",function(e){var t=new D;t._read=function(){},t._write=function(){};var n=!1;t.on("error",function(e){n=!0}),t.pipe(process.stdout),assert(!n),e.end()}),test("end(chunk) two times is an error",function(e){var t=new W;t._write=function(){};var n=!1;t.on("error",function(t){n=!0,e.equal(t.message,"write after end")}),t.end("this is the end"),t.end("and so is this"),process.nextTick(function(){assert(n),e.end()})}),test("dont end while writing",function(e){var t=new W,n=!1;t._write=function(e,t,r){assert(!this.writing),n=!0,this.writing=!0,setTimeout(function(){this.writing=!1,r()})},t.on("finish",function(){assert(n),e.end()}),t.write(Buffer(0)),t.end()}),test("finish does not come before write cb",function(e){var t=new W,n=!1;t._write=function(e,t,r){setTimeout(function(){n=!0,r()},10)},t.on("finish",function(){assert(n),e.end()}),t.write(Buffer(0)),t.end()}),test("finish does not come before sync _write cb",function(e){var t=new W,n=!1;t._write=function(e,t,n){n()},t.on("finish",function(){assert(n),e.end()}),t.write(Buffer(0),function(e){n=!0}),t.end()});