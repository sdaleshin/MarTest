var assert=require("assert"),multiparty=require("../../"),http=require("http"),path=require("path"),TMP_PATH=path.join(__dirname,"..","tmp"),server=http.createServer(function(e,t){var n=new multiparty.Form;n.uploadDir=TMP_PATH,n.on("close",function(){throw new Error('Unexpected "close" event')}),n.on("end",function(){throw new Error('Unexpected "end" event')}),n.on("error",function(e){t.writeHead(500),t.end(e.message)}),n.parse(e)});server.listen(0,function(){var e='--foo\r\nContent-Disposition: form-data; name="file1"; filename="file1"\r\nContent-Type: application/octet-stream\r\n\r\nThis is the first file\r\n--foo\r\nContent-Type: application/octet-stream\r\nContent-Disposition: form-data; name="file2"; filename="file2"\r\nContent-Transfer-Encoding: unknown\r\n\r\nThis is the second file\r\n--foo--\r\n',t=http.request({method:"POST",port:server.address().port,headers:{"Content-Length":e.length,"Content-Type":"multipart/form-data; boundary=foo"}});t.on("response",function(e){assert.equal(e.statusCode,500),e.on("data",function(){}),e.on("end",function(){server.close()})}),t.end(e)});