// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function TestReader(e){R.apply(this),this._buffer=new Buffer(e||100),this._buffer.fill("x"),this._pos=0,this._bufs=10}function TestWriter(){EE.apply(this),this.received=[],this.flush=!1}function test(e,t){count++,tests.push([e,t])}function run(){var e=tests.shift();if(!e)return console.error("ok");var t=e[0],n=e[1];console.log("# %s",t),n({same:assert.deepEqual,ok:assert,equal:assert.equal,end:function(){count--,run()}})}var common=require("../common.js"),R=require("../../lib/_stream_readable"),assert=require("assert"),util=require("util"),EE=require("events").EventEmitter;util.inherits(TestReader,R),TestReader.prototype._read=function(e){var t=this._buffer.length-this._pos;e=Math.max(e,0);var n=Math.min(e,t);if(n===0){setTimeout(function(){this._pos=0,this._bufs-=1,this._bufs<=0?this.ended||this.push(null):this._read(e)}.bind(this),10);return}var r=this._buffer.slice(this._pos,this._pos+n);this._pos+=n,this.push(r)},util.inherits(TestWriter,EE),TestWriter.prototype.write=function(e){return this.received.push(e.toString()),this.emit("write",e),!0},TestWriter.prototype.end=function(e){e&&this.write(e),this.emit("end",this.received)};var tests=[],count=0;process.on("exit",function(){assert.equal(count,0)}),process.nextTick(run),test("a most basic test",function(e){function s(){var e;while(null!==(e=t.read(i++)))n.push(e.toString());t.once("readable",s)}var t=new TestReader(20),n=[],r=["x","xx","xxx","xxxx","xxxxx","xxxxxxxxx","xxxxxxxxxx","xxxxxxxxxxxx","xxxxxxxxxxxxx","xxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxx"];t.on("end",function(){e.same(n,r),e.end()});var i=1;s()}),test("pipe",function(e){var t=new TestReader(5),n=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"],r=new TestWriter,i=!0;r.on("end",function(t){e.same(t,n),e.end()}),t.pipe(r)}),[1,2,3,4,5,6,7,8,9].forEach(function(e){test("unpipe",function(t){var n=new TestReader(5),r=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"];r=[r.slice(0,e),r.slice(e)];var i=[new TestWriter,new TestWriter],s=e;i[0].on("write",function(){--s===0&&(n.unpipe(),t.equal(n._readableState.pipes,null),i[0].end(),n.pipe(i[1]),t.equal(n._readableState.pipes,i[1]))});var o=0,u=!1,a=!1;i[0].on("end",function(e){t.equal(u,!1),u=!0,o++,t.same(e,r[0])}),i[1].on("end",function(e){t.equal(a,!1),a=!0,o++,t.equal(o,2),t.same(e,r[1]),t.end()}),n.pipe(i[0])})}),test("multipipe",function(e){var t=new TestReader(5),n=[new TestWriter,new TestWriter],r=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"],i=2;n[0].on("end",function(t){e.same(t,r,"first"),--i===0&&e.end()}),n[1].on("end",function(t){e.same(t,r,"second"),--i===0&&e.end()}),t.pipe(n[0]),t.pipe(n[1])}),[1,2,3,4,5,6,7,8,9].forEach(function(e){test("multi-unpipe",function(t){var n=new TestReader(5),r=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"];r=[r.slice(0,e),r.slice(e)];var i=[new TestWriter,new TestWriter,new TestWriter],s=e;i[0].on("write",function(){--s===0&&(n.unpipe(),i[0].end(),n.pipe(i[1]))});var o=0;i[0].on("end",function(e){o++,t.same(e,r[0])}),i[1].on("end",function(e){o++,t.equal(o,2),t.same(e,r[1]),t.end()}),n.pipe(i[0]),n.pipe(i[2])})}),test("back pressure respected",function(e){function t(){}var n=new R({objectMode:!0});n._read=t;var r=0;n.push(["one"]),n.push(["two"]),n.push(["three"]),n.push(["four"]),n.push(null);var i=new R;i.write=function(e){console.error('w1.emit("close")'),assert.equal(e[0],"one"),i.emit("close"),process.nextTick(function(){n.pipe(o),n.pipe(u)})},i.end=t,n.pipe(i);var s=["two","two","three","three","four","four"],o=new R;o.write=function(e){return console.error("w2 write",e,r),assert.equal(e[0],s.shift()),assert.equal(r,0),r++,e[0]==="four"?!0:(setTimeout(function(){r--,console.error("w2 drain"),o.emit("drain")},10),!1)},o.end=t;var u=new R;u.write=function(e){return console.error("w3 write",e,r),assert.equal(e[0],s.shift()),assert.equal(r,1),r++,e[0]==="four"?!0:(setTimeout(function(){r--,console.error("w3 drain"),u.emit("drain")},50),!1)},u.end=function(){assert.equal(r,2),assert.equal(s.length,0),e.end()}}),test("read(0) for ended streams",function(e){var t=new R,n=!1,r=!1;t._read=function(e){},t.push(new Buffer("foo")),t.push(null);var i=t.read(0);assert.equal(i,null);var s=new R;s.write=function(e){n=!0,assert.equal(r,!1),assert.equal(e.toString(),"foo")},s.end=function(){r=!0,assert.equal(n,!0),e.end()},t.pipe(s)}),test("sync _read ending",function(e){var t=new R,n=!1;t._read=function(e){t.push(null)},t.once("end",function(){n=!0}),t.read(),process.nextTick(function(){assert.equal(n,!0),e.end()})}),test("adding readable triggers data flow",function(e){var t=new R({highWaterMark:5}),n=!1,r=0;t._read=function(e){r++===2?t.push(null):t.push(new Buffer("asdf"))};var i=!1;t.on("readable",function(){n=!0,t.read()}),t.on("end",function(){e.equal(r,3),e.ok(n),e.end()})});