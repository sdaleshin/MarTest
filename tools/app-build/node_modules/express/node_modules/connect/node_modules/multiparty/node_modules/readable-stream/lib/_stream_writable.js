// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function WriteReq(e,t,n){this.chunk=e,this.encoding=t,this.callback=n}function WritableState(e,t){e=e||{};var n=e.highWaterMark;this.highWaterMark=n||n===0?n:16384,this.objectMode=!!e.objectMode,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var r=e.decodeStrings===!1;this.decodeStrings=!r,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){onwrite(t,e)},this.writecb=null,this.writelen=0,this.buffer=[],this.pendingcb=0,this.prefinished=!1}function Writable(e){if(!(this instanceof Writable||this instanceof require("./_stream_duplex")))return new Writable(e);this._writableState=new WritableState(e,this),this.writable=!0,Stream.call(this)}function writeAfterEnd(e,t,n){var r=new Error("write after end");e.emit("error",r),process.nextTick(function(){n(r)})}function validChunk(e,t,n,r){var i=!0;if(!util.isBuffer(n)&&!util.isString(n)&&!util.isNullOrUndefined(n)&&!t.objectMode){var s=new TypeError("Invalid non-string/buffer chunk");e.emit("error",s),process.nextTick(function(){r(s)}),i=!1}return i}function decodeChunk(e,t,n){return!e.objectMode&&e.decodeStrings!==!1&&util.isString(t)&&(t=new Buffer(t,n)),t}function writeOrBuffer(e,t,n,r,i){n=decodeChunk(t,n,r),util.isBuffer(n)&&(r="buffer");var s=t.objectMode?1:n.length;t.length+=s;var o=t.length<t.highWaterMark;return t.needDrain=!o,t.writing||t.corked?t.buffer.push(new WriteReq(n,r,i)):doWrite(e,t,!1,s,n,r,i),o}function doWrite(e,t,n,r,i,s,o){t.writelen=r,t.writecb=o,t.writing=!0,t.sync=!0,n?e._writev(i,t.onwrite):e._write(i,s,t.onwrite),t.sync=!1}function onwriteError(e,t,n,r,i){n?process.nextTick(function(){t.pendingcb--,i(r)}):(t.pendingcb--,i(r)),e.emit("error",r)}function onwriteStateUpdate(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function onwrite(e,t){var n=e._writableState,r=n.sync,i=n.writecb;onwriteStateUpdate(n);if(t)onwriteError(e,n,r,t,i);else{var s=needFinish(e,n);!s&&!n.corked&&!n.bufferProcessing&&n.buffer.length&&clearBuffer(e,n),r?process.nextTick(function(){afterWrite(e,n,s,i)}):afterWrite(e,n,s,i)}}function afterWrite(e,t,n,r){n||onwriteDrain(e,t),t.pendingcb--,r(),finishMaybe(e,t)}function onwriteDrain(e,t){t.length===0&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function clearBuffer(e,t){t.bufferProcessing=!0;if(e._writev&&t.buffer.length>1){var n=[];for(var r=0;r<t.buffer.length;r++)n.push(t.buffer[r].callback);t.pendingcb++,doWrite(e,t,!0,t.length,t.buffer,"",function(e){for(var r=0;r<n.length;r++)t.pendingcb--,n[r](e)}),t.buffer=[]}else{for(var r=0;r<t.buffer.length;r++){var i=t.buffer[r],s=i.chunk,o=i.encoding,u=i.callback,a=t.objectMode?1:s.length;doWrite(e,t,!1,a,s,o,u);if(t.writing){r++;break}}r<t.buffer.length?t.buffer=t.buffer.slice(r):t.buffer.length=0}t.bufferProcessing=!1}function needFinish(e,t){return t.ending&&t.length===0&&!t.finished&&!t.writing}function prefinish(e,t){t.prefinished||(t.prefinished=!0,e.emit("prefinish"))}function finishMaybe(e,t){var n=needFinish(e,t);return n&&(t.pendingcb===0?(prefinish(e,t),t.finished=!0,e.emit("finish")):prefinish(e,t)),n}function endWritable(e,t,n){t.ending=!0,finishMaybe(e,t),n&&(t.finished?process.nextTick(n):e.once("finish",n)),t.ended=!0}module.exports=Writable,Writable.WritableState=WritableState;var util=require("util");if(!util.isUndefined){var utilIs=require("core-util-is");for(var f in utilIs)util[f]=utilIs[f]}var Stream=require("stream");util.inherits(Writable,Stream),Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))},Writable.prototype.write=function(e,t,n){var r=this._writableState,i=!1;return util.isFunction(t)&&(n=t,t=null),util.isBuffer(e)?t="buffer":t||(t=r.defaultEncoding),util.isFunction(n)||(n=function(){}),r.ended?writeAfterEnd(this,r,n):validChunk(this,r,e,n)&&(r.pendingcb++,i=writeOrBuffer(this,r,e,t,n)),i},Writable.prototype.cork=function(){var e=this._writableState;e.corked++},Writable.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,!e.writing&&!e.corked&&!e.finished&&!e.bufferProcessing&&e.buffer.length&&clearBuffer(this,e))},Writable.prototype._write=function(e,t,n){n(new Error("not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(e,t,n){var r=this._writableState;util.isFunction(e)?(n=e,e=null,t=null):util.isFunction(t)&&(n=t,t=null),util.isNullOrUndefined(e)||this.write(e,t),r.corked&&(r.corked=1,this.uncork()),!r.ending&&!r.finished&&endWritable(this,r,n)};