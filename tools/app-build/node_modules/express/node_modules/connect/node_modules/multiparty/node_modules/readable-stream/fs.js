// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function rethrow(){if(DEBUG){var e=new Error;return function(t){if(t)throw e.message=t.message,t=e,t}}return function(e){if(e)throw e}}function maybeCallback(e){return typeof e=="function"?e:rethrow()}function makeCallback(e){return typeof e!="function"?rethrow():function(){return e.apply(null,arguments)}}function assertEncoding(e){if(e&&!Buffer.isEncoding(e))throw new Error("Unknown encoding: "+e)}function nullCheck(e,t){if((""+e).indexOf("\0")!==-1){var n=new Error("Path must be a string without null bytes.");if(!t)throw n;return process.nextTick(function(){t(n)}),!1}return!0}function stringToFlags(e){if(typeof e!="string")return e;if(!O_EXCL&&~e.indexOf("x"))throw errnoException("ENOSYS","fs.open(O_EXCL)");switch(e){case"r":return O_RDONLY;case"rs":return O_RDONLY|O_SYNC;case"r+":return O_RDWR;case"rs+":return O_RDWR|O_SYNC;case"w":return O_TRUNC|O_CREAT|O_WRONLY;case"wx":case"xw":return O_TRUNC|O_CREAT|O_WRONLY|O_EXCL;case"w+":return O_TRUNC|O_CREAT|O_RDWR;case"wx+":case"xw+":return O_TRUNC|O_CREAT|O_RDWR|O_EXCL;case"a":return O_APPEND|O_CREAT|O_WRONLY;case"ax":case"xa":return O_APPEND|O_CREAT|O_WRONLY|O_EXCL;case"a+":return O_APPEND|O_CREAT|O_RDWR;case"ax+":case"xa+":return O_APPEND|O_CREAT|O_RDWR|O_EXCL}throw new Error("Unknown file open flag: "+e)}function modeNum(e,t){switch(typeof e){case"number":return e;case"string":return parseInt(e,8);default:return t?modeNum(t):undefined}}function preprocessSymlinkDestination(e,t){return isWindows?t==="junction"?pathModule._makeLong(e):(""+e).replace(/\//g,"\\"):e}function toUnixTimestamp(e){if(typeof e=="number")return e;if(e instanceof Date)return e.getTime()/1e3;throw new Error("Cannot parse time: "+e)}function writeAll(e,t,n,r,i,s){s=maybeCallback(arguments[arguments.length-1]),fs.write(e,t,n,r,i,function(o,u){o?fs.close(e,function(){s&&s(o)}):u===r?fs.close(e,s):(n+=u,r-=u,i+=u,writeAll(e,t,n,r,i,s))})}function errnoException(e,t){var n=new Error(t+" "+e);return n.errno=n.code=e,n.syscall=t,n}function FSWatcher(){EventEmitter.call(this);var e=this,t=process.binding("fs_event_wrap").FSEvent;this._handle=new t,this._handle.owner=this,this._handle.onchange=function(t,n,r){t?(e._handle.close(),e.emit("error",errnoException(errno,"watch"))):e.emit("change",n,r)}}function StatWatcher(){EventEmitter.call(this);var e=this;this._handle=new binding.StatWatcher;var t=-1;this._handle.onchange=function(n,r,i){if(t===-1&&i===-1&&n.nlink===r.nlink)return;t=i,e.emit("change",n,r)},this._handle.onstop=function(){e.emit("stop")}}function inStatWatchers(e){return Object.prototype.hasOwnProperty.call(statWatchers,e)&&statWatchers[e]}function allocNewPool(){pool=new Buffer(kPoolSize),pool.used=0}function ReadStream(e,t){if(!(this instanceof ReadStream))return new ReadStream(e,t);t=util._extend({bufferSize:65536,lowWaterMark:16384,highWaterMark:65536},t||{}),Readable.call(this,t),this.path=e,this.fd=t.hasOwnProperty("fd")?t.fd:null,this.flags=t.hasOwnProperty("flags")?t.flags:"r",this.mode=t.hasOwnProperty("mode")?t.mode:438,this.start=t.hasOwnProperty("start")?t.start:undefined,this.end=t.hasOwnProperty("start")?t.end:undefined,this.pos=undefined;if(this.start!==undefined){if("number"!=typeof this.start)throw TypeError("start must be a Number");if(this.end===undefined)this.end=Infinity;else if("number"!=typeof this.end)throw TypeError("end must be a Number");if(this.start>this.end)throw new Error("start must be <= end");this.pos=this.start}typeof this.fd!="number"&&this.open(),this.on("end",function(){this.destroy()})}function WriteStream(e,t){if(!(this instanceof WriteStream))return new WriteStream(e,t);t=util._extend({bufferSize:65536,lowWaterMark:16384,highWaterMark:65536},t||{}),Writable.call(this,t),this.path=e,this.fd=null,this.fd=t.hasOwnProperty("fd")?t.fd:null,this.flags=t.hasOwnProperty("flags")?t.flags:"w",this.mode=t.hasOwnProperty("mode")?t.mode:438,this.start=t.hasOwnProperty("start")?t.start:undefined,this.pos=undefined,this.bytesWritten=0;if(this.start!==undefined){if("number"!=typeof this.start)throw TypeError("start must be a Number");if(this.start<0)throw new Error("start must be >= zero");this.pos=this.start}"number"!=typeof this.fd&&this.open(),this.once("finish",this.close)}function SyncWriteStream(e){Stream.call(this),this.fd=e,this.writable=!0,this.readable=!1}var util=require("util"),pathModule=require("path"),binding=process.binding("fs"),constants=process.binding("constants"),fs=exports,Stream=require("stream").Stream,EventEmitter=require("events").EventEmitter,Readable=require("./lib/_stream_readable.js"),Writable=require("./lib/_stream_writable.js"),kMinPoolSpace=128,kPoolSize=40960,O_APPEND=constants.O_APPEND||0,O_CREAT=constants.O_CREAT||0,O_DIRECTORY=constants.O_DIRECTORY||0,O_EXCL=constants.O_EXCL||0,O_NOCTTY=constants.O_NOCTTY||0,O_NOFOLLOW=constants.O_NOFOLLOW||0,O_RDONLY=constants.O_RDONLY||0,O_RDWR=constants.O_RDWR||0,O_SYMLINK=constants.O_SYMLINK||0,O_SYNC=constants.O_SYNC||0,O_TRUNC=constants.O_TRUNC||0,O_WRONLY=constants.O_WRONLY||0,isWindows=process.platform==="win32",DEBUG=process.env.NODE_DEBUG&&/fs/.test(process.env.NODE_DEBUG);fs.Stats=binding.Stats,fs.Stats.prototype._checkModeProperty=function(e){return(this.mode&constants.S_IFMT)===e},fs.Stats.prototype.isDirectory=function(){return this._checkModeProperty(constants.S_IFDIR)},fs.Stats.prototype.isFile=function(){return this._checkModeProperty(constants.S_IFREG)},fs.Stats.prototype.isBlockDevice=function(){return this._checkModeProperty(constants.S_IFBLK)},fs.Stats.prototype.isCharacterDevice=function(){return this._checkModeProperty(constants.S_IFCHR)},fs.Stats.prototype.isSymbolicLink=function(){return this._checkModeProperty(constants.S_IFLNK)},fs.Stats.prototype.isFIFO=function(){return this._checkModeProperty(constants.S_IFIFO)},fs.Stats.prototype.isSocket=function(){return this._checkModeProperty(constants.S_IFSOCK)},fs.exists=function(e,t){function n(e,n){t&&t(e?!1:!0)}if(!nullCheck(e,n))return;binding.stat(pathModule._makeLong(e),n)},fs.existsSync=function(e){try{return nullCheck(e),binding.stat(pathModule._makeLong(e)),!0}catch(t){return!1}},fs.readFile=function(e,t){function f(){i===0?(s=new Buffer(8192),fs.read(a,s,0,8192,-1,l)):fs.read(a,s,u,i-u,-1,l)}function l(e,t){if(e)return fs.close(a,function(t){return r(e)});if(t===0)return c();u+=t,i!==0?u===i?c():f():(o.push(s.slice(0,t)),f())}function c(){fs.close(a,function(e){return i===0?s=Buffer.concat(o,u):u<i&&(s=s.slice(0,u)),n&&(s=s.toString(n)),r(e,s)})}var n=typeof t=="string"?t:null,r=maybeCallback(arguments[arguments.length-1]);assertEncoding(n);var i,s,o,u=0,a;fs.open(e,constants.O_RDONLY,438,function(e,t){if(e)return r(e);a=t,fs.fstat(a,function(e,t){if(e)return r(e);i=t.size;if(i===0)return o=[],f();s=new Buffer(i),f()})})},fs.readFileSync=function(e,t){assertEncoding(t);var n=fs.openSync(e,constants.O_RDONLY,438),r,i=!0;try{r=fs.fstatSync(n).size,i=!1}finally{i&&fs.closeSync(n)}var s=0,o,u;r===0?u=[]:o=new Buffer(r);var a=!1;while(!a){var i=!0;try{if(r!==0)var f=fs.readSync(n,o,s,r-s);else{o=new Buffer(8192);var f=fs.readSync(n,o,0,8192);f&&u.push(o.slice(0,f))}i=!1}finally{i&&fs.closeSync(n)}s+=f,a=f===0||r!==0&&s>=r}return fs.closeSync(n),r===0?o=Buffer.concat(u,s):s<r&&(o=o.slice(0,s)),t&&(o=o.toString(t)),o},Object.defineProperty(exports,"_stringToFlags",{enumerable:!1,value:stringToFlags}),fs.close=function(e,t){binding.close(e,makeCallback(t))},fs.closeSync=function(e){return binding.close(e)},fs.open=function(e,t,n,r){r=makeCallback(arguments[arguments.length-1]),n=modeNum(n,438);if(!nullCheck(e,r))return;binding.open(pathModule._makeLong(e),stringToFlags(t),n,r)},fs.openSync=function(e,t,n){return n=modeNum(n,438),nullCheck(e),binding.open(pathModule._makeLong(e),stringToFlags(t),n)},fs.read=function(e,t,n,r,i,s){function a(e,n){s&&s(e,n||0,t)}if(!Buffer.isBuffer(t)){var o=arguments[4],u=arguments[3];assertEncoding(u),i=arguments[2],r=arguments[1],t=new Buffer(r),n=0,s=function(e,n){if(!o)return;var r=n>0?t.toString(u,0,n):"";o(e,r,n)}}binding.read(e,t,n,r,i,a)},fs.readSync=function(e,t,n,r,i){var s=!1;if(!Buffer.isBuffer(t)){s=!0;var o=arguments[3];assertEncoding(o),i=arguments[2],r=arguments[1],t=new Buffer(r),n=0}var u=binding.read(e,t,n,r,i);if(!s)return u;var a=u>0?t.toString(o,0,u):"";return[a,u]},fs.write=function(e,t,n,r,i,s){function o(e,n){s(e,n||0,t)}Buffer.isBuffer(t)||(s=arguments[4],i=arguments[2],assertEncoding(arguments[3]),t=new Buffer(""+arguments[1],arguments[3]),n=0,r=t.length);if(!r){typeof s=="function"&&process.nextTick(function(){s(undefined,0)});return}s=maybeCallback(s),binding.write(e,t,n,r,i,o)},fs.writeSync=function(e,t,n,r,i){return Buffer.isBuffer(t)||(i=arguments[2],assertEncoding(arguments[3]),t=new Buffer(""+arguments[1],arguments[3]),n=0,r=t.length),r?binding.write(e,t,n,r,i):0},fs.rename=function(e,t,n){n=makeCallback(n);if(!nullCheck(e,n))return;if(!nullCheck(t,n))return;binding.rename(pathModule._makeLong(e),pathModule._makeLong(t),n)},fs.renameSync=function(e,t){return nullCheck(e),nullCheck(t),binding.rename(pathModule._makeLong(e),pathModule._makeLong(t))},fs.truncate=function(e,t,n){if(typeof e=="number")return fs.ftruncate(e,t,n);typeof t=="function"?(n=t,t=0):typeof t=="undefined"&&(t=0),n=maybeCallback(n),fs.open(e,"w",function(e,r){if(e)return n(e);binding.ftruncate(r,t,function(e){fs.close(r,function(t){n(e||t)})})})},fs.truncateSync=function(e,t){if(typeof e=="number")return fs.ftruncateSync(e,t);typeof t=="undefined"&&(t=0);var n=fs.openSync(e,"w");try{var r=fs.ftruncateSync(n,t)}finally{fs.closeSync(n)}return r},fs.ftruncate=function(e,t,n){typeof t=="function"?(n=t,t=0):typeof t=="undefined"&&(t=0),binding.ftruncate(e,t,makeCallback(n))},fs.ftruncateSync=function(e,t){return typeof t=="undefined"&&(t=0),binding.ftruncate(e,t)},fs.rmdir=function(e,t){t=makeCallback(t);if(!nullCheck(e,t))return;binding.rmdir(pathModule._makeLong(e),t)},fs.rmdirSync=function(e){return nullCheck(e),binding.rmdir(pathModule._makeLong(e))},fs.fdatasync=function(e,t){binding.fdatasync(e,makeCallback(t))},fs.fdatasyncSync=function(e){return binding.fdatasync(e)},fs.fsync=function(e,t){binding.fsync(e,makeCallback(t))},fs.fsyncSync=function(e){return binding.fsync(e)},fs.mkdir=function(e,t,n){typeof t=="function"&&(n=t),n=makeCallback(n);if(!nullCheck(e,n))return;binding.mkdir(pathModule._makeLong(e),modeNum(t,511),n)},fs.mkdirSync=function(e,t){return nullCheck(e),binding.mkdir(pathModule._makeLong(e),modeNum(t,511))},fs.sendfile=function(e,t,n,r,i){binding.sendfile(e,t,n,r,makeCallback(i))},fs.sendfileSync=function(e,t,n,r){return binding.sendfile(e,t,n,r)},fs.readdir=function(e,t){t=makeCallback(t);if(!nullCheck(e,t))return;binding.readdir(pathModule._makeLong(e),t)},fs.readdirSync=function(e){return nullCheck(e),binding.readdir(pathModule._makeLong(e))},fs.fstat=function(e,t){binding.fstat(e,makeCallback(t))},fs.lstat=function(e,t){t=makeCallback(t);if(!nullCheck(e,t))return;binding.lstat(pathModule._makeLong(e),t)},fs.stat=function(e,t){t=makeCallback(t);if(!nullCheck(e,t))return;binding.stat(pathModule._makeLong(e),t)},fs.fstatSync=function(e){return binding.fstat(e)},fs.lstatSync=function(e){return nullCheck(e),binding.lstat(pathModule._makeLong(e))},fs.statSync=function(e){return nullCheck(e),binding.stat(pathModule._makeLong(e))},fs.readlink=function(e,t){t=makeCallback(t);if(!nullCheck(e,t))return;binding.readlink(pathModule._makeLong(e),t)},fs.readlinkSync=function(e){return nullCheck(e),binding.readlink(pathModule._makeLong(e))},fs.symlink=function(e,t,n,r){var i=typeof n=="string"?n:null,r=makeCallback(arguments[arguments.length-1]);if(!nullCheck(e,r))return;if(!nullCheck(t,r))return;binding.symlink(preprocessSymlinkDestination(e,i),pathModule._makeLong(t),i,r)},fs.symlinkSync=function(e,t,n){return n=typeof n=="string"?n:null,nullCheck(e),nullCheck(t),binding.symlink(preprocessSymlinkDestination(e,n),pathModule._makeLong(t),n)},fs.link=function(e,t,n){n=makeCallback(n);if(!nullCheck(e,n))return;if(!nullCheck(t,n))return;binding.link(pathModule._makeLong(e),pathModule._makeLong(t),n)},fs.linkSync=function(e,t){return nullCheck(e),nullCheck(t),binding.link(pathModule._makeLong(e),pathModule._makeLong(t))},fs.unlink=function(e,t){t=makeCallback(t);if(!nullCheck(e,t))return;binding.unlink(pathModule._makeLong(e),t)},fs.unlinkSync=function(e){return nullCheck(e),binding.unlink(pathModule._makeLong(e))},fs.fchmod=function(e,t,n){binding.fchmod(e,modeNum(t),makeCallback(n))},fs.fchmodSync=function(e,t){return binding.fchmod(e,modeNum(t))},constants.hasOwnProperty("O_SYMLINK")&&(fs.lchmod=function(e,t,n){n=maybeCallback(n),fs.open(e,constants.O_WRONLY|constants.O_SYMLINK,function(e,r){if(e){n(e);return}fs.fchmod(r,t,function(e){fs.close(r,function(t){n(e||t)})})})},fs.lchmodSync=function(e,t){var n=fs.openSync(e,constants.O_WRONLY|constants.O_SYMLINK),r,i;try{var s=fs.fchmodSync(n,t)}catch(o){r=o}try{fs.closeSync(n)}catch(o){i=o}if(r||i)throw r||i;return s}),fs.chmod=function(e,t,n){n=makeCallback(n);if(!nullCheck(e,n))return;binding.chmod(pathModule._makeLong(e),modeNum(t),n)},fs.chmodSync=function(e,t){return nullCheck(e),binding.chmod(pathModule._makeLong(e),modeNum(t))},constants.hasOwnProperty("O_SYMLINK")&&(fs.lchown=function(e,t,n,r){r=maybeCallback(r),fs.open(e,constants.O_WRONLY|constants.O_SYMLINK,function(e,i){if(e){r(e);return}fs.fchown(i,t,n,r)})},fs.lchownSync=function(e,t,n){var r=fs.openSync(e,constants.O_WRONLY|constants.O_SYMLINK);return fs.fchownSync(r,t,n)}),fs.fchown=function(e,t,n,r){binding.fchown(e,t,n,makeCallback(r))},fs.fchownSync=function(e,t,n){return binding.fchown(e,t,n)},fs.chown=function(e,t,n,r){r=makeCallback(r);if(!nullCheck(e,r))return;binding.chown(pathModule._makeLong(e),t,n,r)},fs.chownSync=function(e,t,n){return nullCheck(e),binding.chown(pathModule._makeLong(e),t,n)},fs._toUnixTimestamp=toUnixTimestamp,fs.utimes=function(e,t,n,r){r=makeCallback(r);if(!nullCheck(e,r))return;binding.utimes(pathModule._makeLong(e),toUnixTimestamp(t),toUnixTimestamp(n),r)},fs.utimesSync=function(e,t,n){nullCheck(e),t=toUnixTimestamp(t),n=toUnixTimestamp(n),binding.utimes(pathModule._makeLong(e),t,n)},fs.futimes=function(e,t,n,r){t=toUnixTimestamp(t),n=toUnixTimestamp(n),binding.futimes(e,t,n,makeCallback(r))},fs.futimesSync=function(e,t,n){t=toUnixTimestamp(t),n=toUnixTimestamp(n),binding.futimes(e,t,n)},fs.writeFile=function(e,t,n,r){var i=typeof n=="string"?n:"utf8";assertEncoding(i),r=maybeCallback(arguments[arguments.length-1]),fs.open(e,"w",438,function(e,n){if(e)r&&r(e);else{var s=Buffer.isBuffer(t)?t:new Buffer(""+t,i);writeAll(n,s,0,s.length,0,r)}})},fs.writeFileSync=function(e,t,n){assertEncoding(n);var r=fs.openSync(e,"w");Buffer.isBuffer(t)||(t=new Buffer(""+t,n||"utf8"));var i=0,s=t.length;try{while(i<s)i+=fs.writeSync(r,t,i,s-i,i)}finally{fs.closeSync(r)}},fs.appendFile=function(e,t,n,r){var i=typeof n=="string"?n:"utf8";assertEncoding(i),r=maybeCallback(arguments[arguments.length-1]),fs.open(e,"a",438,function(e,n){if(e)return r(e);var s=Buffer.isBuffer(t)?t:new Buffer(""+t,i);writeAll(n,s,0,s.length,null,r)})},fs.appendFileSync=function(e,t,n){assertEncoding(n);var r=fs.openSync(e,"a");Buffer.isBuffer(t)||(t=new Buffer(""+t,n||"utf8"));var i=0,s=null,o=t.length;try{while(i<o)i+=fs.writeSync(r,t,i,o-i,s),s+=i}finally{fs.closeSync(r)}},util.inherits(FSWatcher,EventEmitter),FSWatcher.prototype.start=function(e,t){nullCheck(e);var n=this._handle.start(pathModule._makeLong(e),t);if(n)throw this._handle.close(),errnoException(errno,"watch")},FSWatcher.prototype.close=function(){this._handle.close()},fs.watch=function(e){nullCheck(e);var t,n,r;return"object"==typeof arguments[1]?(n=arguments[1],r=arguments[2]):(n={},r=arguments[1]),n.persistent===undefined&&(n.persistent=!0),t=new FSWatcher,t.start(e,n.persistent),r&&t.addListener("change",r),t},util.inherits(StatWatcher,EventEmitter),StatWatcher.prototype.start=function(e,t,n){nullCheck(e),this._handle.start(pathModule._makeLong(e),t,n)},StatWatcher.prototype.stop=function(){this._handle.stop()};var statWatchers={};fs.watchFile=function(e){nullCheck(e);var t,n,r={interval:5007,persistent:!0};"object"==typeof arguments[1]?(r=util._extend(r,arguments[1]),n=arguments[2]):n=arguments[1];if(!n)throw new Error("watchFile requires a listener function");return inStatWatchers(e)?t=statWatchers[e]:(t=statWatchers[e]=new StatWatcher,t.start(e,r.persistent,r.interval)),t.addListener("change",n),t},fs.unwatchFile=function(e,t){nullCheck(e);if(!inStatWatchers(e))return;var n=statWatchers[e];typeof t=="function"?n.removeListener("change",t):n.removeAllListeners("change"),n.listeners("change").length===0&&(n.stop(),statWatchers[e]=undefined)};var normalize=pathModule.normalize;if(isWindows)var nextPartRe=/(.*?)(?:[\/\\]+|$)/g;else var nextPartRe=/(.*?)(?:[\/]+|$)/g;if(isWindows)var splitRootRe=/^(?:[a-zA-Z]:|[\\\/]{2}[^\\\/]+[\\\/][^\\\/]+)?[\\\/]*/;else var splitRootRe=/^[\/]*/;fs.realpathSync=function(t,n){function l(){var e=splitRootRe.exec(t);o=e[0].length,u=e[0],a=e[0],f="",isWindows&&!s[a]&&(fs.lstatSync(a),s[a]=!0)}t=pathModule.resolve(t);if(n&&Object.prototype.hasOwnProperty.call(n,t))return n[t];var r=t,i={},s={},o,u,a,f;l();while(o<t.length){nextPartRe.lastIndex=o;var c=nextPartRe.exec(t);f=u,u+=c[0],a=f+c[1],o=nextPartRe.lastIndex;if(s[a]||n&&n[a]===a)continue;var h;if(n&&Object.prototype.hasOwnProperty.call(n,a))h=n[a];else{var p=fs.lstatSync(a);if(!p.isSymbolicLink()){s[a]=!0,n&&(n[a]=a);continue}var d=null;if(!isWindows){var v=p.dev.toString(32)+":"+p.ino.toString(32);i.hasOwnProperty(v)&&(d=i[v])}d===null&&(fs.statSync(a),d=fs.readlinkSync(a)),h=pathModule.resolve(f,d),n&&(n[a]=h),isWindows||(i[v]=d)}t=pathModule.resolve(h,t.slice(o)),l()}return n&&(n[r]=t),t},fs.realpath=function(t,n,r){function c(){var e=splitRootRe.exec(t);u=e[0].length,a=e[0],f=e[0],l="",isWindows&&!o[f]?fs.lstat(f,function(e){if(e)return r(e);o[f]=!0,h()}):process.nextTick(h)}function h(){if(u>=t.length)return n&&(n[i]=t),r(null,t);nextPartRe.lastIndex=u;var e=nextPartRe.exec(t);return l=a,a+=e[0],f=l+e[1],u=nextPartRe.lastIndex,o[f]||n&&n[f]===f?process.nextTick(h):n&&Object.prototype.hasOwnProperty.call(n,f)?v(n[f]):fs.lstat(f,p)}function p(e,t){if(e)return r(e);if(!t.isSymbolicLink())return o[f]=!0,n&&(n[f]=f),process.nextTick(h);if(!isWindows){var i=t.dev.toString(32)+":"+t.ino.toString(32);if(s.hasOwnProperty(i))return d(null,s[i],f)}fs.stat(f,function(e){if(e)return r(e);fs.readlink(f,function(e,t){isWindows||(s[i]=t),d(e,t)})})}function d(e,t,i){if(e)return r(e);var s=pathModule.resolve(l,t);n&&(n[i]=s),v(s)}function v(e){t=pathModule.resolve(e,t.slice(u)),c()}typeof r!="function"&&(r=maybeCallback(n),n=null),t=pathModule.resolve(t);if(n&&Object.prototype.hasOwnProperty.call(n,t))return process.nextTick(r.bind(null,null,n[t]));var i=t,s={},o={},u,a,f,l;c()};var pool;fs.createReadStream=function(e,t){return new ReadStream(e,t)},util.inherits(ReadStream,Readable),fs.ReadStream=ReadStream,fs.FileReadStream=fs.ReadStream,ReadStream.prototype.open=function(){var e=this;fs.open(this.path,this.flags,this.mode,function(t,n){if(t){e.destroy(),e.emit("error",t);return}e.fd=n,e.emit("open",n),e.read()})},ReadStream.prototype._read=function(e,t){function o(e,r){if(e)return s.destroy(),t(e);var o=null;r>0&&(o=n.slice(i,i+r)),t(null,o)}if(typeof this.fd!="number")return this.once("open",function(){this._read(e,t)});if(this.destroyed)return;if(!pool||pool.length-pool.used<kMinPoolSpace)pool=null,allocNewPool();var n=pool,r=Math.min(pool.length-pool.used,e),i=pool.used;this.pos!==undefined&&(r=Math.min(this.end-this.pos+1,r));if(r<=0)return t();var s=this;fs.read(this.fd,pool,pool.used,r,this.pos,o),this.pos!==undefined&&(this.pos+=r),pool.used+=r},ReadStream.prototype.destroy=function(){if(this.destroyed)return;this.destroyed=!0,"number"==typeof this.fd&&this.close()},ReadStream.prototype.close=function(e){function n(){fs.close(t.fd,function(e){e?t.emit("error",e):t.emit("close")})}e&&this.once("close",e);if(this.closed||"number"!=typeof this.fd)return"number"!=typeof this.fd&&this.once("open",n),process.nextTick(this.emit.bind(this,"close"));this.closed=!0;var t=this;n()},fs.createWriteStream=function(e,t){return new WriteStream(e,t)},util.inherits(WriteStream,Writable),fs.WriteStream=WriteStream,fs.FileWriteStream=fs.WriteStream,WriteStream.prototype.open=function(){fs.open(this.path,this.flags,this.mode,function(e,t){if(e){this.destroy(),this.emit("error",e);return}this.fd=t,this.emit("open",t)}.bind(this))},WriteStream.prototype._write=function(e,t){if(!Buffer.isBuffer(e))return this.emit("error",new Error("Invalid data"));if(typeof this.fd!="number")return this.once("open",this._write.bind(this,e,t));fs.write(this.fd,e,0,e.length,this.pos,function(e,n){if(e)return this.destroy(),t(e);this.bytesWritten+=n,t()}.bind(this)),this.pos!==undefined&&(this.pos+=e.length)},WriteStream.prototype.destroy=ReadStream.prototype.destroy,WriteStream.prototype.close=ReadStream.prototype.close,WriteStream.prototype.destroySoon=WriteStream.prototype.end,util.inherits(SyncWriteStream,Stream),fs.SyncWriteStream=SyncWriteStream,SyncWriteStream.prototype.write=function(e,t,n){var r,i;if(t)if(typeof t=="string")r=t,i=n;else{if(typeof t!="function")throw new Error("bad arg");i=t}return assertEncoding(r),typeof e=="string"&&(e=new Buffer(e,r)),fs.writeSync(this.fd,e,0,e.length),i&&process.nextTick(i),!0},SyncWriteStream.prototype.end=function(e,t,n){e&&this.write(e,t,n),this.destroy()},SyncWriteStream.prototype.destroy=function(){return fs.closeSync(this.fd),this.fd=null,this.emit("close"),!0},SyncWriteStream.prototype.destroySoon=SyncWriteStream.prototype.destroy;