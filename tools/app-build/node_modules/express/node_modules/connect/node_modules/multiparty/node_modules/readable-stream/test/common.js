// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function protoCtrChain(e){var t=[];for(;e;e=e.__proto__)t.push(e.constructor);return t.join()}function runCallChecks(e){if(e!==0)return;var t=mustCallChecks.filter(function(e){return e.actual!==e.expected});t.forEach(function(e){console.log("Mismatched %s function calls. Expected %d, actual %d.",e.name,e.expected,e.actual),console.log(e.stack.split("\n").slice(2).join("\n"))}),t.length&&process.exit(1)}var path=require("path"),assert=require("assert");exports.testDir=path.dirname(__filename),exports.fixturesDir=path.join(exports.testDir,"fixtures"),exports.libDir=path.join(exports.testDir,"../lib"),exports.tmpDir=path.join(exports.testDir,"tmp"),exports.PORT=+process.env.NODE_COMMON_PORT||12346,process.platform==="win32"?exports.PIPE="\\\\.\\pipe\\libuv-test":exports.PIPE=exports.tmpDir+"/test.sock";var util=require("util");for(var i in util)exports[i]=util[i];exports.indirectInstanceOf=function(e,t){if(e instanceof t)return!0;var n=protoCtrChain(t.prototype),r=protoCtrChain(e);return r.slice(-n.length)===n},exports.ddCommand=function(e,t){if(process.platform==="win32"){var n=path.resolve(exports.fixturesDir,"create-file.js");return'"'+process.argv[0]+'" "'+n+'" "'+e+'" '+t*1024}return'dd if=/dev/zero of="'+e+'" bs=1024 count='+t},exports.spawnCat=function(e){var t=require("child_process").spawn;return process.platform==="win32"?t("more",[],e):t("cat",[],e)},exports.spawnPwd=function(e){var t=require("child_process").spawn;return process.platform==="win32"?t("cmd.exe",["/c","cd"],e):t("pwd",[],e)},exports.globalCheck=!0,process.on("exit",function(){if(!exports.globalCheck)return;var e=[setTimeout,setInterval,setImmediate,clearTimeout,clearInterval,clearImmediate,console,Buffer,process,global];global.gc&&e.push(gc),global.DTRACE_HTTP_SERVER_RESPONSE&&(e.push(DTRACE_HTTP_SERVER_RESPONSE),e.push(DTRACE_HTTP_SERVER_REQUEST),e.push(DTRACE_HTTP_CLIENT_RESPONSE),e.push(DTRACE_HTTP_CLIENT_REQUEST),e.push(DTRACE_NET_STREAM_END),e.push(DTRACE_NET_SERVER_CONNECTION),e.push(DTRACE_NET_SOCKET_READ),e.push(DTRACE_NET_SOCKET_WRITE)),global.COUNTER_NET_SERVER_CONNECTION&&(e.push(COUNTER_NET_SERVER_CONNECTION),e.push(COUNTER_NET_SERVER_CONNECTION_CLOSE),e.push(COUNTER_HTTP_SERVER_REQUEST),e.push(COUNTER_HTTP_SERVER_RESPONSE),e.push(COUNTER_HTTP_CLIENT_REQUEST),e.push(COUNTER_HTTP_CLIENT_RESPONSE)),global.ArrayBuffer&&(e.push(ArrayBuffer),e.push(Int8Array),e.push(Uint8Array),e.push(Uint8ClampedArray),e.push(Int16Array),e.push(Uint16Array),e.push(Int32Array),e.push(Uint32Array),e.push(Float32Array),e.push(Float64Array),e.push(DataView));for(var t in global){var n=!1;for(var r in e)if(global[t]===e[r]){n=!0;break}n||(console.error("Unknown global: %s",t),assert.ok(!1,"Unknown global found"))}});var mustCallChecks=[];exports.mustCall=function(e,t){typeof t!="number"&&(t=1);var n={expected:t,actual:0,stack:(new Error).stack,name:e.name||"<anonymous>"};return mustCallChecks.length===0&&process.on("exit",runCallChecks),mustCallChecks.push(n),function(){return n.actual++,e.apply(this,arguments)}};