// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function ReadableState(e,t){e=e||{};var n=e.highWaterMark;this.highWaterMark=n||n===0?n:16384,this.highWaterMark=~~this.highWaterMark,this.buffer=[],this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.objectMode=!!e.objectMode,this.defaultEncoding=e.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(StringDecoder||(StringDecoder=require("string_decoder").StringDecoder),this.decoder=new StringDecoder(e.encoding),this.encoding=e.encoding)}function Readable(e){if(!(this instanceof Readable))return new Readable(e);this._readableState=new ReadableState(e,this),this.readable=!0,Stream.call(this)}function readableAddChunk(e,t,n,r,i){var s=chunkInvalid(t,n);if(s)e.emit("error",s);else if(util.isNullOrUndefined(n))t.reading=!1,t.ended||onEofChunk(e,t);else if(t.objectMode||n&&n.length>0)if(t.ended&&!i){var o=new Error("stream.push() after EOF");e.emit("error",o)}else if(t.endEmitted&&i){var o=new Error("stream.unshift() after end event");e.emit("error",o)}else t.decoder&&!i&&!r&&(n=t.decoder.write(n)),i||(t.reading=!1),t.flowing&&t.length===0&&!t.sync?(e.emit("data",n),e.read(0)):(t.length+=t.objectMode?1:n.length,i?t.buffer.unshift(n):t.buffer.push(n),t.needReadable&&emitReadable(e)),maybeReadMore(e,t);else i||(t.reading=!1);return needMoreData(t)}function needMoreData(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||e.length===0)}function roundUpToNextPowerOf2(e){if(e>=MAX_HWM)e=MAX_HWM;else{e--;for(var t=1;t<32;t<<=1)e|=e>>t;e++}return e}function howMuchToRead(e,t){return t.length===0&&t.ended?0:t.objectMode?e===0?0:1:isNaN(e)||util.isNull(e)?t.flowing&&t.buffer.length?t.buffer[0].length:t.length:e<=0?0:(e>t.highWaterMark&&(t.highWaterMark=roundUpToNextPowerOf2(e)),e>t.length?t.ended?t.length:(t.needReadable=!0,0):e)}function chunkInvalid(e,t){var n=null;return!util.isBuffer(t)&&!util.isString(t)&&!util.isNullOrUndefined(t)&&!e.objectMode&&!n&&(n=new TypeError("Invalid non-string/buffer chunk")),n}function onEofChunk(e,t){if(t.decoder&&!t.ended&&t.decoder.end){var n=t.decoder.end();n&&n.length&&(t.buffer.push(n),t.length+=t.objectMode?1:n.length)}t.ended=!0,emitReadable(e)}function emitReadable(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(debug("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?process.nextTick(function(){emitReadable_(e)}):emitReadable_(e))}function emitReadable_(e){debug("emit readable"),e.emit("readable"),flow(e)}function maybeReadMore(e,t){t.readingMore||(t.readingMore=!0,process.nextTick(function(){maybeReadMore_(e,t)}))}function maybeReadMore_(e,t){var n=t.length;while(!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark){debug("maybeReadMore read 0"),e.read(0);if(n===t.length)break;n=t.length}t.readingMore=!1}function pipeOnDrain(e){return function(){var t=e._readableState;debug("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,t.awaitDrain===0&&EE.listenerCount(e,"data")&&(t.flowing=!0,flow(e))}}function resume(e,t){t.resumeScheduled||(t.resumeScheduled=!0,process.nextTick(function(){resume_(e,t)}))}function resume_(e,t){t.resumeScheduled=!1,e.emit("resume"),flow(e),t.flowing&&!t.reading&&e.read(0)}function flow(e){var t=e._readableState;debug("flow",t.flowing);if(t.flowing)do var n=e.read();while(null!==n&&t.flowing)}function fromList(e,t){var n=t.buffer,r=t.length,i=!!t.decoder,s=!!t.objectMode,o;if(n.length===0)return null;if(r===0)o=null;else if(s)o=n.shift();else if(!e||e>=r)i?o=n.join(""):o=Buffer.concat(n,r),n.length=0;else if(e<n[0].length){var u=n[0];o=u.slice(0,e),n[0]=u.slice(e)}else if(e===n[0].length)o=n.shift();else{i?o="":o=new Buffer(e);var a=0;for(var f=0,l=n.length;f<l&&a<e;f++){var u=n[0],c=Math.min(e-a,u.length);i?o+=u.slice(0,c):u.copy(o,a,0,c),c<u.length?n[0]=u.slice(c):n.shift(),a+=c}}return o}function endReadable(e){var t=e._readableState;if(t.length>0)throw new Error("endReadable called on non-empty stream");t.endEmitted||(t.ended=!0,process.nextTick(function(){!t.endEmitted&&t.length===0&&(t.endEmitted=!0,e.readable=!1,e.emit("end"))}))}module.exports=Readable,Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter;EE.listenerCount||(EE.listenerCount=function(e,t){return e.listeners(t).length}),global.setImmediate||(global.setImmediate=function(t){return setTimeout(t,0)}),global.clearImmediate||(global.clearImmediate=function(t){return clearTimeout(t)});var Stream=require("stream"),util=require("util");if(!util.isUndefined){var utilIs=require("core-util-is");for(var f in utilIs)util[f]=utilIs[f]}var StringDecoder,debug;if(util.debuglog)debug=util.debuglog("stream");else try{debug=require("debuglog")("stream")}catch(er){debug=function(){}}util.inherits(Readable,Stream),Readable.prototype.push=function(e,t){var n=this._readableState;return util.isString(e)&&!n.objectMode&&(t=t||n.defaultEncoding,t!==n.encoding&&(e=new Buffer(e,t),t="")),readableAddChunk(this,n,e,t,!1)},Readable.prototype.unshift=function(e){var t=this._readableState;return readableAddChunk(this,t,e,"",!0)},Readable.prototype.setEncoding=function(e){StringDecoder||(StringDecoder=require("string_decoder").StringDecoder),this._readableState.decoder=new StringDecoder(e),this._readableState.encoding=e};var MAX_HWM=8388608;Readable.prototype.read=function(e){debug("read",e);var t=this._readableState,n=e;if(!util.isNumber(e)||e>0)t.emittedReadable=!1;if(e===0&&t.needReadable&&(t.length>=t.highWaterMark||t.ended))return debug("read: emitReadable",t.length,t.ended),t.length===0&&t.ended?endReadable(this):emitReadable(this),null;e=howMuchToRead(e,t);if(e===0&&t.ended)return t.length===0&&endReadable(this),null;var r=t.needReadable;debug("need readable",r);if(t.length===0||t.length-e<t.highWaterMark)r=!0,debug("length less than watermark",r);if(t.ended||t.reading)r=!1,debug("reading or ended",r);r&&(debug("do read"),t.reading=!0,t.sync=!0,t.length===0&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1),r&&!t.reading&&(e=howMuchToRead(n,t));var i;return e>0?i=fromList(e,t):i=null,util.isNull(i)&&(t.needReadable=!0,e=0),t.length-=e,t.length===0&&!t.ended&&(t.needReadable=!0),n!==e&&t.ended&&t.length===0&&endReadable(this),util.isNull(i)||this.emit("data",i),i},Readable.prototype._read=function(e){this.emit("error",new Error("not implemented"))},Readable.prototype.pipe=function(e,t){function o(e){debug("onunpipe"),e===n&&f()}function u(){debug("onend"),e.end()}function f(){debug("cleanup"),e.removeListener("close",h),e.removeListener("finish",p),e.removeListener("drain",a),e.removeListener("error",c),e.removeListener("unpipe",o),n.removeListener("end",u),n.removeListener("end",f),n.removeListener("data",l),r.awaitDrain&&(!e._writableState||e._writableState.needDrain)&&a()}function l(t){debug("ondata");var r=e.write(t);!1===r&&(debug("false write response, pause",n._readableState.awaitDrain),n._readableState.awaitDrain++,n.pause())}function c(t){debug("onerror",t),d(),e.removeListener("error",c),EE.listenerCount(e,"error")===0&&e.emit("error",t)}function h(){e.removeListener("finish",p),d()}function p(){debug("onfinish"),e.removeListener("close",h),d()}function d(){debug("unpipe"),n.unpipe(e)}var n=this,r=this._readableState;switch(r.pipesCount){case 0:r.pipes=e;break;case 1:r.pipes=[r.pipes,e];break;default:r.pipes.push(e)}r.pipesCount+=1,debug("pipe count=%d opts=%j",r.pipesCount,t);var i=(!t||t.end!==!1)&&e!==process.stdout&&e!==process.stderr,s=i?u:f;r.endEmitted?process.nextTick(s):n.once("end",s),e.on("unpipe",o);var a=pipeOnDrain(n);return e.on("drain",a),n.on("data",l),e._events.error?Array.isArray(e._events.error)?e._events.error.unshift(c):e._events.error=[c,e._events.error]:e.on("error",c),e.once("close",h),e.once("finish",p),e.emit("pipe",n),r.flowing||(debug("pipe resume"),n.resume()),e},Readable.prototype.unpipe=function(e){var t=this._readableState;if(t.pipesCount===0)return this;if(t.pipesCount===1)return e&&e!==t.pipes?this:(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this),this);if(!e){var n=t.pipes,r=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var i=0;i<r;i++)n[i].emit("unpipe",this);return this}var i=t.pipes.indexOf(e);return i===-1?this:(t.pipes.splice(i,1),t.pipesCount-=1,t.pipesCount===1&&(t.pipes=t.pipes[0]),e.emit("unpipe",this),this)},Readable.prototype.on=function(e,t){var n=Stream.prototype.on.call(this,e,t);e==="data"&&!1!==this._readableState.flowing&&this.resume();if(e==="readable"&&this.readable){var r=this._readableState;if(!r.readableListening){r.readableListening=!0,r.emittedReadable=!1,r.needReadable=!0;if(!r.reading){var i=this;process.nextTick(function(){debug("readable nexttick read 0"),i.read(0)})}else r.length&&emitReadable(this,r)}}return n},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){var e=this._readableState;e.flowing||(debug("resume"),e.flowing=!0,e.reading||(debug("resume read 0"),this.read(0)),resume(this,e))},Readable.prototype.pause=function(){debug("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(debug("pause"),this._readableState.flowing=!1,this.emit("pause"))},Readable.prototype.wrap=function(e){var t=this._readableState,n=!1,r=this;e.on("end",function(){debug("wrapped end");if(t.decoder&&!t.ended){var e=t.decoder.end();e&&e.length&&r.push(e)}r.push(null)}),e.on("data",function(i){debug("wrapped data"),t.decoder&&(i=t.decoder.write(i));if(!i||!t.objectMode&&!i.length)return;var s=r.push(i);s||(n=!0,e.pause())});for(var i in e)util.isFunction(e[i])&&util.isUndefined(this[i])&&(this[i]=function(t){return function(){return e[t].apply(e,arguments)}}(i));var s=["error","close","destroy","pause","resume"];return s.forEach(function(t){e.on(t,r.emit.bind(r,t))}),r._read=function(t){debug("wrapped _read",t),n&&(n=!1,e.resume())},r},Readable._fromList=fromList;