// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function push(){var e=chunks-->0?new Buffer(chunkSize):null;e&&(totalPushed+=e.length,e.fill("x")),r.push(e)}function read100(){readn(100,onData)}function readn(e,t){console.error("read %d",e),expectEndingData-=e,function n(){var i=r.read(e);i?(assert.equal(i.length,e),assert(!r._readableState.flowing),t()):r.once("readable",n)}()}function onData(){expectEndingData-=100,console.error("onData");var e=0;r.on("data",function t(n){e+=n.length;if(e>=100){r.removeListener("data",t),r.pause();if(e>100){var i=e-100;r.unshift(n.slice(n.length-i)),console.error("seen too much",e,i)}setImmediate(pipeLittle)}})}function pipeLittle(){expectEndingData-=200,console.error("pipe a little");var e=new Writable,t=0;e.on("finish",function(){assert.equal(t,200),setImmediate(read1234)}),e._write=function(n,i,s){t+=n.length;if(t>=200){r.unpipe(e),e.end(),s();if(t>200){var o=t-200;t-=o,r.unshift(n.slice(n.length-o))}}else setImmediate(s)},r.pipe(e)}function read1234(){readn(1234,resumePause)}function resumePause(){console.error("resumePause"),r.resume(),r.pause(),r.resume(),r.pause(),r.resume(),r.pause(),r.resume(),r.pause(),r.resume(),r.pause(),setImmediate(pipe)}function pipe(){console.error("pipe the rest");var e=new Writable,t=0;e._write=function(e,n,r){t+=e.length,r()},e.on("finish",function(){console.error("written",t,totalPushed),assert.equal(t,expectEndingData),assert.equal(totalPushed,expectTotalData),console.log("ok")}),r.pipe(e)}var common=require("../common"),assert=require("assert"),stream=require("../../"),Readable=stream.Readable,Writable=stream.Writable,totalChunks=100,chunkSize=99,expectTotalData=totalChunks*chunkSize,expectEndingData=expectTotalData,r=new Readable({highWaterMark:1e3}),chunks=totalChunks;r._read=function(e){chunks%2?chunks%3?push():process.nextTick(push):setImmediate(push)};var totalPushed=0;read100();