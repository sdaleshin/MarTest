/*!
 * Connect - utils
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

function noop(){}var http=require("http"),crypto=require("crypto"),parse=require("url").parse,sep=require("path").sep,signature=require("cookie-signature"),nodeVersion=process.versions.node.split(".");exports.brokenPause=parseInt(nodeVersion[0],10)===0&&parseInt(nodeVersion[1],10)<10,exports.hasBody=function(e){var t="transfer-encoding"in e.headers,n="content-length"in e.headers&&e.headers["content-length"]!=="0";return t||n},exports.mime=function(e){var t=e.headers["content-type"]||"";return t.split(";")[0]},exports.error=function(e,t){var n=new Error(t||http.STATUS_CODES[e]);return n.status=e,n},exports.md5=function(e,t){return crypto.createHash("md5").update(e,"utf8").digest(t||"hex")},exports.merge=function(e,t){if(e&&t)for(var n in t)e[n]=t[n];return e},exports.escape=function(e){return String(e).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},exports.sign=function(e,t){return console.warn("do not use utils.sign(), use https://github.com/visionmedia/node-cookie-signature"),e+"."+crypto.createHmac("sha256",t).update(e).digest("base64").replace(/=+$/,"")},exports.unsign=function(e,t){console.warn("do not use utils.unsign(), use https://github.com/visionmedia/node-cookie-signature");var n=e.slice(0,e.lastIndexOf("."));return exports.sign(n,t)==e?n:!1},exports.parseSignedCookies=function(e,t){var n={};return Object.keys(e).forEach(function(r){var i=e[r];0==i.indexOf("s:")&&(i=signature.unsign(i.slice(2),t),i&&(n[r]=i,delete e[r]))}),n},exports.parseSignedCookie=function(e,t){return 0==e.indexOf("s:")?signature.unsign(e.slice(2),t):e},exports.parseJSONCookies=function(e){return Object.keys(e).forEach(function(t){var n=e[t],r=exports.parseJSONCookie(n);r&&(e[t]=r)}),e},exports.parseJSONCookie=function(e){if(0==e.indexOf("j:"))try{return JSON.parse(e.slice(2))}catch(t){}},exports.pause=exports.brokenPause?require("pause"):function(){return{end:noop,resume:noop}},exports.removeContentHeaders=function(e){if(!e._headers)return;Object.keys(e._headers).forEach(function(t){0==t.indexOf("content")&&e.removeHeader(t)})},exports.conditionalGET=function(e){return e.headers["if-modified-since"]||e.headers["if-none-match"]},exports.unauthorized=function(e,t){e.statusCode=401,e.setHeader("WWW-Authenticate",'Basic realm="'+t+'"'),e.end("Unauthorized")},exports.notModified=function(e){exports.removeContentHeaders(e),e.statusCode=304,e.end()},exports.etag=function(e){return'"'+e.size+"-"+Number(e.mtime)+'"'},exports.parseCacheControl=function(e){var t=e.split(","),n={};for(var r=0,i=t.length;r<i;r++){var s=t[r].split("="),o=s.shift().trim(),u=parseInt(s.shift(),10);n[o]=isNaN(u)?!0:u}return n},exports.parseUrl=function(e){var t=e._parsedUrl;return t&&t.href==e.url?t:(t=parse(e.url),t.auth&&!t.protocol&&~t.href.indexOf("//")&&(t=parse(e.url.replace(/@/g,"%40"))),e._parsedUrl=t)},exports.parseBytes=require("bytes"),exports.normalizeSlashes=function(t){return t.split(sep).join("/")};