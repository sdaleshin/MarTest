/*!
 * Connect - HTTPServer
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var http=require("http"),utils=require("./utils"),debug=require("debug")("connect:dispatcher"),app=module.exports={},env=process.env.NODE_ENV||"development";app.use=function(e,t){"string"!=typeof e&&(t=e,e="/");if("function"==typeof t.handle){var n=t;t.route=e,t=function(e,t,r){n.handle(e,t,r)}}return t instanceof http.Server&&(t=t.listeners("request")[0]),"/"==e[e.length-1]&&(e=e.slice(0,-1)),debug("use %s %s",e||"/",t.name||"anonymous"),this.stack.push({route:e,handle:t}),this},app.handle=function(e,t,n){function c(i){var s,h,p;f&&(e.url=e.url.substr(1),f=!1),e.url=u+a+e.url.substr(u.length),e.originalUrl=e.originalUrl||e.url,a="",s=r[l++];if(!s||t.headerSent){if(n)return n(i);if(i){t.statusCode<400&&(t.statusCode=500),debug("default %s",t.statusCode),i.status&&(t.statusCode=i.status);var d="production"==env?http.STATUS_CODES[t.statusCode]:i.stack||i.toString();d=utils.escape(d),"test"!=env&&console.error(i.stack||i.toString());if(t.headerSent)return e.socket.destroy();t.setHeader("Content-Type","text/html"),t.setHeader("Content-Length",Buffer.byteLength(d));if("HEAD"==e.method)return t.end();t.end(d)}else{debug("default 404"),t.statusCode=404,t.setHeader("Content-Type","text/html");if("HEAD"==e.method)return t.end();t.end("Cannot "+utils.escape(e.method)+" "+utils.escape(e.originalUrl)+"\n")}return}try{h=utils.parseUrl(e).pathname,undefined==h&&(h="/");if(0!=h.toLowerCase().indexOf(s.route.toLowerCase()))return c(i);p=h[s.route.length];if(p&&"/"!=p&&"."!=p)return c(i);a=s.route,e.url=u+e.url.substr(u.length+a.length),!o&&"/"!=e.url[0]&&(e.url="/"+e.url,f=!0),debug("%s %s : %s",s.handle.name||"anonymous",s.route,e.originalUrl);var v=s.handle.length;i?v===4?s.handle(i,e,t,c):c(i):v<4?s.handle(e,t,c):c()}catch(m){c(m)}}var r=this.stack,i=1+e.url.indexOf("?"),s=i?i-1:e.url.length,o=1+e.url.substr(0,s).indexOf("://"),u=o?e.url.substr(0,e.url.indexOf("/",2+o)):"",a="",f=!1,l=0;c()},app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};