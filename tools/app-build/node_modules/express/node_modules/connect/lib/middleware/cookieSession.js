/*!
 * Connect - cookieSession
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

var utils=require("./../utils"),Cookie=require("./session/cookie"),debug=require("debug")("connect:cookieSession"),signature=require("cookie-signature"),crc32=require("buffer-crc32"),url=require("url");module.exports=function(t){t=t||{};var n=t.key||"connect.sess",r=t.proxy;return function(i,s,o){var u=t.secret||i.secret;if(!u)throw new Error("`secret` option required for cookie sessions");i.session={};var a=i.session.cookie=new Cookie(t.cookie),f=url.parse(i.originalUrl).pathname;if(0!=f.indexOf(a.path))return o();if(!t.secret&&i.secret)i.session=i.signedCookies[n]||{},i.session.cookie=a;else{var l=i.cookies[n];if(l){var c=utils.parseSignedCookie(l,u);if(c){var h=crc32.signed(c);i.session=utils.parseJSONCookie(c)||{},i.session.cookie=a}}}s.on("header",function(){if(!i.session){debug("clear session"),a.expires=new Date(0),s.setHeader("Set-Cookie",a.serialize(n,""));return}delete i.session.cookie;var e=(i.headers["x-forwarded-proto"]||"").toLowerCase(),t=i.connection.encrypted||r&&"https"==e.split(/\s*,\s*/)[0];if(a.secure&&!t)return debug("not secured");debug("serializing %j",i.session);var o="j:"+JSON.stringify(i.session);if(h==crc32.signed(o))return debug("unmodified session");o="s:"+signature.sign(o,u),o=a.serialize(n,o),debug("set-cookie %j",a),s.setHeader("Set-Cookie",o)}),o()}};