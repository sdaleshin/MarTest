/*!
 * Connect - logger
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

/*!
 * Log buffer.
 */

/*!
 * Default log buffer duration.
 */

function compile(e){e=e.replace(/"/g,'\\"');var t='  return "'+e.replace(/:([-\w]{2,})(?:\[([^\]]+)\])?/g,function(e,t,n){return'"\n    + (tokens["'+t+'"](req, res, "'+n+'") || "-") + "'})+'";';return new Function("tokens, req, res",t)}var bytes=require("bytes"),buf=[],defaultBufferDuration=1e3;exports=module.exports=function(t){"object"==typeof t?t=t||{}:t?t={format:t}:t={};var n=t.immediate,r=exports[t.format]||t.format||exports.default;"function"!=typeof r&&(r=compile(r));var i=t.stream||process.stdout,s=t.buffer;if(s){var o=i,u="number"==typeof s?s:defaultBufferDuration;setInterval(function(){buf.length&&(o.write(buf.join("")),buf.length=0)},u),i={write:function(e){buf.push(e)}}}return function(t,s,o){function a(){s.removeListener("finish",a),s.removeListener("close",a);var e=r(exports,t,s);if(null==e)return;i.write(e+"\n")}var u=t.socket;t._startTime=new Date,t._remoteAddress=u.socket?u.socket.remoteAddress:u.remoteAddress,n?a():(s.on("finish",a),s.on("close",a)),o()}},exports.token=function(e,t){return exports[e]=t,this},exports.format=function(e,t){return exports[e]=t,this},exports.format("default",':remote-addr - - [:date] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'),exports.format("short",":remote-addr - :method :url HTTP/:http-version :status :res[content-length] - :response-time ms"),exports.format("tiny",":method :url :status :res[content-length] - :response-time ms"),exports.format("dev",function(e,t,n){var r=n.statusCode,i=parseInt(n.getHeader("Content-Length"),10),s=32;return r>=500?s=31:r>=400?s=33:r>=300&&(s=36),i=isNaN(i)?"":i=" - "+bytes(i),"[90m"+t.method+" "+t.originalUrl+" "+"["+s+"m"+n.statusCode+" [90m"+(new Date-t._startTime)+"ms"+i+"[0m"}),exports.token("url",function(e){return e.originalUrl||e.url}),exports.token("method",function(e){return e.method}),exports.token("response-time",function(e){return String(Date.now()-e._startTime)}),exports.token("date",function(){return(new Date).toUTCString()}),exports.token("status",function(e,t){return t.headerSent?t.statusCode:null}),exports.token("referrer",function(e){return e.headers.referer||e.headers.referrer}),exports.token("remote-addr",function(e){if(e.ip)return e.ip;if(e._remoteAddress)return e._remoteAddress;var t=e.socket;return t.socket?t.socket.remoteAddress:t.remoteAddress}),exports.token("http-version",function(e){return e.httpVersionMajor+"."+e.httpVersionMinor}),exports.token("user-agent",function(e){return e.headers["user-agent"]}),exports.token("req",function(e,t,n){return e.headers[n.toLowerCase()]}),exports.token("res",function(e,t,n){return(t._headers||{})[n.toLowerCase()]});