/*!
 * Connect - compress
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

function getSize(e){return Buffer.isBuffer(e)?e.length:Buffer.byteLength(e)}function noop(){}var zlib=require("zlib"),utils=require("../utils"),Negotiator=require("negotiator");exports.methods={gzip:zlib.createGzip,deflate:zlib.createDeflate},exports.filter=function(e,t){return/json|text|javascript|dart|image\/svg\+xml|application\/x-font-ttf|application\/vnd\.ms-opentype|application\/vnd\.ms-fontobject/.test(t.getHeader("Content-Type"))},module.exports=function(t){t=t||{};var n=t.filter||exports.filter,r;return!1===t.threshold||0===t.threshold?r=0:"string"==typeof t.threshold?r=utils.parseBytes(t.threshold):r=t.threshold||1024,function i(e,s,o){var u=e.headers["accept-encoding"],a=s.write,f=s.end,i=!0,l;e.on("close",function(){s.write=s.end=function(){}}),s.flush=noop,s.write=function(e,t){if(!this.headerSent){var n=s.getHeader("content-length");!isNaN(n)&&n<r&&(i=!1),this._implicitHeader()}return l?l.write(new Buffer(e,t)):a.call(s,e,t)},s.end=function(e,t){return e?(!this.headerSent&&getSize(e)<r&&(i=!1),this.write(e,t)):this.headerSent||(i=!1),l?l.end():f.call(s)},s.on("header",function(){if(!n(e,s))return;var r=s.getHeader("Vary");r?~r.indexOf("Accept-Encoding")||s.setHeader("Vary",r+", Accept-Encoding"):s.setHeader("Vary","Accept-Encoding");if(!i)return;var o=s.getHeader("Content-Encoding")||"identity";if("identity"!=o)return;if(!u)return;if("HEAD"==e.method)return;var c=(new Negotiator(e)).preferredEncoding(["gzip","deflate","identity"]);if(c==="identity")return;l=exports.methods[c](t),s.flush=function(){l.flush()},s.setHeader("Content-Encoding",c),s.removeHeader("Content-Length"),l.on("data",function(e){a.call(s,e)}),l.on("end",function(){f.call(s)}),l.on("drain",function(){s.emit("drain")})}),o()}};