/*!
 * Connect - staticCache
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

function respondFromCache(e,t,n){var r=n[0],i=utils.merge({},n[1]),s=n.slice(2);i.age=(new Date-new Date(i.date))/1e3||0;switch(e.method){case"HEAD":t.writeHead(r,i),t.end();break;case"GET":if(utils.conditionalGET(e)&&fresh(e.headers,i))i["content-length"]=0,t.writeHead(304,i),t.end();else{t.writeHead(r,i);function o(){while(s.length)if(!1===t.write(s.shift())){t.once("drain",o);return}t.end()}o()}break;default:t.writeHead(500,""),t.end()}}function mustRevalidate(e,t){var n=t[1],r=utils.parseCacheControl(e.headers["cache-control"]||""),i=utils.parseCacheControl(n["cache-control"]||""),s=(new Date-new Date(n.date))/1e3||0;return i["no-cache"]||i["must-revalidate"]||i["proxy-revalidate"]?!0:r["no-cache"]?!0:null!=r["max-age"]?r["max-age"]<s:null!=i["max-age"]?i["max-age"]<s:!1}function cacheKey(e){return utils.parseUrl(e).path}var utils=require("../utils"),Cache=require("../cache"),fresh=require("fresh");module.exports=function(t){var t=t||{},n=new Cache(t.maxObjects||128),r=t.maxLength||262144;return process.env.NODE_ENV!=="test"&&(console.warn("connect.staticCache() is deprecated and will be removed in 3.0"),console.warn("use varnish or similar reverse proxy caches.")),function(t,i,s){var o=cacheKey(t),u=t.headers.range,a=t.headers.cookie,f=n.get(o);t.on("static",function(e){var t=i._headers,s=utils.parseCacheControl(t["cache-control"]||""),u=t["content-length"],f;if(t["set-cookie"])return a=!0;if(a)return;if(!u||u>r)return;if(t["content-range"])return;if(s["no-cache"]||s["no-store"]||s["private"]||s["must-revalidate"])return;if(f=n.get(o)){if(t.etag==f[0].etag){f[0].date=new Date;return}n.remove(o)}if(null==e)return;var l=[];e.on("data",function(e){l.push(e)}),e.on("end",function(){var e=n.add(o);delete t["x-cache"],e.push(200),e.push(t),e.push.apply(e,l)})}),t.method=="GET"||t.method=="HEAD"?u?s():!a&&f&&!mustRevalidate(t,f)?(i.setHeader("X-Cache","HIT"),respondFromCache(t,i,f)):(i.setHeader("X-Cache","MISS"),s()):s()}};