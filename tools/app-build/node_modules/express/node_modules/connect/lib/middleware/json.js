/*!
 * Connect - json
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var utils=require("../utils"),getBody=require("raw-body");exports=module.exports=function(e){e=e||{};var t=e.strict!==!1,n=typeof e.verify=="function"&&e.verify;return function(i,s,o){if(i._body)return o();i.body=i.body||{};if(!utils.hasBody(i))return o();if(!exports.regexp.test(utils.mime(i)))return o();i._body=!0,getBody(i,{limit:e.limit||"1mb",length:i.headers["content-length"],encoding:"utf8"},function(r,u){if(r)return o(r);if(n)try{n(i,s,u)}catch(r){return r.status||(r.status=403),o(r)}var a=u.trim()[0];if(0==u.length)return o(utils.error(400,"invalid json, empty body"));if(t&&"{"!=a&&"["!=a)return o(utils.error(400,"invalid json"));try{i.body=JSON.parse(u,e.reviver)}catch(r){return r.body=u,r.status=400,o(r)}o()})}},exports.regexp=/^application\/([\w!#\$%&\*`\-\.\^~]*\+)?json$/i;