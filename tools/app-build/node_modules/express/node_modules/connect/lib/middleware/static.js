/*!
 * Connect - static
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var send=require("send"),utils=require("../utils"),parse=utils.parseUrl,url=require("url");exports=module.exports=function(e,t){t=t||{};if(!e)throw new Error("static() root path required");var n=!1!==t.redirect;return function(i,s,o){function l(){o(),f.resume()}function c(){if(!n)return l();var e;u.pathname+="/",e=url.format(u),s.statusCode=303,s.setHeader("Location",e),s.end("Redirecting to "+utils.escape(e))}function h(e){if(404==e.status)return l();o(e)}if("GET"!=i.method&&"HEAD"!=i.method)return o();var u=url.parse(i.originalUrl),a=parse(i).pathname,f=utils.pause(i);if(a=="/"&&u.pathname[u.pathname.length-1]!="/")return c();send(i,a).maxage(t.maxAge||0).root(e).index(t.index||"index.html").hidden(t.hidden).on("error",h).on("directory",c).pipe(s)}},exports.mime=send.mime;