/*!
 * Connect - urlencoded
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var utils=require("../utils"),getBody=require("raw-body"),qs=require("qs");exports=module.exports=function(e){e=e||{};var t=typeof e.verify=="function"&&e.verify;return function(r,i,s){if(r._body)return s();r.body=r.body||{};if(!utils.hasBody(r))return s();if("application/x-www-form-urlencoded"!=utils.mime(r))return s();r._body=!0,getBody(r,{limit:e.limit||"1mb",length:r.headers["content-length"],encoding:"utf8"},function(n,o){if(n)return s(n);if(t)try{t(r,i,o)}catch(n){return n.status||(n.status=403),s(n)}try{r.body=o.length?qs.parse(o,e):{}}catch(n){return n.body=o,s(n)}s()})}};