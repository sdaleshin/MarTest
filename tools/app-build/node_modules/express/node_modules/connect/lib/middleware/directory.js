/*!
 * Connect - directory
 * Copyright(c) 2011 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

/*!
 * Icon cache.
 */

function fileSort(e,t){return Number(t.stat&&t.stat.isDirectory())-Number(e.stat&&e.stat.isDirectory())||String(e.name).toLocaleLowerCase().localeCompare(String(t.name).toLocaleLowerCase())}function htmlPath(e){var t=[];return e.split("/").map(function(e){return t.push(encodeURIComponent(e)),e?'<a href="'+t.join("/")+'">'+e+"</a>":""}).join(" / ")}function iconStyle(e,t){if(!t)return"";var n={},r={tiles:[],details:[],mobile:[]};for(var i=0;i<e.length;i++){var s=e[i];if(s.name=="..")continue;var o=".."==s.name||s.stat&&s.stat.isDirectory(),u=o?icons.folder:icons[extname(s.name)]||icons.default,a=extname(s.name);a=o?".directory":icons[a]?a:".default";if(n[u])continue;n[u]=a+" .name{background-image: url(data:image/png;base64,"+load(u)+");}",r.tiles.push(".view-tiles "+n[u]),r.details.push(".view-details "+n[u]),r.mobile.push("#files "+n[u])}var f=r.tiles.join("\n")+"\n"+r.details.join("\n")+"\n@media (max-width: 768px) {\n	"+r.mobile.join("\n	")+"\n}";return f}function html(e,t,n,r){return'<ul id="files" class="view-'+r+'">'+(r=="details"?'<li class="header"><span class="name">Name</span><span class="size">Size</span><span class="date">Modified</span></li>':"")+e.map(function(e){var r,i=[],s=t.split("/").map(function(e){return encodeURIComponent(e)});if(n){var o=extname(e.name);r=".."==e.name||e.stat&&e.stat.isDirectory(),o=r?".directory":icons[o]?o:".default",i.push("icon"),i.push(o.replace(".",""))}s.push(encodeURIComponent(e.name));var u=e.name==".."?"":e.stat.mtime.toDateString()+" "+e.stat.mtime.toLocaleTimeString(),a=e.name==".."?"":e.stat.size;return'<li><a href="'+utils.normalizeSlashes(normalize(s.join("/")))+'" class="'+i.join(" ")+'"'+' title="'+e.name+'">'+'<span class="name">'+e.name+"</span>"+'<span class="size">'+a+"</span>"+'<span class="date">'+u+"</span>"+"</a></li>"}).join("\n")+"</ul>"}function load(e){return cache[e]?cache[e]:cache[e]=fs.readFileSync(__dirname+"/../public/icons/"+e,"base64")}function removeHidden(e){return e.filter(function(e){return"."!=e[0]})}function stat(e,t,n){var r=new Batch;r.concurrency(10),t.forEach(function(t,n){r.push(function(n){fs.stat(join(e,t),n)})}),r.end(n)}var fs=require("fs"),parse=require("url").parse,utils=require("../utils"),path=require("path"),normalize=path.normalize,sep=path.sep,extname=path.extname,join=path.join,Batch=require("batch"),Negotiator=require("negotiator"),cache={},mediaTypes=["text/html","text/plain","application/json"],mediaType={"text/html":"html","text/plain":"plain","application/json":"json"};exports=module.exports=function(t,n){n=n||{};if(!t)throw new Error("directory() root path required");var r=n.hidden,i=n.icons,s=n.view||"tiles",o=n.filter,t=normalize(t+sep);return function(n,u,a){if("GET"!=n.method&&"HEAD"!=n.method)return a();var f=parse(n.url),l=decodeURIComponent(f.pathname),c=normalize(join(t,l)),h=parse(n.originalUrl),p=decodeURIComponent(h.pathname),d=c!=t;if(~c.indexOf("\0"))return a(utils.error(400));if(0!=c.indexOf(t))return a(utils.error(403));fs.stat(c,function(e,t){if(e)return"ENOENT"==e.code?a():a(e);if(!t.isDirectory())return a();fs.readdir(c,function(e,t){if(e)return a(e);r||(t=removeHidden(t)),o&&(t=t.filter(o)),t.sort();var f=(new Negotiator(n)).preferredMediaType(mediaTypes);if(!f)return a(utils.error(406));exports[mediaType[f]](n,u,t,a,p,d,i,c,s)})})}},exports.html=function(e,t,n,r,i,s,o,u,a){fs.readFile(__dirname+"/../public/directory.html","utf8",function(e,f){if(e)return r(e);fs.readFile(__dirname+"/../public/style.css","utf8",function(e,l){if(e)return r(e);stat(u,n,function(e,u){if(e)return r(e);n=n.map(function(e,t){return{name:e,stat:u[t]}}),n.sort(fileSort),s&&n.unshift({name:".."}),f=f.replace("{style}",l.concat(iconStyle(n,o))).replace("{files}",html(n,i,o,a)).replace("{directory}",i).replace("{linked-path}",htmlPath(i)),t.setHeader("Content-Type","text/html"),t.setHeader("Content-Length",f.length),t.end(f)})})})},exports.json=function(e,t,n){n=JSON.stringify(n),t.setHeader("Content-Type","application/json"),t.setHeader("Content-Length",n.length),t.end(n)},exports.plain=function(e,t,n){n=n.join("\n")+"\n",t.setHeader("Content-Type","text/plain"),t.setHeader("Content-Length",n.length),t.end(n)};var icons={".js":"page_white_code_red.png",".c":"page_white_c.png",".h":"page_white_h.png",".cc":"page_white_cplusplus.png",".php":"page_white_php.png",".rb":"page_white_ruby.png",".cpp":"page_white_cplusplus.png",".swf":"page_white_flash.png",".pdf":"page_white_acrobat.png",folder:"folder.png","default":"page_white.png"};