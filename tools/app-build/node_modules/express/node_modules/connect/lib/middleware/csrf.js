/*!
 * Connect - csrf
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

function defaultValue(e){return e.body&&e.body._csrf||e.query&&e.query._csrf||e.headers["x-csrf-token"]||e.headers["x-xsrf-token"]}function saltedToken(e){return createToken(generateSalt(10),e)}function createToken(e,t){return e+crypto.createHash("sha1").update(e+t).digest("base64")}function checkToken(e,t){return"string"!=typeof e?!1:e===createToken(e.slice(0,10),t)}function generateSalt(e){var t,n=[];for(t=0;t<e;++t)n.push(SALTCHARS[Math.floor(Math.random()*SALTCHARS.length)]);return n.join("")}var utils=require("../utils"),uid=require("uid2"),crypto=require("crypto");module.exports=function(t){t=t||{};var n=t.value||defaultValue;return function(e,t,r){function s(t){var i;e.csrfToken=function(){return i||(i=saltedToken(t))},Object.defineProperty(e.session,"_csrf",{configurable:!0,get:function(){return console.warn("req.session._csrf is deprecated, use req.csrfToken() instead"),e.csrfToken()}});if("GET"==e.method||"HEAD"==e.method||"OPTIONS"==e.method)return r();var s=n(e);if(!checkToken(s,t))return r(utils.error(403));r()}var i=e.session._csrfSecret;if(i)return s(i);uid(24,function(t,n){if(t)return r(t);e.session._csrfSecret=n,s(n)})}};var SALTCHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";