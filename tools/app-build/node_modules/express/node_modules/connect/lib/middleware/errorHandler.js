/*!
 * Connect - errorHandler
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var utils=require("../utils"),fs=require("fs"),env=process.env.NODE_ENV||"development";exports=module.exports=function(){return function(t,n,r,i){t.status&&(r.statusCode=t.status),r.statusCode<400&&(r.statusCode=500),"test"!=env&&console.error(t.stack);var s=n.headers.accept||"";if(~s.indexOf("html"))fs.readFile(__dirname+"/../public/style.css","utf8",function(e,n){fs.readFile(__dirname+"/../public/error.html","utf8",function(e,i){var s=(t.stack||"").split("\n").slice(1).map(function(e){return"<li>"+e+"</li>"}).join("");i=i.replace("{style}",n).replace("{stack}",s).replace("{title}",exports.title).replace("{statusCode}",r.statusCode).replace(/\{error\}/g,utils.escape(t.toString().replace(/\n/g,"<br/>"))),r.setHeader("Content-Type","text/html; charset=utf-8"),r.end(i)})});else if(~s.indexOf("json")){var o={message:t.message,stack:t.stack};for(var u in t)o[u]=t[u];var a=JSON.stringify({error:o});r.setHeader("Content-Type","application/json"),r.end(a)}else r.setHeader("Content-Type","text/plain"),r.end(t.stack)}},exports.title="Connect";