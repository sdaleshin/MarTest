/*!
 * Connect - limit
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var utils=require("../utils"),brokenPause=utils.brokenPause;module.exports=function(t){"string"==typeof t&&(t=utils.parseBytes(t));if("number"!=typeof t)throw new Error("limit() bytes required");return process.env.NODE_ENV!=="test"&&console.warn("connect.limit() will be removed in connect 3.0"),function(n,r,i){function u(){n.on("data",function(e){s+=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e),s>t&&n.destroy()})}var s=0,o=n.headers["content-length"]?parseInt(n.headers["content-length"],10):null;if(n._limit)return i();n._limit=!0;if(o&&o>t)return i(utils.error(413));brokenPause?u():n.on("newListener",function a(e){if(e!=="data")return;n.removeListener("newListener",a),process.nextTick(u)}),i()}};