/*!
 * Connect - multipart
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var multiparty=require("multiparty"),_limit=require("./limit"),utils=require("../utils"),qs=require("qs");exports=module.exports=function(e){e=e||{},process.env.NODE_ENV!=="test"&&(console.warn("connect.multipart() will be removed in connect 3.0"),console.warn("visit https://github.com/senchalabs/connect/wiki/Connect-3.0 for alternatives"));var t=_limit(e.limit||"100mb");return function(r,i,s){if(r._body)return s();r.body=r.body||{},r.files=r.files||{};if(!utils.hasBody(r))return s();if("GET"==r.method||"HEAD"==r.method)return s();if("multipart/form-data"!=utils.mime(r))return s();r._body=!0,t(r,i,function(t){function a(e,t,n){Array.isArray(n[e])?n[e].push(t):n[e]?n[e]=[n[e],t]:n[e]=t}if(t)return s(t);var n=new multiparty.Form(e),i={},o={},u;Object.keys(e).forEach(function(t){n[t]=e[t]}),n.on("field",function(e,t){a(e,t,i)}),e.defer||n.on("file",function(e,t){t.name=t.originalFilename,t.type=t.headers["content-type"]||null,a(e,t,o)}),n.on("error",function(t){e.defer||(t.status=400,s(t)),u=!0}),n.on("close",function(){if(u)return;try{r.body=qs.parse(i),r.files=qs.parse(o)}catch(t){n.emit("error",t);return}e.defer||s()}),n.parse(r),e.defer&&(r.form=n,s())})}};