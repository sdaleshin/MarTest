/*!
 * commander
 * Copyright(c) 2011 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */

function Option(e,t){this.flags=e,this.required=~e.indexOf("<"),this.optional=~e.indexOf("["),this.bool=!~e.indexOf("-no-"),e=e.split(/[ ,|]+/),e.length>1&&!/^[[<]/.test(e[1])&&(this.short=e.shift()),this.long=e.shift(),this.description=t||""}function Command(e){this.commands=[],this.options=[],this._execs=[],this._args=[],this._name=e}function camelcase(e){return e.split("-").reduce(function(e,t){return e+t[0].toUpperCase()+t.slice(1)})}function parseBool(e){return/^y|yes|ok|true$/i.test(e)}function pad(e,t){var n=Math.max(0,t-e.length);return e+Array(n+1).join(" ")}function outputHelpIfNecessary(e,t){t=t||[];for(var n=0;n<t.length;n++)if(t[n]=="--help"||t[n]=="-h")e.outputHelp(),process.exit(0)}var EventEmitter=require("events").EventEmitter,spawn=require("child_process").spawn,keypress=require("keypress"),fs=require("fs"),exists=fs.existsSync,path=require("path"),tty=require("tty"),dirname=path.dirname,basename=path.basename;exports=module.exports=new Command,exports.Command=Command,exports.Option=Option,Option.prototype.name=function(){return this.long.replace("--","").replace("no-","")},Option.prototype.is=function(e){return e==this.short||e==this.long},Command.prototype.__proto__=EventEmitter.prototype,Command.prototype.command=function(e,t){var n=e.split(/ +/),r=new Command(n.shift());return t&&r.description(t),t&&(this.executables=!0),t&&(this._execs[r._name]=!0),this.commands.push(r),r.parseExpectedArgs(n),r.parent=this,t?this:r},Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")},Command.prototype.parseExpectedArgs=function(e){if(!e.length)return;var t=this;return e.forEach(function(e){switch(e[0]){case"<":t._args.push({required:!0,name:e.slice(1,-1)});break;case"[":t._args.push({required:!1,name:e.slice(1,-1)})}}),this},Command.prototype.action=function(e){var t=this;return this.parent.on(this._name,function(n,r){r=r||[];var i=t.parseOptions(r);outputHelpIfNecessary(t,i.unknown),i.unknown.length>0&&t.unknownOption(i.unknown[0]),i.args.length&&(n=i.args.concat(n)),t._args.forEach(function(e,r){e.required&&null==n[r]&&t.missingArgument(e.name)}),t._args.length?n[t._args.length]=t:n.push(t),e.apply(this,n)}),this},Command.prototype.option=function(e,t,n,r){var i=this,s=new Option(e,t),o=s.name(),u=camelcase(o);"function"!=typeof n&&(r=n,n=null);if(0==s.bool||s.optional||s.required)0==s.bool&&(r=!0),undefined!==r&&(i[u]=r);return this.options.push(s),this.on(o,function(e){null!=e&&n&&(e=n(e)),"boolean"==typeof i[u]||"undefined"==typeof i[u]?null==e?i[u]=s.bool?r||!0:!1:i[u]=e:null!==e&&(i[u]=e)}),this},Command.prototype.parse=function(e){this.executables&&this.addImplicitHelpCommand(),this.rawArgs=e,this._name=this._name||basename(e[1]);var t=this.parseOptions(this.normalize(e.slice(2))),n=this.args=t.args,r=this.parseArgs(this.args,t.unknown),i=r.args[0];return this._execs[i]?this.executeSubCommand(e,n,t.unknown):r},Command.prototype.executeSubCommand=function(e,t,n){t=t.concat(n),t.length||this.help(),"help"==t[0]&&1==t.length&&this.help(),"help"==t[0]&&(t[0]=t[1],t[1]="--help");var r=dirname(e[1]),i=basename(e[1])+"-"+t[0],s=path.join(r,i);t=t.slice(1);var o=spawn(s,t,{stdio:"inherit",customFds:[0,1,2]});o.on("error",function(e){e.code=="ENOENT"?console.error("\n  %s(1) does not exist, try --help\n",i):e.code=="EACCES"&&console.error("\n  %s(1) not executable. try chmod or run with root\n",i)}),this.runningCommand=o},Command.prototype.normalize=function(e){var t=[],n,r;for(var i=0,s=e.length;i<s;++i)n=e[i],n.length>1&&"-"==n[0]&&"-"!=n[1]?n.slice(1).split("").forEach(function(e){t.push("-"+e)}):/^--/.test(n)&&~(r=n.indexOf("="))?t.push(n.slice(0,r),n.slice(r+1)):t.push(n);return t},Command.prototype.parseArgs=function(e,t){var n=this.commands,r=n.length,i;return e.length?(i=e[0],this.listeners(i).length?this.emit(e.shift(),e,t):this.emit("*",e)):(outputHelpIfNecessary(this,t),t.length>0&&this.unknownOption(t[0])),this},Command.prototype.optionFor=function(e){for(var t=0,n=this.options.length;t<n;++t)if(this.options[t].is(e))return this.options[t]},Command.prototype.parseOptions=function(e){var t=[],n=e.length,r,i,s,o=[];for(var u=0;u<n;++u){s=e[u];if("--"==s){r=!0;continue}if(r){t.push(s);continue}i=this.optionFor(s);if(i){if(i.required){s=e[++u];if(null==s)return this.optionMissingArgument(i);if("-"==s[0]&&"-"!=s)return this.optionMissingArgument(i,s);this.emit(i.name(),s)}else i.optional?(s=e[u+1],null==s||"-"==s[0]&&"-"!=s?s=null:++u,this.emit(i.name(),s)):this.emit(i.name());continue}if(s.length>1&&"-"==s[0]){o.push(s),e[u+1]&&"-"!=e[u+1][0]&&o.push(e[++u]);continue}t.push(s)}return{args:t,unknown:o}},Command.prototype.missingArgument=function(e){console.error(),console.error("  error: missing required argument `%s'",e),console.error(),process.exit(1)},Command.prototype.optionMissingArgument=function(e,t){console.error(),t?console.error("  error: option `%s' argument missing, got `%s'",e.flags,t):console.error("  error: option `%s' argument missing",e.flags),console.error(),process.exit(1)},Command.prototype.unknownOption=function(e){console.error(),console.error("  error: unknown option `%s'",e),console.error(),process.exit(1)},Command.prototype.version=function(e,t){return 0==arguments.length?this._version:(this._version=e,t=t||"-V, --version",this.option(t,"output the version number"),this.on("version",function(){console.log(e),process.exit(0)}),this)},Command.prototype.description=function(e){return 0==arguments.length?this._description:(this._description=e,this)},Command.prototype.usage=function(e){var t=this._args.map(function(e){return e.required?"<"+e.name+">":"["+e.name+"]"}),n="[options"+(this.commands.length?"] [command":"")+"]"+(this._args.length?" "+t:"");return 0==arguments.length?this._usage||n:(this._usage=e,this)},Command.prototype.largestOptionLength=function(){return this.options.reduce(function(e,t){return Math.max(e,t.flags.length)},0)},Command.prototype.optionHelp=function(){var e=this.largestOptionLength();return[pad("-h, --help",e)+"  "+"output usage information"].concat(this.options.map(function(t){return pad(t.flags,e)+"  "+t.description})).join("\n")},Command.prototype.commandHelp=function(){return this.commands.length?["","  Commands:","",this.commands.map(function(e){var t=e._args.map(function(e){return e.required?"<"+e.name+">":"["+e.name+"]"}).join(" ");return pad(e._name+(e.options.length?" [options]":"")+" "+t,22)+(e.description()?" "+e.description():"")}).join("\n").replace(/^/gm,"    "),""].join("\n"):""},Command.prototype.helpInformation=function(){return["","  Usage: "+this._name+" "+this.usage(),""+this.commandHelp(),"  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""].join("\n")},Command.prototype.promptForNumber=function(e,t){var n=this;this.promptSingleLine(e,function r(i){i=Number(i);if(isNaN(i))return n.promptSingleLine(e+"(must be a number) ",r);t(i)})},Command.prototype.promptForDate=function(e,t){var n=this;this.promptSingleLine(e,function r(i){i=new Date(i);if(isNaN(i.getTime()))return n.promptSingleLine(e+"(must be a date) ",r);t(i)})},Command.prototype.promptForRegexp=function(e,t,n){var r=this;this.promptSingleLine(e,function i(s){if(!t.test(s))return r.promptSingleLine(e+"(regular expression mismatch) ",i);n(s)})},Command.prototype.promptSingleLine=function(e,t){if(arguments[1].global!==undefined&&arguments[1].multiline!==undefined)return this.promptForRegexp(e,arguments[1],arguments[2]);if("function"==typeof arguments[2])return this["promptFor"+(t.name||t)](e,arguments[2]);process.stdout.write(e),process.stdin.setEncoding("utf8"),process.stdin.once("data",function(e){t(e.trim())}).resume()},Command.prototype.promptMultiLine=function(e,t){var n=[];console.log(e),process.stdin.setEncoding("utf8"),process.stdin.on("data",function(e){"\n"==e||"\r\n"==e?(process.stdin.removeAllListeners("data"),t(n.join("\n"))):n.push(e.trimRight())}).resume()},Command.prototype.prompt=function(e,t){var n=this;if("string"==typeof e){if(/ $/.test(e))return this.promptSingleLine.apply(this,arguments);this.promptMultiLine(e,t)}else{var r=Object.keys(e),i={};function s(){var o=r.shift(),u=e[o];if(!o)return t(i);n.prompt(u,function(e){i[o]=e,s()})}s()}},Command.prototype.password=function(e,t,n){function s(e){process.stdin.setRawMode?process.stdin.setRawMode(e):tty.setRawMode(e)}var r=this,i="";"function"==typeof t&&(n=t,t=""),keypress(process.stdin),s(!0),process.stdout.write(e),process.stdin.on("keypress",function(o,u){if(u&&"enter"==u.name){console.log(),process.stdin.pause(),process.stdin.removeAllListeners("keypress"),s(!1);if(!i.trim().length)return r.password(e,t,n);n(i);return}u&&u.ctrl&&"c"==u.name&&(console.log("%s",i),process.exit()),process.stdout.write(t),i+=o}).resume()},Command.prototype.confirm=function(e,t,n){var r=this;this.prompt(e,function(i){if(!i.trim())return n||(e+="(yes or no) "),r.confirm(e,t,!0);t(parseBool(i))})},Command.prototype.choose=function(e,t,n){function s(){r.prompt("  : ",function(r){r=parseInt(r,10)-1,i&&isNaN(r)&&(r=t),null==e[r]?s():n(r,e[r])})}var r=this,i="number"==typeof t;i||(n=t,t=null),e.forEach(function(e,n){i&&n==t?console.log("* %d) %s",n+1,e):console.log("  %d) %s",n+1,e)}),s()},Command.prototype.outputHelp=function(){process.stdout.write(this.helpInformation()),this.emit("--help")},Command.prototype.help=function(){this.outputHelp(),process.exit()};