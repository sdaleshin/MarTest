function send(e,t,n){return new SendStream(e,t,n)}function SendStream(e,t,n){var r=this;this.req=e,this.path=t,this.options=n||{},this.maxage(0),this.hidden(!1),this.index("index.html")}var debug=require("debug")("send"),parseRange=require("range-parser"),Stream=require("stream"),mime=require("mime"),fresh=require("fresh"),path=require("path"),http=require("http"),fs=require("fs"),basename=path.basename,normalize=path.normalize,join=path.join,utils=require("./utils");exports=module.exports=send,exports.mime=mime,SendStream.prototype.__proto__=Stream.prototype,SendStream.prototype.hidden=function(e){return debug("hidden %s",e),this._hidden=e,this},SendStream.prototype.index=function(e){return debug("index %s",e),this._index=e,this},SendStream.prototype.root=SendStream.prototype.from=function(e){return this._root=normalize(e),this},SendStream.prototype.maxage=function(e){return Infinity==e&&(e=31536e6),debug("max-age %d",e),this._maxage=e,this},SendStream.prototype.error=function(e,t){var n=this.res,r=http.STATUS_CODES[e];t=t||new Error(r),t.status=e;if(this.listeners("error").length)return this.emit("error",t);n.statusCode=t.status,n.end(r)},SendStream.prototype.isMalicious=function(){return!this._root&&~this.path.indexOf("..")},SendStream.prototype.hasTrailingSlash=function(){return"/"==this.path[this.path.length-1]},SendStream.prototype.hasLeadingDot=function(){return"."==basename(this.path)[0]},SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]},SendStream.prototype.removeContentHeaderFields=function(){var e=this.res;Object.keys(e._headers).forEach(function(t){0==t.indexOf("content")&&e.removeHeader(t)})},SendStream.prototype.notModified=function(){var e=this.res;debug("not modified"),this.removeContentHeaderFields(),e.statusCode=304,e.end()},SendStream.prototype.isCachable=function(){var e=this.res;return e.statusCode>=200&&e.statusCode<300||304==e.statusCode},SendStream.prototype.onStatError=function(e){var t=["ENOENT","ENAMETOOLONG","ENOTDIR"];if(~t.indexOf(e.code))return this.error(404,e);this.error(500,e)},SendStream.prototype.isFresh=function(){return fresh(this.req.headers,this.res._headers)},SendStream.prototype.redirect=function(e){if(this.listeners("directory").length)return this.emit("directory");var t=this.res;e+="/",t.statusCode=301,t.setHeader("Location",e),t.end("Redirecting to "+utils.escape(e))},SendStream.prototype.pipe=function(e){var t=this,n=arguments,r=this.path,i=this._root;return this.res=e,r=utils.decode(r),-1==r?this.error(400):~r.indexOf("\0")?this.error(400):(i&&(r=normalize(join(this._root,r))),this.isMalicious()?this.error(403):i&&0!=r.indexOf(i)?this.error(403):!this._hidden&&this.hasLeadingDot()?this.error(404):(this._index&&this.hasTrailingSlash()&&(r+=this._index),debug('stat "%s"',r),fs.stat(r,function(e,n){if(e)return t.onStatError(e);if(n.isDirectory())return t.redirect(t.path);t.emit("file",r,n),t.send(r,n)}),e))},SendStream.prototype.send=function(e,t){var n=this.options,r=t.size,i=this.res,s=this.req,o=s.headers.range,u=n.start||0;this.setHeader(t),this.type(e);if(this.isConditionalGET()&&this.isCachable()&&this.isFresh())return this.notModified();r=Math.max(0,r-u);if(n.end!==undefined){var a=n.end-u+1;r>a&&(r=a)}if(o){o=parseRange(r,o);if(-1==o)return i.setHeader("Content-Range","bytes */"+t.size),this.error(416);-2!=o&&(n.start=u+o[0].start,n.end=u+o[0].end,i.statusCode=206,i.setHeader("Content-Range","bytes "+o[0].start+"-"+o[0].end+"/"+r),r=n.end-n.start+1)}i.setHeader("Content-Length",r);if("HEAD"==s.method)return i.end();this.stream(e,n)},SendStream.prototype.stream=function(e,t){var n=this,r=this.res,i=this.req,s=fs.createReadStream(e,t);this.emit("stream",s),s.pipe(r),i.on("close",s.destroy.bind(s)),s.on("error",function(e){if(r._header){console.error(e.stack),i.destroy();return}e.status=500,n.emit("error",e)}),s.on("end",function(){n.emit("end")})},SendStream.prototype.type=function(e){var t=this.res;if(t.getHeader("Content-Type"))return;var n=mime.lookup(e),r=mime.charsets.lookup(n);debug("content-type %s",n),t.setHeader("Content-Type",n+(r?"; charset="+r:""))},SendStream.prototype.setHeader=function(e){var t=this.res;t.getHeader("Accept-Ranges")||t.setHeader("Accept-Ranges","bytes"),t.getHeader("ETag")||t.setHeader("ETag",utils.etag(e)),t.getHeader("Date")||t.setHeader("Date",(new Date).toUTCString()),t.getHeader("Cache-Control")||t.setHeader("Cache-Control","public, max-age="+this._maxage/1e3),t.getHeader("Last-Modified")||t.setHeader("Last-Modified",e.mtime.toUTCString())};