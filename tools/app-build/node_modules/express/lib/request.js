var http=require("http"),utils=require("./utils"),connect=require("connect"),fresh=require("fresh"),parseRange=require("range-parser"),parse=connect.utils.parseUrl,mime=connect.mime,req=exports=module.exports={__proto__:http.IncomingMessage.prototype};req.get=req.header=function(e){switch(e=e.toLowerCase()){case"referer":case"referrer":return this.headers.referrer||this.headers.referer;default:return this.headers[e]}},req.accepts=function(e){var t=arguments.length>1?[].slice.apply(arguments):e;return utils.accepts(t,this.get("Accept"))},req.acceptsEncoding=function(e){return!!~this.acceptedEncodings.indexOf(e)},req.acceptsCharset=function(e){var t=this.acceptedCharsets;return t.length?!!~t.indexOf(e):!0},req.acceptsLanguage=function(e){var t=this.acceptedLanguages;return t.length?!!~t.indexOf(e):!0},req.range=function(e){var t=this.get("Range");if(!t)return;return parseRange(e,t)},req.__defineGetter__("acceptedEncodings",function(){var e=this.get("Accept-Encoding");return e?e.trim().split(/ *, */):[]}),req.__defineGetter__("accepted",function(){var e=this.get("Accept");return e?utils.parseAccept(e):[]}),req.__defineGetter__("acceptedLanguages",function(){var e=this.get("Accept-Language");return e?utils.parseParams(e).map(function(e){return e.value}):[]}),req.__defineGetter__("acceptedCharsets",function(){var e=this.get("Accept-Charset");return e?utils.parseParams(e).map(function(e){return e.value}):[]}),req.param=function(e,t){var n=this.params||{},r=this.body||{},i=this.query||{};return null!=n[e]&&n.hasOwnProperty(e)?n[e]:null!=r[e]?r[e]:null!=i[e]?i[e]:t},req.is=function(e){var t=this.get("Content-Type");return t?(t=t.split(";")[0],~e.indexOf("/")||(e=mime.lookup(e)),~e.indexOf("*")?(e=e.split("/"),t=t.split("/"),"*"==e[0]&&e[1]==t[1]?!0:"*"==e[1]&&e[0]==t[0]?!0:!1):!!~t.indexOf(e)):!1},req.__defineGetter__("protocol",function(){var e=this.app.get("trust proxy");if(this.connection.encrypted)return"https";if(!e)return"http";var t=this.get("X-Forwarded-Proto")||"http";return t.split(/\s*,\s*/)[0]}),req.__defineGetter__("secure",function(){return"https"==this.protocol}),req.__defineGetter__("ip",function(){return this.ips[0]||this.connection.remoteAddress}),req.__defineGetter__("ips",function(){var e=this.app.get("trust proxy"),t=this.get("X-Forwarded-For");return e&&t?t.split(/ *, */):[]}),req.__defineGetter__("auth",function(){var e=this.get("Authorization");if(!e)return;var t=e.split(" ");if("basic"!=t[0].toLowerCase())return;if(!t[1])return;e=t[1],e=(new Buffer(e,"base64")).toString().match(/^([^:]*):(.*)$/);if(!e)return;return{username:e[1],password:e[2]}}),req.__defineGetter__("subdomains",function(){var e=this.app.get("subdomain offset");return(this.host||"").split(".").reverse().slice(e)}),req.__defineGetter__("path",function(){return parse(this).pathname}),req.__defineGetter__("host",function(){var e=this.app.get("trust proxy"),t=e&&this.get("X-Forwarded-Host");t=t||this.get("Host");if(!t)return;return t.split(":")[0]}),req.__defineGetter__("fresh",function(){var e=this.method,t=this.res.statusCode;return"GET"!=e&&"HEAD"!=e?!1:t>=200&&t<300||304==t?fresh(this.headers,this.res._headers):!1}),req.__defineGetter__("stale",function(){return!this.fresh}),req.__defineGetter__("xhr",function(){var e=this.get("X-Requested-With")||"";return"xmlhttprequest"==e.toLowerCase()});