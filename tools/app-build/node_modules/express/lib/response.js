var http=require("http"),path=require("path"),connect=require("connect"),utils=connect.utils,sign=require("cookie-signature").sign,normalizeType=require("./utils").normalizeType,normalizeTypes=require("./utils").normalizeTypes,etag=require("./utils").etag,statusCodes=http.STATUS_CODES,cookie=require("cookie"),send=require("send"),mime=connect.mime,resolve=require("url").resolve,basename=path.basename,extname=path.extname,res=module.exports={__proto__:http.ServerResponse.prototype};res.status=function(e){return this.statusCode=e,this},res.links=function(e){var t=this.get("Link")||"";return t&&(t+=", "),this.set("Link",t+Object.keys(e).map(function(t){return"<"+e[t]+'>; rel="'+t+'"'}).join(", "))},res.send=function(e){var t=this.req,n="HEAD"==t.method,r,i=this.app;2==arguments.length&&("number"!=typeof e&&"number"==typeof arguments[1]?this.statusCode=arguments[1]:(this.statusCode=e,e=arguments[1]));switch(typeof e){case"number":this.get("Content-Type")||this.type("txt"),this.statusCode=e,e=http.STATUS_CODES[e];break;case"string":this.get("Content-Type")||(this.charset=this.charset||"utf-8",this.type("html"));break;case"boolean":case"object":if(null==e)e="";else{if(!Buffer.isBuffer(e))return this.json(e);this.get("Content-Type")||this.type("bin")}}undefined!==e&&!this.get("Content-Length")&&this.set("Content-Length",r=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e)),i.settings.etag&&r&&"GET"==t.method&&(this.get("ETag")||this.set("ETag",etag(e))),t.fresh&&(this.statusCode=304);if(204==this.statusCode||304==this.statusCode)this.removeHeader("Content-Type"),this.removeHeader("Content-Length"),this.removeHeader("Transfer-Encoding"),e="";return this.end(n?null:e),this},res.json=function(e){2==arguments.length&&("number"==typeof arguments[1]?this.statusCode=arguments[1]:(this.statusCode=e,e=arguments[1]));var t=this.app,n=t.get("json replacer"),r=t.get("json spaces"),i=JSON.stringify(e,n,r);return this.charset=this.charset||"utf-8",this.get("Content-Type")||this.set("Content-Type","application/json"),this.send(i)},res.jsonp=function(e){2==arguments.length&&("number"==typeof arguments[1]?this.statusCode=arguments[1]:(this.statusCode=e,e=arguments[1]));var t=this.app,n=t.get("json replacer"),r=t.get("json spaces"),i=JSON.stringify(e,n,r).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),s=this.req.query[t.get("jsonp callback name")];this.charset=this.charset||"utf-8",this.set("Content-Type","application/json");if(s){Array.isArray(s)&&(s=s[0]),this.set("Content-Type","text/javascript");var o=s.replace(/[^\[\]\w$.]/g,"");i="typeof "+o+" === 'function' && "+o+"("+i+");"}return this.send(i)},res.sendfile=function(e,t,n){function u(e){if(o)return;o=!0,f(),r.headerSent||r.removeHeader("Content-Disposition");if(n)return n(e);if(r.headerSent)return;s(e)}function a(e){if(o)return;f(),n&&e.on("end",n)}function f(){i.socket.removeListener("error",u)}var r=this,i=r.req,s=this.req.next,t=t||{},o;"function"==typeof t&&(n=t,t={}),i.socket.on("error",u);var l=send(i,e);t.root&&l.root(t.root),l.maxage(t.maxAge||0),l.on("error",u),l.on("directory",s),l.on("stream",a),l.pipe(this),this.on("finish",f)},res.download=function(e,t,n){return"function"==typeof t&&(n=t,t=null),t=t||e,this.set("Content-Disposition",'attachment; filename="'+basename(t)+'"'),this.sendfile(e,n)},res.contentType=res.type=function(e){return this.set("Content-Type",~e.indexOf("/")?e:mime.lookup(e))},res.format=function(e){var t=this.req,n=t.next,r=e.default;r&&delete e.default;var i=Object.keys(e),s=t.accepts(i);this.vary("Accept");if(s){var o=normalizeType(s).value,u=mime.charsets.lookup(o);u&&(o+="; charset="+u),this.set("Content-Type",o),e[s](t,this,n)}else if(r)r();else{var a=new Error("Not Acceptable");a.status=406,a.types=normalizeTypes(i).map(function(e){return e.value}),n(a)}return this},res.attachment=function(e){return e&&this.type(extname(e)),this.set("Content-Disposition",e?'attachment; filename="'+basename(e)+'"':"attachment"),this},res.set=res.header=function(e,t){if(2==arguments.length)Array.isArray(t)?t=t.map(String):t=String(t),this.setHeader(e,t);else for(var n in e)this.set(n,e[n]);return this},res.get=function(e){return this.getHeader(e)},res.clearCookie=function(e,t){var n={expires:new Date(1),path:"/"};return this.cookie(e,"",t?utils.merge(n,t):n)},res.cookie=function(e,t,n){n=utils.merge({},n);var r=this.req.secret,i=n.signed;if(i&&!r)throw new Error('connect.cookieParser("secret") required for signed cookies');return"number"==typeof t&&(t=t.toString()),"object"==typeof t&&(t="j:"+JSON.stringify(t)),i&&(t="s:"+sign(t,r)),"maxAge"in n&&(n.expires=new Date(Date.now()+n.maxAge),n.maxAge/=1e3),null==n.path&&(n.path="/"),this.set("Set-Cookie",cookie.serialize(e,String(t),n)),this},res.location=function(e){var t=this.app,n=this.req,r;return"back"==e&&(e=n.get("Referrer")||"/"),!~e.indexOf("://")&&0!=e.indexOf("//")&&("."==e[0]?(r=n.originalUrl.split("?")[0],r+="/"==r[r.length-1]?"":"/",e=resolve(r,e)):"/"!=e[0]&&(r=t.path(),e=r+"/"+e)),this.set("Location",e),this},res.redirect=function(e){var t="HEAD"==this.req.method,n=302,r;2==arguments.length&&("number"==typeof e?(n=e,e=arguments[1]):n=arguments[1]),this.location(e),e=this.get("Location"),this.format({text:function(){r=statusCodes[n]+". Redirecting to "+encodeURI(e)},html:function(){var t=utils.escape(e);r="<p>"+statusCodes[n]+'. Redirecting to <a href="'+t+'">'+t+"</a></p>"},"default":function(){r=""}}),this.statusCode=n,this.set("Content-Length",Buffer.byteLength(r)),this.end(t?null:r)},res.vary=function(e){var t=this;if(!e)return this;if(Array.isArray(e)){e.forEach(function(e){t.vary(e)});return}var n=this.get("Vary");return n?(n=n.split(/ *, */),~n.indexOf(e)||n.push(e),this.set("Vary",n.join(", ")),this):(this.set("Vary",e),this)},res.render=function(e,t,n){var r=this,t=t||{},i=this.req,s=i.app;"function"==typeof t&&(n=t,t={}),t._locals=r.locals,n=n||function(e,t){if(e)return i.next(e);r.send(t)},s.render(e,t,n)};