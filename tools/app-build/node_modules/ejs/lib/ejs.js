/*!
 * EJS
 * Copyright(c) 2012 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */

function filtered(e){return e.substr(1).split("|").reduce(function(e,t){var n=t.split(":"),r=n.shift(),i=n.join(":")||"";return i&&(i=", "+i),"filters."+r+"("+e+i+")"})}function rethrow(e,t,n,r){var i=t.split("\n"),s=Math.max(r-3,0),o=Math.min(i.length,r+3),u=i.slice(s,o).map(function(e,t){var n=t+s+1;return(n==r?" >> ":"    ")+n+"| "+e}).join("\n");throw e.path=n,e.message=(n||"ejs")+":"+r+"\n"+u+"\n\n"+e.message,e}function resolveInclude(e,t){var n=join(dirname(t),e),r=extname(e);return r||(n+=".ejs"),n}var utils=require("./utils"),path=require("path"),dirname=path.dirname,extname=path.extname,join=path.join,fs=require("fs"),read=fs.readFileSync,filters=exports.filters=require("./filters"),cache={};exports.clearCache=function(){cache={}};var parse=exports.parse=function(e,t){var t=t||{},n=t.open||exports.open||"<%",r=t.close||exports.close||"%>",i=t.filename,s=t.compileDebug!==!1,o="";o+="var buf = [];",!1!==t._with&&(o+="\nwith (locals || {}) { (function(){ "),o+="\n buf.push('";var u=1,a=!1;for(var f=0,l=e.length;f<l;++f){var c=e[f];if(e.slice(f,n.length+f)==n){f+=n.length;var h,p,d=(s?"__stack.lineno=":"")+u;switch(e[f]){case"=":h="', escape(("+d+", ",p=")), '",++f;break;case"-":h="', ("+d+", ",p="), '",++f;break;default:h="');"+d+";",p="; buf.push('"}var v=e.indexOf(r,f),m=e.substring(f,v),g=f,y=null,b=0;"-"==m[m.length-1]&&(m=m.substring(0,m.length-2),a=!0);if(0==m.trim().indexOf("include")){var w=m.trim().slice(7).trim();if(!i)throw new Error("filename option is required for includes");var E=resolveInclude(w,i);y=read(E,"utf8"),y=exports.parse(y,{filename:E,_with:!1,open:n,close:r,compileDebug:s}),o+="' + (function(){"+y+"})() + '",m=""}while(~(b=m.indexOf("\n",b)))b++,u++;m.substr(0,1)==":"&&(m=filtered(m)),m&&(m.lastIndexOf("//")>m.lastIndexOf("\n")&&(m+="\n"),o+=h,o+=m,o+=p),f+=v-g+r.length-1}else c=="\\"?o+="\\\\":c=="'"?o+="\\'":c!="\r"&&(c=="\n"?a?a=!1:(o+="\\n",u++):o+=c)}return!1!==t._with?o+="'); })();\n} \nreturn buf.join('');":o+="');\nreturn buf.join('');",o},compile=exports.compile=function(e,t){t=t||{};var n=t.escape||utils.escape,r=JSON.stringify(e),i=t.compileDebug!==!1,s=t.client,o=t.filename?JSON.stringify(t.filename):"undefined";i?e=["var __stack = { lineno: 1, input: "+r+", filename: "+o+" };",rethrow.toString(),"try {",exports.parse(e,t),"} catch (err) {","  rethrow(err, __stack.input, __stack.filename, __stack.lineno);","}"].join("\n"):e=exports.parse(e,t),t.debug&&console.log(e),s&&(e="escape = escape || "+n.toString()+";\n"+e);try{var u=new Function("locals, filters, escape, rethrow",e)}catch(a){throw"SyntaxError"==a.name&&(a.message+=t.filename?" in "+o:" while compiling ejs"),a}return s?u:function(e){return u.call(this,e,filters,n,rethrow)}};exports.render=function(e,t){var n,t=t||{};if(t.cache){if(!t.filename)throw new Error('"cache" option requires "filename".');n=cache[t.filename]||(cache[t.filename]=compile(e,t))}else n=compile(e,t);return t.__proto__=t.locals,n.call(t.scope,t)},exports.renderFile=function(e,t,n){var r=e+":string";"function"==typeof t&&(n=t,t={}),t.filename=e;var i;try{i=t.cache?cache[r]||(cache[r]=read(e,"utf8")):read(e,"utf8")}catch(s){n(s);return}n(null,exports.render(i,t))},exports.__express=exports.renderFile,require.extensions?require.extensions[".ejs"]=function(e,t){t=t||e.filename;var n={filename:t,client:!0},r=fs.readFileSync(t).toString(),i=compile(r,n);e._compile("module.exports = "+i.toString()+";",t)}:require.registerExtension&&require.registerExtension(".ejs",function(e){return compile(e,{})});