function fixture(e){return read("test/fixtures/"+e,"utf8").replace(/\r/g,"")}var ejs=require(".."),fs=require("fs"),read=fs.readFileSync,assert=require("should"),users=[];users.push({name:"tobi"}),users.push({name:"loki"}),users.push({name:"jane"}),describe("ejs.compile(str, options)",function(){it("should compile to a function",function(){var e=ejs.compile("<p>yay</p>");e().should.equal("<p>yay</p>")}),it("should throw if there are syntax errors",function(){try{ejs.compile(fixture("fail.ejs"))}catch(e){e.message.should.include("compiling ejs");try{ejs.compile(fixture("fail.ejs"),{filename:"fail.ejs"})}catch(e){e.message.should.include("fail.ejs");return}}assert(!1,"compiling a file with invalid syntax should throw an exception")}),it("should allow customizing delimiters",function(){var e=ejs.compile("<p>{= name }</p>",{open:"{",close:"}"});e({name:"tobi"}).should.equal("<p>tobi</p>");var e=ejs.compile("<p>::= name ::</p>",{open:"::",close:"::"});e({name:"tobi"}).should.equal("<p>tobi</p>");var e=ejs.compile("<p>(= name )</p>",{open:"(",close:")"});e({name:"tobi"}).should.equal("<p>tobi</p>")}),it("should default to using ejs.open and ejs.close",function(){ejs.open="{",ejs.close="}";var e=ejs.compile("<p>{= name }</p>");e({name:"tobi"}).should.equal("<p>tobi</p>");var e=ejs.compile("<p>|= name |</p>",{open:"|",close:"|"});e({name:"tobi"}).should.equal("<p>tobi</p>"),delete ejs.open,delete ejs.close}),it("should have a working client option",function(){var fn=ejs.compile("<p><%= foo %></p>",{client:!0}),str=fn.toString();eval("var preFn = "+str),preFn({foo:"bar"}).should.equal("<p>bar</p>")})}),describe("ejs.render(str, options)",function(){it("should render the template",function(){ejs.render("<p>yay</p>").should.equal("<p>yay</p>")}),it("should accept locals",function(){ejs.render("<p><%= name %></p>",{name:"tobi"}).should.equal("<p>tobi</p>")})}),describe("ejs.renderFile(path, options, fn)",function(){it("should render a file",function(e){ejs.renderFile("test/fixtures/para.ejs",function(t,n){if(t)return e(t);n.should.equal("<p>hey</p>"),e()})}),it("should accept locals",function(e){var t={name:"tj",open:"{",close:"}"};ejs.renderFile("test/fixtures/user.ejs",t,function(t,n){if(t)return e(t);n.should.equal("<h1>tj</h1>"),e()})}),it("should not catch err threw by callback",function(e){var t={name:"tj",open:"{",close:"}"},n=0;try{ejs.renderFile("test/fixtures/user.ejs",t,function(t,r){n++;if(t)return t.message.should.not.equal("Exception in callback"),e(t);throw new Error("Exception in callback")})}catch(r){n.should.equal(1),r.message.should.equal("Exception in callback"),e()}})}),describe("<%=",function(){it("should escape <script>",function(){ejs.render("<%= name %>",{name:"<script>"}).should.equal("&lt;script&gt;")}),it("should escape '",function(){ejs.render("<%= name %>",{name:"The Jones's"}).should.equal("The Jones&#39;s")}),it("shouldn't escape &amp;",function(){ejs.render("<%= name %>",{name:"Us &amp; Them"}).should.equal("Us &amp; Them")}),it("shouldn't escape &#93;",function(){ejs.render("<%= name %>",{name:"The Jones&#39;s"}).should.equal("The Jones&#39;s")}),it("should escape &foo_bar;",function(){ejs.render("<%= name %>",{name:"&foo_bar;"}).should.equal("&amp;foo_bar;")})}),describe("<%-",function(){it("should not escape",function(){ejs.render("<%- name %>",{name:"<script>"}).should.equal("<script>")})}),describe("%>",function(){it("should produce newlines",function(){ejs.render(fixture("newlines.ejs"),{users:users}).should.equal(fixture("newlines.html"))})}),describe("-%>",function(){it("should not produce newlines",function(){ejs.render(fixture("no.newlines.ejs"),{users:users}).should.equal(fixture("no.newlines.html"))})}),describe("single quotes",function(){it("should not mess up the constructed function",function(){ejs.render(fixture("single-quote.ejs")).should.equal(fixture("single-quote.html"))})}),describe("double quotes",function(){it("should not mess up the constructed function",function(){ejs.render(fixture("double-quote.ejs")).should.equal(fixture("double-quote.html"))})}),describe("backslashes",function(){it("should escape",function(){ejs.render(fixture("backslash.ejs")).should.equal(fixture("backslash.html"))})}),describe("messed up whitespace",function(){it("should work",function(){ejs.render(fixture("messed.ejs"),{users:users}).should.equal(fixture("messed.html"))})}),describe("filters",function(){it("should work",function(){var e=["foo","bar","baz"];ejs.render("<%=: items | reverse | first | reverse | capitalize %>",{items:e}).should.equal("Zab")}),it("should accept arguments",function(){ejs.render('<%=: users | map:"name" | join:", " %>',{users:users}).should.equal("tobi, loki, jane")}),it("should truncate string",function(){ejs.render("<%=: word | truncate: 3 %>",{word:"World"}).should.equal("Wor")}),it("should append string if string is longer",function(){ejs.render('<%=: word | truncate: 2,"..." %>',{word:"Testing"}).should.equal("Te...")}),it("should not append string if string is shorter",function(){ejs.render('<%=: word | truncate: 10,"..." %>',{word:"Testing"}).should.equal("Testing")}),it("should accept arguments containing :",function(){ejs.render('<%=: users | map:"name" | join:"::" %>',{users:users}).should.equal("tobi::loki::jane")})}),describe("exceptions",function(){it("should produce useful stack traces",function(e){try{ejs.render(fixture("error.ejs"),{filename:"error.ejs"})}catch(t){t.path.should.equal("error.ejs"),t.stack.split("\n").slice(0,8).join("\n").should.equal(fixture("error.out")),e()}}),it("should not include __stack if compileDebug is false",function(){try{ejs.render(fixture("error.ejs"),{filename:"error.ejs",compileDebug:!1})}catch(e){e.should.not.have.property("path"),e.stack.split("\n").slice(0,8).join("\n").should.not.equal(fixture("error.out"))}})}),describe("includes",function(){it("should include ejs",function(){var e="test/fixtures/include.ejs";ejs.render(fixture("include.ejs"),{filename:e,pets:users,open:"[[",close:"]]"}).should.equal(fixture("include.html"))}),it("should work when nested",function(){var e="test/fixtures/menu.ejs";ejs.render(fixture("menu.ejs"),{filename:e,pets:users}).should.equal(fixture("menu.html"))}),it("should include arbitrary files as-is",function(){var e="test/fixtures/include.css.ejs";ejs.render(fixture("include.css.ejs"),{filename:e,pets:users}).should.equal(fixture("include.css.html"))}),it("should pass compileDebug to include",function(){var file="test/fixtures/include.ejs",fn=ejs.compile(fixture("include.ejs"),{filename:file,open:"[[",close:"]]",compileDebug:!1,client:!0}),str=fn.toString();eval("var preFn = "+str),str.should.not.match(/__stack/),function(){preFn({pets:users})}.should.not.throw()})}),describe("comments",function(){it("should fully render with comments removed",function(){ejs.render(fixture("comments.ejs")).should.equal(fixture("comments.html"))})}),describe("require",function(){it("should allow ejs templates to be required as node modules",function(){var e="test/fixtures/include.ejs",t=require(__dirname+"/fixtures/menu.ejs");t({filename:e,pets:users}).should.equal(fixture("menu.html"))})});