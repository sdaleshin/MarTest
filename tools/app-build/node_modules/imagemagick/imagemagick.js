function exec2(e,t){var n={encoding:"utf8",timeout:0,maxBuffer:512e3,killSignal:"SIGKILL",output:null},r=arguments[arguments.length-1];"function"!=typeof r&&(r=null);if(typeof arguments[2]=="object"){var i=Object.keys(n);for(var s=0;s<i.length;s++){var o=i[s];arguments[2][o]!==undefined&&(n[o]=arguments[2][o])}}var u=childproc.spawn(e,t),a=!1,f=!1,l=function(e){this.proc=e,this.stderr=new c,e.emitter=new EventEmitter,e.on=e.emitter.on.bind(e.emitter),this.out=e.emitter.emit.bind(e.emitter,"data"),this.err=this.stderr.out.bind(this.stderr),this.errCurrent=this.stderr.current.bind(this.stderr)};l.prototype.finish=function(e){this.proc.emitter.emit("end",e,this.errCurrent())};var c=function(e){this.stdout={contents:""},this.stderr={contents:""},this.callback=e;var t=function(e){return function(t){e.contents+=t,!a&&e.contents.length>n.maxBuffer&&(u.kill(n.killSignal),a=!0)}};this.out=t(this.stdout),this.err=t(this.stderr)};c.prototype.current=function(){return this.stdout.contents},c.prototype.errCurrent=function(){return this.stderr.contents},c.prototype.finish=function(e){this.callback(e,this.stdout.contents,this.stderr.contents)};var h=r?new c(r):new l(u),p;n.timeout>0&&(p=setTimeout(function(){a||(u.kill(n.killSignal),f=!0,a=!0,p=null)},n.timeout)),u.stdout.setEncoding(n.encoding),u.stderr.setEncoding(n.encoding),u.stdout.addListener("data",function(e){h.out(e,n.encoding)}),u.stderr.addListener("data",function(e){h.err(e,n.encoding)});var d=process.versions.node.split(".");return u.addListener(d[0]==0&&d[1]<7?"exit":"close",function(e,t){p&&clearTimeout(p);if(e===0&&t===null)h.finish(null);else{var n=new Error("Command "+(f?"timed out":"failed")+": "+h.errCurrent());n.timedOut=f,n.killed=a,n.code=e,n.signal=t,h.finish(n)}}),u}function parseIdentify(e){var t=e.split("\n"),n={},r=[n],i=0,s=[a],o,u,a,f;t.shift();for(f in t){o=t[f],a=o.search(/\S/);if(a>=0){u=o.split(": "),a>i&&s.push(a);while(a<i&&r.length)s.pop(),n=r.pop(),i=s[s.length-1];u.length<2?(r.push(n),n=n[o.split(":")[0].trim().toLowerCase()]={}):n[u[0].trim().toLowerCase()]=u[1].trim(),i=a}}return n}function ExifDate(e){return e=e.split(/ /),new Date(e[0].replace(/:/g,"-")+" "+e[1]+" +0000")}function exifKeyName(e){return e.replace(exifKeyName.RE,function(e){return e.length===1?e.toLowerCase():e.substr(0,e.length-1).toLowerCase()+e.substr(e.length-1)})}var childproc=require("child_process"),EventEmitter=require("events").EventEmitter;exports.identify=function(e,t){var n=Array.isArray(e),r,i=n?[].concat(e):["-verbose",e];if(typeof i[i.length-1]=="object"){r=!0,e=i[i.length-1],i[i.length-1]="-";if(!e.data)throw new Error('first argument is missing the "data" member')}else typeof e=="function"&&(i[i.length-1]="-",t=e);var s=exec2(exports.identify.path,i,{timeout:12e4},function(e,r,i){var s,o;e||(n?s=r:(s=parseIdentify(r),o=s.geometry.split(/x/),s.format=s.format.match(/\S*/)[0],s.width=parseInt(o[0]),s.height=parseInt(o[1]),s.depth=parseInt(s.depth),s.quality!==undefined&&(s.quality=parseInt(s.quality)/100))),t(e,s)});return r&&("string"==typeof e.data?(s.stdin.setEncoding("binary"),s.stdin.write(e.data,"binary"),s.stdin.end()):s.stdin.end(e.data)),s},exports.identify.path="identify",exifKeyName.RE=/^[A-Z]+/;var exifFieldConverters={bitsPerSample:Number,compression:Number,exifImageLength:Number,exifImageWidth:Number,exifOffset:Number,exposureProgram:Number,flash:Number,imageLength:Number,imageWidth:Number,isoSpeedRatings:Number,jpegInterchangeFormat:Number,jpegInterchangeFormatLength:Number,lightSource:Number,meteringMode:Number,orientation:Number,photometricInterpretation:Number,planarConfiguration:Number,resolutionUnit:Number,rowsPerStrip:Number,samplesPerPixel:Number,sensingMethod:Number,stripByteCounts:Number,subSecTime:Number,subSecTimeDigitized:Number,subSecTimeOriginal:Number,customRendered:Number,exposureMode:Number,focalLengthIn35mmFilm:Number,gainControl:Number,saturation:Number,sharpness:Number,subjectDistanceRange:Number,subSecTime:Number,subSecTimeDigitized:Number,subSecTimeOriginal:Number,whiteBalance:Number,sceneCaptureType:Number,dateTime:ExifDate,dateTimeDigitized:ExifDate,dateTimeOriginal:ExifDate};exports.readMetadata=function(e,t){return exports.identify(["-format","%[EXIF:*]",e],function(e,n){var r={};e||n.split(/\n/).forEach(function(e){var t=e.indexOf("=");if(t===-1)return;var n=e.substr(0,t).replace("/","-"),i=e.substr(t+1).trim(),s="default",o=n.indexOf(":");if(o!==-1){s=n.substr(0,o),n=n.substr(o+1);if(s==="exif"){n=exifKeyName(n);var u=exifFieldConverters[n];u&&(i=u(i))}}s in r?r[s][n]=i:r[s]={key:i}}),t(e,r)})},exports.convert=function(e,t,n){var r={encoding:"binary"};return typeof t=="function"?(n=t,t=0):typeof t!="number"&&(t=0),t&&(t=parseInt(t))>0&&!isNaN(t)&&(r.timeout=t),exec2(exports.convert.path,e,r,n)},exports.convert.path="convert";var resizeCall=function(e,t){var n=exports.convert(e.args,e.opt.timeout,t);return e.opt.srcPath.match(/-$/)&&("string"==typeof e.opt.srcData?(n.stdin.setEncoding("binary"),n.stdin.write(e.opt.srcData,"binary"),n.stdin.end()):n.stdin.end(e.opt.srcData)),n};exports.resize=function(e,t){var n=exports.resizeArgs(e);return resizeCall(n,t)},exports.crop=function(e,t){if(typeof e!="object")throw new TypeError("First argument must be an object");if(!e.srcPath&&!e.srcData)throw new TypeError("No srcPath or data defined");if(!e.height&&!e.width)throw new TypeError("No width or height defined");if(e.srcPath)var n=e.srcPath;else var n={data:e.srcData};exports.identify(n,function(n,r){if(n)return t&&t(n);var i=exports.resizeArgs(e),s=!1,o=!1,u=[];i.args.forEach(function(t){o===!0&&(console.log("arg",t),o=!1),!s&&t!="-resize"&&u.push(t),t=="-resize"&&(console.log("resize arg"),s=!0,o=!0),t==="-crop"&&(console.log("crop arg"),o=!0);if(t!="-resize"&&s){var n=r.width/r.height,a=i.opt.width/i.opt.height,f=n<a?""+i.opt.width+"x":"x"+i.opt.height,l=e.gravity?e.gravity:"Center";u=u.concat(["-resize",f,"-gravity",l,"-crop",""+i.opt.width+"x"+i.opt.height+"+0+0","+repage"]),s=!1}}),i.args=u,resizeCall(i,t)})},exports.resizeArgs=function(e){var t={srcPath:null,srcData:null,srcFormat:null,dstPath:null,quality:.8,format:"jpg",progressive:!1,colorspace:null,width:0,height:0,strip:!0,filter:"Lagrange",sharpening:.2,customArgs:[],timeout:0};if(typeof e!="object")throw new Error("first argument must be an object");for(var n in t)n in e&&(t[n]=e[n]);if(!t.srcPath&&!t.srcData)throw new Error("both srcPath and srcData are empty");t.format||(t.format="jpg"),t.srcPath||(t.srcPath=t.srcFormat?t.srcFormat+":-":"-"),t.dstPath||(t.dstPath=t.format?t.format+":-":"-");if(t.width===0&&t.height===0)throw new Error("both width and height can not be 0 (zero)");var r=[t.srcPath];t.sharpening>0&&(r=r.concat(["-set","option:filter:blur",String(1-t.sharpening)])),t.filter&&(r.push("-filter"),r.push(t.filter)),t.strip&&r.push("-strip");if(t.width||t.height)r.push("-resize"),t.height===0?r.push(String(t.width)):t.width===0?r.push("x"+String(t.height)):r.push(String(t.width)+"x"+String(t.height));t.format=t.format.toLowerCase();var i=t.format==="jpg"||t.format==="jpeg";i&&t.progressive&&(r.push("-interlace"),r.push("plane"));if(i||t.format==="png")r.push("-quality"),r.push(Math.round(t.quality*100).toString());else if(t.format==="miff"||t.format==="mif")r.push("-quality"),r.push(Math.round(t.quality*9).toString());return t.colorspace&&(r.push("-colorspace"),r.push(t.colorspace)),Array.isArray(t.customArgs)&&t.customArgs.length&&(r=r.concat(t.customArgs)),r.push(t.dstPath),{opt:t,args:r}};