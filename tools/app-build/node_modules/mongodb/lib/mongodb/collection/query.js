var ObjectID=require("bson").ObjectID,Scope=require("../scope").Scope,shared=require("./shared"),utils=require("../utils"),testForFields={limit:1,sort:1,fields:1,skip:1,hint:1,explain:1,snapshot:1,timeout:1,tailable:1,tailableRetryInterval:1,numberOfRetries:1,awaitdata:1,exhaust:1,batchSize:1,returnKey:1,maxScan:1,min:1,max:1,showDiskLoc:1,comment:1,raw:1,readPreference:1,partial:1,read:1,dbName:1,oplogReplay:1},find=function(){var t,n=Array.prototype.slice.call(arguments,0),r=typeof n[n.length-1]=="function",i=typeof n[0]=="function",s=r?n.pop():i?n.shift():null,o=n.length,u=o>=1?n[0]:{},a=o>=2?n[1]:undefined;o===1&&i&&(u={},t=n[0]);if(o===2&&!Array.isArray(a)){var f=Object.getOwnPropertyNames(a),l=!1;for(var c=0;c<f.length;c++)if(testForFields[f[c]]!=null){l=!0;break}l?(t=a,a=undefined):t={}}else if(o===2&&Array.isArray(a)&&!Array.isArray(a[0])){var h={};for(var c=0;c<a.length;c++)h[a[c]]=1;a=h}3===o&&(t=n[2]),u=u==null?{}:u;var p=u;if(Buffer.isBuffer(p)){var d=p[0]|p[1]<<8|p[2]<<16|p[3]<<24;if(d!=p.length){var v=new Error("query selector raw message size does not match message header size ["+p.length+"] != ["+d+"]");throw v.name="MongoError",v}}var p=a;if(Buffer.isBuffer(p)){var d=p[0]|p[1]<<8|p[2]<<16|p[3]<<24;if(d!=p.length){var v=new Error("query fields raw message size does not match message header size ["+p.length+"] != ["+d+"]");throw v.name="MongoError",v}}if(u instanceof ObjectID||u!=null&&u._bsontype=="ObjectID")u={_id:u};if(t&&t.fields&&!Buffer.isBuffer(t.fields)){a={};if(Array.isArray(t.fields))if(!t.fields.length)a._id=1;else for(var c=0,m=t.fields.length;c<m;c++)a[t.fields[c]]=1;else a=t.fields}t||(t={}),t.skip=o>3?n[2]:t.skip?t.skip:0,t.limit=o>3?n[3]:t.limit?t.limit:0,t.raw=t.raw!=null&&typeof t.raw=="boolean"?t.raw:this.raw,t.hint=t.hint!=null?shared.normalizeHintField(t.hint):this.internalHint,t.timeout=o==5?n[4]:typeof t.timeout=="undefined"?undefined:t.timeout,t.slaveOk=t.slaveOk!=null?t.slaveOk:this.db.slaveOk;var g=t;g["read"]!=null&&(g.readPreference=g.read),g.read=g.readPreference?g.readPreference:this.readPreference;if(g.read=="secondary"||g.read=="secondaryOnly")t.slaveOk=!0;g.selector=u;var y=new Scope(this,{},a,g);return s?s(null,y.find(u)):y.find(u)},findOne=function(){var t=this,n=Array.prototype.slice.call(arguments,0),r=n.pop(),i=this.find.apply(this,n).limit(-1).batchSize(1);i.nextObject(function(e,t){if(e!=null)return r(utils.toError(e),null);r(null,t)})};exports.find=find,exports.findOne=findOne;