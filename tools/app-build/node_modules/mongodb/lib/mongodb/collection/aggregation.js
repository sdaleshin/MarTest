function processScope(e){if(!utils.isObject(e))return e;var t=Object.keys(e),n=t.length,r;while(n--)r=t[n],"function"==typeof e[r]?e[r]=new Code(String(e[r])):e[r]=processScope(e[r]);return e}var shared=require("./shared"),utils=require("../utils"),AggregationCursor=require("../aggregation_cursor").AggregationCursor,Code=require("bson").Code,DbCommand=require("../commands/db_command").DbCommand,pipe=function(){return new AggregationCursor(this,this.serverCapabilities)},mapReduce=function(t,n,r,i){"function"==typeof r&&(i=r,r={});if(null==r.out)throw new Error("the out option parameter must be defined, see mongodb docs for possible values");"function"==typeof t&&(t=t.toString()),"function"==typeof n&&(n=n.toString()),"function"==typeof r.finalize&&(r.finalize=r.finalize.toString());var s={mapreduce:this.collectionName,map:t,reduce:n};for(var o in r)"scope"==o?s[o]=processScope(r[o]):s[o]=r[o];var u=shared._getReadConcern(this,r);u!=0&&u!="primary"&&r.out&&r["out"].inline!=1&&r["out"]!="inline"&&(u="primary");var a=this,f=DbCommand.createDbCommand(this.db,s);this.db._executeQueryCommand(f,{read:u},function(e,t){if(e)return i(e);if(!t||!t.documents||t.documents.length==0)return i(Error("command failed to return results"),null);if(1!=t.documents[0].ok||t.documents[0].err||t.documents[0].errmsg)return i(utils.toError(t.documents[0]));var n={};t.documents[0].timeMillis&&(n.processtime=t.documents[0].timeMillis),t.documents[0].counts&&(n.counts=t.documents[0].counts),t.documents[0].timing&&(n.timing=t.documents[0].timing);if(t.documents[0].results)return r["verbose"]==null||!r.verbose?i(null,t.documents[0].results):i(null,t.documents[0].results,n);var s=null;if(t.documents[0].result!=null&&typeof t.documents[0].result=="object"){var o=t.documents[0].result;s=a.db.db(o.db).collection(o.collection)}else s=a.db.collection(t.documents[0].result);if(r["verbose"]==null||!r.verbose)return i(e,s);i(e,s,n)})},groupFunction=function(){var e=db[ns].find(condition),t=new Map,n=reduce;while(e.hasNext()){var r=e.next(),i={};for(var s=0,o=keys.length;s<o;++s){var u=keys[s];i[u]=r[u]}var a=t.get(i);if(a==null){var f=Object.extend({},i);a=Object.extend(f,initial),t.put(i,a)}n(r,a)}return{result:t.values()}}.toString(),group=function(t,n,r,i,s,o,u,a){var f=Array.prototype.slice.call(arguments,3);a=f.pop(),i=f.length?f.shift():null,s=f.length?f.shift():null,o=f.length?f.shift():null,u=f.length?f.shift()||{}:{},typeof s!="function"&&(o=s,s=null),!Array.isArray(t)&&t instanceof Object&&typeof t!="function"&&!(t instanceof Code)&&(t=Object.keys(t)),typeof i=="function"&&(i=i.toString()),typeof s=="function"&&(s=s.toString()),o=o==null?!0:o;if(o){var l=i instanceof Code?i:new Code(i),c={group:{ns:this.collectionName,$reduce:l,cond:n,initial:r,out:"inline"}};s!=null&&(c.group.finalize=s);if("function"==typeof t||t instanceof Code)c.group.$keyf=t instanceof Code?t:new Code(t);else{var h={};t.forEach(function(e){h[e]=1}),c.group.key=h}var p=DbCommand.createDbSlaveOkCommand(this.db,c),d=shared._getReadConcern(this,u);this.db._executeQueryCommand(p,{read:d},utils.handleSingleCommandResultReturn(null,null,function(e,t){if(e)return a(e,null);a(null,t.retval)}))}else{var v=i!=null&&i instanceof Code?i.scope:{};v.ns=this.collectionName,v.keys=t,v.condition=n,v.initial=r;var m=groupFunction.replace(/ reduce;/,i.toString()+";");this.db.eval(new Code(m,v),function(e,t){if(e)return a(e,null);a(null,t.result||t)})}},aggregate=function(e,t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop();var i=this,s=r[r.length-1];t=s.readPreference||s.explain||s.cursor||s.out||s.allowDiskUsage?r.pop():{},typeof n=="object"&&n!=null&&(t=n);if(!Array.isArray(r[0])){e=[];for(var o=0;o<r.length;o++)e.push(r[o])}if(t.cursor!=null&&t.out==null){var u=t.cursor;return u.pipe=e,u.allowDiskUsage=t.allowDiskUsage==null?!1:t.allowDiskUsage,new AggregationCursor(this,this.serverCapabilities,u)}typeof t.out=="string"&&e.push({$out:t.out});var a={aggregate:this.collectionName,pipeline:e};t.allowDiskUsage&&(a.allowDiskUsage=t.allowDiskUsage),t.readPreference=shared._getReadConcern(this,t),t.explain&&(a.explain=t.explain),this.db.command(a,t,function(e,t){e?n(e):t.err||t.errmsg?n(utils.toError(t)):typeof t=="object"&&t.serverPipeline?n(null,t.serverPipeline):typeof t=="object"&&t.stages?n(null,t.stages):n(null,t.result)})};exports.mapReduce=mapReduce,exports.group=group,exports.aggregate=aggregate,exports.pipe=pipe;