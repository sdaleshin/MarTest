var InsertCommand=require("../commands/insert_command").InsertCommand,DeleteCommand=require("../commands/delete_command").DeleteCommand,UpdateCommand=require("../commands/update_command").UpdateCommand,DbCommand=require("../commands/db_command").DbCommand,utils=require("../utils"),hasWriteCommands=require("../utils").hasWriteCommands,shared=require("./shared"),eErrorMessages=/No matching object found/,insert=function(t,n,r){"function"==typeof n&&(r=n,n={}),n==null&&(n={}),"function"!=typeof r&&(r=null);var i=this.db.serverConfig.checkoutWriter(),s=n.useLegacyOps==null||n.useLegacyOps==0?!1:!0;return!s&&hasWriteCommands(i)&&!Buffer.isBuffer(t)&&!Array.isArray(t)&&t.length>0&&!Buffer.isBuffer(t[0])?(insertWithWriteCommands(this,Array.isArray(t)?t:[t],n,r),this):(insertAll(this,Array.isArray(t)?t:[t],n,r),this)},insertWithWriteCommands=function(e,t,n,r){var i=e.collectionName;if(!!~i.indexOf("\0"))return r(new Error("namespace cannot contain a null character"),null);var s=typeof n["keepGoing"]=="boolean"?n.keepGoing:!1;s=typeof n["continueOnError"]=="boolean"?n.continueOnError:s;var o=typeof n.serializeFunctions!="boolean"?e.serializeFunctions:n.serializeFunctions,u=e.db.serverConfig.checkoutWriter(),a=shared._getWriteConcern(e,n);if(a.w&&a.w!=0&&r==null)throw new Error("writeConcern requires callback");for(var f=0,l=t.length;f<l;++f){var c=t[f];!Buffer.isBuffer(c)&&c["_id"]==null&&e.db.forceServerObjectId!=1&&n.forceServerObjectId!=1&&(c._id=e.pkFactory.createPk())}var h={insert:i,writeConcern:a,ordered:!s,documents:t};e.db.command(h,{connection:u,checkKeys:!0,serializeFunctions:o,writeCommand:!0},function(e,n){if(a.w==0&&typeof r=="function")return r(null,null);if(a.w==0)return;if(r==null)return;if(e!=null)return Array.isArray(e.errDetails)&&(e.code=e.errDetails[0].errCode),r(e,null);if(!n.ok&&(n.err!=null||n.errmsg!=null)){var i=utils.toError(n);return Array.isArray(i.errDetails)&&(i.code=i.errDetails[0].errCode),r(i,null)}r(null,t)})},insertAll=function(t,n,r,i){"function"==typeof r&&(i=r,r={}),r==null&&(r={}),"function"!=typeof i&&(i=null);var s={};r["keepGoing"]!=null&&(s.keepGoing=r.keepGoing),r["continueOnError"]!=null&&(s.continueOnError=r.continueOnError);var o=r.dbName;o==null&&(o=t.db.databaseName),r["serializeFunctions"]!=null?s.serializeFunctions=r.serializeFunctions:s.serializeFunctions=t.serializeFunctions;var u=typeof r.checkKeys!="boolean"?!0:r.checkKeys,a=new InsertCommand(t.db,o+"."+t.collectionName,u,s);for(var f=0,l=n.length;f<l;++f){var c=n[f];!Buffer.isBuffer(c)&&c["_id"]==null&&t.db.forceServerObjectId!=1&&r.forceServerObjectId!=1&&(c._id=t.pkFactory.createPk()),a.add(c)}var h=shared._getWriteConcern(t,r),p={};if(!shared._hasWriteConcern(h)||typeof i!="function"){if(shared._hasWriteConcern(h)&&i==null)throw new Error("Cannot use a writeConcern without a provided callback");var m=t.db._executeInsertCommand(a,p);if(!i)return;return m instanceof Error?i(m):i(null,n)}p.read=!1,h==null&&(p.async=!0),p.safe=h;if(typeof h=="object"){var d=Object.keys(h);for(var v=0;v<d.length;v++)p[d[v]]=h[d[v]]}t.db._executeInsertCommand(a,p,function(e,t){t=t&&t.documents;if(!i)return;e?i(e):t[0].err||t[0].errmsg?i(utils.toError(t[0])):t[0].jnote||t[0].wnote||t[0].wtimeout?i(utils.toError(t[0])):i(null,n)})},removeWithWriteCommands=function(e,t,n,r){"function"==typeof t?(r=t,t=n={}):"function"==typeof n&&(r=n,n={});var i=e.collectionName;if(!!~i.indexOf("\0"))return r(new Error("namespace cannot contain a null character"),null);t=t==null?{}:t;var s=typeof n["keepGoing"]=="boolean"?n.keepGoing:!1;s=typeof n["continueOnError"]=="boolean"?n.continueOnError:s;var o=typeof n.serializeFunctions!="boolean"?e.serializeFunctions:n.serializeFunctions,u=e.db.serverConfig.checkoutWriter(),a=n.single==1?1:0,f=typeof n.upsert=="boolean"?n.upsert:!1,l=shared._getWriteConcern(e,n);if(l.w&&l.w!=0&&r==null)throw new Error("writeConcern requires callback");var c={"delete":i,writeConcern:l,ordered:!s,deletes:[{q:t,limit:a}]};e.db.command(c,{connection:u,checkKeys:!0,serializeFunctions:o,writeCommand:!0},function(e,t){if(l.w==0&&typeof r=="function")return r(null,null);if(l.w==0)return;if(r==null)return;if(e!=null)return Array.isArray(e.errDetails)&&(e.code=e.errDetails[0].errCode),r(e,null);if(!t.ok&&(t.err!=null||t.errmsg!=null)){var n=utils.toError(t);return Array.isArray(n.errDetails)&&(n.code=n.errDetails[0].errCode),r(n,null)}var i=backWardsCompatibiltyResults(t,"remove");r(null,i.n,i)})},remove=function(t,n,r){"function"==typeof n&&(r=n,n=null),n==null&&(n={}),"function"!=typeof r&&(r=null);var i=this.db.serverConfig.checkoutWriter(),s=n.useLegacyOps==null||n.useLegacyOps==0?!1:!0;if(!s&&hasWriteCommands(i)&&!Buffer.isBuffer(t))return removeWithWriteCommands(this,t,n,r);"function"==typeof t?(r=t,t=n={}):"function"==typeof n&&(r=n,n={}),n==null&&(n={}),"function"!=typeof r&&(r=null),t=t==null?{}:t;var o=0|(n.single?1:0),u=n.dbName;u==null&&(u=this.db.databaseName);var a=new DeleteCommand(this.db,u+"."+this.collectionName,t,o),f=this,l=shared._getWriteConcern(f,n);if(!shared._hasWriteConcern(l)||typeof r!="function"){if(shared._hasWriteConcern(l)&&r==null)throw new Error("Cannot use a writeConcern without a provided callback");var d=this.db._executeRemoveCommand(a);if(!r)return;return d instanceof Error?r(d):r()}var c={read:!1};l==null&&(c.async=!0),c.safe=!0;if(typeof l=="object"){var h=Object.keys(l);for(var p=0;p<h.length;p++)c[h[p]]=l[h[p]]}this.db._executeRemoveCommand(a,c,function(e,t){t=t&&t.documents;if(!r)return;e?r(e):t[0].err||t[0].errmsg?r(utils.toError(t[0])):t[0].jnote||t[0].wnote||t[0].wtimeout?r(utils.toError(t[0])):r(null,t[0].n)})},save=function(t,n,r){"function"==typeof n&&(r=n,n=null),n==null&&(n={}),"function"!=typeof r&&(r=null);if(Array.isArray(t))throw new Error("doc parameter must be a single document");var i=t._id,s=shared._getWriteConcern(this,n);i!=null?(s.upsert=!0,this.update({_id:i},t,s,r)):this.insert(t,s,r&&function(e,t){if(e)return r(e,null);Array.isArray(t)?r(e,t[0]):r(e,t)})},updateWithWriteCommands=function(e,t,n,r,i){"function"==typeof r&&(i=r,r=null),r==null&&(r={}),"function"!=typeof i&&(i=null);var s=e.collectionName;if(!!~s.indexOf("\0"))return i(new Error("namespace cannot contain a null character"),null);if(t==null||typeof t!="object")return i(new Error("selector must be a valid JavaScript object"));if(n==null||typeof n!="object")return i(new Error("document must be a valid JavaScript object"));var o=typeof r["keepGoing"]=="boolean"?r.keepGoing:!1;o=typeof r["continueOnError"]=="boolean"?r.continueOnError:o;var u=typeof r.serializeFunctions!="boolean"?e.serializeFunctions:r.serializeFunctions,a=e.db.serverConfig.checkoutWriter(),f=typeof r.multi=="boolean"?r.multi:!1,l=typeof r.upsert=="boolean"?r.upsert:!1,c=shared._getWriteConcern(e,r);if(c.w&&c.w!=0&&i==null)throw new Error("writeConcern requires callback");var h={update:s,writeConcern:c,ordered:!o,updates:[{q:t,u:n,multi:f,upsert:l}]},p=typeof r.checkKeys=="boolean"?r.checkKeys:!1;e.db.command(h,{connection:a,checkKeys:p,serializeFunctions:u,writeCommand:!0},function(e,t){if(c.w==0&&typeof i=="function")return i(null,null);if(c.w==0)return;if(i==null)return;if(e!=null)return Array.isArray(e.errDetails)&&(e.code=e.errDetails[0].errCode),i(e,null);if(!t.ok&&(t.err!=null||t.errmsg!=null)){var n=utils.toError(t);return Array.isArray(n.errDetails)&&(n.code=n.errDetails[0].errCode),i(n,null)}var r=backWardsCompatibiltyResults(t,"update");i(null,r.n,r)})},backWardsCompatibiltyResults=function(e,t){var n=null,r=null,i=!0;if(Array.isArray(e.upserted)||e.upserted!=null)i=!1,n=e.upserted;return t=="remove"||t=="insert"?r={ok:!0,n:e.n}:r={ok:!0,n:e.n,updatedExisting:i},n!=null&&(r.upserted=n),r},update=function(t,n,r,i){"function"==typeof r&&(i=r,r=null),r==null&&(r={}),"function"!=typeof i&&(i=null);var s=this.db.serverConfig.checkoutWriter(),o=r.useLegacyOps==null||r.useLegacyOps==0?!1:!0;if(!o&&hasWriteCommands(s)&&!Buffer.isBuffer(t)&&!Buffer.isBuffer(n))return updateWithWriteCommands(this,t,n,r,i);var u=r.dbName;u==null&&(u=this.db.databaseName);if(t==null||typeof t!="object")return i(new Error("selector must be a valid JavaScript object"));if(n==null||typeof n!="object")return i(new Error("document must be a valid JavaScript object"));r["serializeFunctions"]!=null?r.serializeFunctions=r.serializeFunctions:r.serializeFunctions=this.serializeFunctions;var a=new UpdateCommand(this.db,u+"."+this.collectionName,t,n,r),f=this,l=shared._getWriteConcern(this,r);if(!shared._hasWriteConcern(l)||typeof i!="function"){if(shared._hasWriteConcern(l)&&i==null)throw new Error("Cannot use a writeConcern without a provided callback");var d=this.db._executeUpdateCommand(a);if(!i)return;return d instanceof Error?i(d):i()}var c={read:!1};l==null&&(c.async=!0),c.safe=l;if(typeof l=="object"){var h=Object.keys(l);for(var p=0;p<h.length;p++)c[h[p]]=l[h[p]]}this.db._executeUpdateCommand(a,c,function(e,t){t=t&&t.documents;if(!i)return;e?i(e):t[0].err||t[0].errmsg?i(utils.toError(t[0])):t[0].jnote||t[0].wnote||t[0].wtimeout?i(utils.toError(t[0])):i(null,t[0].n,t[0])})},findAndModify=function(t,n,r,i,s){var o=Array.prototype.slice.call(arguments,1);s=o.pop(),n=o.length?o.shift()||[]:[],r=o.length?o.shift():null,i=o.length?o.shift()||{}:{};var u=this,a={findandmodify:this.collectionName,query:t,sort:utils.formattedOrderClause(n)};a.new=i.new?1:0,a.remove=i.remove?1:0,a.upsert=i.upsert?1:0,i.fields&&(a.fields=i.fields),r&&!i.remove&&(a.update=r),i.connection=u.db.serverConfig.checkoutWriter(),i["serializeFunctions"]!=null?i.serializeFunctions=i.serializeFunctions:i.serializeFunctions=this.serializeFunctions,i.checkKeys=!1,this.db.command(a,i,function(e,t){return e?s(e,null):s(null,t.value,t)})},findAndRemove=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop(),t=i.length?i.shift()||[]:[],n=i.length?i.shift()||{}:{},n.remove=!0,this.findAndModify(e,t,null,n,r)};exports.insert=insert,exports.remove=remove,exports.save=save,exports.update=update,exports.findAndModify=findAndModify,exports.findAndRemove=findAndRemove;