var BaseCommand=require("./base_command").BaseCommand,inherits=require("util").inherits,QueryCommand=exports.QueryCommand=function(e,t,n,r,i,s,o,u){BaseCommand.call(this);var a=s,f;if(Buffer.isBuffer(a)){f=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;if(f!=a.length){var l=new Error("query selector raw message size does not match message header size ["+a.length+"] != ["+f+"]");throw l.name="MongoError",l}}a=o;if(Buffer.isBuffer(a)){f=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;if(f!=a.length){var l=new Error("query fields raw message size does not match message header size ["+a.length+"] != ["+f+"]");throw l.name="MongoError",l}}u=u==null?{}:u,this.collectionName=t,this.queryOptions=n,this.numberToSkip=r,this.numberToReturn=i,s=s==null?{}:s,this.query=s,this.returnFieldSelector=o,this.db=e,this.db&&this.db.slaveOk&&(this.queryOptions|=QueryCommand.OPTS_SLAVE),this.checkKeys=typeof u.checkKeys=="boolean"?u.checkKeys:!1,u["serializeFunctions"]!=null&&u.serializeFunctions&&(this.serializeFunctions=!0)};inherits(QueryCommand,BaseCommand),QueryCommand.OP_QUERY=2004,QueryCommand.prototype.setMongosReadPreference=function(e,t){e==1?e="secondaryPreferred":e=="false"&&(e="primary"),e!=0&&e!="primary"&&(this.queryOptions|=QueryCommand.OPTS_SLAVE),(e!=null||t!=null)&&this.query["$query"]==null&&(this.query={$query:this.query}),e==null&&t==null&&(this.queryOptions&QueryCommand.OPTS_SLAVE?this.query.$readPreference={mode:"secondary"}:this.query.$readPreference={mode:"primary"}),typeof e=="object"&&e["_type"]=="ReadPreference"?this.query.$readPreference=e.toObject():e!=null&&(this.query.$readPreference={mode:e},t!=null&&(this.query.$readPreference.tags=t))},QueryCommand.prototype.toBinary=function(e){if(!~this.collectionName.indexOf("\0")){var t=0;Buffer.isBuffer(this.query)?t=4+Buffer.byteLength(this.collectionName)+1+4+4+this.query.length+16:t=4+Buffer.byteLength(this.collectionName)+1+4+4+this.db.bson.calculateObjectSize(this.query,this.serializeFunctions,!0)+16,this.returnFieldSelector!=null&&!Buffer.isBuffer(this.returnFieldSelector)?Object.keys(this.returnFieldSelector).length>0&&(t+=this.db.bson.calculateObjectSize(this.returnFieldSelector,this.serializeFunctions,!0)):Buffer.isBuffer(this.returnFieldSelector)&&(t+=this.returnFieldSelector.length);if(!e.disableDriverBSONSizeCheck&&t>e.maxBsonSize)throw new Error("Document exceeds maximum allowed bson size of "+e.maxBsonSize+" bytes");if(e.disableDriverBSONSizeCheck&&t>e.maxMessageSizeBytes)throw new Error("Command exceeds maximum message size of "+e.maxMessageSizeBytes+" bytes");var n=0,r=new Buffer(t);r[n+3]=t>>24&255,r[n+2]=t>>16&255,r[n+1]=t>>8&255,r[n]=t&255,n+=4,r[n+3]=this.requestId>>24&255,r[n+2]=this.requestId>>16&255,r[n+1]=this.requestId>>8&255,r[n]=this.requestId&255,n+=4,r[n++]=0,r[n++]=0,r[n++]=0,r[n++]=0,r[n+3]=QueryCommand.OP_QUERY>>24&255,r[n+2]=QueryCommand.OP_QUERY>>16&255,r[n+1]=QueryCommand.OP_QUERY>>8&255,r[n]=QueryCommand.OP_QUERY&255,n+=4,r[n+3]=this.queryOptions>>24&255,r[n+2]=this.queryOptions>>16&255,r[n+1]=this.queryOptions>>8&255,r[n]=this.queryOptions&255,n+=4,n=n+r.write(this.collectionName,n,"utf8")+1,r[n-1]=0,r[n+3]=this.numberToSkip>>24&255,r[n+2]=this.numberToSkip>>16&255,r[n+1]=this.numberToSkip>>8&255,r[n]=this.numberToSkip&255,n+=4,r[n+3]=this.numberToReturn>>24&255,r[n+2]=this.numberToReturn>>16&255,r[n+1]=this.numberToReturn>>8&255,r[n]=this.numberToReturn&255,n+=4;var i=0,s=this.query;Buffer.isBuffer(s)?(i=s.length,s.copy(r,n)):i=this.db.bson.serializeWithBufferAndIndex(s,this.checkKeys,r,n,this.serializeFunctions)-n+1,r[n+3]=i>>24&255,r[n+2]=i>>16&255,r[n+1]=i>>8&255,r[n]=i&255,n+=i,r[n-1]=0;if(this.returnFieldSelector!=null&&!Buffer.isBuffer(this.returnFieldSelector)&&Object.keys(this.returnFieldSelector).length>0){var i=this.db.bson.serializeWithBufferAndIndex(this.returnFieldSelector,this.checkKeys,r,n,this.serializeFunctions)-n+1;r[n+3]=i>>24&255,r[n+2]=i>>16&255,r[n+1]=i>>8&255,r[n]=i&255,n+=i,r[n-1]=0}if(this.returnFieldSelector!=null&&Buffer.isBuffer(this.returnFieldSelector)){var i=0,s=this.returnFieldSelector;i=s.length,s.copy(r,n),r[n+3]=i>>24&255,r[n+2]=i>>16&255,r[n+1]=i>>8&255,r[n]=i&255,n+=i,r[n-1]=0}return r}throw new Error("namespace cannot contain a null character")},QueryCommand.OPTS_NONE=0,QueryCommand.OPTS_TAILABLE_CURSOR=2,QueryCommand.OPTS_SLAVE=4,QueryCommand.OPTS_OPLOG_REPLAY=8,QueryCommand.OPTS_NO_CURSOR_TIMEOUT=16,QueryCommand.OPTS_AWAIT_DATA=32,QueryCommand.OPTS_EXHAUST=64,QueryCommand.OPTS_PARTIAL=128;