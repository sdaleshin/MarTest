var ReadPreference=require("./read_preference").ReadPreference,Base=require("./base").Base,Server=require("./server").Server,format=require("util").format,timers=require("timers"),utils=require("../utils"),inherits=require("util").inherits,processor=require("../utils").processor(),Mongos=function e(t,n){if(!(this instanceof e))return new e(t,n);Base.call(this);if(t==null||!Array.isArray(t)||t.length==0)throw new Error("At least one mongos proxy must be in the array");this.options=n==null?{}:n,this.socketOptions=this.options.socketOptions!=null?this.options.socketOptions:{},this.haEnabled=this.options["ha"]==null?!0:this.options.ha,this._haInProgress=!1,this.mongosStatusCheckInterval=this.options["haInterval"]==null?1e3:this.options.haInterval,this.servers=t,this.downServers={},this.upServers={},this.upServersByUpTime={},this.emitOpen=this.options.emitOpen||!0,this.lowestPingTimeServer=null,this.lowestPingTime=0,this._connectTimeoutMS=this.socketOptions.connectTimeoutMS?this.socketOptions.connectTimeoutMS:1e3;for(var r=0;r<this.servers.length;r++){var i=this.servers[r];i._callBackStore=this._callBackStore,i.auto_reconnect=!1;var s={host:i.host,port:i.port};if(this.socketOptions!=null){var o=Object.keys(this.socketOptions);for(var u=0;u<o.length;u++)s[o[r]]=this.socketOptions[o[r]]}i.socketOptions=s}utils.setSocketTimeoutProperty(this,this.socketOptions)};inherits(Mongos,Base),Mongos.prototype.isMongos=function(){return!0},Mongos.prototype.connect=function(e,t,n){"function"==typeof t&&(n=t,t={}),t==null&&(t={}),"function"!=typeof n&&(n=null);var r=this;this.db=e,this._serverState="connecting",this._numberOfServersLeftToInitialize=this.servers.length;var i=function(e){return function(t,i){r._numberOfServersLeftToInitialize=r._numberOfServersLeftToInitialize-1,t||(r.upServers[format("%s:%s",e.host,e.port)]=e),r._numberOfServersLeftToInitialize==0&&(r.haEnabled&&(r._replicasetTimeoutId!=null&&clearInterval(r._replicasetTimeoutId),r._replicasetTimeoutId=setInterval(r.mongosCheckFunction,r.mongosStatusCheckInterval)),r._serverState="connected",r.emitOpen&&r._emitAcrossAllDbInstances(r,null,"open",null,null,null),r._emitAcrossAllDbInstances(r,null,"fullsetup",null,null,null),n(null,r.db))}},s=function(e){return function(t,n){r.emit("left","mongos",e),r.__executeAllCallbacksWithError(t);var i=!1,s=format("%s:%s",e.host,e.port);r.downServers[s]=e,delete r.upServers[s],Object.keys(r.upServers).length==0&&r._emitAcrossAllDbInstances(r,null,"close",new Error("mongos disconnected, no valid proxies contactable over tcp"),null,null)}};this.mongosCheckFunction=function(){r._haInProgress=!0;var e=Object.keys(r.downServers).length;if(e>0)for(var t in r.downServers){var n=r.downServers[t],i={auto_reconnect:!1,returnIsMasterResults:!0,slaveOk:!0,poolSize:n.poolSize,socketOptions:{connectTimeoutMS:r._connectTimeoutMS,socketTimeoutMS:r._socketTimeoutMS}},o=new Server(n.host,n.port,i),u=function(t,n,i,o){return function(){n.connect(t,i,function(t,i){e-=1;if(t)return o(t,n);n._callBackStore=r._callBackStore,n.on("close",s(n)),n.on("timeout",s(n)),n.on("error",s(n));var u=n.checkoutReader(),a=(new Date).getTime();r.db.command({ping:1},{failFast:!0,connection:u},function(e,t){var i=(new Date).getTime();return n.runtimeStats.pingMs=i-a,r._commandsStore.execute_writes(),r._commandsStore.execute_queries(),o(null,n)})})}};u(r.db,o,i,function(t,n){t&&(r.downServers[format("%s:%s",n.host,n.port)]=n);var i=function(e,t,n){var i=e.length();for(var s=0;s<i;s++){var e=e.get(s),o=e.username,u=e.password,a={authMechanism:e.authMechanism,authSource:e.authdb,connection:t};e.gssapiServiceName&&(a.gssapiServiceName=e.gssapiServiceName);var f=null;r.db.authenticate(o,u,a,function(e,t){f=e!=null?e:f,i-=1,i==0&&n(f?f:null,f?!1:!0)})}};if(r.auth.length()>0){var s=n.allRawConnections(),o=s.length;s.length==0&&e==0&&(r._haInProgress=!1);var u=null;for(var a=0;a<s.length;a++)i(r.auth,s[a],function(t,i){o-=1,u=t?t:u,o==0&&(e==0&&(r._haInProgress=!1),t||add_server(r,n),r._commandsStore.execute_writes(),r._commandsStore.execute_queries())})}else t||add_server(r,n),e==0&&(r._haInProgress=!1,r._commandsStore.execute_writes(),r._commandsStore.execute_queries())})()}else r._haInProgress=!1};for(var o=0;o<this.servers.length;o++){var u=this.servers[o];u.mongosInstance=this,u.on("close",s(u)),u.on("timeout",s(u)),u.on("error",s(u));var t={slaveOk:!0,poolSize:u.poolSize,socketOptions:{connectTimeoutMS:r._connectTimeoutMS},returnIsMasterResults:!0};u.connect(r.db,t,i(u))}};var add_server=function(e,t){e.emit("joined","mongos",null,t);var n=format("%s:%s",t.host,t.port);e.upServers[n]=t,delete e.downServers[n];var r=Object.keys(e.upServers),i={},s=[];for(var o in e.upServers)s.push(e.upServers[o]);s.sort(function(e,t){return e.runtimeStats.pingMs>t.runtimeStats.pingMs});for(var u=0;u<s.length;u++)i[format("%s:%s",s[u].host,s[u].port)]=s[u];e.upServers=i};Mongos.prototype.allServerInstances=function(){return this.servers},Mongos.prototype.setReadPreference=function(){},Mongos.prototype.allRawConnections=function(){var e=[];for(var t in this.upServers)e=e.concat(this.upServers[t].allRawConnections());return e},Mongos.prototype.isConnected=function(){return Object.keys(this.upServers).length>0},Mongos.prototype.isAutoReconnect=function(){return!0},Mongos.prototype.canWrite=Mongos.prototype.isConnected,Mongos.prototype.canRead=Mongos.prototype.isConnected,Mongos.prototype.isDestroyed=function(){return this._serverState=="destroyed"},Mongos.prototype.checkoutWriter=function(){var e=Object.keys(this.upServers);return e.length==0?null:this.upServers[e[0]].checkoutWriter()},Mongos.prototype.checkoutReader=function(e){e=e||"primary";if(e!=null&&typeof e=="object"&&e["_type"]=="ReadPreference"){if(!e.isValid())throw new Error("Illegal readPreference mode specified, "+e.mode)}else if(!ReadPreference.isValid(e))throw new Error("Illegal readPreference mode specified, "+e);var t=Object.keys(this.upServers);return t.length==0?null:this.upServers[t[0]].checkoutWriter()},Mongos.prototype.close=function(e){var t=this;this._serverState="destroyed";var n=t.servers.length;t._replicasetTimeoutId!=null&&clearInterval(t._replicasetTimeoutId),t._replicasetTimeoutId=null,processor(function(){t._emitAcrossAllDbInstances(t,null,"close",null,null,!0)}),t._flushAllCallHandlers(utils.toError("Connection Closed By Application"));for(var r in this.upServers)this.upServers[r].close(function(t,r){n-=1,n==0&&typeof e=="function"&&e(null)})},Mongos.prototype._isUsed=function(){return this._used},exports.Mongos=Mongos;