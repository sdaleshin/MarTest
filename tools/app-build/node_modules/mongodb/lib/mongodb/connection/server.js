function Server(e,t,n){if(!(this instanceof Server))return new Server(e,t,n);Base.call(this),t!=null&&typeof t=="object"&&(n=t,t=Connection.DEFAULT_PORT);var r=this;this.host=e,this.port=t,this.options=n==null?{}:n,this.internalConnection,this.internalMaster=!1,this.connected=!1,this.poolSize=this.options.poolSize==null?5:this.options.poolSize,this.disableDriverBSONSizeCheck=this.options.disableDriverBSONSizeCheck!=null?this.options.disableDriverBSONSizeCheck:!1,this._used=!1,this.replicasetInstance=null,this.emitOpen=this.options.emitOpen||!0,this.ssl=this.options.ssl==null?!1:this.options.ssl,this.sslValidate=this.options.sslValidate==null?!1:this.options.sslValidate,this.sslCA=Array.isArray(this.options.sslCA)?this.options.sslCA:null,this.sslCert=this.options.sslCert,this.sslKey=this.options.sslKey,this.sslPass=this.options.sslPass,this.serverCapabilities=null,this.name=format("%s:%s",e,t);if(this.sslValidate&&(!Array.isArray(this.sslCA)||this.sslCA.length==0))throw new Error("The driver expects an Array of CA certificates in the sslCA parameter when enabling sslValidate");var i=this.options.readPreference,s=i!=null&&typeof i=="object"?i.mode:i;if(s!=null){if(s!=ReadPreference.PRIMARY&&s!=ReadPreference.SECONDARY&&s!=ReadPreference.NEAREST&&s!=ReadPreference.SECONDARY_PREFERRED&&s!=ReadPreference.PRIMARY_PREFERRED)throw new Error("Illegal readPreference mode specified, "+s);this._readPreference=i}else this._readPreference=null;this.isMasterDoc,this.socketOptions=this.options.socketOptions!=null?this.options.socketOptions:{},this.disableDriverBSONSizeCheck&&(this.socketOptions.disableDriverBSONSizeCheck=this.disableDriverBSONSizeCheck),this.ssl&&(this.socketOptions.ssl=!0,this.socketOptions.sslValidate=this.sslValidate==null?!1:this.sslValidate,this.socketOptions.sslCA=Array.isArray(this.sslCA)?this.sslCA:null,this.socketOptions.sslCert=this.sslCert,this.socketOptions.sslKey=this.sslKey,this.socketOptions.sslPass=this.sslPass),this.logger=this.options.logger!=null&&typeof this.options.logger.debug=="function"&&typeof this.options.logger.error=="function"&&typeof this.options.logger.log=="function"?this.options.logger:{error:function(e,t){},log:function(e,t){},debug:function(e,t){}},this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[],timeout:[]},this._serverState="disconnected",this._state={runtimeStats:{queryStats:new RunningStats}},this.recordQueryStats=!1,utils.setSocketTimeoutProperty(this,this.socketOptions)}var Connection=require("./connection").Connection,ReadPreference=require("./read_preference").ReadPreference,DbCommand=require("../commands/db_command").DbCommand,MongoReply=require("../responses/mongo_reply").MongoReply,ConnectionPool=require("./connection_pool").ConnectionPool,EventEmitter=require("events").EventEmitter,ServerCapabilities=require("./server_capabilities").ServerCapabilities,Base=require("./base").Base,format=require("util").format,utils=require("../utils"),timers=require("timers"),inherits=require("util").inherits,processor=require("../utils").processor();inherits(Server,Base),Server.READ_PRIMARY=ReadPreference.PRIMARY,Server.READ_SECONDARY=ReadPreference.SECONDARY_PREFERRED,Server.READ_SECONDARY_ONLY=ReadPreference.SECONDARY,Server.prototype.setReadPreference=function(e){this._readPreference=e},Server.prototype.isMongos=function(){return this.isMasterDoc!=null&&this.isMasterDoc["msg"]=="isdbgrid"?!0:!1},Server.prototype._isUsed=function(){return this._used},Server.prototype.close=function(e){this._serverState="destroyed",this.removeAllListeners(),this.connectionPool!=null&&(this.connectionPool.removeAllEventListeners(),this.connectionPool.stop(!0));if(this.db&&!this.isSetMember()){var t=this;processor(function(){t._emitAcrossAllDbInstances(t,null,"close",null,null,!0)}),t._flushAllCallHandlers(utils.toError("Connection Closed By Application"))}typeof e=="function"&&e(null)},Server.prototype.isDestroyed=function(){return this._serverState=="destroyed"},Server.prototype.isConnected=function(){return this.connectionPool!=null&&this.connectionPool.isConnected()},Server.prototype.canWrite=Server.prototype.isConnected,Server.prototype.canRead=Server.prototype.isConnected,Server.prototype.isAutoReconnect=function(){return this.isSetMember()?!1:this.options.auto_reconnect!=null?this.options.auto_reconnect:!0},Server.prototype.allServerInstances=function(){return[this]},Server.prototype.isSetMember=function(){return this.replicasetInstance!=null||this.mongosInstance!=null},Server.prototype.assignReplicaSet=function(e){this.replicasetInstance=e,this.inheritReplSetOptionsFrom(e),this.enableRecordQueryStats(e.recordQueryStats)},Server.prototype.inheritReplSetOptionsFrom=function(e){this.socketOptions={},this.socketOptions.connectTimeoutMS=e.options.socketOptions.connectTimeoutMS||3e4,e.options.ssl&&(this.socketOptions.ssl=!0,this.socketOptions.sslValidate=e.options.sslValidate==null?!1:e.options.sslValidate,this.socketOptions.sslCA=Array.isArray(e.options.sslCA)?e.options.sslCA:null,this.socketOptions.sslCert=e.options.sslCert,this.socketOptions.sslKey=e.options.sslKey,this.socketOptions.sslPass=e.options.sslPass);if(utils.isObject(e.options.socketOptions)){var t=Object.keys(e.options.socketOptions);for(var n=0;n<t.length;n++)this.socketOptions[t[n]]=e.options.socketOptions[t[n]]}},Server.prototype.connect=function(e,t,n){"function"==typeof t&&(n=t,t={}),t==null&&(t={}),"function"!=typeof n&&(n=null);var r=this;this.options=t,this.ssl==1&&(this.socketOptions.ssl=!0,this.socketOptions.sslValidate=this.sslValidate==null?!1:this.sslValidate,this.socketOptions.sslCA=Array.isArray(this.sslCA)?this.sslCA:null,this.socketOptions.sslCert=this.sslCert,this.socketOptions.sslKey=this.sslKey,this.socketOptions.sslPass=this.sslPass);var i=this,s=t.eventReceiver!=null?t.eventReceiver:this;this.db=e,this.dbInstances=[e],i.connectionPool&&i.connectionPool.stop(),this._serverState="connecting",i.connectionPool!=null&&(this.connectionPool.removeAllEventListeners(),this.connectionPool.stop(!0)),this.connectionPool=new ConnectionPool(this.host,this.port,this.poolSize,e.bson,this.socketOptions);var o=this.connectionPool;if(this.ssl==null||!this.ssl)o._timeToWait=null;o.logger=this.logger,o.bson=e.bson;var u=t.returnIsMasterResults==null?!1:t.returnIsMasterResults,a=function(t){return function(o,a){var f=n;n=null,t=t!=null?t:i;if(o!=null&&f==null)return;if(o!=null)return f(o,null,t);t.master=a.documents[0].ismaster==1?!0:!1,t.connectionPool.setMaxBsonSize(a.documents[0].maxBsonObjectSize),t.connectionPool.setMaxMessageSizeBytes(a.documents[0].maxMessageSizeBytes),t._serverState="connected",t.connected=!0,t.isMasterDoc=a.documents[0],r.emitOpen?(t._emitAcrossAllDbInstances(t,s,"open",null,u?a:null,null),r.emitOpen=!1):t._emitAcrossAllDbInstances(t,s,"reconnect",null,u?a:null,null),i.serverCapabilities=new ServerCapabilities(t.isMasterDoc),u?f(null,a,t):f(null,e,t)}},f=t.connectHandler==null?a(i):t.connectHandler;o.on("poolReady",function(){var t=DbCommand.NcreateIsMasterCommand(e,e.databaseName),n=o.checkoutConnection();i._registerHandler(t,!1,n,f),n.write(t)}),o.on("message",function(e){try{var t=new MongoReply;t.parseHeader(e,o.bson);if(t.messageLength!=e.length)s.listeners("error")&&s.listeners("error").length>0&&s.emit("error",new Error("bson length is different from message length"),i),i.removeAllListeners();else{var r=(new Date).getTime(),u=i._findHandler(t.responseTo.toString());t.requestId>0&&t.cursorId.toString()!="0"&&u&&u.info&&u.info.exhaust&&i._reRegisterHandler(t.requestId,u),t.parseBody(e,o.bson,u.info.raw,function(e){if(e!=null){if(i._serverState==="disconnected")return;i._serverState="disconnected",i.removeAllListeners(),o.stop(!0);if(typeof n=="function"){var r=n;n=null,r(e,null,i)}else i.isSetMember()?i.listeners("parseError")&&i.listeners("parseError").length>0&&i.emit("parseError",utils.toError(e),i):s.listeners("parseError")&&s.listeners("parseError").length>0&&s.emit("parseError",utils.toError(e),i);i.isSetMember()||(i.__executeAllCallbacksWithError(e),i._emitAcrossAllDbInstances(i,s,"parseError",i,null,!0));return}i.recordQueryStats==1&&i._state["runtimeStats"]!=null&&i._state.runtimeStats.queryStats instanceof RunningStats&&i._state.runtimeStats.queryStats.push((new Date).getTime()-u.info.start),i._callHandler(t.responseTo,t,null),(t.responseFlag&1<<1)!=0&&t.documents[0].code&&t.documents[0].code==13436&&i.close()})}}catch(a){processor(function(){throw a})}}),o.on("timeout",function(e){if(i._serverState==="disconnected"||i._serverState==="destroyed")return;i._serverState="disconnected";if(typeof n=="function"){var t=n;n=null,t(e,null,i)}else i.isSetMember()?i.listeners("timeout")&&i.listeners("timeout").length>0&&i.emit("timeout",e,i):s.listeners("timeout")&&s.listeners("timeout").length>0&&s.emit("timeout",e,i);i.isSetMember()||(i.__executeAllCallbacksWithError(e),i._emitAcrossAllDbInstances(i,s,"timeout",e,i,!0)),i.isAutoReconnect()&&!i.isSetMember()&&i._serverState!="destroyed"&&!i._reconnectInProgreess&&(i._reconnect_retries=i.db.numberOfRetries,i._reconnectInProgreess=!0,setTimeout(l(i),i.db.retryMiliSeconds))}),o.on("error",function(e,t,r){if(i._serverState==="disconnected"||i._serverState==="destroyed")return;i._serverState="disconnected";var o=new Error(e&&e.err?e.err:e);r&&r.ssl&&(o.ssl=!0);if(typeof n=="function"){var u=n;n=null,u(o,null,i)}else i.isSetMember()?i.listeners("error")&&i.listeners("error").length>0&&i.emit("error",o,i):s.listeners("error")&&s.listeners("error").length>0&&s.emit("error",o,i);i.isSetMember()||(i.__executeAllCallbacksWithError(o),i._emitAcrossAllDbInstances(i,s,"error",o,i,!0)),i.isAutoReconnect()&&!i.isSetMember()&&i._serverState!="destroyed"&&!i._reconnectInProgreess&&(i._reconnect_retries=i.db.numberOfRetries,i._reconnectInProgreess=!0,setTimeout(l(i),i.db.retryMiliSeconds))}),o.on("close",function(){if(i._serverState==="disconnected"||i._serverState==="destroyed")return;i._serverState="disconnected";if(typeof n=="function"){var e=n;n=null,e(new Error("connection closed"),null,i)}else i.isSetMember()?i.listeners("close")&&i.listeners("close").length>0&&i.emit("close",new Error("connection closed"),i):s.listeners("close")&&s.listeners("close").length>0&&s.emit("close",new Error("connection closed"),i);i.isSetMember()||(i.__executeAllCallbacksWithError(new Error("connection closed")),i._emitAcrossAllDbInstances(i,s,"close",i,null,!0)),i.isAutoReconnect()&&!i.isSetMember()&&i._serverState!="destroyed"&&!i._reconnectInProgreess&&(i._reconnect_retries=i.db.numberOfRetries,i._reconnectInProgreess=!0,setTimeout(l(i),i.db.retryMiliSeconds))});var l=function(e){return function(){e.connect(e.db,e.options,function(t,n){e._reconnect_retries=e._reconnect_retries-1;if(t)return e._reconnect_retries==0||e._serverState=="destroyed"?(e._serverState="connected",e._reconnectInProgreess=!1,e.__executeAllCallbacksWithError(new Error("failed to reconnect to server"))):setTimeout(l(e),e.db.retryMiliSeconds);e._serverState="authenticating",r._apply_auths(e.db,function(t,n){e._serverState="connected",e._reconnectInProgreess=!1,e._commandsStore.execute_queries(),e._commandsStore.execute_writes()})})}};o.on("parseError",function(e){if(i._serverState==="disconnected"||i._serverState==="destroyed")return;i._serverState="disconnected";if(typeof n=="function"){var t=n;n=null,t(utils.toError(e),null,i)}else i.isSetMember()?i.listeners("parseError")&&i.listeners("parseError").length>0&&i.emit("parseError",utils.toError(e),i):s.listeners("parseError")&&s.listeners("parseError").length>0&&s.emit("parseError",utils.toError(e),i);i.isSetMember()||(i.__executeAllCallbacksWithError(utils.toError(e)),i._emitAcrossAllDbInstances(i,s,"parseError",i,null,!0))}),o.start()},Server.prototype.allRawConnections=function(){return this.connectionPool!=null?this.connectionPool.getAllConnections():[]};var canCheckoutWriter=function(e,t){return e.isMasterDoc&&e.isMasterDoc["arbiterOnly"]==1?new Error("Cannot write to an arbiter"):e.isMasterDoc&&e.isMasterDoc["secondary"]==1?new Error("Cannot write to a secondary"):t==1&&e._readPreference==ReadPreference.SECONDARY&&e.isMasterDoc&&e.isMasterDoc["ismaster"]==1?new Error("Cannot read from primary when secondary only specified"):e.isMasterDoc?null:new Error("Cannot determine state of server")};Server.prototype.checkoutWriter=function(e){if(e==1)return this.connectionPool.checkoutConnection();var t=canCheckoutWriter(this,e);if(t==null&&this.connectionPool!=null){var n=this.connectionPool.checkoutConnection();return n&&(n.serverCapabilities=this.serverCapabilities),n}return t==null?null:t};var canCheckoutReader=function(e){if(e.isMasterDoc&&e.isMasterDoc["arbiterOnly"]==1)return new Error("Cannot write to an arbiter");if(e._readPreference!=null){if(e._readPreference==ReadPreference.PRIMARY&&e.isMasterDoc&&e.isMasterDoc["ismaster"]!=1)return new Error("Read preference is Server.PRIMARY and server is not master");if(e._readPreference==ReadPreference.SECONDARY&&e.isMasterDoc&&e.isMasterDoc["ismaster"]==1)return new Error("Cannot read from primary when secondary only specified")}else if(!e.isMasterDoc)return new Error("Cannot determine state of server");return null};Server.prototype.checkoutReader=function(e){var t=canCheckoutReader(this);if(t==null&&this.connectionPool!=null){var n=this.connectionPool.checkoutConnection();return n&&(n.serverCapabilities=this.serverCapabilities),n}return t==null?null:t},Server.prototype.enableRecordQueryStats=function(e){this.recordQueryStats=e};var RunningStats=function(){var e=this;this.m_n=0,this.m_oldM=0,this.m_oldS=0,this.m_newM=0,this.m_newS=0,Object.defineProperty(this,"numDataValues",{enumerable:!0,get:function(){return this.m_n}}),Object.defineProperty(this,"mean",{enumerable:!0,get:function(){return this.m_n>0?this.m_newM:0}}),Object.defineProperty(this,"variance",{enumerable:!0,get:function(){return this.m_n>1?this.m_newS/(this.m_n-1):0}}),Object.defineProperty(this,"standardDeviation",{enumerable:!0,get:function(){return Math.sqrt(this.variance)}}),Object.defineProperty(this,"sScore",{enumerable:!0,get:function(){var e=this.mean+this.standardDeviation;return e==0?0:2*this.mean*this.standardDeviation/e}})};RunningStats.prototype.push=function(e){this.m_n=this.m_n+1,this.m_n==1?(this.m_oldM=this.m_newM=e,this.m_oldS=0):(this.m_newM=this.m_oldM+(e-this.m_oldM)/this.m_n,this.m_newS=this.m_oldS+(e-this.m_oldM)*(e-this.m_newM),this.m_oldM=this.m_newM,this.m_oldS=this.m_newS)},Object.defineProperty(Server.prototype,"autoReconnect",{enumerable:!0,get:function(){return this.options["auto_reconnect"]==null?!1:this.options.auto_reconnect}}),Object.defineProperty(Server.prototype,"connection",{enumerable:!0,get:function(){return this.internalConnection},set:function(e){this.internalConnection=e}}),Object.defineProperty(Server.prototype,"master",{enumerable:!0,get:function(){return this.internalMaster},set:function(e){this.internalMaster=e}}),Object.defineProperty(Server.prototype,"primary",{enumerable:!0,get:function(){return this}}),Object.defineProperty(Server.prototype,"queryStats",{enumerable:!0,get:function(){return this._state.runtimeStats.queryStats}}),Object.defineProperty(Server.prototype,"runtimeStats",{enumerable:!0,get:function(){return this._state.runtimeStats}}),Object.defineProperty(Server.prototype,"readPreference",{enumerable:!0,get:function(){return this._readPreference==null&&this.readSecondary?Server.READ_SECONDARY:this._readPreference==null&&!this.readSecondary?Server.READ_PRIMARY:this._readPreference}}),exports.Server=Server;