var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,utils=require("../utils"),mongodb_cr_authenticate=require("../auth/mongodb_cr.js").authenticate,mongodb_gssapi_authenticate=require("../auth/mongodb_gssapi.js").authenticate,mongodb_sspi_authenticate=require("../auth/mongodb_sspi.js").authenticate,mongodb_plain_authenticate=require("../auth/mongodb_plain.js").authenticate,mongodb_x509_authenticate=require("../auth/mongodb_x509.js").authenticate,id=0,CallbackStore=function(){EventEmitter.call(this),this._notReplied={},this.id=id++};inherits(CallbackStore,EventEmitter),CallbackStore.prototype.notRepliedToIds=function(){return Object.keys(this._notReplied)},CallbackStore.prototype.callbackInfo=function(e){return this._notReplied[e]};var NonExecutedOperationStore=function(e){var t={read:[],write_reads:[],write:[]},n=function(e,t){while(t.length>0){var n=t.shift();typeof n.callback=="function"&&n.callback(e)}};this.count=function(){return t.read.length+t.write_reads.length+t.write.length},this.write=function(e){t.write.push(e)},this.read_from_writer=function(e){t.write_reads.push(e)},this.read=function(e){t.read.push(e)},this.validateBufferLimit=function(e){if(e==-1||e==null)return!0;var r=utils.toError("No connection operations buffering limit of "+e+" reached");return e<this.count()&&(n(r,t.read),n(r,t.write_reads),n(r,t.write)),!1},this.execute_queries=function(n){var r=e.checkoutReader();if(r==null||r instanceof Error)return;while(t.read.length>0){var i=t.read.shift();i.options.connection=r,i.executeQueryCommand(i.db,i.db_command,i.options,i.callback)}},this.execute_writes=function(){var n=e.checkoutWriter();if(n==null||n instanceof Error)return;while(t.write_reads.length>0){var r=t.write_reads.shift();r.options.connection=n,r.executeQueryCommand(r.db,r.db_command,r.options,r.callback)}while(t.write.length>0){var r=t.write.shift();r.options.connection=n,r.executeInsertCommand(r.db,r.db_command,r.options,r.callback)}}},AuthStore=function(){var e=[];this.add=function(t,n,r,i,s,o){if(!this.contains(n)){var u={username:r,password:i,db:n,authMechanism:t,gssapiServiceName:o};typeof s=="string"&&(u.authdb=s),e.push(u)}},this.contains=function(t){for(var n=0;n<e.length;n++)if(e[n].db==t)return!0;return!1},this.remove=function(t){var n=[];for(var r=0;r<e.length;r++)e[r].db!=t&&n.push(e[r]);e=n},this.get=function(t){return e[t]},this.length=function(){return e.length},this.toArray=function(){return e.slice(0)}},DbStore=function(){var e=[];this.add=function(t){var n=!1;for(var r=0;r<e.length;r++)t.databaseName==e[r].databaseName&&(n=!0);n||e.push(t)},this.reset=function(){e=[]},this.db=function(){return e},this.fetch=function(t){for(var n=0;n<e.length;n++)if(t==e[n].databaseName)return e[n];return null},this.emit=function(t,n,r,i,s,o){var u=!1;if(!u&&o)return process.nextTick(function(){throw n});for(var a=0;a<e.length;a++)e[a].listeners(t).length>0&&(s==null||s.databaseName!==e[a].databaseName||s.tag!==e[a].tag)&&(e[a].emit(t,n,r==null?e[a]:r),u=!0);n&&t=="error"&&!u&&o&&r&&r.db&&process.nextTick(function(){r.db.emit(t,n,null)})}},Base=function e(){EventEmitter.call(this),e._callBackStore==null&&(e._callBackStore=new CallbackStore),this._callBackStore=new CallbackStore,this._commandsStore=new NonExecutedOperationStore(this),this.auth=new AuthStore,this._dbStore=new DbStore};inherits(Base,EventEmitter),Base.prototype._apply_auths=function(e,t){_apply_auths_serially(this,e,this.auth.toArray(),t)};var _apply_auths_serially=function(e,t,n,r){if(n.length==0)return r(null,null);var i=n.shift(),s=e.allRawConnections(),o=s.length,u={};i.authMechanism=="GSSAPI"?process.platform=="win32"?mongodb_sspi_authenticate(t,i.username,i.password,i.authdb,u,r):mongodb_gssapi_authenticate(t,i.username,i.password,i.authdb,u,r):i.authMechanism=="MONGODB-CR"?mongodb_cr_authenticate(t,i.username,i.password,i.authdb,u,r):i.authMechanism=="PLAIN"?mongodb_plain_authenticate(t,i.username,i.password,i.authdb,u,r):i.authMechanism=="MONGODB-X509"&&mongodb_x509_authenticate(t,i.username,i.password,i.authdb,u,r)};Base.prototype.__executeAllCallbacksWithError=function(e){var t=Object.keys(this._callBackStore._notReplied);for(var n=0;n<t.length;n++){var r=this._callBackStore._notReplied[t[n]];this._callBackStore.emit(t[n],e,null),delete this._callBackStore._notReplied[t[n]],this._callBackStore._events&&delete this._callBackStore._events[t[n]]}},Base.prototype.__executeAllServerSpecificErrorCallbacks=function(e,t,n){var r=Object.keys(this._callBackStore._notReplied);for(var i=0;i<r.length;i++){var s=this._callBackStore._notReplied[r[i]];if(s.connection){var o=s.connection.socketOptions.host,u=s.connection.socketOptions.port;u==t&&o==e&&(this._callBackStore.emit(r[i],n,null),delete this._callBackStore._notReplied[r[i]],this._callBackStore._events&&delete this._callBackStore._events[r[i]])}}},Base.prototype._registerHandler=function(e,t,n,r,i){typeof r=="function"&&(i=r,r=!1),this._callBackStore.once(e.getRequestId(),i),this._callBackStore._notReplied[e.getRequestId().toString()]={start:(new Date).getTime(),raw:t,connection:n,exhaust:r}},Base.prototype._reRegisterHandler=function(e,t,n){this._callBackStore.once(e,t.callback.listener),this._callBackStore._notReplied[e]=t.info},Base.prototype._flushAllCallHandlers=function(e){var t=Object.keys(this._callBackStore._notReplied);for(var n=0;n<t.length;n++)this._callHandler(t[n],null,e)},Base.prototype._callHandler=function(e,t,n){var r=this;if(this._callBackStore.listeners(e).length>=1){var i=this._callBackStore._notReplied[e];delete this._callBackStore._notReplied[e];var s=this._callBackStore.listeners(e)[0].listener;this._callBackStore.removeAllListeners(e),this._callBackStore._events&&delete this._callBackStore._events[e];try{typeof s=="function"&&s(n,t,i.connection)}catch(n){r._emitAcrossAllDbInstances(r,null,"error",utils.toError(n),r,!0,!0)}}},Base.prototype._hasHandler=function(e){return this._callBackStore.listeners(e).length>=1},Base.prototype._removeHandler=function(e){this._callBackStore._notReplied[e]!=null&&delete this._callBackStore._notReplied[e],this._callBackStore.removeAllListeners(e),this._callBackStore._events&&delete this._callBackStore._events[e]},Base.prototype._findHandler=function(e){var t=this._callBackStore._notReplied[e];return{info:t,callback:this._callBackStore.listeners(e).length>=1?this._callBackStore.listeners(e)[0]:null}},Base.prototype._emitAcrossAllDbInstances=function(e,t,n,r,i,s,o){if(s){var u=this._dbStore.db();for(var a=0;a<u.length;a++)typeof u[a].openCalled!="undefined"&&(u[a].openCalled=!1)}this._dbStore.emit(n,r,i,s,t,o)},exports.Base=Base;