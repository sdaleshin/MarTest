var Server=require("../../server").Server,format=require("util").format,PingStrategy=exports.PingStrategy=function(e,t){this.replicaset=e,this.secondaryAcceptableLatencyMS=t,this.state="disconnected",this.pingInterval=5e3,this.Db=require("../../../db").Db,this.dbs={},this.index=0,this.Logger=null};PingStrategy.prototype.start=function(e){if("connected"==this.state)return;this.state="connected",this._pingServer(e)},PingStrategy.prototype.stop=function(e){this.state="disconnected";for(var t in this.dbs)this.dbs[t].close();e&&e(null,null)},PingStrategy.prototype.checkoutConnection=function(e,t){var n=[],r=this;if(!Array.isArray(t)){n=this.replicaset._state.master!=null?[this.replicaset._state.master]:[];var i=Object.keys(this.replicaset._state.secondaries);for(var s=0;s<i.length;s++)n.push(this.replicaset._state.secondaries[i[s]])}else n=t;var o=[];if(e!=null&&typeof e=="object"){var u=Array.isArray(e)?e:[e];for(var a=0;a<u.length;a++){var f=u[a],l=Object.keys(f);for(var s=0;s<n.length;s++){var c=n[s];if(c.tags!=null){var h=!0;for(var p=0;p<l.length;p++)if(c.tags[l[p]]!=f[l[p]]){h=!1;break}h&&o.push(c)}}}}else var o=n;o.sort(function(e,t){return e.runtimeStats.pingMs>t.runtimeStats.pingMs});if(0===o.length)return new Error("No replica set members available for query");var d=o.filter(function(e){return undefined!=e.runtimeStats.pingMs})[0];d||(d=o[0]);var v=d.runtimeStats.pingMs|0,m=v+this.secondaryAcceptableLatencyMS,g=o.length;while(g--)o[g].runtimeStats.pingMs>m&&o.splice(g,1);r.logger&&r.logger.debug&&(r.logger.debug("Ping strategy selection order for tags",e),o.forEach(function(e){r.logger.debug(format("%s:%s = %s ms",e.host,e.port,e.runtimeStats.pingMs),null)}));if(o.length==0)return new Error("No replica set members available for query");this.index=this.index%o.length;var y=o[this.index].checkoutReader();return this.index=this.index+1,r.logger&&r.logger.debug&&y&&r.logger.debug("picked server %s:%s",y.socketOptions.host,y.socketOptions.port),y},PingStrategy.prototype._pingServer=function(e){var t=this,n=function(){if(t.state=="disconnected"||t.state=="destroyed")return;if(t.replicaset.isDestroyed()||t.replicaset._serverState=="disconnected")return;var e=t.replicaset._state.master!=null?[t.replicaset._state.master]:[],r=Object.keys(t.replicaset._state.secondaries);for(var i=0;i<r.length;i++)e.push(t.replicaset._state.secondaries[r[i]]);var s=e.length;for(var i=0;i<e.length;i++){var o=e[i];new function(e){function f(){s--,0===s&&"connected"==t.state&&setTimeout(n,t.pingInterval)}var r=t.dbs[e.host+":"+e.port];if(r!=null){var i=Date.now(),o=function(e,n){e.executeDbCommand({ping:1},{failFast:!0},function(r){if(r)return delete t.dbs[e.serverConfig.host+":"+e.serverConfig.port],e.close(),f();null!=n.runtimeStats&&n.isConnected()&&(n.runtimeStats.pingMs=Date.now()-i),e.executeDbCommand({ismaster:1},{failFast:!0},function(r,i){if(r)return delete t.dbs[e.serverConfig.host+":"+e.serverConfig.port],e.close(),f();i&&i.documents&&t.replicaset.processIsMaster&&t.replicaset.processIsMaster(n,i.documents[0]),f()})})};o(r,e)}else{var u=t.replicaset.options.socketOptions?t.replicaset.options.socketOptions.connectTimeoutMS:0,a=new Server(e.host,e.port,{auto_reconnect:!1,returnIsMasterResults:!0,slaveOk:!0,poolSize:1,socketOptions:{connectTimeoutMS:u},ssl:t.replicaset.options.ssl,sslValidate:t.replicaset.options.sslValidate,sslCA:t.replicaset.options.sslCA,sslCert:t.replicaset.options.sslCert,sslKey:t.replicaset.options.sslKey,sslPass:t.replicaset.options.sslPass}),r=new t.Db("local",a,{safe:!0});r.on("close",function(){delete t.dbs[this.serverConfig.host+":"+this.serverConfig.port]});var o=function(e,n){if(t.state=="disconnected"){t.stop();return}e.open(function(r,i){if(t.state=="disconnected"&&e!=null)return e.close();if(r)return delete t.dbs[e.serverConfig.host+":"+e.serverConfig.port],e.close(),f();t.dbs[e.serverConfig.host+":"+e.serverConfig.port]=e;var s=Date.now();e.executeDbCommand({ping:1},{failFast:!0},function(r){if(r)return delete t.dbs[e.serverConfig.host+":"+e.serverConfig.port],e.close(),f();null!=n.runtimeStats&&n.isConnected()&&(n.runtimeStats.pingMs=Date.now()-s),e.executeDbCommand({ismaster:1},{failFast:!0},function(r,i){if(r)return delete t.dbs[e.serverConfig.host+":"+e.serverConfig.port],e.close(),f();i&&i.documents&&t.replicaset.processIsMaster&&t.replicaset.processIsMaster(n,i.documents[0]),f()})})})};o(r,e)}}(o)}};n(),e&&e(null)};