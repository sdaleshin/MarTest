var DbCommand=require("../../commands/db_command").DbCommand,format=require("util").format,HighAvailabilityProcess=function(e,t){this.replset=e,this.options=t,this.server=null,this.state=HighAvailabilityProcess.INIT,this.selectedIndex=0};HighAvailabilityProcess.INIT="init",HighAvailabilityProcess.RUNNING="running",HighAvailabilityProcess.STOPPED="stopped",HighAvailabilityProcess.prototype.start=function(){var e=this;if(this.replset._state&&Object.keys(this.replset._state.addresses).length==0){this.server&&this.server.close(),this.state=HighAvailabilityProcess.STOPPED;return}this.server&&this.server.close(),this._haProcessInProcess=!1,this.state=HighAvailabilityProcess.RUNNING;var t=this.replset._state.getAllReadServers();if(t.length==0)return;var n=t[this.selectedIndex%t.length];this.selectedIndex=this.selectedIndex+1;var r=e.options.connectTimeoutMS||1e4,i=e.options.socketTimeoutMS||3e4,s=require("../../db").Db,o=require("../server").Server,u=new o(n.host,n.port,{auto_reconnect:!1,returnIsMasterResults:!0,poolSize:1,socketOptions:{connectTimeoutMS:r,socketTimeoutMS:i,keepAlive:100},ssl:this.options.ssl,sslValidate:this.options.sslValidate,sslCA:this.options.sslCA,sslCert:this.options.sslCert,sslKey:this.options.sslKey,sslPass:this.options.sslPass});e.db=new s("local",u,{w:1}),u.once("error",_handle(this,u)),u.once("close",_handle(this,u)),u.once("timeout",_handle(this,u)),u.name=format("%s:%s",n.host,n.port),u.connect(e.db,function(t,n,r){e.state==HighAvailabilityProcess.STOPPED&&r.close();if(t){r.close();if(Object.keys(e.replset._state.addresses).length==0)return;setTimeout(function(){e.start()},e.options.haInterval)}else e.server=r,setTimeout(_timeoutHandle(e),e.options.haInterval)})},HighAvailabilityProcess.prototype.stop=function(){this.state=HighAvailabilityProcess.STOPPED,this.server&&this.server.close()};var _timeoutHandle=function(e){return function(){if(e.state==HighAvailabilityProcess.STOPPED){for(var t in e.replset._state.addresses)e.replset._state.addresses[t].close(),delete e.replset._state.addresses[t];return}e.server.isConnected()&&!e._haProcessInProcess?(e._haProcessInProcess=!0,e.db._executeQueryCommand(DbCommand.createIsMasterCommand(e.db),{failFast:!0,connection:e.server.checkoutReader()},function(t,n){if(t)return e.server.close(),setTimeout(_timeoutHandle(e),e.options.haInterval);var r=n.documents[0],i=r.hosts||[],s=[],o=e.replset._state;if(!r.ismaster&&!r.secondary&&o.addresses[r.me])return e.server.close(),o.addresses[r.me].close(),delete o.secondaries[r.me],setTimeout(_timeoutHandle(e),e.options.haInterval);for(var u=0;u<i.length;u++){var a=i[u];o.addresses[a]==null?s.push(a):o.addresses[a]&&!o.addresses[a].isConnected()&&(o.addresses[a].close(),delete o.secondaries[a],s.push(a));if(r.primary&&o.master==null||r.primary&&o.master.name!=r.primary)o.addresses[r.primary]&&(o.master&&o.master.close(),delete o.secondaries[r.primary],o.master=o.addresses[r.primary]),o.master!=null&&o.master.isMasterDoc!=null?(o.master.isMasterDoc.ismaster=!0,o.master.isMasterDoc.secondary=!1):o.master!=null&&(o.master.isMasterDoc=r,o.master.isMasterDoc.ismaster=!0,o.master.isMasterDoc.secondary=!1),e.replset._commandsStore.execute_queries(),e.replset._commandsStore.execute_writes()}if(!(s.length>0))return e._haProcessInProcess=!1,setTimeout(_timeoutHandle(e),e.options.haInterval);_reconnect_servers(e,s)})):e.server.isConnected()?setTimeout(_timeoutHandle(e),e.options.haInterval):setTimeout(function(){return e.start()},e.options.haInterval)}},_reconnect_servers=function(e,t){if(t.length==0)return e._haProcessInProcess=!1,setTimeout(_timeoutHandle(e),e.options.haInterval);var n=e.options.connectTimeoutMS||1e4,r=e.options.socketTimeoutMS||0,i=require("../../db").Db,s=require("../server").Server,o=t.shift(),u=o.split(":")[0],a=parseInt(o.split(":")[1],10),f=new s(u,a,{auto_reconnect:!1,returnIsMasterResults:!0,poolSize:e.options.poolSize,socketOptions:{connectTimeoutMS:n,socketTimeoutMS:r},ssl:e.options.ssl,sslValidate:e.options.sslValidate,sslCA:e.options.sslCA,sslCert:e.options.sslCert,sslKey:e.options.sslKey,sslPass:e.options.sslPass}),l=new i("local",f,{w:1}),c=e.replset._state;f.once("error",_repl_set_handler("error",e.replset,f)),f.once("close",_repl_set_handler("close",e.replset,f)),f.once("timeout",_repl_set_handler("timeout",e.replset,f)),f.name=o,f._callBackStore=e.replset._callBackStore,f.replicasetInstance=e.replset,f.enableRecordQueryStats(e.replset.recordQueryStats),f.connect(l,function(n,r,i){e.state==HighAvailabilityProcess.STOPPED&&i.close(),n?(i.close(),e.replset.__executeAllServerSpecificErrorCallbacks(i.socketOptions.host,i.socketOptions.port,n),setTimeout(function(){_reconnect_servers(e,t)},e.options.haInterval)):_apply_auths(e,l,i,function(n,r){if(n)return i.close(),setTimeout(function(){_reconnect_servers(e,t)},e.options.haInterval);var s=i.isMasterDoc;e.replset.__executeAllServerSpecificErrorCallbacks(i.socketOptions.host,i.socketOptions.port,n),s.ismaster?(e.replset.emit("joined","primary",s,i),c.secondaries[s.me]&&delete c.secondaries[s.me],c.addresses[s.me]=i,c.master=i,e.replset._commandsStore.execute_writes()):s.secondary?(e.replset.emit("joined","secondary",s,i),c.secondaries[s.me]=i,c.addresses[s.me]=i,e.replset._commandsStore.execute_queries()):i.close(),i.name=s.me,i.tags=s.tags,setTimeout(function(){_reconnect_servers(e,t)},e.options.haInterval)})})},_apply_auths=function(e,t,n,r){if(e.replset.auth.length()==0)return r(null);if(e.replset.auth.length()>0){var i=e.replset.auth.length(),s=n.allRawConnections(),o=s.length,u=function(e,n,r){var i=e.length();for(var s=0;s<i;s++){var e=e.get(s),o=e.username,u=e.password,a={authMechanism:e.authMechanism,authSource:e.authdb,connection:n};e.gssapiServiceName&&(a.gssapiServiceName=e.gssapiServiceName);var f=null;t.authenticate(o,u,a,function(e,t){f=e!=null?e:f,i-=1,i==0&&r(f?f:null,f?!1:!0)})}},a=null;for(var f=0;f<s.length;f++)u(e.replset.auth,s[f],function(e,t){o-=1,a=e?e:a,o==0&&r(null)})}},_handle=function(e,t){return function(e){t.close()}},_repl_set_handler=function(e,t,n){var r=require("./repl_set").ReplSet;return function(e,i){n.close(),t._state.isPrimary(n)?(t._state.master==null,t._serverState=r.REPLSET_READ_ONLY):t._state.isSecondary(n)&&delete t._state.secondaries[n.name];var s=n.socketOptions.host,o=n.socketOptions.port;t.__executeAllServerSpecificErrorCallbacks(s,o,e)}};exports.HighAvailabilityProcess=HighAvailabilityProcess;