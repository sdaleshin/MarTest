function _roundRobin(e,t){var n=Object.keys(e._state.secondaries);e._currentServerChoice=e._currentServerChoice+1;var r=n[e._currentServerChoice%n.length],i=null!=e._state.secondaries[r]?e._state.secondaries[r].checkoutReader():null;return null==i&&(i=pickFirstConnectedSecondary(e,t)),i}var ReadPreference=require("../read_preference").ReadPreference,DbCommand=require("../../commands/db_command").DbCommand,inherits=require("util").inherits,format=require("util").format,timers=require("timers"),Server=require("../server").Server,utils=require("../../utils"),PingStrategy=require("./strategies/ping_strategy").PingStrategy,StatisticsStrategy=require("./strategies/statistics_strategy").StatisticsStrategy,Options=require("./options").Options,ReplSetState=require("./repl_set_state").ReplSetState,HighAvailabilityProcess=require("./ha").HighAvailabilityProcess,Base=require("../base").Base,STATE_STARTING_PHASE_1=0,STATE_PRIMARY=1,STATE_SECONDARY=2,STATE_RECOVERING=3,STATE_FATAL_ERROR=4,STATE_STARTING_PHASE_2=5,STATE_UNKNOWN=6,STATE_ARBITER=7,STATE_DOWN=8,STATE_ROLLBACK=9,processor=require("../../utils").processor(),ReplSet=exports.ReplSet=function(e,t){if(!(this instanceof ReplSet))return new ReplSet(e,t);Base.call(this);if(!Array.isArray(e))throw Error("The parameter must be an array of servers and contain at least one server");for(var n=0;n<e.length;n++)if(!(e[n]instanceof Server))throw new Error("list of servers must be of type Server");this.options=new Options(t),this.options.init(),this._serverState=ReplSet.REPLSET_DISCONNECTED,this._haProcess=new HighAvailabilityProcess(this,this.options),this.servers=this.options.decorateAndClean(e,this._callBackStore);if(this.servers.length==0)throw new Error("No valid seed servers in the array");this.options.strategy=="ping"?this.strategyInstance=new PingStrategy(this,this.options.secondaryAcceptableLatencyMS):this.options.strategy=="statistical"&&(this.strategyInstance=new StatisticsStrategy(this),this.enableRecordQueryStats(!0)),this.emitOpen=this.options.emitOpen||!0,this._state=new ReplSetState(this),this._currentServerChoice=0;for(var n=0;n<this.servers.length;n++)this.servers[n]._callBackStore=this._callBackStore,this.servers[n].name=format("%s:%s",this.servers[n].host,this.servers[n].port),this.servers[n].replicasetInstance=this,this.servers[n].options.auto_reconnect=!1,this.servers[n].inheritReplSetOptionsFrom(this);utils.setSocketTimeoutProperty(this,this.options.socketOptions)};inherits(ReplSet,Base),ReplSet.REPLSET_CONNECTING="connecting",ReplSet.REPLSET_DISCONNECTED="disconnected",ReplSet.REPLSET_CONNECTED="connected",ReplSet.REPLSET_RECONNECTING="reconnecting",ReplSet.REPLSET_DESTROYED="destroyed",ReplSet.REPLSET_READ_ONLY="readonly",ReplSet.prototype.isAutoReconnect=function(){return!0},ReplSet.prototype.canWrite=function(){return this._state.master&&this._state.master.isConnected()},ReplSet.prototype.canRead=function(e){return e!=ReadPreference.PRIMARY&&e!=null&&e!=0||this._state.master!=null&&!!this._state.master.isConnected()?Object.keys(this._state.secondaries).length>0:!1},ReplSet.prototype.enableRecordQueryStats=function(e){this.recordQueryStats=e;for(var t=0;t<this.servers.length;t++)this.servers[t].enableRecordQueryStats(e)},ReplSet.prototype.setReadPreference=function(e){this.options.readPreference=e},ReplSet.prototype.connect=function(e,t,n){if(this._serverState!=ReplSet.REPLSET_DISCONNECTED)return n(new Error("in process of connection"));if(typeof n!="function")throw new Error("cannot call ReplSet.prototype.connect with no callback function");var r=this;this.options.db=e,this._serverState=ReplSet.REPLSET_CONNECTING;var i=this.servers.slice(0),s=i.pop();s.name=format("%s:%s",s.host,s.port);var o={returnIsMasterResults:!0,eventReceiver:s};this.once("fullsetup",function(e,t,i){r._serverState=ReplSet.REPLSET_CONNECTED,r._haProcess&&r._haProcess.stop(),r._haProcess.start(),processor(function(){r.emitOpen&&r._emitAcrossAllDbInstances(r,null,"open",null,null,null),r._emitAcrossAllDbInstances(r,null,"fullsetup",null,null,null)}),r.strategyInstance&&r.strategyInstance.start(),n(e,t,i)}),this.once("connectionError",function(e,t){n(e,t)}),s.connect(this.options.db,o,_connectHandler(this,i,s))},ReplSet.prototype.close=function(e){var t=this;this._serverState=ReplSet.REPLSET_DESTROYED,this._haProcess.stop(),this.strategyInstance&&this.strategyInstance.stop();for(var n in this._state.addresses)this._state.addresses[n].close();this._state=new ReplSetState(this),processor(function(){t._emitAcrossAllDbInstances(t,null,"close",null,null,!0)}),t._flushAllCallHandlers(utils.toError("Connection Closed By Application"));if(typeof e=="function")return e(null,null)};var createServer=function(e,t,n){var r={};if(n.socketOptions){var i=Object.keys(n.socketOptions);for(var s=0;s<i.length;s++)r[i[s]]=n.socketOptions[i[s]]}var o=t.split(/:/);1===o.length&&(o[1]=Connection.DEFAULT_PORT),r.host=o[0],r.port=parseInt(o[1],10);var u={readPreference:n.readPreference,socketOptions:r,poolSize:n.poolSize,logger:n.logger,auto_reconnect:!1,ssl:n.ssl,sslValidate:n.sslValidate,sslCA:n.sslCA,sslCert:n.sslCert,sslKey:n.sslKey,sslPass:n.sslPass},a=new Server(r.host,r.port,u);return a._callBackStore=e._callBackStore,a.replicasetInstance=e,a.enableRecordQueryStats(e.recordQueryStats),a.on("close",_handler("close",e,a)),a.on("error",_handler("error",e,a)),a.on("timeout",_handler("timeout",e,a)),a},_handler=function(e,t,n){return function(e,r){if(t._state.isPrimary(n)){t.emit("left","primary",n);var i=t._state.master;t._state.master=null,t._serverState=ReplSet.REPLSET_READ_ONLY;if(i!=null){var s=i.socketOptions.host,o=i.socketOptions.port;t.__executeAllServerSpecificErrorCallbacks(s,o,e)}}else t._state.isSecondary(n)&&(t.emit("left","secondary",n),delete t._state.secondaries[n.name]);Object.keys(t._state.addresses).length==0&&t._serverState!=ReplSet.REPLSET_DESTROYED&&(t._serverState=ReplSet.REPLSET_DISCONNECTED,t._dbStore.emit("close",new Error("replicaset disconnected, no valid servers contactable over tcp"),null,!0));var s=n.socketOptions.host,o=n.socketOptions.port;t.__executeAllServerSpecificErrorCallbacks(s,o,e)}},locateNewServers=function(e,t,n,r){var i=r.hosts,s=function(e,t){for(var n=0;n<t.length;n++)if(t[n].name==e)return!0;return!1},o=[];if(Array.isArray(i))for(var u=0;u<i.length;u++)!t.contains(i[u])&&!s(i[u],n)&&o.push(createServer(e,i[u],e.options));return o},_connectHandler=function(e,t,n){return function(r,i){r?e._state.errors[n.name]=n:delete e._state.errors[n.name];if(!r){var s=i.documents[0];!s.ismaster&&!s.secondary&&(e._state.errors[n.name]=n)}if(!r&&e._state.errors[n.name]==null){var s=i.documents[0];e.options.rs_name==null&&(e.options.rs_name=s.setName);if(typeof s.setName=="string"&&s.setName!=e.options.rs_name)return e.emit("connectionError",new Error("Replicaset name "+s.setName+" does not match specified name "+e.options.rs_name));n.on("close",_handler("close",e,n)),n.on("error",_handler("error",e,n)),n.on("timeout",_handler("timeout",e,n)),n.name=s.me,n.tags=s.tags,e._state.addServer(n,s);if(t.length==0){var o=locateNewServers(e,e._state,t,s);for(var u=0;u<o.length;u++)e._state.errors[o[u].name]==null&&t.push(o[u])}}if(t.length==0&&!e._state.hasValidServers())return e.emit("connectionError",new Error("No valid replicaset instance servers found"));if(t.length==0)return!e.options.connectWithNoPrimary&&(e._state.master==null||!e._state.master.isConnected())?e.emit("connectionError",new Error("No primary found in set")):e.emit("fullsetup",null,e.options.db,e);var a=t.pop(),f={returnIsMasterResults:!0,eventReceiver:a};a.connect(e.options.db,f,_connectHandler(e,t,a))}};ReplSet.prototype.isDestroyed=function(){return this._serverState==ReplSet.REPLSET_DESTROYED},ReplSet.prototype.isConnected=function(e){var t=!1;if(e==null||e==ReadPreference.PRIMARY||e==0)t=this._state.master!=null&&this._state.master.isConnected();return e!=ReadPreference.PRIMARY_PREFERRED&&e!=ReadPreference.SECONDARY_PREFERRED&&e!=ReadPreference.NEAREST||!(this._state.master!=null&&this._state.master.isConnected()||this._state&&this._state.secondaries&&Object.keys(this._state.secondaries).length>0)?e==ReadPreference.SECONDARY&&(t=this._state&&this._state.secondaries&&Object.keys(this._state.secondaries).length>0):t=!0,t},ReplSet.prototype.isMongos=function(){return!1},ReplSet.prototype.checkoutWriter=function(){return this._state.master?this._state.master.checkoutWriter():new Error("no writer connection available")},ReplSet.prototype.processIsMaster=function(e,t){if(!t.ismaster&&!t.secondary){var n=this._state.addresses[e.name];n&&n.close(),_handler(null,this,n)(new Error("server is in recovery mode"))}},ReplSet.prototype.allRawConnections=function(){var e=[];for(var t in this._state.addresses)e=e.concat(this._state.addresses[t].allRawConnections());return e},ReplSet.prototype.allServerInstances=function(){var e=this;if(!e._state)return[];var t=e._state.master!=null?[e._state.master]:[],n=Object.keys(e._state.secondaries);for(var r=0;r<n.length;r++)t.push(e._state.secondaries[n[r]]);return t},ReplSet.prototype.checkoutReader=function(e,t){var n=null;if(typeof e=="object"&&e["_type"]=="ReadPreference"){if(!e.isValid())throw new Error("Illegal readPreference mode specified, "+e.mode);t=e.tags,e=e.mode}else if(typeof e=="object"&&e["_type"]!="ReadPreference")return new Error("read preferences must be either a string or an instance of ReadPreference");var r=e!=null?e:this.options.readPreference;if(r!=null&&typeof r=="object"&&r["_type"]=="ReadPreference"){if(!r.isValid())throw new Error("Illegal readPreference mode specified, "+r.mode);t=r.tags,e=r.mode}r=r==1?ReadPreference.SECONDARY_PREFERRED:r,r=r==null?ReadPreference.PRIMARY:r;if(r=="primary")return typeof t=="object"&&t!=null?new Error("PRIMARY cannot be combined with tags"):this._state.master==null?new Error("No replica set primary available for query with ReadPreference PRIMARY"):this.checkoutWriter();if((this.options.readSecondary||r==ReadPreference.SECONDARY_PREFERRED||r==ReadPreference.SECONDARY)&&Object.keys(this._state.secondaries).length>0)if(this.strategyInstance!=null){var i=[];for(var s in this._state.secondaries)i.push(this._state.secondaries[s]);if(r==ReadPreference.SECONDARY)n=this.strategyInstance.checkoutConnection(t,i);else{n=this.strategyInstance.checkoutConnection(t,i);if(n==null||n instanceof Error){n=this.checkoutWriter();if(n==null||n instanceof Error)return new Error("No replica set members available for query")}}}else if(t!=null&&typeof t=="object"){n=_pickFromTags(this,t);if(n==null)return new Error("No replica set members available for query")}else n=_roundRobin(this,t);else if(r==ReadPreference.PRIMARY_PREFERRED){n=this.checkoutWriter();if(n==null||n instanceof Error)if(t!=null&&typeof t=="object"){n=_pickFromTags(this,t);if(n==null)return new Error("No replica set members available for query")}else n=_roundRobin(this,t)}else if(r==ReadPreference.SECONDARY_PREFERRED){if(this.strategyInstance!=null){n=this.strategyInstance.checkoutConnection(t);if(n==null||n instanceof Error){n=this.checkoutWriter();if(n==null||n instanceof Error){var o=r==ReadPreference.SECONDARY?"secondary":r;return new Error("No replica set member available for query with ReadPreference "+o+" and tags "+JSON.stringify(t))}}}else if(t!=null&&typeof t=="object"){n=_pickFromTags(this,t);if(n==null){n=this.checkoutWriter();if(n==null||n instanceof Error){var o=r==ReadPreference.SECONDARY?"secondary":r;return new Error("No replica set member available for query with ReadPreference "+o+" and tags "+JSON.stringify(t))}}}}else if(r==ReadPreference.NEAREST&&this.strategyInstance!=null)n=this.strategyInstance.checkoutConnection(t);else{if(r==ReadPreference.NEAREST&&this.strategyInstance==null)return new Error("A strategy for calculating nearness must be enabled such as ping or statistical");if(r==ReadPreference.SECONDARY&&Object.keys(this._state.secondaries).length==0){if(t!=null&&typeof t=="object"){var o=r==ReadPreference.SECONDARY?"secondary":r;return new Error("No replica set member available for query with ReadPreference "+o+" and tags "+JSON.stringify(t))}return new Error("No replica set secondary available for query with ReadPreference SECONDARY")}n=this.checkoutWriter()}return n};var _pickFromTags=function(e,t){var n=Array.isArray(t)?t:[t];for(var r=0;r<n.length;r++){var i=n[r],s=Object.keys(i),o=Object.keys(e._state.secondaries),u=[];for(var a=0;a<o.length;a++){var f=e._state.secondaries[o[a]];if(f.tags!=null){var l=!0;for(var c=0;c<s.length;c++)if(f.tags[s[c]]!=i[s[c]]){l=!1;break}l&&u.push(f)}}if(u.length>0)return e.strategyInstance?e.strategyInstance.checkoutConnection(t,u):u[Math.floor(Math.random()*u.length)].checkoutReader()}return null},pickFirstConnectedSecondary=function(t,n){var r=Object.keys(t._state.secondaries),i;for(var s=0;s<r.length;s++){i=t._state.secondaries[r[s]].checkoutReader();if(i)return i}if(t._readPreference==ReadPreference.SECONDARY_PREFERRED){i=t._state.master.checkoutReader();if(i)return i}var o=t._readPreference==ReadPreference.SECONDARY_PREFERRED?"secondary":t._readPreference;return new Error("No replica set member available for query with ReadPreference "+o+" and tags "+JSON.stringify(n))};Object.defineProperty(ReplSet.prototype,"secondaries",{enumerable:!0,get:function(){return utils.objectToArray(this._state.secondaries)}}),Object.defineProperty(ReplSet.prototype,"arbiters",{enumerable:!0,get:function(){return utils.objectToArray(this._state.arbiters)}});