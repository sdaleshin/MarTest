var ReadPreference=require("./connection/read_preference").ReadPreference,Readable=require("stream").Readable,CommandCursor=require("./command_cursor").CommandCursor,utils=require("./utils"),shared=require("./collection/shared"),inherits=require("util").inherits,AggregationCursor=function(e,t,n){var r=[],i=this,s=null,o={};n=n==null?{}:n,r=Array.isArray(n.pipe)?n.pipe:r,typeof n.batchSize=="number"&&(o.batchSize=n.batchSize);var u=shared._getReadConcern(e,n);Readable.call(this,{objectMode:!0});var a=null,f={readPreference:u},l={aggregate:e.collectionName,pipeline:r,cursor:o};typeof n.allowDiskUsage=="boolean"&&(l.allowDiskUsage=n.allowDiskUsage);var c=new CommandCursor(e.db,e,l);this.explain=function(t){if(typeof t!="function")throw utils.toError("AggregationCursor explain requires a callback function");f.explain=!0,e.aggregate(r,f,function(e,n){if(e)return t(e,null);t(null,n)})},this.get=function(t){if(typeof t!="function")throw utils.toError("AggregationCursor get requires a callback function");var n=e.db.serverConfig.checkoutReader(f.readPreference);if(!n.serverCapabilities.hasAggregationCursor)return e.aggregate(r,f,function(e,n){if(e)return t(e);t(null,n)});c.get({connection:n},t)},this.getOne=function(t){if(typeof t!="function")throw utils.toError("AggregationCursor getOne requires a callback function");r.push({$limit:1}),e.aggregate(r,f,function(e,n){if(e)return t(e);t(null,n[0])})},this.each=function(t){a||(a=e.db.serverConfig.checkoutReader(f.readPreference)),a.serverCapabilities.hasAggregationCursor||e.aggregate(r,f,function(e,n){if(e)return t(e);while(n.length>0)t(null,n.shift());t(null,null)}),c.each({connection:a},t)},this.next=function(t){if(typeof t!="function")throw utils.toError("AggregationCursor next requires a callback function");a||(a=e.db.serverConfig.checkoutReader(f.readPreference));if(!a.serverCapabilities.hasAggregationCursor){if(!s)return e.aggregate(r,f,function(e,n){if(e)return t(e);s=n;var r=s.shift();t(null,r?r:null)});var n=s.shift();return t(null,n?n:null)}c.next({connection:a},t)},this.close=function(t){if(typeof t!="function")throw utils.toError("AggregationCursor close requires a callback function");a||(a=e.db.serverConfig.checkoutReader(f.readPreference));if(!a.serverCapabilities.hasAggregationCursor)return t(null,null);c.close({connection:a},t)},this._read=function(e){i.next(function(e,t){if(e)return i.emit("error",e),i.push(null);i.push(t)})}};Readable!=null&&inherits(AggregationCursor,Readable),exports.AggregationCursor=AggregationCursor;