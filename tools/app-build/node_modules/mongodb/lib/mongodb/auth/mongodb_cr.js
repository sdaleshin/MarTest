var DbCommand=require("../commands/db_command").DbCommand,utils=require("../utils"),authenticate=function(e,t,n,r,i,s){var o=0,u=null;i["connection"]!=null?o=1:(o=e.serverConfig.allRawConnections().length,i.onAll=!0),e._executeQueryCommand(DbCommand.createGetNonceCommand(e),i,function(i,a,f){if(i==null){var l=a.documents[0].nonce;e._executeQueryCommand(DbCommand.createAuthenticationCommand(e,t,n,l,r),{connection:f},function(i,a){o-=1,i?u=i:a&&Array.isArray(a.documents)&&a.documents.length>0&&(a.documents[0].err!=null||a.documents[0].errmsg!=null)&&(u=utils.toError(a.documents[0]));if(o<=0&&typeof s=="function"){var f=s;s=null,u==null&&a&&Array.isArray(a.documents)&&a.documents.length>0&&a.documents[0].ok==1?(e.serverConfig.auth.add("MONGODB-CR",e.databaseName,t,n,r),f(u,!0)):f(u,!1)}})}})};exports.authenticate=authenticate;