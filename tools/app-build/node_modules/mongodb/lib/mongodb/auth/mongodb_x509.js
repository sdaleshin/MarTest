var DbCommand=require("../commands/db_command").DbCommand,utils=require("../utils"),Binary=require("bson").Binary,format=require("util").format,authenticate=function(e,t,n,r,i){var s=0,o=null;r["connection"]!=null?s=1:(s=e.serverConfig.allRawConnections().length,r.onAll=!0);var u={authenticate:1,mechanism:"MONGODB-X509",user:t},a=r["connection"]!=null?[r.connection]:e.serverConfig.allRawConnections();for(var f=0;f<s;f++){var l=a[f];e._executeQueryCommand(DbCommand.createDbCommand(e,u,{},"$external"),{connection:l},function(r,u){s-=1;if(r)o=r;else if(u.documents[0].err!=null||u.documents[0].errmsg!=null)o=utils.toError(u.documents[0]);if(s<=0&&typeof i=="function"){var a=i;i=null,o==null&&u.documents[0].ok==1?(e.serverConfig.auth.add("MONGODB-X509",e.databaseName,t,n),a(o,!0)):a(o,!1)}})}};exports.authenticate=authenticate;