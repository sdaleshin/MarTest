var Long=require("bson").Long,GetMoreCommand=require("./commands/get_more_command").GetMoreCommand,CommandCursor=function(e,t,n,r){r=r||{};var i=Long.fromInt(0),s=Long.fromInt(0),o="init";n.cursor.batchSize=1;var u=n.cursor.batchSize||0,a=r.raw||!1,f=r.readPreference||"primary",l=e.serverConfig.checkoutReader(f),c=r.maxTimeMS,h=null,p=function(n){var r=new GetMoreCommand(e,e.databaseName+"."+t.collectionName,u,i),s={connection:l};e._executeQueryCommand(r,s,function(e,t){if(e)return h=[],o="closed",n(e);n(null,t)})},d=function(e){p(function(t,n){if(t)return h=[],o="closed",e(t,null);h=h.concat(n.documents),i=n.cursorId,typeof i=="number"&&(i=Long.fromNumber(i));if(n.cursorId.equals(s))return e(null,h);d(e)})},v=function(e){p(function(t,n){if(t)return h=[],o="closed",e(t,null);h=n.documents;while(h.length>0)e(null,h.shift());i=n.cursorId,typeof i=="number"&&(i=Long.fromNumber(i));if(n.cursorId.equals(s))return o="closed",e(null,null);v(e)})};this.get=function(t,r){typeof t=="function"&&(r=t,t={}),l=t.connection?t.connection:l;var u={connection:l};typeof c=="number"&&(u.maxTimeMS=c),e.command(n,u,function(e,t){if(e)return o="closed",r(e,null);i=t.cursor.id,typeof i=="number"&&(i=Long.fromNumber(i));if(i.equals(s))return r(null,t.cursor.firstBatch);h=t.cursor.firstBatch,d(r)})},this.each=function(t,r){typeof t=="function"&&(r=t,t={});if(this.isClosed())return r(new Error("cursor is closed"));l=t.connection?t.connection:l;var u={connection:l};typeof c=="number"&&(u.maxTimeMS=c),e.command(n,u,function(e,t){if(e)return o="closed",r(e,null);h=t.cursor.firstBatch;while(h.length>0)r(null,h.shift());i=t.cursor.id,typeof i=="number"&&(i=Long.fromNumber(i));if(i.equals(s))return o="closed",r(null,null);v(r)})},this.next=function(t,r){typeof t=="function"&&(r=t,t={});if(this.isClosed())return r(new Error("cursor is closed"));l=t.connection?t.connection:l;var u={connection:l};typeof c=="number"&&(u.maxTimeMS=c),h?h.length>0?r(null,h.shift()):h.length==0&&i.equals(s)?(o="closed",r(null,null)):p(function(e,t){return e?(o="closed",r(e,null)):(i=t.cursorId,typeof i=="number"&&(i=Long.fromNumber(i)),h=h.concat(t.documents),h.length==0?(o="closed",r(null,null)):r(null,h.shift()))}):e.command(n,u,function(e,t){if(e)return o="closed",r(e,null);i=t.cursor.id,typeof i=="number"&&(i=Long.fromNumber(i)),h=t.cursor.firstBatch,h.length>0?r(null,h.shift()):(o="closed",r(null,null))})},this.isClosed=function(){return o=="closed"},this.maxTimeMS=function(e){c=e},this.close=function(t,n){typeof t=="function"&&(n=t,t={});if(i instanceof Long&&i.greaterThan(Long.fromInt(0)))try{var r=new KillCursorCommand(this.db,[i]);e._executeQueryCommand(r,{connection:l})}catch(s){}l=null,i=Long.fromInt(0),o="closed",h=null,n&&n(null,null)}};exports.CommandCursor=CommandCursor;