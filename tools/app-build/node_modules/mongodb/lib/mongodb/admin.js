/*!
 * Module dependencies.
 */

function Admin(e){if(!(this instanceof Admin))return new Admin(e);this.db=e}var Collection=require("./collection").Collection,Cursor=require("./cursor").Cursor,DbCommand=require("./commands/db_command").DbCommand,utils=require("./utils");Admin.prototype.buildInfo=function(e){this.serverInfo(e)},Admin.prototype.serverInfo=function(e){this.db.executeDbAdminCommand({buildinfo:1},function(t,n){return t!=null?e(t,null):e(null,n.documents[0])})},Admin.prototype.serverStatus=function(e){var t=this;this.db.executeDbAdminCommand({serverStatus:1},function(t,n){if(t!=null||n.documents[0].ok!==1)return t?e(t,!1):e(utils.toError(n.documents[0]),!1);e(null,n.documents[0])})},Admin.prototype.profilingLevel=function(e){var t=this;this.db.executeDbAdminCommand({profile:-1},function(t,n){n=n.documents[0];if(t==null&&n.ok===1){var r=n.was;return r==0?e(null,"off"):r==1?e(null,"slow_only"):r==2?e(null,"all"):e(new Error("Error: illegal profiling level value "+r),null)}t!=null?e(t,null):e(new Error("Error with profile command"),null)})},Admin.prototype.ping=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop(),this.db.executeDbAdminCommand({ping:1},t)},Admin.prototype.authenticate=function(e,t,n){this.db.authenticate(e,t,{authdb:"admin"},function(e,t){return n(e,t)})},Admin.prototype.logout=function(e){this.db.logout({authdb:"admin"},function(t,n){return e(t,n)})},Admin.prototype.addUser=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,2);r=i.pop(),n=i.length?i.shift():{},n.dbName="admin",this.db.addUser(e,t,n,function(e,t){return r(e,t)})},Admin.prototype.removeUser=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,1);n=i.pop(),t=i.length?i.shift():{},t.dbName="admin",this.db.removeUser(e,t,function(e,t){return n(e,t)})},Admin.prototype.setProfilingLevel=function(e,t){var n=this,r={},i=0;if(e=="off")i=0;else if(e=="slow_only")i=1;else{if(e!="all")return t(new Error("Error: illegal profiling level value "+e));i=2}r.profile=i,this.db.executeDbAdminCommand(r,function(n,r){return r=r.documents[0],n==null&&r.ok===1?t(null,e):n!=null?t(n,null):t(new Error("Error with profile command"),null)})},Admin.prototype.profilingInfo=function(e){try{(new Cursor(this.db,new Collection(this.db,DbCommand.SYSTEM_PROFILE_COLLECTION),{},{},{dbName:"admin"})).toArray(function(t,n){return e(t,n)})}catch(t){return e(t,null)}},Admin.prototype.command=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,1);n=i.pop(),t=i.length?i.shift():{},this.db.executeDbAdminCommand(e,t,function(e,t){return n!=null?n(e,t):null})},Admin.prototype.validateCollection=function(e,t,n){var r=Array.prototype.slice.call(arguments,1);n=r.pop(),t=r.length?r.shift():{};var i=this,s={validate:e},o=Object.keys(t);for(var u=0;u<o.length;u++)t.hasOwnProperty(o[u])&&(s[o[u]]=t[o[u]]);this.db.executeDbCommand(s,function(t,r){return t!=null?n(t,null):(r=r.documents[0],r.ok===0?n(new Error("Error with validate command"),null):r.result!=null&&r.result.constructor!=String?n(new Error("Error with validation data"),null):r.result!=null&&r.result.match(/exception|corrupt/)!=null?n(new Error("Error: invalid collection "+e),null):r.valid!=null&&!r.valid?n(new Error("Error: invalid collection "+e),null):n(null,r))})},Admin.prototype.listDatabases=function(e){this.db.executeDbAdminCommand({listDatabases:1},{},function(t,n){return t!=null?e(t,null):e(null,n.documents[0])})},Admin.prototype.replSetGetStatus=function(e){var t=this;this.db.executeDbAdminCommand({replSetGetStatus:1},function(t,n){return t==null&&n.documents[0].ok===1?e(null,n.documents[0]):t?e(t,!1):e(utils.toError(n.documents[0]),!1)})},exports.Admin=Admin;