function assertExpression(e){Function("","return ("+e+")")}function assertNestingCorrect(e){var t=characterParser(e);if(t.isNesting())throw new Error("Nesting must match on expression `"+e+"`")}var utils=require("./utils"),characterParser=require("character-parser"),Lexer=module.exports=function(t){this.input=t.replace(/\r\n|\r/g,"\n"),this.deferredTokens=[],this.lastIndents=0,this.lineno=1,this.stash=[],this.indentStack=[],this.indentRe=null,this.pipeless=!1};Lexer.prototype={tok:function(e,t){return{type:e,line:this.lineno,val:t}},consume:function(e){this.input=this.input.substr(e)},scan:function(e,t){var n;if(n=e.exec(this.input))return this.consume(n[0].length),this.tok(t,n[1])},defer:function(e){this.deferredTokens.push(e)},lookahead:function(e){var t=e-this.stash.length;while(t-->0)this.stash.push(this.next());return this.stash[--e]},bracketExpression:function(e){e=e||0;var t=this.input[e];if(t!="("&&t!="{"&&t!="[")throw new Error("unrecognized start character");var n={"(":")","{":"}","[":"]"}[t],r=characterParser.parseMax(this.input,{start:e+1});if(this.input[r.end]!==n)throw new Error("start character "+t+" does not match end character "+this.input[r.end]);return r},stashed:function(){return this.stash.length&&this.stash.shift()},deferred:function(){return this.deferredTokens.length&&this.deferredTokens.shift()},eos:function(){if(this.input.length)return;return this.indentStack.length?(this.indentStack.shift(),this.tok("outdent")):this.tok("eos")},blank:function(){var e;if(e=/^\n *\n/.exec(this.input))return this.consume(e[0].length-1),++this.lineno,this.pipeless?this.tok("text",""):this.next()},comment:function(){var e;if(e=/^ *\/\/(-)?([^\n]*)/.exec(this.input)){this.consume(e[0].length);var t=this.tok("comment",e[2]);return t.buffer="-"!=e[1],t}},interpolation:function(){if(/^#\{/.test(this.input)){var e;try{e=this.bracketExpression(1)}catch(t){return}return this.consume(e.end+1),this.tok("interpolation",e.src)}},tag:function(){var e;if(e=/^(\w[-:\w]*)(\/?)/.exec(this.input)){this.consume(e[0].length);var t,n=e[1];if(":"==n[n.length-1]){n=n.slice(0,-1),t=this.tok("tag",n),this.defer(this.tok(":"));while(" "==this.input[0])this.input=this.input.substr(1)}else t=this.tok("tag",n);return t.selfClosing=!!e[2],t}},filter:function(){return this.scan(/^:([\w\-]+)/,"filter")},doctype:function(){if(this.scan(/^!!! *([^\n]+)?/,"doctype"))throw new Error("`!!!` is deprecated, you must now use `doctype`");return this.scan(/^(?:doctype) *([^\n]+)?/,"doctype")},id:function(){return this.scan(/^#([\w-]+)/,"id")},className:function(){return this.scan(/^\.([\w-]+)/,"class")},text:function(){return/^([^\.\<][^\n]+)/.test(this.input)&&!/^(?:\| ?| )([^\n]+)/.test(this.input)&&console.warn("Warning: missing space before text for line "+this.lineno+" of jade file."),this.scan(/^(?:\| ?| )([^\n]+)/,"text")||this.scan(/^([^\.][^\n]+)/,"text")},dot:function(){return this.scan(/^\./,"dot")},"extends":function(){return this.scan(/^extends? +([^\n]+)/,"extends")},prepend:function(){var e;if(e=/^prepend +([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t="prepend",n=e[1],r=this.tok("block",n);return r.mode=t,r}},append:function(){var e;if(e=/^append +([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t="append",n=e[1],r=this.tok("block",n);return r.mode=t,r}},block:function(){var e;if(e=/^block\b *(?:(prepend|append) +)?([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=e[1]||"replace",n=e[2],r=this.tok("block",n);return r.mode=t,r}},mixinBlock:function(){var e;if(e=/^block\s*\n/.exec(this.input))return this.consume(e[0].length-1),this.tok("mixin-block")},yield:function(){return this.scan(/^yield */,"yield")},include:function(){return this.scan(/^include +([^\n]+)/,"include")},includeFiltered:function(){var e;if(e=/^include:([\w\-]+) +([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=e[1],n=e[2],r=this.tok("include",n);return r.filter=t,r}},"case":function(){return this.scan(/^case +([^\n]+)/,"case")},when:function(){return this.scan(/^when +([^:\n]+)/,"when")},"default":function(){return this.scan(/^default */,"default")},call:function(){var e,t;if(t=/^\+(([-\w]+)|(#\{))/.exec(this.input)){if(t[2])this.consume(t[0].length),e=this.tok("call",t[2]);else{var n;try{n=this.bracketExpression(2)}catch(r){return}this.consume(n.end+1),assertExpression(n.src),e=this.tok("call","#{"+n.src+"}")}if(t=/^ *\(/.exec(this.input))try{var i=this.bracketExpression(t[0].length-1);/^ *[-\w]+ *=/.test(i.src)||(this.consume(i.end+1),e.args=i.src)}catch(r){}return e}},mixin:function(){var e;if(e=/^mixin +([-\w]+)(?: *\((.*)\))? */.exec(this.input)){this.consume(e[0].length);var t=this.tok("mixin",e[1]);return t.args=e[2],t}},conditional:function(){var e;if(e=/^(if|unless|else if|else)\b([^\n]*)/.exec(this.input)){this.consume(e[0].length);var t=e[1],n=e[2];switch(t){case"if":assertExpression(n),n="if ("+n+")";break;case"unless":assertExpression(n),n="if (!("+n+"))";break;case"else if":assertExpression(n),n="else if ("+n+")";break;case"else":if(n&&n.trim())throw new Error("`else` cannot have a condition, perhaps you meant `else if`");n="else"}return this.tok("code",n)}},"while":function(){var e;if(e=/^while +([^\n]+)/.exec(this.input))return this.consume(e[0].length),assertExpression(e[1]),this.tok("code","while ("+e[1]+")")},each:function(){var e;if(e=/^(?:- *)?(?:each|for) +([a-zA-Z_$][\w$]*)(?: *, *([a-zA-Z_$][\w$]*))? * in *([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=this.tok("each",e[1]);return t.key=e[2]||"$index",assertExpression(e[3]),t.code=e[3],t}},code:function(){var e;if(e=/^(!?=|-)[ \t]*([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=e[1];e[1]=e[2];var n=this.tok("code",e[1]);return n.escape=t.charAt(0)==="=",n.buffer=t.charAt(0)==="="||t.charAt(1)==="=",n.buffer&&assertExpression(e[1]),n}},attrs:function(){if("("==this.input.charAt(0)){var e=this.bracketExpression().end,t=this.input.substr(1,e-1),n=this.tok("attrs");assertNestingCorrect(t);var r="",i=function(e){return e.replace(/(\\)?#\{(.+)/g,function(e,t,n){if(t)return e;try{var s=characterParser.parseMax(n);return n[s.end]!=="}"?e.substr(0,2)+i(e.substr(2)):(assertExpression(s.src),r+" + ("+s.src+") + "+r+i(n.substr(s.end+1)))}catch(o){return e.substr(0,2)+i(e.substr(2))}})};this.consume(e+1),n.attrs={},n.escaped={};var s=!0,o="",u="",a="",f=characterParser.defaultState(),l="key",c=function(e){if(o.trim()==="")return!1;if(e===t.length)return!0;if(l==="key"){if(t[e]===" "||t[e]==="\n")for(var n=e;n<t.length;n++)if(t[n]!=" "&&t[n]!="\n")return t[n]==="="||t[n]==="!"||t[n]===","?!1:!0;return t[e]===","}if(l==="value"&&!f.isNesting())try{Function("","return ("+u+");");if(t[e]===" "||t[e]==="\n")for(var n=e;n<t.length;n++)if(t[n]!=" "&&t[n]!="\n")return characterParser.isPunctuator(t[n])&&t[n]!='"'&&t[n]!="'"?!1:!0;return t[e]===","}catch(r){return!1}};for(var h=0;h<=t.length;h++)if(c(h))u=u.trim(),u&&assertExpression(u),o=o.trim(),o=o.replace(/^['"]|['"]$/g,""),n.escaped[o]=s,n.attrs[o]=""==u?!0:u,o=u="",l="key",s=!1;else switch(l){case"key-char":if(t[h]===r){l="key";if(h+1<t.length&&[" ",",","!","=","\n"].indexOf(t[h+1])===-1)throw new Error("Unexpected character "+t[h+1]+" expected ` `, `\\n`, `,`, `!` or `=`")}else l==="key-char"&&(o+=t[h]);break;case"key":if(o!==""||t[h]!=='"'&&t[h]!=="'")if(t[h]==="!"||t[h]==="="){s=t[h]!=="!",t[h]==="!"&&h++;if(t[h]!=="=")throw new Error("Unexpected character "+t[h]+" expected `=`");l="value",f=characterParser.defaultState()}else o+=t[h];else l="key-char",r=t[h];break;case"value":f=characterParser.parseChar(t[h],f),f.isString()?(l="string",r=t[h],a=t[h]):u+=t[h];break;case"string":f=characterParser.parseChar(t[h],f),a+=t[h],f.isString()||(l="value",u+=i(a))}return"/"==this.input.charAt(0)&&(this.consume(1),n.selfClosing=!0),n}},attributesBlock:function(){var e;if(/^&attributes\b/.test(this.input)){this.consume(11);var t=this.bracketExpression();return this.consume(t.end+1),this.tok("&attributes",t.src)}},indent:function(){var e,t;this.indentRe?e=this.indentRe.exec(this.input):(t=/^\n(\t*) */,e=t.exec(this.input),e&&!e[1].length&&(t=/^\n( *)/,e=t.exec(this.input)),e&&e[1].length&&(this.indentRe=t));if(e){var n,r=e[1].length;++this.lineno,this.consume(r+1);if(" "==this.input[0]||"	"==this.input[0])throw new Error("Invalid indentation, you can use tabs or spaces but not both");if("\n"==this.input[0])return this.tok("newline");if(this.indentStack.length&&r<this.indentStack[0]){while(this.indentStack.length&&this.indentStack[0]>r)this.stash.push(this.tok("outdent")),this.indentStack.shift();n=this.stash.pop()}else r&&r!=this.indentStack[0]?(this.indentStack.unshift(r),n=this.tok("indent",r)):n=this.tok("newline");return n}},pipelessText:function(){if(this.pipeless){if("\n"==this.input[0])return;var e=this.input.indexOf("\n");-1==e&&(e=this.input.length);var t=this.input.substr(0,e);return this.consume(t.length),this.tok("text",t)}},colon:function(){return this.scan(/^: */,":")},fail:function(){throw new Error("unexpected text "+this.input.substr(0,5))},advance:function(){return this.stashed()||this.next()},next:function(){return this.deferred()||this.blank()||this.eos()||this.pipelessText()||this.yield()||this.doctype()||this.interpolation()||this["case"]()||this.when()||this["default"]()||this["extends"]()||this.append()||this.prepend()||this.block()||this.mixinBlock()||this.include()||this.includeFiltered()||this.mixin()||this.call()||this.conditional()||this.each()||this["while"]()||this.tag()||this.filter()||this.code()||this.id()||this.className()||this.attrs()||this.attributesBlock()||this.indent()||this.comment()||this.colon()||this.text()||this.dot()||this.fail()}};