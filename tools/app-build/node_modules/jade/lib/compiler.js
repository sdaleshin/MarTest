var nodes=require("./nodes"),filters=require("./filters"),doctypes=require("./doctypes"),selfClosing=require("./self-closing"),runtime=require("./runtime"),utils=require("./utils"),parseJSExpression=require("character-parser").parseMax,isConstant=require("constantinople"),toConstant=require("constantinople").toConstant,Compiler=module.exports=function(t,n){this.options=n=n||{},this.node=t,this.hasCompiledDoctype=!1,this.hasCompiledTag=!1,this.pp=n.pretty||!1,this.debug=!1!==n.compileDebug,this.inMixin=!1,this.indents=0,this.parentIndents=0,this.terse=!1,n.doctype&&this.setDoctype(n.doctype)};Compiler.prototype={compile:function(){return this.buf=[],this.pp&&this.buf.push("jade.indent = [];"),this.lastBufferedIdx=-1,this.visit(this.node),this.buf.join("\n")},setDoctype:function(e){e=e||"default";if(e.toLowerCase()==="5")throw new Error("`doctype 5` is deprecated, you must now use `doctype html`");this.doctype=doctypes[e.toLowerCase()]||"<!DOCTYPE "+e+">",this.terse=this.doctype.toLowerCase()=="<!doctype html>",this.xml=0==this.doctype.indexOf("<?xml")},buffer:function(e,t){var n=this;if(t){var r=/(\\)?([#!]){((?:.|\n)*)$/.exec(e);if(r){this.buffer(e.substr(0,r.index),!1);if(r[1]){this.buffer(r[2]+"{",!1),this.buffer(r[3],!0);return}try{var i=r[3],s=parseJSExpression(i),o=("!"==r[2]?"":"jade.escape")+"((jade.interp = "+s.src+") == null ? '' : jade.interp)"}catch(u){throw u}this.bufferExpression(o),this.buffer(i.substr(s.end+1),!0);return}}e=JSON.stringify(e),e=e.substr(1,e.length-2),this.lastBufferedIdx==this.buf.length?(this.lastBufferedType==="code"&&(this.lastBuffered+=' + "'),this.lastBufferedType="text",this.lastBuffered+=e,this.buf[this.lastBufferedIdx-1]="buf.push("+this.bufferStartChar+this.lastBuffered+'");'):(this.buf.push('buf.push("'+e+'");'),this.lastBufferedType="text",this.bufferStartChar='"',this.lastBuffered=e,this.lastBufferedIdx=this.buf.length)},bufferExpression:function(e){var t=Function("","return ("+e+");");if(isConstant(e))return this.buffer(t(),!1);this.lastBufferedIdx==this.buf.length?(this.lastBufferedType==="text"&&(this.lastBuffered+='"'),this.lastBufferedType="code",this.lastBuffered+=" + ("+e+")",this.buf[this.lastBufferedIdx-1]="buf.push("+this.bufferStartChar+this.lastBuffered+");"):(this.buf.push("buf.push("+e+");"),this.lastBufferedType="code",this.bufferStartChar="",this.lastBuffered="("+e+")",this.lastBufferedIdx=this.buf.length)},prettyIndent:function(e,t){e=e||0,t=t?"\n":"",this.buffer(t+Array(this.indents+e).join("  ")),this.parentIndents&&this.buf.push("buf.push.apply(buf, jade.indent);")},visit:function(e){var t=this.debug;t&&this.buf.push("jade_debug.unshift({ lineno: "+e.line+", filename: "+(e.filename?JSON.stringify(e.filename):"jade_debug[0].filename")+" });"),!1===e.debug&&this.debug&&(this.buf.pop(),this.buf.pop()),this.visitNode(e),t&&this.buf.push("jade_debug.shift();")},visitNode:function(e){return this["visit"+e.type](e)},visitCase:function(e){var t=this.withinCase;this.withinCase=!0,this.buf.push("switch ("+e.expr+"){"),this.visit(e.block),this.buf.push("}"),this.withinCase=t},visitWhen:function(e){"default"==e.expr?this.buf.push("default:"):this.buf.push("case "+e.expr+":"),this.visit(e.block),this.buf.push("  break;")},visitLiteral:function(e){this.buffer(e.str)},visitBlock:function(e){var t=e.nodes.length,n=this.escape,r=this.pp;r&&t>1&&!n&&e.nodes[0].isText&&e.nodes[1].isText&&this.prettyIndent(1,!0);for(var i=0;i<t;++i)r&&i>0&&!n&&e.nodes[i].isText&&e.nodes[i-1].isText&&this.prettyIndent(1,!1),this.visit(e.nodes[i]),e.nodes[i+1]&&e.nodes[i].isText&&e.nodes[i+1].isText&&this.buffer("\n")},visitMixinBlock:function(e){if(!this.inMixin)throw new Error("Anonymous blocks are not allowed unless they are part of a mixin.");this.pp&&this.buf.push("jade.indent.push('"+Array(this.indents+1).join("  ")+"');"),this.buf.push("block && block();"),this.pp&&this.buf.push("jade.indent.pop();")},visitDoctype:function(e){e&&(e.val||!this.doctype)&&this.setDoctype(e.val||"default"),this.doctype&&this.buffer(this.doctype),this.hasCompiledDoctype=!0},visitMixin:function(e){var t="jade_mixins[",n=e.args||"",r=e.block,i=e.attrs,s=e.attributeBlocks,o=this.pp;t+=(e.name[0]=="#"?e.name.substr(2,e.name.length-3):'"'+e.name+'"')+"]";if(e.call){o&&this.buf.push("jade.indent.push('"+Array(this.indents+1).join("  ")+"');");if(r||i.length){this.buf.push(t+".call({");if(r){this.buf.push("block: function(){"),this.parentIndents++;var u=this.indents;this.indents=0,this.visit(e.block),this.indents=u,this.parentIndents--,i.length?this.buf.push("},"):this.buf.push("}")}if(s.length){if(i.length){var a=this.attrs(i);s.unshift(a)}this.buf.push("attributes: jade.merge(["+s.join(",")+"])")}else if(i.length){var a=this.attrs(i);this.buf.push("attributes: "+a)}n?this.buf.push("}, "+n+");"):this.buf.push("});")}else this.buf.push(t+"("+n+");");o&&this.buf.push("jade.indent.pop();")}else this.buf.push(t+" = function("+n+"){"),this.buf.push("var block = (this && this.block), attributes = (this && this.attributes) || {};"),this.parentIndents++,this.inMixin=!0,this.visit(r),this.inMixin=!1,this.parentIndents--,this.buf.push("};")},visitTag:function(e){function i(){e.buffer?r.bufferExpression(t):r.buffer(t)}this.indents++;var t=e.name,n=this.pp,r=this;"pre"==e.name&&(this.escape=!0),this.hasCompiledTag||(!this.hasCompiledDoctype&&"html"==t&&this.visitDoctype(),this.hasCompiledTag=!0),n&&!e.isInline()&&this.prettyIndent(0,!0);if((~selfClosing.indexOf(t)||e.selfClosing)&&!this.xml){this.buffer("<"),i(),this.visitAttributes(e.attrs,e.attributeBlocks),this.terse?this.buffer(">"):this.buffer("/>");if(e.block&&(e.block.type!=="Block"||e.block.nodes.length!==0))throw new Error(t+" is self closing and should not have content.")}else this.buffer("<"),i(),this.visitAttributes(e.attrs,e.attributeBlocks),this.buffer(">"),e.code&&this.visitCode(e.code),this.visit(e.block),n&&!e.isInline()&&"pre"!=e.name&&!e.canInline()&&this.prettyIndent(0,!0),this.buffer("</"),i(),this.buffer(">");"pre"==e.name&&(this.escape=!1),this.indents--},visitFilter:function(e){var t=e.block.nodes.map(function(e){return e.val}).join("\n");e.attrs=e.attrs||{},e.attrs.filename=this.options.filename,this.buffer(filters(e.name,t,e.attrs),!0)},visitText:function(e){this.buffer(e.val,!0)},visitComment:function(e){if(!e.buffer)return;this.pp&&this.prettyIndent(1,!0),this.buffer("<!--"+e.val+"-->")},visitBlockComment:function(e){if(!e.buffer)return;this.pp&&this.prettyIndent(1,!0),this.buffer("<!--"+e.val),this.visit(e.block),this.pp&&this.prettyIndent(1,!0),this.buffer("-->")},visitCode:function(e){if(e.buffer){var t=e.val.trimLeft();t="null == (jade.interp = "+t+') ? "" : jade.interp',e.escape&&(t="jade.escape("+t+")"),this.bufferExpression(t)}else this.buf.push(e.val);e.block&&(e.buffer||this.buf.push("{"),this.visit(e.block),e.buffer||this.buf.push("}"))},visitEach:function(e){this.buf.push("// iterate "+e.obj+"\n"+";(function(){\n"+"  var $$obj = "+e.obj+";\n"+"  if ('number' == typeof $$obj.length) {\n"),e.alternative&&this.buf.push("  if ($$obj.length) {"),this.buf.push("    for (var "+e.key+" = 0, $$l = $$obj.length; "+e.key+" < $$l; "+e.key+"++) {\n"+"      var "+e.val+" = $$obj["+e.key+"];\n"),this.visit(e.block),this.buf.push("    }\n"),e.alternative&&(this.buf.push("  } else {"),this.visit(e.alternative),this.buf.push("  }")),this.buf.push("  } else {\n    var $$l = 0;\n    for (var "+e.key+" in $$obj) {\n"+"      $$l++;"+"      var "+e.val+" = $$obj["+e.key+"];\n"),this.visit(e.block),this.buf.push("    }\n"),e.alternative&&(this.buf.push("    if ($$l === 0) {"),this.visit(e.alternative),this.buf.push("    }")),this.buf.push("  }\n}).call(this);\n")},visitAttributes:function(e,t){if(t.length){if(e.length){var n=this.attrs(e);t.unshift(n)}this.bufferExpression("jade.attrs(jade.merge(["+t.join(",")+"]), "+JSON.stringify(this.terse)+")")}else e.length&&this.attrs(e,!0)},attrs:function(e,t){var n=[],r=[],i=[],s=[];return e.forEach(function(e){var o=e.name,u=e.escaped;if(o!=="class"&&s.indexOf(o)!==-1)throw new Error('Duplicate key "'+o+'" is not allowed.');s.push(o);if(o==="class")r.push(e.val),i.push(e.escaped);else if(isConstant(e.val))if(t)this.buffer(runtime.attr(o,toConstant(e.val),u,this.terse));else{var a=toConstant(e.val);u&&(o.indexOf("data")!==0||typeof a=="string")&&(a=runtime.escape(a)),n.push(JSON.stringify(o)+": "+JSON.stringify(a))}else if(t)this.bufferExpression('jade.attr("'+o+'", '+e.val+", "+JSON.stringify(u)+", "+JSON.stringify(this.terse)+")");else{var a=JSON.stringify(e.val);u&&o.indexOf("data")!==0?a="jade.escape("+a+")":u&&(a="(typeof (jade.interp = "+a+') == "string" ? jade.escape(jade.interp) : jade.interp)"'),n.push(JSON.stringify(o)+": "+a)}}.bind(this)),t?r.every(isConstant)?this.buffer(runtime.cls(r.map(toConstant),i)):this.bufferExpression("jade.cls(["+r.join(",")+"], "+JSON.stringify(i)+")"):(r.every(isConstant)?r=JSON.stringify(runtime.joinClasses(r.map(toConstant).map(runtime.joinClasses).map(function(e,t){return i[t]?runtime.escape(e):e}))):r.length&&(r="(jade.interp = "+JSON.stringify(i)+","+" jade.joinClasses(["+r.join(",")+"].map(jade.joinClasses).map(function (cls, i) {"+"   return jade.interp[i] ? jade.escape(cls) : cls"+" }))"+")"),r.length&&n.push('"class": '+r)),"{"+n.join(",")+"}"}};