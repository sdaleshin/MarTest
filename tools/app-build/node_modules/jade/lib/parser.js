var Lexer=require("./lexer"),nodes=require("./nodes"),utils=require("./utils"),filters=require("./filters"),path=require("path"),parseJSExpression=require("character-parser").parseMax,extname=path.extname,Parser=exports=module.exports=function(t,n,r){this.input=t.replace(/^\uFEFF/,""),this.lexer=new Lexer(this.input),this.filename=n,this.blocks={},this.mixins={},this.options=r,this.contexts=[this]};Parser.prototype={constructor:Parser,context:function(e){if(!e)return this.contexts.pop();this.contexts.push(e)},advance:function(){return this.lexer.advance()},skip:function(e){while(e--)this.advance()},peek:function(){return this.lookahead(1)},line:function(){return this.lexer.lineno},lookahead:function(e){return this.lexer.lookahead(e)},parse:function(){var e=new nodes.Block,t;e.line=0,e.filename=this.filename;while("eos"!=this.peek().type)if("newline"==this.peek().type)this.advance();else{var n=this.peek(),r=this.parseExpr();r.filename=this.options.filename,r.line=n.line,e.push(r)}if(t=this.extending){this.context(t);var i=t.parse();this.context();for(var s in this.mixins)i.unshift(this.mixins[s]);return i}return e},expect:function(e){if(this.peek().type===e)return this.advance();throw new Error('expected "'+e+'", but got "'+this.peek().type+'"')},accept:function(e){if(this.peek().type===e)return this.advance()},parseExpr:function(){switch(this.peek().type){case"tag":return this.parseTag();case"mixin":return this.parseMixin();case"block":return this.parseBlock();case"mixin-block":return this.parseMixinBlock();case"case":return this.parseCase();case"when":return this.parseWhen();case"default":return this.parseDefault();case"extends":return this.parseExtends();case"include":return this.parseInclude();case"doctype":return this.parseDoctype();case"filter":return this.parseFilter();case"comment":return this.parseComment();case"text":return this.parseText();case"each":return this.parseEach();case"code":return this.parseCode();case"call":return this.parseCall();case"interpolation":return this.parseInterpolation();case"yield":this.advance();var e=new nodes.Block;return e.yield=!0,e;case"id":case"class":var t=this.advance();return this.lexer.defer(this.lexer.tok("tag","div")),this.lexer.defer(t),this.parseExpr();default:throw new Error('unexpected token "'+this.peek().type+'"')}},parseText:function(){var e=this.expect("text"),t=this.parseTextWithInlineTags(e.val);if(t.length===1)return t[0];var n=new nodes.Block;for(var r=0;r<t.length;r++)n.push(t[r]);return n},parseBlockExpansion:function(){return":"==this.peek().type?(this.advance(),new nodes.Block(this.parseExpr())):this.block()},parseCase:function(){var e=this.expect("case").val,t=new nodes.Case(e);return t.line=this.line(),t.block=this.block(),t},parseWhen:function(){var e=this.expect("when").val;return new nodes.Case.When(e,this.parseBlockExpansion())},parseDefault:function(){return this.expect("default"),new nodes.Case.When("default",this.parseBlockExpansion())},parseCode:function(){var e=this.expect("code"),t=new nodes.Code(e.val,e.buffer,e.escape),n,r=1;t.line=this.line();while(this.lookahead(r)&&"newline"==this.lookahead(r).type)++r;return n="indent"==this.lookahead(r).type,n&&(this.skip(r-1),t.block=this.block()),t},parseComment:function(){var e=this.expect("comment"),t;return"indent"==this.peek().type?(this.lexer.pipeless=!0,t=new nodes.BlockComment(e.val,this.parseTextBlock(),e.buffer),this.lexer.pipeless=!1):t=new nodes.Comment(e.val,e.buffer),t.line=this.line(),t},parseDoctype:function(){var e=this.expect("doctype"),t=new nodes.Doctype(e.val);return t.line=this.line(),t},parseFilter:function(){var e=this.expect("filter"),t=this.accept("attrs"),n;"indent"==this.peek().type?(this.lexer.pipeless=!0,n=this.parseTextBlock(),this.lexer.pipeless=!1):n=new nodes.Block;var r=new nodes.Filter(e.val,n,t&&t.attrs);return r.line=this.line(),r},parseEach:function(){var e=this.expect("each"),t=new nodes.Each(e.code,e.val,e.key);return t.line=this.line(),t.block=this.block(),this.peek().type=="code"&&this.peek().val=="else"&&(this.advance(),t.alternative=this.block()),t},resolvePath:function(e,t){var n=require("path"),r=n.dirname,i=n.basename,s=n.join;if(e[0]!=="/"&&!this.filename)throw new Error('the "filename" option is required to use "'+t+'" with "relative" paths');if(e[0]==="/"&&!this.options.basedir)throw new Error('the "basedir" option is required to use "'+t+'" with "absolute" paths');return e=s(e[0]==="/"?this.options.basedir:r(this.filename),e),i(e).indexOf(".")===-1&&(e+=".jade"),e},parseExtends:function(){var e=require("fs"),t=this.resolvePath(this.expect("extends").val.trim(),"extends");".jade"!=t.substr(-5)&&(t+=".jade");var n=e.readFileSync(t,"utf8"),r=new this.constructor(n,t,this.options);return r.blocks=this.blocks,r.contexts=this.contexts,this.extending=r,new nodes.Literal("")},parseBlock:function(){var e=this.expect("block"),t=e.mode,n=e.val.trim();e="indent"==this.peek().type?this.block():new nodes.Block(new nodes.Literal(""));var r=this.blocks[n]||{prepended:[],appended:[]};if(r.mode==="replace")return this.blocks[n]=r;var i=r.prepended.concat(e.nodes).concat(r.appended);switch(t){case"append":r.appended=r.parser===this?r.appended.concat(e.nodes):e.nodes.concat(r.appended);break;case"prepend":r.prepended=r.parser===this?e.nodes.concat(r.prepended):r.prepended.concat(e.nodes)}return e.nodes=i,e.appended=r.appended,e.prepended=r.prepended,e.mode=t,e.parser=this,this.blocks[n]=e},parseMixinBlock:function(){var e=this.expect("mixin-block");return new nodes.MixinBlock},parseInclude:function(){var e=require("fs"),t=this.expect("include"),n=this.resolvePath(t.val.trim(),"include");if(t.filter){var r=e.readFileSync(n,"utf8").replace(/\r/g,"");return r=filters(t.filter,r,{filename:n}),new nodes.Literal(r)}if(".jade"!=n.substr(-5)){var r=e.readFileSync(n,"utf8").replace(/\r/g,"");return new nodes.Literal(r)}var r=e.readFileSync(n,"utf8"),i=new this.constructor(r,n,this.options);i.blocks=utils.merge({},this.blocks),i.mixins=this.mixins,this.context(i);var s=i.parse();return this.context(),s.filename=n,"indent"==this.peek().type&&s.includeBlock().push(this.block()),s},parseCall:function(){var e=this.expect("call"),t=e.val,n=e.args,r=new nodes.Mixin(t,n,new nodes.Block,!0);return this.tag(r),r.code&&(r.block.push(r.code),r.code=null),r.block.isEmpty()&&(r.block=null),r},parseMixin:function(){var e=this.expect("mixin"),t=e.val,n=e.args,r;return"indent"==this.peek().type?(r=new nodes.Mixin(t,n,this.block(),!1),this.mixins[t]=r,r):new nodes.Mixin(t,n,null,!0)},parseTextWithInlineTags:function(e){var t=this.line(),n=/(\\)?#\[((?:.|\n)*)$/.exec(e);if(n){if(n[1]){var r=new nodes.Text(e.substr(0,n.index)+"#[");r.line=t;var i=this.parseTextWithInlineTags(n[2]);return i[0].type==="Text"&&(r.val+=i[0].val,i.shift()),[r].concat(i)}var r=new nodes.Text(e.substr(0,n.index));r.line=t;var s=[r],i=n[2],o=parseJSExpression(i),u=new Parser(o.src,this.filename,this.options);return s.push(u.parse()),s.concat(this.parseTextWithInlineTags(i.substr(o.end+1)))}var r=new nodes.Text(e);return r.line=t,[r]},parseTextBlock:function(){var e=new nodes.Block;e.line=this.line();var t=this.expect("indent").val;null==this._spaces&&(this._spaces=t);var n=Array(t-this._spaces+1).join(" ");while("outdent"!=this.peek().type)switch(this.peek().type){case"newline":this.advance();break;case"indent":this.parseTextBlock(!0).nodes.forEach(function(t){e.push(t)});break;default:var r=this.parseTextWithInlineTags(n+this.advance().val);r.forEach(function(t){e.push(t)})}return t==this._spaces&&(this._spaces=null),this.expect("outdent"),e},block:function(){var e=new nodes.Block;e.line=this.line(),e.filename=this.filename,this.expect("indent");while("outdent"!=this.peek().type)if("newline"==this.peek().type)this.advance();else{var t=this.parseExpr();t.filename=this.filename,e.push(t)}return this.expect("outdent"),e},parseInterpolation:function(){var e=this.advance(),t=new nodes.Tag(e.val);return t.buffer=!0,this.tag(t)},parseTag:function(){var e=2;"attrs"==this.lookahead(e).type&&++e;var t=this.advance(),n=new nodes.Tag(t.val);return n.selfClosing=t.selfClosing,this.tag(n)},tag:function(e){e.line=this.line();var t=!1;e:for(;;)switch(this.peek().type){case"id":case"class":var n=this.advance();e.setAttribute(n.type,"'"+n.val+"'");continue;case"attrs":t&&console.warn("You should not have jade tags with multiple attributes."),t=!0;var n=this.advance(),r=n.attrs,i=n.escaped,s=Object.keys(r);n.selfClosing&&(e.selfClosing=!0);for(var o=0,u=s.length;o<u;++o){var a=s[o],f=r[a];e.setAttribute(a,f,i[a])}continue;case"&attributes":var n=this.advance();e.addAttributes(n.val);break;default:break e}"dot"==this.peek().type&&(e.textOnly=!0,this.advance());switch(this.peek().type){case"text":e.block.push(this.parseText());break;case"code":e.code=this.parseCode();break;case":":this.advance(),e.block=new nodes.Block,e.block.push(this.parseExpr());break;case"newline":case"indent":case"outdent":case"eos":break;default:throw new Error("Unexpected token `"+this.peek().type+"` expected `text`, `code`, `:`, `newline` or `eos`")}while("newline"==this.peek().type)this.advance();if("indent"==this.peek().type)if(e.textOnly)this.lexer.pipeless=!0,e.block=this.parseTextBlock(),this.lexer.pipeless=!1;else{var l=this.block();if(e.block)for(var o=0,u=l.nodes.length;o<u;++o)e.block.push(l.nodes[o]);else e.block=l}return e}};