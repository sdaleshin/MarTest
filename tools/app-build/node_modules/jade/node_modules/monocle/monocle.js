var path=require("path"),fs=require("fs"),readdirp=require("readdirp"),is_windows=process.platform==="win32";module.exports=function(){function i(e){readdirp({root:e.root,fileFilter:e.fileFilter,directoryFilter:e.directoryFilter},function(t,n){n.files.forEach(function(t){f(t,e.listener,e.partial)}),typeof e.complete=="function"&&e.complete()}),!e.partial&&(r=setInterval(function(){u(e)},n))}function s(e){e.files.forEach(function(t){var n={fullPath:fs.realpathSync(t),name:fs.realpathSync(t).split("/").pop()};n.fullParentDir=n.fullPath.split("/").slice(0,n.fullPath.split("/").length-1).join("/"),f(n,e.listener)}),typeof e.complete=="function"&&e.complete()}function o(){is_windows?Object.keys(e).forEach(function(t){e[t].close()}):Object.keys(e).forEach(function(e){fs.unwatchFile(e)}),clearInterval(r),e={},t={}}function u(e){Object.keys(t).forEach(function(n){var r=t[n];fs.stat(n,function(s,o){var u=r;s||(u=(new Date(o.mtime)).getTime()),u!=r&&(t[n]=u,i({root:n,listener:e.listener,fileFilter:e.fileFilter,directoryFilter:e.directoryFilter,partial:!0}))})})}function a(e){return e.absolutePath=path.resolve(process.cwd(),e.fullPath),e.absolutePath}function f(t,n,r){a(t),l(t),e[t.fullPath]||(is_windows?function(){e[t.fullPath]=fs.watch(t.fullPath,function(){typeof n=="function"&&n(t)}),r&&n(t)}(t,n):function(t,n){e[t.fullPath]=!0,fs.watchFile(t.fullPath,{interval:150},function(){typeof n=="function"&&n(t)}),r&&n(t)}(t,n))}function l(e){var n=e.fullParentDir;t[n]||fs.stat(n,function(e,r){e?t[n]=(new Date).getTime():t[n]=(new Date(r.mtime)).getTime()})}function c(e){e=Array.isArray(e)?e:[e];var t={directories:[],files:[]};return e.forEach(function(e){fs.statSync(e).isDirectory()?t.directories.push(e):t.files.push(e)}),t}function h(e,t){var n={};return Object.keys(e).forEach(function(t){n[t]=e[t]}),Object.keys(t).forEach(function(e){n[e]=t[e]}),n}function p(e){var t=c(e.path);t.directories.length&&t.directories.forEach(function(t){i(h(e,{root:t}))}),t.files.length&&s(h(e,{files:t.files}))}var e={},t={},n=1e3,r=undefined;return{watchDirectory:i,watchFiles:s,watchPaths:p,unwatchAll:o}};