function Transformer(e){this.name=e.name,this.engines=e.engines,this.isBinary=e.isBinary||!1,this.isMinifier=e.isMinifier||!1,this.outputFormat=e.outputFormat,this._cache={},typeof e.async=="function"&&(this._renderAsync=e.async,this.sudoSync=e.sudoSync||!1),typeof e.sync=="function"?(this._renderSync=e.sync,this.sync=!0):this.sync=e.sudoSync||!1;if(this.isMinifier)minifiers[this.outputFormat]=this;else{var t=minifiers[this.outputFormat];t&&(this.minify=function(e,n){return n&&n.minify?t.renderSync(e,typeof n.minify=="object"&&n.minify||{}):e})}}function fixString(e){return e==null?e:(e=e.toString(),e=65279==e.charCodeAt(0)?e.substring(1):e,e.replace(/\r/g,""))}function clone(e){if(Array.isArray(e))return e.map(clone);if(e&&typeof e=="object"){var t={};for(var n in e)t[n]=clone(e[n]);return t}return e}var Promise=require("promise"),fs=require("fs"),path=require("path"),normalize=path.normalize;Promise.prototype.nodeify=function(e){return typeof e=="function"?(this.then(function(t){process.nextTick(function(){e(null,t)})},function(t){process.nextTick(function(){e(t)})}),undefined):this};var minifiers={};module.exports=Transformer,Transformer.prototype.cache=function(e,t){return e.cache&&e.filename?t?this.cache[e.filename]=t:this.cache[e.filename]:t},Transformer.prototype.loadModule=function(){if(this.engine)return this.engine;for(var e=0;e<this.engines.length;e++)try{var t=this.engines[e]==="."?null:this.engine=require(this.engines[e]);return this.engineName=this.engines[e],t}catch(n){if(this.engines.length===1)throw n}throw new Error("In order to apply the transform "+this.name+" you must install one of "+this.engines.map(function(e){return'"'+e+'"'}).join())},Transformer.prototype.minify=function(e,t){return e},Transformer.prototype.renderSync=function(e,t){t=t||{},t=clone(t),this.loadModule();if(this._renderSync)return this.minify(this._renderSync(this.isBinary?e:fixString(e),t),t);if(this.sudoSync){t.sudoSync=!0;var n,r;this._renderAsync(this.isBinary?e:fixString(e),t,function(e,t){e?r=e:n=t});if(r)throw r;if(n!=undefined)return this.minify(n,t);throw typeof this.sudoSync=="string"?new Error(this.sudoSync.replace(/FILENAME/g,t.filename||"")):new Error("There was a problem transforming "+(t.filename||"")+" syncronously using "+this.name)}throw new Error(this.name+" does not support transforming syncronously.")},Transformer.prototype.render=function(e,t,n){t=t||{};var r=this;return(new Promise(function(n,i){r.loadModule(),r._renderAsync?r._renderAsync(r.isBinary?e:fixString(e),clone(t),function(e,s){e?i(e):n(r.minify(s,t))}):n(r.renderSync(e,t))})).nodeify(n)},Transformer.prototype.renderFile=function(e,t,n){t=t||{};var r=this;return(new Promise(function(n,i){t.filename=e=normalize(e),r._cache[e]?n(null):fs.readFile(e,function(e,t){e?i(e):n(t)})})).then(function(e){return r.render(e,t)}).nodeify(n)},Transformer.prototype.renderFileSync=function(e,t){return t=t||{},t.filename=e=normalize(e),this.renderSync(this._cache[e]?null:fs.readFileSync(e),t)};