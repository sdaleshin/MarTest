/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */

function removeAmdefine(e){return e=String(e).replace(/if\s*\(typeof\s*define\s*!==\s*'function'\)\s*{\s*var\s*define\s*=\s*require\('amdefine'\)\(module,\s*require\);\s*}\s*/g,""),e=e.replace(/\b(define\(.*)('amdefine',?)/gm,"$1"),e}function makeNonRelative(e){return e.replace(/require\('.\//g,"require('source-map/").replace(/\.\.\/\.\.\/lib\//g,"")}function buildBrowser(){console.log("\nCreating dist/source-map.js");var e=copy.createCommonJsProject({roots:[path.join(__dirname,"lib")]});copy({source:["build/mini-require.js",{project:e,require:["source-map/source-map-generator","source-map/source-map-consumer","source-map/source-node"]},"build/suffix-browser.js"],filter:[copy.filter.moduleDefines,removeAmdefine],dest:"dist/source-map.js"})}function buildBrowserMin(){console.log("\nCreating dist/source-map.min.js"),copy({source:"dist/source-map.js",filter:copy.filter.uglifyjs,dest:"dist/source-map.min.js"})}function buildFirefox(){function t(e){return/^test\-.*?\.js/.test(e)}console.log("\nCreating dist/SourceMap.jsm");var e=copy.createCommonJsProject({roots:[path.join(__dirname,"lib")]});copy({source:["build/prefix-source-map.jsm",{project:e,require:["source-map/source-map-consumer","source-map/source-map-generator","source-map/source-node"]},"build/suffix-source-map.jsm"],filter:[copy.filter.moduleDefines,removeAmdefine,makeNonRelative],dest:"dist/SourceMap.jsm"}),console.log("\nCreating dist/test/Utils.jsm"),e=copy.createCommonJsProject({roots:[__dirname,path.join(__dirname,"lib")]}),copy({source:["build/prefix-utils.jsm","build/assert-shim.js",{project:e,require:["test/source-map/util"]},"build/suffix-utils.jsm"],filter:[copy.filter.moduleDefines,removeAmdefine,makeNonRelative],dest:"dist/test/Utils.jsm"});var n=fs.readdirSync(path.join(__dirname,"test","source-map")).filter(t);n.forEach(function(e){console.log("\nCreating",path.join("dist","test",e.replace(/\-/g,"_"))),copy({source:["build/test-prefix.js",path.join("test","source-map",e),"build/test-suffix.js"],filter:[removeAmdefine,makeNonRelative,function(t,n){return t.replace("define(",'define("'+path.join("test","source-map",e.replace(/\.js$/,""))+'", ["require", "exports", "module"], ')},function(t,n){return t.replace("{THIS_MODULE}",function(){return"test/source-map/"+e.replace(/\.js$/,"")})}],dest:path.join("dist","test",e.replace(/\-/g,"_"))})})}function ensureDir(e){var t=!1;try{t=fs.statSync(e).isDirectory()}catch(n){}t||fs.mkdirSync(e,511)}var path=require("path"),fs=require("fs"),copy=require("dryice").copy;removeAmdefine.onRead=!0,makeNonRelative.onRead=!0,ensureDir("dist"),ensureDir("dist/test"),buildFirefox(),buildBrowser(),buildBrowserMin();