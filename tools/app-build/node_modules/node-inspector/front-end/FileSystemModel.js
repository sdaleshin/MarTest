/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.FileSystemModel=function(){WebInspector.Object.call(this),this._fileSystemsForOrigin={},WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.SecurityOriginAdded,this._securityOriginAdded,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.SecurityOriginRemoved,this._securityOriginRemoved,this),FileSystemAgent.enable(),this._reset()},WebInspector.FileSystemModel.prototype={_reset:function(){for(var e in this._fileSystemsForOrigin)this._removeOrigin(e);var t=WebInspector.resourceTreeModel.securityOrigins();for(var n=0;n<t.length;++n)this._addOrigin(t[n])},_securityOriginAdded:function(e){var t=e.data;this._addOrigin(t)},_securityOriginRemoved:function(e){var t=e.data;this._removeOrigin(t)},_addOrigin:function(e){this._fileSystemsForOrigin[e]={};var t=["persistent","temporary"];for(var n=0;n<t.length;++n)this._requestFileSystemRoot(e,t[n],this._fileSystemRootReceived.bind(this,e,t[n],this._fileSystemsForOrigin[e]))},_removeOrigin:function(e){for(var t in this._fileSystemsForOrigin[e]){var n=this._fileSystemsForOrigin[e][t];delete this._fileSystemsForOrigin[e][t],this._fileSystemRemoved(n)}delete this._fileSystemsForOrigin[e]},_requestFileSystemRoot:function(e,t,n){function r(e,t,r){if(e){n(FileError.SECURITY_ERR);return}n(t,r)}FileSystemAgent.requestFileSystemRoot(e,t,r.bind(this))},_fileSystemAdded:function(e){this.dispatchEventToListeners(WebInspector.FileSystemModel.EventTypes.FileSystemAdded,e)},_fileSystemRemoved:function(e){this.dispatchEventToListeners(WebInspector.FileSystemModel.EventTypes.FileSystemRemoved,e)},refreshFileSystemList:function(){this._reset()},_fileSystemRootReceived:function(e,t,n,r,i){if(!r&&i&&this._fileSystemsForOrigin[e]===n){var s=new WebInspector.FileSystemModel.FileSystem(this,e,t,i);n[t]=s,this._fileSystemAdded(s)}},requestDirectoryContent:function(e,t){this._requestDirectoryContent(e.url,this._directoryContentReceived.bind(this,e,t))},_requestDirectoryContent:function(e,t){function n(e,n,r){if(e){t(FileError.SECURITY_ERR);return}if(n!==0){t(n,null);return}t(n,r)}FileSystemAgent.requestDirectoryContent(e,n.bind(this))},_directoryContentReceived:function(e,t,n,r){var i=[];for(var s=0;s<r.length;++s)r[s].isDirectory?i.push(new WebInspector.FileSystemModel.Directory(this,e.fileSystem,r[s])):i.push(new WebInspector.FileSystemModel.File(this,e.fileSystem,r[s]));t(n,i)},requestMetadata:function(e,t){function n(e,n,r){if(e){t(FileError.SECURITY_ERR);return}t(n,r)}FileSystemAgent.requestMetadata(e.url,n.bind(this))},requestFileContent:function(e,t,n,r,i,s){this._requestFileContent(e.url,t,n,r,i,s)},_requestFileContent:function(e,t,n,r,i,s){function o(e,t,n,r){if(e){s&&s(FileError.SECURITY_ERR);return}s&&s(t,n,r)}FileSystemAgent.requestFileContent(e,t,n,r,i,o.bind(this))},deleteEntry:function(e,t){function r(r){t(r),r||n._removeFileSystem(e.fileSystem)}var n=this;e===e.fileSystem.root?this._deleteEntry(e.url,r):this._deleteEntry(e.url,t)},_deleteEntry:function(e,t){function n(e,n){if(e){t&&t(FileError.SECURITY_ERR);return}t&&t(n)}FileSystemAgent.deleteEntry(e,n.bind(this))},_removeFileSystem:function(e){var t=e.origin,n=e.type;this._fileSystemsForOrigin[t]&&this._fileSystemsForOrigin[t][n]&&(delete this._fileSystemsForOrigin[t][n],this._fileSystemRemoved(e),Object.isEmpty(this._fileSystemsForOrigin[t])&&delete this._fileSystemsForOrigin[t])},__proto__:WebInspector.Object.prototype},WebInspector.FileSystemModel.EventTypes={FileSystemAdded:"FileSystemAdded",FileSystemRemoved:"FileSystemRemoved"},WebInspector.FileSystemModel.FileSystem=function(e,t,n,r){this.origin=t,this.type=n,this.root=new WebInspector.FileSystemModel.Directory(e,this,r)},WebInspector.FileSystemModel.FileSystem.prototype={get name(){return"filesystem:"+this.origin+"/"+this.type}},WebInspector.FileSystemModel.Entry=function(e,t,n){this._fileSystemModel=e,this._fileSystem=t,this._url=n.url,this._name=n.name,this._isDirectory=n.isDirectory},WebInspector.FileSystemModel.Entry.compare=function(e,t){return e.isDirectory!=t.isDirectory?t.isDirectory?1:-1:e.name.compareTo(t.name)},WebInspector.FileSystemModel.Entry.prototype={get fileSystemModel(){return this._fileSystemModel},get fileSystem(){return this._fileSystem},get url(){return this._url},get name(){return this._name},get isDirectory(){return this._isDirectory},requestMetadata:function(e){this.fileSystemModel.requestMetadata(this,e)},deleteEntry:function(e){this.fileSystemModel.deleteEntry(this,e)}},WebInspector.FileSystemModel.Directory=function(e,t,n){WebInspector.FileSystemModel.Entry.call(this,e,t,n)},WebInspector.FileSystemModel.Directory.prototype={requestDirectoryContent:function(e){this.fileSystemModel.requestDirectoryContent(this,e)},__proto__:WebInspector.FileSystemModel.Entry.prototype},WebInspector.FileSystemModel.File=function(e,t,n){WebInspector.FileSystemModel.Entry.call(this,e,t,n),this._mimeType=n.mimeType,this._resourceType=WebInspector.resourceTypes[n.resourceType],this._isTextFile=n.isTextFile},WebInspector.FileSystemModel.File.prototype={get mimeType(){return this._mimeType},get resourceType(){return this._resourceType},get isTextFile(){return this._isTextFile},requestFileContent:function(e,t,n,r,i){this.fileSystemModel.requestFileContent(this,e,t,n,r,i)},__proto__:WebInspector.FileSystemModel.Entry.prototype};