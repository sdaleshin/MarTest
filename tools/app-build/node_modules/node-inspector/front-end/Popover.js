/*
 * Copyright (C) 2009 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.Popover=function(e){WebInspector.View.call(this),this.markAsRoot(),this.element.className="popover custom-popup-vertical-scroll custom-popup-horizontal-scroll",this._popupArrowElement=document.createElement("div"),this._popupArrowElement.className="arrow",this.element.appendChild(this._popupArrowElement),this._contentDiv=document.createElement("div"),this._contentDiv.className="content",this.element.appendChild(this._contentDiv),this._popoverHelper=e},WebInspector.Popover.prototype={show:function(e,t,n,r,i){this._innerShow(null,e,t,n,r,i)},showView:function(e,t,n,r){this._innerShow(e,e.element,t,n,r)},_innerShow:function(e,t,n,r,i,s){if(this._disposed)return;this.contentElement=t,WebInspector.Popover._popover&&WebInspector.Popover._popover.detach(),WebInspector.Popover._popover=this;var o=e?e.measurePreferredSize():this.contentElement.measurePreferredSize();r=r||o.width,i=i||o.height,WebInspector.View.prototype.show.call(this,document.body),e?e.show(this._contentDiv):this._contentDiv.appendChild(this.contentElement),this._positionElement(n,r,i,s),this._popoverHelper&&(this._contentDiv.addEventListener("mousemove",this._popoverHelper._killHidePopoverTimer.bind(this._popoverHelper),!0),this.element.addEventListener("mouseout",this._popoverHelper._popoverMouseOut.bind(this._popoverHelper),!0))},hide:function(){this.detach(),delete WebInspector.Popover._popover},get disposed(){return this._disposed},dispose:function(){this.isShowing()&&this.hide(),this._disposed=!0},setCanShrink:function(e){this._hasFixedHeight=!e,this._contentDiv.addStyleClass("fixed-height")},_positionElement:function(e,t,n,r){const i=25,s=this._hasFixedHeight?0:11,o=15,u=10,a=10;t=Math.max(t,50);const f=window.innerWidth,l=window.innerHeight;var c=e instanceof AnchorBox?e:e.boxInWindow(window),h={x:0,y:0,width:t+s,height:n},p,d=c.y,v=l-c.y-c.height;d>v||r===WebInspector.Popover.Orientation.Bottom?(c.y>h.height+o+a||r===WebInspector.Popover.Orientation.Bottom?h.y=c.y-h.height-o:(h.y=a,h.height=c.y-a*2-o,this._hasFixedHeight&&h.height<n&&(h.y=a,h.height=n)),p=WebInspector.Popover.Orientation.Bottom):(h.y=c.y+c.height+o,h.y+h.height+o-i>=l&&r!==WebInspector.Popover.Orientation.Top&&(h.height=l-c.y-c.height-a*2-o,this._hasFixedHeight&&h.height<n&&(h.y=l-n-a,h.height=n)),p=WebInspector.Popover.Orientation.Top);var m;if(c.x+h.width<f)h.x=Math.max(a,c.x-a-u),m="left";else if(h.width+a*2<f){h.x=f-h.width-a,m="right";var g=Math.max(0,f-c.x-c.width-a-u);g+=c.width/2,g=Math.min(g,h.width-a-u),this._popupArrowElement.style.right=g+"px"}else h.x=a,h.width=f-a*2,h.height+=s,m="left",p===WebInspector.Popover.Orientation.Bottom&&(h.y-=s),this._popupArrowElement.style.left=Math.max(0,c.x-a*2-u)+"px",this._popupArrowElement.style.left+=c.width/2;this.element.className="popover custom-popup-vertical-scroll custom-popup-horizontal-scroll "+p+"-"+m+"-arrow",this.element.positionAt(h.x-i,h.y-i),this.element.style.width=h.width+i*2+"px",this.element.style.height=h.height+i*2+"px"},__proto__:WebInspector.View.prototype},WebInspector.PopoverHelper=function(e,t,n,r,i){this._panelElement=e,this._getAnchor=t,this._showPopover=n,this._onHide=r,this._disableOnClick=!!i,e.addEventListener("mousedown",this._mouseDown.bind(this),!1),e.addEventListener("mousemove",this._mouseMove.bind(this),!1),e.addEventListener("mouseout",this._mouseOut.bind(this),!1),this.setTimeout(1e3)},WebInspector.PopoverHelper.prototype={setTimeout:function(e){this._timeout=e},_eventInHoverElement:function(e){if(!this._hoverElement)return!1;var t=this._hoverElement instanceof AnchorBox?this._hoverElement:this._hoverElement.boxInWindow();return t.x<=e.clientX&&e.clientX<=t.x+t.width&&t.y<=e.clientY&&e.clientY<=t.y+t.height},_mouseDown:function(e){this._disableOnClick||!this._eventInHoverElement(e)?this.hidePopover():(this._killHidePopoverTimer(),this._handleMouseAction(e,!0))},_mouseMove:function(e){if(this._eventInHoverElement(e))return;this._startHidePopoverTimer(),this._handleMouseAction(e,!1)},_popoverMouseOut:function(e){if(!this.isPopoverVisible())return;e.relatedTarget&&!e.relatedTarget.isSelfOrDescendant(this._popover._contentDiv)&&this._startHidePopoverTimer()},_mouseOut:function(e){if(!this.isPopoverVisible())return;this._eventInHoverElement(e)||this._startHidePopoverTimer()},_startHidePopoverTimer:function(){function e(){this._hidePopover(),delete this._hidePopoverTimer}if(!this._popover||this._hidePopoverTimer)return;this._hidePopoverTimer=setTimeout(e.bind(this),this._timeout/2)},_handleMouseAction:function(e,t){this._resetHoverTimer();if(e.which&&this._disableOnClick)return;this._hoverElement=this._getAnchor(e.target,e);if(!this._hoverElement)return;const n=t?0:this._popup?this._timeout*.6:this._timeout;this._hoverTimer=setTimeout(this._mouseHover.bind(this,this._hoverElement),n)},_resetHoverTimer:function(){this._hoverTimer&&(clearTimeout(this._hoverTimer),delete this._hoverTimer)},isPopoverVisible:function(){return!!this._popover},hidePopover:function(){this._resetHoverTimer(),this._hidePopover()},_hidePopover:function(){if(!this._popover)return;this._onHide&&this._onHide(),this._popover.dispose(),delete this._popover,this._hoverElement=null},_mouseHover:function(e){delete this._hoverTimer,this._hidePopover(),this._popover=new WebInspector.Popover(this),this._showPopover(e,this._popover)},_killHidePopoverTimer:function(){this._hidePopoverTimer&&(clearTimeout(this._hidePopoverTimer),delete this._hidePopoverTimer,this._resetHoverTimer())}},WebInspector.Popover.Orientation={Top:"top",Bottom:"bottom"},WebInspector.PopoverContentHelper=function(e){this._contentTable=document.createElement("table");var t=this._createCell(WebInspector.UIString("%s - Details",e),"popover-details-title");t.colSpan=2;var n=document.createElement("tr");n.appendChild(t),this._contentTable.appendChild(n)},WebInspector.PopoverContentHelper.prototype={contentTable:function(){return this._contentTable},_createCell:function(e,t){var n=document.createElement("label");n.appendChild(document.createTextNode(e));var r=document.createElement("td");return r.className="popover-details",t&&(r.className+=" "+t),r.textContent=e,r},appendTextRow:function(e,t){var n=document.createElement("tr");n.appendChild(this._createCell(e,"popover-details-row-title")),n.appendChild(this._createCell(t,"popover-details-row-data")),this._contentTable.appendChild(n)},appendElementRow:function(e,t,n){var r=document.createElement("tr"),i=this._createCell(e,"popover-details-row-title");n&&i.addStyleClass(n),r.appendChild(i);var s=document.createElement("td");s.className="details",s.appendChild(t),r.appendChild(s),this._contentTable.appendChild(r)},appendStackTrace:function(e,t,n){this.appendTextRow("","");var r=document.createElement("table");for(var i=0;i<t.length;++i){var s=t[i],o=document.createElement("tr");o.className="details",o.appendChild(this._createCell(s.functionName?s.functionName:WebInspector.UIString("(anonymous function)"),"function-name")),o.appendChild(this._createCell(" @ "));var u=document.createElement("td"),a=n(s);u.appendChild(a),o.appendChild(u),r.appendChild(o)}this.appendElementRow(e,r,"popover-stacktrace-title")}};