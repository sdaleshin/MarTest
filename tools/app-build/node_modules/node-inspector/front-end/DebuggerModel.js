/*
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.DebuggerModel=function(){InspectorBackend.registerDebuggerDispatcher(new WebInspector.DebuggerDispatcher(this)),this._debuggerPausedDetails=null,this._scripts={},this._scriptsBySourceURL={},this._canSetScriptSource=!1,this._breakpointsActive=!0,WebInspector.settings.pauseOnExceptionStateString=WebInspector.settings.createSetting("pauseOnExceptionStateString",WebInspector.DebuggerModel.PauseOnExceptionsState.DontPauseOnExceptions),WebInspector.settings.pauseOnExceptionStateString.addChangeListener(this._pauseOnExceptionStateChanged,this),this.enableDebugger(),WebInspector.DebuggerModel.applySkipStackFrameSettings()},WebInspector.DebuggerModel.PauseOnExceptionsState={DontPauseOnExceptions:"none",PauseOnAllExceptions:"all",PauseOnUncaughtExceptions:"uncaught"},WebInspector.DebuggerModel.Location=function(e,t,n){this.scriptId=e,this.lineNumber=t,this.columnNumber=n},WebInspector.DebuggerModel.Events={DebuggerWasEnabled:"DebuggerWasEnabled",DebuggerWasDisabled:"DebuggerWasDisabled",DebuggerPaused:"DebuggerPaused",DebuggerResumed:"DebuggerResumed",ParsedScriptSource:"ParsedScriptSource",FailedToParseScriptSource:"FailedToParseScriptSource",BreakpointResolved:"BreakpointResolved",GlobalObjectCleared:"GlobalObjectCleared",CallFrameSelected:"CallFrameSelected",ConsoleCommandEvaluatedInSelectedCallFrame:"ConsoleCommandEvaluatedInSelectedCallFrame",BreakpointsActiveStateChanged:"BreakpointsActiveStateChanged"},WebInspector.DebuggerModel.BreakReason={DOM:"DOM",EventListener:"EventListener",XHR:"XHR",Exception:"exception",Assert:"assert",CSPViolation:"CSPViolation",DebugCommand:"debugCommand"},WebInspector.DebuggerModel.prototype={debuggerEnabled:function(){return!!this._debuggerEnabled},enableDebugger:function(){function e(e,t){this._canSetScriptSource=t}if(this._debuggerEnabled)return;DebuggerAgent.canSetScriptSource(e.bind(this)),DebuggerAgent.enable(this._debuggerWasEnabled.bind(this))},disableDebugger:function(){if(!this._debuggerEnabled)return;DebuggerAgent.disable(this._debuggerWasDisabled.bind(this))},canSetScriptSource:function(){return this._canSetScriptSource},_debuggerWasEnabled:function(){this._debuggerEnabled=!0,this._pauseOnExceptionStateChanged(),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.DebuggerWasEnabled)},_pauseOnExceptionStateChanged:function(){DebuggerAgent.setPauseOnExceptions(WebInspector.settings.pauseOnExceptionStateString.get())},_debuggerWasDisabled:function(){this._debuggerEnabled=!1,this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.DebuggerWasDisabled)},continueToLocation:function(e){DebuggerAgent.continueToLocation(e)},stepIntoSelection:function(e){function t(e,t){if(t)return;this._pendingStepIntoLocation=e}DebuggerAgent.continueToLocation(e,!0,t.bind(this,e))},setBreakpointByScriptLocation:function(e,t,n){var r=this.scriptForId(e.scriptId);r.sourceURL?this.setBreakpointByURL(r.sourceURL,e.lineNumber,e.columnNumber,t,n):this.setBreakpointBySourceId(e,t,n)},setBreakpointByURL:function(e,t,n,r,i){function l(e,t,n){if(i){var r=n;i(e?null:t,r)}}var s=0,o=this._scriptsBySourceURL[e]||[];for(var u=0,a=o.length;u<a;++u){var f=o[u];t===f.lineOffset&&(s=s?Math.min(s,f.columnOffset):f.columnOffset)}n=Math.max(n,s),DebuggerAgent.setBreakpointByUrl(t,e,undefined,n,r,undefined,l.bind(this)),WebInspector.userMetrics.ScriptsBreakpointSet.record()},setBreakpointBySourceId:function(e,t,n){function r(e,t,r){if(n){var i=r;n(e?null:t,[i])}}DebuggerAgent.setBreakpoint(e,t,r.bind(this)),WebInspector.userMetrics.ScriptsBreakpointSet.record()},removeBreakpoint:function(e,t){DebuggerAgent.removeBreakpoint(e,t)},_breakpointResolved:function(e,t){this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.BreakpointResolved,{breakpointId:e,location:t})},_globalObjectCleared:function(){this._setDebuggerPausedDetails(null),this._reset(),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.GlobalObjectCleared)},_reset:function(){this._scripts={},this._scriptsBySourceURL={}},get scripts(){return this._scripts},scriptForId:function(e){return this._scripts[e]||null},scriptsForSourceURL:function(e){return e?this._scriptsBySourceURL[e]||[]:[]},setScriptSource:function(e,t,n){this._scripts[e].editSource(t,this._didEditScriptSource.bind(this,e,t,n))},_didEditScriptSource:function(e,t,n,r,i,s,o){n(r,i),o?DebuggerAgent.stepInto():!r&&s&&s.length&&this._pausedScript(s,this._debuggerPausedDetails.reason,this._debuggerPausedDetails.auxData,this._debuggerPausedDetails.breakpointIds)},get callFrames(){return this._debuggerPausedDetails?this._debuggerPausedDetails.callFrames:null},debuggerPausedDetails:function(){return this._debuggerPausedDetails},_setDebuggerPausedDetails:function(e){this._debuggerPausedDetails&&this._debuggerPausedDetails.dispose(),this._debuggerPausedDetails=e,this._debuggerPausedDetails&&this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.DebuggerPaused,this._debuggerPausedDetails),e?(this.setSelectedCallFrame(e.callFrames[0]),DebuggerAgent.setOverlayMessage(WebInspector.UIString("Paused in debugger"))):(this.setSelectedCallFrame(null),DebuggerAgent.setOverlayMessage())},_pausedScript:function(e,t,n,r){if(this._pendingStepIntoLocation){var i=this._pendingStepIntoLocation;delete this._pendingStepIntoLocation;if(e.length>0){var s=e[0].location;if(s.lineNumber==i.lineNumber&&s.columnNumber==i.columnNumber&&s.scriptId==i.scriptId){DebuggerAgent.stepInto();return}}}this._setDebuggerPausedDetails(new WebInspector.DebuggerPausedDetails(this,e,t,n,r))},_resumedScript:function(){this._setDebuggerPausedDetails(null),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.DebuggerResumed)},_parsedScriptSource:function(e,t,n,r,i,s,o,u,a){var f=new WebInspector.Script(e,t,n,r,i,s,o,u,a);this._registerScript(f),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.ParsedScriptSource,f)},_registerScript:function(e){this._scripts[e.scriptId]=e;if(e.isAnonymousScript())return;var t=this._scriptsBySourceURL[e.sourceURL];t||(t=[],this._scriptsBySourceURL[e.sourceURL]=t),t.push(e)},createRawLocation:function(e,t,n){return e.sourceURL?this.createRawLocationByURL(e.sourceURL,t,n):new WebInspector.DebuggerModel.Location(e.scriptId,t,n)},createRawLocationByURL:function(e,t,n){var r=null,i=this._scriptsBySourceURL[e]||[];for(var s=0,o=i.length;s<o;++s){var u=i[s];r||(r=u);if(u.lineOffset>t||u.lineOffset===t&&u.columnOffset>n)continue;if(u.endLine<t||u.endLine===t&&u.endColumn<=n)continue;r=u;break}return r?new WebInspector.DebuggerModel.Location(r.scriptId,t,n):null},isPaused:function(){return!!this.debuggerPausedDetails()},setSelectedCallFrame:function(e){this._selectedCallFrame=e;if(!this._selectedCallFrame)return;this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.CallFrameSelected,e)},selectedCallFrame:function(){return this._selectedCallFrame},evaluateOnSelectedCallFrame:function(e,t,n,r,i,s,o){function u(e,n){i?o(null,!!n,n?null:e):o(WebInspector.RemoteObject.fromPayload(e),!!n),t==="console"&&this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.ConsoleCommandEvaluatedInSelectedCallFrame)}this.selectedCallFrame().evaluate(e,t,n,r,i,s,u.bind(this))},getSelectedCallFrameVariables:function(e){function i(n){for(var i=0;n&&i<n.length;++i)t[n[i].name]=!0;--r==0&&e(t)}var t={"this":!0},n=this._selectedCallFrame;n||e(t);var r=0;for(var s=0;s<n.scopeChain.length;++s){var o=n.scopeChain[s],u=WebInspector.RemoteObject.fromPayload(o.object);r++,u.getAllProperties(!1,i)}},setBreakpointsActive:function(e){if(this._breakpointsActive===e)return;this._breakpointsActive=e,DebuggerAgent.setBreakpointsActive(e),this.dispatchEventToListeners(WebInspector.DebuggerModel.Events.BreakpointsActiveStateChanged,e)},breakpointsActive:function(){return this._breakpointsActive},createLiveLocation:function(e,t){var n=this._scripts[e.scriptId];return n.createLiveLocation(e,t)},rawLocationToUILocation:function(e){var t=this._scripts[e.scriptId];return t?t.rawLocationToUILocation(e.lineNumber,e.columnNumber):null},callStackModified:function(e,t){t&&t.stack_update_needs_step_in?DebuggerAgent.stepInto():e&&e.length&&this._pausedScript(e,this._debuggerPausedDetails.reason,this._debuggerPausedDetails.auxData,this._debuggerPausedDetails.breakpointIds)},__proto__:WebInspector.Object.prototype},WebInspector.DebuggerModel.applySkipStackFrameSettings=function(){if(!WebInspector.experimentsSettings.frameworksDebuggingSupport.isEnabled())return;var e=WebInspector.settings,t=e.skipStackFramesSwitch.get()?e.skipStackFramesPattern.get():undefined;DebuggerAgent.skipStackFrames(t)},WebInspector.DebuggerEventTypes={JavaScriptPause:0,JavaScriptBreakpoint:1,NativeBreakpoint:2},WebInspector.DebuggerDispatcher=function(e){this._debuggerModel=e},WebInspector.DebuggerDispatcher.prototype={paused:function(e,t,n,r){this._debuggerModel._pausedScript(e,t,n,r||[])},resumed:function(){this._debuggerModel._resumedScript()},globalObjectCleared:function(){this._debuggerModel._globalObjectCleared()},scriptParsed:function(e,t,n,r,i,s,o,u,a){this._debuggerModel._parsedScriptSource(e,t,n,r,i,s,!!o,u,a)},scriptFailedToParse:function(e,t,n,r,i){},breakpointResolved:function(e,t){this._debuggerModel._breakpointResolved(e,t)}},WebInspector.DebuggerModel.CallFrame=function(e,t){this._script=e,this._payload=t,this._locations=[]},WebInspector.DebuggerModel.CallFrame.prototype={get script(){return this._script},get type(){return this._payload.type},get id(){return this._payload.callFrameId},get scopeChain(){return this._payload.scopeChain},get this(){return this._payload.this},get functionName(){return this._payload.functionName},get location(){var e=this._payload.location;return e},evaluate:function(e,t,n,r,i,s,o){function u(e,t,n){if(e){console.error(e),o(null,!1);return}o(t,n)}DebuggerAgent.evaluateOnCallFrame(this._payload.callFrameId,e,t,n,r,i,s,u.bind(this))},restart:function(e){function t(t,n,r){t||WebInspector.debuggerModel.callStackModified(n,r),e&&e(t)}DebuggerAgent.restartFrame(this._payload.callFrameId,t)},getStepIntoLocations:function(e){function t(t,n){if(t)return;this._stepInLocations=n,e(this._stepInLocations.slice(0))}if(this._stepInLocations){e(this._stepInLocations.slice(0));return}DebuggerAgent.getStepInPositions(this.id,t.bind(this))},createLiveLocation:function(e){var t=this._script.createLiveLocation(this.location,e);return this._locations.push(t),t},dispose:function(e){for(var t=0;t<this._locations.length;++t)this._locations[t].dispose();this._locations=[]}},WebInspector.DebuggerPausedDetails=function(e,t,n,r,i){this.callFrames=[];for(var s=0;s<t.length;++s){var o=t[s],u=e.scriptForId(o.location.scriptId);u&&this.callFrames.push(new WebInspector.DebuggerModel.CallFrame(u,o))}this.reason=n,this.auxData=r,this.breakpointIds=i},WebInspector.DebuggerPausedDetails.prototype={dispose:function(){for(var e=0;e<this.callFrames.length;++e){var t=this.callFrames[e];t.dispose()}}},WebInspector.debuggerModel=null;