/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.SuggestBoxDelegate=function(){},WebInspector.SuggestBoxDelegate.prototype={applySuggestion:function(e,t){},acceptSuggestion:function(){}},WebInspector.SuggestBox=function(e,t,n,r){this._suggestBoxDelegate=e,this._anchorElement=t,this._length=0,this._selectedIndex=-1,this._selectedElement=null,this._maxItemsHeight=r,this._boundOnScroll=this._onScrollOrResize.bind(this,!0),this._boundOnResize=this._onScrollOrResize.bind(this,!1),window.addEventListener("scroll",this._boundOnScroll,!0),window.addEventListener("resize",this._boundOnResize,!0),this._bodyElement=t.ownerDocument.body,this._element=t.ownerDocument.createElement("div"),this._element.className="suggest-box "+(n||""),this._element.addEventListener("mousedown",this._onBoxMouseDown.bind(this),!0),this.containerElement=this._element.createChild("div","container"),this.contentElement=this.containerElement.createChild("div","content")},WebInspector.SuggestBox.prototype={visible:function(){return!!this._element.parentElement},_onScrollOrResize:function(e,t){if(e&&this._element.isAncestor(t.target)||!this.visible())return;this._updateBoxPosition(this._anchorBox)},setPosition:function(e){this._updateBoxPosition(e)},_updateBoxPosition:function(e){this._anchorBox=e,this.contentElement.style.display="inline-block",document.body.appendChild(this.contentElement),this.contentElement.positionAt(0,0);var t=this.contentElement.offsetWidth,n=this.contentElement.offsetHeight;this.contentElement.style.display="block",this.containerElement.appendChild(this.contentElement);const r=6,i=21,s=2;var o=document.body.offsetWidth-e.x-r,u=Math.min(t,o-i)+i,a=t+i,f=e.x;u<a&&(o=document.body.offsetWidth-r,u=Math.min(t,o-i)+i,f=document.body.offsetWidth-u);var l,c=e.y,h=document.body.offsetHeight-e.y-e.height,p=this._maxItemsHeight?n*this._maxItemsHeight/this._length:Math.max(h,c)-r,d=Math.min(n,p-s)+s;h>=c?(l=e.y+e.height,this._element.removeStyleClass("above-anchor"),this._element.addStyleClass("under-anchor")):(l=e.y-d,this._element.removeStyleClass("under-anchor"),this._element.addStyleClass("above-anchor")),this._element.positionAt(f,l),this._element.style.width=u+"px",this._element.style.height=d+"px"},_onBoxMouseDown:function(e){e.preventDefault()},hide:function(){if(!this.visible())return;this._element.remove(),delete this._selectedElement},removeFromElement:function(){window.removeEventListener("scroll",this._boundOnScroll,!0),window.removeEventListener("resize",this._boundOnResize,!0),this.hide()},_applySuggestion:function(e,t){if(!this.visible()||!e&&!this._selectedElement)return!1;var n=e||this._selectedElement.textContent;return n?(this._suggestBoxDelegate.applySuggestion(n,t),!0):!1},acceptSuggestion:function(e){var t=this._applySuggestion(e,!1);return this.hide(),t?(this._suggestBoxDelegate.acceptSuggestion(),!0):!1},_selectClosest:function(e,t){if(!this._length)return!1;var n=this._selectedIndex+e;return t?n=(this._length+n)%this._length:n=Number.constrain(n,0,this._length-1),this._selectItem(n),this._applySuggestion(undefined,!0),!0},_onItemMouseDown:function(e,t){this.acceptSuggestion(e),t.consume(!0)},_createItemElement:function(e,t){var n=document.createElement("div");n.className="suggest-box-content-item source-code",n.tabIndex=-1;if(e&&e.length&&!t.indexOf(e)){var r=n.createChild("span","prefix");r.textContent=e;var i=n.createChild("span","suffix");i.textContent=t.substring(e.length)}else{var i=n.createChild("span","suffix");i.textContent=t}return n.addEventListener("mousedown",this._onItemMouseDown.bind(this,t),!1),n},_updateItems:function(e,t,n){this._length=e.length,this.contentElement.removeChildren();for(var r=0;r<e.length;++r){var i=e[r],s=this._createItemElement(n,i);this.contentElement.appendChild(s)}this._selectedElement=null,typeof t=="number"&&this._selectItem(t)},_selectItem:function(e){this._selectedElement&&this._selectedElement.classList.remove("selected"),this._selectedIndex=e,this._selectedElement=this.contentElement.children[e],this._selectedElement.classList.add("selected"),this._selectedElement.scrollIntoViewIfNeeded(!1)},_canShowBox:function(e,t,n){return!e||!e.length?!1:e.length>1?!0:t&&e[0]!==n},_rememberRowCountPerViewport:function(){if(!this.contentElement.firstChild)return;this._rowCountPerViewport=Math.floor(this.containerElement.offsetHeight/this.contentElement.firstChild.offsetHeight)},updateSuggestions:function(e,t,n,r,i){this._canShowBox(t,r,i)?(this._updateItems(t,n,i),this._updateBoxPosition(e),this.visible()||this._bodyElement.appendChild(this._element),this._rememberRowCountPerViewport()):this.hide()},keyPressed:function(e){switch(e.keyIdentifier){case"Up":return this.upKeyPressed();case"Down":return this.downKeyPressed();case"PageUp":return this.pageUpKeyPressed();case"PageDown":return this.pageDownKeyPressed();case"Enter":return this.enterKeyPressed()}return!1},upKeyPressed:function(){return this._selectClosest(-1,!0)},downKeyPressed:function(){return this._selectClosest(1,!0)},pageUpKeyPressed:function(){return this._selectClosest(-this._rowCountPerViewport,!1)},pageDownKeyPressed:function(){return this._selectClosest(this._rowCountPerViewport,!1)},enterKeyPressed:function(){var e=!!this._selectedElement;return this.acceptSuggestion(),e}};