/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.OverviewGrid=function(e){this.element=document.createElement("div"),this.element.className="fill",this.element.id=e+"-overview-container",this._grid=new WebInspector.TimelineGrid,this._grid.element.id=e+"-overview-grid",this._grid.setScrollAndDividerTop(0,0),this.element.appendChild(this._grid.element),this._window=new WebInspector.OverviewGrid.Window(this.element,this._grid.dividersLabelBarElement)},WebInspector.OverviewGrid.prototype={clientWidth:function(){return this.element.clientWidth},updateDividers:function(e){this._grid.updateDividers(e)},addEventDividers:function(e){this._grid.addEventDividers(e)},removeEventDividers:function(){this._grid.removeEventDividers()},setWindowPosition:function(e,t){this._window._setWindowPosition(e,t)},reset:function(){this._window.reset()},windowLeft:function(){return this._window.windowLeft},windowRight:function(){return this._window.windowRight},setWindow:function(e,t){this._window._setWindow(e,t)},addEventListener:function(e,t,n){this._window.addEventListener(e,t,n)},zoom:function(e,t){this._window._zoom(e,t)},setResizeEnabled:function(e){this._window._setEnabled(!!e)}},WebInspector.OverviewGrid.MinSelectableSize=14,WebInspector.OverviewGrid.WindowScrollSpeedFactor=.3,WebInspector.OverviewGrid.ResizerOffset=3.5,WebInspector.OverviewGrid.Window=function(e,t){this._parentElement=e,this._dividersLabelBarElement=t,WebInspector.installDragHandle(this._parentElement,this._startWindowSelectorDragging.bind(this),this._windowSelectorDragging.bind(this),this._endWindowSelectorDragging.bind(this),"ew-resize"),WebInspector.installDragHandle(this._dividersLabelBarElement,this._startWindowDragging.bind(this),this._windowDragging.bind(this),null,"move"),this.windowLeft=0,this.windowRight=1,this._parentElement.addEventListener("mousewheel",this._onMouseWheel.bind(this),!0),this._parentElement.addEventListener("dblclick",this._resizeWindowMaximum.bind(this),!0),this._overviewWindowElement=e.createChild("div","overview-grid-window"),this._overviewWindowBordersElement=e.createChild("div","overview-grid-window-rulers"),e.createChild("div","overview-grid-dividers-background"),this._leftResizeElement=e.createChild("div","overview-grid-window-resizer"),this._leftResizeElement.style.left=0,WebInspector.installDragHandle(this._leftResizeElement,this._resizerElementStartDragging.bind(this),this._leftResizeElementDragging.bind(this),null,"ew-resize"),this._rightResizeElement=e.createChild("div","overview-grid-window-resizer overview-grid-window-resizer-right"),this._rightResizeElement.style.right=0,WebInspector.installDragHandle(this._rightResizeElement,this._resizerElementStartDragging.bind(this),this._rightResizeElementDragging.bind(this),null,"ew-resize"),this._setEnabled(!0)},WebInspector.OverviewGrid.Events={WindowChanged:"WindowChanged"},WebInspector.OverviewGrid.Window.prototype={reset:function(){this.windowLeft=0,this.windowRight=1,this._overviewWindowElement.style.left="0%",this._overviewWindowElement.style.width="100%",this._overviewWindowBordersElement.style.left="0%",this._overviewWindowBordersElement.style.right="0%",this._leftResizeElement.style.left="0%",this._rightResizeElement.style.left="100%",this._setEnabled(!0)},_setEnabled:function(e){e=!!e;if(this._enabled===e)return;this._enabled=e,this._parentElement.enableStyleClass("resize-enabled",e)},_resizerElementStartDragging:function(e){return this._enabled?(this._resizerParentOffsetLeft=e.pageX-e.offsetX-e.target.offsetLeft,e.preventDefault(),!0):!1},_leftResizeElementDragging:function(e){this._resizeWindowLeft(e.pageX-this._resizerParentOffsetLeft),e.preventDefault()},_rightResizeElementDragging:function(e){this._resizeWindowRight(e.pageX-this._resizerParentOffsetLeft),e.preventDefault()},_startWindowSelectorDragging:function(e){if(!this._enabled)return!1;this._offsetLeft=e.pageX-e.offsetX;var t=e.pageX-this._offsetLeft;return this._overviewWindowSelector=new WebInspector.OverviewGrid.WindowSelector(this._parentElement,t),!0},_windowSelectorDragging:function(e){this._overviewWindowSelector._updatePosition(e.pageX-this._offsetLeft),e.preventDefault()},_endWindowSelectorDragging:function(e){var t=this._overviewWindowSelector._close(e.pageX-this._offsetLeft);delete this._overviewWindowSelector;if(t.end===t.start){var n=t.end;t.start=Math.max(0,n-WebInspector.OverviewGrid.MinSelectableSize/2),t.end=Math.min(this._parentElement.clientWidth,n+WebInspector.OverviewGrid.MinSelectableSize/2)}else t.end-t.start<WebInspector.OverviewGrid.MinSelectableSize&&(this._parentElement.clientWidth-t.end>WebInspector.OverviewGrid.MinSelectableSize?t.end=t.start+WebInspector.OverviewGrid.MinSelectableSize:t.start=t.end-WebInspector.OverviewGrid.MinSelectableSize);this._setWindowPosition(t.start,t.end)},_startWindowDragging:function(e){return this._dragStartPoint=e.pageX,this._dragStartLeft=this.windowLeft,this._dragStartRight=this.windowRight,!0},_windowDragging:function(e){e.preventDefault();var t=(e.pageX-this._dragStartPoint)/this._parentElement.clientWidth;this._dragStartLeft+t<0&&(t=-this._dragStartLeft),this._dragStartRight+t>1&&(t=1-this._dragStartRight),this._setWindow(this._dragStartLeft+t,this._dragStartRight+t)},_resizeWindowLeft:function(e){e<10?e=0:e>this._rightResizeElement.offsetLeft-4&&(e=this._rightResizeElement.offsetLeft-4),this._setWindowPosition(e,null)},_resizeWindowRight:function(e){e>this._parentElement.clientWidth-10?e=this._parentElement.clientWidth:e<this._leftResizeElement.offsetLeft+WebInspector.OverviewGrid.MinSelectableSize&&(e=this._leftResizeElement.offsetLeft+WebInspector.OverviewGrid.MinSelectableSize),this._setWindowPosition(null,e)},_resizeWindowMaximum:function(){this._setWindowPosition(0,this._parentElement.clientWidth)},_setWindow:function(e,t){var n=e,r=t,i=t-e,s=i*this._parentElement.clientWidth,o=WebInspector.OverviewGrid.MinSelectableSize/2;if(s<o){var u=o/s;n=(t+e-i*u)/2,r=(t+e+i*u)/2}this.windowLeft=e,this._leftResizeElement.style.left=n*100+"%",this.windowRight=t,this._rightResizeElement.style.left=r*100+"%",this._overviewWindowElement.style.left=n*100+"%",this._overviewWindowBordersElement.style.left=n*100+"%",this._overviewWindowElement.style.width=(r-n)*100+"%",this._overviewWindowBordersElement.style.right=(1-r)*100+"%",this.dispatchEventToListeners(WebInspector.OverviewGrid.Events.WindowChanged)},_setWindowPosition:function(e,t){var n=this._parentElement.clientWidth,r=typeof e=="number"?e/n:this.windowLeft,i=typeof t=="number"?t/n:this.windowRight;this._setWindow(r,i)},_onMouseWheel:function(e){if(typeof e.wheelDeltaY=="number"&&e.wheelDeltaY){const t=1.1,n=1/120;var r=e.offsetX/e.target.clientWidth;this._zoom(Math.pow(t,-e.wheelDeltaY*n),r)}if(typeof e.wheelDeltaX=="number"&&e.wheelDeltaX){var i=Math.round(e.wheelDeltaX*WebInspector.OverviewGrid.WindowScrollSpeedFactor),s=this._leftResizeElement.offsetLeft+WebInspector.OverviewGrid.ResizerOffset,o=this._rightResizeElement.offsetLeft+WebInspector.OverviewGrid.ResizerOffset;s-i<0&&(i=s),o-i>this._parentElement.clientWidth&&(i=o-this._parentElement.clientWidth),this._setWindowPosition(s-i,o-i),e.preventDefault()}},_zoom:function(e,t){var n=this.windowLeft,r=this.windowRight,i=r-n,s=e*i;s>1&&(s=1,e=s/i),n=t+(n-t)*e,n=Number.constrain(n,0,1-s),r=t+(r-t)*e,r=Number.constrain(r,s,1),this._setWindow(n,r)},__proto__:WebInspector.Object.prototype},WebInspector.OverviewGrid.WindowSelector=function(e,t){this._startPosition=t,this._width=e.offsetWidth,this._windowSelector=document.createElement("div"),this._windowSelector.className="overview-grid-window-selector",this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-this._startPosition+"px",e.appendChild(this._windowSelector)},WebInspector.OverviewGrid.WindowSelector.prototype={_createSelectorElement:function(e,t,n,r){var i=document.createElement("div");return i.className="overview-grid-window-selector",i.style.left=t+"px",i.style.width=n+"px",i.style.top="0px",i.style.height=r+"px",e.appendChild(i),i},_close:function(e){return e=Math.max(0,Math.min(e,this._width)),this._windowSelector.remove(),this._startPosition<e?{start:this._startPosition,end:e}:{start:e,end:this._startPosition}},_updatePosition:function(e){e=Math.max(0,Math.min(e,this._width)),e<this._startPosition?(this._windowSelector.style.left=e+"px",this._windowSelector.style.right=this._width-this._startPosition+"px"):(this._windowSelector.style.left=this._startPosition+"px",this._windowSelector.style.right=this._width-e+"px")}};