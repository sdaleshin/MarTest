/*
 * Copyright (C) 2007 Apple Inc.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.MetricsSidebarPane=function(){WebInspector.SidebarPane.call(this,WebInspector.UIString("Metrics")),WebInspector.cssModel.addEventListener(WebInspector.CSSStyleModel.Events.StyleSheetChanged,this._styleSheetOrMediaQueryResultChanged,this),WebInspector.cssModel.addEventListener(WebInspector.CSSStyleModel.Events.MediaQueryResultChanged,this._styleSheetOrMediaQueryResultChanged,this),WebInspector.domAgent.addEventListener(WebInspector.DOMAgent.Events.AttrModified,this._attributesUpdated,this),WebInspector.domAgent.addEventListener(WebInspector.DOMAgent.Events.AttrRemoved,this._attributesUpdated,this)},WebInspector.MetricsSidebarPane.prototype={update:function(e){e&&(this.node=e),this._innerUpdate()},_innerUpdate:function(){function t(t){if(!t||this.node!==e)return;this._updateMetrics(t)}function n(t){if(!t||this.node!==e)return;this.inlineStyle=t}if(this._isEditingMetrics)return;var e=this.node;if(!e||e.nodeType()!==Node.ELEMENT_NODE){this.bodyElement.removeChildren();return}WebInspector.cssModel.getComputedStyleAsync(e.id,t.bind(this)),WebInspector.cssModel.getInlineStylesAsync(e.id,n.bind(this))},_styleSheetOrMediaQueryResultChanged:function(){this._innerUpdate()},_attributesUpdated:function(e){if(this.node!==e.data.node)return;this._innerUpdate()},_getPropertyValueAsPx:function(e,t){return Number(e.getPropertyValue(t).replace(/px$/,"")||0)},_getBox:function(e,t){var n=t==="border"?"-width":"",r=this._getPropertyValueAsPx(e,t+"-left"+n),i=this._getPropertyValueAsPx(e,t+"-top"+n),s=this._getPropertyValueAsPx(e,t+"-right"+n),o=this._getPropertyValueAsPx(e,t+"-bottom"+n);return{left:r,top:i,right:s,bottom:o}},_highlightDOMNode:function(e,t,n){n.consume();var r=e&&this.node?this.node.id:0;if(r){if(this._highlightMode===t)return;this._highlightMode=t,WebInspector.domAgent.highlightDOMNode(r,t)}else delete this._highlightMode,WebInspector.domAgent.hideDOMNodeHighlight();for(var i=0;this._boxElements&&i<this._boxElements.length;++i){var s=this._boxElements[i];!r||t==="all"||s._name===t?s.style.backgroundColor=s._backgroundColor:s.style.backgroundColor=""}},_updateMetrics:function(e){function r(e,t,n,r){var i=(t!=="position"?t+"-":"")+n+r,s=e.getPropertyValue(i);s===""||t!=="position"&&s==="0px"?s="‒":t==="position"&&s==="auto"&&(s="‒"),s=s.replace(/px$/,""),s=Number.toFixedIfFloating(s);var o=document.createElement("div");return o.className=n,o.textContent=s,o.addEventListener("dblclick",this.startEditing.bind(this,o,t,i,e),!1),o}function i(e){var t=e.getPropertyValue("width").replace(/px$/,"");if(!isNaN(t)&&e.getPropertyValue("box-sizing")==="border-box"){var r=n._getBox(e,"border"),i=n._getBox(e,"padding");t=t-r.left-r.right-i.left-i.right}return Number.toFixedIfFloating(t)}function s(e){var t=e.getPropertyValue("height").replace(/px$/,"");if(!isNaN(t)&&e.getPropertyValue("box-sizing")==="border-box"){var r=n._getBox(e,"border"),i=n._getBox(e,"padding");t=t-r.top-r.bottom-i.top-i.bottom}return Number.toFixedIfFloating(t)}var t=document.createElement("div");t.className="metrics";var n=this,o={"table-cell":!0,"table-column":!0,"table-column-group":!0,"table-footer-group":!0,"table-header-group":!0,"table-row":!0,"table-row-group":!0},u={"table-column":!0,"table-column-group":!0,"table-footer-group":!0,"table-header-group":!0,"table-row":!0,"table-row-group":!0},a={"static":!0},f=["content","padding","border","margin","position"],l=[WebInspector.Color.PageHighlight.Content,WebInspector.Color.PageHighlight.Padding,WebInspector.Color.PageHighlight.Border,WebInspector.Color.PageHighlight.Margin,WebInspector.Color.fromRGBA([0,0,0,0])],c=[WebInspector.UIString("content"),WebInspector.UIString("padding"),WebInspector.UIString("border"),WebInspector.UIString("margin"),WebInspector.UIString("position")],h=null;this._boxElements=[];for(var p=0;p<f.length;++p){var d=f[p];if(d==="margin"&&o[e.getPropertyValue("display")])continue;if(d==="padding"&&u[e.getPropertyValue("display")])continue;if(d==="position"&&a[e.getPropertyValue("position")])continue;var v=document.createElement("div");v.className=d,v._backgroundColor=l[p].toString(WebInspector.Color.Format.RGBA),v._name=d,v.style.backgroundColor=v._backgroundColor,v.addEventListener("mouseover",this._highlightDOMNode.bind(this,!0,d==="position"?"all":d),!1),this._boxElements.push(v);if(d==="content"){var m=document.createElement("span");m.textContent=i(e),m.addEventListener("dblclick",this.startEditing.bind(this,m,"width","width",e),!1);var g=document.createElement("span");g.textContent=s(e),g.addEventListener("dblclick",this.startEditing.bind(this,g,"height","height",e),!1),v.appendChild(m),v.appendChild(document.createTextNode(" × ")),v.appendChild(g)}else{var y=d==="border"?"-width":"",b=document.createElement("div");b.className="label",b.textContent=c[p],v.appendChild(b),v.appendChild(r.call(this,e,d,"top",y)),v.appendChild(document.createElement("br")),v.appendChild(r.call(this,e,d,"left",y)),h&&v.appendChild(h),v.appendChild(r.call(this,e,d,"right",y)),v.appendChild(document.createElement("br")),v.appendChild(r.call(this,e,d,"bottom",y))}h=v}t.appendChild(h),t.addEventListener("mouseover",this._highlightDOMNode.bind(this,!1,""),!1),this.bodyElement.removeChildren(),this.bodyElement.appendChild(t)},startEditing:function(e,t,n,r){if(WebInspector.isBeingEdited(e))return;var i={box:t,styleProperty:n,computedStyle:r},s=this._handleKeyDown.bind(this,i,n);i.keyDownHandler=s,e.addEventListener("keydown",s,!1),this._isEditingMetrics=!0;var o=new WebInspector.EditingConfig(this.editingCommitted.bind(this),this.editingCancelled.bind(this),i);WebInspector.startEditing(e,o),window.getSelection().setBaseAndExtent(e,0,e,1)},_handleKeyDown:function(e,t,n){function i(t,n){this._applyUserInput(r,n,t,e,!1)}function s(e){return t!=="margin"&&e<0&&(e=0),e}var r=n.currentTarget;WebInspector.handleElementValueModifications(n,r,i.bind(this),undefined,s)},editingEnded:function(e,t){delete this.originalPropertyData,delete this.previousPropertyDataCandidate,e.removeEventListener("keydown",t.keyDownHandler,!1),delete this._isEditingMetrics},editingCancelled:function(e,t){if("originalPropertyData"in this&&this.inlineStyle)if(!this.originalPropertyData){var n=this.inlineStyle.pastLastSourcePropertyIndex();n&&this.inlineStyle.allProperties[n-1].setText("",!1)}else this.inlineStyle.allProperties[this.originalPropertyData.index].setText(this.originalPropertyData.propertyText,!1);this.editingEnded(e,t),this.update()},_applyUserInput:function(e,t,n,r,i){if(!this.inlineStyle)return this.editingCancelled(e,r);if(i&&t===n)return this.editingCancelled(e,r);r.box==="position"||!!t&&t!=="‒"?r.box==="position"&&(!t||t==="‒")&&(t="auto"):t="0px",t=t.toLowerCase(),/^\d+$/.test(t)&&(t+="px");var s=r.styleProperty,o=r.computedStyle;if(o.getPropertyValue("box-sizing")==="border-box"&&(s==="width"||s==="height")){if(!t.match(/px$/)){WebInspector.log("For elements with box-sizing: border-box, only absolute content area dimensions can be applied",WebInspector.ConsoleMessage.MessageLevel.Error,!0);return}var u=this._getBox(o,"border"),a=this._getBox(o,"padding"),f=Number(t.replace(/px$/,""));if(isNaN(f))return;s==="width"?f+=u.left+u.right+a.left+a.right:f+=u.top+u.bottom+a.top+a.bottom,t=f+"px"}this.previousPropertyDataCandidate=null;var l=this,c=function(e){if(!e)return;l.inlineStyle=e,"originalPropertyData"in l||(l.originalPropertyData=l.previousPropertyDataCandidate),typeof l._highlightMode!="undefined"&&WebInspector.domAgent.highlightDOMNode(l.node.id,l._highlightMode),i&&(l.dispatchEventToListeners("metrics edited"),l.update())},h=this.inlineStyle.allProperties;for(var p=0;p<h.length;++p){var d=h[p];if(d.name!==r.styleProperty||d.inactive)continue;this.previousPropertyDataCandidate=d,d.setValue(t,i,!0,c);return}this.inlineStyle.appendProperty(r.styleProperty,t,c)},editingCommitted:function(e,t,n,r){this.editingEnded(e,r),this._applyUserInput(e,t,n,r,!0)},__proto__:WebInspector.SidebarPane.prototype};