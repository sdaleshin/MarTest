/*
 * Copyright (C) 2009 280 North Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ProfileDataGridNode=function(e,t,n){this.profileNode=e,WebInspector.DataGridNode.call(this,null,n),this.tree=t,this.childrenByCallUID={},this.lastComparator=null,this.callUID=e.callUID,this.selfTime=e.selfTime,this.totalTime=e.totalTime,this.functionName=e.functionName,this.url=e.url},WebInspector.ProfileDataGridNode.prototype={get data(){function e(e){return WebInspector.UIString("%.0fâ€‰ms",e)}var t={};return t["function"]=this.functionName,this.tree.profileView.showSelfTimeAsPercent.get()?t.self=WebInspector.UIString("%.2f%",this.selfPercent):t.self=e(this.selfTime),this.tree.profileView.showTotalTimeAsPercent.get()?t.total=WebInspector.UIString("%.2f%",this.totalPercent):t.total=e(this.totalTime),t},createCell:function(e){var t=WebInspector.DataGridNode.prototype.createCell.call(this,e);e==="self"&&this._searchMatchedSelfColumn?t.addStyleClass("highlight"):e==="total"&&this._searchMatchedTotalColumn&&t.addStyleClass("highlight");if(e!=="function")return t;this.profileNode._searchMatchedFunctionColumn&&t.addStyleClass("highlight");if(this.profileNode.url){var n=this.profileNode.lineNumber?this.profileNode.lineNumber-1:0,r=this.tree.profileView._linkifier.linkifyLocation(this.profileNode.url,n,0,"profile-node-file");r.style.maxWidth="75%",t.insertBefore(r,t.firstChild)}return t},select:function(e){WebInspector.DataGridNode.prototype.select.call(this,e),this.tree.profileView._dataGridNodeSelected(this)},deselect:function(e){WebInspector.DataGridNode.prototype.deselect.call(this,e),this.tree.profileView._dataGridNodeDeselected(this)},sort:function(e,t){var n=[[this]];for(var r=0;r<n.length;++r){var i=n[r],s=i.length;for(var o=0;o<s;++o){var u=i[o];if(!t&&(!u.expanded||u.lastComparator===e)){u.children.length&&(u.shouldRefreshChildren=!0);continue}u.lastComparator=e;var a=u.children,f=a.length;if(f){a.sort(e);for(var l=0;l<f;++l)a[l]._recalculateSiblings(l);n.push(a)}}}},insertChild:function(e,t){WebInspector.DataGridNode.prototype.insertChild.call(this,e,t),this.childrenByCallUID[e.callUID]=e},removeChild:function(e){WebInspector.DataGridNode.prototype.removeChild.call(this,e),delete this.childrenByCallUID[e.callUID]},removeChildren:function(){WebInspector.DataGridNode.prototype.removeChildren.call(this),this.childrenByCallUID={}},findChild:function(e){return e?this.childrenByCallUID[e.callUID]:null},get selfPercent(){return this.selfTime/this.tree.totalTime*100},get totalPercent(){return this.totalTime/this.tree.totalTime*100},get _parent(){return this.parent!==this.dataGrid?this.parent:this.tree},populate:function(){if(this._populated)return;this._populated=!0,this._sharedPopulate();if(this._parent){var e=this._parent.lastComparator;e&&this.sort(e,!0)}},_save:function(){if(this._savedChildren)return;this._savedSelfTime=this.selfTime,this._savedTotalTime=this.totalTime,this._savedChildren=this.children.slice()},_restore:function(){if(!this._savedChildren)return;this.selfTime=this._savedSelfTime,this.totalTime=this._savedTotalTime,this.removeChildren();var e=this._savedChildren,t=e.length;for(var n=0;n<t;++n)e[n]._restore(),this.appendChild(e[n])},_merge:function(e,t){this.selfTime+=e.selfTime,t||(this.totalTime+=e.totalTime);var n=this.children.slice();this.removeChildren();var r=n.length;for(var i=0;i<r;++i)(!t||n[i]!==e)&&this.appendChild(n[i]);n=e.children.slice(),r=n.length;for(var i=0;i<r;++i){var s=n[i],o=this.childrenByCallUID[s.callUID];o?o._merge(s,!1):this.appendChild(s)}},__proto__:WebInspector.DataGridNode.prototype},WebInspector.ProfileDataGridTree=function(e,t){this.tree=this,this.children=[],this.profileView=e,this.totalTime=t.totalTime,this.lastComparator=null,this.childrenByCallUID={}},WebInspector.ProfileDataGridTree.prototype={get expanded(){return!0},appendChild:function(e){this.insertChild(e,this.children.length)},insertChild:function(e,t){this.children.splice(t,0,e),this.childrenByCallUID[e.callUID]=e},removeChildren:function(){this.children=[],this.childrenByCallUID={}},findChild:WebInspector.ProfileDataGridNode.prototype.findChild,sort:WebInspector.ProfileDataGridNode.prototype.sort,_save:function(){if(this._savedChildren)return;this._savedTotalTime=this.totalTime,this._savedChildren=this.children.slice()},restore:function(){if(!this._savedChildren)return;this.children=this._savedChildren,this.totalTime=this._savedTotalTime;var e=this.children,t=e.length;for(var n=0;n<t;++n)e[n]._restore();this._savedChildren=null}},WebInspector.ProfileDataGridTree.propertyComparators=[{},{}],WebInspector.ProfileDataGridTree.propertyComparator=function(e,t){var n=WebInspector.ProfileDataGridTree.propertyComparators[t?1:0][e];return n||(t?n=function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}:n=function(t,n){return t[e]>n[e]?-1:t[e]<n[e]?1:0},WebInspector.ProfileDataGridTree.propertyComparators[t?1:0][e]=n),n};