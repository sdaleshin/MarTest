/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

importScript("cm/codemirror.js"),importScript("cm/css.js"),importScript("cm/javascript.js"),importScript("cm/xml.js"),importScript("cm/htmlmixed.js"),importScript("cm/matchbrackets.js"),importScript("cm/closebrackets.js"),importScript("cm/markselection.js"),importScript("cm/comment.js"),importScript("cm/overlay.js"),importScript("cm/htmlembedded.js"),importScript("cm/clike.js"),importScript("cm/coffeescript.js"),importScript("cm/php.js"),importScript("cm/python.js"),importScript("cm/shell.js"),importScript("CodeMirrorUtils.js"),WebInspector.CodeMirrorTextEditor=function(e,t){WebInspector.View.call(this),this._delegate=t,this._url=e,this.registerRequiredCSS("cm/codemirror.css"),this.registerRequiredCSS("cm/cmdevtools.css"),this._codeMirror=window.CodeMirror(this.element,{lineNumbers:!0,gutters:["CodeMirror-linenumbers"],matchBrackets:!0,smartIndent:!1,styleSelectedText:!0,electricChars:!1,autoCloseBrackets:{explode:!1}}),this._codeMirror._codeMirrorTextEditor=this,CodeMirror.keyMap["devtools-common"]={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentLess",Enter:"smartNewlineAndIndent","Ctrl-Space":"autocomplete"},CodeMirror.keyMap["devtools-pc"]={"Ctrl-A":"selectAll","Ctrl-Z":"undoAndReveal","Shift-Ctrl-Z":"redoAndReveal","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-Up":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-/":"toggleComment",fallthrough:"devtools-common"},CodeMirror.keyMap["devtools-mac"]={"Cmd-A":"selectAll","Cmd-Z":"undoAndReveal","Shift-Cmd-Z":"redoAndReveal","Cmd-Up":"goDocStart","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineStartSmart","Cmd-Right":"goLineEnd","Alt-Backspace":"delGroupBefore","Alt-Delete":"delGroupAfter","Cmd-/":"toggleComment",fallthrough:"devtools-common"},WebInspector.settings.textEditorIndent.addChangeListener(this._updateEditorIndentation,this),this._updateEditorIndentation(),WebInspector.settings.showWhitespacesInEditor.addChangeListener(this._updateCodeMirrorMode,this),this._codeMirror.setOption("keyMap",WebInspector.isMac()?"devtools-mac":"devtools-pc"),this._codeMirror.setOption("flattenSpans",!1),this._codeMirror.setOption("maxHighlightLength",1e3),this._codeMirror.setOption("mode",null),this._shouldClearHistory=!0,this._lineSeparator="\n",this._tokenHighlighter=new WebInspector.CodeMirrorTextEditor.TokenHighlighter(this._codeMirror),this._blockIndentController=new WebInspector.CodeMirrorTextEditor.BlockIndentController(this._codeMirror),this._fixWordMovement=new WebInspector.CodeMirrorTextEditor.FixWordMovement(this._codeMirror),this._autocompleteController=new WebInspector.CodeMirrorTextEditor.AutocompleteController(this,this._codeMirror),this._codeMirror.on("change",this._change.bind(this)),this._codeMirror.on("beforeChange",this._beforeChange.bind(this)),this._codeMirror.on("gutterClick",this._gutterClick.bind(this)),this._codeMirror.on("cursorActivity",this._cursorActivity.bind(this)),this._codeMirror.on("scroll",this._scroll.bind(this)),this._codeMirror.on("focus",this._focus.bind(this)),this._codeMirror.on("blur",this._blur.bind(this)),this.element.addEventListener("contextmenu",this._contextMenu.bind(this),!1),this.element.addStyleClass("fill"),this.element.style.overflow="hidden",this.element.firstChild.addStyleClass("source-code"),this.element.firstChild.addStyleClass("fill"),this._elementToWidget=new Map,this._nestedUpdatesCounter=0,this.element.addEventListener("focus",this._handleElementFocus.bind(this),!1),this.element.addEventListener("keydown",this._handleKeyDown.bind(this),!0),this.element.tabIndex=0,this._setupSelectionColor(),this._setupWhitespaceHighlight()},WebInspector.CodeMirrorTextEditor.autocompleteCommand=function(e){e._codeMirrorTextEditor._autocompleteController.autocomplete()},CodeMirror.commands.autocomplete=WebInspector.CodeMirrorTextEditor.autocompleteCommand,CodeMirror.commands.smartNewlineAndIndent=function(e){function t(e){for(var t=0;t<e.length;++t)if(!WebInspector.TextUtils.isSpaceChar(e[t]))return t;return e.length}function n(e){var n=e.getCursor("start"),r=e.getLine(n.line),i=n.line>0?t(r):0;n.ch<=i?(e.replaceSelection("\n"+r.substring(0,n.ch),"end","+input"),e.setSelection(new CodeMirror.Pos(n.line+1,n.ch))):e.execCommand("newlineAndIndent")}e.operation(n.bind(this,e))},CodeMirror.commands.undoAndReveal=function(e){var t=e.getScrollInfo();e.execCommand("undo");var n=e.getCursor("start");e._codeMirrorTextEditor._innerRevealLine(n.line,t)},CodeMirror.commands.redoAndReveal=function(e){var t=e.getScrollInfo();e.execCommand("redo");var n=e.getCursor("start");e._codeMirrorTextEditor._innerRevealLine(n.line,t)},WebInspector.CodeMirrorTextEditor.LongLineModeLineLengthThreshold=2e3,WebInspector.CodeMirrorTextEditor.MaximumNumberOfWhitespacesPerSingleSpan=16,WebInspector.CodeMirrorTextEditor.prototype={wasShown:function(){this._codeMirror.refresh()},_guessIndentationLevel:function(){function r(r){var i=r.text;if(i.length===0||!WebInspector.TextUtils.isSpaceChar(i[0]))return;if(e.test(i)){++t;return}var s=0;while(s<i.length&&WebInspector.TextUtils.isSpaceChar(i[s]))++s;if(s%2!==0)return;n[s]=1+(n[s]||0)}var e=/^\t+/,t=0,n={};this._codeMirror.eachLine(r);var i=this.linesCount/100;if(t&&t>i)return"	";var s=Infinity;for(var o in n){if(n[o]<i)continue;var u=parseInt(o,10);s>u&&(s=u)}return s===Infinity?WebInspector.TextUtils.Indent.FourSpaces:(new Array(s+1)).join(" ")},_updateEditorIndentation:function(){var e={},t=WebInspector.settings.textEditorIndent.get();WebInspector.settings.textEditorAutoDetectIndent.get()&&(t=this._guessIndentationLevel()),t===WebInspector.TextUtils.Indent.TabCharacter?(this._codeMirror.setOption("indentWithTabs",!0),this._codeMirror.setOption("indentUnit",4)):(this._codeMirror.setOption("indentWithTabs",!1),this._codeMirror.setOption("indentUnit",t.length),e.Tab=function(e){if(e.somethingSelected())return CodeMirror.Pass;var n=e.getCursor("head");e.replaceRange(t.substring(n.ch%t.length),e.getCursor())}),this._codeMirror.setOption("extraKeys",e),this._indentationLevel=t},indent:function(){return this._indentationLevel},highlightSearchResults:function(e,t){function n(){t?(this.revealLine(t.startLine),this.setSelection(WebInspector.TextRange.createFromLocation(t.startLine,t.startColumn))):this.setSelection(this.selection().collapseToEnd()),this._tokenHighlighter.highlightSearchResults(e,t)}this._codeMirror.operation(n.bind(this))},cancelSearchResultsHighlight:function(){this._codeMirror.operation(this._tokenHighlighter.highlightSelectedTokens.bind(this._tokenHighlighter))},undo:function(){this._codeMirror.undo()},redo:function(){this._codeMirror.redo()},_setupSelectionColor:function(){if(WebInspector.CodeMirrorTextEditor._selectionStyleInjected)return;WebInspector.CodeMirrorTextEditor._selectionStyleInjected=!0;var e=WebInspector.getSelectionBackgroundColor(),t=e?".CodeMirror .CodeMirror-selected { background-color: "+e+";}":"",n=WebInspector.getSelectionForegroundColor(),r=n?".CodeMirror .CodeMirror-selectedtext:not(.CodeMirror-persist-highlight) { color: "+n+"!important;}":"";if(!r&&!t)return;var i=document.createElement("style");i.textContent=t+r,document.head.appendChild(i)},_setupWhitespaceHighlight:function(){if(WebInspector.CodeMirrorTextEditor._whitespaceStyleInjected||!WebInspector.settings.showWhitespacesInEditor.get())return;WebInspector.CodeMirrorTextEditor._whitespaceStyleInjected=!0;const e=".cm-whitespace-",t="Â·";var n="",r="";for(var i=1;i<=WebInspector.CodeMirrorTextEditor.MaximumNumberOfWhitespacesPerSingleSpan;++i){n+=t;var s=e+i+"::before { content: '"+n+"';}\n";r+=s}r+=".cm-tab:before { display: block !important; }\n";var o=document.createElement("style");o.textContent=r,document.head.appendChild(o)},_handleKeyDown:function(e){this._autocompleteController.keyDown(e)&&e.consume(!0)},_shouldProcessWordForAutocompletion:function(e){return e.length&&(e[0]<"0"||e[0]>"9")},_addTextToCompletionDictionary:function(e){var t=WebInspector.TextUtils.textToWords(e);for(var n=0;n<t.length;++n)this._shouldProcessWordForAutocompletion(t[n])&&this._dictionary.addWord(t[n])},_removeTextFromCompletionDictionary:function(e){var t=WebInspector.TextUtils.textToWords(e);for(var n=0;n<t.length;++n)this._shouldProcessWordForAutocompletion(t[n])&&this._dictionary.removeWord(t[n])},setCompletionDictionary:function(e){this._dictionary=e,this._addTextToCompletionDictionary(this.text())},cursorPositionToCoordinates:function(e,t){if(e>=this._codeMirror.lineCount()||e<0||t<0||t>this._codeMirror.getLine(e).length)return null;var n=this._codeMirror.cursorCoords(new CodeMirror.Pos(e,t));return{x:n.left,y:n.top,height:n.bottom-n.top}},coordinatesToCursorPosition:function(e,t){var n=document.elementFromPoint(e,t);if(!n||!n.isSelfOrDescendant(this._codeMirror.getWrapperElement()))return null;var r=this._codeMirror.getGutterElement().boxInWindow();if(e>=r.x&&e<=r.x+r.width&&t>=r.y&&t<=r.y+r.height)return null;var i=this._codeMirror.coordsChar({left:e,top:t});return this._toRange(i,i)},tokenAtTextPosition:function(e,t){if(e<0||e>=this._codeMirror.lineCount())return null;var n=this._codeMirror.getTokenAt(new CodeMirror.Pos(e,(t||0)+1));if(!n||!n.type)return null;var r=WebInspector.CodeMirrorUtils.convertTokenType(n.type);return r?{startColumn:n.start,endColumn:n.end-1,type:r}:null},copyRange:function(e){var t=this._toPos(e.normalize());return this._codeMirror.getRange(t.start,t.end)},isClean:function(){return this._codeMirror.isClean()},markClean:function(){this._codeMirror.markClean()},_hasLongLines:function(){function e(e){return e.text.length>WebInspector.CodeMirrorTextEditor.LongLineModeLineLengthThreshold&&(t=!0),t}var t=!1;return this._codeMirror.eachLine(e),t},_whitespaceOverlayMode:function(e){function n(t,n){function r(e){if(e.peek()===" "){var t=0;while(t<WebInspector.CodeMirrorTextEditor.MaximumNumberOfWhitespacesPerSingleSpan&&e.peek()===" ")++t,e.next();return"whitespace whitespace-"+t}while(!e.eol()&&e.peek()!==" ")e.next();return null}var i={token:r};return CodeMirror.overlayMode(CodeMirror.getMode(t,e),i,!1)}var t=CodeMirror.mimeModes[e]+"+whitespaces";return CodeMirror.modes[t]?t:(CodeMirror.defineMode(t,n),t)},_enableLongLinesMode:function(){this._codeMirror.setOption("styleSelectedText",!1),this._longLinesMode=!0},_disableLongLinesMode:function(){this._codeMirror.setOption("styleSelectedText",!0),this._longLinesMode=!1},_updateCodeMirrorMode:function(){var e=WebInspector.settings.showWhitespacesInEditor.get();this._codeMirror.setOption("mode",e?this._whitespaceOverlayMode(this._mimeType):this._mimeType)},setMimeType:function(e){this._mimeType=e,this._hasLongLines()?this._enableLongLinesMode():this._disableLongLinesMode(),this._updateCodeMirrorMode()},setReadOnly:function(e){this.element.enableStyleClass("CodeMirror-readonly",e),this._codeMirror.setOption("readOnly",e)},readOnly:function(){return!!this._codeMirror.getOption("readOnly")},removeHighlight:function(e){e.clear()},highlightRange:function(e,t){t="CodeMirror-persist-highlight "+t;var n=this._toPos(e);return++n.end.ch,this._codeMirror.markText(n.start,n.end,{className:t,startStyle:t+"-start",endStyle:t+"-end"})},highlightRegex:function(e,t){},defaultFocusedElement:function(){return this.element},focus:function(){this._codeMirror.focus()},_handleElementFocus:function(){this._codeMirror.focus()},beginUpdates:function(){++this._nestedUpdatesCounter},endUpdates:function(){--this._nestedUpdatesCounter||this._codeMirror.refresh()},revealLine:function(e){this._innerRevealLine(e,this._codeMirror.getScrollInfo())},_innerRevealLine:function(e,t){var n=this._codeMirror.lineAtHeight(t.top,"local"),r=this._codeMirror.lineAtHeight(t.top+t.clientHeight,"local"),i=r-n+1;if(e<n){var s=Math.max(e-i/2+1,0)|0;this._codeMirror.scrollIntoView(new CodeMirror.Pos(s,0))}else if(e>r){var o=Math.min(e+i/2-1,this.linesCount-1)|0;this._codeMirror.scrollIntoView(new CodeMirror.Pos(o,0))}},_gutterClick:function(e,t,n,r){this.dispatchEventToListeners(WebInspector.TextEditor.Events.GutterClick,{lineNumber:t,event:r})},_contextMenu:function(e){var t=new WebInspector.ContextMenu(e),n=e.target.enclosingNodeOrSelfWithClass("CodeMirror-gutter-elt");n?this._delegate.populateLineGutterContextMenu(t,parseInt(n.textContent,10)-1):this._delegate.populateTextAreaContextMenu(t,0),t.show()},addBreakpoint:function(e,t,n){if(e<0||e>=this._codeMirror.lineCount())return;var r="cm-breakpoint"+(n?" cm-breakpoint-conditional":"")+(t?" cm-breakpoint-disabled":"");this._codeMirror.addLineClass(e,"wrap",r)},removeBreakpoint:function(e){if(e<0||e>=this._codeMirror.lineCount())return;var t=this._codeMirror.getLineHandle(e).wrapClass;if(!t)return;var n=t.split(" ");for(var r=0;r<n.length;++r)n[r].startsWith("cm-breakpoint")&&this._codeMirror.removeLineClass(e,"wrap",n[r])},setExecutionLine:function(e){this._executionLine=this._codeMirror.getLineHandle(e),this._codeMirror.addLineClass(this._executionLine,"wrap","cm-execution-line")},clearExecutionLine:function(){this._executionLine&&this._codeMirror.removeLineClass(this._executionLine,"wrap","cm-execution-line"),delete this._executionLine},addDecoration:function(e,t){var n=this._codeMirror.addLineWidget(e,t);this._elementToWidget.put(t,n)},removeDecoration:function(e,t){var n=this._elementToWidget.remove(t);n&&this._codeMirror.removeLineWidget(n)},highlightPosition:function(e,t){if(e<0)return;e=Math.min(e,this._codeMirror.lineCount()-1);if(typeof t!="number"||t<0||t>this._codeMirror.getLine(e).length)t=0;this.clearPositionHighlight(),this._highlightedLine=this._codeMirror.getLineHandle(e);if(!this._highlightedLine)return;this.revealLine(e),this._codeMirror.addLineClass(this._highlightedLine,null,"cm-highlight"),this._clearHighlightTimeout=setTimeout(this.clearPositionHighlight.bind(this),2e3),this.readOnly()||this._codeMirror.setSelection(new CodeMirror.Pos(e,t))},clearPositionHighlight:function(){this._clearHighlightTimeout&&clearTimeout(this._clearHighlightTimeout),delete this._clearHighlightTimeout,this._highlightedLine&&this._codeMirror.removeLineClass(this._highlightedLine,null,"cm-highlight"),delete this._highlightedLine},elementsToRestoreScrollPositionsFor:function(){return[]},inheritScrollPositions:function(e){},_updatePaddingBottom:function(e,t){var n=this._codeMirror.getScrollInfo(),r,i=this.element.firstChild.querySelector(".CodeMirror-lines"),s=this._codeMirror.lineCount();s<=1?r=0:r=Math.max(n.clientHeight-this._codeMirror.getLineHandle(this._codeMirror.lastLine()).height,0),r+="px",i.style.paddingBottom=r,this._codeMirror.setSize(e,t)},_resizeEditor:function(){var e=this.element.parentElement;if(!e||!this.isShowing())return;var t=this._codeMirror.getScrollInfo(),n=e.offsetWidth,r=e.offsetHeight;this._codeMirror.setSize(n,r),this._updatePaddingBottom(n,r),this._codeMirror.scrollTo(t.left,t.top)},onResize:function(){this._resizeEditor()},editRange:function(e,t){var n=this._toPos(e);this._codeMirror.replaceRange(t,n.start,n.end);var r=this._toRange(n.start,this._codeMirror.posFromIndex(this._codeMirror.indexFromPos(n.start)+t.length));return this._delegate.onTextChanged(e,r),WebInspector.settings.textEditorAutoDetectIndent.get()&&this._updateEditorIndentation(),r},_wordRangeForCursorPosition:function(e,t,n){var r=this.line(e);if(t===0||!WebInspector.TextUtils.isWordChar(r.charAt(t-1)))return null;var i=t-1;while(i>0&&WebInspector.TextUtils.isWordChar(r.charAt(i-1)))--i;if(n)return new WebInspector.TextRange(e,i,e,t);var s=t;while(s<r.length&&WebInspector.TextUtils.isWordChar(r.charAt(s)))++s;return new WebInspector.TextRange(e,i,e,s)},_beforeChange:function(e,t){if(!this._dictionary)return;this._updatedLines=this._updatedLines||{};for(var n=t.from.line;n<=t.to.line;++n)this._updatedLines[n]=this.line(n)},_change:function(e,t){var n=this._codeMirror.lineCount()===1;n!==this._hasOneLine&&this._resizeEditor(),this._hasOneLine=n;var r=this._elementToWidget.values();for(var i=0;i<r.length;++i)this._codeMirror.removeLineWidget(r[i]);this._elementToWidget.clear();if(this._updatedLines){for(var s in this._updatedLines)this._removeTextFromCompletionDictionary(this._updatedLines[s]);delete this._updatedLines}var o={},u=!1;do{var a=this._toRange(t.from,t.to),f=a.clone(),l=t.text.length;u=t.origin==="+input"&&t.text.length===1&&t.text[0].length===1||t.origin==="+delete"&&t.removed.length===1&&t.removed[0].length===1,l===0?(f.endLine=f.startLine,f.endColumn=f.startColumn):l===1?(f.endLine=f.startLine,f.endColumn=f.startColumn+t.text[0].length):(f.endLine=f.startLine+l-1,f.endColumn=t.text[l-1].length),this._muteTextChangedEvent||this._delegate.onTextChanged(a,f);for(var i=f.startLine;i<=f.endLine;++i)o[i]=!0;if(this._dictionary)for(var i=f.startLine;i<=f.endLine;++i)o[i]=this.line(i)}while(t=t.next);if(this._dictionary)for(var s in o)this._addTextToCompletionDictionary(o[s]);u&&this._autocompleteController.autocomplete()},_cursorActivity:function(){var e=this._codeMirror.getCursor("anchor"),t=this._codeMirror.getCursor("head");this._delegate.selectionChanged(this._toRange(e,t)),this._tokenHighlighter.highlightedRegex()||this._codeMirror.operation(this._tokenHighlighter.highlightSelectedTokens.bind(this._tokenHighlighter))},_scroll:function(){this._scrollTimer&&clearTimeout(this._scrollTimer);var e=this._codeMirror.lineAtHeight(this._codeMirror.getScrollInfo().top,"local");this._scrollTimer=setTimeout(this._delegate.scrollChanged.bind(this._delegate,e),100)},_focus:function(){this._delegate.editorFocused()},_blur:function(){this._autocompleteController.finishAutocomplete()},scrollToLine:function(e){var t=new CodeMirror.Pos(e,0),n=this._codeMirror.charCoords(t,"local");this._codeMirror.scrollTo(0,n.top)},firstVisibleLine:function(){return this._codeMirror.lineAtHeight(this._codeMirror.getScrollInfo().top,"local")},lastVisibleLine:function(){var e=this._codeMirror.getScrollInfo();return this._codeMirror.lineAtHeight(e.top+e.clientHeight,"local")},selection:function(){var e=this._codeMirror.getCursor("anchor"),t=this._codeMirror.getCursor("head");return this._toRange(e,t)},lastSelection:function(){return this._lastSelection},setSelection:function(e){this._lastSelection=e;var t=this._toPos(e);this._codeMirror.setSelection(t.start,t.end)},_detectLineSeparator:function(e){this._lineSeparator=e.indexOf("\r\n")>=0?"\r\n":"\n"},setText:function(e){this._muteTextChangedEvent=!0,this._codeMirror.setValue(e),this._updateEditorIndentation(),this._shouldClearHistory&&(this._codeMirror.clearHistory(),this._shouldClearHistory=!1),this._detectLineSeparator(e),delete this._muteTextChangedEvent},text:function(){return this._codeMirror.getValue().replace(/\n/g,this._lineSeparator)},range:function(){var e=this.linesCount,t=this._codeMirror.getLine(e-1);return this._toRange(new CodeMirror.Pos(0,0),new CodeMirror.Pos(e-1,t.length))},line:function(e){return this._codeMirror.getLine(e)},get linesCount(){return this._codeMirror.lineCount()},setAttribute:function(e,t,n){if(e<0||e>=this._codeMirror.lineCount())return;var r=this._codeMirror.getLineHandle(e);r.attributes===undefined&&(r.attributes={}),r.attributes[t]=n},getAttribute:function(e,t){if(e<0||e>=this._codeMirror.lineCount())return null;var n=this._codeMirror.getLineHandle(e);return n.attributes&&n.attributes[t]!==undefined?n.attributes[t]:null},removeAttribute:function(e,t){if(e<0||e>=this._codeMirror.lineCount())return;var n=this._codeMirror.getLineHandle(e);n&&n.attributes&&delete n.attributes[t]},_toPos:function(e){return{start:new CodeMirror.Pos(e.startLine,e.startColumn),end:new CodeMirror.Pos(e.endLine,e.endColumn)}},_toRange:function(e,t){return new WebInspector.TextRange(e.line,e.ch,t.line,t.ch)},__proto__:WebInspector.View.prototype},WebInspector.CodeMirrorTextEditor.TokenHighlighter=function(e){this._codeMirror=e},WebInspector.CodeMirrorTextEditor.TokenHighlighter.prototype={highlightSearchResults:function(e,t){var n=this._highlightRegex;this._highlightRegex=e,this._highlightRange=t,this._searchResultMarker&&(this._searchResultMarker.clear(),delete this._searchResultMarker),this._highlightDescriptor&&this._highlightDescriptor.selectionStart&&this._codeMirror.removeLineClass(this._highlightDescriptor.selectionStart.line,"wrap","cm-line-with-selection");var r=this._highlightRange?new CodeMirror.Pos(this._highlightRange.startLine,this._highlightRange.startColumn):null;r&&this._codeMirror.addLineClass(r.line,"wrap","cm-line-with-selection"),this._highlightRegex===n?this._highlightDescriptor&&(this._highlightDescriptor.selectionStart=r):(this._removeHighlight(),this._setHighlighter(this._searchHighlighter.bind(this,this._highlightRegex,this._highlightRange),r));if(r){var i=WebInspector.CodeMirrorTextEditor.prototype._toPos(this._highlightRange);this._searchResultMarker=this._codeMirror.markText(i.start,i.end,{className:"cm-column-with-selection"})}},highlightedRegex:function(){return this._highlightRegex},highlightSelectedTokens:function(){delete this._highlightRegex,delete this._highlightRange,this._highlightDescriptor&&this._highlightDescriptor.selectionStart&&this._codeMirror.removeLineClass(this._highlightDescriptor.selectionStart.line,"wrap","cm-line-with-selection"),this._removeHighlight();var e=this._codeMirror.getCursor("start"),t=this._codeMirror.getCursor("end");if(e.line!==t.line)return;if(e.ch===t.ch)return;var n=this._codeMirror.getSelection();this._isWord(n,e.line,e.ch,t.ch)&&(e&&this._codeMirror.addLineClass(e.line,"wrap","cm-line-with-selection"),this._setHighlighter(this._tokenHighlighter.bind(this,n,e),e))},_isWord:function(e,t,n,r){var i=this._codeMirror.getLine(t),s=n===0||!WebInspector.TextUtils.isWordChar(i.charAt(n-1)),o=r===i.length||!WebInspector.TextUtils.isWordChar(i.charAt(r));return s&&o&&WebInspector.TextUtils.isWord(e)},_removeHighlight:function(){this._highlightDescriptor&&(this._codeMirror.removeOverlay(this._highlightDescriptor.overlay),delete this._highlightDescriptor)},_searchHighlighter:function(e,t,n){n.column()===0&&delete this._searchMatchLength;if(this._searchMatchLength){if(this._searchMatchLength>1){for(var r=0;r<this._searchMatchLength-2;++r)n.next();return this._searchMatchLength=1,"search-highlight"}return n.next(),delete this._searchMatchLength,"search-highlight search-highlight-end"}var i=n.match(e,!1);if(i){n.next();var s=i[0].length;return s===1?"search-highlight search-highlight-full":(this._searchMatchLength=s,"search-highlight search-highlight-start")}while(!n.match(e,!1)&&n.next());},_tokenHighlighter:function(e,t,n){var r=e.charAt(0);if(n.match(e)&&(n.eol()||!WebInspector.TextUtils.isWordChar(n.peek())))return n.column()===t.ch?"token-highlight column-with-selection":"token-highlight";var i;do i=n.next();while(i&&(WebInspector.TextUtils.isWordChar(i)||n.peek()!==r))},_setHighlighter:function(e,t){var n={token:e};this._codeMirror.addOverlay(n),this._highlightDescriptor={overlay:n,selectionStart:t}}},WebInspector.CodeMirrorTextEditor.BlockIndentController=function(e){e.addKeyMap(this)},WebInspector.CodeMirrorTextEditor.BlockIndentController.prototype={name:"blockIndentKeymap",Enter:function(e){if(e.somethingSelected())return CodeMirror.Pass;var t=e.getCursor();if(t.ch===0)return CodeMirror.Pass;var n=e.getLine(t.line);if(n.substr(t.ch-1,2)==="{}")e.execCommand("newlineAndIndent"),e.setCursor(t),e.execCommand("newlineAndIndent"),e.execCommand("indentMore");else{if(n.substr(t.ch-1,1)!=="{")return CodeMirror.Pass;e.execCommand("newlineAndIndent"),e.execCommand("indentMore")}},"'}'":function(e){var t=e.getCursor(),n=e.getLine(t.line);for(var r=0;r<n.length;++r)if(!WebInspector.TextUtils.isSpaceChar(n.charAt(r)))return CodeMirror.Pass;e.replaceRange("}",t);var i=e.findMatchingBracket();if(!i||!i.match)return;n=e.getLine(i.to.line);var s=0;while(s<n.length&&WebInspector.TextUtils.isSpaceChar(n.charAt(s)))++s;e.replaceRange(n.substr(0,s)+"}",new CodeMirror.Pos(t.line,0),new CodeMirror.Pos(t.line,t.ch+1))}},WebInspector.CodeMirrorTextEditor.FixWordMovement=function(e){function t(e,t){var n=t.getCursor("head");if(n.ch!==0||n.line===0)return CodeMirror.Pass;t.setExtending(e),t.execCommand("goLineUp"),t.execCommand("goLineEnd"),t.setExtending(!1)}function n(e,t){var n=t.getCursor("head"),r=t.getLine(n.line);if(n.ch!==r.length||n.line+1===t.lineCount())return CodeMirror.Pass;t.setExtending(e),t.execCommand("goLineDown"),t.execCommand("goLineStart"),t.setExtending(!1)}function r(e){if(e.somethingSelected())return CodeMirror.Pass;var t=e.getCursor("head");if(t.ch!==0)return CodeMirror.Pass;e.execCommand("delCharBefore")}var i=WebInspector.isMac()?"Alt":"Ctrl",s=i+"-Left",o=i+"-Right",u={};u[s]=t.bind(this,!1),u[o]=n.bind(this,!1),u["Shift-"+s]=t.bind(this,!0),u["Shift-"+o]=n.bind(this,!0),u[i+"-Backspace"]=r.bind(this),e.addKeyMap(u)},WebInspector.CodeMirrorTextEditor.AutocompleteController=function(e,t){this._textEditor=e,this._codeMirror=t,this._codeMirror.on("scroll",this._onScroll.bind(this)),this._codeMirror.on("cursorActivity",this._onCursorActivity.bind(this))},WebInspector.CodeMirrorTextEditor.AutocompleteController.prototype={autocomplete:function(){function u(t,n){return e.wordCount(n)-e.wordCount(t)||t.length-n.length}var e=this._textEditor._dictionary;if(!e||this._codeMirror.somethingSelected()){this.finishAutocomplete();return}var t=this._codeMirror.getCursor(),n=this._textEditor._wordRangeForCursorPosition(t.line,t.ch,!1);if(!n||n.startColumn===t.ch){this.finishAutocomplete();return}var r=n.clone();r.endColumn=t.ch;var i=this._textEditor.copyRange(n),s=e.hasWord(i);s&&e.removeWord(i);var o=e.wordsWithPrefix(this._textEditor.copyRange(r));s&&e.addWord(i),o.sort(u),this._suggestBox||(this._suggestBox=new WebInspector.SuggestBox(this,this._textEditor.element,"generic-suggest",6),this._anchorBox=this._anchorBoxForPosition(t.line,t.ch)),this._suggestBox.updateSuggestions(this._anchorBox,o,0,!0,this._textEditor.copyRange(r)),this._prefixRange=r,this._suggestBox.visible()||this.finishAutocomplete()},finishAutocomplete:function(){if(!this._suggestBox)return;this._suggestBox.hide(),this._suggestBox=null,this._prefixRange=null,this._anchorBox=null},keyDown:function(e){return this._suggestBox?e.keyCode===WebInspector.KeyboardShortcut.Keys.Esc.code?(this.finishAutocomplete(),!0):e.keyCode===WebInspector.KeyboardShortcut.Keys.Tab.code?(this._suggestBox.acceptSuggestion(),this.finishAutocomplete(),!0):this._suggestBox.keyPressed(e):!1},applySuggestion:function(e,t){this._currentSuggestion=e},acceptSuggestion:function(){if(this._prefixRange.endColumn-this._prefixRange.startColumn!==this._currentSuggestion.length){var e=this._textEditor._toPos(this._prefixRange);this._codeMirror.replaceRange(this._currentSuggestion,e.start,e.end,"+autocomplete")}},_onScroll:function(){if(!this._suggestBox)return;var e=this._codeMirror.getCursor(),t=this._codeMirror.getScrollInfo(),n=this._codeMirror.lineAtHeight(t.top,"local"),r=this._codeMirror.lineAtHeight(t.top+t.clientHeight,"local");e.line<n||e.line>r?this.finishAutocomplete():(this._anchorBox=this._anchorBoxForPosition(e.line,e.ch),this._suggestBox.setPosition(this._anchorBox))},_onCursorActivity:function(){if(!this._suggestBox)return;var e=this._codeMirror.getCursor();(e.line!==this._prefixRange.startLine||e.ch>this._prefixRange.endColumn||e.ch<this._prefixRange.startColumn)&&this.finishAutocomplete()},_anchorBoxForPosition:function(e,t){var n=this._textEditor.cursorPositionToCoordinates(e,t);return n?new AnchorBox(n.x,n.y,0,n.height):null}};