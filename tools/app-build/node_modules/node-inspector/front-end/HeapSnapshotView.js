/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.HeapSnapshotView=function(e,t){function s(e){var t=this._profiles(),n;for(var r=0;r<t.length;++r)if(t[r].uid===this._profileUid){n=r;break}n>0?this.baseSelect.setSelectedIndex(n-1):this.baseSelect.setSelectedIndex(n),this.dataGrid.setDataSource(e)}WebInspector.View.call(this),this.element.addStyleClass("heap-snapshot-view"),this.parent=e,this.parent.addEventListener("profile added",this._onProfileHeaderAdded,this),t._profileType.id===WebInspector.TrackingHeapSnapshotProfileType.TypeId&&(this._trackingOverviewGrid=new WebInspector.HeapTrackingOverviewGrid(t),this._trackingOverviewGrid.addEventListener(WebInspector.HeapTrackingOverviewGrid.IdsRangeChanged,this._onIdsRangeChanged.bind(this)),this._trackingOverviewGrid.show(this.element)),this.viewsContainer=document.createElement("div"),this.viewsContainer.addStyleClass("views-container"),this.element.appendChild(this.viewsContainer),this.containmentView=new WebInspector.View,this.containmentView.element.addStyleClass("view"),this.containmentDataGrid=new WebInspector.HeapSnapshotContainmentDataGrid,this.containmentDataGrid.element.addEventListener("mousedown",this._mouseDownInContentsGrid.bind(this),!0),this.containmentDataGrid.show(this.containmentView.element),this.containmentDataGrid.addEventListener(WebInspector.DataGrid.Events.SelectedNode,this._selectionChanged,this),this.constructorsView=new WebInspector.View,this.constructorsView.element.addStyleClass("view"),this.constructorsView.element.appendChild(this._createToolbarWithClassNameFilter()),this.constructorsDataGrid=new WebInspector.HeapSnapshotConstructorsDataGrid,this.constructorsDataGrid.element.addStyleClass("class-view-grid"),this.constructorsDataGrid.element.addEventListener("mousedown",this._mouseDownInContentsGrid.bind(this),!0),this.constructorsDataGrid.show(this.constructorsView.element),this.constructorsDataGrid.addEventListener(WebInspector.DataGrid.Events.SelectedNode,this._selectionChanged,this),this.dataGrid=this.constructorsDataGrid,this.currentView=this.constructorsView,this.currentView.show(this.viewsContainer),this.diffView=new WebInspector.View,this.diffView.element.addStyleClass("view"),this.diffView.element.appendChild(this._createToolbarWithClassNameFilter()),this.diffDataGrid=new WebInspector.HeapSnapshotDiffDataGrid,this.diffDataGrid.element.addStyleClass("class-view-grid"),this.diffDataGrid.show(this.diffView.element),this.diffDataGrid.addEventListener(WebInspector.DataGrid.Events.SelectedNode,this._selectionChanged,this),this.dominatorView=new WebInspector.View,this.dominatorView.element.addStyleClass("view"),this.dominatorDataGrid=new WebInspector.HeapSnapshotDominatorsDataGrid,this.dominatorDataGrid.element.addEventListener("mousedown",this._mouseDownInContentsGrid.bind(this),!0),this.dominatorDataGrid.show(this.dominatorView.element),this.dominatorDataGrid.addEventListener(WebInspector.DataGrid.Events.SelectedNode,this._selectionChanged,this),this.retainmentViewHeader=document.createElement("div"),this.retainmentViewHeader.addStyleClass("retainers-view-header"),WebInspector.installDragHandle(this.retainmentViewHeader,this._startRetainersHeaderDragging.bind(this),this._retainersHeaderDragging.bind(this),this._endRetainersHeaderDragging.bind(this),"row-resize");var n=document.createElement("div");n.className="title";var r=document.createElement("span");r.textContent=WebInspector.UIString("Object's retaining tree"),n.appendChild(r),this.retainmentViewHeader.appendChild(n),this.element.appendChild(this.retainmentViewHeader),this.retainmentView=new WebInspector.View,this.retainmentView.element.addStyleClass("view"),this.retainmentView.element.addStyleClass("retaining-paths-view"),this.retainmentDataGrid=new WebInspector.HeapSnapshotRetainmentDataGrid,this.retainmentDataGrid.show(this.retainmentView.element),this.retainmentDataGrid.addEventListener(WebInspector.DataGrid.Events.SelectedNode,this._inspectedObjectChanged,this),this.retainmentView.show(this.element),this.retainmentDataGrid.reset(),this.viewSelect=new WebInspector.StatusBarComboBox(this._onSelectedViewChanged.bind(this)),this.views=[{title:"Summary",view:this.constructorsView,grid:this.constructorsDataGrid},{title:"Comparison",view:this.diffView,grid:this.diffDataGrid},{title:"Containment",view:this.containmentView,grid:this.containmentDataGrid}],WebInspector.settings.showAdvancedHeapSnapshotProperties.get()&&this.views.push({title:"Dominators",view:this.dominatorView,grid:this.dominatorDataGrid}),this.views.current=0;for(var i=0;i<this.views.length;++i)this.viewSelect.createOption(WebInspector.UIString(this.views[i].title));this._profileUid=t.uid,this._profileTypeId=t.profileType().id,this.baseSelect=new WebInspector.StatusBarComboBox(this._changeBase.bind(this)),this.baseSelect.element.addStyleClass("hidden"),this._updateBaseOptions(),this.filterSelect=new WebInspector.StatusBarComboBox(this._changeFilter.bind(this)),this._updateFilterOptions(),this.selectedSizeText=new WebInspector.StatusBarText(""),this._popoverHelper=new WebInspector.ObjectPopoverHelper(this.element,this._getHoverAnchor.bind(this),this._resolveObjectForPopover.bind(this),undefined,!0),this.profile.load(s.bind(this))},WebInspector.HeapSnapshotView.prototype={_onIdsRangeChanged:function(e){var t=e.data.minId,n=e.data.maxId;this.selectedSizeText.setText(WebInspector.UIString("Selected size: %s",Number.bytesToString(e.data.size))),this.constructorsDataGrid.snapshot&&this.constructorsDataGrid.setSelectionRange(t,n)},dispose:function(){this.parent.removeEventListener("profile added",this._onProfileHeaderAdded,this),this.profile.dispose(),this.baseProfile&&this.baseProfile.dispose(),this.containmentDataGrid.dispose(),this.constructorsDataGrid.dispose(),this.diffDataGrid.dispose(),this.dominatorDataGrid.dispose(),this.retainmentDataGrid.dispose()},get statusBarItems(){return[this.viewSelect.element,this.baseSelect.element,this.filterSelect.element,this.selectedSizeText.element]},get profile(){return this.parent.getProfile(this._profileTypeId,this._profileUid)},get baseProfile(){return this.parent.getProfile(this._profileTypeId,this._baseProfileUid)},wasShown:function(){function e(){this.profile._wasShown(),this.baseProfile&&this.baseProfile.load(function(){})}this.profile.load(e.bind(this))},willHide:function(){this._currentSearchResultIndex=-1,this._popoverHelper.hidePopover(),this.helpPopover&&this.helpPopover.isShowing()&&this.helpPopover.hide()},onResize:function(){var e=this.retainmentView.element.clientHeight;this._updateRetainmentViewHeight(e)},searchCanceled:function(){if(this._searchResults)for(var e=0;e<this._searchResults.length;++e){var t=this._searchResults[e].node;delete t._searchMatched,t.refresh()}delete this._searchFinishedCallback,this._currentSearchResultIndex=-1,this._searchResults=[]},performSearch:function(e,t){function i(e){return"_name"in e&&n.test(e._name)}function s(e){return"snapshotNodeId"in e&&e.snapshotNodeId===r}function u(e){return delete e._searchMatched,o(e)?(e._searchMatched=!0,e.refresh(),!0):!1}this.searchCanceled(),e=e.trim();if(!e)return;if(this.currentView!==this.constructorsView&&this.currentView!==this.diffView)return;this._searchFinishedCallback=t;var n=createPlainTextSearchRegex(e,"i"),r=null,o;e.charAt(0)!=="@"?o=i:(r=parseInt(e.substring(1),10),o=s);var a=this.dataGrid.rootNode().children[0],f=0,l={};const c=1;while(a)u(a)&&this._searchResults.push({node:a}),a=a.traverseNextNode(!1,null,f>=c,l),f+=l.depthChange;t(this,this._searchResults.length)},jumpToFirstSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;this._currentSearchResultIndex=0,this._jumpToSearchResult(this._currentSearchResultIndex)},jumpToLastSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;this._currentSearchResultIndex=this._searchResults.length-1,this._jumpToSearchResult(this._currentSearchResultIndex)},jumpToNextSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;++this._currentSearchResultIndex>=this._searchResults.length&&(this._currentSearchResultIndex=0),this._jumpToSearchResult(this._currentSearchResultIndex)},jumpToPreviousSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;--this._currentSearchResultIndex<0&&(this._currentSearchResultIndex=this._searchResults.length-1),this._jumpToSearchResult(this._currentSearchResultIndex)},showingFirstSearchResult:function(){return this._currentSearchResultIndex===0},showingLastSearchResult:function(){return this._searchResults&&this._currentSearchResultIndex===this._searchResults.length-1},_jumpToSearchResult:function(e){var t=this._searchResults[e];if(!t)return;var n=t.node;n.revealAndSelect()},refreshVisibleData:function(){var e=this.dataGrid.rootNode().children[0];while(e)e.refresh(),e=e.traverseNextNode(!1,null,!0)},_changeBase:function(){if(this._baseProfileUid===this._profiles()[this.baseSelect.selectedIndex()].uid)return;this._baseProfileUid=this._profiles()[this.baseSelect.selectedIndex()].uid;var e=this.dataGrid;e.snapshot&&this.baseProfile.load(e.setBaseDataSource.bind(e));if(!this.currentQuery||!this._searchFinishedCallback||!this._searchResults)return;this._searchFinishedCallback(this,-this._searchResults.length),this.performSearch(this.currentQuery,this._searchFinishedCallback)},_changeFilter:function(){var e=this.filterSelect.selectedIndex()-1;this.dataGrid.filterSelectIndexChanged(this._profiles(),e),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.HeapSnapshotFilterChanged,label:this.filterSelect.selectedOption().label});if(!this.currentQuery||!this._searchFinishedCallback||!this._searchResults)return;this._searchFinishedCallback(this,-this._searchResults.length),this.performSearch(this.currentQuery,this._searchFinishedCallback)},_createToolbarWithClassNameFilter:function(){var e=document.createElement("div");e.addStyleClass("class-view-toolbar");var t=document.createElement("input");return t.addStyleClass("class-name-filter"),t.setAttribute("placeholder",WebInspector.UIString("Class filter")),t.addEventListener("keyup",this._changeNameFilter.bind(this,t),!1),e.appendChild(t),e},_changeNameFilter:function(e){var t=e.value;this.dataGrid.changeNameFilter(t)},_profiles:function(){return this.parent.getProfileType(this._profileTypeId).getProfiles()},populateContextMenu:function(e,t){this.dataGrid.populateContextMenu(this.parent,e,t)},_selectionChanged:function(e){var t=e.target.selectedNode;this._setRetainmentDataGridSource(t),this._inspectedObjectChanged(e)},_inspectedObjectChanged:function(e){var t=e.target.selectedNode;!this.profile.fromFile()&&t instanceof WebInspector.HeapSnapshotGenericObjectNode&&ConsoleAgent.addInspectedHeapObject(t.snapshotNodeId)},_setRetainmentDataGridSource:function(e){e&&e.snapshotNodeIndex?this.retainmentDataGrid.setDataSource(e.isDeletedNode?e.dataGrid.baseSnapshot:e.dataGrid.snapshot,e.snapshotNodeIndex):this.retainmentDataGrid.reset()},_mouseDownInContentsGrid:function(e){if(e.detail<2)return;var t=e.target.enclosingNodeOrSelfWithNodeName("td");if(!t||!t.hasStyleClass("count-column")&&!t.hasStyleClass("shallowSize-column")&&!t.hasStyleClass("retainedSize-column"))return;e.consume(!0)},changeView:function(e,t){function i(e){var n=e.data;n.removeEventListener(WebInspector.HeapSnapshotSortableDataGrid.Events.ContentShown,i,this),n===this.dataGrid&&t()}var n=null;for(var r=0;r<this.views.length;++r)if(this.views[r].title===e){n=r;break}if(this.views.current===n||n==null){setTimeout(t,0);return}this.views[n].grid.addEventListener(WebInspector.HeapSnapshotSortableDataGrid.Events.ContentShown,i,this),this.viewSelect.setSelectedIndex(n),this._changeView(n)},_updateDataSourceAndView:function(){function t(t){if(this.dataGrid!==e)return;e.snapshot!==t&&e.setDataSource(t),e===this.diffDataGrid&&(this._baseProfileUid||(this._baseProfileUid=this._profiles()[this.baseSelect.selectedIndex()].uid),this.baseProfile.load(n.bind(this)))}function n(e){this.diffDataGrid.baseSnapshot!==e&&this.diffDataGrid.setBaseDataSource(e)}var e=this.dataGrid;if(e.snapshot)return;this.profile.load(t.bind(this))},_onSelectedViewChanged:function(e){this._changeView(e.target.selectedIndex)},_updateSelectorsVisibility:function(){this.currentView===this.diffView?this.baseSelect.element.removeStyleClass("hidden"):this.baseSelect.element.addStyleClass("hidden"),this.currentView===this.constructorsView?(this._trackingOverviewGrid&&(this._trackingOverviewGrid.element.removeStyleClass("hidden"),this._trackingOverviewGrid.update(),this.viewsContainer.addStyleClass("reserve-80px-at-top")),this.filterSelect.element.removeStyleClass("hidden")):(this.filterSelect.element.addStyleClass("hidden"),this._trackingOverviewGrid&&(this._trackingOverviewGrid.element.addStyleClass("hidden"),this.viewsContainer.removeStyleClass("reserve-80px-at-top")))},_changeView:function(e){if(e===this.views.current)return;this.views.current=e,this.currentView.detach();var t=this.views[this.views.current];this.currentView=t.view,this.dataGrid=t.grid,this.currentView.show(this.viewsContainer),this.refreshVisibleData(),this.dataGrid.updateWidths(),this._updateSelectorsVisibility(),this._updateDataSourceAndView();if(!this.currentQuery||!this._searchFinishedCallback||!this._searchResults)return;this._searchFinishedCallback(this,-this._searchResults.length),this.performSearch(this.currentQuery,this._searchFinishedCallback)},_getHoverAnchor:function(e){var t=e.enclosingNodeOrSelfWithNodeName("span");if(!t)return;var n=e.enclosingNodeOrSelfWithNodeName("tr");if(!n)return;return t.node=n._dataGridNode,t},_resolveObjectForPopover:function(e,t,n){if(this.profile.fromFile())return;e.node.queryObjectContent(t,n)},_startRetainersHeaderDragging:function(e){return this.isShowing()?(this._previousDragPosition=e.pageY,!0):!1},_retainersHeaderDragging:function(e){var t=this.retainmentView.element.clientHeight;t+=this._previousDragPosition-e.pageY,this._previousDragPosition=e.pageY,this._updateRetainmentViewHeight(t),e.consume(!0)},_endRetainersHeaderDragging:function(e){delete this._previousDragPosition,e.consume()},_updateRetainmentViewHeight:function(e){e=Number.constrain(e,Preferences.minConsoleHeight,this.element.clientHeight-Preferences.minConsoleHeight),this.viewsContainer.style.bottom=e+this.retainmentViewHeader.clientHeight+"px",this._trackingOverviewGrid&&this.currentView===this.constructorsView&&this.viewsContainer.addStyleClass("reserve-80px-at-top"),this.retainmentView.element.style.height=e+"px",this.retainmentViewHeader.style.bottom=e+"px",this.currentView.doResize()},_updateBaseOptions:function(){var e=this._profiles();if(this.baseSelect.size()===e.length)return;for(var t=this.baseSelect.size(),n=e.length;t<n;++t){var r=e[t].title;WebInspector.ProfilesPanelDescriptor.isUserInitiatedProfile(r)&&(r=WebInspector.UIString("Snapshot %d",WebInspector.ProfilesPanelDescriptor.userInitiatedProfileIndex(r))),this.baseSelect.createOption(r)}},_updateFilterOptions:function(){var e=this._profiles();if(this.filterSelect.size()-1===e.length)return;this.filterSelect.size()||this.filterSelect.createOption(WebInspector.UIString("All objects"));if(this.profile.fromFile())return;for(var t=this.filterSelect.size()-1,n=e.length;t<n;++t){var r=e[t],i=e[t].title;if(WebInspector.ProfilesPanelDescriptor.isUserInitiatedProfile(i)){var s=WebInspector.ProfilesPanelDescriptor.userInitiatedProfileIndex(i);t?i=WebInspector.UIString("Objects allocated between Snapshots %d and %d",s-1,s):i=WebInspector.UIString("Objects allocated before Snapshot %d",s)}this.filterSelect.createOption(i)}},_onProfileHeaderAdded:function(e){if(!e.data||e.data.type!==this._profileTypeId)return;this._updateBaseOptions(),this._updateFilterOptions()},__proto__:WebInspector.View.prototype},WebInspector.HeapProfilerDispatcher=function(){this._dispatchers=[],InspectorBackend.registerHeapProfilerDispatcher(this)},WebInspector.HeapProfilerDispatcher.prototype={register:function(e){this._dispatchers.push(e)},_genericCaller:function(e){var t=Array.prototype.slice.call(arguments.callee.caller.arguments);for(var n=0;n<this._dispatchers.length;++n)this._dispatchers[n][e].apply(this._dispatchers[n],t)},heapStatsUpdate:function(e){this._genericCaller("heapStatsUpdate")},lastSeenObjectId:function(e,t){this._genericCaller("lastSeenObjectId")},addProfileHeader:function(e){this._genericCaller("addProfileHeader")},addHeapSnapshotChunk:function(e,t){this._genericCaller("addHeapSnapshotChunk")},finishHeapSnapshot:function(e){this._genericCaller("finishHeapSnapshot")},reportHeapSnapshotProgress:function(e,t){this._genericCaller("reportHeapSnapshotProgress")},resetProfiles:function(){this._genericCaller("resetProfiles")}},WebInspector.HeapProfilerDispatcher._dispatcher=new WebInspector.HeapProfilerDispatcher,WebInspector.HeapSnapshotProfileType=function(){WebInspector.ProfileType.call(this,WebInspector.HeapSnapshotProfileType.TypeId,WebInspector.UIString("Take Heap Snapshot")),WebInspector.HeapProfilerDispatcher._dispatcher.register(this)},WebInspector.HeapSnapshotProfileType.TypeId="HEAP",WebInspector.HeapSnapshotProfileType.SnapshotReceived="SnapshotReceived",WebInspector.HeapSnapshotProfileType.prototype={fileExtension:function(){return".heapsnapshot"},get buttonTooltip(){return WebInspector.UIString("Take heap snapshot.")},isInstantProfile:function(){return!0},buttonClicked:function(){return this._takeHeapSnapshot(function(){}),WebInspector.userMetrics.ProfilesHeapProfileTaken.record(),!1},heapStatsUpdate:function(e){},lastSeenObjectId:function(e,t){},get treeItemTitle(){return WebInspector.UIString("HEAP SNAPSHOTS")},get description(){return WebInspector.UIString("Heap snapshot profiles show memory distribution among your page's JavaScript objects and related DOM nodes.")},createTemporaryProfile:function(e){return e=e||WebInspector.UIString("Snapshotting…"),new WebInspector.HeapProfileHeader(this,e)},createProfile:function(e){return new WebInspector.HeapProfileHeader(this,e.title,e.uid,e.maxJSObjectId||0)},_takeHeapSnapshot:function(e){var t=this.findTemporaryProfile();t||this.addProfile(this.createTemporaryProfile()),HeapProfilerAgent.takeHeapSnapshot(!0,e)},addProfileHeader:function(e){if(!this.findTemporaryProfile())return;var t=this.createProfile(e);t._profileSamples=this._profileSamples,this._profileSamples=null,this.addProfile(t)},addHeapSnapshotChunk:function(e,t){var n=this._profilesIdMap[this._makeKey(e)];n&&n.transferChunk(t)},finishHeapSnapshot:function(e){var t=this._profilesIdMap[this._makeKey(e)];t&&t.finishHeapSnapshot()},reportHeapSnapshotProgress:function(e,t){var n=this.findTemporaryProfile();n&&this.dispatchEventToListeners(WebInspector.ProfileType.Events.ProgressUpdated,{profile:n,done:e,total:t})},resetProfiles:function(){this._reset()},removeProfile:function(e){WebInspector.ProfileType.prototype.removeProfile.call(this,e),e.isTemporary||HeapProfilerAgent.removeProfile(e.uid)},_requestProfilesFromBackend:function(e){HeapProfilerAgent.getProfileHeaders(e)},_snapshotReceived:function(e){this.dispatchEventToListeners(WebInspector.HeapSnapshotProfileType.SnapshotReceived,e)},__proto__:WebInspector.ProfileType.prototype},WebInspector.TrackingHeapSnapshotProfileType=function(e){WebInspector.ProfileType.call(this,WebInspector.TrackingHeapSnapshotProfileType.TypeId,WebInspector.UIString("Record Heap Allocations")),this._profilesPanel=e,WebInspector.HeapProfilerDispatcher._dispatcher.register(this)},WebInspector.TrackingHeapSnapshotProfileType.TypeId="HEAP-RECORD",WebInspector.TrackingHeapSnapshotProfileType.HeapStatsUpdate="HeapStatsUpdate",WebInspector.TrackingHeapSnapshotProfileType.TrackingStarted="TrackingStarted",WebInspector.TrackingHeapSnapshotProfileType.TrackingStopped="TrackingStopped",WebInspector.TrackingHeapSnapshotProfileType.prototype={heapStatsUpdate:function(e){if(!this._profileSamples)return;var t;for(var n=0;n<e.length;n+=3){t=e[n];var r=e[n+1],i=e[n+2];this._profileSamples.sizes[t]=i;if(!this._profileSamples.max[t]||i>this._profileSamples.max[t])this._profileSamples.max[t]=i}this._lastUpdatedIndex=t},lastSeenObjectId:function(e,t){var n=this._profileSamples;if(!n)return;var r=Math.max(n.ids.length,n.max.length-1);n.ids[r]=e,n.max[r]||(n.max[r]=0,n.sizes[r]=0),n.timestamps[r]=t,n.totalTime<t-n.timestamps[0]&&(n.totalTime*=2),this.dispatchEventToListeners(WebInspector.TrackingHeapSnapshotProfileType.HeapStatsUpdate,this._profileSamples);var i=this.findTemporaryProfile();i.sidebarElement.wait=!0,i.sidebarElement&&!i.sidebarElement.wait&&(i.sidebarElement.wait=!0)},hasTemporaryView:function(){return!0},get buttonTooltip(){return this._recording?WebInspector.UIString("Stop recording heap profile."):WebInspector.UIString("Start recording heap profile.")},isInstantProfile:function(){return!1},buttonClicked:function(){return this._toggleRecording()},_startRecordingProfile:function(){this._lastSeenIndex=-1,this._profileSamples={sizes:[],ids:[],timestamps:[],max:[],totalTime:3e4},this._recording=!0,HeapProfilerAgent.startTrackingHeapObjects(),this.dispatchEventToListeners(WebInspector.TrackingHeapSnapshotProfileType.TrackingStarted)},_stopRecordingProfile:function(){HeapProfilerAgent.stopTrackingHeapObjects(),HeapProfilerAgent.takeHeapSnapshot(!0),this._recording=!1,this.dispatchEventToListeners(WebInspector.TrackingHeapSnapshotProfileType.TrackingStopped)},_toggleRecording:function(){return this._recording?this._stopRecordingProfile():this._startRecordingProfile(),this._recording},get treeItemTitle(){return WebInspector.UIString("HEAP TIMELINES")},get description(){return WebInspector.UIString("Record JavaScript object allocations over time. Use this profile type to isolate memory leaks.")},_reset:function(){WebInspector.HeapSnapshotProfileType.prototype._reset.call(this),this._recording&&this._stopRecordingProfile(),this._profileSamples=null,this._lastSeenIndex=-1},createTemporaryProfile:function(e){return e=e||WebInspector.UIString("Recording…"),new WebInspector.HeapProfileHeader(this,e)},_requestProfilesFromBackend:function(e){},__proto__:WebInspector.HeapSnapshotProfileType.prototype},WebInspector.HeapProfileHeader=function(e,t,n,r){WebInspector.ProfileHeader.call(this,e,t,n),this.maxJSObjectId=r,this._receiver=null,this._snapshotProxy=null,this._totalNumberOfChunks=0,this._transferHandler=null},WebInspector.HeapProfileHeader.prototype={createSidebarTreeElement:function(){return new WebInspector.ProfileSidebarTreeElement(this,WebInspector.UIString("Snapshot %d"),"heap-snapshot-sidebar-tree-item")},createView:function(e){return new WebInspector.HeapSnapshotView(e,this)},load:function(e){if(this.uid===-1)return;if(this._snapshotProxy){e(this._snapshotProxy);return}this._numberOfChunks=0,this._receiver||(this._setupWorker(),this._transferHandler=new WebInspector.BackendSnapshotLoader(this),this.sidebarElement.subtitle=WebInspector.UIString("Loading…"),this.sidebarElement.wait=!0,this.startSnapshotTransfer());var t=this._receiver;t.addConsumer(e)},startSnapshotTransfer:function(){HeapProfilerAgent.getHeapSnapshot(this.uid)},snapshotConstructorName:function(){return"JSHeapSnapshot"},snapshotProxyConstructor:function(){return WebInspector.HeapSnapshotProxy},_setupWorker:function(){function e(e){this.sidebarElement.wait=e.data}var t=new WebInspector.HeapSnapshotWorkerProxy(this._handleWorkerEvent.bind(this));t.addEventListener("wait",e,this);var n=t.createLoader(this.snapshotConstructorName(),this.snapshotProxyConstructor());n.addConsumer(this._snapshotReceived.bind(this)),this._receiver=n},_handleWorkerEvent:function(e,t){if(WebInspector.HeapSnapshotProgress.Event.Update!==e)return;this._updateSubtitle(t)},dispose:function(){this._receiver?this._receiver.close():this._snapshotProxy&&this._snapshotProxy.dispose();if(this._view){var e=this._view;this._view=null,e.dispose()}},_updateSubtitle:function(e){this.sidebarElement.subtitle=e},_didCompleteSnapshotTransfer:function(){this.sidebarElement.subtitle=Number.bytesToString(this._snapshotProxy.totalSize),this.sidebarElement.wait=!1},transferChunk:function(e){this._transferHandler.transferChunk(e)},_snapshotReceived:function(e){this._receiver=null,e&&(this._snapshotProxy=e),this._didCompleteSnapshotTransfer();var t=this._snapshotProxy.worker;this.isTemporary=!1,t.startCheckingForLongRunningCalls(),this.notifySnapshotReceived()},notifySnapshotReceived:function(){this._profileType._snapshotReceived(this)},finishHeapSnapshot:function(){this._transferHandler&&(this._transferHandler.finishTransfer(),this._totalNumberOfChunks=this._transferHandler._totalNumberOfChunks)},_wasShown:function(){},canSaveToFile:function(){return!this.fromFile()&&!!this._snapshotProxy&&!this._receiver},saveToFile:function(){function t(){this._receiver=e,this._transferHandler=new WebInspector.SaveSnapshotHandler(this),HeapProfilerAgent.getHeapSnapshot(this.uid)}var e=new WebInspector.FileOutputStream;this._fileName=this._fileName||"Heap-"+(new Date).toISO8601Compact()+this._profileType.fileExtension(),e.open(this._fileName,t.bind(this))},loadFromFile:function(e){this.title=e.name,this.sidebarElement.subtitle=WebInspector.UIString("Loading…"),this.sidebarElement.wait=!0,this._setupWorker();var t=new WebInspector.HeapSnapshotLoadFromFileDelegate(this),n=this._createFileReader(e,t);n.start(this._receiver)},_createFileReader:function(e,t){return new WebInspector.ChunkedFileReader(e,1e7,t)},__proto__:WebInspector.ProfileHeader.prototype},WebInspector.SnapshotTransferHandler=function(e,t){this._numberOfChunks=0,this._savedChunks=0,this._header=e,this._totalNumberOfChunks=0,this._title=t},WebInspector.SnapshotTransferHandler.prototype={transferChunk:function(e){++this._numberOfChunks,this._header._receiver.write(e,this._didTransferChunk.bind(this))},finishTransfer:function(){},_didTransferChunk:function(){this._updateProgress(++this._savedChunks,this._totalNumberOfChunks)},_updateProgress:function(e,t){}},WebInspector.SaveSnapshotHandler=function(e){WebInspector.SnapshotTransferHandler.call(this,e,"Saving… %d%"),this._totalNumberOfChunks=e._totalNumberOfChunks,this._updateProgress(0,this._totalNumberOfChunks)},WebInspector.SaveSnapshotHandler.prototype={_updateProgress:function(e,t){var n=((t?e/t:0)*100).toFixed(0);this._header._updateSubtitle(WebInspector.UIString(this._title,n)),e===t&&(this._header._receiver.close(),this._header._didCompleteSnapshotTransfer())},__proto__:WebInspector.SnapshotTransferHandler.prototype},WebInspector.BackendSnapshotLoader=function(e){WebInspector.SnapshotTransferHandler.call(this,e,"Loading… %d%")},WebInspector.BackendSnapshotLoader.prototype={finishTransfer:function(){this._header._receiver.close(this._didFinishTransfer.bind(this)),this._totalNumberOfChunks=this._numberOfChunks},_didFinishTransfer:function(){console.assert(this._totalNumberOfChunks===this._savedChunks,"Not all chunks were transfered.")},__proto__:WebInspector.SnapshotTransferHandler.prototype},WebInspector.HeapSnapshotLoadFromFileDelegate=function(e){this._snapshotHeader=e},WebInspector.HeapSnapshotLoadFromFileDelegate.prototype={onTransferStarted:function(){},onChunkTransferred:function(e){},onTransferFinished:function(){},onError:function(e,t){switch(t.target.error.code){case t.target.error.NOT_FOUND_ERR:this._snapshotHeader._updateSubtitle(WebInspector.UIString("'%s' not found.",e.fileName()));break;case t.target.error.NOT_READABLE_ERR:this._snapshotHeader._updateSubtitle(WebInspector.UIString("'%s' is not readable",e.fileName()));break;case t.target.error.ABORT_ERR:break;default:this._snapshotHeader._updateSubtitle(WebInspector.UIString("'%s' error %d",e.fileName(),t.target.error.code))}}},WebInspector.HeapTrackingOverviewGrid=function(e){WebInspector.View.call(this),this.registerRequiredCSS("flameChart.css"),this.element.id="heap-recording-view",this._overviewContainer=this.element.createChild("div","overview-container"),this._overviewGrid=new WebInspector.OverviewGrid("heap-recording"),this._overviewCanvas=this._overviewContainer.createChild("canvas","heap-recording-overview-canvas"),this._overviewContainer.appendChild(this._overviewGrid.element),this._overviewCalculator=new WebInspector.HeapTrackingOverviewGrid.OverviewCalculator,this._overviewGrid.addEventListener(WebInspector.OverviewGrid.Events.WindowChanged,this._onWindowChanged,this),this._profileSamples=e._profileSamples||e._profileType._profileSamples,e.isTemporary&&(this._profileType=e._profileType,this._profileType.addEventListener(WebInspector.TrackingHeapSnapshotProfileType.HeapStatsUpdate,this._onHeapStatsUpdate,this),this._profileType.addEventListener(WebInspector.TrackingHeapSnapshotProfileType.TrackingStopped,this._onStopTracking,this));var t=this._profileSamples.timestamps,n=this._profileSamples.totalTime;this._windowLeft=0,this._windowRight=n&&t.length?(t[t.length-1]-t[0])/n:1,this._overviewGrid.setWindow(this._windowLeft,this._windowRight),this._yScale=new WebInspector.HeapTrackingOverviewGrid.SmoothScale,this._xScale=new WebInspector.HeapTrackingOverviewGrid.SmoothScale},WebInspector.HeapTrackingOverviewGrid.IdsRangeChanged="IdsRangeChanged",WebInspector.HeapTrackingOverviewGrid.prototype={_onStopTracking:function(e){this._profileType.removeEventListener(WebInspector.TrackingHeapSnapshotProfileType.HeapStatsUpdate,this._onHeapStatsUpdate,this),this._profileType.removeEventListener(WebInspector.TrackingHeapSnapshotProfileType.TrackingStopped,this._onStopTracking,this)},_onHeapStatsUpdate:function(e){this._profileSamples=e.data,this._scheduleUpdate()},_drawOverviewCanvas:function(e,t){function l(e,t){var n=0,r=0;for(var i=1;i<s.length;++i){var u=Math.floor((s[i]-o)*a);u!==r&&(n&&t(r,n),n=0,r=u),n+=e[i]}t(r,n)}function c(e,t){f=Math.max(f,t)}function b(e,n){p.moveTo(e,t-1),p.lineTo(e,Math.round(t-n*h-1))}if(!this._profileSamples)return;var n=this._profileSamples,r=n.sizes,i=n.max,s=n.timestamps,o=s[0],u=s[s.length-1],a=this._xScale.nextScale(e/n.totalTime),f=0;l(r,c);var h=this._yScale.nextScale(f?t/(f*1.1):0);this._overviewCanvas.width=e*window.devicePixelRatio,this._overviewCanvas.height=t*window.devicePixelRatio,this._overviewCanvas.style.width=e+"px",this._overviewCanvas.style.height=t+"px";var p=this._overviewCanvas.getContext("2d");p.scale(window.devicePixelRatio,window.devicePixelRatio),p.beginPath(),p.lineWidth=2,p.strokeStyle="rgba(192, 192, 192, 0.6)";var d=(u-o)*a;p.moveTo(d,t-1),p.lineTo(d,0),p.stroke(),p.closePath();var v,m,g=14;if(h){const y=(t-g)/h;m=Math.pow(1024,Math.floor(Math.log(y)/Math.log(1024))),m*=Math.pow(10,Math.floor(Math.log(y/m)/Math.log(10))),m*5<=y&&(m*=5),v=Math.round(t-m*h-.5)+.5,p.beginPath(),p.lineWidth=1,p.strokeStyle="rgba(0, 0, 0, 0.2)",p.moveTo(0,v),p.lineTo(e,v),p.stroke(),p.closePath()}p.beginPath(),p.lineWidth=2,p.strokeStyle="rgba(192, 192, 192, 0.6)",l(i,b),p.stroke(),p.closePath(),p.beginPath(),p.lineWidth=2,p.strokeStyle="rgba(0, 0, 192, 0.8)",l(r,b),p.stroke(),p.closePath();if(m){var w=Number.bytesToString(m),E=4,S=0,x=v-.5,T=2*E+p.measureText(w).width;p.beginPath(),p.textBaseline="bottom",p.font="10px "+window.getComputedStyle(this.element,null).getPropertyValue("font-family"),p.fillStyle="rgba(255, 255, 255, 0.75)",p.fillRect(S,x-g,T,g),p.fillStyle="rgb(64, 64, 64)",p.fillText(w,S+E,x),p.fill(),p.closePath()}},onResize:function(){this._updateOverviewCanvas=!0,this._scheduleUpdate()},_onWindowChanged:function(){this._updateGridTimerId||(this._updateGridTimerId=setTimeout(this._updateGrid.bind(this),10))},_scheduleUpdate:function(){if(this._updateTimerId)return;this._updateTimerId=setTimeout(this.update.bind(this),10)},_updateBoundaries:function(){this._windowLeft=this._overviewGrid.windowLeft(),this._windowRight=this._overviewGrid.windowRight(),this._windowWidth=this._windowRight-this._windowLeft},update:function(){this._updateTimerId=null;if(!this.isShowing())return;this._updateBoundaries(),this._overviewCalculator._updateBoundaries(this),this._overviewGrid.updateDividers(this._overviewCalculator),this._drawOverviewCanvas(this._overviewContainer.clientWidth,this._overviewContainer.clientHeight-20)},_updateGrid:function(){this._updateGridTimerId=0,this._updateBoundaries();var e=this._profileSamples.ids,t=this._profileSamples.timestamps,n=this._profileSamples.sizes,r=t[0],i=this._profileSamples.totalTime,s=r+i*this._windowLeft,o=r+i*this._windowRight,u=0,a=e[e.length-1]+1,f=0;for(var l=0;l<t.length;++l){if(!t[l])continue;if(t[l]>o)break;a=e[l];if(t[l]<s){u=e[l];continue}f+=n[l]}this.dispatchEventToListeners(WebInspector.HeapTrackingOverviewGrid.IdsRangeChanged,{minId:u,maxId:a,size:f})},__proto__:WebInspector.View.prototype},WebInspector.HeapTrackingOverviewGrid.SmoothScale=function(){this._lastUpdate=0,this._currentScale=0},WebInspector.HeapTrackingOverviewGrid.SmoothScale.prototype={nextScale:function(e){e=e||this._currentScale;if(this._currentScale){var t=Date.now(),n=t-this._lastUpdate;this._lastUpdate=t;var r=20,i=Math.pow(r,n/1e3),s=e/this._currentScale;this._currentScale*=Number.constrain(s,1/i,i)}else this._currentScale=e;return this._currentScale}},WebInspector.HeapTrackingOverviewGrid.OverviewCalculator=function(){},WebInspector.HeapTrackingOverviewGrid.OverviewCalculator.prototype={_updateBoundaries:function(e){this._minimumBoundaries=0,this._maximumBoundaries=e._profileSamples.totalTime,this._xScaleFactor=e._overviewContainer.clientWidth/this._maximumBoundaries},computePosition:function(e){return(e-this._minimumBoundaries)*this._xScaleFactor},formatTime:function(e){return Number.secondsToString((e+this._minimumBoundaries)/1e3)},maximumBoundary:function(){return this._maximumBoundaries},minimumBoundary:function(){return this._minimumBoundaries},zeroTime:function(){return this._minimumBoundaries},boundarySpan:function(){return this._maximumBoundaries-this._minimumBoundaries}};