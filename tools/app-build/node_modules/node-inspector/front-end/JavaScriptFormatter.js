/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

function FormattedContentBuilder(e,t,n,r,i){this._originalContent=e,this._originalOffset=n,this._lastOriginalPosition=0,this._formattedContent=[],this._formattedContentLength=0,this._formattedOffset=r,this._lastFormattedPosition=0,this._mapping=t,this._lineNumber=0,this._nestingLevel=0,this._indentString=i,this._cachedIndents={}}function Tokenizer(e){this._readNextToken=parse.tokenizer(e),this._state=this._readNextToken.context()}function JavaScriptFormatter(e,t){this._tokenizer=e,this._builder=t,this._token=null,this._nextToken=this._tokenizer.next()}FormattedContentBuilder.prototype={addToken:function(e){for(var t=0;t<e.comments_before.length;++t)this._addComment(e.comments_before[t]);while(this._lineNumber<e.line)this._addText("\n"),this._addIndent(),this._needNewLine=!1,this._lineNumber+=1;this._needNewLine&&(this._addText("\n"),this._addIndent(),this._needNewLine=!1),this._addMappingIfNeeded(e.pos),this._addText(this._originalContent.substring(e.pos,e.endPos)),this._lineNumber=e.endLine},addSpace:function(){this._addText(" ")},addNewLine:function(){this._needNewLine=!0},increaseNestingLevel:function(){this._nestingLevel+=1},decreaseNestingLevel:function(){this._nestingLevel-=1},content:function(){return this._formattedContent.join("")},mapping:function(){return{original:this._originalPositions,formatted:this._formattedPositions}},_addIndent:function(){if(this._cachedIndents[this._nestingLevel]){this._addText(this._cachedIndents[this._nestingLevel]);return}var e="";for(var t=0;t<this._nestingLevel;++t)e+=this._indentString;this._addText(e),this._nestingLevel<=20&&(this._cachedIndents[this._nestingLevel]=e)},_addComment:function(e){if(this._lineNumber<e.line){for(var t=this._lineNumber;t<e.line;++t)this._addText("\n");this._lineNumber=e.line,this._needNewLine=!1,this._addIndent()}else this.addSpace();this._addMappingIfNeeded(e.pos),e.type==="comment1"?this._addText("//"):this._addText("/*"),this._addText(e.value);if(e.type!=="comment1"){this._addText("*/");var n;while((n=e.value.indexOf("\n",n+1))!==-1)this._lineNumber+=1}},_addText:function(e){this._formattedContent.push(e),this._formattedContentLength+=e.length},_addMappingIfNeeded:function(e){if(e-this._lastOriginalPosition===this._formattedContentLength-this._lastFormattedPosition)return;this._mapping.original.push(this._originalOffset+e),this._lastOriginalPosition=e,this._mapping.formatted.push(this._formattedOffset+this._formattedContentLength),this._lastFormattedPosition=this._formattedContentLength}};var tokens=[["EOS"],["LPAREN","("],["RPAREN",")"],["LBRACK","["],["RBRACK","]"],["LBRACE","{"],["RBRACE","}"],["COLON",":"],["SEMICOLON",";"],["PERIOD","."],["CONDITIONAL","?"],["INC","++"],["DEC","--"],["ASSIGN","="],["ASSIGN_BIT_OR","|="],["ASSIGN_BIT_XOR","^="],["ASSIGN_BIT_AND","&="],["ASSIGN_SHL","<<="],["ASSIGN_SAR",">>="],["ASSIGN_SHR",">>>="],["ASSIGN_ADD","+="],["ASSIGN_SUB","-="],["ASSIGN_MUL","*="],["ASSIGN_DIV","/="],["ASSIGN_MOD","%="],["COMMA",","],["OR","||"],["AND","&&"],["BIT_OR","|"],["BIT_XOR","^"],["BIT_AND","&"],["SHL","<<"],["SAR",">>"],["SHR",">>>"],["ADD","+"],["SUB","-"],["MUL","*"],["DIV","/"],["MOD","%"],["EQ","=="],["NE","!="],["EQ_STRICT","==="],["NE_STRICT","!=="],["LT","<"],["GT",">"],["LTE","<="],["GTE",">="],["INSTANCEOF","instanceof"],["IN","in"],["NOT","!"],["BIT_NOT","~"],["DELETE","delete"],["TYPEOF","typeof"],["VOID","void"],["BREAK","break"],["CASE","case"],["CATCH","catch"],["CONTINUE","continue"],["DEBUGGER","debugger"],["DEFAULT","default"],["DO","do"],["ELSE","else"],["FINALLY","finally"],["FOR","for"],["FUNCTION","function"],["IF","if"],["NEW","new"],["RETURN","return"],["SWITCH","switch"],["THIS","this"],["THROW","throw"],["TRY","try"],["VAR","var"],["WHILE","while"],["WITH","with"],["NULL_LITERAL","null"],["TRUE_LITERAL","true"],["FALSE_LITERAL","false"],["NUMBER"],["STRING"],["IDENTIFIER"],["CONST","const"]],Tokens={};for(var i=0;i<tokens.length;++i)Tokens[tokens[i][0]]=i;var TokensByValue={};for(var i=0;i<tokens.length;++i)tokens[i][1]&&(TokensByValue[tokens[i][1]]=i);var TokensByType={eof:Tokens.EOS,name:Tokens.IDENTIFIER,num:Tokens.NUMBER,regexp:Tokens.DIV,string:Tokens.STRING};Tokenizer.prototype={content:function(){return this._state.text},next:function(e){var t=this._readNextToken(e);return t.endPos=this._state.pos,t.endLine=this._state.line,t.token=this._convertUglifyToken(t),t},_convertUglifyToken:function(e){var t=TokensByType[e.type];if(typeof t=="number")return t;t=TokensByValue[e.value];if(typeof t=="number")return t;throw"Unknown token type "+e.type}},JavaScriptFormatter.prototype={format:function(){this._parseSourceElements(Tokens.EOS),this._consume(Tokens.EOS)},_peek:function(){return this._nextToken.token},_next:function(){if(this._token&&this._token.token===Tokens.EOS)throw"Unexpected EOS token";return this._builder.addToken(this._nextToken),this._token=this._nextToken,this._nextToken=this._tokenizer.next(this._forceRegexp),this._forceRegexp=!1,this._token.token},_consume:function(e){var t=this._next();if(t!==e)throw"Unexpected token in consume: expected "+e+", actual "+t},_expect:function(e){var t=this._next();if(t!==e)throw"Unexpected token: expected "+e+", actual "+t},_expectSemicolon:function(){this._peek()===Tokens.SEMICOLON&&this._consume(Tokens.SEMICOLON)},_hasLineTerminatorBeforeNext:function(){return this._nextToken.nlb},_parseSourceElements:function(e){while(this._peek()!==e)this._parseStatement(),this._builder.addNewLine()},_parseStatementOrBlock:function(){if(this._peek()===Tokens.LBRACE)return this._builder.addSpace(),this._parseBlock(),!0;this._builder.addNewLine(),this._builder.increaseNestingLevel(),this._parseStatement(),this._builder.decreaseNestingLevel()},_parseStatement:function(){switch(this._peek()){case Tokens.LBRACE:return this._parseBlock();case Tokens.CONST:case Tokens.VAR:return this._parseVariableStatement();case Tokens.SEMICOLON:return this._next();case Tokens.IF:return this._parseIfStatement();case Tokens.DO:return this._parseDoWhileStatement();case Tokens.WHILE:return this._parseWhileStatement();case Tokens.FOR:return this._parseForStatement();case Tokens.CONTINUE:return this._parseContinueStatement();case Tokens.BREAK:return this._parseBreakStatement();case Tokens.RETURN:return this._parseReturnStatement();case Tokens.WITH:return this._parseWithStatement();case Tokens.SWITCH:return this._parseSwitchStatement();case Tokens.THROW:return this._parseThrowStatement();case Tokens.TRY:return this._parseTryStatement();case Tokens.FUNCTION:return this._parseFunctionDeclaration();case Tokens.DEBUGGER:return this._parseDebuggerStatement();default:return this._parseExpressionOrLabelledStatement()}},_parseFunctionDeclaration:function(){this._expect(Tokens.FUNCTION),this._builder.addSpace(),this._expect(Tokens.IDENTIFIER),this._parseFunctionLiteral()},_parseBlock:function(){this._expect(Tokens.LBRACE),this._builder.addNewLine(),this._builder.increaseNestingLevel();while(this._peek()!==Tokens.RBRACE)this._parseStatement(),this._builder.addNewLine();this._builder.decreaseNestingLevel(),this._expect(Tokens.RBRACE)},_parseVariableStatement:function(){this._parseVariableDeclarations(),this._expectSemicolon()},_parseVariableDeclarations:function(){this._peek()===Tokens.VAR?this._consume(Tokens.VAR):this._consume(Tokens.CONST),this._builder.addSpace();var e=!0;do e||(this._consume(Tokens.COMMA),this._builder.addSpace()),e=!1,this._expect(Tokens.IDENTIFIER),this._peek()===Tokens.ASSIGN&&(this._builder.addSpace(),this._consume(Tokens.ASSIGN),this._builder.addSpace(),this._parseAssignmentExpression());while(this._peek()===Tokens.COMMA)},_parseExpressionOrLabelledStatement:function(){this._parseExpression(),this._peek()===Tokens.COLON&&(this._expect(Tokens.COLON),this._builder.addSpace(),this._parseStatement()),this._expectSemicolon()},_parseIfStatement:function(){this._expect(Tokens.IF),this._builder.addSpace(),this._expect(Tokens.LPAREN),this._parseExpression(),this._expect(Tokens.RPAREN);var e=this._parseStatementOrBlock();this._peek()===Tokens.ELSE&&(e?this._builder.addSpace():this._builder.addNewLine(),this._next(),this._peek()===Tokens.IF?(this._builder.addSpace(),this._parseStatement()):this._parseStatementOrBlock())},_parseContinueStatement:function(){this._expect(Tokens.CONTINUE);var e=this._peek();!this._hasLineTerminatorBeforeNext()&&e!==Tokens.SEMICOLON&&e!==Tokens.RBRACE&&e!==Tokens.EOS&&(this._builder.addSpace(),this._expect(Tokens.IDENTIFIER)),this._expectSemicolon()},_parseBreakStatement:function(){this._expect(Tokens.BREAK);var e=this._peek();!this._hasLineTerminatorBeforeNext()&&e!==Tokens.SEMICOLON&&e!==Tokens.RBRACE&&e!==Tokens.EOS&&(this._builder.addSpace(),this._expect(Tokens.IDENTIFIER)),this._expectSemicolon()},_parseReturnStatement:function(){this._expect(Tokens.RETURN);var e=this._peek();!this._hasLineTerminatorBeforeNext()&&e!==Tokens.SEMICOLON&&e!==Tokens.RBRACE&&e!==Tokens.EOS&&(this._builder.addSpace(),this._parseExpression()),this._expectSemicolon()},_parseWithStatement:function(){this._expect(Tokens.WITH),this._builder.addSpace(),this._expect(Tokens.LPAREN),this._parseExpression(),this._expect(Tokens.RPAREN),this._parseStatementOrBlock()},_parseCaseClause:function(){this._peek()===Tokens.CASE?(this._expect(Tokens.CASE),this._builder.addSpace(),this._parseExpression()):this._expect(Tokens.DEFAULT),this._expect(Tokens.COLON),this._builder.addNewLine(),this._builder.increaseNestingLevel();while(this._peek()!==Tokens.CASE&&this._peek()!==Tokens.DEFAULT&&this._peek()!==Tokens.RBRACE)this._parseStatement(),this._builder.addNewLine();this._builder.decreaseNestingLevel()},_parseSwitchStatement:function(){this._expect(Tokens.SWITCH),this._builder.addSpace(),this._expect(Tokens.LPAREN),this._parseExpression(),this._expect(Tokens.RPAREN),this._builder.addSpace(),this._expect(Tokens.LBRACE),this._builder.addNewLine(),this._builder.increaseNestingLevel();while(this._peek()!==Tokens.RBRACE)this._parseCaseClause();this._builder.decreaseNestingLevel(),this._expect(Tokens.RBRACE)},_parseThrowStatement:function(){this._expect(Tokens.THROW),this._builder.addSpace(),this._parseExpression(),this._expectSemicolon()},_parseTryStatement:function(){this._expect(Tokens.TRY),this._builder.addSpace(),this._parseBlock();var e=this._peek();e===Tokens.CATCH&&(this._builder.addSpace(),this._consume(Tokens.CATCH),this._builder.addSpace(),this._expect(Tokens.LPAREN),this._expect(Tokens.IDENTIFIER),this._expect(Tokens.RPAREN),this._builder.addSpace(),this._parseBlock(),e=this._peek()),e===Tokens.FINALLY&&(this._consume(Tokens.FINALLY),this._builder.addSpace(),this._parseBlock())},_parseDoWhileStatement:function(){this._expect(Tokens.DO);var e=this._parseStatementOrBlock();e?this._builder.addSpace():this._builder.addNewLine(),this._expect(Tokens.WHILE),this._builder.addSpace(),this._expect(Tokens.LPAREN),this._parseExpression(),this._expect(Tokens.RPAREN),this._expectSemicolon()},_parseWhileStatement:function(){this._expect(Tokens.WHILE),this._builder.addSpace(),this._expect(Tokens.LPAREN),this._parseExpression(),this._expect(Tokens.RPAREN),this._parseStatementOrBlock()},_parseForStatement:function(){this._expect(Tokens.FOR),this._builder.addSpace(),this._expect(Tokens.LPAREN),this._peek()!==Tokens.SEMICOLON&&(this._peek()===Tokens.VAR||this._peek()===Tokens.CONST?(this._parseVariableDeclarations(),this._peek()===Tokens.IN&&(this._builder.addSpace(),this._consume(Tokens.IN),this._builder.addSpace(),this._parseExpression())):this._parseExpression()),this._peek()!==Tokens.RPAREN&&(this._expect(Tokens.SEMICOLON),this._builder.addSpace(),this._peek()!==Tokens.SEMICOLON&&this._parseExpression(),this._expect(Tokens.SEMICOLON),this._builder.addSpace(),this._peek()!==Tokens.RPAREN&&this._parseExpression()),this._expect(Tokens.RPAREN),this._parseStatementOrBlock()},_parseExpression:function(){this._parseAssignmentExpression();while(this._peek()===Tokens.COMMA)this._expect(Tokens.COMMA),this._builder.addSpace(),this._parseAssignmentExpression()},_parseAssignmentExpression:function(){this._parseConditionalExpression();var e=this._peek();Tokens.ASSIGN<=e&&e<=Tokens.ASSIGN_MOD&&(this._builder.addSpace(),this._next(),this._builder.addSpace(),this._parseAssignmentExpression())},_parseConditionalExpression:function(){this._parseBinaryExpression(),this._peek()===Tokens.CONDITIONAL&&(this._builder.addSpace(),this._consume(Tokens.CONDITIONAL),this._builder.addSpace(),this._parseAssignmentExpression(),this._builder.addSpace(),this._expect(Tokens.COLON),this._builder.addSpace(),this._parseAssignmentExpression())},_parseBinaryExpression:function(){this._parseUnaryExpression();var e=this._peek();while(Tokens.OR<=e&&e<=Tokens.IN)this._builder.addSpace(),this._next(),this._builder.addSpace(),this._parseBinaryExpression(),e=this._peek()},_parseUnaryExpression:function(){var e=this._peek();if(!(Tokens.NOT<=e&&e<=Tokens.VOID||e===Tokens.ADD||e===Tokens.SUB||e===Tokens.INC||e===Tokens.DEC))return this._parsePostfixExpression();this._next(),(e===Tokens.DELETE||e===Tokens.TYPEOF||e===Tokens.VOID)&&this._builder.addSpace(),this._parseUnaryExpression()},_parsePostfixExpression:function(){this._parseLeftHandSideExpression();var e=this._peek();!this._hasLineTerminatorBeforeNext()&&(e===Tokens.INC||e===Tokens.DEC)&&this._next()},_parseLeftHandSideExpression:function(){this._peek()===Tokens.NEW?this._parseNewExpression():this._parseMemberExpression();for(;;)switch(this._peek()){case Tokens.LBRACK:this._consume(Tokens.LBRACK),this._parseExpression(),this._expect(Tokens.RBRACK);break;case Tokens.LPAREN:this._parseArguments();break;case Tokens.PERIOD:this._consume(Tokens.PERIOD),this._expect(Tokens.IDENTIFIER);break;default:return}},_parseNewExpression:function(){this._expect(Tokens.NEW),this._builder.addSpace(),this._peek()===Tokens.NEW?this._parseNewExpression():this._parseMemberExpression()},_parseMemberExpression:function(){this._peek()===Tokens.FUNCTION?(this._expect(Tokens.FUNCTION),this._peek()===Tokens.IDENTIFIER&&(this._builder.addSpace(),this._expect(Tokens.IDENTIFIER)),this._parseFunctionLiteral()):this._parsePrimaryExpression();for(;;)switch(this._peek()){case Tokens.LBRACK:this._consume(Tokens.LBRACK),this._parseExpression(),this._expect(Tokens.RBRACK);break;case Tokens.PERIOD:this._consume(Tokens.PERIOD),this._expect(Tokens.IDENTIFIER);break;case Tokens.LPAREN:this._parseArguments();break;default:return}},_parseDebuggerStatement:function(){this._expect(Tokens.DEBUGGER),this._expectSemicolon()},_parsePrimaryExpression:function(){switch(this._peek()){case Tokens.THIS:return this._consume(Tokens.THIS);case Tokens.NULL_LITERAL:return this._consume(Tokens.NULL_LITERAL);case Tokens.TRUE_LITERAL:return this._consume(Tokens.TRUE_LITERAL);case Tokens.FALSE_LITERAL:return this._consume(Tokens.FALSE_LITERAL);case Tokens.IDENTIFIER:return this._consume(Tokens.IDENTIFIER);case Tokens.NUMBER:return this._consume(Tokens.NUMBER);case Tokens.STRING:return this._consume(Tokens.STRING);case Tokens.ASSIGN_DIV:return this._parseRegExpLiteral();case Tokens.DIV:return this._parseRegExpLiteral();case Tokens.LBRACK:return this._parseArrayLiteral();case Tokens.LBRACE:return this._parseObjectLiteral();case Tokens.LPAREN:this._consume(Tokens.LPAREN),this._parseExpression(),this._expect(Tokens.RPAREN);return;default:return this._next()}},_parseArrayLiteral:function(){this._expect(Tokens.LBRACK),this._builder.increaseNestingLevel();while(this._peek()!==Tokens.RBRACK)this._peek()!==Tokens.COMMA&&this._parseAssignmentExpression(),this._peek()!==Tokens.RBRACK&&(this._expect(Tokens.COMMA),this._builder.addSpace());this._builder.decreaseNestingLevel(),this._expect(Tokens.RBRACK)},_parseObjectLiteralGetSet:function(){var e=this._peek();if(e===Tokens.IDENTIFIER||e===Tokens.NUMBER||e===Tokens.STRING||Tokens.DELETE<=e&&e<=Tokens.FALSE_LITERAL||e===Tokens.INSTANCEOF||e===Tokens.IN||e===Tokens.CONST)this._next(),this._parseFunctionLiteral()},_parseObjectLiteral:function(){this._expect(Tokens.LBRACE),this._builder.increaseNestingLevel();while(this._peek()!==Tokens.RBRACE){var e=this._peek();switch(e){case Tokens.IDENTIFIER:this._consume(Tokens.IDENTIFIER);var t=this._token.value;if((t==="get"||t==="set")&&this._peek()!==Tokens.COLON){this._builder.addSpace(),this._parseObjectLiteralGetSet(),this._peek()!==Tokens.RBRACE&&this._expect(Tokens.COMMA);continue}break;case Tokens.STRING:this._consume(Tokens.STRING);break;case Tokens.NUMBER:this._consume(Tokens.NUMBER);break;default:this._next()}this._expect(Tokens.COLON),this._builder.addSpace(),this._parseAssignmentExpression(),this._peek()!==Tokens.RBRACE&&this._expect(Tokens.COMMA)}this._builder.decreaseNestingLevel(),this._expect(Tokens.RBRACE)},_parseRegExpLiteral:function(){this._nextToken.type==="regexp"?this._next():(this._forceRegexp=!0,this._next())},_parseArguments:function(){this._expect(Tokens.LPAREN);var e=this._peek()===Tokens.RPAREN;while(!e)this._parseAssignmentExpression(),e=this._peek()===Tokens.RPAREN,e||(this._expect(Tokens.COMMA),this._builder.addSpace());this._expect(Tokens.RPAREN)},_parseFunctionLiteral:function(){this._expect(Tokens.LPAREN);var e=this._peek()===Tokens.RPAREN;while(!e)this._expect(Tokens.IDENTIFIER),e=this._peek()===Tokens.RPAREN,e||(this._expect(Tokens.COMMA),this._builder.addSpace());this._expect(Tokens.RPAREN),this._builder.addSpace(),this._expect(Tokens.LBRACE),this._builder.addNewLine(),this._builder.increaseNestingLevel(),this._parseSourceElements(Tokens.RBRACE),this._builder.decreaseNestingLevel(),this._expect(Tokens.RBRACE)}};