/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.NetworkManager=function(){WebInspector.Object.call(this),this._dispatcher=new WebInspector.NetworkDispatcher(this),WebInspector.settings.cacheDisabled.get()&&NetworkAgent.setCacheDisabled(!0),NetworkAgent.enable(),WebInspector.settings.cacheDisabled.addChangeListener(this._cacheDisabledSettingChanged,this)},WebInspector.NetworkManager.EventTypes={RequestStarted:"RequestStarted",RequestUpdated:"RequestUpdated",RequestFinished:"RequestFinished",RequestUpdateDropped:"RequestUpdateDropped"},WebInspector.NetworkManager._MIMETypes={"text/html":{document:!0},"text/xml":{document:!0},"text/plain":{document:!0},"application/xhtml+xml":{document:!0},"text/css":{stylesheet:!0},"text/xsl":{stylesheet:!0},"image/jpg":{image:!0},"image/jpeg":{image:!0},"image/pjpeg":{image:!0},"image/png":{image:!0},"image/gif":{image:!0},"image/bmp":{image:!0},"image/svg+xml":{image:!0,font:!0,document:!0},"image/vnd.microsoft.icon":{image:!0},"image/webp":{image:!0},"image/x-icon":{image:!0},"image/x-xbitmap":{image:!0},"font/ttf":{font:!0},"font/otf":{font:!0},"font/woff":{font:!0},"font/woff2":{font:!0},"font/truetype":{font:!0},"font/opentype":{font:!0},"application/octet-stream":{font:!0,image:!0},"application/font-woff":{font:!0},"application/x-font-woff":{font:!0},"application/x-font-type1":{font:!0},"application/x-font-ttf":{font:!0},"application/x-truetype-font":{font:!0},"text/javascript":{script:!0},"text/ecmascript":{script:!0},"application/javascript":{script:!0},"application/ecmascript":{script:!0},"application/x-javascript":{script:!0},"application/json":{script:!0},"text/javascript1.1":{script:!0},"text/javascript1.2":{script:!0},"text/javascript1.3":{script:!0},"text/jscript":{script:!0},"text/livescript":{script:!0}},WebInspector.NetworkManager.prototype={inflightRequestForURL:function(e){return this._dispatcher._inflightRequestsByURL[e]},_cacheDisabledSettingChanged:function(e){var t=e.data;NetworkAgent.setCacheDisabled(t)},__proto__:WebInspector.Object.prototype},WebInspector.NetworkDispatcher=function(e){this._manager=e,this._inflightRequestsById={},this._inflightRequestsByURL={},InspectorBackend.registerNetworkDispatcher(this)},WebInspector.NetworkDispatcher.prototype={_headersMapToHeadersArray:function(e){var t=[];for(var n in e){var r=e[n].split("\n");for(var i=0;i<r.length;++i)t.push({name:n,value:r[i]})}return t},_updateNetworkRequestWithRequest:function(e,t){e.requestMethod=t.method,e.requestHeaders=this._headersMapToHeadersArray(t.headers),e.requestFormData=t.postData},_updateNetworkRequestWithResponse:function(e,t){if(!t)return;t.url&&e.url!==t.url&&(e.url=t.url),e.mimeType=t.mimeType,e.statusCode=t.status,e.statusText=t.statusText,e.responseHeaders=this._headersMapToHeadersArray(t.headers),t.headersText&&(e.responseHeadersText=t.headersText),t.requestHeaders&&(e.requestHeaders=this._headersMapToHeadersArray(t.requestHeaders)),t.requestHeadersText&&(e.requestHeadersText=t.requestHeadersText),e.connectionReused=t.connectionReused,e.connectionId=t.connectionId,t.fromDiskCache?e.cached=!0:e.timing=t.timing,this._mimeTypeIsConsistentWithType(e)||WebInspector.console.addMessage(WebInspector.ConsoleMessage.create(WebInspector.ConsoleMessage.MessageSource.Network,WebInspector.ConsoleMessage.MessageLevel.Log,WebInspector.UIString('Resource interpreted as %s but transferred with MIME type %s: "%s".',e.type.title(),e.mimeType,e.url),WebInspector.ConsoleMessage.MessageType.Log,"",0,0,1,[],null,e.requestId))},_mimeTypeIsConsistentWithType:function(e){return e.hasErrorStatusCode()||e.statusCode===304||e.statusCode===204?!0:typeof e.type=="undefined"||e.type===WebInspector.resourceTypes.Other||e.type===WebInspector.resourceTypes.XHR||e.type===WebInspector.resourceTypes.WebSocket?!0:e.mimeType?e.mimeType in WebInspector.NetworkManager._MIMETypes?e.type.name()in WebInspector.NetworkManager._MIMETypes[e.mimeType]:!1:!0},_isNull:function(e){return e?!e.status&&!e.mimeType&&(!e.headers||!Object.keys(e.headers).length):!0},requestWillBeSent:function(e,t,n,r,i,s,o,u){var a=this._inflightRequestsById[e];if(a){if(!u)return;this.responseReceived(e,t,n,s,PageAgent.ResourceType.Other,u),a=this._appendRedirect(e,s,i.url)}else a=this._createNetworkRequest(e,t,n,i.url,r,o);a.hasNetworkData=!0,this._updateNetworkRequestWithRequest(a,i),a.startTime=s,this._startNetworkRequest(a)},requestServedFromCache:function(e){var t=this._inflightRequestsById[e];if(!t)return;t.cached=!0},responseReceived:function(e,t,n,r,i,s){if(this._isNull(s))return;var o=this._inflightRequestsById[e];if(!o){var u={};u.url=s.url,u.frameId=t,u.loaderId=n,u.resourceType=i,u.mimeType=s.mimeType,this._manager.dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.RequestUpdateDropped,u);return}o.responseReceivedTime=r,o.type=WebInspector.resourceTypes[i],this._updateNetworkRequestWithResponse(o,s),this._updateNetworkRequest(o)},dataReceived:function(e,t,n,r){var i=this._inflightRequestsById[e];if(!i)return;i.resourceSize+=n,r!=-1&&i.increaseTransferSize(r),i.endTime=t,this._updateNetworkRequest(i)},loadingFinished:function(e,t){var n=this._inflightRequestsById[e];if(!n)return;this._finishNetworkRequest(n,t)},loadingFailed:function(e,t,n,r){var i=this._inflightRequestsById[e];if(!i)return;i.failed=!0,i.canceled=r,i.localizedFailDescription=n,this._finishNetworkRequest(i,t)},webSocketCreated:function(e,t){var n=new WebInspector.NetworkRequest(e,t,"","","");n.type=WebInspector.resourceTypes.WebSocket,this._startNetworkRequest(n)},webSocketWillSendHandshakeRequest:function(e,t,n){var r=this._inflightRequestsById[e];if(!r)return;r.requestMethod="GET",r.requestHeaders=this._headersMapToHeadersArray(n.headers),r.startTime=t,this._updateNetworkRequest(r)},webSocketHandshakeResponseReceived:function(e,t,n){var r=this._inflightRequestsById[e];if(!r)return;r.statusCode=n.status,r.statusText=n.statusText,r.responseHeaders=this._headersMapToHeadersArray(n.headers),r.responseReceivedTime=t,this._updateNetworkRequest(r)},webSocketFrameReceived:function(e,t,n){var r=this._inflightRequestsById[e];if(!r)return;r.addFrame(n,t),r.responseReceivedTime=t,this._updateNetworkRequest(r)},webSocketFrameSent:function(e,t,n){var r=this._inflightRequestsById[e];if(!r)return;r.addFrame(n,t,!0),r.responseReceivedTime=t,this._updateNetworkRequest(r)},webSocketFrameError:function(e,t,n){var r=this._inflightRequestsById[e];if(!r)return;r.addFrameError(n,t),r.responseReceivedTime=t,this._updateNetworkRequest(r)},webSocketClosed:function(e,t){var n=this._inflightRequestsById[e];if(!n)return;this._finishNetworkRequest(n,t)},_appendRedirect:function(e,t,n){var r=this._inflightRequestsById[e],i=r.redirects||[];r.requestId="redirected:"+e+"."+i.length,delete r.redirects,i.length>0&&(r.redirectSource=i[i.length-1]),this._finishNetworkRequest(r,t);var s=this._createNetworkRequest(e,r.frameId,r.loaderId,n,r.documentURL,r.initiator);return s.redirects=i.concat(r),s},_startNetworkRequest:function(e){this._inflightRequestsById[e.requestId]=e,this._inflightRequestsByURL[e.url]=e,this._dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.RequestStarted,e)},_updateNetworkRequest:function(e){this._dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.RequestUpdated,e)},_finishNetworkRequest:function(e,t){e.endTime=t,e.finished=!0,this._dispatchEventToListeners(WebInspector.NetworkManager.EventTypes.RequestFinished,e),delete this._inflightRequestsById[e.requestId],delete this._inflightRequestsByURL[e.url]},_dispatchEventToListeners:function(e,t){this._manager.dispatchEventToListeners(e,t)},_createNetworkRequest:function(e,t,n,r,i,s){var o=new WebInspector.NetworkRequest(e,r,i,t,n);return o.initiator=s,o}},WebInspector.networkManager=null;