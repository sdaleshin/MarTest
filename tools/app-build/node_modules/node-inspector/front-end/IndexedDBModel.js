/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.IndexedDBModel=function(){IndexedDBAgent.enable(),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.SecurityOriginAdded,this._securityOriginAdded,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.SecurityOriginRemoved,this._securityOriginRemoved,this),this._databases=new Map,this._databaseNamesBySecurityOrigin={},this._reset()},WebInspector.IndexedDBModel.KeyTypes={NumberType:"number",StringType:"string",DateType:"date",ArrayType:"array"},WebInspector.IndexedDBModel.KeyPathTypes={NullType:"null",StringType:"string",ArrayType:"array"},WebInspector.IndexedDBModel.keyFromIDBKey=function(e){if(typeof e=="undefined"||e===null)return null;var t={};switch(typeof e){case"number":t.number=e,t.type=WebInspector.IndexedDBModel.KeyTypes.NumberType;break;case"string":t.string=e,t.type=WebInspector.IndexedDBModel.KeyTypes.StringType;break;case"object":if(e instanceof Date)t.date=e.getTime(),t.type=WebInspector.IndexedDBModel.KeyTypes.DateType;else if(e instanceof Array){t.array=[];for(var n=0;n<e.length;++n)t.array.push(WebInspector.IndexedDBModel.keyFromIDBKey(e[n]));t.type=WebInspector.IndexedDBModel.KeyTypes.ArrayType}break;default:return null}return t},WebInspector.IndexedDBModel.keyRangeFromIDBKeyRange=function(e){var t=window.IDBKeyRange||window.webkitIDBKeyRange;if(typeof e=="undefined"||e===null)return null;var n={};return n.lower=WebInspector.IndexedDBModel.keyFromIDBKey(e.lower),n.upper=WebInspector.IndexedDBModel.keyFromIDBKey(e.upper),n.lowerOpen=e.lowerOpen,n.upperOpen=e.upperOpen,n},WebInspector.IndexedDBModel.idbKeyPathFromKeyPath=function(e){var t;switch(e.type){case WebInspector.IndexedDBModel.KeyPathTypes.NullType:t=null;break;case WebInspector.IndexedDBModel.KeyPathTypes.StringType:t=e.string;break;case WebInspector.IndexedDBModel.KeyPathTypes.ArrayType:t=e.array}return t},WebInspector.IndexedDBModel.keyPathStringFromIDBKeyPath=function(e){return typeof e=="string"?'"'+e+'"':e instanceof Array?'["'+e.join('", "')+'"]':null},WebInspector.IndexedDBModel.EventTypes={DatabaseAdded:"DatabaseAdded",DatabaseRemoved:"DatabaseRemoved",DatabaseLoaded:"DatabaseLoaded"},WebInspector.IndexedDBModel.prototype={_reset:function(){for(var e in this._databaseNamesBySecurityOrigin)this._removeOrigin(e);var t=WebInspector.resourceTreeModel.securityOrigins();for(var n=0;n<t.length;++n)this._addOrigin(t[n])},refreshDatabaseNames:function(){for(var e in this._databaseNamesBySecurityOrigin)this._loadDatabaseNames(e)},refreshDatabase:function(e){this._loadDatabase(e)},clearObjectStore:function(e,t,n){IndexedDBAgent.clearObjectStore(e.securityOrigin,e.name,t,n)},_securityOriginAdded:function(e){var t=e.data;this._addOrigin(t)},_securityOriginRemoved:function(e){var t=e.data;this._removeOrigin(t)},_addOrigin:function(e){console.assert(!this._databaseNamesBySecurityOrigin[e]),this._databaseNamesBySecurityOrigin[e]=[],this._loadDatabaseNames(e)},_removeOrigin:function(e){console.assert(this._databaseNamesBySecurityOrigin[e]);for(var t=0;t<this._databaseNamesBySecurityOrigin[e].length;++t)this._databaseRemoved(e,this._databaseNamesBySecurityOrigin[e][t]);delete this._databaseNamesBySecurityOrigin[e]},_updateOriginDatabaseNames:function(e,t){var n={};for(var r=0;r<t.length;++r)n[t[r]]=!0;var i={};for(var r=0;r<this._databaseNamesBySecurityOrigin[e].length;++r)i[this._databaseNamesBySecurityOrigin[e][r]]=!0;this._databaseNamesBySecurityOrigin[e]=t;for(var s in i)n[s]||this._databaseRemoved(e,s);for(var s in n)i[s]||this._databaseAdded(e,s)},_databaseAdded:function(e,t){var n=new WebInspector.IndexedDBModel.DatabaseId(e,t);this.dispatchEventToListeners(WebInspector.IndexedDBModel.EventTypes.DatabaseAdded,n)},_databaseRemoved:function(e,t){var n=new WebInspector.IndexedDBModel.DatabaseId(e,t);this.dispatchEventToListeners(WebInspector.IndexedDBModel.EventTypes.DatabaseRemoved,n)},_loadDatabaseNames:function(e){function t(t,n){if(t){console.error("IndexedDBAgent error: "+t);return}if(!this._databaseNamesBySecurityOrigin[e])return;this._updateOriginDatabaseNames(e,n)}IndexedDBAgent.requestDatabaseNames(e,t.bind(this))},_loadDatabase:function(e){function t(t,n){if(t){console.error("IndexedDBAgent error: "+t);return}if(!this._databaseNamesBySecurityOrigin[e.securityOrigin])return;var r=new WebInspector.IndexedDBModel.Database(e,n.version,n.intVersion);this._databases.put(e,r);for(var i=0;i<n.objectStores.length;++i){var s=n.objectStores[i],o=WebInspector.IndexedDBModel.idbKeyPathFromKeyPath(s.keyPath),u=new WebInspector.IndexedDBModel.ObjectStore(s.name,o,s.autoIncrement);for(var a=0;a<s.indexes.length;++a){var f=s.indexes[a],l=WebInspector.IndexedDBModel.idbKeyPathFromKeyPath(f.keyPath),c=new WebInspector.IndexedDBModel.Index(f.name,l,f.unique,f.multiEntry);u.indexes[c.name]=c}r.objectStores[u.name]=u}this.dispatchEventToListeners(WebInspector.IndexedDBModel.EventTypes.DatabaseLoaded,r)}IndexedDBAgent.requestDatabase(e.securityOrigin,e.name,t.bind(this))},loadObjectStoreData:function(e,t,n,r,i,s){this._requestData(e,e.name,t,"",n,r,i,s)},loadIndexData:function(e,t,n,r,i,s,o){this._requestData(e,e.name,t,n,r,i,s,o)},_requestData:function(e,t,n,r,i,s,o,u){function a(t,n,r){if(t){console.error("IndexedDBAgent error: "+t);return}if(!this._databaseNamesBySecurityOrigin[e.securityOrigin])return;var i=[];for(var s=0;s<n.length;++s){var o=WebInspector.RemoteObject.fromPayload(n[s].key),a=WebInspector.RemoteObject.fromPayload(n[s].primaryKey),f=WebInspector.RemoteObject.fromPayload(n[s].value);i.push(new WebInspector.IndexedDBModel.Entry(o,a,f))}u(i,r)}var f=WebInspector.IndexedDBModel.keyRangeFromIDBKeyRange(i);IndexedDBAgent.requestData(e.securityOrigin,t,n,r,s,o,f?f:undefined,a.bind(this))},__proto__:WebInspector.Object.prototype},WebInspector.IndexedDBModel.Entry=function(e,t,n){this.key=e,this.primaryKey=t,this.value=n},WebInspector.IndexedDBModel.DatabaseId=function(e,t){this.securityOrigin=e,this.name=t},WebInspector.IndexedDBModel.DatabaseId.prototype={equals:function(e){return this.name===e.name&&this.securityOrigin===e.securityOrigin}},WebInspector.IndexedDBModel.Database=function(e,t,n){this.databaseId=e,this.version=t,this.intVersion=n,this.objectStores={}},WebInspector.IndexedDBModel.ObjectStore=function(e,t,n){this.name=e,this.keyPath=t,this.autoIncrement=n,this.indexes={}},WebInspector.IndexedDBModel.ObjectStore.prototype={get keyPathString(){return WebInspector.IndexedDBModel.keyPathStringFromIDBKeyPath(this.keyPath)}},WebInspector.IndexedDBModel.Index=function(e,t,n,r){this.name=e,this.keyPath=t,this.unique=n,this.multiEntry=r},WebInspector.IndexedDBModel.Index.prototype={get keyPathString(){return WebInspector.IndexedDBModel.keyPathStringFromIDBKeyPath(this.keyPath)}};