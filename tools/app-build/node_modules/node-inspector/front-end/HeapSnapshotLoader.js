/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.HeapSnapshotLoader=function(e){this._reset(),this._progress=new WebInspector.HeapSnapshotProgress(e)},WebInspector.HeapSnapshotLoader.prototype={dispose:function(){this._reset()},_reset:function(){this._json="",this._state="find-snapshot-info",this._snapshot={}},close:function(){this._json&&this._parseStringsArray()},buildSnapshot:function(e){this._progress.updateStatus("Processing snapshot…");var t=WebInspector[e],n=new t(this._snapshot,this._progress);return this._reset(),n},_parseUintArray:function(){var e=0,t="0".charCodeAt(0),n="9".charCodeAt(0),r="]".charCodeAt(0),i=this._json.length;for(;;){while(e<i){var s=this._json.charCodeAt(e);if(t<=s&&s<=n)break;if(s===r)return this._json=this._json.slice(e+1),!1;++e}if(e===i)return this._json="",!0;var o=0,u=e;while(e<i){var s=this._json.charCodeAt(e);if(t>s||s>n)break;o*=10,o+=s-t,++e}if(e===i)return this._json=this._json.slice(u),!0;this._array[this._arrayIndex++]=o}},_parseStringsArray:function(){this._progress.updateStatus("Parsing strings…");var e=this._json.lastIndexOf("]");if(e===-1)throw new Error("Incomplete JSON");this._json=this._json.slice(0,e+1),this._snapshot.strings=JSON.parse(this._json)},write:function(e){this._json+=e;switch(this._state){case"find-snapshot-info":var t='"snapshot"',n=this._json.indexOf(t);if(n===-1)throw new Error("Snapshot token not found");this._json=this._json.slice(n+t.length+1),this._state="parse-snapshot-info",this._progress.updateStatus("Loading snapshot info…");case"parse-snapshot-info":var r=WebInspector.findBalancedCurlyBrackets(this._json);if(r===-1)return;this._snapshot.snapshot=JSON.parse(this._json.slice(0,r)),this._json=this._json.slice(r),this._state="find-nodes";case"find-nodes":var i='"nodes"',s=this._json.indexOf(i);if(s===-1)return;var o=this._json.indexOf("[",s);if(o===-1)return;this._json=this._json.slice(o+1);var u=this._snapshot.snapshot.meta.node_fields.length,a=this._snapshot.snapshot.node_count*u;this._array=new Uint32Array(a),this._arrayIndex=0,this._state="parse-nodes";case"parse-nodes":var f=this._parseUintArray();this._progress.updateProgress("Loading nodes… %d%",this._arrayIndex,this._array.length);if(f)return;this._snapshot.nodes=this._array,this._state="find-edges",this._array=null;case"find-edges":var l='"edges"',c=this._json.indexOf(l);if(c===-1)return;var o=this._json.indexOf("[",c);if(o===-1)return;this._json=this._json.slice(o+1);var h=this._snapshot.snapshot.meta.edge_fields.length,p=this._snapshot.snapshot.edge_count*h;this._array=new Uint32Array(p),this._arrayIndex=0,this._state="parse-edges";case"parse-edges":var f=this._parseUintArray();this._progress.updateProgress("Loading edges… %d%",this._arrayIndex,this._array.length);if(f)return;this._snapshot.edges=this._array,this._array=null,this._state="find-strings",this._progress.updateStatus("Loading strings…");case"find-strings":var d='"strings"',v=this._json.indexOf(d);if(v===-1)return;var o=this._json.indexOf("[",v);if(o===-1)return;this._json=this._json.slice(o),this._state="accumulate-strings";break;case"accumulate-strings":}}};