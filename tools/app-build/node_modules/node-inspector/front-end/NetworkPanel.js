/*
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2008, 2009 Anthony Ricaud <rik@webkit.org>
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

importScript("RequestView.js"),importScript("NetworkItemView.js"),importScript("RequestCookiesView.js"),importScript("RequestHeadersView.js"),importScript("RequestHTMLView.js"),importScript("RequestJSONView.js"),importScript("RequestPreviewView.js"),importScript("RequestResponseView.js"),importScript("RequestTimingView.js"),importScript("ResourceWebSocketFrameView.js"),WebInspector.NetworkLogView=function(e){WebInspector.View.call(this),this.registerRequiredCSS("networkLogView.css"),this._coulmnsVisibilitySetting=e,this._allowRequestSelection=!1,this._requests=[],this._requestsById={},this._requestsByURL={},this._staleRequests={},this._requestGridNodes={},this._lastRequestGridNodeId=0,this._mainRequestLoadTime=-1,this._mainRequestDOMContentLoadedTime=-1,this._typeFilterElements={},this._typeFilter=WebInspector.NetworkLogView._trivialTypeFilter,this._matchedRequests=[],this._highlightedSubstringChanges=[],this._filteredOutRequests=new Map,this._matchedRequestsMap={},this._currentMatchedRequestIndex=-1,this._createStatusbarButtons(),this._createStatusBarItems(),this._linkifier=new WebInspector.Linkifier,WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.RequestStarted,this._onRequestStarted,this),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.RequestUpdated,this._onRequestUpdated,this),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.RequestFinished,this._onRequestUpdated,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.MainFrameNavigated,this._mainFrameNavigated,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.Load,this._loadEventFired,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.DOMContentLoaded,this._domContentLoadedEventFired,this),this._initializeView(),WebInspector.networkLog.requests.forEach(this._appendRequest.bind(this))},WebInspector.NetworkLogView.HTTPSchemas={http:!0,https:!0,ws:!0,wss:!0},WebInspector.NetworkLogView._responseHeaderColumns=["Cache-Control","Connection","Content-Encoding","Content-Length","ETag","Keep-Alive","Last-Modified","Server","Vary"],WebInspector.NetworkLogView._defaultColumnsVisibility={method:!0,status:!0,scheme:!1,domain:!1,type:!0,initiator:!0,cookies:!1,setCookies:!1,size:!0,time:!0,"Cache-Control":!1,Connection:!1,"Content-Encoding":!1,"Content-Length":!1,ETag:!1,"Keep-Alive":!1,"Last-Modified":!1,Server:!1,Vary:!1},WebInspector.NetworkLogView._defaultRefreshDelay=500,WebInspector.NetworkLogView.ALL_TYPES="all",WebInspector.NetworkLogView.prototype={_initializeView:function(){this.element.id="network-container",this._createSortingFunctions(),this._createTable(),this._createTimelineGrid(),this._createSummaryBar(),this.useLargeRows||this._setLargerRequests(this.useLargeRows),this._allowPopover=!0,this._popoverHelper=new WebInspector.PopoverHelper(this.element,this._getPopoverAnchor.bind(this),this._showPopover.bind(this),this._onHidePopover.bind(this)),this._popoverHelper.setTimeout(100),this.calculator=new WebInspector.NetworkTransferTimeCalculator,this._toggleTypeFilter(WebInspector.NetworkLogView.ALL_TYPES,!1),this.switchToDetailedView()},get statusBarItems(){return[this._largerRequestsButton.element,this._preserveLogToggle.element,this._clearButton.element,this._filterBarElement,this._progressBarContainer]},get useLargeRows(){return WebInspector.settings.resourcesLargeRows.get()},set allowPopover(e){this._allowPopover=e},elementsToRestoreScrollPositionsFor:function(){return this._dataGrid?[this._dataGrid.scrollContainer]:[]},onResize:function(){this._updateOffscreenRows()},_createTimelineGrid:function(){this._timelineGrid=new WebInspector.TimelineGrid,this._timelineGrid.element.addStyleClass("network-timeline-grid"),this._dataGrid.element.appendChild(this._timelineGrid.element)},_createTable:function(){var e=[];e.push({id:"name",titleDOMFragment:this._makeHeaderFragment(WebInspector.UIString("Name"),WebInspector.UIString("Path")),title:WebInspector.UIString("Name"),sortable:!0,weight:20,disclosure:!0}),e.push({id:"method",title:WebInspector.UIString("Method"),sortable:!0,weight:6}),e.push({id:"status",titleDOMFragment:this._makeHeaderFragment(WebInspector.UIString("Status"),WebInspector.UIString("Text")),title:WebInspector.UIString("Status"),sortable:!0,weight:6}),e.push({id:"scheme",title:WebInspector.UIString("Scheme"),sortable:!0,weight:6}),e.push({id:"domain",title:WebInspector.UIString("Domain"),sortable:!0,weight:6}),e.push({id:"type",title:WebInspector.UIString("Type"),sortable:!0,weight:6}),e.push({id:"initiator",title:WebInspector.UIString("Initiator"),sortable:!0,weight:10}),e.push({id:"cookies",title:WebInspector.UIString("Cookies"),sortable:!0,weight:6,align:WebInspector.DataGrid.Align.Right}),e.push({id:"setCookies",title:WebInspector.UIString("Set-Cookies"),sortable:!0,weight:6,align:WebInspector.DataGrid.Align.Right}),e.push({id:"size",titleDOMFragment:this._makeHeaderFragment(WebInspector.UIString("Size"),WebInspector.UIString("Content")),title:WebInspector.UIString("Size"),sortable:!0,weight:6,align:WebInspector.DataGrid.Align.Right}),e.push({id:"time",titleDOMFragment:this._makeHeaderFragment(WebInspector.UIString("Time"),WebInspector.UIString("Latency")),title:WebInspector.UIString("Time"),sortable:!0,weight:6,align:WebInspector.DataGrid.Align.Right});var t=WebInspector.NetworkLogView._responseHeaderColumns;for(var n=0;n<t.length;++n){var r=t[n],i={id:r,title:WebInspector.UIString(r),weight:6};r==="Content-Length"&&(i.align=WebInspector.DataGrid.Align.Right),e.push(i)}e.push({id:"timeline",titleDOMFragment:document.createDocumentFragment(),title:WebInspector.UIString("Timeline"),sortable:!1,weight:40,sort:WebInspector.DataGrid.Order.Ascending}),this._dataGrid=new WebInspector.DataGrid(e),this._dataGrid.setName("networkLog"),this._dataGrid.resizeMethod=WebInspector.DataGrid.ResizeMethod.Last,this._dataGrid.element.addStyleClass("network-log-grid"),this._dataGrid.element.addEventListener("contextmenu",this._contextMenu.bind(this),!0),this._dataGrid.show(this.element),this._dataGrid.addEventListener(WebInspector.DataGrid.Events.SortingChanged,this._sortItems,this),this._dataGrid.addEventListener(WebInspector.DataGrid.Events.ColumnsResized,this._updateDividersIfNeeded,this),this._dataGrid.scrollContainer.addEventListener("scroll",this._updateOffscreenRows.bind(this)),this._patchTimelineHeader()},_makeHeaderFragment:function(e,t){var n=document.createDocumentFragment();n.createTextChild(e);var r=n.createChild("div","network-header-subtitle");return r.createTextChild(t),n},_patchTimelineHeader:function(){var e=document.createElement("select"),t=document.createElement("option");t.value="startTime",t.label=WebInspector.UIString("Timeline"),e.appendChild(t),t=document.createElement("option"),t.value="startTime",t.label=WebInspector.UIString("Start Time"),e.appendChild(t),t=document.createElement("option"),t.value="responseTime",t.label=WebInspector.UIString("Response Time"),e.appendChild(t),t=document.createElement("option"),t.value="endTime",t.label=WebInspector.UIString("End Time"),e.appendChild(t),t=document.createElement("option"),t.value="duration",t.label=WebInspector.UIString("Duration"),e.appendChild(t),t=document.createElement("option"),t.value="latency",t.label=WebInspector.UIString("Latency"),e.appendChild(t);var n=this._dataGrid.headerTableHeader("timeline");n.replaceChild(e,n.firstChild),e.addEventListener("click",function(e){e.consume()},!1),e.addEventListener("change",this._sortByTimeline.bind(this),!1),this._timelineSortSelector=e},_createSortingFunctions:function(){this._sortingFunctions={},this._sortingFunctions.name=WebInspector.NetworkDataGridNode.NameComparator,this._sortingFunctions.method=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"method",!1),this._sortingFunctions.status=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"statusCode",!1),this._sortingFunctions.scheme=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"scheme",!1),this._sortingFunctions.domain=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"domain",!1),this._sortingFunctions.type=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"mimeType",!1),this._sortingFunctions.initiator=WebInspector.NetworkDataGridNode.InitiatorComparator,this._sortingFunctions.cookies=WebInspector.NetworkDataGridNode.RequestCookiesCountComparator,this._sortingFunctions.setCookies=WebInspector.NetworkDataGridNode.ResponseCookiesCountComparator,this._sortingFunctions.size=WebInspector.NetworkDataGridNode.SizeComparator,this._sortingFunctions.time=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"duration",!1),this._sortingFunctions.timeline=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"startTime",!1),this._sortingFunctions.startTime=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"startTime",!1),this._sortingFunctions.endTime=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"endTime",!1),this._sortingFunctions.responseTime=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"responseReceivedTime",!1),this._sortingFunctions.duration=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"duration",!0),this._sortingFunctions.latency=WebInspector.NetworkDataGridNode.RequestPropertyComparator.bind(null,"latency",!0);var e=new WebInspector.NetworkTransferTimeCalculator,t=new WebInspector.NetworkTransferDurationCalculator;this._calculators={},this._calculators.timeline=e,this._calculators.startTime=e,this._calculators.endTime=e,this._calculators.responseTime=e,this._calculators.duration=t,this._calculators.latency=t},_sortItems:function(){this._removeAllNodeHighlights();var e=this._dataGrid.sortColumnIdentifier();if(e==="timeline"){this._sortByTimeline();return}var t=this._sortingFunctions[e];if(!t)return;this._dataGrid.sortNodes(t,!this._dataGrid.isSortOrderAscending()),this._timelineSortSelector.selectedIndex=0,this._updateOffscreenRows(),this.searchCanceled(),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.NetworkSort,column:e,sortOrder:this._dataGrid.sortOrder()})},_sortByTimeline:function(){this._removeAllNodeHighlights();var e=this._timelineSortSelector.selectedIndex;e||(e=1);var t=this._timelineSortSelector[e],n=t.value,r=this._sortingFunctions[n];this._dataGrid.sortNodes(r),this.calculator=this._calculators[n],this.calculator.startAtZero?this._timelineGrid.hideEventDividers():this._timelineGrid.showEventDividers(),this._dataGrid.markColumnAsSortedBy("timeline",WebInspector.DataGrid.Order.Ascending),this._updateOffscreenRows()},_addTypeFilter:function(e,t){var n=this._filterBarElement.createChild("li",e);n.typeName=e,n.createTextChild(t),n.addEventListener("click",this._onTypeFilterClicked.bind(this),!1),this._typeFilterElements[e]=n},_createStatusBarItems:function(){var e=document.createElement("div");e.className="scope-bar status-bar-item",e.title=WebInspector.UIString("Use %s Click to select multiple types.",WebInspector.KeyboardShortcut.shortcutToString("",WebInspector.KeyboardShortcut.Modifiers.CtrlOrMeta)),this._filterBarElement=e,this._addTypeFilter(WebInspector.NetworkLogView.ALL_TYPES,WebInspector.UIString("All")),e.createChild("div","scope-bar-divider");for(var t in WebInspector.resourceTypes){var n=WebInspector.resourceTypes[t];this._addTypeFilter(n.name(),n.categoryTitle())}this._progressBarContainer=document.createElement("div"),this._progressBarContainer.className="status-bar-item"},_createSummaryBar:function(){var e=this._dataGrid.dataTableBody,t=document.createElement("tfoot"),n=t.createChild("tr","revealed network-summary-bar"),r=n.createChild("td");r.setAttribute("colspan",7),e.parentNode.insertBefore(t,e),this._summaryBarElement=r},_updateSummaryBar:function(){var e=this._requests.length;if(!e){if(this._summaryBarElement._isDisplayingWarning)return;this._summaryBarElement._isDisplayingWarning=!0,this._summaryBarElement.removeChildren(),this._summaryBarElement.createChild("div","warning-icon-small"),this._summaryBarElement.appendChild(document.createTextNode(WebInspector.UIString("No requests captured. Reload the page to see detailed information on the network activity.")));return}delete this._summaryBarElement._isDisplayingWarning;var t=0,n=0,r=0,i=-1,s=-1;for(var o=0;o<this._requests.length;++o){var u=this._requests[o],a=u.transferSize;t+=a,this._filteredOutRequests.get(u)||(n++,r+=a),u.url===WebInspector.inspectedPageURL&&(i=u.startTime),u.endTime>s&&(s=u.endTime)}var f="";n!==e?(f+=String.sprintf(WebInspector.UIString("%d / %d requests"),n,e),f+="  ❘  "+String.sprintf(WebInspector.UIString("%s / %s transferred"),Number.bytesToString(r),Number.bytesToString(t))):(f+=String.sprintf(WebInspector.UIString("%d requests"),e),f+="  ❘  "+String.sprintf(WebInspector.UIString("%s transferred"),Number.bytesToString(t))),i!==-1&&this._mainRequestLoadTime!==-1&&this._mainRequestDOMContentLoadedTime!==-1&&this._mainRequestDOMContentLoadedTime>i&&(f+="  ❘  "+String.sprintf(WebInspector.UIString("%s (load: %s, DOMContentLoaded: %s)"),Number.secondsToString(s-i),Number.secondsToString(this._mainRequestLoadTime-i),Number.secondsToString(this._mainRequestDOMContentLoadedTime-i))),this._summaryBarElement.textContent=f},_onTypeFilterClicked:function(e){var t;WebInspector.isMac()?t=e.metaKey&&!e.ctrlKey&&!e.altKey&&!e.shiftKey:t=e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey,this._toggleTypeFilter(e.target.typeName,t),this._removeAllNodeHighlights(),this.searchCanceled(),this._filterRequests()},_toggleTypeFilter:function(e,t){if(t&&e!==WebInspector.NetworkLogView.ALL_TYPES)this._typeFilterElements[WebInspector.NetworkLogView.ALL_TYPES].removeStyleClass("selected");else for(var n in this._typeFilterElements)this._typeFilterElements[n].removeStyleClass("selected");var r=this._typeFilterElements[e];r.enableStyleClass("selected",!r.hasStyleClass("selected"));var i={};for(var n in this._typeFilterElements)this._typeFilterElements[n].hasStyleClass("selected")&&(i[n]=!0);e===WebInspector.NetworkLogView.ALL_TYPES?this._typeFilter=WebInspector.NetworkLogView._trivialTypeFilter:this._typeFilter=WebInspector.NetworkLogView._typeFilter.bind(null,i)},_scheduleRefresh:function(){if(this._needsRefresh)return;this._needsRefresh=!0,this.isShowing()&&!this._refreshTimeout&&(this._refreshTimeout=setTimeout(this.refresh.bind(this),WebInspector.NetworkLogView._defaultRefreshDelay))},_updateDividersIfNeeded:function(){if(!this._dataGrid)return;var e=this._dataGrid.columns.timeline;for(var t=0;t<this._dataGrid.resizers.length;++t)e.ordinal===this._dataGrid.resizers[t].rightNeighboringColumnIndex&&(this._timelineGrid.element.style.left=this._dataGrid.resizers[t].style.left);var n=!0;this.isShowing()?(this.calculator.setDisplayWindow(this._timelineGrid.dividersElement.clientWidth),n=this._timelineGrid.updateDividers(this.calculator)):(this._scheduleRefresh(),n=!1);if(!n)return;if(this.calculator.startAtZero||!this.calculator.computePercentageFromEventTime)return;this._timelineGrid.removeEventDividers();if(this._mainRequestLoadTime!==-1){var r=this.calculator.computePercentageFromEventTime(this._mainRequestLoadTime),i=document.createElement("div");i.className="network-event-divider network-red-divider";var s=document.createElement("div");s.className="network-event-divider-padding",s.title=WebInspector.UIString("Load event fired"),s.appendChild(i),s.style.left=r+"%",this._timelineGrid.addEventDivider(s)}if(this._mainRequestDOMContentLoadedTime!==-1){var r=this.calculator.computePercentageFromEventTime(this._mainRequestDOMContentLoadedTime),o=document.createElement("div");o.className="network-event-divider network-blue-divider";var u=document.createElement("div");u.className="network-event-divider-padding",u.title=WebInspector.UIString("DOMContentLoaded event fired"),u.appendChild(o),u.style.left=r+"%",this._timelineGrid.addEventDivider(u)}},_refreshIfNeeded:function(){this._needsRefresh&&this.refresh()},_invalidateAllItems:function(){for(var e=0;e<this._requests.length;++e){var t=this._requests[e];this._staleRequests[t.requestId]=t}},get calculator(){return this._calculator},set calculator(e){if(!e||this._calculator===e)return;this._calculator=e,this._calculator.reset(),this._invalidateAllItems(),this.refresh()},_requestGridNode:function(e){return this._requestGridNodes[e.__gridNodeId]},_createRequestGridNode:function(e){var t=new WebInspector.NetworkDataGridNode(this,e);return e.__gridNodeId=this._lastRequestGridNodeId++,this._requestGridNodes[e.__gridNodeId]=t,t},_createStatusbarButtons:function(){this._preserveLogToggle=new WebInspector.StatusBarButton(WebInspector.UIString("Preserve Log upon Navigation"),"record-profile-status-bar-item"),this._preserveLogToggle.addEventListener("click",this._onPreserveLogClicked,this),this._clearButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear"),"clear-status-bar-item"),this._clearButton.addEventListener("click",this._reset,this),this._largerRequestsButton=new WebInspector.StatusBarButton(WebInspector.UIString("Use small resource rows."),"network-larger-resources-status-bar-item"),this._largerRequestsButton.toggled=WebInspector.settings.resourcesLargeRows.get(),this._largerRequestsButton.addEventListener("click",this._toggleLargerRequests,this)},_loadEventFired:function(e){this._mainRequestLoadTime=e.data||-1,this._scheduleRefresh()},_domContentLoadedEventFired:function(e){this._mainRequestDOMContentLoadedTime=e.data||-1,this._scheduleRefresh()},wasShown:function(){this._refreshIfNeeded()},willHide:function(){this._popoverHelper.hidePopover()},refresh:function(){this._needsRefresh=!1,this._refreshTimeout&&(clearTimeout(this._refreshTimeout),delete this._refreshTimeout),this._removeAllNodeHighlights();var e=this._dataGrid.isScrolledToLastRow(),t=!1;this.calculator.updateBoundariesForEventTime&&(t=this.calculator.updateBoundariesForEventTime(this._mainRequestLoadTime)||t,t=this.calculator.updateBoundariesForEventTime(this._mainRequestDOMContentLoadedTime)||t);for(var n in this._staleRequests){var r=this._staleRequests[n],i=this._requestGridNode(r);i||(i=this._createRequestGridNode(r),this._dataGrid.rootNode().appendChild(i)),i.refreshRequest(),this._applyFilter(i),this.calculator.updateBoundaries(r)&&(t=!0),i.isFilteredOut()||this._updateHighlightIfMatched(r)}t&&this._invalidateAllItems();for(var n in this._staleRequests)this._requestGridNode(this._staleRequests[n]).refreshGraph(this.calculator);this._staleRequests={},this._sortItems(),this._updateSummaryBar(),this._dataGrid.updateWidths(),e&&this._dataGrid.scrollToLastRow()},_onPreserveLogClicked:function(e){this._preserveLogToggle.toggled=!this._preserveLogToggle.toggled},_reset:function(){this.dispatchEventToListeners(WebInspector.NetworkLogView.EventTypes.ViewCleared),this._clearSearchMatchedList(),this._popoverHelper&&this._popoverHelper.hidePopover(),this._calculator&&this._calculator.reset(),this._requests=[],this._requestsById={},this._requestsByURL={},this._staleRequests={},this._requestGridNodes={},this._dataGrid&&(this._dataGrid.rootNode().removeChildren(),this._updateDividersIfNeeded(),this._updateSummaryBar()),this._mainRequestLoadTime=-1,this._mainRequestDOMContentLoadedTime=-1},get requests(){return this._requests},requestById:function(e){return this._requestsById[e]},_onRequestStarted:function(e){this._appendRequest(e.data)},_appendRequest:function(e){this._requests.push(e);if(this._requestsById[e.requestId]){var t=e.redirects[e.redirects.length-1];this._requestsById[t.requestId]=t,this._updateSearchMatchedListAfterRequestIdChanged(e.requestId,t.requestId)}this._requestsById[e.requestId]=e,this._requestsByURL[e.url]=e;if(e.redirects)for(var n=0;n<e.redirects.length;++n)this._refreshRequest(e.redirects[n]);this._refreshRequest(e)},_onRequestUpdated:function(e){var t=e.data;this._refreshRequest(t)},_refreshRequest:function(e){this._staleRequests[e.requestId]=e,this._scheduleRefresh()},clear:function(){if(this._preserveLogToggle.toggled)return;this._reset()},_mainFrameNavigated:function(e){if(this._preserveLogToggle.toggled)return;var t=e.data,n=t.loaderId,r=[];for(var i=0;i<this._requests.length;++i){var s=this._requests[i];s.loaderId===n&&r.push(s)}this._reset();for(var i=0;i<r.length;++i)this._appendRequest(r[i])},switchToDetailedView:function(){if(!this._dataGrid)return;this._dataGrid.selectedNode&&(this._dataGrid.selectedNode.selected=!1),this.element.removeStyleClass("brief-mode"),this._detailedMode=!0,this._updateColumns()},switchToBriefView:function(){this.element.addStyleClass("brief-mode"),this._removeAllNodeHighlights(),this._detailedMode=!1,this._updateColumns(),this._popoverHelper.hidePopover()},_toggleLargerRequests:function(){WebInspector.settings.resourcesLargeRows.set(!WebInspector.settings.resourcesLargeRows.get()),this._setLargerRequests(WebInspector.settings.resourcesLargeRows.get())},_setLargerRequests:function(e){this._largerRequestsButton.toggled=e,e?(this._largerRequestsButton.title=WebInspector.UIString("Use small resource rows."),this._dataGrid.element.removeStyleClass("small"),this._timelineGrid.element.removeStyleClass("small")):(this._largerRequestsButton.title=WebInspector.UIString("Use large resource rows."),this._dataGrid.element.addStyleClass("small"),this._timelineGrid.element.addStyleClass("small")),this.dispatchEventToListeners(WebInspector.NetworkLogView.EventTypes.RowSizeChanged,{largeRows:e}),this._updateOffscreenRows()},_getPopoverAnchor:function(e){if(!this._allowPopover)return;var t=e.enclosingNodeOrSelfWithClass("network-graph-bar")||e.enclosingNodeOrSelfWithClass("network-graph-label");return t&&t.parentElement.request&&t.parentElement.request.timing?t:(t=e.enclosingNodeOrSelfWithClass("network-script-initiated"),t&&t.request&&t.request.initiator?t:null)},_showPopover:function(e,t){var n;e.hasStyleClass("network-script-initiated")?n=this._generateScriptInitiatedPopoverContent(e.request):n=WebInspector.RequestTimingView.createTimingTable(e.parentElement.request),t.show(n,e)},_onHidePopover:function(){this._linkifier.reset()},_generateScriptInitiatedPopoverContent:function(e){var t=e.initiator.stackTrace,n=document.createElement("table");for(var r=0;r<t.length;++r){var i=t[r],s=document.createElement("tr");s.createChild("td").textContent=i.functionName?i.functionName:WebInspector.UIString("(anonymous function)"),s.createChild("td").textContent=" @ ",s.createChild("td").appendChild(this._linkifier.linkifyLocation(i.url,i.lineNumber-1,i.columnNumber-1)),n.appendChild(s)}return n},_updateColumns:function(){var e=this._coulmnsVisibilitySetting.get(),t=!!this._detailedMode;for(var n in e){var r=t&&e[n];this._dataGrid.setColumnVisible(n,r)}this._dataGrid.setColumnVisible("timeline",t),this._dataGrid.applyColumnWeights()},_toggleColumnVisibility:function(e){var t=this._coulmnsVisibilitySetting.get();t[e]=!t[e],this._coulmnsVisibilitySetting.set(t),this._updateColumns()},_getConfigurableColumnIDs:function(){function t(t,n){return e[t].title.compareTo(e[n].title)}if(this._configurableColumnIDs)return this._configurableColumnIDs;var e=this._dataGrid.columns,n=Object.keys(this._coulmnsVisibilitySetting.get());return this._configurableColumnIDs=n.sort(t),this._configurableColumnIDs},_contextMenu:function(e){var t=new WebInspector.ContextMenu(e);if(this._detailedMode&&e.target.isSelfOrDescendant(this._dataGrid.headerTableBody)){var n=this._coulmnsVisibilitySetting.get(),r=this._getConfigurableColumnIDs();for(var i=0;i<r.length;++i){var s=r[i],o=this._dataGrid.columns[s];t.appendCheckboxItem(o.title,this._toggleColumnVisibility.bind(this,s),!!n[s])}t.show();return}var u=this._dataGrid.dataGridNodeFromNode(e.target),a=u&&u._request;a&&(t.appendItem(WebInspector.openLinkExternallyLabel(),WebInspector.openResource.bind(WebInspector,a.url,!1)),t.appendSeparator(),t.appendItem(WebInspector.copyLinkAddressLabel(),this._copyLocation.bind(this,a)),a.requestHeadersText&&t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Copy request headers":"Copy Request Headers"),this._copyRequestHeaders.bind(this,a)),a.responseHeadersText&&t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Copy response headers":"Copy Response Headers"),this._copyResponseHeaders.bind(this,a)),t.appendItem(WebInspector.UIString("Copy as cURL"),this._copyCurlCommand.bind(this,a))),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Copy all as HAR":"Copy All as HAR"),this._copyAll.bind(this)),t.appendSeparator(),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Save as HAR with content":"Save as HAR with Content"),this._exportAll.bind(this)),t.appendSeparator(),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Clear browser cache":"Clear Browser Cache"),this._clearBrowserCache.bind(this)),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Clear browser cookies":"Clear Browser Cookies"),this._clearBrowserCookies.bind(this)),a&&a.type===WebInspector.resourceTypes.XHR&&(t.appendSeparator(),t.appendItem(WebInspector.UIString("Replay XHR"),this._replayXHR.bind(this,a.requestId)),t.appendSeparator()),t.show()},_replayXHR:function(e){NetworkAgent.replayXHR(e)},_copyAll:function(){var e={log:(new WebInspector.HARLog(this._requests.filter(WebInspector.NetworkLogView.HTTPRequestsFilter))).build()};InspectorFrontendHost.copyText(JSON.stringify(e,null,2))},_copyLocation:function(e){InspectorFrontendHost.copyText(e.url)},_copyRequestHeaders:function(e){InspectorFrontendHost.copyText(e.requestHeadersText)},_copyResponseHeaders:function(e){InspectorFrontendHost.copyText(e.responseHeadersText)},_copyCurlCommand:function(e){InspectorFrontendHost.copyText(this._generateCurlCommand(e))},_exportAll:function(){function n(){var e=new WebInspector.ProgressIndicator;this._progressBarContainer.appendChild(e.element);var n=new WebInspector.HARWriter;n.write(t,this._requests.filter(WebInspector.NetworkLogView.HTTPRequestsFilter),e)}var e=WebInspector.inspectedPageDomain+".har",t=new WebInspector.FileOutputStream;t.open(e,n.bind(this))},_clearBrowserCache:function(){confirm(WebInspector.UIString("Are you sure you want to clear browser cache?"))&&NetworkAgent.clearBrowserCache()},_clearBrowserCookies:function(){confirm(WebInspector.UIString("Are you sure you want to clear browser cookies?"))&&NetworkAgent.clearBrowserCookies()},_updateOffscreenRows:function(){var e=this._dataGrid.dataTableBody,t=e.children,n=t.length;if(n<2)return;var r=this._dataGrid.scrollContainer.scrollTop,i=r+this._dataGrid.scrollContainer.offsetHeight,s=0,o=0;for(var u=0;u<n-1;++u){var a=t[u],f=this._dataGrid.dataGridNodeFromNode(a);if(f.isFilteredOut()){a.removeStyleClass("offscreen");continue}s||(s=a.offsetHeight);var l=o*s<i&&(o+1)*s>r;l!==a.rowIsVisible&&(a.enableStyleClass("offscreen",!l),a.rowIsVisible=l),o++}},_matchRequest:function(e){if(!this._searchRegExp)return-1;if(!e.name().match(this._searchRegExp)&&!e.path().match(this._searchRegExp))return-1;if(e.requestId in this._matchedRequestsMap)return this._matchedRequestsMap[e.requestId];var t=this._matchedRequests.length;return this._matchedRequestsMap[e.requestId]=t,this._matchedRequests.push(e.requestId),t},_clearSearchMatchedList:function(){delete this._searchRegExp,this._matchedRequests=[],this._matchedRequestsMap={},this._removeAllHighlights()},_updateSearchMatchedListAfterRequestIdChanged:function(e,t){var n=this._matchedRequestsMap[e];n&&(delete this._matchedRequestsMap[e],this._matchedRequestsMap[t]=n,this._matchedRequests[n]=t)},_updateHighlightIfMatched:function(e){var t=this._matchRequest(e);if(t===-1)return;this.dispatchEventToListeners(WebInspector.NetworkLogView.EventTypes.SearchCountUpdated,this._matchedRequests.length);if(this._currentMatchedRequestIndex!==-1&&this._currentMatchedRequestIndex!==t)return;this._highlightNthMatchedRequestForSearch(t,!1)},_removeAllHighlights:function(){this._removeAllNodeHighlights();for(var e=0;e<this._highlightedSubstringChanges.length;++e)WebInspector.revertDomChanges(this._highlightedSubstringChanges[e]);this._highlightedSubstringChanges=[]},_highlightMatchedRequest:function(e,t,n){var r=this._requestGridNode(e);if(!r)return;var i=e.name().match(n),s=e.path().match(n);!i&&s&&!this._largerRequestsButton.toggled&&this._toggleLargerRequests();var o=r._highlightMatchedSubstring(n);this._highlightedSubstringChanges.push(o),t&&(r.reveal(),this._highlightNode(r))},_highlightNthMatchedRequestForSearch:function(e,t){var n=this.requestById(this._matchedRequests[e]);if(!n)return;this._removeAllHighlights(),this._highlightMatchedRequest(n,t,this._searchRegExp);var r=this._requestGridNode(n);r&&(this._currentMatchedRequestIndex=e),this.dispatchEventToListeners(WebInspector.NetworkLogView.EventTypes.SearchIndexUpdated,this._currentMatchedRequestIndex)},performSearch:function(e,t){var n=0,r;this._currentMatchedRequestIndex!==-1&&(r=this._matchedRequests[this._currentMatchedRequestIndex]),this._clearSearchMatchedList(),this._searchRegExp=createPlainTextSearchRegex(e,"i");var i=this._dataGrid.dataTableBody.childNodes,s=Array.prototype.slice.call(i,0,i.length-1);for(var o=0;o<s.length;++o){var u=this._dataGrid.dataGridNodeFromNode(s[o]);if(u.isFilteredOut())continue;this._matchRequest(u._request)!==-1&&u._request.requestId===r&&(n=this._matchedRequests.length-1)}this.dispatchEventToListeners(WebInspector.NetworkLogView.EventTypes.SearchCountUpdated,this._matchedRequests.length),t&&this._highlightNthMatchedRequestForSearch(n,!0)},_applyFilter:function(e){var t=this._filterRegExp,n=e._request,r=!1;this._typeFilter(n)&&(r=!t||t.test(n.name())||t.test(n.path()),t&&r&&this._highlightMatchedRequest(n,!1,t)),e.element.enableStyleClass("filtered-out",!r),r?this._filteredOutRequests.remove(n):this._filteredOutRequests.put(n,!0)},performFilter:function(e){delete this._filterRegExp,e&&(this._filterRegExp=createPlainTextSearchRegex(e,"i")),this._filterRequests()},_filterRequests:function(){this._removeAllHighlights(),this._filteredOutRequests.clear();var e=this._dataGrid.rootNode().children;for(var t=0;t<e.length;++t)this._applyFilter(e[t]);this._updateSummaryBar(),this._updateOffscreenRows()},jumpToPreviousSearchResult:function(){if(!this._matchedRequests.length)return;this._highlightNthMatchedRequestForSearch((this._currentMatchedRequestIndex+this._matchedRequests.length-1)%this._matchedRequests.length,!0)},jumpToNextSearchResult:function(){if(!this._matchedRequests.length)return;this._highlightNthMatchedRequestForSearch((this._currentMatchedRequestIndex+1)%this._matchedRequests.length,!0)},searchCanceled:function(){this._clearSearchMatchedList(),this.dispatchEventToListeners(WebInspector.NetworkLogView.EventTypes.SearchCountUpdated,0)},revealAndHighlightRequest:function(e){this._removeAllNodeHighlights();var t=this._requestGridNode(e);t&&(this._dataGrid.element.focus(),t.reveal(),this._highlightNode(t))},_removeAllNodeHighlights:function(){this._highlightedNode&&(this._highlightedNode.element.removeStyleClass("highlighted-row"),delete this._highlightedNode)},_highlightNode:function(e){e.element.addStyleClass("highlighted-row"),this._highlightedNode=e},_generateCurlCommand:function(e){function r(e){var t=e.charCodeAt(0);return t<256?t<16?"\\x0"+t.toString(16):"\\x"+t.toString(16):(t=t.toString(16),"\\u"+("0000"+t).substr(t.length,4))}function i(e){return/[^\x20-\x7E]|\'/.test(e)?"$'"+e.replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[^\x20-\x7E]/g,r)+"'":"'"+e+"'"}var t=["curl"],n={};t.push(i(e.url).replace(/[[{}\]]/g,"\\$&"));var s="GET",o=[],u=e.requestContentType();u&&u.startsWith("application/x-www-form-urlencoded")&&e.requestFormData?(o.push("--data"),o.push(i(e.requestFormData)),n["Content-Length"]=!0,s="POST"):e.requestFormData&&(o.push("--data-binary"),o.push(i(e.requestFormData)),n["Content-Length"]=!0,s="POST"),e.requestMethod!==s&&(t.push("-X"),t.push(e.requestMethod));for(var a=0;a<e.requestHeaders.length;a++){var f=e.requestHeaders[a];if(f.name in n)continue;t.push("-H"),t.push(i(f.name+": "+f.value))}return t=t.concat(o),t.push("--compressed"),t.join(" ")},__proto__:WebInspector.View.prototype},WebInspector.NetworkLogView.HTTPRequestsFilter=function(e){return e.parsedURL.isValid&&e.scheme in WebInspector.NetworkLogView.HTTPSchemas},WebInspector.NetworkLogView.EventTypes={ViewCleared:"ViewCleared",RowSizeChanged:"RowSizeChanged",RequestSelected:"RequestSelected",SearchCountUpdated:"SearchCountUpdated",SearchIndexUpdated:"SearchIndexUpdated"},WebInspector.NetworkPanel=function(){function s(){return this.visibleView}WebInspector.Panel.call(this,"network"),this.registerRequiredCSS("networkPanel.css"),this._injectStyles(),this.createSidebarView(),this.splitView.hideMainElement();var e=WebInspector.NetworkLogView._defaultColumnsVisibility,t=WebInspector.settings.createSetting("networkLogColumnsVisibility",e),n=t.get(),r={};for(var i in e)r[i]=n.hasOwnProperty(i)?n[i]:e[i];t.set(r),this._networkLogView=new WebInspector.NetworkLogView(t),this._networkLogView.show(this.sidebarElement),this._viewsContainerElement=this.splitView.mainElement,this._viewsContainerElement.id="network-views",this._viewsContainerElement.addStyleClass("hidden"),this._networkLogView.useLargeRows||this._viewsContainerElement.addStyleClass("small"),this._networkLogView.addEventListener(WebInspector.NetworkLogView.EventTypes.ViewCleared,this._onViewCleared,this),this._networkLogView.addEventListener(WebInspector.NetworkLogView.EventTypes.RowSizeChanged,this._onRowSizeChanged,this),this._networkLogView.addEventListener(WebInspector.NetworkLogView.EventTypes.RequestSelected,this._onRequestSelected,this),this._networkLogView.addEventListener(WebInspector.NetworkLogView.EventTypes.SearchCountUpdated,this._onSearchCountUpdated,this),this._networkLogView.addEventListener(WebInspector.NetworkLogView.EventTypes.SearchIndexUpdated,this._onSearchIndexUpdated,this),this._closeButtonElement=this._viewsContainerElement.createChild("div","close-button"),this._closeButtonElement.id="network-close-button",this._closeButtonElement.addEventListener("click",this._toggleGridMode.bind(this),!1),this._viewsContainerElement.appendChild(this._closeButtonElement),WebInspector.GoToLineDialog.install(this,s.bind(this))},WebInspector.NetworkPanel.prototype={get statusBarItems(){return this._networkLogView.statusBarItems},elementsToRestoreScrollPositionsFor:function(){return this._networkLogView.elementsToRestoreScrollPositionsFor()},_reset:function(){this._networkLogView._reset()},handleShortcut:function(e){if(this._viewingRequestMode&&e.keyCode===WebInspector.KeyboardShortcut.Keys.Esc.code){this._toggleGridMode(),e.handled=!0;return}WebInspector.Panel.prototype.handleShortcut.call(this,e)},wasShown:function(){WebInspector.Panel.prototype.wasShown.call(this)},get requests(){return this._networkLogView.requests},requestById:function(e){return this._networkLogView.requestById(e)},_requestByAnchor:function(e){return e.requestId?this.requestById(e.requestId):this._networkLogView._requestsByURL[e.href]},canShowAnchorLocation:function(e){return!!this._requestByAnchor(e)},showAnchorLocation:function(e){var t=this._requestByAnchor(e);this.revealAndHighlightRequest(t)},revealAndHighlightRequest:function(e){this._toggleGridMode(),e&&this._networkLogView.revealAndHighlightRequest(e)},_onViewCleared:function(e){this._closeVisibleRequest(),this._toggleGridMode(),this._viewsContainerElement.removeChildren(),this._viewsContainerElement.appendChild(this._closeButtonElement)},_onRowSizeChanged:function(e){this._viewsContainerElement.enableStyleClass("small",!e.data.largeRows)},_onSearchCountUpdated:function(e){WebInspector.searchController.updateSearchMatchesCount(e.data,this)},_onSearchIndexUpdated:function(e){WebInspector.searchController.updateCurrentMatchIndex(e.data,this)},_onRequestSelected:function(e){this._showRequest(e.data)},_showRequest:function(e){if(!e)return;this._toggleViewingRequestMode(),this.visibleView&&(this.visibleView.detach(),delete this.visibleView);var t=new WebInspector.NetworkItemView(e);t.show(this._viewsContainerElement),this.visibleView=t},_closeVisibleRequest:function(){this.element.removeStyleClass("viewing-resource"),this.visibleView&&(this.visibleView.detach(),delete this.visibleView)},_toggleGridMode:function(){this._viewingRequestMode&&(this._viewingRequestMode=!1,this.element.removeStyleClass("viewing-resource"),this.splitView.hideMainElement()),this._networkLogView.switchToDetailedView(),this._networkLogView.allowPopover=!0,this._networkLogView._allowRequestSelection=!1},_toggleViewingRequestMode:function(){if(this._viewingRequestMode)return;this._viewingRequestMode=!0,this.element.addStyleClass("viewing-resource"),this.splitView.showMainElement(),this._networkLogView.allowPopover=!1,this._networkLogView._allowRequestSelection=!0,this._networkLogView.switchToBriefView()},performSearch:function(e,t){this._networkLogView.performSearch(e,t)},canFilter:function(){return!0},performFilter:function(e){this._networkLogView.performFilter(e)},jumpToPreviousSearchResult:function(){this._networkLogView.jumpToPreviousSearchResult()},jumpToNextSearchResult:function(){this._networkLogView.jumpToNextSearchResult()},searchCanceled:function(){this._networkLogView.searchCanceled()},appendApplicableItems:function(e,t,n){function r(e){WebInspector.inspectorView.setCurrentPanel(this),this.revealAndHighlightRequest(e)}function i(e){var n=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Reveal in Network panel":"Reveal in Network Panel");t.appendItem(n,r.bind(this,e))}if(n instanceof WebInspector.Resource){var s=n;s.request&&i.call(this,s.request);return}if(n instanceof WebInspector.UISourceCode){var o=n,s=WebInspector.resourceForURL(o.url);s&&s.request&&i.call(this,s.request);return}if(!(n instanceof WebInspector.NetworkRequest))return;var u=n;if(this.visibleView&&this.visibleView.isShowing()&&this.visibleView.request()===u)return;i.call(this,u)},_injectStyles:function(){var e=document.createElement("style"),t=[],n=WebInspector.NetworkLogView._defaultColumnsVisibility,r=[],i=[];for(var s in n)r.push("#network-container .hide-"+s+"-column ."+s+"-column"),i.push(".network-log-grid.data-grid td."+s+"-column");t.push(r.join(", ")+"{border-left: 0 none transparent;}"),t.push(i.join(", ")+"{background-color: rgba(0, 0, 0, 0.07);}"),e.textContent=t.join("\n"),document.head.appendChild(e)},__proto__:WebInspector.Panel.prototype},WebInspector.NetworkBaseCalculator=function(){},WebInspector.NetworkBaseCalculator.prototype={computePosition:function(e){return(e-this._minimumBoundary)/this.boundarySpan()*this._workingArea},computeBarGraphPercentages:function(e){return{start:0,middle:0,end:this._value(e)/this.boundarySpan()*100}},computeBarGraphLabels:function(e){const t=this.formatTime(this._value(e));return{left:t,right:t,tooltip:t}},boundarySpan:function(){return this._maximumBoundary-this._minimumBoundary},updateBoundaries:function(e){this._minimumBoundary=0;var t=this._value(e);return typeof this._maximumBoundary=="undefined"||t>this._maximumBoundary?(this._maximumBoundary=t,!0):!1},reset:function(){delete this._minimumBoundary,delete this._maximumBoundary},maximumBoundary:function(){return this._maximumBoundary},minimumBoundary:function(){return this._minimumBoundary},zeroTime:function(){return this._minimumBoundary},_value:function(e){return 0},formatTime:function(e){return e.toString()},setDisplayWindow:function(e){this._workingArea=e,this.paddingLeft=0}},WebInspector.NetworkTimeCalculator=function(e){WebInspector.NetworkBaseCalculator.call(this),this.startAtZero=e},WebInspector.NetworkTimeCalculator.prototype={computeBarGraphPercentages:function(e){if(e.startTime!==-1)var t=(e.startTime-this._minimumBoundary)/this.boundarySpan()*100;else var t=0;if(e.responseReceivedTime!==-1)var n=(e.responseReceivedTime-this._minimumBoundary)/this.boundarySpan()*100;else var n=this.startAtZero?t:100;if(e.endTime!==-1)var r=(e.endTime-this._minimumBoundary)/this.boundarySpan()*100;else var r=this.startAtZero?n:100;return this.startAtZero&&(r-=t,n-=t,t=0),{start:t,middle:n,end:r}},computePercentageFromEventTime:function(e){return e!==-1&&!this.startAtZero?(e-this._minimumBoundary)/this.boundarySpan()*100:0},updateBoundariesForEventTime:function(e){return e===-1||this.startAtZero?!1:typeof this._maximumBoundary=="undefined"||e>this._maximumBoundary?(this._maximumBoundary=e,!0):!1},computeBarGraphLabels:function(e){var t="";e.responseReceivedTime!==-1&&e.endTime!==-1&&(t=this.formatTime(e.endTime-e.responseReceivedTime));var n=e.latency>0;if(n)var r=this.formatTime(e.latency);else var r=t;if(e.timing)return{left:r,right:t};if(n&&t)var i=this.formatTime(e.duration),s=WebInspector.UIString("%s latency, %s download (%s total)",r,t,i);else if(n)var s=WebInspector.UIString("%s latency",r);else if(t)var s=WebInspector.UIString("%s download",t);return e.cached&&(s=WebInspector.UIString("%s (from cache)",s)),{left:r,right:t,tooltip:s}},updateBoundaries:function(e){var t=!1,n;this.startAtZero?n=0:n=this._lowerBound(e),n!==-1&&(typeof this._minimumBoundary=="undefined"||n<this._minimumBoundary)&&(this._minimumBoundary=n,t=!0);var r=this._upperBound(e);return r!==-1&&(typeof this._maximumBoundary=="undefined"||r>this._maximumBoundary)&&(this._maximumBoundary=r,t=!0),t},formatTime:function(e){return Number.secondsToString(e)},_lowerBound:function(e){return 0},_upperBound:function(e){return 0},__proto__:WebInspector.NetworkBaseCalculator.prototype},WebInspector.NetworkTransferTimeCalculator=function(){WebInspector.NetworkTimeCalculator.call(this,!1)},WebInspector.NetworkTransferTimeCalculator.prototype={formatTime:function(e){return Number.secondsToString(e)},_lowerBound:function(e){return e.startTime},_upperBound:function(e){return e.endTime},__proto__:WebInspector.NetworkTimeCalculator.prototype},WebInspector.NetworkTransferDurationCalculator=function(){WebInspector.NetworkTimeCalculator.call(this,!0)},WebInspector.NetworkTransferDurationCalculator.prototype={formatTime:function(e){return Number.secondsToString(e)},_upperBound:function(e){return e.duration},__proto__:WebInspector.NetworkTimeCalculator.prototype},WebInspector.NetworkDataGridNode=function(e,t){WebInspector.DataGridNode.call(this,{}),this._parentView=e,this._request=t,this._linkifier=new WebInspector.Linkifier},WebInspector.NetworkDataGridNode.prototype={createCells:function(){this._element.addStyleClass("offscreen"),this._nameCell=this._createDivInTD("name"),this._methodCell=this._createDivInTD("method"),this._statusCell=this._createDivInTD("status"),this._schemeCell=this._createDivInTD("scheme"),this._domainCell=this._createDivInTD("domain"),this._typeCell=this._createDivInTD("type"),this._initiatorCell=this._createDivInTD("initiator"),this._cookiesCell=this._createDivInTD("cookies"),this._setCookiesCell=this._createDivInTD("setCookies"),this._sizeCell=this._createDivInTD("size"),this._timeCell=this._createDivInTD("time"),this._responseHeaderCells={};var e=WebInspector.NetworkLogView._responseHeaderColumns;for(var t=0;t<e.length;++t)this._responseHeaderCells[e[t]]=this._createDivInTD(e[t]);this._timelineCell=this._createDivInTD("timeline"),this._createTimelineBar(this._timelineCell),this._nameCell.addEventListener("click",this._onClick.bind(this),!1),this._nameCell.addEventListener("dblclick",this._openInNewTab.bind(this),!1)},wasDetached:function(){this._linkifier.reset()},isFilteredOut:function(){return this._parentView._filteredOutRequests.get(this._request)?!0:!this._parentView._typeFilter(this._request)},_onClick:function(){this._parentView._allowRequestSelection||this.select()},select:function(){this._parentView.dispatchEventToListeners(WebInspector.NetworkLogView.EventTypes.RequestSelected,this._request),WebInspector.DataGridNode.prototype.select.apply(this,arguments),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.NetworkRequestSelected,url:this._request.url})},_highlightMatchedSubstring:function(e){var t=[],n=this._element.textContent.match(e);return n&&WebInspector.highlightSearchResult(this._nameCell,n.index,n[0].length,t),t},_openInNewTab:function(){InspectorFrontendHost.openInNewTab(this._request.url)},get selectable(){return this._parentView._allowRequestSelection&&!this.isFilteredOut()},_createDivInTD:function(e){var t=this.createTD(e),n=t.createChild("div");return this._element.appendChild(t),n},_createTimelineBar:function(e){e.className="network-graph-side",this._barAreaElement=document.createElement("div"),this._barAreaElement.className="network-graph-bar-area",this._barAreaElement.request=this._request,e.appendChild(this._barAreaElement),this._barLeftElement=document.createElement("div"),this._barLeftElement.className="network-graph-bar waiting",this._barAreaElement.appendChild(this._barLeftElement),this._barRightElement=document.createElement("div"),this._barRightElement.className="network-graph-bar",this._barAreaElement.appendChild(this._barRightElement),this._labelLeftElement=document.createElement("div"),this._labelLeftElement.className="network-graph-label waiting",this._barAreaElement.appendChild(this._labelLeftElement),this._labelRightElement=document.createElement("div"),this._labelRightElement.className="network-graph-label",this._barAreaElement.appendChild(this._labelRightElement),e.addEventListener("mouseover",this._refreshLabelPositions.bind(this),!1)},refreshRequest:function(){this._refreshNameCell(),this._refreshMethodCell(),this._refreshStatusCell(),this._refreshSchemeCell(),this._refreshDomainCell(),this._refreshTypeCell(),this._refreshInitiatorCell(),this._refreshCookiesCell(),this._refreshSetCookiesCell(),this._refreshSizeCell(),this._refreshTimeCell();var e=WebInspector.NetworkLogView._responseHeaderColumns;for(var t=0;t<e.length;++t)this._refreshResponseHeaderCell(e[t]);this._request.cached&&this._timelineCell.addStyleClass("resource-cached"),this._element.addStyleClass("network-item"),this._element.enableStyleClass("network-error-row",this._request.failed||this._request.statusCode>=400),this._updateElementStyleClasses(this._element)},_updateElementStyleClasses:function(e){var t="network-type-"+this._request.type.name();e.hasStyleClass(t)||(e.removeMatchingStyleClasses("network-type-\\w+"),e.addStyleClass(t))},_refreshResponseHeaderCell:function(e){var t=this._responseHeaderCells[e],n=this._request.responseHeaderValue(e);t.setTextAndTitle(n?n:"")},_refreshNameCell:function(){this._nameCell.removeChildren();if(this._request.type===WebInspector.resourceTypes.Image){var e=document.createElement("img");e.className="image-network-icon-preview",this._request.populateImageSource(e);var t=document.createElement("div");t.className="icon",t.appendChild(e)}else{var t=document.createElement("img");t.className="icon"}this._nameCell.appendChild(t),this._nameCell.appendChild(document.createTextNode(this._request.name())),this._appendSubtitle(this._nameCell,this._request.path()),this._nameCell.title=this._request.url},_refreshMethodCell:function(){this._methodCell.setTextAndTitle(this._request.requestMethod)},_refreshStatusCell:function(){this._statusCell.removeChildren();if(this._request.failed){var e=this._request.canceled?WebInspector.UIString("(canceled)"):WebInspector.UIString("(failed)");this._request.localizedFailDescription?(this._statusCell.appendChild(document.createTextNode(e)),this._appendSubtitle(this._statusCell,this._request.localizedFailDescription),this._statusCell.title=e+" "+this._request.localizedFailDescription):this._statusCell.setTextAndTitle(e),this._statusCell.addStyleClass("network-dim-cell");return}this._statusCell.removeStyleClass("network-dim-cell"),this._request.statusCode?(this._statusCell.appendChild(document.createTextNode(""+this._request.statusCode)),this._appendSubtitle(this._statusCell,this._request.statusText),this._statusCell.title=this._request.statusCode+" "+this._request.statusText,this._request.cached&&this._statusCell.addStyleClass("network-dim-cell")):(!this._request.isHttpFamily()&&this._request.finished?this._statusCell.setTextAndTitle(WebInspector.UIString("Success")):this._request.isPingRequest()?this._statusCell.setTextAndTitle(WebInspector.UIString("(ping)")):this._statusCell.setTextAndTitle(WebInspector.UIString("(pending)")),this._statusCell.addStyleClass("network-dim-cell"))},_refreshSchemeCell:function(){this._schemeCell.setTextAndTitle(this._request.scheme)},_refreshDomainCell:function(){this._typeCell.setTextAndTitle(this._request.domain)},_refreshTypeCell:function(){this._request.mimeType?(this._typeCell.removeStyleClass("network-dim-cell"),this._typeCell.setTextAndTitle(this._request.mimeType)):this._request.isPingRequest()?(this._typeCell.removeStyleClass("network-dim-cell"),this._typeCell.setTextAndTitle(this._request.requestContentType()||"")):(this._typeCell.addStyleClass("network-dim-cell"),this._typeCell.setTextAndTitle(WebInspector.UIString("Pending")))},_refreshInitiatorCell:function(){this._initiatorCell.removeChildren(),this._initiatorCell.removeStyleClass("network-dim-cell"),this._initiatorCell.removeStyleClass("network-script-initiated"),delete this._initiatorCell.request;var e=this._request,t=e.initiatorInfo();switch(t.type){case WebInspector.NetworkRequest.InitiatorType.Parser:this._initiatorCell.title=t.url+":"+t.lineNumber,this._initiatorCell.appendChild(WebInspector.linkifyResourceAsNode(t.url,t.lineNumber-1)),this._appendSubtitle(this._initiatorCell,WebInspector.UIString("Parser"));break;case WebInspector.NetworkRequest.InitiatorType.Redirect:this._initiatorCell.title=t.url,this._initiatorCell.appendChild(WebInspector.linkifyRequestAsNode(e.redirectSource)),this._appendSubtitle(this._initiatorCell,WebInspector.UIString("Redirect"));break;case WebInspector.NetworkRequest.InitiatorType.Script:var n=this._linkifier.linkifyLocation(t.url,t.lineNumber-1,t.columnNumber-1);n.title="",this._initiatorCell.appendChild(n),this._appendSubtitle(this._initiatorCell,WebInspector.UIString("Script")),this._initiatorCell.addStyleClass("network-script-initiated"),this._initiatorCell.request=e;break;default:this._initiatorCell.title="",this._initiatorCell.addStyleClass("network-dim-cell"),this._initiatorCell.setTextAndTitle(WebInspector.UIString("Other"))}},_refreshCookiesCell:function(){var e=this._request.requestCookies;this._cookiesCell.setTextAndTitle(e?""+e.length:"")},_refreshSetCookiesCell:function(){var e=this._request.responseCookies;this._setCookiesCell.setTextAndTitle(e?""+e.length:"")},_refreshSizeCell:function(){if(this._request.cached)this._sizeCell.setTextAndTitle(WebInspector.UIString("(from cache)")),this._sizeCell.addStyleClass("network-dim-cell");else{var e=Number.bytesToString(this._request.resourceSize),t=Number.bytesToString(this._request.transferSize);this._sizeCell.setTextAndTitle(t),this._sizeCell.removeStyleClass("network-dim-cell"),this._appendSubtitle(this._sizeCell,e)}},_refreshTimeCell:function(){this._request.duration>0?(this._timeCell.removeStyleClass("network-dim-cell"),this._timeCell.setTextAndTitle(Number.secondsToString(this._request.duration)),this._appendSubtitle(this._timeCell,Number.secondsToString(this._request.latency))):(this._timeCell.addStyleClass("network-dim-cell"),this._timeCell.setTextAndTitle(WebInspector.UIString("Pending")))},_appendSubtitle:function(e,t){var n=document.createElement("div");n.className="network-cell-subtitle",n.textContent=t,e.appendChild(n)},refreshGraph:function(e){var t=e.computeBarGraphPercentages(this._request);this._percentages=t,this._barAreaElement.removeStyleClass("hidden"),this._updateElementStyleClasses(this._timelineCell),this._barLeftElement.style.setProperty("left",t.start+"%"),this._barRightElement.style.setProperty("right",100-t.end+"%"),this._barLeftElement.style.setProperty("right",100-t.end+"%"),this._barRightElement.style.setProperty("left",t.middle+"%");var n=e.computeBarGraphLabels(this._request);this._labelLeftElement.textContent=n.left,this._labelRightElement.textContent=n.right;var r=n.tooltip||"";this._barLeftElement.title=r,this._labelLeftElement.title=r,this._labelRightElement.title=r,this._barRightElement.title=r},_refreshLabelPositions:function(){if(!this._percentages)return;this._labelLeftElement.style.removeProperty("left"),this._labelLeftElement.style.removeProperty("right"),this._labelLeftElement.removeStyleClass("before"),this._labelLeftElement.removeStyleClass("hidden"),this._labelRightElement.style.removeProperty("left"),this._labelRightElement.style.removeProperty("right"),this._labelRightElement.removeStyleClass("after"),this._labelRightElement.removeStyleClass("hidden");const e=10,t=this._barRightElement.offsetWidth,n=this._barLeftElement.offsetWidth;if(this._barLeftElement)var r=n-e,i=t-n-e;else var r=n-t-e,i=t-e;const s=this._labelLeftElement.offsetWidth,o=this._labelRightElement.offsetWidth,u=s>r,a=o>i,f=this._timelineCell.offsetWidth;if(u&&f*(this._percentages.start/100)<s+10)var l=!0;if(a&&f*((100-this._percentages.end)/100)<o+10)var c=!0;n==t&&(u&&!a?l=!0:a&&!u&&(c=!0)),u?(l&&this._labelLeftElement.addStyleClass("hidden"),this._labelLeftElement.style.setProperty("right",100-this._percentages.start+"%"),this._labelLeftElement.addStyleClass("before")):(this._labelLeftElement.style.setProperty("left",this._percentages.start+"%"),this._labelLeftElement.style.setProperty("right",100-this._percentages.middle+"%")),a?(c&&this._labelRightElement.addStyleClass("hidden"),this._labelRightElement.style.setProperty("left",this._percentages.end+"%"),this._labelRightElement.addStyleClass("after")):(this._labelRightElement.style.setProperty("left",this._percentages.middle+"%"),this._labelRightElement.style.setProperty("right",100-this._percentages.end+"%"))},__proto__:WebInspector.DataGridNode.prototype},WebInspector.NetworkLogView._trivialTypeFilter=function(e){return!0},WebInspector.NetworkLogView._typeFilter=function(e,t){return t.type.name()in e},WebInspector.NetworkDataGridNode.NameComparator=function(e,t){var n=e._request.name(),r=t._request.name();return n>r?1:r>n?-1:0},WebInspector.NetworkDataGridNode.SizeComparator=function(e,t){return t._request.cached&&!e._request.cached?1:e._request.cached&&!t._request.cached?-1:e._request.transferSize-t._request.transferSize},WebInspector.NetworkDataGridNode.InitiatorComparator=function(e,t){var n=e._request.initiatorInfo(),r=t._request.initiatorInfo();return n.type<r.type?-1:n.type>r.type?1:n.source<r.source?-1:n.source>r.source?1:n.lineNumber<r.lineNumber?-1:n.lineNumber>r.lineNumber?1:n.columnNumber<r.columnNumber?-1:n.columnNumber>r.columnNumber?1:0},WebInspector.NetworkDataGridNode.RequestCookiesCountComparator=function(e,t){var n=e._request.requestCookies?e._request.requestCookies.length:0,r=t._request.requestCookies?t._request.requestCookies.length:0;return n-r},WebInspector.NetworkDataGridNode.ResponseCookiesCountComparator=function(e,t){var n=e._request.responseCookies?e._request.responseCookies.length:0,r=t._request.responseCookies?t._request.responseCookies.length:0;return n-r},WebInspector.NetworkDataGridNode.RequestPropertyComparator=function(e,t,n,r){var i=n._request[e],s=r._request[e];return i>s?t?-1:1:s>i?t?1:-1:0};