/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.OutputStreamDelegate=function(){},WebInspector.OutputStreamDelegate.prototype={onTransferStarted:function(){},onTransferFinished:function(){},onChunkTransferred:function(e){},onError:function(e,t){}},WebInspector.OutputStream=function(){},WebInspector.OutputStream.prototype={write:function(e,t){},close:function(){}},WebInspector.ChunkedReader=function(){},WebInspector.ChunkedReader.prototype={fileSize:function(){},loadedSize:function(){},fileName:function(){},cancel:function(){}},WebInspector.ChunkedFileReader=function(e,t,n){this._file=e,this._fileSize=e.size,this._loadedSize=0,this._chunkSize=t,this._delegate=n,this._isCanceled=!1},WebInspector.ChunkedFileReader.prototype={start:function(e){this._output=e,this._reader=new FileReader,this._reader.onload=this._onChunkLoaded.bind(this),this._reader.onerror=this._delegate.onError.bind(this._delegate,this),this._delegate.onTransferStarted(),this._loadChunk()},cancel:function(){this._isCanceled=!0},loadedSize:function(){return this._loadedSize},fileSize:function(){return this._fileSize},fileName:function(){return this._file.name},_onChunkLoaded:function(e){if(this._isCanceled)return;if(e.target.readyState!==FileReader.DONE)return;var t=e.target.result;this._loadedSize+=t.length,this._output.write(t);if(this._isCanceled)return;this._delegate.onChunkTransferred(this);if(this._loadedSize===this._fileSize){this._file=null,this._reader=null,this._output.close(),this._delegate.onTransferFinished();return}this._loadChunk()},_loadChunk:function(){var e=this._loadedSize,t=Math.min(this._fileSize,e+this._chunkSize),n=this._file.slice(e,t);this._reader.readAsText(n)}},WebInspector.ChunkedXHRReader=function(e,t){this._url=e,this._delegate=t,this._fileSize=0,this._loadedSize=0,this._isCanceled=!1},WebInspector.ChunkedXHRReader.prototype={start:function(e){this._output=e,this._xhr=new XMLHttpRequest,this._xhr.open("GET",this._url,!0),this._xhr.onload=this._onLoad.bind(this),this._xhr.onprogress=this._onProgress.bind(this),this._xhr.onerror=this._delegate.onError.bind(this._delegate,this),this._xhr.send(null),this._delegate.onTransferStarted()},cancel:function(){this._isCanceled=!0,this._xhr.abort()},loadedSize:function(){return this._loadedSize},fileSize:function(){return this._fileSize},fileName:function(){return this._url},_onProgress:function(e){if(this._isCanceled)return;e.lengthComputable&&(this._fileSize=e.total);var t=this._xhr.responseText.substring(this._loadedSize);if(!t.length)return;this._loadedSize+=t.length,this._output.write(t);if(this._isCanceled)return;this._delegate.onChunkTransferred(this)},_onLoad:function(e){this._onProgress(e);if(this._isCanceled)return;this._output.close(),this._delegate.onTransferFinished()}},WebInspector.createFileSelectorElement=function(e){function n(n){e(t.files[0])}var t=document.createElement("input");return t.type="file",t.style.display="none",t.setAttribute("tabindex",-1),t.onchange=n,t},WebInspector.findBalancedCurlyBrackets=function(e,t,n){n=n||e.length,t=t||0;var r=0,i=!1;for(var s=t;s<n;++s){var o=e[s];if(i)o==="\\"?++s:o==='"'&&(i=!1);else if(o==='"')i=!0;else if(o==="{")++r;else if(o==="}"&&--r===0)return s+1}return-1},WebInspector.FileOutputStream=function(){},WebInspector.FileOutputStream.prototype={open:function(e,t){function n(){WebInspector.fileManager.removeEventListener(WebInspector.FileManager.EventTypes.SavedURL,n,this),WebInspector.fileManager.addEventListener(WebInspector.FileManager.EventTypes.AppendedToURL,this._onAppendDone,this),t(this)}this._closed=!1,this._writeCallbacks=[],this._fileName=e,WebInspector.fileManager.addEventListener(WebInspector.FileManager.EventTypes.SavedURL,n,this),WebInspector.fileManager.save(this._fileName,"",!0)},write:function(e,t){this._writeCallbacks.push(t),WebInspector.fileManager.append(this._fileName,e)},close:function(){this._closed=!0;if(this._writeCallbacks.length)return;WebInspector.fileManager.removeEventListener(WebInspector.FileManager.EventTypes.AppendedToURL,this._onAppendDone,this),WebInspector.fileManager.close(this._fileName)},_onAppendDone:function(e){if(e.data!==this._fileName)return;var t=this._writeCallbacks.shift();t&&t(this),this._writeCallbacks.length||this._closed&&(WebInspector.fileManager.removeEventListener(WebInspector.FileManager.EventTypes.AppendedToURL,this._onAppendDone,this),WebInspector.fileManager.close(this._fileName))}};