/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.FileSystemProjectDelegate=function(e,t){this._fileSystem=e,this._normalizedFileSystemPath=this._fileSystem.path(),WebInspector.isWin()&&(this._normalizedFileSystemPath=this._normalizedFileSystemPath.replace(/\\/g,"/")),this._fileSystemURL="file://"+this._normalizedFileSystemPath+"/",this._workspace=t,this._searchCallbacks={},this._indexingCallbacks={},this._indexingProgresses={}},WebInspector.FileSystemProjectDelegate._scriptExtensions=["js","java","coffee","ts","dart"].keySet(),WebInspector.FileSystemProjectDelegate._styleSheetExtensions=["css","scss","sass","less"].keySet(),WebInspector.FileSystemProjectDelegate._documentExtensions=["htm","html","asp","aspx","phtml","jsp"].keySet(),WebInspector.FileSystemProjectDelegate.projectId=function(e){return"filesystem:"+e},WebInspector.FileSystemProjectDelegate._lastRequestId=0,WebInspector.FileSystemProjectDelegate.prototype={id:function(){return WebInspector.FileSystemProjectDelegate.projectId(this._fileSystem.path())},type:function(){return WebInspector.projectTypes.FileSystem},fileSystemPath:function(){return this._fileSystem.path()},displayName:function(){return this._normalizedFileSystemPath.substr(this._normalizedFileSystemPath.lastIndexOf("/")+1)},_filePathForPath:function(e){return"/"+e},requestFileContent:function(e,t){function r(n){var r=this._extensionForPath(e),i=WebInspector.ResourceType.mimeTypesForExtensions[r];t(n,!1,i)}var n=this._filePathForPath(e);this._fileSystem.requestFileContent(n,r.bind(this))},requestMetadata:function(e,t){var n=this._filePathForPath(e);this._fileSystem.requestMetadata(n,t)},canSetFileContent:function(){return!0},setFileContent:function(e,t,n){var r=this._filePathForPath(e);this._fileSystem.setFileContent(r,t,n.bind(this,""))},canRename:function(){return!0},rename:function(e,t,n){var r=this._filePathForPath(e);this._fileSystem.renameFile(r,t,n)},searchInFileContent:function(e,t,n,r,i){function o(e){var s=[];e!==null&&(s=WebInspector.ContentProvider.performSearchInContent(e,t,n,r)),i(s)}var s=this._filePathForPath(e);this._fileSystem.requestFileContent(s,o.bind(this))},searchInContent:function(e,t,n,r,i){function o(s){function o(e){var t=e.substr(this._fileSystem.path().length+1);return WebInspector.isWin()&&(t=t.replace(/\\/g,"/")),t}function c(){for(;l<f;++l){if(a>=s.length)break;var e=s[a++],t=this._filePathForPath(e);this._fileSystem.requestFileContent(t,h.bind(this,e))}}function h(o,f){var h=[];f!==null&&(h=WebInspector.ContentProvider.performSearchInContent(f,e,t,n)),u.put(o,h),r.worked(1),--l;if(a<s.length)c.call(this);else{if(l)return;r.done(),i(u)}}s=s.map(o.bind(this));var u=new StringMap;r.setTotalWork(s.length);if(s.length===0){r.done(),i(u);return}var a=0,f=20,l=0;c.call(this)}var s=++WebInspector.FileSystemProjectDelegate._lastRequestId;this._searchCallbacks[s]=o.bind(this),InspectorFrontendHost.searchInPath(s,this._fileSystem.path(),n?"":e)},searchCompleted:function(e,t){if(!this._searchCallbacks[e])return;var n=this._searchCallbacks[e];delete this._searchCallbacks[e],n(t)},indexContent:function(e,t){var n=++WebInspector.FileSystemProjectDelegate._lastRequestId;this._indexingCallbacks[n]=t,this._indexingProgresses[n]=e,e.setTotalWork(1),e.addEventListener(WebInspector.Progress.Events.Canceled,this._indexingCanceled.bind(this,n)),InspectorFrontendHost.indexPath(n,this._fileSystem.path())},_indexingCanceled:function(e){if(!this._indexingProgresses[e])return;InspectorFrontendHost.stopIndexing(e),delete this._indexingProgresses[e],delete this._indexingCallbacks[e]},indexingTotalWorkCalculated:function(e,t){if(!this._indexingProgresses[e])return;var n=this._indexingProgresses[e];n.setTotalWork(t)},indexingWorked:function(e,t){if(!this._indexingProgresses[e])return;var n=this._indexingProgresses[e];n.worked(t)},indexingDone:function(e){if(!this._indexingProgresses[e])return;var t=this._indexingProgresses[e],n=this._indexingCallbacks[e];delete this._indexingProgresses[e],delete this._indexingCallbacks[e],t.done(),n.call()},_extensionForPath:function(e){var t=e.lastIndexOf(".");return t===-1?"":e.substring(t+1).toLowerCase()},_contentTypeForExtension:function(e){return WebInspector.FileSystemProjectDelegate._scriptExtensions[e]?WebInspector.resourceTypes.Script:WebInspector.FileSystemProjectDelegate._styleSheetExtensions[e]?WebInspector.resourceTypes.Stylesheet:WebInspector.FileSystemProjectDelegate._documentExtensions[e]?WebInspector.resourceTypes.Document:WebInspector.resourceTypes.Other},populate:function(){this._fileSystem.requestFilesRecursive("",this._addFile.bind(this))},refresh:function(e){this._fileSystem.requestFilesRecursive(e,this._addFile.bind(this))},excludeFolder:function(e){WebInspector.isolatedFileSystemManager.mapping().addExcludedFolder(this._fileSystem.path(),e)},createFile:function(e,t,n){function r(e){this._addFile(e),n(e)}this._fileSystem.createFile(e,t,r.bind(this))},deleteFile:function(e){this._fileSystem.deleteFile(e),this._removeFile(e)},remove:function(){WebInspector.isolatedFileSystemManager.removeFileSystem(this._fileSystem.path())},_addFile:function(e){e||console.assert(!1);var t=e.lastIndexOf("/"),n=e.substring(0,t),r=e.substring(t+1),i=this._workspace.urlForPath(this._fileSystem.path(),e),s=this._extensionForPath(r),o=this._contentTypeForExtension(s),u=new WebInspector.FileDescriptor(n,r,this._fileSystemURL+e,i,o,!0);this.dispatchEventToListeners(WebInspector.ProjectDelegate.Events.FileAdded,u)},_removeFile:function(e){this.dispatchEventToListeners(WebInspector.ProjectDelegate.Events.FileRemoved,e)},reset:function(){this.dispatchEventToListeners(WebInspector.ProjectDelegate.Events.Reset,null)},__proto__:WebInspector.Object.prototype},WebInspector.fileSystemProjectDelegate=null,WebInspector.FileSystemWorkspaceProvider=function(e,t){this._isolatedFileSystemManager=e,this._workspace=t,this._isolatedFileSystemManager.addEventListener(WebInspector.IsolatedFileSystemManager.Events.FileSystemAdded,this._fileSystemAdded,this),this._isolatedFileSystemManager.addEventListener(WebInspector.IsolatedFileSystemManager.Events.FileSystemRemoved,this._fileSystemRemoved,this),this._projectDelegates={}},WebInspector.FileSystemWorkspaceProvider.prototype={_fileSystemAdded:function(e){var t=e.data,n=WebInspector.FileSystemProjectDelegate.projectId(t.path()),r=new WebInspector.FileSystemProjectDelegate(t,this._workspace);this._projectDelegates[r.id()]=r,console.assert(!this._workspace.project(r.id())),this._workspace.addProject(r),r.populate()},_fileSystemRemoved:function(e){var t=e.data,n=WebInspector.FileSystemProjectDelegate.projectId(t.path());this._workspace.removeProject(n),delete this._projectDelegates[n]},fileSystemPath:function(e){var t=this._projectDelegates[e.project().id()];return t.fileSystemPath()},delegate:function(e){var t=WebInspector.FileSystemProjectDelegate.projectId(e);return this._projectDelegates[t]}},WebInspector.fileSystemWorkspaceProvider=null;