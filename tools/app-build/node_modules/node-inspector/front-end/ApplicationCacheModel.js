/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * 1. Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY GOOGLE INC. AND ITS CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL GOOGLE INC.
 * OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ApplicationCacheModel=function(){ApplicationCacheAgent.enable(),InspectorBackend.registerApplicationCacheDispatcher(new WebInspector.ApplicationCacheDispatcher(this)),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameNavigated,this._frameNavigated,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameDetached,this._frameDetached,this),this._statuses={},this._manifestURLsByFrame={},this._mainFrameNavigated(),this._onLine=!0},WebInspector.ApplicationCacheModel.EventTypes={FrameManifestStatusUpdated:"FrameManifestStatusUpdated",FrameManifestAdded:"FrameManifestAdded",FrameManifestRemoved:"FrameManifestRemoved",NetworkStateChanged:"NetworkStateChanged"},WebInspector.ApplicationCacheModel.prototype={_frameNavigated:function(e){var t=e.data;if(t.isMainFrame()){this._mainFrameNavigated();return}ApplicationCacheAgent.getManifestForFrame(t.id,this._manifestForFrameLoaded.bind(this,t.id))},_frameDetached:function(e){var t=e.data;this._frameManifestRemoved(t.id)},_mainFrameNavigated:function(){ApplicationCacheAgent.getFramesWithManifests(this._framesWithManifestsLoaded.bind(this))},_manifestForFrameLoaded:function(e,t,n){if(t){console.error(t);return}n||this._frameManifestRemoved(e)},_framesWithManifestsLoaded:function(e,t){if(e){console.error(e);return}for(var n=0;n<t.length;++n)this._frameManifestUpdated(t[n].frameId,t[n].manifestURL,t[n].status)},_frameManifestUpdated:function(e,t,n){if(n===applicationCache.UNCACHED){this._frameManifestRemoved(e);return}if(!t)return;this._manifestURLsByFrame[e]&&t!==this._manifestURLsByFrame[e]&&this._frameManifestRemoved(e);var r=this._statuses[e]!==n;this._statuses[e]=n,this._manifestURLsByFrame[e]||(this._manifestURLsByFrame[e]=t,this.dispatchEventToListeners(WebInspector.ApplicationCacheModel.EventTypes.FrameManifestAdded,e)),r&&this.dispatchEventToListeners(WebInspector.ApplicationCacheModel.EventTypes.FrameManifestStatusUpdated,e)},_frameManifestRemoved:function(e){if(!this._manifestURLsByFrame[e])return;var t=this._manifestURLsByFrame[e];delete this._manifestURLsByFrame[e],delete this._statuses[e],this.dispatchEventToListeners(WebInspector.ApplicationCacheModel.EventTypes.FrameManifestRemoved,e)},frameManifestURL:function(e){return this._manifestURLsByFrame[e]||""},frameManifestStatus:function(e){return this._statuses[e]||applicationCache.UNCACHED},get onLine(){return this._onLine},_statusUpdated:function(e,t,n){this._frameManifestUpdated(e,t,n)},requestApplicationCache:function(e,t){function n(e,n){if(e){console.error(e),t(null);return}t(n)}ApplicationCacheAgent.getApplicationCacheForFrame(e,n.bind(this))},_networkStateUpdated:function(e){this._onLine=e,this.dispatchEventToListeners(WebInspector.ApplicationCacheModel.EventTypes.NetworkStateChanged,e)},__proto__:WebInspector.Object.prototype},WebInspector.ApplicationCacheDispatcher=function(e){this._applicationCacheModel=e},WebInspector.ApplicationCacheDispatcher.prototype={applicationCacheStatusUpdated:function(e,t,n){this._applicationCacheModel._statusUpdated(e,t,n)},networkStateUpdated:function(e){this._applicationCacheModel._networkStateUpdated(e)}};