/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.HAREntry=function(e){this._request=e},WebInspector.HAREntry.prototype={build:function(){var e={startedDateTime:new Date(this._request.startTime*1e3),time:WebInspector.HAREntry._toMilliseconds(this._request.duration),request:this._buildRequest(),response:this._buildResponse(),cache:{},timings:this._buildTimings()};this._request.connectionId&&(e.connection=String(this._request.connectionId));var t=WebInspector.networkLog.pageLoadForRequest(this._request);return t&&(e.pageref="page_"+t.id),e},_buildRequest:function(){var e={method:this._request.requestMethod,url:this._buildRequestURL(this._request.url),httpVersion:this._request.requestHttpVersion,headers:this._request.requestHeaders,queryString:this._buildParameters(this._request.queryParameters||[]),cookies:this._buildCookies(this._request.requestCookies||[]),headersSize:this._request.requestHeadersSize,bodySize:this.requestBodySize};return this._request.requestFormData&&(e.postData=this._buildPostData()),e},_buildResponse:function(){return{status:this._request.statusCode,statusText:this._request.statusText,httpVersion:this._request.responseHttpVersion,headers:this._request.responseHeaders,cookies:this._buildCookies(this._request.responseCookies||[]),content:this._buildContent(),redirectURL:this._request.responseHeaderValue("Location")||"",headersSize:this._request.responseHeadersSize,bodySize:this.responseBodySize}},_buildContent:function(){var e={size:this._request.resourceSize,mimeType:this._request.mimeType},t=this.responseCompression;return typeof t=="number"&&(e.compression=t),e},_buildTimings:function(){var e=this._interval("connectStart","connectEnd"),t=0,n=-1;return this._request.connectionReused?t=e:n=e,{blocked:t,dns:this._interval("dnsStart","dnsEnd"),connect:n,send:this._interval("sendStart","sendEnd"),wait:this._interval("sendEnd","receiveHeadersEnd"),receive:WebInspector.HAREntry._toMilliseconds(this._request.receiveDuration),ssl:this._interval("sslStart","sslEnd")}},_buildPostData:function(){var e={mimeType:this._request.requestHeaderValue("Content-Type"),text:this._request.requestFormData};return this._request.formParameters&&(e.params=this._buildParameters(this._request.formParameters)),e},_buildParameters:function(e){return e.slice()},_buildRequestURL:function(e){return e.split("#",2)[0]},_buildCookies:function(e){return e.map(this._buildCookie.bind(this))},_buildCookie:function(e){return{name:e.name(),value:e.value(),path:e.path(),domain:e.domain(),expires:e.expiresDate(new Date(this._request.startTime*1e3)),httpOnly:e.httpOnly(),secure:e.secure()}},_interval:function(e,t){var n=this._request.timing;if(!n)return-1;var r=n[e];return typeof r!="number"||r===-1?-1:Math.round(n[t]-r)},get requestBodySize(){return this._request.requestFormData?this._request.requestFormData.length:0},get responseBodySize(){return this._request.cached||this._request.statusCode===304?0:this._request.transferSize-this._request.responseHeadersSize},get responseCompression(){if(this._request.cached||this._request.statusCode===304||this._request.statusCode===206)return;return this._request.resourceSize-this.responseBodySize}},WebInspector.HAREntry._toMilliseconds=function(e){return e===-1?-1:Math.round(e*1e3)},WebInspector.HARLog=function(e){this._requests=e},WebInspector.HARLog.prototype={build:function(){return{version:"1.2",creator:this._creator(),pages:this._buildPages(),entries:this._requests.map(this._convertResource.bind(this))}},_creator:function(){var e=/AppleWebKit\/([^ ]+)/.exec(window.navigator.userAgent);return{name:"WebInspector",version:e?e[1]:"n/a"}},_buildPages:function(){var e={},t=[];for(var n=0;n<this._requests.length;++n){var r=WebInspector.networkLog.pageLoadForRequest(this._requests[n]);if(!r||e[r.id])continue;e[r.id]=!0,t.push(this._convertPage(r))}return t},_convertPage:function(e){return{startedDateTime:new Date(e.startTime*1e3),id:"page_"+e.id,title:e.url,pageTimings:{onContentLoad:this._pageEventTime(e,e.contentLoadTime),onLoad:this._pageEventTime(e,e.loadTime)}}},_convertResource:function(e){return(new WebInspector.HAREntry(e)).build()},_pageEventTime:function(e,t){var n=e.startTime;return t===-1||n===-1?-1:WebInspector.HAREntry._toMilliseconds(t-n)}},WebInspector.HARWriter=function(){},WebInspector.HARWriter.prototype={write:function(e,t,n){this._stream=e,this._harLog=(new WebInspector.HARLog(t)).build(),this._pendingRequests=1;var r=this._harLog.entries;for(var i=0;i<r.length;++i){var s=t[i].content;typeof s=="undefined"&&t[i].finished?(++this._pendingRequests,t[i].requestContent(this._onContentAvailable.bind(this,r[i]))):s!==null&&(r[i].response.content.text=s)}var o=new WebInspector.CompositeProgress(n);this._writeProgress=o.createSubProgress(),--this._pendingRequests?(this._requestsProgress=o.createSubProgress(),this._requestsProgress.setTitle(WebInspector.UIString("Collecting content…")),this._requestsProgress.setTotalWork(this._pendingRequests)):this._beginWrite()},_onContentAvailable:function(e,t,n,r){t!==null&&(e.response.content.text=t),this._requestsProgress&&this._requestsProgress.worked(),--this._pendingRequests||(this._requestsProgress.done(),this._beginWrite())},_beginWrite:function(){const e=2;this._text=JSON.stringify({log:this._harLog},null,e),this._writeProgress.setTitle(WebInspector.UIString("Writing file…")),this._writeProgress.setTotalWork(this._text.length),this._bytesWritten=0,this._writeNextChunk(this._stream)},_writeNextChunk:function(e,t){if(this._bytesWritten>=this._text.length||t){e.close(),this._writeProgress.done();return}const n=1e5;var r=this._text.substring(this._bytesWritten,this._bytesWritten+n);this._bytesWritten+=r.length,e.write(r,this._writeNextChunk.bind(this)),this._writeProgress.setWorked(this._bytesWritten)}};