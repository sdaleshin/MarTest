/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.LayerTree=function(e,t){WebInspector.Object.call(this),this._model=e,this._treeOutline=t,this._treeOutline.childrenListElement.addEventListener("mousemove",this._onMouseMove.bind(this),!1),this._treeOutline.childrenListElement.addEventListener("mouseout",this._onMouseMove.bind(this),!1),this._treeOutline.childrenListElement.addEventListener("contextmenu",this._onContextMenu.bind(this),!0),this._model.addEventListener(WebInspector.LayerTreeModel.Events.LayerTreeChanged,this._update.bind(this)),this._lastHoveredNode=null,this._needsUpdate=!0},WebInspector.LayerTree.Events={LayerHovered:"LayerHovered",LayerSelected:"LayerSelected"},WebInspector.LayerTree.prototype={setVisible:function(e){if(this._isVisible===e)return;this._isVisible=e,e&&this._needsUpdate&&this._update()},selectLayer:function(e){this.hoverLayer(null);var t=e&&this._treeOutline.getCachedTreeElement(e);t?t.revealAndSelect(!0):this._treeOutline.selectedTreeElement&&this._treeOutline.selectedTreeElement.deselect()},hoverLayer:function(e){var t=e&&this._treeOutline.getCachedTreeElement(e);if(t===this._lastHoveredNode)return;this._lastHoveredNode&&this._lastHoveredNode.setHovered(!1),t&&t.setHovered(!0),this._lastHoveredNode=t},_update:function(){function t(t){var n=t.id();e[n]&&console.assert(!1,"Duplicate layer id: "+n),e[n]=!0;var r=this._treeOutline.getCachedTreeElement(t),i=t===this._model.contentRoot()?this._treeOutline:this._treeOutline.getCachedTreeElement(t.parent());i||console.assert(!1,"Parent is not in the tree");if(!r)r=new WebInspector.LayerTreeElement(this,t),i.appendChild(r);else{var s=r.parent.representedObject&&r.parent.representedObject.id();s!==t.parentId()&&((r.parent||this._treeOutline).removeChild(r),i.appendChild(r)),r._update()}}if(!this._isVisible){this._needsUpdate=!0;return}this._needsUpdate=!1;var e={};this._model.forEachLayer(t.bind(this),this._model.contentRoot());for(var n=0;n<this._treeOutline.children.length;++n)for(var r=this._treeOutline.children[n];r;)if(e[r.representedObject.id()])r=r.traverseNextTreeElement(!1);else{var i=r.nextSibling||r.parent;r.parent.removeChild(r),r===this._lastHoveredNode&&(this._lastHoveredNode=null),r=i}},_onMouseMove:function(e){var t=this._treeOutline.treeElementFromPoint(e.pageX,e.pageY);if(t===this._lastHoveredNode)return;this.dispatchEventToListeners(WebInspector.LayerTree.Events.LayerHovered,t&&t.representedObject)},_selectedNodeChanged:function(e){var t=e.representedObject;this.dispatchEventToListeners(WebInspector.LayerTree.Events.LayerSelected,t)},_onContextMenu:function(e){var t=this._treeOutline.treeElementFromPoint(e.pageX,e.pageY);if(!t||!t.representedObject)return;var n=t.representedObject;if(!n)return;var r=n.nodeId();if(!r)return;var i=WebInspector.domAgent.nodeForId(r);if(!i)return;var s=new WebInspector.ContextMenu(e);s.appendApplicableItems(i),s.show()},__proto__:WebInspector.Object.prototype},WebInspector.LayerTreeElement=function(e,t){TreeElement.call(this,"",t),this._layerTree=e,this._update()},WebInspector.LayerTreeElement.prototype={onattach:function(){var e=document.createElement("div");e.className="selection",this.listItemElement.insertBefore(e,this.listItemElement.firstChild)},_update:function(){var e=this.representedObject,t=e.nodeIdForSelfOrAncestor(),n=t&&WebInspector.domAgent.nodeForId(t),r=document.createDocumentFragment();r.createChild("div","selection"),r.appendChild(document.createTextNode(n?n.appropriateSelectorFor(!1):"#"+e.id()));var i=r.createChild("span","dimmed");i.textContent=WebInspector.UIString(" (%d Ã— %d)",e.width(),e.height()),this.title=r},onselect:function(){this._layerTree._selectedNodeChanged(this)},setHovered:function(e){this.listItemElement.enableStyleClass("hovered",e)},__proto__:TreeElement.prototype};