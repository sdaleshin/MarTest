/*
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CookieParser=function(){},WebInspector.CookieParser.KeyValue=function(e,t,n){this.key=e,this.value=t,this.position=n},WebInspector.CookieParser.prototype={cookies:function(){return this._cookies},parseCookie:function(e){if(!this._initialize(e))return null;for(var t=this._extractKeyValue();t;t=this._extractKeyValue())t.key.charAt(0)==="$"&&this._lastCookie?this._lastCookie.addAttribute(t.key.slice(1),t.value):t.key.toLowerCase()!=="$version"&&typeof t.value=="string"&&this._addCookie(t,WebInspector.Cookie.Type.Request),this._advanceAndCheckCookieDelimiter();return this._flushCookie(),this._cookies},parseSetCookie:function(e){if(!this._initialize(e))return null;for(var t=this._extractKeyValue();t;t=this._extractKeyValue())this._lastCookie?this._lastCookie.addAttribute(t.key,t.value):this._addCookie(t,WebInspector.Cookie.Type.Response),this._advanceAndCheckCookieDelimiter()&&this._flushCookie();return this._flushCookie(),this._cookies},_initialize:function(e){return this._input=e,typeof e!="string"?!1:(this._cookies=[],this._lastCookie=null,this._originalInputLength=this._input.length,!0)},_flushCookie:function(){this._lastCookie&&this._lastCookie.setSize(this._originalInputLength-this._input.length-this._lastCookiePosition),this._lastCookie=null},_extractKeyValue:function(){if(!this._input||!this._input.length)return null;var e=/^[ \t]*([^\s=;]+)[ \t]*(?:=[ \t]*([^;\n]*))?/.exec(this._input);if(!e)return console.log("Failed parsing cookie header before: "+this._input),null;var t=new WebInspector.CookieParser.KeyValue(e[1],e[2]&&e[2].trim(),this._originalInputLength-this._input.length);return this._input=this._input.slice(e[0].length),t},_advanceAndCheckCookieDelimiter:function(){var e=/^\s*[\n;]\s*/.exec(this._input);return e?(this._input=this._input.slice(e[0].length),e[0].match("\n")!==null):!1},_addCookie:function(e,t){this._lastCookie&&this._lastCookie.setSize(e.position-this._lastCookiePosition),this._lastCookie=typeof e.value=="string"?new WebInspector.Cookie(e.key,e.value,t):new WebInspector.Cookie("",e.key,t),this._lastCookiePosition=e.position,this._cookies.push(this._lastCookie)}},WebInspector.CookieParser.parseCookie=function(e){return(new WebInspector.CookieParser).parseCookie(e)},WebInspector.CookieParser.parseSetCookie=function(e){return(new WebInspector.CookieParser).parseSetCookie(e)},WebInspector.Cookie=function(e,t,n){this._name=e,this._value=t,this._type=n,this._attributes={}},WebInspector.Cookie.prototype={name:function(){return this._name},value:function(){return this._value},type:function(){return this._type},httpOnly:function(){return"httponly"in this._attributes},secure:function(){return"secure"in this._attributes},session:function(){return!("expires"in this._attributes||"max-age"in this._attributes)},path:function(){return this._attributes.path},port:function(){return this._attributes.port},domain:function(){return this._attributes.domain},expires:function(){return this._attributes.expires},maxAge:function(){return this._attributes["max-age"]},size:function(){return this._size},setSize:function(e){this._size=e},expiresDate:function(e){if(this.maxAge()){var t=e===null?new Date:e;return new Date(t.getTime()+1e3*this.maxAge())}return this.expires()?new Date(this.expires()):null},attributes:function(){return this._attributes},addAttribute:function(e,t){this._attributes[e.toLowerCase()]=t},remove:function(e){PageAgent.deleteCookie(this.name(),(this.secure()?"https://":"http://")+this.domain()+this.path(),e)}},WebInspector.Cookie.Type={Request:0,Response:1},WebInspector.Cookies={},WebInspector.Cookies.getCookiesAsync=function(e){function t(t,n,r){if(t)return;e(n.map(WebInspector.Cookies.buildCookieProtocolObject))}PageAgent.getCookies(t)},WebInspector.Cookies.buildCookieProtocolObject=function(e){var t=new WebInspector.Cookie(e.name,e.value,null);return t.addAttribute("domain",e.domain),t.addAttribute("path",e.path),t.addAttribute("port",e.port),e.expires&&t.addAttribute("expires",e.expires),e.httpOnly&&t.addAttribute("httpOnly"),e.secure&&t.addAttribute("secure"),t.setSize(e.size),t},WebInspector.Cookies.cookieMatchesResourceURL=function(e,t){var n=t.asParsedURL();return!n||!WebInspector.Cookies.cookieDomainMatchesResourceDomain(e.domain(),n.host)?!1:n.path.startsWith(e.path())&&(!e.port()||n.port==e.port())&&(!e.secure()||n.scheme==="https")},WebInspector.Cookies.cookieDomainMatchesResourceDomain=function(e,t){return e.charAt(0)!=="."?t===e:!!t.match(new RegExp("^([^\\.]+\\.)*"+e.substring(1).escapeForRegExp()+"$","i"))};