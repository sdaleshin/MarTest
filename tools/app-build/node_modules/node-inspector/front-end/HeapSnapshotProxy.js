/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyrightdd
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.HeapSnapshotWorkerWrapper=function(){},WebInspector.HeapSnapshotWorkerWrapper.prototype={postMessage:function(e){},terminate:function(){},__proto__:WebInspector.Object.prototype},WebInspector.HeapSnapshotRealWorker=function(){this._worker=new Worker("HeapSnapshotWorker.js"),this._worker.addEventListener("message",this._messageReceived.bind(this),!1)},WebInspector.HeapSnapshotRealWorker.prototype={_messageReceived:function(e){var t=e.data;this.dispatchEventToListeners("message",t)},postMessage:function(e){this._worker.postMessage(e)},terminate:function(){this._worker.terminate()},__proto__:WebInspector.HeapSnapshotWorkerWrapper.prototype},WebInspector.AsyncTaskQueue=function(){this._queue=[],this._isTimerSheduled=!1},WebInspector.AsyncTaskQueue.prototype={addTask:function(e){this._queue.push(e),this._scheduleTimer()},_onTimeout:function(){this._isTimerSheduled=!1;var e=this._queue;this._queue=[];for(var t=0;t<e.length;t++)try{e[t]()}catch(n){console.error("Exception while running task: "+n.stack)}this._scheduleTimer()},_scheduleTimer:function(){this._queue.length&&!this._isTimerSheduled&&(setTimeout(this._onTimeout.bind(this),0),this._isTimerSheduled=!0)}},WebInspector.HeapSnapshotFakeWorker=function(){this._dispatcher=new WebInspector.HeapSnapshotWorkerDispatcher(window,this._postMessageFromWorker.bind(this)),this._asyncTaskQueue=new WebInspector.AsyncTaskQueue},WebInspector.HeapSnapshotFakeWorker.prototype={postMessage:function(e){function t(){this._dispatcher&&this._dispatcher.dispatchMessage({data:e})}this._asyncTaskQueue.addTask(t.bind(this))},terminate:function(){this._dispatcher=null},_postMessageFromWorker:function(e){function t(){this.dispatchEventToListeners("message",e)}this._asyncTaskQueue.addTask(t.bind(this))},__proto__:WebInspector.HeapSnapshotWorkerWrapper.prototype},WebInspector.HeapSnapshotWorkerProxy=function(e){this._eventHandler=e,this._nextObjectId=1,this._nextCallId=1,this._callbacks=[],this._previousCallbacks=[],this._worker=typeof InspectorTest=="undefined"?new WebInspector.HeapSnapshotRealWorker:new WebInspector.HeapSnapshotFakeWorker,this._worker.addEventListener("message",this._messageReceived,this)},WebInspector.HeapSnapshotWorkerProxy.prototype={createLoader:function(e,t){var n=this._nextObjectId++,r=new WebInspector.HeapSnapshotLoaderProxy(this,n,e,t);return this._postMessage({callId:this._nextCallId++,disposition:"create",objectId:n,methodName:"WebInspector.HeapSnapshotLoader"}),r},dispose:function(){this._worker.terminate(),this._interval&&clearInterval(this._interval)},disposeObject:function(e){this._postMessage({callId:this._nextCallId++,disposition:"dispose",objectId:e})},callGetter:function(e,t,n){var r=this._nextCallId++;this._callbacks[r]=e,this._postMessage({callId:r,disposition:"getter",objectId:t,methodName:n})},callFactoryMethod:function(e,t,n,r){var i=this._nextCallId++,s=Array.prototype.slice.call(arguments,4),o=this._nextObjectId++;if(e){function u(t){e(t?new r(this,o):null)}return this._callbacks[i]=u.bind(this),this._postMessage({callId:i,disposition:"factory",objectId:t,methodName:n,methodArguments:s,newObjectId:o}),null}return this._postMessage({callId:i,disposition:"factory",objectId:t,methodName:n,methodArguments:s,newObjectId:o}),new r(this,o)},callMethod:function(e,t,n){var r=this._nextCallId++,i=Array.prototype.slice.call(arguments,3);e&&(this._callbacks[r]=e),this._postMessage({callId:r,disposition:"method",objectId:t,methodName:n,methodArguments:i})},startCheckingForLongRunningCalls:function(){if(this._interval)return;this._checkLongRunningCalls(),this._interval=setInterval(this._checkLongRunningCalls.bind(this),300)},_checkLongRunningCalls:function(){for(var e in this._previousCallbacks)e in this._callbacks||delete this._previousCallbacks[e];var t=!1;for(e in this._previousCallbacks){t=!0;break}this.dispatchEventToListeners("wait",t);for(e in this._callbacks)this._previousCallbacks[e]=!0},_findFunction:function(e){var t=e.split("."),n=window;for(var r=0;r<t.length;++r)n=n[t[r]];return n},_messageReceived:function(e){var t=e.data;if(t.eventName){this._eventHandler&&this._eventHandler(t.eventName,t.data);return}if(t.error){t.errorMethodName&&WebInspector.log(WebInspector.UIString("An error happened when a call for method '%s' was requested",t.errorMethodName)),WebInspector.log(t.errorCallStack),delete this._callbacks[t.callId];return}if(!this._callbacks[t.callId])return;var n=this._callbacks[t.callId];delete this._callbacks[t.callId],n(t.result)},_postMessage:function(e){this._worker.postMessage(e)},__proto__:WebInspector.Object.prototype},WebInspector.HeapSnapshotProxyObject=function(e,t){this._worker=e,this._objectId=t},WebInspector.HeapSnapshotProxyObject.prototype={_callWorker:function(e,t){return t.splice(1,0,this._objectId),this._worker[e].apply(this._worker,t)},dispose:function(){this._worker.disposeObject(this._objectId)},disposeWorker:function(){this._worker.dispose()},callFactoryMethod:function(e,t,n,r){return this._callWorker("callFactoryMethod",Array.prototype.slice.call(arguments,0))},callGetter:function(e,t){return this._callWorker("callGetter",Array.prototype.slice.call(arguments,0))},callMethod:function(e,t,n){return this._callWorker("callMethod",Array.prototype.slice.call(arguments,0))},get worker(){return this._worker}},WebInspector.HeapSnapshotLoaderProxy=function(e,t,n,r){WebInspector.HeapSnapshotProxyObject.call(this,e,t),this._snapshotConstructorName=n,this._proxyConstructor=r,this._pendingSnapshotConsumers=[]},WebInspector.HeapSnapshotLoaderProxy.prototype={addConsumer:function(e){this._pendingSnapshotConsumers.push(e)},write:function(e,t){this.callMethod(t,"write",e)},close:function(e){function t(){e&&e(),this.callFactoryMethod(n.bind(this),"buildSnapshot",this._proxyConstructor,this._snapshotConstructorName)}function n(e){this.dispose(),e.updateStaticData(r.bind(this))}function r(e){for(var t=0;t<this._pendingSnapshotConsumers.length;++t)this._pendingSnapshotConsumers[t](e);this._pendingSnapshotConsumers=[]}this.callMethod(t.bind(this),"close")},__proto__:WebInspector.HeapSnapshotProxyObject.prototype},WebInspector.HeapSnapshotProxy=function(e,t){WebInspector.HeapSnapshotProxyObject.call(this,e,t)},WebInspector.HeapSnapshotProxy.prototype={aggregates:function(e,t,n,r){this.callMethod(r,"aggregates",e,t,n)},aggregatesForDiff:function(e){this.callMethod(e,"aggregatesForDiff")},calculateSnapshotDiff:function(e,t,n){this.callMethod(n,"calculateSnapshotDiff",e,t)},nodeClassName:function(e,t){this.callMethod(t,"nodeClassName",e)},dominatorIdsForNode:function(e,t){this.callMethod(t,"dominatorIdsForNode",e)},createEdgesProvider:function(e,t){return this.callFactoryMethod(null,"createEdgesProvider",WebInspector.HeapSnapshotProviderProxy,e,t)},createRetainingEdgesProvider:function(e,t){return this.callFactoryMethod(null,"createRetainingEdgesProvider",WebInspector.HeapSnapshotProviderProxy,e,t)},createAddedNodesProvider:function(e,t){return this.callFactoryMethod(null,"createAddedNodesProvider",WebInspector.HeapSnapshotProviderProxy,e,t)},createDeletedNodesProvider:function(e){return this.callFactoryMethod(null,"createDeletedNodesProvider",WebInspector.HeapSnapshotProviderProxy,e)},createNodesProvider:function(e){return this.callFactoryMethod(null,"createNodesProvider",WebInspector.HeapSnapshotProviderProxy,e)},createNodesProviderForClass:function(e,t){return this.callFactoryMethod(null,"createNodesProviderForClass",WebInspector.HeapSnapshotProviderProxy,e,t)},createNodesProviderForDominator:function(e){return this.callFactoryMethod(null,"createNodesProviderForDominator",WebInspector.HeapSnapshotProviderProxy,e)},dispose:function(){this.disposeWorker()},get nodeCount(){return this._staticData.nodeCount},get rootNodeIndex(){return this._staticData.rootNodeIndex},updateStaticData:function(e){function t(t){this._staticData=t,e(this)}this.callMethod(t.bind(this),"updateStaticData")},get totalSize(){return this._staticData.totalSize},get uid(){return this._staticData.uid},__proto__:WebInspector.HeapSnapshotProxyObject.prototype},WebInspector.HeapSnapshotProviderProxy=function(e,t){WebInspector.HeapSnapshotProxyObject.call(this,e,t)},WebInspector.HeapSnapshotProviderProxy.prototype={nodePosition:function(e,t){this.callMethod(t,"nodePosition",e)},isEmpty:function(e){this.callMethod(e,"isEmpty")},serializeItemsRange:function(e,t,n){this.callMethod(n,"serializeItemsRange",e,t)},sortAndRewind:function(e,t){this.callMethod(t,"sortAndRewind",e)},__proto__:WebInspector.HeapSnapshotProxyObject.prototype};