/*
 * Copyright (C) 2007 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.EventListenersSidebarPane=function(){WebInspector.SidebarPane.call(this,WebInspector.UIString("Event Listeners")),this.bodyElement.addStyleClass("events-pane"),this.sections=[],this.settingsSelectElement=document.createElement("select"),this.settingsSelectElement.className="select-filter";var e=document.createElement("option");e.value="all",e.label=WebInspector.UIString("All Nodes"),this.settingsSelectElement.appendChild(e),e=document.createElement("option"),e.value="selected",e.label=WebInspector.UIString("Selected Node Only"),this.settingsSelectElement.appendChild(e);var t=WebInspector.settings.eventListenersFilter.get();t==="all"?this.settingsSelectElement[0].selected=!0:t==="selected"&&(this.settingsSelectElement[1].selected=!0),this.settingsSelectElement.addEventListener("click",function(e){e.consume()},!1),this.settingsSelectElement.addEventListener("change",this._changeSetting.bind(this),!1),this.titleElement.appendChild(this.settingsSelectElement),this._linkifier=new WebInspector.Linkifier},WebInspector.EventListenersSidebarPane._objectGroupName="event-listeners-sidebar-pane",WebInspector.EventListenersSidebarPane.prototype={update:function(e){function r(r,i){if(r)return;var s="selected"===WebInspector.settings.eventListenersFilter.get(),o=[],u={};for(var a=0;a<i.length;++a){var f=i[a];if(s&&e.id!==f.nodeId)continue;f.node=WebInspector.domAgent.nodeForId(f.nodeId),delete f.nodeId;if(/^function _inspectorCommandLineAPI_logEvent\(/.test(f.handlerBody.toString()))continue;var l=f.type,c=u[l];c||(c=new WebInspector.EventListenersSection(l,e.id,n._linkifier),u[l]=c,o.push(l),n.sections.push(c)),c.addListener(f)}if(o.length===0){var h=document.createElement("div");h.className="info",h.textContent=WebInspector.UIString("No Event Listeners"),t.appendChild(h);return}o.sort();for(var a=0;a<o.length;++a){var c=u[o[a]];t.appendChild(c.element)}}RuntimeAgent.releaseObjectGroup(WebInspector.EventListenersSidebarPane._objectGroupName),this._linkifier.reset();var t=this.bodyElement;t.removeChildren(),this.sections=[];var n=this;e&&e.eventListeners(WebInspector.EventListenersSidebarPane._objectGroupName,r),this._selectedNode=e},willHide:function(){delete this._selectedNode},_changeSetting:function(){var e=this.settingsSelectElement[this.settingsSelectElement.selectedIndex];WebInspector.settings.eventListenersFilter.set(e.value),this.update(this._selectedNode)},__proto__:WebInspector.SidebarPane.prototype},WebInspector.EventListenersSection=function(e,t,n){this.eventListeners=[],this._nodeId=t,this._linkifier=n,WebInspector.PropertiesSection.call(this,e),this.propertiesElement.remove(),delete this.propertiesElement,delete this.propertiesTreeOutline,this._eventBars=document.createElement("div"),this._eventBars.className="event-bars",this.element.appendChild(this._eventBars)},WebInspector.EventListenersSection.prototype={addListener:function(e){var t=new WebInspector.EventListenerBar(e,this._nodeId,this._linkifier);this._eventBars.appendChild(t.element)},__proto__:WebInspector.PropertiesSection.prototype},WebInspector.EventListenerBar=function(e,t,n){WebInspector.ObjectPropertiesSection.call(this,WebInspector.RemoteObject.fromPrimitiveValue("")),this.eventListener=e,this._nodeId=t,this._setNodeTitle(),this._setFunctionSubtitle(n),this.editable=!1,this.element.className="event-bar",this.headerElement.addStyleClass("source-code"),this.propertiesElement.className="event-properties properties-tree source-code"},WebInspector.EventListenerBar.prototype={update:function(){function e(e){var t=[];this.eventListener.type&&t.push(WebInspector.RemoteObjectProperty.fromPrimitiveValue("type",this.eventListener.type)),typeof this.eventListener.useCapture!="undefined"&&t.push(WebInspector.RemoteObjectProperty.fromPrimitiveValue("useCapture",this.eventListener.useCapture)),typeof this.eventListener.isAttribute!="undefined"&&t.push(WebInspector.RemoteObjectProperty.fromPrimitiveValue("isAttribute",this.eventListener.isAttribute)),e&&t.push(new WebInspector.RemoteObjectProperty("node",e));if(typeof this.eventListener.handler!="undefined"){var n=WebInspector.RemoteObject.fromPayload(this.eventListener.handler);t.push(new WebInspector.RemoteObjectProperty("handler",n))}typeof this.eventListener.handlerBody!="undefined"&&t.push(WebInspector.RemoteObjectProperty.fromPrimitiveValue("listenerBody",this.eventListener.handlerBody)),this.eventListener.sourceName&&t.push(WebInspector.RemoteObjectProperty.fromPrimitiveValue("sourceName",this.eventListener.sourceName)),this.eventListener.location&&t.push(WebInspector.RemoteObjectProperty.fromPrimitiveValue("lineNumber",this.eventListener.location.lineNumber+1)),this.updateProperties(t)}WebInspector.RemoteObject.resolveNode(this.eventListener.node,WebInspector.EventListenersSidebarPane._objectGroupName,e.bind(this))},_setNodeTitle:function(){var e=this.eventListener.node;if(!e)return;if(e.nodeType()===Node.DOCUMENT_NODE){this.titleElement.textContent="document";return}if(e.id===this._nodeId){this.titleElement.textContent=e.appropriateSelectorFor();return}this.titleElement.removeChildren(),this.titleElement.appendChild(WebInspector.DOMPresentationUtils.linkifyNodeReference(this.eventListener.node))},_setFunctionSubtitle:function(e){if(this.eventListener.location){this.subtitleElement.removeChildren();var t;this.eventListener.location.scriptId&&(t=e.linkifyRawLocation(this.eventListener.location));if(!t){var n=this.eventListener.sourceName,r=this.eventListener.location.lineNumber,i=0;t=e.linkifyLocation(n,r,i)}this.subtitleElement.appendChild(t)}else{var s=this.eventListener.handlerBody.match(/function ([^\(]+?)\(/);s?this.subtitleElement.textContent=s[1]:this.subtitleElement.textContent=WebInspector.UIString("(anonymous function)")}},__proto__:WebInspector.ObjectPropertiesSection.prototype};