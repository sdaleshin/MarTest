/*
 * Copyright (C) 2011 Google Inc.  All rights reserved.
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ConsoleMessageImpl=function(e,t,n,r,i,s,o,u,a,f,l,c,h){WebInspector.ConsoleMessage.call(this,e,t,s,o,u,a),this._linkifier=r,this.type=i||WebInspector.ConsoleMessage.MessageType.Log,this._messageText=n,this._parameters=f,this._stackTrace=l,this._request=c?WebInspector.networkLog.requestForId(c):null,this._isOutdated=h,this._dataGrids=[],this._dataGridParents=new Map,this._customFormatters={object:this._formatParameterAsObject,array:this._formatParameterAsArray,node:this._formatParameterAsNode,string:this._formatParameterAsString}},WebInspector.ConsoleMessageImpl.prototype={request:function(){return this._request},wasShown:function(){for(var e=0;this._dataGrids&&e<this._dataGrids.length;++e){var t=this._dataGrids[e],n=this._dataGridParents.get(t)||null;t.show(n)}},willHide:function(){for(var e=0;this._dataGrids&&e<this._dataGrids.length;++e){var t=this._dataGrids[e];this._dataGridParents.put(t,t.element.parentElement),t.detach()}},_formatMessage:function(){this._formattedMessage=document.createElement("span"),this._formattedMessage.className="console-message-text source-code";if(this.source===WebInspector.ConsoleMessage.MessageSource.ConsoleAPI)switch(this.type){case WebInspector.ConsoleMessage.MessageType.Trace:this._messageElement=this._format(this._parameters||["console.trace()"]);break;case WebInspector.ConsoleMessage.MessageType.Clear:this._messageElement=document.createTextNode(WebInspector.UIString("Console was cleared")),this._formattedMessage.addStyleClass("console-info");break;case WebInspector.ConsoleMessage.MessageType.Assert:var e=[WebInspector.UIString("Assertion failed:")];this._parameters&&(e=e.concat(this._parameters)),this._messageElement=this._format(e);break;case WebInspector.ConsoleMessage.MessageType.Dir:var t=this._parameters?this._parameters[0]:undefined,e=["%O",t];this._messageElement=this._format(e);break;case WebInspector.ConsoleMessage.MessageType.Profile:var n=WebInspector.ProfilesPanelDescriptor.resolveProfileTitle(this._messageText);this._messageElement=document.createTextNode(WebInspector.UIString("Profile '%s' started.",n));break;case WebInspector.ConsoleMessage.MessageType.ProfileEnd:var r=this._messageText.lastIndexOf("#"),n=WebInspector.ProfilesPanelDescriptor.resolveProfileTitle(this._messageText.substring(0,r)),i=this._messageText.substring(r+1),s=WebInspector.UIString("Profile '%s' finished.","%_"),o=WebInspector.linkifyURLAsNode("webkit-profile://CPU/"+i,n);this._messageElement=document.createElement("span"),this._formatWithSubstitutionString(s,[o],this._messageElement);break;default:var e=this._parameters||[this._messageText];this._messageElement=this._format(e)}else if(this.source===WebInspector.ConsoleMessage.MessageSource.Network)if(this._request){this._stackTrace=this._request.initiator.stackTrace,this._request.initiator&&this._request.initiator.url&&(this.url=this._request.initiator.url,this.line=this._request.initiator.lineNumber),this._messageElement=document.createElement("span");if(this.level===WebInspector.ConsoleMessage.MessageLevel.Error)this._messageElement.appendChild(document.createTextNode(this._request.requestMethod+" ")),this._messageElement.appendChild(WebInspector.linkifyRequestAsNode(this._request)),this._request.failed?this._messageElement.appendChild(document.createTextNode(" "+this._request.localizedFailDescription)):this._messageElement.appendChild(document.createTextNode(" "+this._request.statusCode+" ("+this._request.statusText+")"));else{var u=WebInspector.linkifyStringAsFragmentWithCustomLinkifier(this._messageText,WebInspector.linkifyRequestAsNode.bind(null,this._request));this._messageElement.appendChild(u)}}else{if(this.url){var a=!WebInspector.resourceForURL(this.url)&&!WebInspector.workspace.uiSourceCodeForURL(this.url);this._anchorElement=WebInspector.linkifyURLAsNode(this.url,this.url,"console-message-url",a)}this._messageElement=this._format([this._messageText])}else{var e=this._parameters||[this._messageText];this._messageElement=this._format(e)}if(this.source!==WebInspector.ConsoleMessage.MessageSource.Network||this._request)this._stackTrace&&this._stackTrace.length&&this._stackTrace[0].scriptId?this._anchorElement=this._linkifyCallFrame(this._stackTrace[0]):this.url&&this.url!=="undefined"&&(this._anchorElement=this._linkifyLocation(this.url,this.line,this.column));this._formattedMessage.appendChild(this._messageElement),this._anchorElement&&(this._formattedMessage.appendChild(document.createTextNode(" ")),this._formattedMessage.appendChild(this._anchorElement));var f=!!this._stackTrace&&this._stackTrace.length&&(this.source===WebInspector.ConsoleMessage.MessageSource.Network||this.level===WebInspector.ConsoleMessage.MessageLevel.Error||this.type===WebInspector.ConsoleMessage.MessageType.Trace);if(f){var l=document.createElement("ol");l.className="outline-disclosure";var c=new TreeOutline(l),h=this._formattedMessage,p=new TreeElement(h,null,!0);h.treeElementForTest=p,c.appendChild(p),this.type===WebInspector.ConsoleMessage.MessageType.Trace&&p.expand(),this._populateStackTraceTreeElement(p),this._formattedMessage=l}this._message=this._messageElement.textContent},get message(){var e=this.formattedMessage;return this._message},get formattedMessage(){return this._formattedMessage||this._formatMessage(),this._formattedMessage},request:function(){return this._request},_linkifyLocation:function(e,t,n){return t=t?t-1:0,n=n?n-1:0,this._linkifier.linkifyLocation(e,t,n,"console-message-url")},_linkifyCallFrame:function(e){var t=e.lineNumber?e.lineNumber-1:0,n=e.columnNumber?e.columnNumber-1:0,r=new WebInspector.DebuggerModel.Location(e.scriptId,t,n);return this._linkifier.linkifyRawLocation(r,"console-message-url")},isErrorOrWarning:function(){return this.level===WebInspector.ConsoleMessage.MessageLevel.Warning||this.level===WebInspector.ConsoleMessage.MessageLevel.Error},_format:function(e){var t=document.createElement("span");if(!e.length)return t;for(var n=0;n<e.length;++n){if(e[n]instanceof WebInspector.RemoteObject)continue;typeof e[n]=="object"?e[n]=WebInspector.RemoteObject.fromPayload(e[n]):e[n]=WebInspector.RemoteObject.fromPrimitiveValue(e[n])}var r=WebInspector.RemoteObject.type(e[0])==="string"&&this.type!==WebInspector.ConsoleMessage.MessageType.Result;if(r){var i=this._formatWithSubstitutionString(e[0].description,e.slice(1),t);e=i.unusedSubstitutions,e.length&&t.appendChild(document.createTextNode(" "))}if(this.type===WebInspector.ConsoleMessage.MessageType.Table)return t.appendChild(this._formatParameterAsTable(e)),t;for(var n=0;n<e.length;++n)r&&e[n].type==="string"?t.appendChild(WebInspector.linkifyStringAsFragment(e[n].description)):t.appendChild(this._formatParameter(e[n],!1,!0)),n<e.length-1&&t.appendChild(document.createTextNode(" "));return t},_formatParameter:function(e,t,n){var r;t?r="object":e instanceof WebInspector.RemoteObject?r=e.subtype||e.type:r=typeof e;var i=this._customFormatters[r];i||(i=this._formatParameterAsValue,e=e.description);var s=document.createElement("span");return s.className="console-formatted-"+r+" source-code",i.call(this,e,s,n),s},_formatParameterAsValue:function(e,t){t.appendChild(document.createTextNode(e))},_formatParameterAsObject:function(e,t,n){this._formatParameterAsArrayOrObject(e,e.description,t,n)},_formatParameterAsArrayOrObject:function(e,t,n,r){var i=document.createElement("span");t&&i.createTextChild(t);if(r&&e.preview){i.addStyleClass("console-object-preview");var s=this._appendObjectPreview(e,t,i);if(s){n.appendChild(i);return}}var o=new WebInspector.ObjectPropertiesSection(e,i);o.enableContextMenu(),n.appendChild(o.element);var u=o.titleElement.createChild("span","object-info-state-note");u.title=WebInspector.UIString("Object state below is captured upon first expansion")},_appendObjectPreview:function(e,t,n){var r=e.preview,i=e.subtype==="array";t&&n.createTextChild(" "),n.createTextChild(i?"[":"{");for(var s=0;s<r.properties.length;++s){s>0&&n.createTextChild(", ");var o=r.properties[s];if(!i||o.name!=s)n.createChild("span","name").textContent=o.name,n.createTextChild(": ");n.appendChild(this._renderPropertyPreview(o))}return r.overflow&&(n.createChild("span").textContent="…"),n.createTextChild(i?"]":"}"),r.lossless},_renderPropertyPreview:function(e){var t=document.createElement("span");return t.className="console-formatted-"+e.type,e.type==="function"?(t.textContent="function",t):e.type==="object"&&e.subtype==="regexp"?(t.addStyleClass("console-formatted-string"),t.textContent=e.value,t):e.type==="object"&&e.subtype==="node"&&e.value?(t.addStyleClass("console-formatted-preview-node"),WebInspector.DOMPresentationUtils.createSpansForNodeTitle(t,e.value),t):e.type==="string"?(t.textContent='"'+e.value+'"',t):(t.textContent=e.value,t)},_formatParameterAsNode:function(e,t){function n(n){if(!n){this._formatParameterAsObject(e,t,!1);return}var r=new WebInspector.ElementsTreeOutline(!1,!1);r.setVisible(!0),r.rootDOMNode=WebInspector.domAgent.nodeForId(n),r.element.addStyleClass("outline-disclosure"),r.children[0].hasChildren||r.element.addStyleClass("single-node"),t.appendChild(r.element),r.element.treeElementForTest=r.children[0]}e.pushNodeToFrontend(n.bind(this))},useArrayPreviewInFormatter:function(e){return this.type!==WebInspector.ConsoleMessage.MessageType.DirXML&&!!e.preview},_formatParameterAsArray:function(e,t){if(this.useArrayPreviewInFormatter(e)){this._formatParameterAsArrayOrObject(e,"",t,!0);return}const n=100;this._isOutdated||e.arrayLength()>n?this._formatParameterAsObject(e,t,!1):e.getOwnProperties(this._printArray.bind(this,e,t))},_formatParameterAsTable:function(e){var t=document.createElement("span"),n=e[0];if(!n||!n.preview)return t;var r=[],i=n.preview,s=[];for(var o=0;o<i.properties.length;++o){var u=i.properties[o],a=u.valuePreview;if(!a)continue;var f={};const l=20;for(var c=0;c<a.properties.length;++c){var h=a.properties[c],p=r.indexOf(h.name)!=-1;if(!p){if(r.length===l)continue;p=!0,r.push(h.name)}p&&(f[h.name]=this._renderPropertyPreview(h))}s.push([u.name,f])}var d=[];for(var o=0;o<s.length;++o){var v=s[o][0],f=s[o][1];d.push(v);for(var c=0;c<r.length;++c)d.push(f[r[c]])}if(!d.length)return t;r.unshift(WebInspector.UIString("(index)"));var m=WebInspector.DataGrid.createSortableDataGrid(r,d);return m.renderInline(),this._dataGrids.push(m),this._dataGridParents.put(m,t),t},_formatParameterAsString:function(e,t){var n=document.createElement("span");n.className="console-formatted-string source-code",n.appendChild(WebInspector.linkifyStringAsFragment(e.description)),t.removeStyleClass("console-formatted-string"),t.appendChild(document.createTextNode('"')),t.appendChild(n),t.appendChild(document.createTextNode('"'))},_printArray:function(e,t,n){function a(e,t){if(t-u<=1)return;var n=e.createChild("span","console-formatted-undefined");n.textContent=WebInspector.UIString("undefined × %d",t-u-1)}if(!n)return;var r=[];for(var i=0;i<n.length;++i){var s=n[i],o=s.name;isNaN(o)||(r[o]=this._formatAsArrayEntry(s.value))}t.appendChild(document.createTextNode("["));var u=-1,f=e.arrayLength();for(var i=0;i<f;++i){var l=r[i];if(!l)continue;i-u>1&&(a(t,i),t.appendChild(document.createTextNode(", "))),t.appendChild(l),u=i,i<f-1&&t.appendChild(document.createTextNode(", "))}a(t,f),t.appendChild(document.createTextNode("]"))},_formatAsArrayEntry:function(e){return this._formatParameter(e,e.subtype&&e.subtype==="array",!1)},_formatWithSubstitutionString:function(e,t,n){function i(e,t){return this._formatParameter(t,e,!1)}function s(e){return e.description}function o(e){return typeof e.value!="number"?"NaN":e.value}function u(e){return typeof e.value!="number"?"NaN":Math.floor(e.value)}function a(e){return e instanceof Node?e:""}function l(e){f={};var t=document.createElement("span");t.setAttribute("style",e.description);for(var n=0;n<t.style.length;n++){var r=t.style[n];c(r)&&(f[r]=t.style[r])}}function c(e){var t=["background","border","color","font","line","margin","padding","text","-webkit-background","-webkit-border","-webkit-font","-webkit-margin","-webkit-padding","-webkit-text"];for(var n=0;n<t.length;n++)if(e.startsWith(t[n]))return!0;return!1}function h(e,t){if(t instanceof Node)e.appendChild(t);else if(typeof t!="undefined"){var n=WebInspector.linkifyStringAsFragment(String(t));if(f){var r=document.createElement("span");for(var i in f)r.style[i]=f[i];r.appendChild(n),n=r}e.appendChild(n)}return e}var r={},f=null;return r.o=i.bind(this,!1),r.s=s,r.f=o,r.i=u,r.d=u,r.c=l,r.O=i.bind(this,!0),r._=a,String.format(e,t,r,n,h)},clearHighlight:function(){if(!this._formattedMessage)return;var e=this._formattedMessage;delete this._formattedMessage,delete this._anchorElement,delete this._messageElement,this._formatMessage(),this._element.replaceChild(this._formattedMessage,e)},highlightSearchResults:function(e){if(!this._formattedMessage)return;this._highlightSearchResultsInElement(e,this._messageElement),this._anchorElement&&this._highlightSearchResultsInElement(e,this._anchorElement),this._element.scrollIntoViewIfNeeded()},_highlightSearchResultsInElement:function(e,t){e.lastIndex=0;var n=t.textContent,r=e.exec(n),i=[];while(r)i.push({offset:r.index,length:r[0].length}),r=e.exec(n);WebInspector.highlightSearchResults(t,i)},matchesRegex:function(e){return e.lastIndex=0,e.test(this.message)||this._anchorElement&&e.test(this._anchorElement.textContent)},toMessageElement:function(){if(this._element)return this._element;var e=document.createElement("div");e.message=this,e.className="console-message",this._element=e;switch(this.level){case WebInspector.ConsoleMessage.MessageLevel.Log:e.addStyleClass("console-log-level");break;case WebInspector.ConsoleMessage.MessageLevel.Debug:e.addStyleClass("console-debug-level");break;case WebInspector.ConsoleMessage.MessageLevel.Warning:e.addStyleClass("console-warning-level");break;case WebInspector.ConsoleMessage.MessageLevel.Error:e.addStyleClass("console-error-level")}return(this.type===WebInspector.ConsoleMessage.MessageType.StartGroup||this.type===WebInspector.ConsoleMessage.MessageType.StartGroupCollapsed)&&e.addStyleClass("console-group-title"),e.appendChild(this.formattedMessage),this.repeatCount>1&&this.updateRepeatCount(),e},_populateStackTraceTreeElement:function(e){for(var t=0;t<this._stackTrace.length;t++){var n=this._stackTrace[t],r=document.createElement("div"),i=document.createElement("span");i.className="console-message-text source-code";var s=n.functionName||WebInspector.UIString("(anonymous function)");i.appendChild(document.createTextNode(s)),r.appendChild(i);if(n.scriptId){r.appendChild(document.createTextNode(" "));var o=this._linkifyCallFrame(n);if(!o)continue;r.appendChild(o)}var u=new TreeElement(r);e.appendChild(u)}},updateRepeatCount:function(){if(!this._element)return;this.repeatCountElement||(this.repeatCountElement=document.createElement("span"),this.repeatCountElement.className="bubble",this._element.insertBefore(this.repeatCountElement,this._element.firstChild),this._element.addStyleClass("repeated-message")),this.repeatCountElement.textContent=this.repeatCount},toString:function(){var e;switch(this.source){case WebInspector.ConsoleMessage.MessageSource.XML:e="XML";break;case WebInspector.ConsoleMessage.MessageSource.JS:e="JS";break;case WebInspector.ConsoleMessage.MessageSource.Network:e="Network";break;case WebInspector.ConsoleMessage.MessageSource.ConsoleAPI:e="ConsoleAPI";break;case WebInspector.ConsoleMessage.MessageSource.Storage:e="Storage";break;case WebInspector.ConsoleMessage.MessageSource.AppCache:e="AppCache";break;case WebInspector.ConsoleMessage.MessageSource.Rendering:e="Rendering";break;case WebInspector.ConsoleMessage.MessageSource.CSS:e="CSS";break;case WebInspector.ConsoleMessage.MessageSource.Security:e="Security";break;case WebInspector.ConsoleMessage.MessageSource.Other:e="Other"}var t;switch(this.type){case WebInspector.ConsoleMessage.MessageType.Log:t="Log";break;case WebInspector.ConsoleMessage.MessageType.Dir:t="Dir";break;case WebInspector.ConsoleMessage.MessageType.DirXML:t="Dir XML";break;case WebInspector.ConsoleMessage.MessageType.Trace:t="Trace";break;case WebInspector.ConsoleMessage.MessageType.StartGroupCollapsed:case WebInspector.ConsoleMessage.MessageType.StartGroup:t="Start Group";break;case WebInspector.ConsoleMessage.MessageType.EndGroup:t="End Group";break;case WebInspector.ConsoleMessage.MessageType.Assert:t="Assert";break;case WebInspector.ConsoleMessage.MessageType.Result:t="Result";break;case WebInspector.ConsoleMessage.MessageType.Profile:case WebInspector.ConsoleMessage.MessageType.ProfileEnd:t="Profiling"}var n;switch(this.level){case WebInspector.ConsoleMessage.MessageLevel.Log:n="Log";break;case WebInspector.ConsoleMessage.MessageLevel.Warning:n="Warning";break;case WebInspector.ConsoleMessage.MessageLevel.Debug:n="Debug";break;case WebInspector.ConsoleMessage.MessageLevel.Error:n="Error"}return e+" "+t+" "+n+": "+this.formattedMessage.textContent+"\n"+this.url+" line "+this.line},get text(){return this._messageText},location:function(){var e=this.stackTrace?this.stackTrace[0].lineNumber-1:this.line-1,t=this.stackTrace&&this.stackTrace[0].columnNumber?this.stackTrace[0].columnNumber-1:0;return WebInspector.debuggerModel.createRawLocationByURL(this.url,e,t)},isEqual:function(e){if(!e)return!1;if(this._stackTrace){if(!e._stackTrace)return!1;var t=this._stackTrace,n=e._stackTrace;if(t.length!==n.length)return!1;for(var r=0;r<t.length;r++)if(t[r].url!==n[r].url||t[r].functionName!==n[r].functionName||t[r].lineNumber!==n[r].lineNumber||t[r].columnNumber!==n[r].columnNumber)return!1}return this.source===e.source&&this.type===e.type&&this.level===e.level&&this.line===e.line&&this.url===e.url&&this.message===e.message&&this._request===e._request},get stackTrace(){return this._stackTrace},clone:function(){return WebInspector.ConsoleMessage.create(this.source,this.level,this._messageText,this.type,this.url,this.line,this.column,this.repeatCount,this._parameters,this._stackTrace,this._request?this._request.requestId:undefined,this._isOutdated)},__proto__:WebInspector.ConsoleMessage.prototype};