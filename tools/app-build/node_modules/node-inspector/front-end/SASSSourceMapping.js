/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.SASSSourceMapping=function(e,t,n){this.pollPeriodMs=5e3,this.pollIntervalMs=200,this._cssModel=e,this._workspace=t,this._networkWorkspaceProvider=n,this._addingRevisionCounter=0,this._reset(),WebInspector.fileManager.addEventListener(WebInspector.FileManager.EventTypes.SavedURL,this._fileSaveFinished,this),WebInspector.settings.cssSourceMapsEnabled.addChangeListener(this._toggleSourceMapSupport,this),this._cssModel.addEventListener(WebInspector.CSSStyleModel.Events.StyleSheetChanged,this._styleSheetChanged,this),this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeContentCommitted,this._uiSourceCodeContentCommitted,this),this._workspace.addEventListener(WebInspector.Workspace.Events.ProjectWillReset,this._reset,this)},WebInspector.SASSSourceMapping.prototype={_styleSheetChanged:function(e){var t=e.data.styleSheetId;if(this._addingRevisionCounter){--this._addingRevisionCounter;return}var n=this._cssModel.styleSheetHeaderForId(t);if(!n)return;this.removeHeader(n)},_toggleSourceMapSupport:function(e){var t=e.data,n=this._cssModel.styleSheetHeaders();for(var r=0;r<n.length;++r)t?this.addHeader(n[r]):this.removeHeader(n[r])},_fileSaveFinished:function(e){var t=e.data;this._sassFileSaved(t,!1)},_headerValue:function(e,t){e=e.toLowerCase();var n=null;for(var r in t)if(r.toLowerCase()===e){n=t[r];break}return n},_lastModified:function(e){var t=this._headerValue("last-modified",e);if(!t)return null;var n=new Date(t);return isNaN(n.getTime())?null:n},_checkLastModified:function(e,t){var n=this._lastModified(e);if(n)return n;var r=this._headerValue("etag",e)?', "ETag" response header found instead':"",i=String.sprintf('The "Last-Modified" response header is missing or invalid for %s%s. The CSS auto-reload functionality will not work correctly.',t,r);return WebInspector.log(i),null},_sassFileSaved:function(e,t){function i(t,n,r,i){if(t||n>=400){console.error("Could not load content for "+e+" : "+(t||"HTTP status code: "+n));return}var o=this._checkLastModified(r,e);if(!o)return;s.call(this,o)}function s(t){if(!t)return;var r=Date.now(),i=r+this.pollPeriodMs,s=this._pollDataForSASSURL[e];if(s){var o=s.dataByURL;for(var u in o)clearTimeout(o[u].timer)}s={dataByURL:{},deadlineMs:i,sassTimestamp:t},this._pollDataForSASSURL[e]=s;for(var a=0;a<n.length;++a)s.dataByURL[n[a]]={previousPoll:r},this._pollCallback(n[a],e,!1)}var n=this._cssURLsForSASSURL[e];if(!n)return;if(!WebInspector.settings.cssReloadEnabled.get())return;var r=this._workspace.uiSourceCodeForURL(e);console.assert(r),t?r.requestMetadata(s.bind(this)):NetworkAgent.loadResourceForFrontend(WebInspector.resourceTreeModel.mainFrame.id,e,undefined,i.bind(this))},_pollCallback:function(e,t,n){var r,i=this._pollDataForSASSURL[t];if(!i)return;if(n||(r=(new Date).getTime())>i.deadlineMs){delete i.dataByURL[e],Object.keys(i.dataByURL).length||delete this._pollDataForSASSURL[t];return}var s=this.pollIntervalMs+i.dataByURL[e].previousPoll,o=Math.max(0,s-r);i.dataByURL[e].previousPoll=r+o,i.dataByURL[e].timer=setTimeout(this._reloadCSS.bind(this,e,t,this._pollCallback.bind(this)),o)},_reloadCSS:function(e,t,n){var r=this._workspace.uiSourceCodeForURL(e);if(!r){WebInspector.log(e+" resource missing. Please reload the page."),n(e,t,!0);return}this._workspace.hasMappingForURL(t)?this._reloadCSSFromFileSystem(r,t,n):this._reloadCSSFromNetwork(r,t,n)},_reloadCSSFromNetwork:function(e,t,n){function o(s,o,u,a){if(s||o>=400){console.error("Could not load content for "+r+" : "+(s||"HTTP status code: "+o)),n(r,t,!0);return}if(!this._pollDataForSASSURL[t]){n(r,t,!0);return}if(o===304){n(r,t,!1);return}var f=this._checkLastModified(u,r);if(!f){n(r,t,!0);return}if(f.getTime()<i.sassTimestamp.getTime()){n(r,t,!1);return}this._updateCSSRevision(e,a,t,n)}var r=e.url,i=this._pollDataForSASSURL[t];if(!i){n(r,t,!0);return}var s={"if-modified-since":(new Date(i.sassTimestamp.getTime()-1e3)).toUTCString()};NetworkAgent.loadResourceForFrontend(WebInspector.resourceTreeModel.mainFrame.id,r,s,o.bind(this))},_updateCSSRevision:function(e,t,n,r){++this._addingRevisionCounter,e.addRevision(t),this._cssUISourceCodeUpdated(e.url,n,r)},_reloadCSSFromFileSystem:function(e,t,n){function r(r){function u(r){if(r===null)return;this._updateCSSRevision(e,r,t,n)}var i=e.url;if(!r){n(i,t,!1);return}var s=r.getTime(),o=this._pollDataForSASSURL[t];if(!o){n(i,t,!0);return}if(s<o.sassTimestamp.getTime()){n(i,t,!1);return}e.requestOriginalContent(u.bind(this))}e.requestMetadata(r.bind(this))},_cssUISourceCodeUpdated:function(e,t,n){var r=this._completeSourceMapURLForCSSURL[e];if(!r)return;var i=this._cssModel.styleSheetIdsForURL(e);if(!i)return;var s=[];for(var o=0;o<i.length;++o)s.push(this._cssModel.styleSheetHeaderForId(i[o]));for(var o=0;o<i.length;++o)this._loadSourceMapAndBindUISourceCode(s,!0,r);n(e,t,!0)},addHeader:function(e){if(!e.sourceMapURL||!e.sourceURL||e.isInline||!WebInspector.settings.cssSourceMapsEnabled.get())return;var t=WebInspector.ParsedURL.completeURL(e.sourceURL,e.sourceMapURL);if(!t)return;this._completeSourceMapURLForCSSURL[e.sourceURL]=t,this._loadSourceMapAndBindUISourceCode([e],!1,t)},removeHeader:function(e){var t=e.sourceURL;if(!t||!e.sourceMapURL||e.isInline||!this._completeSourceMapURLForCSSURL[t])return;delete this._sourceMapByStyleSheetURL[t],delete this._completeSourceMapURLForCSSURL[t];for(var n in this._cssURLsForSASSURL){var r=this._cssURLsForSASSURL[n];r.remove(t),r.length||delete this._cssURLsForSASSURL[n]}var i=WebInspector.ParsedURL.completeURL(t,e.sourceMapURL);i&&delete this._sourceMapByURL[i],e.updateLocations()},_loadSourceMapAndBindUISourceCode:function(e,t,n){function i(n){if(!n)return;this._sourceMapByStyleSheetURL[r]=n;for(var i=0;i<e.length;++i)t?e[i].updateLocations():this._bindUISourceCode(e[i],n)}console.assert(e.length);var r=e[0].sourceURL;this._loadSourceMapForStyleSheet(n,r,t,i.bind(this))},_addCSSURLforSASSURL:function(e,t){var n;this._cssURLsForSASSURL.hasOwnProperty(t)?n=this._cssURLsForSASSURL[t]:(n=[],this._cssURLsForSASSURL[t]=n),n.indexOf(e)===-1&&n.push(e)},_loadSourceMapForStyleSheet:function(e,t,n,r){function o(t){var n=this._pendingSourceMapLoadingCallbacks[e];delete this._pendingSourceMapLoadingCallbacks[e];if(!n)return;t?this._sourceMapByURL[e]=t:delete this._sourceMapByURL[e];for(var r=0;r<n.length;++r)n[r](t)}var i=this._sourceMapByURL[e];if(i&&!n){r(i);return}var s=this._pendingSourceMapLoadingCallbacks[e];if(s){s.push(r);return}s=[r],this._pendingSourceMapLoadingCallbacks[e]=s,WebInspector.SourceMap.load(e,t,o.bind(this))},_bindUISourceCode:function(e,t){e.pushSourceMapping(this);var n=e.sourceURL,r=t.sources();for(var i=0;i<r.length;++i){var s=r[i];this._addCSSURLforSASSURL(n,s);if(!this._workspace.hasMappingForURL(s)&&!this._workspace.uiSourceCodeForURL(s)){var o=t.sourceContentProvider(s,WebInspector.resourceTypes.Stylesheet),u=this._networkWorkspaceProvider.addFileForURL(s,o,!0);u.setSourceMapping(this)}}},rawLocationToUILocation:function(e){var t=e,n,r=this._sourceMapByStyleSheetURL[t.url];if(!r)return null;n=r.findEntry(t.lineNumber,t.columnNumber);if(!n||n.length===2)return null;var i=this._workspace.uiSourceCodeForURL(n[2]);return i?new WebInspector.UILocation(i,n[3],n[4]):null},uiLocationToRawLocation:function(e,t,n){return new WebInspector.CSSLocation(e.url||"",t,n)},isIdentity:function(){return!1},_uiSourceCodeAdded:function(e){var t=e.data,n=this._cssURLsForSASSURL[t.url];if(!n)return;t.setSourceMapping(this);for(var r=0;r<n.length;++r){var i=this._cssModel.styleSheetIdsForURL(n[r]);for(var s=0;s<i.length;++s){var o=this._cssModel.styleSheetHeaderForId(i[s]);console.assert(o),o.updateLocations()}}},_uiSourceCodeContentCommitted:function(e){var t=e.data.uiSourceCode;t.project().type()===WebInspector.projectTypes.FileSystem&&this._sassFileSaved(t.url,!0)},_reset:function(){this._addingRevisionCounter=0,this._completeSourceMapURLForCSSURL={},this._cssURLsForSASSURL={},this._pendingSourceMapLoadingCallbacks={},this._pollDataForSASSURL={},this._sourceMapByURL={},this._sourceMapByStyleSheetURL={}}};