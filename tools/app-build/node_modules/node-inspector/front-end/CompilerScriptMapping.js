/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CompilerScriptMapping=function(e,t){this._workspace=e,this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAddedToWorkspace,this),this._networkWorkspaceProvider=t,this._sourceMapForSourceMapURL={},this._pendingSourceMapLoadingCallbacks={},this._sourceMapForScriptId={},this._scriptForSourceMap=new Map,this._sourceMapForURL={},WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.GlobalObjectCleared,this._debuggerReset,this)},WebInspector.CompilerScriptMapping.prototype={rawLocationToUILocation:function(e){var t=e,n=this._sourceMapForScriptId[t.scriptId];if(!n)return null;var r=t.lineNumber,i=t.columnNumber||0,s=n.findEntry(r,i);if(!s||s.length===2)return null;var o=s[2],u=this._workspace.uiSourceCodeForURL(o);return u?new WebInspector.UILocation(u,s[3],s[4]):null},uiLocationToRawLocation:function(e,t,n){if(!e.url)return null;var r=this._sourceMapForURL[e.url];if(!r)return null;var i=r.findEntryReversed(e.url,t);return WebInspector.debuggerModel.createRawLocation(this._scriptForSourceMap.get(r)||null,i[0],i[1])},isIdentity:function(){return!1},addScript:function(e){function t(t){if(!t)return;if(this._scriptForSourceMap.get(t)){this._sourceMapForScriptId[e.scriptId]=t,e.updateLocations();return}this._sourceMapForScriptId[e.scriptId]=t,this._scriptForSourceMap.put(t,e);var n=t.sources();for(var r=0;r<n.length;++r){var i=n[r];if(this._sourceMapForURL[i])continue;this._sourceMapForURL[i]=t;if(!this._workspace.hasMappingForURL(i)&&!this._workspace.uiSourceCodeForURL(i)){var s=t.sourceContentProvider(i,WebInspector.resourceTypes.Script);this._networkWorkspaceProvider.addFileForURL(i,s,!0)}var o=this._workspace.uiSourceCodeForURL(i);o&&(this._bindUISourceCode(o),o.isContentScript=e.isContentScript)}e.updateLocations()}e.pushSourceMapping(this),this.loadSourceMapForScript(e,t.bind(this))},_bindUISourceCode:function(e){e.setSourceMapping(this)},_uiSourceCodeAddedToWorkspace:function(e){var t=e.data;if(!t.url||!this._sourceMapForURL[t.url])return;this._bindUISourceCode(t)},loadSourceMapForScript:function(e,t){function o(e){var t=this._pendingSourceMapLoadingCallbacks[r];delete this._pendingSourceMapLoadingCallbacks[r];if(!t)return;e&&(this._sourceMapForSourceMapURL[r]=e);for(var n=0;n<t.length;++n)t[n](e)}if(!e.sourceMapURL){t(null);return}var n=WebInspector.ParsedURL.completeURL(WebInspector.inspectedPageURL,e.sourceURL);if(!n){t(null);return}var r=WebInspector.ParsedURL.completeURL(n,e.sourceMapURL);if(!r){t(null);return}var i=this._sourceMapForSourceMapURL[r];if(i){t(i);return}var s=this._pendingSourceMapLoadingCallbacks[r];if(s){s.push(t);return}s=[t],this._pendingSourceMapLoadingCallbacks[r]=s,WebInspector.SourceMap.load(r,n,o.bind(this))},_debuggerReset:function(){this._sourceMapForSourceMapURL={},this._pendingSourceMapLoadingCallbacks={},this._sourceMapForScriptId={},this._scriptForSourceMap=new Map,this._sourceMapForURL={}}};