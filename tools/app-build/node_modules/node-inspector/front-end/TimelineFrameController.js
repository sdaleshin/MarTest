/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.TimelineFrameController=function(e,t,n){this._lastFrame=null,this._model=e,this._overviewPane=t,this._presentationModel=n,this._model.addEventListener(WebInspector.TimelineModel.Events.RecordAdded,this._onRecordAdded,this),this._model.addEventListener(WebInspector.TimelineModel.Events.RecordsCleared,this._onRecordsCleared,this);var r=e.records;for(var i=0;i<r.length;++i)this._addRecord(r[i])},WebInspector.TimelineFrameController.prototype={_onRecordAdded:function(e){this._addRecord(e.data)},_onRecordsCleared:function(){this._lastFrame=null},_addRecord:function(e){if(e.isBackground)return;var t,n;e.type===WebInspector.TimelineModel.RecordType.Program?(n=e,this._lastFrame&&(this._lastFrame.timeByCategory.other+=WebInspector.TimelineModel.durationInSeconds(n)),t=e.children||[]):t=[e],t.forEach(this._innerAddRecord.bind(this,n))},_innerAddRecord:function(e,t){var n=t.type===WebInspector.TimelineModel.RecordType.BeginFrame,r=n&&e?WebInspector.TimelineModel.endTimeInSeconds(e)-WebInspector.TimelineModel.startTimeInSeconds(t):0;if(n&&this._lastFrame)this._flushFrame(t,r);else{this._lastFrame||(this._lastFrame=this._createFrame(t,r)),t.thread||WebInspector.TimelineModel.aggregateTimeForRecord(this._lastFrame.timeByCategory,t);var i=WebInspector.TimelineModel.durationInSeconds(t);this._lastFrame.cpuTime+=i,this._lastFrame.timeByCategory.other-=i}},_flushFrame:function(e,t){this._lastFrame.endTime=WebInspector.TimelineModel.startTimeInSeconds(e),this._lastFrame.duration=this._lastFrame.endTime-this._lastFrame.startTime,this._lastFrame.timeByCategory.other-=t,this._lastFrame.cpuTime+=this._lastFrame.timeByCategory.other,this._overviewPane.addFrame(this._lastFrame),this._presentationModel.addFrame(this._lastFrame),this._lastFrame=this._createFrame(e,t)},_createFrame:function(e,t){var n=new WebInspector.TimelineFrame;return n.startTime=WebInspector.TimelineModel.startTimeInSeconds(e),n.startTimeOffset=this._model.recordOffsetInSeconds(e),n.timeByCategory.other=t,n},dispose:function(){this._model.removeEventListener(WebInspector.TimelineModel.Events.RecordAdded,this._onRecordAdded,this),this._model.removeEventListener(WebInspector.TimelineModel.Events.RecordsCleared,this._onRecordsCleared,this)}},WebInspector.FrameStatistics=function(e){this.frameCount=e.length,this.minDuration=Infinity,this.maxDuration=0,this.timeByCategory={},this.startOffset=e[0].startTimeOffset;var t=e[this.frameCount-1];this.endOffset=t.startTimeOffset+t.duration;var n=0,r=0;for(var i=0;i<this.frameCount;++i){var s=e[i].duration;n+=s,r+=s*s,this.minDuration=Math.min(this.minDuration,s),this.maxDuration=Math.max(this.maxDuration,s),WebInspector.TimelineModel.aggregateTimeByCategory(this.timeByCategory,e[i].timeByCategory)}this.average=n/this.frameCount;var o=r/this.frameCount-this.average*this.average;this.stddev=Math.sqrt(o)},WebInspector.TimelineFrame=function(){this.timeByCategory={},this.cpuTime=0};