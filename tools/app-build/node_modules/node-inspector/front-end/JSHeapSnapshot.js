/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.JSHeapSnapshot=function(e,t){this._nodeFlags={canBeQueried:1,detachedDOMTreeNode:2,pageObject:4,visitedMarkerMask:65535,visitedMarker:65536},WebInspector.HeapSnapshot.call(this,e,t)},WebInspector.JSHeapSnapshot.prototype={createNode:function(e){return new WebInspector.JSHeapSnapshotNode(this,e)},createEdge:function(e,t){return new WebInspector.JSHeapSnapshotEdge(this,e,t)},createRetainingEdge:function(e,t){return new WebInspector.JSHeapSnapshotRetainerEdge(this,e,t)},classNodesFilter:function(){function e(e){return e.isUserObject()}return e},containmentEdgesFilter:function(e){function t(t){return t.isInvisible()?!1:e?!0:!t.isHidden()&&!t.node().isHidden()}return t},retainingEdgesFilter:function(e){function n(e){return t(e)&&!e.node().isRoot()&&!e.isWeak()}var t=this.containmentEdgesFilter(e);return n},dispose:function(){WebInspector.HeapSnapshot.prototype.dispose.call(this),delete this._flags},_markInvisibleEdges:function(){for(var e=this.rootNode().edges();e.hasNext();e.next()){var t=e.edge;if(!t.isShortcut())continue;var n=t.node(),r={};for(var i=n.edges();i.hasNext();i.next()){var s=i.edge;s.isShortcut()&&(r[s._nameOrIndex()]=!0)}for(i.rewind();i.hasNext();i.next()){var s=i.edge;!s.isShortcut()&&s.node().isHidden()&&s._hasStringName()&&s._nameOrIndex()in r&&(this._containmentEdges[s._edges._start+s.edgeIndex+this._edgeTypeOffset]=this._edgeInvisibleType)}}},_calculateFlags:function(){this._flags=new Uint32Array(this.nodeCount),this._markDetachedDOMTreeNodes(),this._markQueriableHeapObjects(),this._markPageOwnedNodes()},_isUserRoot:function(e){return e.isUserRoot()||e.isDocumentDOMTreesRoot()},forEachRoot:function(e,t){function n(e,t){for(var n=e.edges();n.hasNext();n.next()){var r=n.edge.node();if(r.name()===t)return r}return null}function r(e,t){for(var n=e.edges();n.hasNext();n.next()){var r=n.edge;if(r.name()===t)return r.node()}return null}function s(t){var n=t._ordinal();i[n]||(e(t),i[n]=!0)}var i={},o=n(this.rootNode(),"(GC roots)");if(!o)return;if(t)for(var u=this.rootNode().edges();u.hasNext();u.next()){var a=u.edge.node();if(a.isDocumentDOMTreesRoot())s(a);else if(a.isUserRoot()){var f=r(a,"native_context");f?s(f):s(a)}}else{for(var u=o.edges();u.hasNext();u.next()){var l=u.edge.node();for(var c=l.edges();c.hasNext();c.next())s(c.edge.node());s(l)}for(var u=this.rootNode().edges();u.hasNext();u.next())s(u.edge.node())}},userObjectsMapAndFlag:function(){return{map:this._flags,flag:this._nodeFlags.pageObject}},_flagsOfNode:function(e){return this._flags[e.nodeIndex/this._nodeFieldCount]},_markDetachedDOMTreeNodes:function(){var e=this._nodeFlags.detachedDOMTreeNode,t;for(var n=this.rootNode().edges();n.hasNext();n.next()){var r=n.edge.node();if(r.name()==="(Detached DOM trees)"){t=r;break}}if(!t)return;var i=/^Detached DOM tree/;for(var n=t.edges();n.hasNext();n.next()){var r=n.edge.node();if(i.test(r.className()))for(var s=r.edges();s.hasNext();s.next())this._flags[s.edge.node().nodeIndex/this._nodeFieldCount]|=e}},_markQueriableHeapObjects:function(){var e=this._nodeFlags.canBeQueried,t=this._edgeHiddenType,n=this._edgeInternalType,r=this._edgeInvisibleType,i=this._edgeWeakType,s=this._edgeToNodeOffset,o=this._edgeTypeOffset,u=this._edgeFieldsCount,a=this._containmentEdges,f=this._nodes,l=this.nodeCount,c=this._nodeFieldCount,h=this._firstEdgeIndexes,p=this._flags,d=[];for(var v=this.rootNode().edges();v.hasNext();v.next())v.edge.node().isUserRoot()&&d.push(v.edge.node().nodeIndex/c);while(d.length){var m=d.pop();if(p[m]&e)continue;p[m]|=e;var g=h[m],y=h[m+1];for(var b=g;b<y;b+=u){var w=a[b+s],E=w/c;if(p[E]&e)continue;var S=a[b+o];if(S===t||S===r||S===n||S===i)continue;d.push(E)}}},_markPageOwnedNodes:function(){var e=this._edgeShortcutType,t=this._edgeElementType,n=this._edgeToNodeOffset,r=this._edgeTypeOffset,i=this._edgeFieldsCount,s=this._edgeWeakType,o=this._firstEdgeIndexes,u=this._containmentEdges,a=u.length,f=this._nodes,l=this._nodeFieldCount,c=this.nodeCount,h=this._flags,p=this._nodeFlags.pageObject,d=this._nodeFlags.visitedMarker,v=this._nodeFlags.visitedMarkerMask,m=d|p,g=new Uint32Array(c),y=0,b=this._rootNodeIndex/l,w=this.rootNode();for(var E=o[b],S=o[b+1];E<S;E+=i){var x=u[E+r],T=u[E+n];if(x===t){w.nodeIndex=T;if(!w.isDocumentDOMTreesRoot())continue}else if(x!==e)continue;var N=T/l;g[y++]=N,h[N]|=d}while(y){var N=g[--y];h[N]|=p,h[N]&=v;var C=o[N],S=o[N+1];for(var E=C;E<S;E+=i){var k=u[E+n],L=k/l;if(h[L]&m)continue;var A=u[E+r];if(A===s)continue;g[y++]=L,h[L]|=d}}},__proto__:WebInspector.HeapSnapshot.prototype},WebInspector.JSHeapSnapshotNode=function(e,t){WebInspector.HeapSnapshotNode.call(this,e,t)},WebInspector.JSHeapSnapshotNode.prototype={canBeQueried:function(){var e=this._snapshot._flagsOfNode(this);return!!(e&this._snapshot._nodeFlags.canBeQueried)},isUserObject:function(){var e=this._snapshot._flagsOfNode(this);return!!(e&this._snapshot._nodeFlags.pageObject)},className:function(){var e=this.type();switch(e){case"hidden":return"(system)";case"object":case"native":return this.name();case"code":return"(compiled code)";default:return"("+e+")"}},classIndex:function(){var e=this._snapshot,t=e._nodes,n=t[this.nodeIndex+e._nodeTypeOffset];return n===e._nodeObjectType||n===e._nodeNativeType?t[this.nodeIndex+e._nodeNameOffset]:-1-n},id:function(){var e=this._snapshot;return e._nodes[this.nodeIndex+e._nodeIdOffset]},isHidden:function(){return this._type()===this._snapshot._nodeHiddenType},isSynthetic:function(){return this._type()===this._snapshot._nodeSyntheticType},isUserRoot:function(){return!this.isSynthetic()},isDocumentDOMTreesRoot:function(){return this.isSynthetic()&&this.name()==="(Document DOM trees)"},serialize:function(){var e=WebInspector.HeapSnapshotNode.prototype.serialize.call(this),t=this._snapshot._flagsOfNode(this);return t&this._snapshot._nodeFlags.canBeQueried&&(e.canBeQueried=!0),t&this._snapshot._nodeFlags.detachedDOMTreeNode&&(e.detachedDOMTreeNode=!0),e},__proto__:WebInspector.HeapSnapshotNode.prototype},WebInspector.JSHeapSnapshotEdge=function(e,t,n){WebInspector.HeapSnapshotEdge.call(this,e,t,n)},WebInspector.JSHeapSnapshotEdge.prototype={clone:function(){return new WebInspector.JSHeapSnapshotEdge(this._snapshot,this._edges,this.edgeIndex)},hasStringName:function(){return this.isShortcut()?isNaN(parseInt(this._name(),10)):this._hasStringName()},isElement:function(){return this._type()===this._snapshot._edgeElementType},isHidden:function(){return this._type()===this._snapshot._edgeHiddenType},isWeak:function(){return this._type()===this._snapshot._edgeWeakType},isInternal:function(){return this._type()===this._snapshot._edgeInternalType},isInvisible:function(){return this._type()===this._snapshot._edgeInvisibleType},isShortcut:function(){return this._type()===this._snapshot._edgeShortcutType},name:function(){if(!this.isShortcut())return this._name();var e=parseInt(this._name(),10);return isNaN(e)?this._name():e},toString:function(){var e=this.name();switch(this.type()){case"context":return"->"+e;case"element":return"["+e+"]";case"weak":return"[["+e+"]]";case"property":return e.indexOf(" ")===-1?"."+e:'["'+e+'"]';case"shortcut":return typeof e=="string"?e.indexOf(" ")===-1?"."+e:'["'+e+'"]':"["+e+"]";case"internal":case"hidden":case"invisible":return"{"+e+"}"}return"?"+e+"?"},_hasStringName:function(){return!this.isElement()&&!this.isHidden()&&!this.isWeak()},_name:function(){return this._hasStringName()?this._snapshot._strings[this._nameOrIndex()]:this._nameOrIndex()},_nameOrIndex:function(){return this._edges.item(this.edgeIndex+this._snapshot._edgeNameOffset)},_type:function(){return this._edges.item(this.edgeIndex+this._snapshot._edgeTypeOffset)},__proto__:WebInspector.HeapSnapshotEdge.prototype},WebInspector.JSHeapSnapshotRetainerEdge=function(e,t,n){WebInspector.HeapSnapshotRetainerEdge.call(this,e,t,n)},WebInspector.JSHeapSnapshotRetainerEdge.prototype={clone:function(){return new WebInspector.JSHeapSnapshotRetainerEdge(this._snapshot,this._retainedNodeIndex,this.retainerIndex())},isHidden:function(){return this._edge().isHidden()},isInternal:function(){return this._edge().isInternal()},isInvisible:function(){return this._edge().isInvisible()},isShortcut:function(){return this._edge().isShortcut()},isWeak:function(){return this._edge().isWeak()},__proto__:WebInspector.HeapSnapshotRetainerEdge.prototype};