/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CPUProfileView=function(e){WebInspector.View.call(this),this.element.addStyleClass("profile-view"),this.showSelfTimeAsPercent=WebInspector.settings.createSetting("cpuProfilerShowSelfTimeAsPercent",!0),this.showTotalTimeAsPercent=WebInspector.settings.createSetting("cpuProfilerShowTotalTimeAsPercent",!0),this.showAverageTimeAsPercent=WebInspector.settings.createSetting("cpuProfilerShowAverageTimeAsPercent",!0),this._viewType=WebInspector.settings.createSetting("cpuProfilerView",WebInspector.CPUProfileView._TypeHeavy);var t=[];t.push({id:"self",title:WebInspector.UIString("Self"),width:"72px",sort:WebInspector.DataGrid.Order.Descending,sortable:!0}),t.push({id:"total",title:WebInspector.UIString("Total"),width:"72px",sortable:!0}),t.push({id:"function",title:WebInspector.UIString("Function"),disclosure:!0,sortable:!0}),this.dataGrid=new WebInspector.DataGrid(t),this.dataGrid.addEventListener(WebInspector.DataGrid.Events.SortingChanged,this._sortProfile,this),this.dataGrid.element.addEventListener("mousedown",this._mouseDownInDataGrid.bind(this),!0),this.dataGrid.show(this.element),this.viewSelectComboBox=new WebInspector.StatusBarComboBox(this._changeView.bind(this));var n={};n[WebInspector.CPUProfileView._TypeFlame]=this.viewSelectComboBox.createOption(WebInspector.UIString("Flame Chart"),"",WebInspector.CPUProfileView._TypeFlame),n[WebInspector.CPUProfileView._TypeHeavy]=this.viewSelectComboBox.createOption(WebInspector.UIString("Heavy (Bottom Up)"),"",WebInspector.CPUProfileView._TypeHeavy),n[WebInspector.CPUProfileView._TypeTree]=this.viewSelectComboBox.createOption(WebInspector.UIString("Tree (Top Down)"),"",WebInspector.CPUProfileView._TypeTree);var r=this._viewType.get()||WebInspector.CPUProfileView._TypeFlame,i=n[r]||n[WebInspector.CPUProfileView._TypeFlame];this.viewSelectComboBox.select(i),this._statusBarButtonsElement=document.createElement("span"),this.percentButton=new WebInspector.StatusBarButton("","percent-time-status-bar-item"),this.percentButton.addEventListener("click",this._percentClicked,this),this._statusBarButtonsElement.appendChild(this.percentButton.element),this.focusButton=new WebInspector.StatusBarButton(WebInspector.UIString("Focus selected function."),"focus-profile-node-status-bar-item"),this.focusButton.setEnabled(!1),this.focusButton.addEventListener("click",this._focusClicked,this),this._statusBarButtonsElement.appendChild(this.focusButton.element),this.excludeButton=new WebInspector.StatusBarButton(WebInspector.UIString("Exclude selected function."),"exclude-profile-node-status-bar-item"),this.excludeButton.setEnabled(!1),this.excludeButton.addEventListener("click",this._excludeClicked,this),this._statusBarButtonsElement.appendChild(this.excludeButton.element),this.resetButton=new WebInspector.StatusBarButton(WebInspector.UIString("Restore all functions."),"reset-profile-status-bar-item"),this.resetButton.visible=!1,this.resetButton.addEventListener("click",this._resetClicked,this),this._statusBarButtonsElement.appendChild(this.resetButton.element),this.profileHead=null,this.profile=e,this._linkifier=new WebInspector.Linkifier(new WebInspector.Linkifier.DefaultFormatter(30)),this.profile._profile?this._processProfileData(this.profile._profile):ProfilerAgent.getCPUProfile(this.profile.uid,this._getCPUProfileCallback.bind(this))},WebInspector.CPUProfileView._TypeFlame="Flame",WebInspector.CPUProfileView._TypeTree="Tree",WebInspector.CPUProfileView._TypeHeavy="Heavy",WebInspector.CPUProfileView.prototype={selectRange:function(e,t){if(!this._flameChart)return;this._flameChart.selectRange(e,t)},_revealProfilerNode:function(e){var t=this.profileDataGridTree.children[0];while(t&&t.profileNode!==e.data)t=t.traverseNextNode(!1,null,!1);t&&t.revealAndSelect()},_getCPUProfileCallback:function(e,t){if(e)return;if(!t.head)return;this._processProfileData(t)},_processProfileData:function(e){this.profileHead=e.head,this.samples=e.samples,this._calculateTimes(e),this._assignParentsInProfile(),this.samples&&this._buildIdToNodeMap(),this._changeView(),this._updatePercentButton(),this._flameChart&&this._flameChart.update()},get statusBarItems(){return[this.viewSelectComboBox.element,this._statusBarButtonsElement]},_getBottomUpProfileDataGridTree:function(){return this._bottomUpProfileDataGridTree||(this._bottomUpProfileDataGridTree=new WebInspector.BottomUpProfileDataGridTree(this,this.profileHead)),this._bottomUpProfileDataGridTree},_getTopDownProfileDataGridTree:function(){return this._topDownProfileDataGridTree||(this._topDownProfileDataGridTree=new WebInspector.TopDownProfileDataGridTree(this,this.profileHead)),this._topDownProfileDataGridTree},willHide:function(){this._currentSearchResultIndex=-1},refresh:function(){var e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;this.dataGrid.rootNode().removeChildren();var t=this.profileDataGridTree.children,n=t.length;for(var r=0;r<n;++r)this.dataGrid.rootNode().appendChild(t[r]);e&&(e.selected=!0)},refreshVisibleData:function(){var e=this.dataGrid.rootNode().children[0];while(e)e.refresh(),e=e.traverseNextNode(!1,null,!0)},refreshShowAsPercents:function(){this._updatePercentButton(),this.refreshVisibleData()},searchCanceled:function(){if(this._searchResults)for(var e=0;e<this._searchResults.length;++e){var t=this._searchResults[e].profileNode;delete t._searchMatchedSelfColumn,delete t._searchMatchedTotalColumn,delete t._searchMatchedFunctionColumn,t.refresh()}delete this._searchFinishedCallback,this._currentSearchResultIndex=-1,this._searchResults=[]},performSearch:function(e,t){function c(e){delete e._searchMatchedSelfColumn,delete e._searchMatchedTotalColumn,delete e._searchMatchedFunctionColumn;if(s)r?(e.selfPercent<a&&(e._searchMatchedSelfColumn=!0),e.totalPercent<a&&(e._searchMatchedTotalColumn=!0)):n&&(e.selfPercent>a&&(e._searchMatchedSelfColumn=!0),e.totalPercent>a&&(e._searchMatchedTotalColumn=!0)),i&&(e.selfPercent==a&&(e._searchMatchedSelfColumn=!0),e.totalPercent==a&&(e._searchMatchedTotalColumn=!0));else if(o||u)r?(e.selfTime<f&&(e._searchMatchedSelfColumn=!0),e.totalTime<f&&(e._searchMatchedTotalColumn=!0)):n&&(e.selfTime>f&&(e._searchMatchedSelfColumn=!0),e.totalTime>f&&(e._searchMatchedTotalColumn=!0)),i&&(e.selfTime==f&&(e._searchMatchedSelfColumn=!0),e.totalTime==f&&(e._searchMatchedTotalColumn=!0));if(e.functionName.match(l)||e.url&&e.url.match(l))e._searchMatchedFunctionColumn=!0;return e._searchMatchedSelfColumn||e._searchMatchedTotalColumn||e._searchMatchedFunctionColumn?(e.refresh(),!0):!1}this.searchCanceled(),e=e.trim();if(!e.length)return;this._searchFinishedCallback=t;var n=e.startsWith(">"),r=e.startsWith("<"),i=e.startsWith("=")||(n||r)&&e.indexOf("=")===1,s=e.lastIndexOf("%")===e.length-1,o=e.length>2&&e.lastIndexOf("ms")===e.length-2,u=!o&&e.lastIndexOf("s")===e.length-1,a=parseFloat(e);if(n||r||i)i&&(n||r)?a=parseFloat(e.substring(2)):a=parseFloat(e.substring(1));var f=u?a*1e3:a;!isNaN(a)&&!n&&!r&&(i=!0);var l=createPlainTextSearchRegex(e,"i"),h=this.profileDataGridTree.children[0];while(h)c(h)&&this._searchResults.push({profileNode:h}),h=h.traverseNextNode(!1,null,!1);t(this,this._searchResults.length)},jumpToFirstSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;this._currentSearchResultIndex=0,this._jumpToSearchResult(this._currentSearchResultIndex)},jumpToLastSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;this._currentSearchResultIndex=this._searchResults.length-1,this._jumpToSearchResult(this._currentSearchResultIndex)},jumpToNextSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;++this._currentSearchResultIndex>=this._searchResults.length&&(this._currentSearchResultIndex=0),this._jumpToSearchResult(this._currentSearchResultIndex)},jumpToPreviousSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;--this._currentSearchResultIndex<0&&(this._currentSearchResultIndex=this._searchResults.length-1),this._jumpToSearchResult(this._currentSearchResultIndex)},showingFirstSearchResult:function(){return this._currentSearchResultIndex===0},showingLastSearchResult:function(){return this._searchResults&&this._currentSearchResultIndex===this._searchResults.length-1},_jumpToSearchResult:function(e){var t=this._searchResults[e];if(!t)return;var n=t.profileNode;n.revealAndSelect()},_ensureFlameChartCreated:function(){if(this._flameChart)return;this._flameChart=new WebInspector.FlameChart(this),this._flameChart.addEventListener(WebInspector.FlameChart.Events.SelectedNode,this._onSelectedNode.bind(this))},_onSelectedNode:function(e){var t=e.data;if(!t||!t.scriptId)return;var n=WebInspector.debuggerModel.scriptForId(t.scriptId);if(!n)return;var r=n.rawLocationToUILocation(t.lineNumber);if(!r)return;WebInspector.showPanel("scripts").showUILocation(r)},_changeView:function(){if(!this.profile)return;switch(this.viewSelectComboBox.selectedOption().value){case WebInspector.CPUProfileView._TypeFlame:this._ensureFlameChartCreated(),this.dataGrid.detach(),this._flameChart.show(this.element),this._viewType.set(WebInspector.CPUProfileView._TypeFlame),this._statusBarButtonsElement.enableStyleClass("hidden",!0);return;case WebInspector.CPUProfileView._TypeTree:this.profileDataGridTree=this._getTopDownProfileDataGridTree(),this._sortProfile(),this._viewType.set(WebInspector.CPUProfileView._TypeTree);break;case WebInspector.CPUProfileView._TypeHeavy:this.profileDataGridTree=this._getBottomUpProfileDataGridTree(),this._sortProfile(),this._viewType.set(WebInspector.CPUProfileView._TypeHeavy)}this._statusBarButtonsElement.enableStyleClass("hidden",!1),this._flameChart&&this._flameChart.detach(),this.dataGrid.show(this.element);if(!this.currentQuery||!this._searchFinishedCallback||!this._searchResults)return;this._searchFinishedCallback(this,-this._searchResults.length),this.performSearch(this.currentQuery,this._searchFinishedCallback)},_percentClicked:function(e){var t=this.showSelfTimeAsPercent.get()&&this.showTotalTimeAsPercent.get()&&this.showAverageTimeAsPercent.get();this.showSelfTimeAsPercent.set(!t),this.showTotalTimeAsPercent.set(!t),this.showAverageTimeAsPercent.set(!t),this.refreshShowAsPercents()},_updatePercentButton:function(){this.showSelfTimeAsPercent.get()&&this.showTotalTimeAsPercent.get()&&this.showAverageTimeAsPercent.get()?(this.percentButton.title=WebInspector.UIString("Show absolute total and self times."),this.percentButton.toggled=!0):(this.percentButton.title=WebInspector.UIString("Show total and self times as percentages."),this.percentButton.toggled=!1)},_focusClicked:function(e){if(!this.dataGrid.selectedNode)return;this.resetButton.visible=!0,this.profileDataGridTree.focus(this.dataGrid.selectedNode),this.refresh(),this.refreshVisibleData()},_excludeClicked:function(e){var t=this.dataGrid.selectedNode;if(!t)return;t.deselect(),this.resetButton.visible=!0,this.profileDataGridTree.exclude(t),this.refresh(),this.refreshVisibleData()},_resetClicked:function(e){this.resetButton.visible=!1,this.profileDataGridTree.restore(),this._linkifier.reset(),this.refresh(),this.refreshVisibleData()},_dataGridNodeSelected:function(e){this.focusButton.setEnabled(!0),this.excludeButton.setEnabled(!0)},_dataGridNodeDeselected:function(e){this.focusButton.setEnabled(!1),this.excludeButton.setEnabled(!1)},_sortProfile:function(){var e=this.dataGrid.isSortOrderAscending(),t=this.dataGrid.sortColumnIdentifier(),n={self:"selfTime",total:"totalTime","function":"functionName"}[t];this.profileDataGridTree.sort(WebInspector.ProfileDataGridTree.propertyComparator(n,e)),this.refresh()},_mouseDownInDataGrid:function(e){if(e.detail<2)return;var t=e.target.enclosingNodeOrSelfWithNodeName("td");if(!t||!t.hasStyleClass("total-column")&&!t.hasStyleClass("self-column")&&!t.hasStyleClass("average-column"))return;t.hasStyleClass("total-column")?this.showTotalTimeAsPercent.set(!this.showTotalTimeAsPercent.get()):t.hasStyleClass("self-column")?this.showSelfTimeAsPercent.set(!this.showSelfTimeAsPercent.get()):t.hasStyleClass("average-column")&&this.showAverageTimeAsPercent.set(!this.showAverageTimeAsPercent.get()),this.refreshShowAsPercents(),e.consume(!0)},_calculateTimes:function(e){function t(e){var n=e.hitCount;for(var r=0;r<e.children.length;r++)n+=t(e.children[r]);return n}function i(e){e.selfTime=e.hitCount*r;var t=e.selfTime;for(var n=0;n<e.children.length;n++)t+=i(e.children[n]);return e.totalTime=t,t}e.totalHitCount=t(e.head);var n=1e3*e.endTime-1e3*e.startTime,r=e.totalHitCount/n;this.samplesPerMs=r,i(e.head)},_assignParentsInProfile:function(){var e=this.profileHead;e.parent=null,e.head=null;var t=[{parent:e,children:e.children}];while(t.length>0){var n=t.pop(),r=n.parent,i=n.children,s=i.length;for(var o=0;o<s;++o)i[o].head=e,i[o].parent=r,i[o].children.length>0&&t.push({parent:i[o],children:i[o].children})}},_buildIdToNodeMap:function(){var e=this._idToNode={},t=[this.profileHead];while(t.length){var n=t.pop();e[n.id]=n;for(var r=0;r<n.children.length;r++)t.push(n.children[r])}var i=this.profileHead.children;for(var r=0;r<i.length;r++){var n=i[r];if(n.functionName=="(garbage collector)"){this._gcNode=n;break}}},__proto__:WebInspector.View.prototype},WebInspector.CPUProfileType=function(){WebInspector.ProfileType.call(this,WebInspector.CPUProfileType.TypeId,WebInspector.UIString("Collect JavaScript CPU Profile")),InspectorBackend.registerProfilerDispatcher(this),this._recording=!1,WebInspector.CPUProfileType.instance=this},WebInspector.CPUProfileType.TypeId="CPU",WebInspector.CPUProfileType.prototype={fileExtension:function(){return".cpuprofile"},get buttonTooltip(){return this._recording?WebInspector.UIString("Stop CPU profiling."):WebInspector.UIString("Start CPU profiling.")},buttonClicked:function(){return this._recording?(this.stopRecordingProfile(),!1):(this.startRecordingProfile(),!0)},get treeItemTitle(){return WebInspector.UIString("CPU PROFILES")},get description(){return WebInspector.UIString("CPU profiles show where the execution time is spent in your page's JavaScript functions.")},addProfileHeader:function(e){this.addProfile(this.createProfile(e))},isRecordingProfile:function(){return this._recording},startRecordingProfile:function(){this._recording=!0,WebInspector.userMetrics.ProfilesCPUProfileTaken.record(),ProfilerAgent.start()},stopRecordingProfile:function(){this._recording=!1,ProfilerAgent.stop()},setRecordingProfile:function(e){this._recording=e},createTemporaryProfile:function(e){return e=e||WebInspector.UIString("Recording…"),new WebInspector.CPUProfileHeader(this,e)},createProfile:function(e){return new WebInspector.CPUProfileHeader(this,e.title,e.uid)},removeProfile:function(e){WebInspector.ProfileType.prototype.removeProfile.call(this,e),e.isTemporary||ProfilerAgent.removeProfile(this.id,e.uid)},_requestProfilesFromBackend:function(e){ProfilerAgent.getProfileHeaders(e)},resetProfiles:function(){this._reset()},addHeapSnapshotChunk:function(e,t){throw new Error("Never called")},finishHeapSnapshot:function(e){throw new Error("Never called")},reportHeapSnapshotProgress:function(e,t){throw new Error("Never called")},__proto__:WebInspector.ProfileType.prototype},WebInspector.CPUProfileHeader=function(e,t,n){WebInspector.ProfileHeader.call(this,e,t,n)},WebInspector.CPUProfileHeader.prototype={onTransferStarted:function(){this._jsonifiedProfile="",this.sidebarElement.subtitle=WebInspector.UIString("Loading… %s",Number.bytesToString(this._jsonifiedProfile.length))},onChunkTransferred:function(e){this.sidebarElement.subtitle=WebInspector.UIString("Loading… %d%",Number.bytesToString(this._jsonifiedProfile.length))},onTransferFinished:function(){this.sidebarElement.subtitle=WebInspector.UIString("Parsing…"),this._profile=JSON.parse(this._jsonifiedProfile),this._jsonifiedProfile=null,this.sidebarElement.subtitle=WebInspector.UIString("Loaded"),this.isTemporary=!1},onError:function(e,t){switch(t.target.error.code){case t.target.error.NOT_FOUND_ERR:this.sidebarElement.subtitle=WebInspector.UIString("'%s' not found.",e.fileName());break;case t.target.error.NOT_READABLE_ERR:this.sidebarElement.subtitle=WebInspector.UIString("'%s' is not readable",e.fileName());break;case t.target.error.ABORT_ERR:break;default:this.sidebarElement.subtitle=WebInspector.UIString("'%s' error %d",e.fileName(),t.target.error.code)}},write:function(e){this._jsonifiedProfile+=e},close:function(){},createSidebarTreeElement:function(){return new WebInspector.ProfileSidebarTreeElement(this,WebInspector.UIString("Profile %d"),"profile-sidebar-tree-item")},createView:function(e){return new WebInspector.CPUProfileView(this)},canSaveToFile:function(){return!0},saveToFile:function(){function t(t,n){if(t){e.close();return}if(!n.head){e.close();return}e.write(JSON.stringify(n),e.close.bind(e))}function n(){ProfilerAgent.getCPUProfile(this.uid,t.bind(this))}var e=new WebInspector.FileOutputStream;this._fileName=this._fileName||"CPU-"+(new Date).toISO8601Compact()+this._profileType.fileExtension(),e.open(this._fileName,n.bind(this))},loadFromFile:function(e){this.title=e.name,this.sidebarElement.subtitle=WebInspector.UIString("Loading…"),this.sidebarElement.wait=!0;var t=new WebInspector.ChunkedFileReader(e,1e7,this);t.start(this)},__proto__:WebInspector.ProfileHeader.prototype};