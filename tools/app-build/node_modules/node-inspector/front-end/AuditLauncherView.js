/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.AuditLauncherView=function(e){WebInspector.View.call(this),this._auditController=e,this._categoryIdPrefix="audit-category-item-",this._auditRunning=!1,this.element.addStyleClass("audit-launcher-view"),this.element.addStyleClass("panel-enabler-view"),this._contentElement=document.createElement("div"),this._contentElement.className="audit-launcher-view-content",this.element.appendChild(this._contentElement),this._boundCategoryClickListener=this._categoryClicked.bind(this),this._resetResourceCount(),this._sortedCategories=[],this._headerElement=document.createElement("h1"),this._headerElement.className="no-audits",this._headerElement.textContent=WebInspector.UIString("No audits to run"),this._contentElement.appendChild(this._headerElement),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.RequestStarted,this._onRequestStarted,this),WebInspector.networkManager.addEventListener(WebInspector.NetworkManager.EventTypes.RequestFinished,this._onRequestFinished,this);var t={};t[WebInspector.AuditLauncherView.AllCategoriesKey]=!0,this._selectedCategoriesSetting=WebInspector.settings.createSetting("selectedAuditCategories",t)},WebInspector.AuditLauncherView.AllCategoriesKey="__AllCategories",WebInspector.AuditLauncherView.prototype={_resetResourceCount:function(){this._loadedResources=0,this._totalResources=0},_onRequestStarted:function(e){var t=e.data;if(t.type===WebInspector.resourceTypes.WebSocket)return;++this._totalResources,this._updateResourceProgress()},_onRequestFinished:function(e){var t=e.data;if(t.type===WebInspector.resourceTypes.WebSocket)return;++this._loadedResources,this._updateResourceProgress()},addCategory:function(e){function r(e,t){var n=e.displayName||"",r=t.displayName||"";return n.localeCompare(r)}this._sortedCategories.length||this._createLauncherUI();var t=this._selectedCategoriesSetting.get(),n=this._createCategoryElement(e.displayName,e.id);e._checkboxElement=n.firstChild;if(this._selectAllCheckboxElement.checked||t[e.displayName])e._checkboxElement.checked=!0,++this._currentCategoriesCount;var i=insertionIndexForObjectInListSortedByFunction(e,this._sortedCategories,r);this._categoriesElement.insertBefore(n,this._categoriesElement.children[i]),this._sortedCategories.splice(i,0,e),this._selectedCategoriesUpdated()},_setAuditRunning:function(e){if(this._auditRunning===e)return;this._auditRunning=e,this._updateButton(),this._toggleUIComponents(this._auditRunning),this._auditRunning?this._startAudit():this._stopAudit()},_startAudit:function(){function n(){this._displayResourceLoadingProgress=!1}var e=[];for(var t=0;t<this._sortedCategories.length;++t)this._sortedCategories[t]._checkboxElement.checked&&e.push(this._sortedCategories[t].id);this._resetResourceCount(),this._progressIndicator=new WebInspector.ProgressIndicator,this._buttonContainerElement.appendChild(this._progressIndicator.element),this._displayResourceLoadingProgress=!0,this._auditController.initiateAudit(e,this._progressIndicator,this._auditPresentStateElement.checked,n.bind(this),this._setAuditRunning.bind(this,!1))},_stopAudit:function(){this._displayResourceLoadingProgress=!1,this._progressIndicator.cancel(),this._progressIndicator.done(),delete this._progressIndicator},_toggleUIComponents:function(e){this._selectAllCheckboxElement.disabled=e,this._categoriesElement.disabled=e,this._auditPresentStateElement.disabled=e,this._auditReloadedStateElement.disabled=e},_launchButtonClicked:function(e){this._setAuditRunning(!this._auditRunning)},_selectAllClicked:function(e,t){var n=this._categoriesElement.childNodes;for(var r=0,i=n.length;r<i;++r)n[r].firstChild.checked=e;this._currentCategoriesCount=e?this._sortedCategories.length:0,this._selectedCategoriesUpdated(t)},_categoryClicked:function(e){this._currentCategoriesCount+=e.target.checked?1:-1,this._selectAllCheckboxElement.checked=this._currentCategoriesCount===this._sortedCategories.length,this._selectedCategoriesUpdated(!0)},_createCategoryElement:function(e,t){var n=document.createElement("label");n.id=this._categoryIdPrefix+t;var r=document.createElement("input");return r.type="checkbox",t!==""&&r.addEventListener("click",this._boundCategoryClickListener,!1),n.appendChild(r),n.appendChild(document.createTextNode(e)),n.__displayName=e,n},_createLauncherUI:function(){function t(e){this._selectAllClicked(e.target.checked,!0)}this._headerElement=document.createElement("h1"),this._headerElement.textContent=WebInspector.UIString("Select audits to run");for(var e=0;e<this._contentElement.children.length;++e)this._contentElement.removeChild(this._contentElement.children[e]);this._contentElement.appendChild(this._headerElement);var n=this._createCategoryElement(WebInspector.UIString("Select All"),"");n.id="audit-launcher-selectall",this._selectAllCheckboxElement=n.firstChild,this._selectAllCheckboxElement.checked=this._selectedCategoriesSetting.get()[WebInspector.AuditLauncherView.AllCategoriesKey],this._selectAllCheckboxElement.addEventListener("click",t.bind(this),!1),this._contentElement.appendChild(n),this._categoriesElement=this._contentElement.createChild("fieldset","audit-categories-container"),this._currentCategoriesCount=0,this._contentElement.createChild("div","flexible-space"),this._buttonContainerElement=this._contentElement.createChild("div","button-container");var r=this._buttonContainerElement.createChild("label");this._auditPresentStateElement=r.createChild("input"),this._auditPresentStateElement.name="audit-mode",this._auditPresentStateElement.type="radio",this._auditPresentStateElement.checked=!0,this._auditPresentStateLabelElement=document.createTextNode(WebInspector.UIString("Audit Present State")),r.appendChild(this._auditPresentStateLabelElement),r=this._buttonContainerElement.createChild("label"),this._auditReloadedStateElement=r.createChild("input"),this._auditReloadedStateElement.name="audit-mode",this._auditReloadedStateElement.type="radio",r.appendChild(document.createTextNode("Reload Page and Audit on Load")),this._launchButton=this._buttonContainerElement.createChild("button"),this._launchButton.textContent=WebInspector.UIString("Run"),this._launchButton.addEventListener("click",this._launchButtonClicked.bind(this),!1),this._selectAllClicked(this._selectAllCheckboxElement.checked)},_updateResourceProgress:function(){this._displayResourceLoadingProgress&&this._progressIndicator.setTitle(WebInspector.UIString("Loading (%d of %d)",this._loadedResources,this._totalResources))},_selectedCategoriesUpdated:function(e){var t=e?{}:this._selectedCategoriesSetting.get(),n=this._categoriesElement.childNodes;for(var r=0,i=n.length;r<i;++r)t[n[r].__displayName]=n[r].firstChild.checked;t[WebInspector.AuditLauncherView.AllCategoriesKey]=this._selectAllCheckboxElement.checked,this._selectedCategoriesSetting.set(t),this._updateButton()},_updateButton:function(){this._launchButton.textContent=this._auditRunning?WebInspector.UIString("Stop"):WebInspector.UIString("Run"),this._launchButton.disabled=!this._currentCategoriesCount},__proto__:WebInspector.View.prototype};