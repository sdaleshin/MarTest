/*
 * Copyright (C) 2009 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CookieItemsView=function(e,t){WebInspector.View.call(this),this.element.addStyleClass("storage-view"),this._deleteButton=new WebInspector.StatusBarButton(WebInspector.UIString("Delete"),"delete-storage-status-bar-item"),this._deleteButton.visible=!1,this._deleteButton.addEventListener("click",this._deleteButtonClicked,this),this._clearButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear"),"clear-storage-status-bar-item"),this._clearButton.visible=!1,this._clearButton.addEventListener("click",this._clearButtonClicked,this),this._refreshButton=new WebInspector.StatusBarButton(WebInspector.UIString("Refresh"),"refresh-storage-status-bar-item"),this._refreshButton.addEventListener("click",this._refreshButtonClicked,this),this._treeElement=e,this._cookieDomain=t,this._emptyView=new WebInspector.EmptyView(WebInspector.UIString("This site has no cookies.")),this._emptyView.show(this.element),this.element.addEventListener("contextmenu",this._contextMenu.bind(this),!0)},WebInspector.CookieItemsView.prototype={get statusBarItems(){return[this._refreshButton.element,this._clearButton.element,this._deleteButton.element]},wasShown:function(){this._update()},willHide:function(){this._deleteButton.visible=!1},_update:function(){WebInspector.Cookies.getCookiesAsync(this._updateWithCookies.bind(this))},_updateWithCookies:function(e){this._cookies=this._filterCookiesForDomain(e);if(!this._cookies.length){this._emptyView.show(this.element),this._clearButton.visible=!1,this._deleteButton.visible=!1,this._cookiesTable&&this._cookiesTable.detach();return}this._cookiesTable||(this._cookiesTable=new WebInspector.CookiesTable(!1,this._update.bind(this),this._showDeleteButton.bind(this))),this._cookiesTable.setCookies(this._cookies),this._emptyView.detach(),this._cookiesTable.show(this.element),this._treeElement.subtitle=String.sprintf(WebInspector.UIString("%d cookies (%s)"),this._cookies.length,Number.bytesToString(this._totalSize)),this._clearButton.visible=!0,this._deleteButton.visible=!!this._cookiesTable.selectedCookie()},_filterCookiesForDomain:function(e){function r(e){var t=e.documentURL.asParsedURL();t&&t.host==this._cookieDomain&&n.push(e.url)}var t=[],n=[];this._totalSize=0,WebInspector.forAllResources(r.bind(this));for(var i=0;i<e.length;++i){var s=!1,o=e[i].size();for(var u=0;u<n.length;++u){var a=n[u];WebInspector.Cookies.cookieMatchesResourceURL(e[i],a)&&(this._totalSize+=o,s||(s=!0,t.push(e[i])))}}return t},clear:function(){this._cookiesTable.clear(),this._update()},_clearButtonClicked:function(){this.clear()},_showDeleteButton:function(){this._deleteButton.visible=!0},_deleteButtonClicked:function(){var e=this._cookiesTable.selectedCookie();e&&(e.remove(),this._update())},_refreshButtonClicked:function(e){this._update()},_contextMenu:function(e){if(!this._cookies.length){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString("Refresh"),this._update.bind(this)),t.show()}},__proto__:WebInspector.View.prototype};