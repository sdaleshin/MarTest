/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.JavaScriptBreakpointsSidebarPane=function(e,t){WebInspector.SidebarPane.call(this,WebInspector.UIString("Breakpoints")),this.registerRequiredCSS("breakpointsList.css"),this._breakpointManager=e,this._showSourceLineDelegate=t,this.listElement=document.createElement("ol"),this.listElement.className="breakpoint-list",this.emptyElement=document.createElement("div"),this.emptyElement.className="info",this.emptyElement.textContent=WebInspector.UIString("No Breakpoints"),this.bodyElement.appendChild(this.emptyElement),this._items=new Map;var n=this._breakpointManager.allBreakpointLocations();for(var r=0;r<n.length;++r)this._addBreakpoint(n[r].breakpoint,n[r].uiLocation);this._breakpointManager.addEventListener(WebInspector.BreakpointManager.Events.BreakpointAdded,this._breakpointAdded,this),this._breakpointManager.addEventListener(WebInspector.BreakpointManager.Events.BreakpointRemoved,this._breakpointRemoved,this),this.emptyElement.addEventListener("contextmenu",this._emptyElementContextMenu.bind(this),!0)},WebInspector.JavaScriptBreakpointsSidebarPane.prototype={_emptyElementContextMenu:function(e){var t=new WebInspector.ContextMenu(e),n=WebInspector.debuggerModel.breakpointsActive(),r=n?WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Deactivate breakpoints":"Deactivate Breakpoints"):WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Activate breakpoints":"Activate Breakpoints");t.appendItem(r,WebInspector.debuggerModel.setBreakpointsActive.bind(WebInspector.debuggerModel,!n)),t.show()},_breakpointAdded:function(e){this._breakpointRemoved(e);var t=e.data.breakpoint,n=e.data.uiLocation;this._addBreakpoint(t,n)},_addBreakpoint:function(e,t){function o(e,n,r){var i=e.lineEndings();t.lineNumber<i.length&&(s.textContent=e.substring(i[t.lineNumber-1],i[t.lineNumber]))}var n=document.createElement("li");n.addStyleClass("cursor-pointer"),n.addEventListener("contextmenu",this._breakpointContextMenu.bind(this,e),!0),n.addEventListener("click",this._breakpointClicked.bind(this,t),!1);var r=document.createElement("input");r.className="checkbox-elem",r.type="checkbox",r.checked=e.enabled(),r.addEventListener("click",this._breakpointCheckboxClicked.bind(this,e),!1),n.appendChild(r);var i=document.createTextNode(t.linkText());n.appendChild(i);var s=document.createElement("div");s.className="source-text monospace",n.appendChild(s),t.uiSourceCode.requestContent(o.bind(this)),n._data=t;var u=this.listElement.firstChild;while(u){if(u._data&&this._compareBreakpoints(u._data,n._data)>0)break;u=u.nextSibling}this._addListElement(n,u);var a={};a.element=n,a.checkbox=r,this._items.put(e,a),this.expand()},_breakpointRemoved:function(e){var t=e.data.breakpoint,n=e.data.uiLocation,r=this._items.get(t);if(!r)return;this._items.remove(t),this._removeListElement(r.element)},highlightBreakpoint:function(e){var t=this._items.get(e);if(!t)return;t.element.addStyleClass("breakpoint-hit"),this._highlightedBreakpointItem=t},clearBreakpointHighlight:function(){this._highlightedBreakpointItem&&(this._highlightedBreakpointItem.element.removeStyleClass("breakpoint-hit"),delete this._highlightedBreakpointItem)},_breakpointClicked:function(e,t){this._showSourceLineDelegate(e.uiSourceCode,e.lineNumber)},_breakpointCheckboxClicked:function(e,t){t.consume(),e.setEnabled(t.target.checked)},_breakpointContextMenu:function(e,t){function u(e){var t=0;for(var n=0;n<e.length;++n)e[n].checkbox.checked&&t++;return t}var n=this._items.values(),r=new WebInspector.ContextMenu(t);r.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove breakpoint":"Remove Breakpoint"),e.remove.bind(e));if(n.length>1){var i=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove all breakpoints":"Remove All Breakpoints");r.appendItem(i,this._breakpointManager.removeAllBreakpoints.bind(this._breakpointManager))}r.appendSeparator();var s=WebInspector.debuggerModel.breakpointsActive(),o=s?WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Deactivate breakpoints":"Deactivate Breakpoints"):WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Activate breakpoints":"Activate Breakpoints");r.appendItem(o,WebInspector.debuggerModel.setBreakpointsActive.bind(WebInspector.debuggerModel,!s));if(n.length>1){var a=u(n),f=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Enable all breakpoints":"Enable All Breakpoints"),l=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Disable all breakpoints":"Disable All Breakpoints");r.appendSeparator(),r.appendItem(f,this._breakpointManager.toggleAllBreakpoints.bind(this._breakpointManager,!0),a==n.length),r.appendItem(l,this._breakpointManager.toggleAllBreakpoints.bind(this._breakpointManager,!1),!(a>1))}r.show()},_addListElement:function(e,t){t?this.listElement.insertBefore(e,t):(this.listElement.firstChild||(this.bodyElement.removeChild(this.emptyElement),this.bodyElement.appendChild(this.listElement)),this.listElement.appendChild(e))},_removeListElement:function(e){this.listElement.removeChild(e),this.listElement.firstChild||(this.bodyElement.removeChild(this.listElement),this.bodyElement.appendChild(this.emptyElement))},_compare:function(e,t){return e!==t?e<t?-1:1:0},_compareBreakpoints:function(e,t){return this._compare(e.uiSourceCode.originURL(),t.uiSourceCode.originURL())||this._compare(e.lineNumber,t.lineNumber)},reset:function(){this.listElement.removeChildren(),this.listElement.parentElement&&(this.bodyElement.removeChild(this.listElement),this.bodyElement.appendChild(this.emptyElement)),this._items.clear()},__proto__:WebInspector.SidebarPane.prototype},WebInspector.XHRBreakpointsSidebarPane=function(){WebInspector.NativeBreakpointsSidebarPane.call(this,WebInspector.UIString("XHR Breakpoints")),this._breakpointElements={};var e=document.createElement("button");e.className="pane-title-button add",e.addEventListener("click",this._addButtonClicked.bind(this),!1),e.title=WebInspector.UIString("Add XHR breakpoint"),this.titleElement.appendChild(e),this.emptyElement.addEventListener("contextmenu",this._emptyElementContextMenu.bind(this),!0),this._restoreBreakpoints()},WebInspector.XHRBreakpointsSidebarPane.prototype={_emptyElementContextMenu:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add breakpoint":"Add Breakpoint"),this._addButtonClicked.bind(this)),t.show()},_addButtonClicked:function(e){function r(e,n,r){this._removeListElement(t),e&&(this._setBreakpoint(r,!0),this._saveBreakpoints())}e&&e.consume(),this.expand();var t=document.createElement("p");t.className="breakpoint-condition";var n=document.createElement("span");t.textContent=WebInspector.UIString("Break when URL contains:"),n.className="editing",n.id="breakpoint-condition-input",t.appendChild(n),this._addListElement(t,this.listElement.firstChild);var i=new WebInspector.EditingConfig(r.bind(this,!0),r.bind(this,!1));WebInspector.startEditing(n,i)},_setBreakpoint:function(e,t){if(e in this._breakpointElements)return;var n=document.createElement("li");n._url=e,n.addEventListener("contextmenu",this._contextMenu.bind(this,e),!0);var r=document.createElement("input");r.className="checkbox-elem",r.type="checkbox",r.checked=t,r.addEventListener("click",this._checkboxClicked.bind(this,e),!1),n._checkboxElement=r,n.appendChild(r);var i=document.createElement("span");e?i.textContent=WebInspector.UIString('URL contains "%s"',e):i.textContent=WebInspector.UIString("Any XHR"),i.addStyleClass("cursor-auto"),i.addEventListener("dblclick",this._labelClicked.bind(this,e),!1),n.appendChild(i);var s=this.listElement.firstChild;while(s){if(s._url&&s._url<n._url)break;s=s.nextSibling}this._addListElement(n,s),this._breakpointElements[e]=n,t&&DOMDebuggerAgent.setXHRBreakpoint(e)},_removeBreakpoint:function(e){var t=this._breakpointElements[e];if(!t)return;this._removeListElement(t),delete this._breakpointElements[e],t._checkboxElement.checked&&DOMDebuggerAgent.removeXHRBreakpoint(e)},_contextMenu:function(e,t){function r(){this._removeBreakpoint(e),this._saveBreakpoints()}function i(){for(var e in this._breakpointElements)this._removeBreakpoint(e);this._saveBreakpoints()}var n=new WebInspector.ContextMenu(t),s=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove all breakpoints":"Remove All Breakpoints");n.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add breakpoint":"Add Breakpoint"),this._addButtonClicked.bind(this)),n.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove breakpoint":"Remove Breakpoint"),r.bind(this)),n.appendItem(s,i.bind(this)),n.show()},_checkboxClicked:function(e,t){t.target.checked?DOMDebuggerAgent.setXHRBreakpoint(e):DOMDebuggerAgent.removeXHRBreakpoint(e),this._saveBreakpoints()},_labelClicked:function(e){function r(r,i,s){this._removeListElement(n),r?(this._removeBreakpoint(e),this._setBreakpoint(s,t._checkboxElement.checked),this._saveBreakpoints()):t.removeStyleClass("hidden")}var t=this._breakpointElements[e],n=document.createElement("span");n.className="breakpoint-condition editing",n.textContent=e,this.listElement.insertBefore(n,t),t.addStyleClass("hidden"),WebInspector.startEditing(n,new WebInspector.EditingConfig(r.bind(this,!0),r.bind(this,!1)))},highlightBreakpoint:function(e){var t=this._breakpointElements[e];if(!t)return;this.expand(),t.addStyleClass("breakpoint-hit"),this._highlightedElement=t},clearBreakpointHighlight:function(){this._highlightedElement&&(this._highlightedElement.removeStyleClass("breakpoint-hit"),delete this._highlightedElement)},_saveBreakpoints:function(){var e=[];for(var t in this._breakpointElements)e.push({url:t,enabled:this._breakpointElements[t]._checkboxElement.checked});WebInspector.settings.xhrBreakpoints.set(e)},_restoreBreakpoints:function(){var e=WebInspector.settings.xhrBreakpoints.get();for(var t=0;t<e.length;++t){var n=e[t];n&&typeof n.url=="string"&&this._setBreakpoint(n.url,n.enabled)}},__proto__:WebInspector.NativeBreakpointsSidebarPane.prototype},WebInspector.EventListenerBreakpointsSidebarPane=function(){WebInspector.SidebarPane.call(this,WebInspector.UIString("Event Listener Breakpoints")),this.registerRequiredCSS("breakpointsList.css"),this.categoriesElement=document.createElement("ol"),this.categoriesElement.tabIndex=0,this.categoriesElement.addStyleClass("properties-tree"),this.categoriesElement.addStyleClass("event-listener-breakpoints"),this.categoriesTreeOutline=new TreeOutline(this.categoriesElement),this.bodyElement.appendChild(this.categoriesElement),this._breakpointItems={},this._createCategory(WebInspector.UIString("Animation"),!1,["requestAnimationFrame","cancelAnimationFrame","animationFrameFired"]),this._createCategory(WebInspector.UIString("Control"),!0,["resize","scroll","zoom","focus","blur","select","change","submit","reset"]),this._createCategory(WebInspector.UIString("Clipboard"),!0,["copy","cut","paste","beforecopy","beforecut","beforepaste"]),this._createCategory(WebInspector.UIString("DOM Mutation"),!0,["DOMActivate","DOMFocusIn","DOMFocusOut","DOMAttrModified","DOMCharacterDataModified","DOMNodeInserted","DOMNodeInsertedIntoDocument","DOMNodeRemoved","DOMNodeRemovedFromDocument","DOMSubtreeModified","DOMContentLoaded"]),this._createCategory(WebInspector.UIString("Device"),!0,["deviceorientation","devicemotion"]),this._createCategory(WebInspector.UIString("Keyboard"),!0,["keydown","keyup","keypress","input"]),this._createCategory(WebInspector.UIString("Load"),!0,["load","unload","abort","error","hashchange"]),this._createCategory(WebInspector.UIString("Mouse"),!0,["click","dblclick","mousedown","mouseup","mouseover","mousemove","mouseout","mousewheel"]),this._createCategory(WebInspector.UIString("Timer"),!1,["setTimer","clearTimer","timerFired"]),this._createCategory(WebInspector.UIString("Touch"),!0,["touchstart","touchmove","touchend","touchcancel"]),this._createCategory(WebInspector.UIString("WebGL"),!1,["webglErrorFired","webglWarningFired"]),this._restoreBreakpoints()},WebInspector.EventListenerBreakpointsSidebarPane.categotyListener="listener:",WebInspector.EventListenerBreakpointsSidebarPane.categotyInstrumentation="instrumentation:",WebInspector.EventListenerBreakpointsSidebarPane.eventNameForUI=function(e,t){WebInspector.EventListenerBreakpointsSidebarPane._eventNamesForUI||(WebInspector.EventListenerBreakpointsSidebarPane._eventNamesForUI={"instrumentation:setTimer":WebInspector.UIString("Set Timer"),"instrumentation:clearTimer":WebInspector.UIString("Clear Timer"),"instrumentation:timerFired":WebInspector.UIString("Timer Fired"),"instrumentation:requestAnimationFrame":WebInspector.UIString("Request Animation Frame"),"instrumentation:cancelAnimationFrame":WebInspector.UIString("Cancel Animation Frame"),"instrumentation:animationFrameFired":WebInspector.UIString("Animation Frame Fired"),"instrumentation:webglErrorFired":WebInspector.UIString("WebGL Error Fired"),"instrumentation:webglWarningFired":WebInspector.UIString("WebGL Warning Fired")});if(t&&e==="instrumentation:webglErrorFired"&&t.webglErrorName){var n=t.webglErrorName;return n=n.replace(/^.*(0x[0-9a-f]+).*$/i,"$1"),WebInspector.UIString("WebGL Error Fired (%s)",n)}return WebInspector.EventListenerBreakpointsSidebarPane._eventNamesForUI[e]||e.substring(e.indexOf(":")+1)},WebInspector.EventListenerBreakpointsSidebarPane.prototype={_createCategory:function(e,t,n){var r={};r.element=new TreeElement(e),this.categoriesTreeOutline.appendChild(r.element),r.element.listItemElement.addStyleClass("event-category"),r.element.selectable=!0,r.checkbox=this._createCheckbox(r.element),r.checkbox.addEventListener("click",this._categoryCheckboxClicked.bind(this,r),!0),r.children={};for(var i=0;i<n.length;++i){var s=(t?WebInspector.EventListenerBreakpointsSidebarPane.categotyListener:WebInspector.EventListenerBreakpointsSidebarPane.categotyInstrumentation)+n[i],o={},u=WebInspector.EventListenerBreakpointsSidebarPane.eventNameForUI(s);o.element=new TreeElement(u),r.element.appendChild(o.element);var a=document.createElement("div");a.className="breakpoint-hit-marker",o.element.listItemElement.appendChild(a),o.element.listItemElement.addStyleClass("source-code"),o.element.selectable=!1,o.checkbox=this._createCheckbox(o.element),o.checkbox.addEventListener("click",this._breakpointCheckboxClicked.bind(this,s),!0),o.parent=r,this._breakpointItems[s]=o,r.children[s]=o}},_createCheckbox:function(e){var t=document.createElement("input");return t.className="checkbox-elem",t.type="checkbox",e.listItemElement.insertBefore(t,e.listItemElement.firstChild),t},_categoryCheckboxClicked:function(e){var t=e.checkbox.checked;for(var n in e.children){var r=e.children[n];if(r.checkbox.checked===t)continue;t?this._setBreakpoint(n):this._removeBreakpoint(n)}this._saveBreakpoints()},_breakpointCheckboxClicked:function(e,t){t.target.checked?this._setBreakpoint(e):this._removeBreakpoint(e),this._saveBreakpoints()},_setBreakpoint:function(e){var t=this._breakpointItems[e];if(!t)return;t.checkbox.checked=!0,e.startsWith(WebInspector.EventListenerBreakpointsSidebarPane.categotyListener)?DOMDebuggerAgent.setEventListenerBreakpoint(e.substring(WebInspector.EventListenerBreakpointsSidebarPane.categotyListener.length)):e.startsWith(WebInspector.EventListenerBreakpointsSidebarPane.categotyInstrumentation)&&DOMDebuggerAgent.setInstrumentationBreakpoint(e.substring(WebInspector.EventListenerBreakpointsSidebarPane.categotyInstrumentation.length)),this._updateCategoryCheckbox(t.parent)},_removeBreakpoint:function(e){var t=this._breakpointItems[e];if(!t)return;t.checkbox.checked=!1,e.startsWith(WebInspector.EventListenerBreakpointsSidebarPane.categotyListener)?DOMDebuggerAgent.removeEventListenerBreakpoint(e.substring(WebInspector.EventListenerBreakpointsSidebarPane.categotyListener.length)):e.startsWith(WebInspector.EventListenerBreakpointsSidebarPane.categotyInstrumentation)&&DOMDebuggerAgent.removeInstrumentationBreakpoint(e.substring(WebInspector.EventListenerBreakpointsSidebarPane.categotyInstrumentation.length)),this._updateCategoryCheckbox(t.parent)},_updateCategoryCheckbox:function(e){var t=!1,n=!1;for(var r in e.children){var i=e.children[r];i.checkbox.checked?t=!0:n=!0}e.checkbox.checked=t,e.checkbox.indeterminate=t&&n},highlightBreakpoint:function(e){var t=this._breakpointItems[e];if(!t)return;this.expand(),t.parent.element.expand(),t.element.listItemElement.addStyleClass("breakpoint-hit"),this._highlightedElement=t.element.listItemElement},clearBreakpointHighlight:function(){this._highlightedElement&&(this._highlightedElement.removeStyleClass("breakpoint-hit"),delete this._highlightedElement)},_saveBreakpoints:function(){var e=[];for(var t in this._breakpointItems)this._breakpointItems[t].checkbox.checked&&e.push({eventName:t});WebInspector.settings.eventListenerBreakpoints.set(e)},_restoreBreakpoints:function(){var e=WebInspector.settings.eventListenerBreakpoints.get();for(var t=0;t<e.length;++t){var n=e[t];n&&typeof n.eventName=="string"&&this._setBreakpoint(n.eventName)}},__proto__:WebInspector.SidebarPane.prototype};