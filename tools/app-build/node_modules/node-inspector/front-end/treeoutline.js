/*
 * Copyright (C) 2007 Apple Inc.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

function TreeOutline(e,t){this.children=[],this.selectedTreeElement=null,this._childrenListNode=e,this.childrenListElement=this._childrenListNode,this._childrenListNode.removeChildren(),this.expandTreeElementsWhenArrowing=!1,this.root=!0,this.hasChildren=!1,this.expanded=!0,this.selected=!1,this.treeOutline=this,this.comparator=null,this.setFocusable(!t),this._childrenListNode.addEventListener("keydown",this._treeKeyDown.bind(this),!0),this._treeElementsMap=new Map,this._expandedStateMap=new Map}function TreeElement(e,t,n){this._title=e,this.representedObject=t||{},this._hidden=!1,this._selectable=!0,this.expanded=!1,this.selected=!1,this.hasChildren=n,this.children=[],this.treeOutline=null,this.parent=null,this.previousSibling=null,this.nextSibling=null,this._listItemNode=null}TreeOutline.prototype.setFocusable=function(e){e?this._childrenListNode.setAttribute("tabIndex",0):this._childrenListNode.removeAttribute("tabIndex")},TreeOutline.prototype.appendChild=function(e){var t;this.treeOutline.comparator?t=insertionIndexForObjectInListSortedByFunction(e,this.children,this.treeOutline.comparator):t=this.children.length,this.insertChild(e,t)},TreeOutline.prototype.insertBeforeChild=function(e,t){if(!e)throw"child can't be undefined or null";if(!t)throw"beforeChild can't be undefined or null";var n=this.children.indexOf(t);if(n===-1)throw"beforeChild not found in this node's children";this.insertChild(e,n)},TreeOutline.prototype.insertChild=function(e,t){if(!e)throw"child can't be undefined or null";var n=t>0?this.children[t-1]:null;n?(n.nextSibling=e,e.previousSibling=n):e.previousSibling=null;var r=this.children[t];r?(r.previousSibling=e,e.nextSibling=r):e.nextSibling=null,this.children.splice(t,0,e),this.hasChildren=!0,e.parent=this,e.treeOutline=this.treeOutline,e.treeOutline._rememberTreeElement(e);var i=e.children[0];while(i)i.treeOutline=this.treeOutline,i.treeOutline._rememberTreeElement(i),i=i.traverseNextTreeElement(!1,e,!0);e.hasChildren&&typeof e.treeOutline._expandedStateMap.get(e.representedObject)!="undefined"&&(e.expanded=e.treeOutline._expandedStateMap.get(e.representedObject)),this._childrenListNode||(this._childrenListNode=this.treeOutline._childrenListNode.ownerDocument.createElement("ol"),this._childrenListNode.parentTreeElement=this,this._childrenListNode.classList.add("children"),this.hidden&&this._childrenListNode.classList.add("hidden")),e._attach()},TreeOutline.prototype.removeChildAtIndex=function(e){if(e<0||e>=this.children.length)throw"childIndex out of range";var t=this.children[e];this.children.splice(e,1);var n=t.parent;t.deselect()&&(t.previousSibling?t.previousSibling.select():t.nextSibling?t.nextSibling.select():n.select()),t.previousSibling&&(t.previousSibling.nextSibling=t.nextSibling),t.nextSibling&&(t.nextSibling.previousSibling=t.previousSibling),t.treeOutline&&(t.treeOutline._forgetTreeElement(t),t.treeOutline._forgetChildrenRecursive(t)),t._detach(),t.treeOutline=null,t.parent=null,t.nextSibling=null,t.previousSibling=null},TreeOutline.prototype.removeChild=function(e){if(!e)throw"child can't be undefined or null";var t=this.children.indexOf(e);if(t===-1)throw"child not found in this node's children";this.removeChildAtIndex.call(this,t)},TreeOutline.prototype.removeChildren=function(){for(var e=0;e<this.children.length;++e){var t=this.children[e];t.deselect(),t.treeOutline&&(t.treeOutline._forgetTreeElement(t),t.treeOutline._forgetChildrenRecursive(t)),t._detach(),t.treeOutline=null,t.parent=null,t.nextSibling=null,t.previousSibling=null}this.children=[]},TreeOutline.prototype._rememberTreeElement=function(e){this._treeElementsMap.get(e.representedObject)||this._treeElementsMap.put(e.representedObject,[]);var t=this._treeElementsMap.get(e.representedObject);if(t.indexOf(e)!==-1)return;t.push(e)},TreeOutline.prototype._forgetTreeElement=function(e){if(this._treeElementsMap.get(e.representedObject)){var t=this._treeElementsMap.get(e.representedObject);t.remove(e,!0),t.length||this._treeElementsMap.remove(e.representedObject)}},TreeOutline.prototype._forgetChildrenRecursive=function(e){var t=e.children[0];while(t)this._forgetTreeElement(t),t=t.traverseNextTreeElement(!1,e,!0)},TreeOutline.prototype.getCachedTreeElement=function(e){if(!e)return null;var t=this._treeElementsMap.get(e);return t&&t.length?t[0]:null},TreeOutline.prototype.findTreeElement=function(e,t,n){if(!e)return null;var r=this.getCachedTreeElement(e);if(r)return r;var i=[];for(var s=n(e);s;s=n(s)){i.push(s);if(this.getCachedTreeElement(s))break}if(!s)return null;for(var o=i.length-1;o>=0;--o){var u=this.getCachedTreeElement(i[o]);u&&u.onpopulate()}return this.getCachedTreeElement(e)},TreeOutline.prototype.treeElementFromPoint=function(e,t){var n=this._childrenListNode.ownerDocument.elementFromPoint(e,t);if(!n)return null;var r=n.enclosingNodeOrSelfWithNodeNameInArray(["ol","li"]);return r?r.parentTreeElement||r.treeElement:null},TreeOutline.prototype._treeKeyDown=function(e){if(e.target!==this._childrenListNode)return;if(!this.selectedTreeElement||e.shiftKey||e.metaKey||e.ctrlKey)return;var t=!1,n;if(e.keyIdentifier==="Up"&&!e.altKey){n=this.selectedTreeElement.traversePreviousTreeElement(!0);while(n&&!n.selectable)n=n.traversePreviousTreeElement(!this.expandTreeElementsWhenArrowing);t=n?!0:!1}else if(e.keyIdentifier==="Down"&&!e.altKey){n=this.selectedTreeElement.traverseNextTreeElement(!0);while(n&&!n.selectable)n=n.traverseNextTreeElement(!this.expandTreeElementsWhenArrowing);t=n?!0:!1}else if(e.keyIdentifier==="Left"){if(this.selectedTreeElement.expanded)e.altKey?this.selectedTreeElement.collapseRecursively():this.selectedTreeElement.collapse(),t=!0;else if(this.selectedTreeElement.parent&&!this.selectedTreeElement.parent.root){t=!0;if(this.selectedTreeElement.parent.selectable){n=this.selectedTreeElement.parent;while(n&&!n.selectable)n=n.parent;t=n?!0:!1}else this.selectedTreeElement.parent&&this.selectedTreeElement.parent.collapse()}}else if(e.keyIdentifier==="Right"){if(!this.selectedTreeElement.revealed())this.selectedTreeElement.reveal(),t=!0;else if(this.selectedTreeElement.hasChildren){t=!0;if(this.selectedTreeElement.expanded){n=this.selectedTreeElement.children[0];while(n&&!n.selectable)n=n.nextSibling;t=n?!0:!1}else e.altKey?this.selectedTreeElement.expandRecursively():this.selectedTreeElement.expand()}}else e.keyCode===8||e.keyCode===46?t=this.selectedTreeElement.ondelete():isEnterKey(e)?t=this.selectedTreeElement.onenter():e.keyCode===WebInspector.KeyboardShortcut.Keys.Space.code&&(t=this.selectedTreeElement.onspace());n&&(n.reveal(),n.select(!1,!0)),t&&e.consume(!0)},TreeOutline.prototype.expand=function(){},TreeOutline.prototype.collapse=function(){},TreeOutline.prototype.revealed=function(){return!0},TreeOutline.prototype.reveal=function(){},TreeOutline.prototype.select=function(){},TreeOutline.prototype.revealAndSelect=function(e){},TreeElement.prototype={arrowToggleWidth:10,get selectable(){return this._hidden?!1:this._selectable},set selectable(e){this._selectable=e},get listItemElement(){return this._listItemNode},get childrenListElement(){return this._childrenListNode},get title(){return this._title},set title(e){this._title=e,this._setListItemNodeContent()},get tooltip(){return this._tooltip},set tooltip(e){this._tooltip=e,this._listItemNode&&(this._listItemNode.title=e?e:"")},get hasChildren(){return this._hasChildren},set hasChildren(e){if(this._hasChildren===e)return;this._hasChildren=e;if(!this._listItemNode)return;e?this._listItemNode.classList.add("parent"):(this._listItemNode.classList.remove("parent"),this.collapse())},get hidden(){return this._hidden},set hidden(e){if(this._hidden===e)return;this._hidden=e,e?(this._listItemNode&&this._listItemNode.classList.add("hidden"),this._childrenListNode&&this._childrenListNode.classList.add("hidden")):(this._listItemNode&&this._listItemNode.classList.remove("hidden"),this._childrenListNode&&this._childrenListNode.classList.remove("hidden"))},get shouldRefreshChildren(){return this._shouldRefreshChildren},set shouldRefreshChildren(e){this._shouldRefreshChildren=e,e&&this.expanded&&this.expand()},_setListItemNodeContent:function(){if(!this._listItemNode)return;typeof this._title=="string"?this._listItemNode.textContent=this._title:(this._listItemNode.removeChildren(),this._title&&this._listItemNode.appendChild(this._title))}},TreeElement.prototype.appendChild=TreeOutline.prototype.appendChild,TreeElement.prototype.insertChild=TreeOutline.prototype.insertChild,TreeElement.prototype.insertBeforeChild=TreeOutline.prototype.insertBeforeChild,TreeElement.prototype.removeChild=TreeOutline.prototype.removeChild,TreeElement.prototype.removeChildAtIndex=TreeOutline.prototype.removeChildAtIndex,TreeElement.prototype.removeChildren=TreeOutline.prototype.removeChildren,TreeElement.prototype._attach=function(){if(!this._listItemNode||this.parent._shouldRefreshChildren)this._listItemNode&&this._listItemNode.parentNode&&this._listItemNode.parentNode.removeChild(this._listItemNode),this._listItemNode=this.treeOutline._childrenListNode.ownerDocument.createElement("li"),this._listItemNode.treeElement=this,this._setListItemNodeContent(),this._listItemNode.title=this._tooltip?this._tooltip:"",this.hidden&&this._listItemNode.classList.add("hidden"),this.hasChildren&&this._listItemNode.classList.add("parent"),this.expanded&&this._listItemNode.classList.add("expanded"),this.selected&&this._listItemNode.classList.add("selected"),this._listItemNode.addEventListener("mousedown",TreeElement.treeElementMouseDown,!1),this._listItemNode.addEventListener("click",TreeElement.treeElementToggled,!1),this._listItemNode.addEventListener("dblclick",TreeElement.treeElementDoubleClicked,!1),this.onattach();var e=null;this.nextSibling&&this.nextSibling._listItemNode&&this.nextSibling._listItemNode.parentNode===this.parent._childrenListNode&&(e=this.nextSibling._listItemNode),this.parent._childrenListNode.insertBefore(this._listItemNode,e),this._childrenListNode&&this.parent._childrenListNode.insertBefore(this._childrenListNode,this._listItemNode.nextSibling),this.selected&&this.select(),this.expanded&&this.expand()},TreeElement.prototype._detach=function(){this._listItemNode&&this._listItemNode.parentNode&&this._listItemNode.parentNode.removeChild(this._listItemNode),this._childrenListNode&&this._childrenListNode.parentNode&&this._childrenListNode.parentNode.removeChild(this._childrenListNode)},TreeElement.treeElementMouseDown=function(e){var t=e.currentTarget;if(!t||!t.treeElement||!t.treeElement.selectable)return;if(t.treeElement.isEventWithinDisclosureTriangle(e))return;t.treeElement.selectOnMouseDown(e)},TreeElement.treeElementToggled=function(e){var t=e.currentTarget;if(!t||!t.treeElement)return;var n=t.treeElement.toggleOnClick&&!t.treeElement.selectable,r=t.treeElement.isEventWithinDisclosureTriangle(e);if(!n&&!r)return;t.treeElement.expanded?e.altKey?t.treeElement.collapseRecursively():t.treeElement.collapse():e.altKey?t.treeElement.expandRecursively():t.treeElement.expand(),e.consume()},TreeElement.treeElementDoubleClicked=function(e){var t=e.currentTarget;if(!t||!t.treeElement)return;var n=t.treeElement.ondblclick.call(t.treeElement,e);if(n)return;t.treeElement.hasChildren&&!t.treeElement.expanded&&t.treeElement.expand()},TreeElement.prototype.collapse=function(){this._listItemNode&&this._listItemNode.classList.remove("expanded"),this._childrenListNode&&this._childrenListNode.classList.remove("expanded"),this.expanded=!1,this.treeOutline&&this.treeOutline._expandedStateMap.put(this.representedObject,!1),this.oncollapse()},TreeElement.prototype.collapseRecursively=function(){var e=this;while(e)e.expanded&&e.collapse(),e=e.traverseNextTreeElement(!1,this,!0)},TreeElement.prototype.expand=function(){if(!this.hasChildren||this.expanded&&!this._shouldRefreshChildren&&this._childrenListNode)return;this.expanded=!0,this.treeOutline&&this.treeOutline._expandedStateMap.put(this.representedObject,!0);if(this.treeOutline&&(!this._childrenListNode||this._shouldRefreshChildren)){this._childrenListNode&&this._childrenListNode.parentNode&&this._childrenListNode.parentNode.removeChild(this._childrenListNode),this._childrenListNode=this.treeOutline._childrenListNode.ownerDocument.createElement("ol"),this._childrenListNode.parentTreeElement=this,this._childrenListNode.classList.add("children"),this.hidden&&this._childrenListNode.classList.add("hidden"),this.onpopulate();for(var e=0;e<this.children.length;++e)this.children[e]._attach();delete this._shouldRefreshChildren}this._listItemNode&&(this._listItemNode.classList.add("expanded"),this._childrenListNode&&this._childrenListNode.parentNode!=this._listItemNode.parentNode&&this.parent._childrenListNode.insertBefore(this._childrenListNode,this._listItemNode.nextSibling)),this._childrenListNode&&this._childrenListNode.classList.add("expanded"),this.onexpand()},TreeElement.prototype.expandRecursively=function(e){var t=this,n={},r=0;isNaN(e)&&(e=3);while(t)r<e&&t.expand(),t=t.traverseNextTreeElement(!1,this,r>=e,n),r+=n.depthChange},TreeElement.prototype.hasAncestor=function(e){if(!e)return!1;var t=this.parent;while(t){if(e===t)return!0;t=t.parent}return!1},TreeElement.prototype.reveal=function(){var e=this.parent;while(e&&!e.root)e.expanded||e.expand(),e=e.parent;this.onreveal(this)},TreeElement.prototype.revealed=function(){var e=this.parent;while(e&&!e.root){if(!e.expanded)return!1;e=e.parent}return!0},TreeElement.prototype.selectOnMouseDown=function(e){this.select(!1,!0)&&e.consume(!0)},TreeElement.prototype.select=function(e,t){return!this.treeOutline||!this.selectable||this.selected?!1:(this.treeOutline.selectedTreeElement&&this.treeOutline.selectedTreeElement.deselect(),this.selected=!0,e||this.treeOutline._childrenListNode.focus(),this.treeOutline?(this.treeOutline.selectedTreeElement=this,this._listItemNode&&this._listItemNode.classList.add("selected"),this.onselect(t)):!1)},TreeElement.prototype.revealAndSelect=function(e){this.reveal(),this.select(e)},TreeElement.prototype.deselect=function(e){return!this.treeOutline||this.treeOutline.selectedTreeElement!==this||!this.selected?!1:(this.selected=!1,this.treeOutline.selectedTreeElement=null,this._listItemNode&&this._listItemNode.classList.remove("selected"),!0)},TreeElement.prototype.onpopulate=function(){},TreeElement.prototype.onenter=function(){},TreeElement.prototype.ondelete=function(){},TreeElement.prototype.onspace=function(){},TreeElement.prototype.onattach=function(){},TreeElement.prototype.onexpand=function(){},TreeElement.prototype.oncollapse=function(){},TreeElement.prototype.ondblclick=function(){},TreeElement.prototype.onreveal=function(){},TreeElement.prototype.onselect=function(e){},TreeElement.prototype.traverseNextTreeElement=function(e,t,n,r){!n&&this.hasChildren&&this.onpopulate(),r&&(r.depthChange=0);var i=e?this.revealed()?this.children[0]:null:this.children[0];if(i&&(!e||e&&this.expanded))return r&&(r.depthChange=1),i;if(this===t)return null;i=e?this.revealed()?this.nextSibling:null:this.nextSibling;if(i)return i;i=this;while(i&&!i.root&&!(e?i.revealed()?i.nextSibling:null:i.nextSibling)&&i.parent!==t)r&&(r.depthChange-=1),i=i.parent;return i?e?i.revealed()?i.nextSibling:null:i.nextSibling:null},TreeElement.prototype.traversePreviousTreeElement=function(e,t){var n=e?this.revealed()?this.previousSibling:null:this.previousSibling;!t&&n&&n.hasChildren&&n.onpopulate();while(n&&(e?n.revealed()&&n.expanded?n.children[n.children.length-1]:null:n.children[n.children.length-1]))!t&&n.hasChildren&&n.onpopulate(),n=e?n.revealed()&&n.expanded?n.children[n.children.length-1]:null:n.children[n.children.length-1];return n?n:!this.parent||this.parent.root?null:this.parent},TreeElement.prototype.isEventWithinDisclosureTriangle=function(e){var t=window.getComputedStyle(this._listItemNode).getPropertyCSSValue("padding-left"),n=t?t.getFloatValue(CSSPrimitiveValue.CSS_PX):0,r=this._listItemNode.totalOffsetLeft()+n;return e.pageX>=r&&e.pageX<=r+this.arrowToggleWidth&&this.hasChildren};