/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.FileSystemView=function(e){WebInspector.SidebarView.call(this,WebInspector.SidebarView.SidebarPosition.Start,"FileSystemViewSidebarWidth"),this.element.addStyleClass("file-system-view"),this.element.addStyleClass("storage-view");var t=this.element.createChild("ol","filesystem-directory-tree");this._directoryTree=new TreeOutline(t),this.sidebarElement.appendChild(t),this.sidebarElement.addStyleClass("outline-disclosure"),this.sidebarElement.addStyleClass("sidebar");var n=new WebInspector.FileSystemView.EntryTreeElement(this,e.root);n.expanded=!0,this._directoryTree.appendChild(n),this._visibleView=null,this._refreshButton=new WebInspector.StatusBarButton(WebInspector.UIString("Refresh"),"refresh-storage-status-bar-item"),this._refreshButton.visible=!0,this._refreshButton.addEventListener("click",this._refresh,this),this._deleteButton=new WebInspector.StatusBarButton(WebInspector.UIString("Delete"),"delete-storage-status-bar-item"),this._deleteButton.visible=!0,this._deleteButton.addEventListener("click",this._confirmDelete,this)},WebInspector.FileSystemView.prototype={get statusBarItems(){return[this._refreshButton.element,this._deleteButton.element]},get visibleView(){return this._visibleView},showView:function(e){if(this._visibleView===e)return;this._visibleView&&this._visibleView.detach(),this._visibleView=e,e.show(this.mainElement)},_refresh:function(){this._directoryTree.children[0].refresh()},_confirmDelete:function(){confirm(WebInspector.UIString("Are you sure you want to delete the selected entry?"))&&this._delete()},_delete:function(){this._directoryTree.selectedTreeElement.deleteEntry()},__proto__:WebInspector.SidebarView.prototype},WebInspector.FileSystemView.EntryTreeElement=function(e,t){TreeElement.call(this,t.name,null,t.isDirectory),this._entry=t,this._fileSystemView=e},WebInspector.FileSystemView.EntryTreeElement.prototype={onattach:function(){var e=this.listItemElement.createChild("div","selection");this.listItemElement.insertBefore(e,this.listItemElement.firstChild)},onselect:function(){if(!this._view)if(this._entry.isDirectory)this._view=new WebInspector.DirectoryContentView;else{var e=this._entry;this._view=new WebInspector.FileContentView(e)}this._fileSystemView.showView(this._view),this.refresh()},onpopulate:function(){this.refresh()},_directoryContentReceived:function(e,t){if(e===FileError.NOT_FOUND_ERR){this.parent!==this.treeOutline&&this.parent.refresh();return}if(e!==0||!t){console.error("Failed to read directory: "+e);return}t.sort(WebInspector.FileSystemModel.Entry.compare),this._view&&this._view.showEntries(t);var n=this.children.slice(0),r=0,i=0,s=0;while(r<t.length&&i<n.length){var o=t[r],u=n[i],a=o.name.compareTo(u._entry.name);if(a===0){u._entry.isDirectory?u.shouldRefreshChildren=!0:u.refresh(),++r,++i,++s;continue}if(a<0){this.insertChild(new WebInspector.FileSystemView.EntryTreeElement(this._fileSystemView,o),s),++r,++s;continue}this.removeChildAtIndex(s),++i}for(;r<t.length;++r)this.appendChild(new WebInspector.FileSystemView.EntryTreeElement(this._fileSystemView,t[r]));for(;i<n.length;++i)this.removeChild(n[i])},refresh:function(){if(!this._entry.isDirectory){if(this._view&&this._view===this._fileSystemView.visibleView){var e=this._view;e.refresh()}}else this._entry.requestDirectoryContent(this._directoryContentReceived.bind(this))},deleteEntry:function(){this._entry.deleteEntry(this._deletionCompleted.bind(this))},_deletionCompleted:function(){this._entry!=this._entry.fileSystem.root&&this.parent.refresh()},__proto__:TreeElement.prototype};