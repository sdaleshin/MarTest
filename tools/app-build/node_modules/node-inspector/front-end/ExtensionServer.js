/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ExtensionServer=function(){this._clientObjects={},this._handlers={},this._subscribers={},this._subscriptionStartHandlers={},this._subscriptionStopHandlers={},this._extraHeaders={},this._requests={},this._lastRequestId=0,this._registeredExtensions={},this._status=new WebInspector.ExtensionStatus;var e=WebInspector.extensionAPI.Commands;this._registerHandler(e.AddAuditCategory,this._onAddAuditCategory.bind(this)),this._registerHandler(e.AddAuditResult,this._onAddAuditResult.bind(this)),this._registerHandler(e.AddConsoleMessage,this._onAddConsoleMessage.bind(this)),this._registerHandler(e.AddRequestHeaders,this._onAddRequestHeaders.bind(this)),this._registerHandler(e.CreatePanel,this._onCreatePanel.bind(this)),this._registerHandler(e.CreateSidebarPane,this._onCreateSidebarPane.bind(this)),this._registerHandler(e.CreateStatusBarButton,this._onCreateStatusBarButton.bind(this)),this._registerHandler(e.EvaluateOnInspectedPage,this._onEvaluateOnInspectedPage.bind(this)),this._registerHandler(e.ForwardKeyboardEvent,this._onForwardKeyboardEvent.bind(this)),this._registerHandler(e.GetHAR,this._onGetHAR.bind(this)),this._registerHandler(e.GetConsoleMessages,this._onGetConsoleMessages.bind(this)),this._registerHandler(e.GetPageResources,this._onGetPageResources.bind(this)),this._registerHandler(e.GetRequestContent,this._onGetRequestContent.bind(this)),this._registerHandler(e.GetResourceContent,this._onGetResourceContent.bind(this)),this._registerHandler(e.Reload,this._onReload.bind(this)),this._registerHandler(e.SetOpenResourceHandler,this._onSetOpenResourceHandler.bind(this)),this._registerHandler(e.SetResourceContent,this._onSetResourceContent.bind(this)),this._registerHandler(e.SetSidebarHeight,this._onSetSidebarHeight.bind(this)),this._registerHandler(e.SetSidebarContent,this._onSetSidebarContent.bind(this)),this._registerHandler(e.SetSidebarPage,this._onSetSidebarPage.bind(this)),this._registerHandler(e.ShowPanel,this._onShowPanel.bind(this)),this._registerHandler(e.StopAuditCategoryRun,this._onStopAuditCategoryRun.bind(this)),this._registerHandler(e.Subscribe,this._onSubscribe.bind(this)),this._registerHandler(e.OpenResource,this._onOpenResource.bind(this)),this._registerHandler(e.Unsubscribe,this._onUnsubscribe.bind(this)),this._registerHandler(e.UpdateButton,this._onUpdateButton.bind(this)),this._registerHandler(e.UpdateAuditProgress,this._onUpdateAuditProgress.bind(this)),window.addEventListener("message",this._onWindowMessage.bind(this),!1)},WebInspector.ExtensionServer.prototype={hasExtensions:function(){return!!Object.keys(this._registeredExtensions).length},notifySearchAction:function(e,t,n){this._postNotification(WebInspector.extensionAPI.Events.PanelSearch+e,t,n)},notifyViewShown:function(e,t){this._postNotification(WebInspector.extensionAPI.Events.ViewShown+e,t)},notifyViewHidden:function(e){this._postNotification(WebInspector.extensionAPI.Events.ViewHidden+e)},notifyButtonClicked:function(e){this._postNotification(WebInspector.extensionAPI.Events.ButtonClicked+e)},_inspectedURLChanged:function(e){this._requests={};var t=e.data;this._postNotification(WebInspector.extensionAPI.Events.InspectedURLChanged,t)},startAuditRun:function(e,t){this._clientObjects[t.id]=t,this._postNotification("audit-started-"+e.id,t.id)},stopAuditRun:function(e){delete this._clientObjects[e.id]},hasSubscribers:function(e){return!!this._subscribers[e]},_postNotification:function(e,t){var n=this._subscribers[e];if(!n)return;var r={command:"notify-"+e,arguments:Array.prototype.slice.call(arguments,1)};for(var i=0;i<n.length;++i)n[i].postMessage(r)},_onSubscribe:function(e,t){var n=this._subscribers[e.type];n?n.push(t):(this._subscribers[e.type]=[t],this._subscriptionStartHandlers[e.type]&&this._subscriptionStartHandlers[e.type]())},_onUnsubscribe:function(e,t){var n=this._subscribers[e.type];if(!n)return;n.remove(t),n.length||(delete this._subscribers[e.type],this._subscriptionStopHandlers[e.type]&&this._subscriptionStopHandlers[e.type]())},_onAddRequestHeaders:function(e){var t=e.extensionId;if(typeof t!="string")return this._status.E_BADARGTYPE("extensionId",typeof t,"string");var n=this._extraHeaders[t];n||(n={},this._extraHeaders[t]=n);for(var r in e.headers)n[r]=e.headers[r];var i={};for(var s in this._extraHeaders){var o=this._extraHeaders[s];for(r in o)typeof o[r]=="string"&&(i[r]=o[r])}NetworkAgent.setExtraHTTPHeaders(i)},_onCreatePanel:function(e,t){var n=e.id;if(n in this._clientObjects||n in WebInspector.panels)return this._status.E_EXISTS(n);var r=this._expandResourcePath(t._extensionOrigin,e.page),i=new WebInspector.PanelDescriptor(n,e.title,undefined,undefined,new WebInspector.ExtensionPanel(n,r));return this._clientObjects[n]=i.panel(),WebInspector.inspectorView.addPanel(i),this._status.OK()},_onShowPanel:function(e){WebInspector.showPanel(e.id)},_onCreateStatusBarButton:function(e,t){var n=this._clientObjects[e.panel];if(!!n&&n instanceof WebInspector.ExtensionPanel){var r=new WebInspector.ExtensionButton(e.id,this._expandResourcePath(t._extensionOrigin,e.icon),e.tooltip,e.disabled);return this._clientObjects[e.id]=r,n.addStatusBarItem(r.element),this._status.OK()}return this._status.E_NOTFOUND(e.panel)},_onUpdateButton:function(e,t){var n=this._clientObjects[e.id];return!!n&&n instanceof WebInspector.ExtensionButton?(n.update(this._expandResourcePath(t._extensionOrigin,e.icon),e.tooltip,e.disabled),this._status.OK()):this._status.E_NOTFOUND(e.id)},_onCreateSidebarPane:function(e){var t=WebInspector.panel(e.panel);if(!t)return this._status.E_NOTFOUND(e.panel);if(!t.addExtensionSidebarPane)return this._status.E_NOTSUPPORTED();var n=e.id,r=new WebInspector.ExtensionSidebarPane(e.title,e.id);return this._clientObjects[n]=r,t.addExtensionSidebarPane(n,r),this._status.OK()},_onSetSidebarHeight:function(e){var t=this._clientObjects[e.id];return t?(t.setHeight(e.height),this._status.OK()):this._status.E_NOTFOUND(e.id)},_onSetSidebarContent:function(e,t){function r(n){var r=n?this._status.E_FAILED(n):this._status.OK();this._dispatchCallback(e.requestId,t,r)}var n=this._clientObjects[e.id];if(!n)return this._status.E_NOTFOUND(e.id);if(e.evaluateOnPage)return n.setExpression(e.expression,e.rootTitle,e.evaluateOptions,t._extensionOrigin,r.bind(this));n.setObject(e.expression,e.rootTitle,r.bind(this))},_onSetSidebarPage:function(e,t){var n=this._clientObjects[e.id];if(!n)return this._status.E_NOTFOUND(e.id);n.setPage(this._expandResourcePath(t._extensionOrigin,e.page))},_onOpenResource:function(e){var t=document.createElement("a");return t.href=e.url,t.lineNumber=e.lineNumber,WebInspector.showAnchorLocation(t)?this._status.OK():this._status.E_NOTFOUND(e.url)},_onSetOpenResourceHandler:function(e,t){var n=this._registeredExtensions[t._extensionOrigin].name||"Extension "+t._extensionOrigin;e.handlerPresent?WebInspector.openAnchorLocationRegistry.registerHandler(n,this._handleOpenURL.bind(this,t)):WebInspector.openAnchorLocationRegistry.unregisterHandler(n)},_handleOpenURL:function(e,t){var n=t.url,r=WebInspector.workspace.uiSourceCodeForOriginURL(n)||WebInspector.resourceForURL(n);if(!r)return!1;var i=t.lineNumber;return typeof i=="number"&&(i+=1),e.postMessage({command:"open-resource",resource:this._makeResource(r),lineNumber:i}),!0},_onReload:function(e){var t=e.options||{};NetworkAgent.setUserAgentOverride(typeof t.userAgent=="string"?t.userAgent:"");var n;t.injectedScript&&(n="(function(){"+t.injectedScript+"})()");var r=t.preprocessingScript;return PageAgent.reload(!!t.ignoreCache,n,r),this._status.OK()},_onEvaluateOnInspectedPage:function(e,t){function n(n,r,i){var s;n?s=this._status.E_PROTOCOLERROR(n.toString()):i?s={isException:!0,value:r.description}:s={value:r.value},this._dispatchCallback(e.requestId,t,s)}return this.evaluate(e.expression,!0,!0,e.evaluateOptions,t._extensionOrigin,n.bind(this))},_onGetConsoleMessages:function(){return WebInspector.console.messages.map(this._makeConsoleMessage)},_onAddConsoleMessage:function(e){function t(e){switch(e){case WebInspector.extensionAPI.console.Severity.Log:return WebInspector.ConsoleMessage.MessageLevel.Log;case WebInspector.extensionAPI.console.Severity.Warning:return WebInspector.ConsoleMessage.MessageLevel.Warning;case WebInspector.extensionAPI.console.Severity.Error:return WebInspector.ConsoleMessage.MessageLevel.Error;case WebInspector.extensionAPI.console.Severity.Debug:return WebInspector.ConsoleMessage.MessageLevel.Debug}}var n=t(e.severity);if(!n)return this._status.E_BADARG("message.severity",e.severity);var r=WebInspector.ConsoleMessage.create(WebInspector.ConsoleMessage.MessageSource.JS,n,e.text,WebInspector.ConsoleMessage.MessageType.Log,e.url,e.line);WebInspector.console.addMessage(r)},_makeConsoleMessage:function(e){function t(e){if(!e)return;switch(e){case WebInspector.ConsoleMessage.MessageLevel.Log:return WebInspector.extensionAPI.console.Severity.Log;case WebInspector.ConsoleMessage.MessageLevel.Warning:return WebInspector.extensionAPI.console.Severity.Warning;case WebInspector.ConsoleMessage.MessageLevel.Error:return WebInspector.extensionAPI.console.Severity.Error;case WebInspector.ConsoleMessage.MessageLevel.Debug:return WebInspector.extensionAPI.console.Severity.Debug;default:return WebInspector.extensionAPI.console.Severity.Log}}var n={severity:t(e.level),text:e.text};return e.url&&(n.url=e.url),e.line&&(n.line=e.line),n},_onGetHAR:function(){var e=WebInspector.networkLog.requests,t=(new WebInspector.HARLog(e)).build();for(var n=0;n<t.entries.length;++n)t.entries[n]._requestId=this._requestId(e[n]);return t},_makeResource:function(e){return{url:e.contentURL(),type:e.contentType().name()}},_onGetPageResources:function(){function t(t){e[t.contentURL()]||(e[t.contentURL()]=this._makeResource(t))}var e={},n=WebInspector.workspace.uiSourceCodesForProjectType(WebInspector.projectTypes.Network);return n.forEach(t.bind(this)),WebInspector.resourceTreeModel.forAllResources(t.bind(this)),Object.values(e)},_getResourceContent:function(e,t,n){function r(e,r,i){var s={encoding:r?"base64":"",content:e};this._dispatchCallback(t.requestId,n,s)}e.requestContent(r.bind(this))},_onGetRequestContent:function(e,t){var n=this._requestById(e.id);if(!n)return this._status.E_NOTFOUND(e.id);this._getResourceContent(n,e,t)},_onGetResourceContent:function(e,t){var n=e.url,r=WebInspector.workspace.uiSourceCodeForOriginURL(n)||WebInspector.resourceForURL(n);if(!r)return this._status.E_NOTFOUND(n);this._getResourceContent(r,e,t)},_onSetResourceContent:function(e,t){function n(n){var r=n?this._status.E_FAILED(n):this._status.OK();this._dispatchCallback(e.requestId,t,r)}var r=e.url,i=WebInspector.workspace.uiSourceCodeForOriginURL(r);if(!i){var s=WebInspector.resourceTreeModel.resourceForURL(r);return s?this._status.E_NOTSUPPORTED("Resource is not editable"):this._status.E_NOTFOUND(r)}i.setWorkingCopy(e.content),e.commit?i.commitWorkingCopy(n.bind(this)):n.call(this,null)},_requestId:function(e){return e._extensionRequestId||(e._extensionRequestId=++this._lastRequestId,this._requests[e._extensionRequestId]=e),e._extensionRequestId},_requestById:function(e){return this._requests[e]},_onAddAuditCategory:function(e,t){var n=new WebInspector.ExtensionAuditCategory(t._extensionOrigin,e.id,e.displayName,e.resultCount);if(WebInspector.panel("audits").getCategory(n.id))return this._status.E_EXISTS(n.id);this._clientObjects[e.id]=n,WebInspector.panel("audits").addCategory(n)},_onAddAuditResult:function(e){var t=this._clientObjects[e.resultId];if(!t)return this._status.E_NOTFOUND(e.resultId);try{t.addResult(e.displayName,e.description,e.severity,e.details)}catch(n){return n}return this._status.OK()},_onUpdateAuditProgress:function(e){var t=this._clientObjects[e.resultId];if(!t)return this._status.E_NOTFOUND(e.resultId);t.updateProgress(Math.min(Math.max(0,e.progress),1))},_onStopAuditCategoryRun:function(e){var t=this._clientObjects[e.resultId];if(!t)return this._status.E_NOTFOUND(e.resultId);t.done()},_onForwardKeyboardEvent:function(e){const t="U+001B";if(!e.ctrlKey&&!e.altKey&&!e.metaKey&&!/^F\d+$/.test(e.keyIdentifier)&&e.keyIdentifier!==t)return;var n=new window.KeyboardEvent(e.eventType,{keyIdentifier:e.keyIdentifier,location:e.location,ctrlKey:e.ctrlKey,altKey:e.altKey,shiftKey:e.shiftKey,metaKey:e.metaKey});document.dispatchEvent(n)},_dispatchCallback:function(e,t,n){e&&t.postMessage({command:"callback",requestId:e,result:n})},initExtensions:function(){function e(){WebInspector.timelineManager.addEventListener(WebInspector.TimelineManager.EventTypes.TimelineEventRecorded,this._notifyTimelineEventRecorded,this),WebInspector.timelineManager.start()}function t(){WebInspector.timelineManager.stop(),WebInspector.timelineManager.removeEventListener(WebInspector.TimelineManager.EventTypes.TimelineEventRecorded,this._notifyTimelineEventRecorded,this)}this._registerAutosubscriptionHandler(WebInspector.extensionAPI.Events.ConsoleMessageAdded,WebInspector.console,WebInspector.ConsoleModel.Events.MessageAdded,this._notifyConsoleMessageAdded),this._registerAutosubscriptionHandler(WebInspector.extensionAPI.Events.NetworkRequestFinished,WebInspector.networkManager,WebInspector.NetworkManager.EventTypes.RequestFinished,this._notifyRequestFinished),this._registerAutosubscriptionHandler(WebInspector.extensionAPI.Events.ResourceAdded,WebInspector.workspace,WebInspector.Workspace.Events.UISourceCodeAdded,this._notifyResourceAdded),this._registerAutosubscriptionHandler(WebInspector.extensionAPI.Events.ElementsPanelObjectSelected,WebInspector.notifications,WebInspector.ElementsTreeOutline.Events.SelectedNodeChanged,this._notifyElementsSelectionChanged),this._registerAutosubscriptionHandler(WebInspector.extensionAPI.Events.ResourceContentCommitted,WebInspector.workspace,WebInspector.Workspace.Events.UISourceCodeContentCommitted,this._notifyUISourceCodeContentCommitted),this._registerSubscriptionHandler(WebInspector.extensionAPI.Events.TimelineEventRecorded,e.bind(this),t.bind(this)),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.InspectedURLChanged,this._inspectedURLChanged,this),this._initDone=!0,this._pendingExtensions&&(this._pendingExtensions.forEach(this._innerAddExtension,this),delete this._pendingExtensions),InspectorExtensionRegistry.getExtensionsAsync()},_notifyConsoleMessageAdded:function(e){this._postNotification(WebInspector.extensionAPI.Events.ConsoleMessageAdded,this._makeConsoleMessage(e.data))},_notifyResourceAdded:function(e){var t=e.data;this._postNotification(WebInspector.extensionAPI.Events.ResourceAdded,this._makeResource(t))},_notifyUISourceCodeContentCommitted:function(e){var t=e.data.uiSourceCode,n=e.data.content;this._postNotification(WebInspector.extensionAPI.Events.ResourceContentCommitted,this._makeResource(t),n)},_notifyRequestFinished:function(e){var t=e.data;this._postNotification(WebInspector.extensionAPI.Events.NetworkRequestFinished,this._requestId(t),(new WebInspector.HAREntry(t)).build())},_notifyElementsSelectionChanged:function(){this._postNotification(WebInspector.extensionAPI.Events.ElementsPanelObjectSelected)},_notifyTimelineEventRecorded:function(e){this._postNotification(WebInspector.extensionAPI.Events.TimelineEventRecorded,e.data)},_addExtensions:function(e){e.forEach(this._addExtension,this)},_addExtension:function(e){if(this._initDone){this._innerAddExtension(e);return}this._pendingExtensions?this._pendingExtensions.push(e):this._pendingExtensions=[e]},_innerAddExtension:function(e){const t=new RegExp("([^:]+://[^/]*)/");var n=e.startPage,r=e.name;try{var i=t.exec(n);if(!i)return console.error("Skipping extension with invalid URL: "+n),!1;var s=i[1];this._registeredExtensions[s]||(InspectorFrontendHost.setInjectedScriptForOrigin(s,buildExtensionAPIInjectedScript(e)),this._registeredExtensions[s]={name:r});var o=document.createElement("iframe");o.src=n,o.style.display="none",document.body.appendChild(o)}catch(u){return console.error("Failed to initialize extension "+n+":"+u),!1}return!0},_onWindowMessage:function(e){e.data==="registerExtension"&&this._registerExtension(e.origin,e.ports[0])},_registerExtension:function(e,t){if(!this._registeredExtensions.hasOwnProperty(e)){e!==window.location.origin&&console.error("Ignoring unauthorized client request from "+e);return}t._extensionOrigin=e,t.addEventListener("message",this._onmessage.bind(this),!1),t.start()},_onmessage:function(e){var t=e.data,n;t.command in this._handlers?n=this._handlers[t.command](t,e.target):n=this._status.E_NOTSUPPORTED(t.command),n&&t.requestId&&this._dispatchCallback(t.requestId,e.target,n)},_registerHandler:function(e,t){console.assert(e),this._handlers[e]=t},_registerSubscriptionHandler:function(e,t,n){this._subscriptionStartHandlers[e]=t,this._subscriptionStopHandlers[e]=n},_registerAutosubscriptionHandler:function(e,t,n,r){this._registerSubscriptionHandler(e,t.addEventListener.bind(t,n,r,this),t.removeEventListener.bind(t,n,r,this))},_expandResourcePath:function(e,t){if(!t)return;return e+this._normalizePath(t)},_normalizePath:function(e){var t=e.split("/"),n=[];for(var r=0;r<t.length;++r){if(t[r]===".")continue;if(t[r]==="")continue;t[r]===".."?n.pop():n.push(t[r])}return"/"+n.join("/")},evaluate:function(e,t,n,r,i,s){var o;if(typeof r=="object"){function u(e){function n(n){return t=n.url===e?n:null,t}var t;return WebInspector.resourceTreeModel.frames().some(n),t}var a=r.frameURL?u(r.frameURL):WebInspector.resourceTreeModel.mainFrame;if(!a)return r.frameURL?console.warn("evaluate: there is no frame with URL "+r.frameURL):console.warn("evaluate: the main frame is not yet available"),this._status.E_NOTFOUND(r.frameURL||"<top>");var f;r.useContentScriptContext?f=i:r.scriptExecutionContext&&(f=r.scriptExecutionContext);var l=WebInspector.runtimeModel.contextListByFrame(a),c;if(f){c=l.contextBySecurityOrigin(f);if(!c)return console.warn("The JS context "+f+" was not found in the frame "+a.url),this._status.E_NOTFOUND(f)}else{c=l.mainWorldContext();if(!c)return this._status.E_FAILED(a.url+" has no execution context")}o=c.id}RuntimeAgent.evaluate(e,"extension",t,!0,o,n,!1,s)}},WebInspector.ExtensionStatus=function(){function e(e,t){var n=Array.prototype.slice.call(arguments,2),r={code:e,description:t,details:n};return e!=="OK"&&(r.isError=!0,console.log("Extension server error: "+String.vsprintf(t,n))),r}this.OK=e.bind(null,"OK","OK"),this.E_EXISTS=e.bind(null,"E_EXISTS","Object already exists: %s"),this.E_BADARG=e.bind(null,"E_BADARG","Invalid argument %s: %s"),this.E_BADARGTYPE=e.bind(null,"E_BADARGTYPE","Invalid type for argument %s: got %s, expected %s"),this.E_NOTFOUND=e.bind(null,"E_NOTFOUND","Object not found: %s"),this.E_NOTSUPPORTED=e.bind(null,"E_NOTSUPPORTED","Object does not support requested operation: %s"),this.E_PROTOCOLERROR=e.bind(null,"E_PROTOCOLERROR","Inspector protocol error: %s"),this.E_FAILED=e.bind(null,"E_FAILED","Operation failed: %s")},WebInspector.addExtensions=function(e){WebInspector.extensionServer._addExtensions(e)},WebInspector.extensionAPI={},defineCommonExtensionSymbols(WebInspector.extensionAPI),WebInspector.extensionServer=new WebInspector.ExtensionServer,window.addExtension=function(e,t){WebInspector.extensionServer._addExtension({startPage:e,name:t})};