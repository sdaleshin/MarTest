/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ObjectPropertiesSection=function(e,t,n,r,i,s,o){this.emptyPlaceholder=r||WebInspector.UIString("No Properties"),this.object=e,this.ignoreHasOwnProperty=i,this.extraProperties=s,this.treeElementConstructor=o||WebInspector.ObjectPropertyTreeElement,this.editable=!0,this.skipProto=!1,WebInspector.PropertiesSection.call(this,t||"",n)},WebInspector.ObjectPropertiesSection._arrayLoadThreshold=100,WebInspector.ObjectPropertiesSection.prototype={enableContextMenu:function(){this.element.addEventListener("contextmenu",this._contextMenuEventFired.bind(this),!1)},_contextMenuEventFired:function(e){var t=new WebInspector.ContextMenu(e);t.appendApplicableItems(this.object),t.show()},onpopulate:function(){this.update()},update:function(){function e(e,t){if(!e)return;this.updateProperties(e,t)}if(this.object.arrayLength()>WebInspector.ObjectPropertiesSection._arrayLoadThreshold){this.propertiesTreeOutline.removeChildren(),WebInspector.ArrayGroupingTreeElement._populateArray(this.propertiesTreeOutline,this.object,0,this.object.arrayLength()-1);return}WebInspector.RemoteObject.loadFromObject(this.object,!!this.ignoreHasOwnProperty,e.bind(this))},updateProperties:function(e,t,n,r){n||(n=this.treeElementConstructor),r||(r=WebInspector.ObjectPropertiesSection.CompareProperties);if(this.extraProperties)for(var i=0;i<this.extraProperties.length;++i)e.push(this.extraProperties[i]);this.propertiesTreeOutline.removeChildren(),WebInspector.ObjectPropertyTreeElement.populateWithProperties(this.propertiesTreeOutline,e,t,n,r,this.skipProto,this.object),this.propertiesForTest=e;if(!this.propertiesTreeOutline.children.length){var s=document.createElement("div");s.className="info",s.textContent=this.emptyPlaceholder;var o=new TreeElement(s,null,!1);this.propertiesTreeOutline.appendChild(o)}},__proto__:WebInspector.PropertiesSection.prototype},WebInspector.ObjectPropertiesSection.CompareProperties=function(e,t){var n=e.name,r=t.name;return n==="__proto__"?1:r==="__proto__"?-1:String.naturalOrderComparator(n,r)},WebInspector.ObjectPropertyTreeElement=function(e){this.property=e,TreeElement.call(this,"",null,!1),this.toggleOnClick=!0,this.selectable=!1},WebInspector.ObjectPropertyTreeElement.prototype={onpopulate:function(){return WebInspector.ObjectPropertyTreeElement.populate(this,this.property.value)},ondblclick:function(e){(this.property.writable||this.property.setter)&&this.startEditing(e)},onattach:function(){this.update()},update:function(){this.nameElement=document.createElement("span"),this.nameElement.className="name",this.nameElement.textContent=this.property.name,this.property.enumerable||this.nameElement.addStyleClass("dimmed"),this.property.isAccessorProperty()&&this.nameElement.addStyleClass("properties-accessor-property-name");var e=document.createElement("span");e.className="separator",e.textContent=": ";if(this.property.value){this.valueElement=document.createElement("span"),this.valueElement.className="value";var t=this.property.value.description;if(this.property.wasThrown)this.valueElement.textContent="[Exception: "+t+"]";else if(this.property.value.type==="string"&&typeof t=="string")this.valueElement.textContent='"'+t.replace(/\n/g,"↵")+'"',this.valueElement._originalTextContent='"'+t+'"';else if(this.property.value.type==="function"&&typeof t=="string")this.valueElement.textContent=/.*/.exec(t)[0].replace(/ +$/g,""),this.valueElement._originalTextContent=t;else if(this.property.value.type!=="object"||this.property.value.subtype!=="node")this.valueElement.textContent=t;this.property.wasThrown&&this.valueElement.addStyleClass("error"),this.property.value.subtype?this.valueElement.addStyleClass("console-formatted-"+this.property.value.subtype):this.property.value.type&&this.valueElement.addStyleClass("console-formatted-"+this.property.value.type),this.valueElement.addEventListener("contextmenu",this._contextMenuFired.bind(this,this.property.value),!1),this.property.value.type==="object"&&this.property.value.subtype==="node"&&this.property.value.description?(WebInspector.DOMPresentationUtils.createSpansForNodeTitle(this.valueElement,this.property.value.description),this.valueElement.addEventListener("mousemove",this._mouseMove.bind(this,this.property.value),!1),this.valueElement.addEventListener("mouseout",this._mouseOut.bind(this,this.property.value),!1)):this.valueElement.title=t||"",this.listItemElement.removeChildren(),this.hasChildren=this.property.value.hasChildren&&!this.property.wasThrown}else this.property.getter?(this.valueElement=document.createElement("span"),this.valueElement.addStyleClass("properties-calculate-value-button"),this.valueElement.textContent="(...)",this.valueElement.title="Invoke property getter",this.valueElement.addEventListener("click",this._onInvokeGetterClick.bind(this),!1)):(this.valueElement=document.createElement("span"),this.valueElement.textContent="<unreadable>");this.listItemElement.appendChild(this.nameElement),this.listItemElement.appendChild(e),this.listItemElement.appendChild(this.valueElement)},_contextMenuFired:function(e,t){var n=new WebInspector.ContextMenu(t);this.populateContextMenu(n),n.appendApplicableItems(e),n.show()},populateContextMenu:function(e){},_mouseMove:function(e){this.property.value.highlightAsDOMNode()},_mouseOut:function(e){this.property.value.hideDOMNodeHighlight()},updateSiblings:function(){this.parent.root?this.treeOutline.section.update():this.parent.shouldRefreshChildren=!0},renderPromptAsBlock:function(){return!1},elementAndValueToEdit:function(e){return[this.valueElement,typeof this.valueElement._originalTextContent=="string"?this.valueElement._originalTextContent:undefined]},startEditing:function(e){function s(){this.editingCommitted(null,n.textContent,i.previousContent,i)}var t=this.elementAndValueToEdit(e),n=t[0],r=t[1];if(WebInspector.isBeingEdited(n)||!this.treeOutline.section.editable||this._readOnly)return;typeof r!="undefined"&&(n.textContent=r);var i={expanded:this.expanded,elementToEdit:n,previousContent:n.textContent};this.hasChildren=!1,this.listItemElement.addStyleClass("editing-sub-part"),this._prompt=new WebInspector.ObjectPropertyPrompt(this.editingCommitted.bind(this,null,n.textContent,i.previousContent,i),this.editingCancelled.bind(this,null,i),this.renderPromptAsBlock());var o=this._prompt.attachAndStartEditing(n,s.bind(this));window.getSelection().setBaseAndExtent(n,0,n,1),o.addEventListener("keydown",this._promptKeyDown.bind(this,i),!1)},isEditing:function(){return!!this._prompt},editingEnded:function(e){this._prompt.detach(),delete this._prompt,this.listItemElement.scrollLeft=0,this.listItemElement.removeStyleClass("editing-sub-part"),e.expanded&&this.expand()},editingCancelled:function(e,t){this.editingEnded(t),this.update()},editingCommitted:function(e,t,n,r){if(t===n)return this.editingCancelled(e,r);this.editingEnded(r),this.applyExpression(t,!0)},_promptKeyDown:function(e,t){if(isEnterKey(t))return t.consume(!0),this.editingCommitted(null,e.elementToEdit.textContent,e.previousContent,e);if(t.keyIdentifier==="U+001B")return t.consume(),this.editingCancelled(null,e)},applyExpression:function(e,t){function r(e){if(!t)return;e&&this.update(),n?this.updateSiblings():this.parent.removeChild(this)}e=e.trim();var n=e.length;this.property.parentObject.setPropertyValue(this.property.name,e.trim(),r.bind(this))},propertyPath:function(){if("_cachedPropertyPath"in this)return this._cachedPropertyPath;var e=this,t;do e.property&&(t?t=e.property.name+"."+t:t=e.property.name),e=e.parent;while(e&&!e.root);return this._cachedPropertyPath=t,t},_onInvokeGetterClick:function(e){function t(e,t,n){if(e)return;var r=WebInspector.RemoteObject.fromPayload(t);this.property.value=r,this.property.wasThrown=n,this.update(),this.shouldRefreshChildren=!0}e.consume();if(!this.property.getter)return;var n="function(th){return this.call(th);}",r=[{objectId:this.property.parentObject.objectId}];RuntimeAgent.callFunctionOn(this.property.getter.objectId,n,r,undefined,!1,undefined,t.bind(this))},__proto__:TreeElement.prototype},WebInspector.ObjectPropertyTreeElement.populate=function(e,t){function n(n,r){e.removeChildren();if(!n)return;r||(r=[]),WebInspector.ObjectPropertyTreeElement.populateWithProperties(e,n,r,e.treeOutline.section.treeElementConstructor,WebInspector.ObjectPropertiesSection.CompareProperties,e.treeOutline.section.skipProto,t)}if(e.children.length&&!e.shouldRefreshChildren)return;if(t.arrayLength()>WebInspector.ObjectPropertiesSection._arrayLoadThreshold){e.removeChildren(),WebInspector.ArrayGroupingTreeElement._populateArray(e,t,0,t.arrayLength()-1);return}WebInspector.RemoteObject.loadFromObjectPerProto(t,n)},WebInspector.ObjectPropertyTreeElement.populateWithProperties=function(e,t,n,r,i,s,o){t.sort(i);for(var u=0;u<t.length;++u){var a=t[u];if(s&&a.name==="__proto__")continue;if(a.isAccessorProperty()){a.name!=="__proto__"&&a.getter&&(a.parentObject=o,e.appendChild(new r(a)));if(a.isOwn){if(a.getter){var f=new WebInspector.RemoteObjectProperty("get "+a.name,a.getter);f.parentObject=o,e.appendChild(new r(f))}if(a.setter){var l=new WebInspector.RemoteObjectProperty("set "+a.name,a.setter);l.parentObject=o,e.appendChild(new r(l))}}}else a.parentObject=o,e.appendChild(new r(a))}if(o&&o.type==="function"){var c=!1;if(n)for(var u=0;u<n.length;u++)if(n[u].name=="[[TargetFunction]]"){c=!0;break}c||e.appendChild(new WebInspector.FunctionScopeMainTreeElement(o))}if(n)for(var u=0;u<n.length;u++)n[u].parentObject=o,e.appendChild(new r(n[u]))},WebInspector.FunctionScopeMainTreeElement=function(e){TreeElement.call(this,"<function scope>",null,!1),this.toggleOnClick=!0,this.selectable=!1,this._remoteObject=e,this.hasChildren=!0},WebInspector.FunctionScopeMainTreeElement.prototype={onpopulate:function(){function e(e,t){if(e){console.error(e);return}this.removeChildren();var n=t.scopeChain;if(!n)return;for(var r=0;r<n.length;++r){var i=n[r],s=null,o;switch(i.type){case"local":s=WebInspector.UIString("Local"),o=!1;break;case"closure":s=WebInspector.UIString("Closure"),o=!1;break;case"catch":s=WebInspector.UIString("Catch"),o=!1;break;case"with":s=WebInspector.UIString("With Block"),o=!0;break;case"global":s=WebInspector.UIString("Global"),o=!0;break;default:console.error("Unknown scope type: "+i.type);continue}var u;o?u=undefined:u=new WebInspector.ScopeRef(r,undefined,this._remoteObject.objectId);var a=WebInspector.ScopeRemoteObject.fromPayload(i.object,u);if(o){var f=WebInspector.RemoteObjectProperty.fromScopeValue(s,a);f.parentObject=null,this.appendChild(new this.treeOutline.section.treeElementConstructor(f))}else{var l=new WebInspector.ScopeTreeElement(s,null,a);this.appendChild(l)}}}if(this.children.length&&!this.shouldRefreshChildren)return;DebuggerAgent.getFunctionDetails(this._remoteObject.objectId,e.bind(this))},__proto__:TreeElement.prototype},WebInspector.ScopeTreeElement=function(e,t,n){TreeElement.call(this,e,null,!1),this.toggleOnClick=!0,this.selectable=!1,this._remoteObject=n,this.hasChildren=!0},WebInspector.ScopeTreeElement.prototype={onpopulate:function(){return WebInspector.ObjectPropertyTreeElement.populate(this,this._remoteObject)},__proto__:TreeElement.prototype},WebInspector.ArrayGroupingTreeElement=function(e,t,n,r){TreeElement.call(this,String.sprintf("[%d … %d]",t,n),undefined,!0),this._fromIndex=t,this._toIndex=n,this._object=e,this._readOnly=!0,this._propertyCount=r,this._populated=!1},WebInspector.ArrayGroupingTreeElement._bucketThreshold=100,WebInspector.ArrayGroupingTreeElement._sparseIterationThreshold=25e4,WebInspector.ArrayGroupingTreeElement._populateArray=function(e,t,n,r){WebInspector.ArrayGroupingTreeElement._populateRanges(e,t,n,r,!0)},WebInspector.ArrayGroupingTreeElement._populateRanges=function(e,t,n,r,i){function s(e,t,n,r){function s(n){if(t-e<r)for(var s=e;s<=t;++s)s in this&&n(s);else{i=i||Object.getOwnPropertyNames(this);for(var s=0;s<i.length;++s){var o=i[s],u=o>>>0;String(u)===o&&e<=u&&u<=t&&n(u)}}}function u(){++o}function h(e){l===-1&&(l=e),c=e,++o===a&&(f.push([l,c,o]),o=0,l=-1)}var i=null,o=0;s.call(this,u);var a=o;o<=n?a=o:a=Math.pow(n,Math.ceil(Math.log(o)/Math.log(n))-1);var f=[];o=0;var l=-1,c=0;return s.call(this,h),o>0&&f.push([l,c,o]),f}function o(n){if(n.length==1)WebInspector.ArrayGroupingTreeElement._populateAsFragment(e,t,n[0][0],n[0][1]);else for(var r=0;r<n.length;++r){var s=n[r][0],o=n[r][1],u=n[r][2];s==o?WebInspector.ArrayGroupingTreeElement._populateAsFragment(e,t,s,o):e.appendChild(new WebInspector.ArrayGroupingTreeElement(t,s,o,u))}i&&WebInspector.ArrayGroupingTreeElement._populateNonIndexProperties(e,t)}t.callFunctionJSON(s,[{value:n},{value:r},{value:WebInspector.ArrayGroupingTreeElement._bucketThreshold},{value:WebInspector.ArrayGroupingTreeElement._sparseIterationThreshold}],o.bind(this))},WebInspector.ArrayGroupingTreeElement._populateAsFragment=function(e,t,n,r){function i(e,t,n){var r=Object.create(null);if(t-e<n)for(var i=e;i<=t;++i)i in this&&(r[i]=this[i]);else{var s=Object.getOwnPropertyNames(this);for(var i=0;i<s.length;++i){var o=s[i],u=o>>>0;String(u)===o&&e<=u&&u<=t&&(r[u]=this[u])}}return r}function s(e){e.getAllProperties(!1,o.bind(this))}function o(t,n){if(!t)return;t.sort(WebInspector.ObjectPropertiesSection.CompareProperties);for(var r=0;r<t.length;++r){t[r].parentObject=this._object;var i=new e.treeOutline.section.treeElementConstructor(t[r]);i._readOnly=!0,e.appendChild(i)}}t.callFunction(i,[{value:n},{value:r},{value:WebInspector.ArrayGroupingTreeElement._sparseIterationThreshold}],s.bind(this))},WebInspector.ArrayGroupingTreeElement._populateNonIndexProperties=function(e,t){function n(){var e=Object.create(this.__proto__),t=Object.getOwnPropertyNames(this);for(var n=0;n<t.length;++n){var r=t[n];if(String(r>>>0)===r&&r>>>0!==4294967295)continue;var i=Object.getOwnPropertyDescriptor(this,r);i&&Object.defineProperty(e,r,i)}return e}function r(e){e.getOwnProperties(i.bind(this))}function i(t,n){if(!t)return;t.sort(WebInspector.ObjectPropertiesSection.CompareProperties);for(var r=0;r<t.length;++r){t[r].parentObject=this._object;var i=new e.treeOutline.section.treeElementConstructor(t[r]);i._readOnly=!0,e.appendChild(i)}}t.callFunction(n,undefined,r.bind(this))},WebInspector.ArrayGroupingTreeElement.prototype={onpopulate:function(){if(this._populated)return;this._populated=!0;if(this._propertyCount>=WebInspector.ArrayGroupingTreeElement._bucketThreshold){WebInspector.ArrayGroupingTreeElement._populateRanges(this,this._object,this._fromIndex,this._toIndex,!1);return}WebInspector.ArrayGroupingTreeElement._populateAsFragment(this,this._object,this._fromIndex,this._toIndex)},onattach:function(){this.listItemElement.addStyleClass("name")},__proto__:TreeElement.prototype},WebInspector.ObjectPropertyPrompt=function(e,t,n){WebInspector.TextPrompt.call(this,WebInspector.runtimeModel.completionsForTextPrompt.bind(WebInspector.runtimeModel)),this.setSuggestBoxEnabled("generic-suggest"),n&&this.renderAsBlock()},WebInspector.ObjectPropertyPrompt.prototype={__proto__:WebInspector.TextPrompt.prototype};