/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.RuntimeModel=function(e){e.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameAdded,this._frameAdded,this),e.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameNavigated,this._frameNavigated,this),e.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameDetached,this._frameDetached,this),e.addEventListener(WebInspector.ResourceTreeModel.EventTypes.CachedResourcesLoaded,this._didLoadCachedResources,this),this._frameIdToContextList={}},WebInspector.RuntimeModel.Events={FrameExecutionContextListAdded:"FrameExecutionContextListAdded",FrameExecutionContextListRemoved:"FrameExecutionContextListRemoved"},WebInspector.RuntimeModel.prototype={setCurrentExecutionContext:function(e){this._currentExecutionContext=e},currentExecutionContext:function(){return this._currentExecutionContext},contextLists:function(){return Object.values(this._frameIdToContextList)},contextListByFrame:function(e){return this._frameIdToContextList[e.id]},_frameAdded:function(e){var t=e.data,n=new WebInspector.FrameExecutionContextList(t);this._frameIdToContextList[t.id]=n,this.dispatchEventToListeners(WebInspector.RuntimeModel.Events.FrameExecutionContextListAdded,n)},_frameNavigated:function(e){var t=e.data,n=this._frameIdToContextList[t.id];n&&n._frameNavigated(t)},_frameDetached:function(e){var t=e.data,n=this._frameIdToContextList[t.id];if(!n)return;this.dispatchEventToListeners(WebInspector.RuntimeModel.Events.FrameExecutionContextListRemoved,n),delete this._frameIdToContextList[t.id]},_didLoadCachedResources:function(){InspectorBackend.registerRuntimeDispatcher(new WebInspector.RuntimeDispatcher(this)),RuntimeAgent.enable()},_executionContextCreated:function(e){var t=this._frameIdToContextList[e.frameId];if(!t)return;t._addExecutionContext(new WebInspector.ExecutionContext(e.id,e.name,e.isPageContext))},evaluate:function(e,t,n,r,i,s,o){function u(e,t,n){if(e){console.error(e),o(null,!1);return}i?o(null,!!n,n?null:t):o(WebInspector.RemoteObject.fromPayload(t),!!n)}if(WebInspector.debuggerModel.selectedCallFrame()){WebInspector.debuggerModel.evaluateOnSelectedCallFrame(e,t,n,r,i,s,o);return}e||(e="this"),RuntimeAgent.evaluate(e,t,n,r,this._currentExecutionContext?this._currentExecutionContext.id:undefined,i,s,u)},completionsForTextPrompt:function(e,t,n,r){var i=t.startContainer.rangeOfWord(t.startOffset," =:[({;,!+-*/&|^<>",e,"backward"),s=i.toString(),o=t.toString();this._completionsForExpression(s,o,n,r)},_completionsForExpression:function(e,t,n,r){function u(e,t){function n(e){var t;e==="string"?t=new String(""):e==="number"?t=new Number(0):e==="boolean"?t=new Boolean(!1):t=this;var n={};for(var r=t;r;r=r.__proto__)try{var i=Object.getOwnPropertyNames(r);for(var s=0;s<i.length;++s)n[i[s]]=!0}catch(o){}return n}if(!e||t){r([]);return}e.type==="object"||e.type==="function"?e.callFunctionJSON(n,undefined,f.bind(this)):(e.type==="string"||e.type==="number"||e.type==="boolean")&&this.evaluate("("+n+')("'+e.type+'")',"completion",!1,!0,!0,!1,a.bind(this))}function a(e,t,n){n&&!t?f.call(this,n.value):r([])}function f(n){RuntimeAgent.releaseObjectGroup("completion");if(!n){r([]);return}var i=!s&&!o;if(i){const u=["dir","dirxml","keys","values","profile","profileEnd","monitorEvents","unmonitorEvents","inspect","copy","clear","getEventListeners","debug","undebug","monitor","unmonitor","table","$","$$","$x"];for(var a=0;a<u.length;++a)n[u[a]]=!0}this._reportCompletions(r,s,o,e,t,Object.keys(n))}var i=e.length-1,s=e[i]===".",o=e[i]==="[";if(s||o)e=e.substr(0,i);if(e&&parseInt(e,10)==e){r([]);return}if(!t&&!e&&!n){r([]);return}!e&&WebInspector.debuggerModel.selectedCallFrame()?WebInspector.debuggerModel.getSelectedCallFrameVariables(f.bind(this)):this.evaluate(e,"completion",!0,!0,!1,!1,u.bind(this))},_reportCompletions:function(e,t,n,r,i,s){if(n)if(i.length&&i[0]==="'")var o="'";else var o='"';var u=[];if(!r){const a=["break","case","catch","continue","default","delete","do","else","finally","for","function","if","in","instanceof","new","return","switch","this","throw","try","typeof","var","void","while","with"];s=s.concat(a)}s.sort();for(var f=0;f<s.length;++f){var l=s[f];if(t&&!/^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(l))continue;n&&(/^[0-9]+$/.test(l)||(l=o+l.escapeCharacters(o+"\\")+o),l+="]");if(l.length<i.length)continue;if(i.length&&!l.startsWith(i))continue;u.push(l)}e(u)},__proto__:WebInspector.Object.prototype},WebInspector.runtimeModel=null,WebInspector.RuntimeDispatcher=function(e){this._runtimeModel=e},WebInspector.RuntimeDispatcher.prototype={executionContextCreated:function(e){this._runtimeModel._executionContextCreated(e)}},WebInspector.ExecutionContext=function(e,t,n){this.id=e,this.name=n&&!t?"<page context>":t,this.isMainWorldContext=n},WebInspector.ExecutionContext.comparator=function(e,t){return e.isMainWorldContext?-1:t.isMainWorldContext?1:e.name.localeCompare(t.name)},WebInspector.FrameExecutionContextList=function(e){this._frame=e,this._executionContexts=[]},WebInspector.FrameExecutionContextList.EventTypes={ContextsUpdated:"ContextsUpdated",ContextAdded:"ContextAdded"},WebInspector.FrameExecutionContextList.prototype={_frameNavigated:function(e){this._frame=e,this._executionContexts=[],this.dispatchEventToListeners(WebInspector.FrameExecutionContextList.EventTypes.ContextsUpdated,this)},_addExecutionContext:function(e){var t=insertionIndexForObjectInListSortedByFunction(e,this._executionContexts,WebInspector.ExecutionContext.comparator);this._executionContexts.splice(t,0,e),this.dispatchEventToListeners(WebInspector.FrameExecutionContextList.EventTypes.ContextAdded,this)},executionContexts:function(){return this._executionContexts},mainWorldContext:function(){return this._executionContexts[0]},contextBySecurityOrigin:function(e){for(var t=0;t<this._executionContexts.length;++t){var n=this._executionContexts[t];if(!n.isMainWorldContext&&n.name===e)return n}},get frameId(){return this._frame.id},get url(){return this._frame.url},get displayName(){if(!this._frame.parentFrame)return"<top frame>";var e=this._frame.name||"",t=(new WebInspector.ParsedURL(this._frame.url)).displayName;return t?e?e+"( "+t+" )":t:"<iframe>"},__proto__:WebInspector.Object.prototype};