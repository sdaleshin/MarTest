/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.UISourceCode=function(e,t,n,r,i,s,o){this._project=e,this._parentPath=t,this._name=n,this._originURL=r,this._url=i,this._contentType=s,this._isEditable=o,this._requestContentCallbacks=[],this._liveLocations=new Set,this._consoleMessages=[],this.history=[],this.isEditable()&&this._url&&this._restoreRevisionHistory(),this._formatterMapping=new WebInspector.IdentityFormatterSourceMapping},WebInspector.UISourceCode.Events={FormattedChanged:"FormattedChanged",WorkingCopyChanged:"WorkingCopyChanged",WorkingCopyCommitted:"WorkingCopyCommitted",TitleChanged:"TitleChanged",SavedStateUpdated:"SavedStateUpdated",ConsoleMessageAdded:"ConsoleMessageAdded",ConsoleMessageRemoved:"ConsoleMessageRemoved",ConsoleMessagesCleared:"ConsoleMessagesCleared",SourceMappingChanged:"SourceMappingChanged"},WebInspector.UISourceCode.prototype={get url(){return this._url},name:function(){return this._name},parentPath:function(){return this._parentPath},path:function(){return this._parentPath?this._parentPath+"/"+this._name:this._name},fullDisplayName:function(){return this._project.displayName()+"/"+(this._parentPath?this._parentPath+"/":"")+this.displayName(!0)},displayName:function(e){var t=this.name()||WebInspector.UIString("(index)");return e?t:t.trimEnd(100)},uri:function(){var e=this.path();return this._project.id()?e?this._project.id()+"/"+e:this._project.id():e},originURL:function(){return this._originURL},canRename:function(){return this._project.canRename()},rename:function(e,t){function n(e,n){e&&this._updateName(n),t(e)}this._project.rename(this,e,n.bind(this))},_updateName:function(e){var t=this.uri();this._name=e,this._url=e,this._originURL=e,this.dispatchEventToListeners(WebInspector.UISourceCode.Events.TitleChanged,t)},contentURL:function(){return this.originURL()},contentType:function(){return this._contentType},scriptFile:function(){return this._scriptFile},setScriptFile:function(e){this._scriptFile=e},styleFile:function(){return this._styleFile},setStyleFile:function(e){this._styleFile=e},project:function(){return this._project},requestMetadata:function(e){this._project.requestMetadata(this,e)},requestContent:function(e){if(this._content||this._contentLoaded){e(this._content,!1,this._mimeType);return}this._requestContentCallbacks.push(e),this._requestContentCallbacks.length===1&&this._project.requestFileContent(this,this._fireContentAvailable.bind(this))},checkContentUpdated:function(e){function t(t){if(t===null){var n=this.workingCopy();this._commitContent("",!1),this.setWorkingCopy(n),delete this._checkingContent,e&&e();return}if(typeof this._lastAcceptedContent=="string"&&this._lastAcceptedContent===t){delete this._checkingContent,e&&e();return}if(this._content===t){delete this._lastAcceptedContent,delete this._checkingContent,e&&e();return}if(!this.isDirty()){this._commitContent(t,!1),delete this._checkingContent,e&&e();return}var r=window.confirm(WebInspector.UIString("This file was changed externally. Would you like to reload it?"));r?this._commitContent(t,!1):this._lastAcceptedContent=t,delete this._checkingContent,e&&e()}if(!this._project.canSetFileContent())return;if(this._checkingContent)return;this._checkingContent=!0,this._project.requestFileContent(this,t.bind(this))},requestOriginalContent:function(e){this._project.requestFileContent(this,e)},_commitContent:function(e,t){delete this._lastAcceptedContent,this._content=e,this._contentLoaded=!0;var n=this.history.length?this.history[this.history.length-1]:null;if(!n||n._content!==this._content){var r=new WebInspector.Revision(this,this._content,new Date);this.history.push(r),r._persist()}this._innerResetWorkingCopy(),this._hasCommittedChanges=!0,this.dispatchEventToListeners(WebInspector.UISourceCode.Events.WorkingCopyCommitted),this._url&&WebInspector.fileManager.isURLSaved(this._url)&&this._saveURLWithFileManager(!1,this._content),t&&this._project.setFileContent(this,this._content,function(){})},_saveURLWithFileManager:function(e,t){function n(){this._savedWithFileManager=!0,this.dispatchEventToListeners(WebInspector.UISourceCode.Events.SavedStateUpdated)}WebInspector.fileManager.save(this._url,t,e,n.bind(this)),WebInspector.fileManager.close(this._url)},saveToFileSystem:function(e){if(this.isDirty()){this._saveURLWithFileManager(e,this.workingCopy()),this.commitWorkingCopy(function(){});return}this.requestContent(this._saveURLWithFileManager.bind(this,e))},hasUnsavedCommittedChanges:function(){var e=WebInspector.extensionServer.hasSubscribers(WebInspector.extensionAPI.Events.ResourceContentCommitted);return this._savedWithFileManager||this.project().canSetFileContent()||e?!1:!!this._hasCommittedChanges},addRevision:function(e){this._commitContent(e,!0)},_restoreRevisionHistory:function(){function n(e){return WebInspector.resourceTreeModel.mainFrame?e.loaderId===WebInspector.resourceTreeModel.mainFrame.loaderId:!1}if(!window.localStorage)return;var e=WebInspector.Revision._revisionHistoryRegistry(),t=e[this.url];if(!t)return;t=t.filter(n);if(!t.length)return;for(var r=0;r<t.length;++r){var i=window.localStorage[t[r].key],s=new Date(t[r].timestamp),o=new WebInspector.Revision(this,i,s);this.history.push(o)}this._content=this.history[this.history.length-1].content,this._hasCommittedChanges=!0,this._contentLoaded=!0,this._mimeType=this.canonicalMimeType()},_clearRevisionHistory:function(){if(!window.localStorage)return;var e=WebInspector.Revision._revisionHistoryRegistry(),t=e[this.url];for(var n=0;t&&n<t.length;++n)delete window.localStorage[t[n].key];delete e[this.url],window.localStorage["revision-history"]=JSON.stringify(e)},revertToOriginal:function(){function e(e,t,n){if(typeof e!="string")return;this.addRevision(e)}this.requestOriginalContent(e.bind(this)),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.ApplyOriginalContent,url:this.url})},revertAndClearHistory:function(e){function t(t,n,r){if(typeof t!="string")return;this.addRevision(t),this._clearRevisionHistory(),this.history=[],e(this)}this.requestOriginalContent(t.bind(this)),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.RevertRevision,url:this.url})},isEditable:function(){return this._isEditable},workingCopy:function(){return this._workingCopyGetter&&(this._workingCopy=this._workingCopyGetter(),delete this._workingCopyGetter),this.isDirty()?this._workingCopy:this._content},resetWorkingCopy:function(){this._innerResetWorkingCopy(),this.dispatchEventToListeners(WebInspector.UISourceCode.Events.WorkingCopyChanged)},_innerResetWorkingCopy:function(){delete this._workingCopy,delete this._workingCopyGetter},setWorkingCopy:function(e){this._mimeType||(this._mimeType=this.canonicalMimeType()),this._workingCopy=e,delete this._workingCopyGetter,this.dispatchEventToListeners(WebInspector.UISourceCode.Events.WorkingCopyChanged)},setWorkingCopyGetter:function(e){this._workingCopyGetter=e,this.dispatchEventToListeners(WebInspector.UISourceCode.Events.WorkingCopyChanged)},removeWorkingCopyGetter:function(){if(!this._workingCopyGetter)return;this._workingCopy=this._workingCopyGetter(),delete this._workingCopyGetter},commitWorkingCopy:function(e){if(!this.isDirty()){e(null);return}this._commitContent(this.workingCopy(),!0),e(null),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.FileSaved,url:this.url})},isDirty:function(){return typeof this._workingCopy!="undefined"||typeof this._workingCopyGetter!="undefined"},mimeType:function(){return this._mimeType},canonicalMimeType:function(){return this.contentType().canonicalMimeType()||this._mimeType},content:function(){return this._content},searchInContent:function(e,t,n,r){var i=this.content();if(i){var s=new WebInspector.StaticContentProvider(this.contentType(),i);s.searchInContent(e,t,n,r);return}this._project.searchInFileContent(this,e,t,n,r)},_fireContentAvailable:function(e,t,n){this._contentLoaded=!0,this._mimeType=n,this._content=e;var r=this._requestContentCallbacks.slice();this._requestContentCallbacks=[];for(var i=0;i<r.length;++i)r[i](e,t,n);this._formatOnLoad&&(delete this._formatOnLoad,this.setFormatted(!0))},contentLoaded:function(){return this._contentLoaded},uiLocationToRawLocation:function(e,t){if(!this._sourceMapping)return null;var n=this._formatterMapping.formattedToOriginal(e,t);return this._sourceMapping.uiLocationToRawLocation(this,n[0],n[1])},addLiveLocation:function(e){this._liveLocations.add(e)},removeLiveLocation:function(e){this._liveLocations.remove(e)},updateLiveLocations:function(){var e=this._liveLocations.items();for(var t=0;t<e.length;++t)e[t].update()},overrideLocation:function(e){var t=this._formatterMapping.originalToFormatted(e.lineNumber,e.columnNumber);return e.lineNumber=t[0],e.columnNumber=t[1],e},consoleMessages:function(){return this._consoleMessages},consoleMessageAdded:function(e){this._consoleMessages.push(e),this.dispatchEventToListeners(WebInspector.UISourceCode.Events.ConsoleMessageAdded,e)},consoleMessageRemoved:function(e){this._consoleMessages.remove(e),this.dispatchEventToListeners(WebInspector.UISourceCode.Events.ConsoleMessageRemoved,e)},consoleMessagesCleared:function(){this._consoleMessages=[],this.dispatchEventToListeners(WebInspector.UISourceCode.Events.ConsoleMessagesCleared)},formatted:function(){return!!this._formatted},setFormatted:function(e){function t(t,n,r){function s(e,t){this._content=e,this._innerResetWorkingCopy(),this._formatterMapping=t,this.dispatchEventToListeners(WebInspector.UISourceCode.Events.FormattedChanged,{content:e}),this.updateLiveLocations()}var i;e?i=WebInspector.Formatter.createFormatter(this.contentType()):i=new WebInspector.IdentityFormatter,i.formatContent(r,t||"",s.bind(this))}if(!this.contentLoaded()){this._formatOnLoad=e;return}if(this._formatted===e)return;if(this.isDirty())return;this._formatted=e,this._contentLoaded=!1,this._content=!1,WebInspector.UISourceCode.prototype.requestContent.call(this,t.bind(this))},createFormatter:function(){return null},setSourceMapping:function(e){var t=this._sourceMapping?this._sourceMapping.isIdentity():!0;this._sourceMapping=e;var n={};n.isIdentity=e?e.isIdentity():!0,n.identityHasChanged=n.isIdentity!==t,this.dispatchEventToListeners(WebInspector.UISourceCode.Events.SourceMappingChanged,n)},__proto__:WebInspector.Object.prototype},WebInspector.UILocation=function(e,t,n){this.uiSourceCode=e,this.lineNumber=t,this.columnNumber=n},WebInspector.UILocation.prototype={uiLocationToRawLocation:function(){return this.uiSourceCode.uiLocationToRawLocation(this.lineNumber,this.columnNumber)},url:function(){return this.uiSourceCode.contentURL()},linkText:function(){var e=this.uiSourceCode.displayName();return typeof this.lineNumber=="number"&&(e+=":"+(this.lineNumber+1)),e}},WebInspector.RawLocation=function(){},WebInspector.LiveLocation=function(e,t){this._rawLocation=e,this._updateDelegate=t,this._uiSourceCodes=[]},WebInspector.LiveLocation.prototype={update:function(){var e=this.uiLocation();if(e){var t=e.uiSourceCode;this._uiSourceCodes.indexOf(t)===-1&&(t.addLiveLocation(this),this._uiSourceCodes.push(t));var n=this._updateDelegate(e);n&&this.dispose()}},rawLocation:function(){return this._rawLocation},uiLocation:function(){},dispose:function(){for(var e=0;e<this._uiSourceCodes.length;++e)this._uiSourceCodes[e].removeLiveLocation(this);this._uiSourceCodes=[]}},WebInspector.Revision=function(e,t,n){this._uiSourceCode=e,this._content=t,this._timestamp=n},WebInspector.Revision._revisionHistoryRegistry=function(){if(!WebInspector.Revision._revisionHistoryRegistryObject)if(window.localStorage){var e=window.localStorage["revision-history"];try{WebInspector.Revision._revisionHistoryRegistryObject=e?JSON.parse(e):{}}catch(t){WebInspector.Revision._revisionHistoryRegistryObject={}}}else WebInspector.Revision._revisionHistoryRegistryObject={};return WebInspector.Revision._revisionHistoryRegistryObject},WebInspector.Revision.filterOutStaleRevisions=function(){function u(){window.localStorage["revision-history"]=JSON.stringify(t)}if(!window.localStorage)return;var e=WebInspector.Revision._revisionHistoryRegistry(),t={};for(var n in e){var r=e[n],i=[];for(var s=0;r&&s<r.length;++s){var o=r[s];o.loaderId===WebInspector.resourceTreeModel.mainFrame.loaderId?(i.push(o),t[n]=i):delete window.localStorage[o.key]}}WebInspector.Revision._revisionHistoryRegistryObject=t,setTimeout(u,0)},WebInspector.Revision.prototype={get uiSourceCode(){return this._uiSourceCode},get timestamp(){return this._timestamp},get content(){return this._content||null},revertToThis:function(){function e(e){this._uiSourceCode._content!==e&&this._uiSourceCode.addRevision(e)}this.requestContent(e.bind(this))},contentURL:function(){return this._uiSourceCode.originURL()},contentType:function(){return this._uiSourceCode.contentType()},requestContent:function(e){e(this._content||"",!1,this.uiSourceCode.canonicalMimeType())},searchInContent:function(e,t,n,r){r([])},_persist:function(){function o(){window.localStorage[r]=this._content,window.localStorage["revision-history"]=JSON.stringify(i)}if(this._uiSourceCode.project().type()===WebInspector.projectTypes.FileSystem)return;if(!window.localStorage)return;var e=this.contentURL();if(!e||e.startsWith("inspector://"))return;var t=WebInspector.resourceTreeModel.mainFrame.loaderId,n=this.timestamp.getTime(),r="revision-history|"+e+"|"+t+"|"+n,i=WebInspector.Revision._revisionHistoryRegistry(),s=i[e];s||(s=[],i[e]=s),s.push({url:e,loaderId:t,timestamp:n,key:r}),setTimeout(o.bind(this),0)}};