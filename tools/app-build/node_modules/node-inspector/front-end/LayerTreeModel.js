/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.LayerTreeModel=function(){WebInspector.Object.call(this),this._layersById={},InspectorBackend.registerLayerTreeDispatcher(new WebInspector.LayerTreeDispatcher(this)),LayerTreeAgent.enable(),this._needsRefresh=!0},WebInspector.LayerTreeModel.Events={LayerTreeChanged:"LayerTreeChanged"},WebInspector.LayerTreeModel.prototype={dispose:function(){LayerTreeAgent.disable()},root:function(){return this._root},contentRoot:function(){return this._contentRoot},forEachLayer:function(e,t){if(!t){t=this.root();if(!t)return!1}return e(t)||t.children().some(this.forEachLayer.bind(this,e))},requestLayers:function(e){function t(e,t){this._root=null,this._contentRoot=null,e&&(console.error("LayerTreeAgent.getLayers(): "+e),t=[]),this._repopulate(t);for(var n=0;n<this._pendingRequestLayersCallbacks.length;++n)this._pendingRequestLayersCallbacks[n]();delete this._pendingRequestLayersCallbacks}function n(){LayerTreeAgent.getLayers(undefined,t.bind(this))}delete this._delayedRequestLayersTimer,e||(e=function(){});if(!this._needsRefresh){e();return}if(this._pendingRequestLayersCallbacks){this._pendingRequestLayersCallbacks.push(e);return}this._pendingRequestLayersCallbacks=[],this._pendingRequestLayersCallbacks.push(e),WebInspector.domAgent.requestDocument(n.bind(this))},layerById:function(e){return this._layersById[e]},_repopulate:function(e){var t=this._layersById;this._layersById={};for(var n=0;n<e.length;++n){var r=t[e[n].layerId];r?r._reset(e[n]):r=new WebInspector.Layer(e[n]),this._layersById[r.id()]=r;var i=r.parentId();!this._contentRoot&&r.nodeId()&&(this._contentRoot=r);if(i){var s=this._layersById[i];s||console.assert(s,"missing parent "+i+" for layer "+r.id()),s.addChild(r)}else this._root&&console.assert(!1,"Multiple root layers"),this._root=r}this.dispatchEventToListeners(WebInspector.LayerTreeModel.Events.LayerTreeChanged)},_layerTreeChanged:function(){if(this._delayedRequestLayersTimer)return;this._needsRefresh=!0,this._delayedRequestLayersTimer=setTimeout(this.requestLayers.bind(this),100)},__proto__:WebInspector.Object.prototype},WebInspector.Layer=function(e){this._reset(e)},WebInspector.Layer.prototype={id:function(){return this._layerPayload.layerId},parentId:function(){return this._layerPayload.parentLayerId},parent:function(){return this._parent},isRoot:function(){return!this.parentId()},children:function(){return this._children},addChild:function(e){e._parent&&console.assert(!1,"Child already has a parent"),this._children.push(e),e._parent=this},nodeId:function(){return this._layerPayload.nodeId},nodeIdForSelfOrAncestor:function(){for(var e=this;e;e=e._parent){var t=e._layerPayload.nodeId;if(t)return t}return null},offsetX:function(){return this._layerPayload.offsetX},offsetY:function(){return this._layerPayload.offsetY},width:function(){return this._layerPayload.width},height:function(){return this._layerPayload.height},transform:function(){return this._layerPayload.transform},anchorPoint:function(){return[this._layerPayload.anchorX||0,this._layerPayload.anchorY||0,this._layerPayload.anchorZ||0]},invisible:function(){return this._layerPayload.invisible},paintCount:function(){return this._layerPayload.paintCount},requestCompositingReasons:function(e){function t(t,n){if(t){console.error("LayerTreeAgent.reasonsForCompositingLayer(): "+t),e(null);return}e(n)}LayerTreeAgent.compositingReasons(this.id(),t.bind(this))},_reset:function(e){this._children=[],this._parent=null,this._layerPayload=e}},WebInspector.LayerTreeDispatcher=function(e){this._layerTreeModel=e},WebInspector.LayerTreeDispatcher.prototype={layerTreeDidChange:function(){this._layerTreeModel._layerTreeChanged()}};