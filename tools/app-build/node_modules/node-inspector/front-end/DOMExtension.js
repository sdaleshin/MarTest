/*
 * Copyright (C) 2007 Apple Inc.  All rights reserved.
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Contains diff method based on Javascript Diff Algorithm By John Resig
 * http://ejohn.org/files/jsdiff.js (released under the MIT license).
 */

function removeSubsequentNodes(e,t){for(var n=e;n&&n!==t;){var r=n;n=n.nextSibling,r.remove()}}function Size(e,t){this.width=e,this.height=t}function AnchorBox(e,t,n,r){this.x=e||0,this.y=t||0,this.width=n||0,this.height=r||0}function isEnterKey(e){return e.keyCode!==229&&e.keyIdentifier==="Enter"}function consumeEvent(e){e.consume()}function NonLeakingMutationObserver(e){this._observer=new WebKitMutationObserver(e),NonLeakingMutationObserver._instances.push(this),NonLeakingMutationObserver._unloadListener||(NonLeakingMutationObserver._unloadListener=function(){while(NonLeakingMutationObserver._instances.length)NonLeakingMutationObserver._instances[NonLeakingMutationObserver._instances.length-1].disconnect()},window.addEventListener("unload",NonLeakingMutationObserver._unloadListener,!1))}Node.prototype.rangeOfWord=function(e,t,n,r){var i,s=0,o,u=0;n||(n=this);if(!r||r==="backward"||r==="both"){var a=this;while(a){if(a===n){i||(i=n);break}if(a.nodeType===Node.TEXT_NODE){var f=a===this?e-1:a.nodeValue.length-1;for(var l=f;l>=0;--l)if(t.indexOf(a.nodeValue[l])!==-1){i=a,s=l+1;break}}if(i)break;a=a.traversePreviousNode(n)}i||(i=n,s=0)}else i=this,s=e;if(!r||r==="forward"||r==="both"){a=this;while(a){if(a===n){o||(o=n);break}if(a.nodeType===Node.TEXT_NODE){var f=a===this?e:0;for(var l=f;l<a.nodeValue.length;++l)if(t.indexOf(a.nodeValue[l])!==-1){o=a,u=l;break}}if(o)break;a=a.traverseNextNode(n)}o||(o=n,u=n.nodeType===Node.TEXT_NODE?n.nodeValue.length:n.childNodes.length)}else o=this,u=e;var c=this.ownerDocument.createRange();return c.setStart(i,s),c.setEnd(o,u),c},Node.prototype.traverseNextTextNode=function(e){var t=this.traverseNextNode(e);if(!t)return;while(t&&t.nodeType!==Node.TEXT_NODE)t=t.traverseNextNode(e);return t},Node.prototype.rangeBoundaryForOffset=function(e){var t=this.traverseNextTextNode(this);while(t&&e>t.nodeValue.length)e-=t.nodeValue.length,t=t.traverseNextTextNode(this);return t?{container:t,offset:e}:{container:this,offset:0}},Element.prototype.removeStyleClass=function(e){this.classList.remove(e)},Element.prototype.removeMatchingStyleClasses=function(e){var t=new RegExp("(^|\\s+)"+e+"($|\\s+)");t.test(this.className)&&(this.className=this.className.replace(t," "))},Element.prototype.addStyleClass=function(e){this.classList.add(e)},Element.prototype.hasStyleClass=function(e){return this.classList.contains(e)},Element.prototype.enableStyleClass=function(e,t){t?this.addStyleClass(e):this.removeStyleClass(e)},Element.prototype.positionAt=function(e,t){typeof e=="number"?this.style.setProperty("left",e+"px"):this.style.removeProperty("left"),typeof t=="number"?this.style.setProperty("top",t+"px"):this.style.removeProperty("top")},Element.prototype.isScrolledToBottom=function(){return this.scrollTop+this.clientHeight===this.scrollHeight},Element.prototype.measurePreferredSize=function(e){e=e||document.body,e.appendChild(this),this.positionAt(0,0);var t=new Size(this.offsetWidth,this.offsetHeight);return this.positionAt(undefined,undefined),this.remove(),t},Node.prototype.enclosingNodeOrSelfWithNodeNameInArray=function(e){for(var t=this;t&&t!==this.ownerDocument;t=t.parentNode)for(var n=0;n<e.length;++n)if(t.nodeName.toLowerCase()===e[n].toLowerCase())return t;return null},Node.prototype.enclosingNodeOrSelfWithNodeName=function(e){return this.enclosingNodeOrSelfWithNodeNameInArray([e])},Node.prototype.enclosingNodeOrSelfWithClass=function(e,t){for(var n=this;n&&n!==t&&n!==this.ownerDocument;n=n.parentNode)if(n.nodeType===Node.ELEMENT_NODE&&n.hasStyleClass(e))return n;return null},Element.prototype.query=function(e){return this.ownerDocument.evaluate(e,this,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},Element.prototype.removeChildren=function(){this.firstChild&&(this.textContent="")},Element.prototype.isInsertionCaretInside=function(){var e=window.getSelection();if(!e.rangeCount||!e.isCollapsed)return!1;var t=e.getRangeAt(0);return t.startContainer.isSelfOrDescendant(this)},Element.prototype.createChild=function(e,t){var n=this.ownerDocument.createElement(e);return t&&(n.className=t),this.appendChild(n),n},DocumentFragment.prototype.createChild=Element.prototype.createChild,Element.prototype.createTextChild=function(e){var t=this.ownerDocument.createTextNode(e);return this.appendChild(t),t},DocumentFragment.prototype.createTextChild=Element.prototype.createTextChild,Element.prototype.totalOffsetLeft=function(){return this.totalOffset().left},Element.prototype.totalOffsetTop=function(){return this.totalOffset().top},Element.prototype.totalOffset=function(){var e=0,t=0;for(var n=this;n;n=n.offsetParent)e+=n.offsetLeft,t+=n.offsetTop,this!==n&&(e+=n.clientLeft-n.scrollLeft,t+=n.clientTop-n.scrollTop);return{left:e,top:t}},Element.prototype.scrollOffset=function(){var e=0,t=0;for(var n=this;n;n=n.scrollParent)e+=n.scrollLeft,t+=n.scrollTop;return{left:e,top:t}},Element.prototype.offsetRelativeToWindow=function(e){var t=new AnchorBox,n=this,r=this.ownerDocument.defaultView;while(r&&n){t.x+=n.totalOffsetLeft(),t.y+=n.totalOffsetTop();if(r===e)break;n=r.frameElement,r=r.parent}return t},Element.prototype.boxInWindow=function(e){e=e||this.ownerDocument.defaultView;var t=this.offsetRelativeToWindow(window);return t.width=Math.min(this.offsetWidth,window.innerWidth-t.x),t.height=Math.min(this.offsetHeight,window.innerHeight-t.y),t},Element.prototype.setTextAndTitle=function(e){this.textContent=e,this.title=e},KeyboardEvent.prototype.__defineGetter__("data",function(){switch(this.type){case"keypress":return!this.ctrlKey&&!this.metaKey?String.fromCharCode(this.charCode):"";case"keydown":case"keyup":return!this.ctrlKey&&!this.metaKey&&!this.altKey?String.fromCharCode(this.which):""}}),Event.prototype.consume=function(e){this.stopImmediatePropagation(),e&&this.preventDefault(),this.handled=!0},Text.prototype.select=function(e,t){e=e||0,t=t||this.textContent.length,e<0&&(e=t+e);var n=this.ownerDocument.defaultView.getSelection();n.removeAllRanges();var r=this.ownerDocument.createRange();return r.setStart(this,e),r.setEnd(this,t),n.addRange(r),this},Element.prototype.selectionLeftOffset=function(){var e=window.getSelection();if(!e.containsNode(this,!0))return null;var t=e.anchorOffset,n=e.anchorNode;while(n!==this){while(n.previousSibling)n=n.previousSibling,t+=n.textContent.length;n=n.parentNode}return t},Node.prototype.isAncestor=function(e){if(!e)return!1;var t=e.parentNode;while(t){if(this===t)return!0;t=t.parentNode}return!1},Node.prototype.isDescendant=function(e){return!!e&&e.isAncestor(this)},Node.prototype.isSelfOrAncestor=function(e){return!!e&&(e===this||this.isAncestor(e))},Node.prototype.isSelfOrDescendant=function(e){return!!e&&(e===this||this.isDescendant(e))},Node.prototype.traverseNextNode=function(e){var t=this.firstChild;if(t)return t;if(e&&this===e)return null;t=this.nextSibling;if(t)return t;t=this;while(t&&!t.nextSibling&&(!e||!t.parentNode||t.parentNode!==e))t=t.parentNode;return t?t.nextSibling:null},Node.prototype.traversePreviousNode=function(e){if(e&&this===e)return null;var t=this.previousSibling;while(t&&t.lastChild)t=t.lastChild;return t?t:this.parentNode},NonLeakingMutationObserver._instances=[],NonLeakingMutationObserver.prototype={observe:function(e,t){this._observer&&this._observer.observe(e,t)},disconnect:function(){this._observer&&this._observer.disconnect(),NonLeakingMutationObserver._instances.remove(this),delete this._observer}};