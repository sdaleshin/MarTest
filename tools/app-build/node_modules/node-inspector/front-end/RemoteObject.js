/*
 * Copyright (C) 2009 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.RemoteObject=function(e,t,n,r,i,s){this._type=t,this._subtype=n,e?(this._objectId=e,this._description=i,this._hasChildren=!0,this._preview=s):(console.assert(t!=="object"||r===null),this._description=i||r+"",this._hasChildren=!1,this.value=r)},WebInspector.RemoteObject.fromPrimitiveValue=function(e){return new WebInspector.RemoteObject(undefined,typeof e,undefined,e)},WebInspector.RemoteObject.fromLocalObject=function(e){return new WebInspector.LocalJSONObject(e)},WebInspector.RemoteObject.resolveNode=function(e,t,n){function r(e,t){if(!n)return;e||!t?n(null):n(WebInspector.RemoteObject.fromPayload(t))}DOMAgent.resolveNode(e.id,t,r)},WebInspector.RemoteObject.fromPayload=function(e){return console.assert(typeof e=="object","Remote object payload should only be an object"),new WebInspector.RemoteObject(e.objectId,e.type,e.subtype,e.value,e.description,e.preview)},WebInspector.RemoteObject.type=function(e){if(e===null)return"null";var t=typeof e;return t!=="object"&&t!=="function"?t:e.type},WebInspector.RemoteObject.prototype={get objectId(){return this._objectId},get type(){return this._type},get subtype(){return this._subtype},get description(){return this._description},get hasChildren(){return this._hasChildren},get preview(){return this._preview},getOwnProperties:function(e){this.doGetProperties(!0,!1,e)},getAllProperties:function(e,t){this.doGetProperties(!1,e,t)},doGetProperties:function(e,t,n){function r(e,t,r){if(e){n(null,null);return}var i=[];for(var s=0;t&&s<t.length;++s){var o=t[s];i.push(new WebInspector.RemoteObjectProperty(o.name,null,o))}var u=null;if(r){u=[];for(var s=0;s<r.length;s++){var o=r[s];u.push(new WebInspector.RemoteObjectProperty(o.name,WebInspector.RemoteObject.fromPayload(o.value)))}}n(i,u)}if(!this._objectId){n([],null);return}RuntimeAgent.getProperties(this._objectId,e,t,r)},setPropertyValue:function(e,t,n){function r(t,r,i){if(t||i){n(t||r.description);return}this.doSetObjectPropertyValue(r,e,n),r.objectId&&RuntimeAgent.releaseObject(r.objectId)}if(!this._objectId){n("Can't set a property of non-object.");return}RuntimeAgent.evaluate.invoke({expression:t,doNotPauseOnExceptionsAndMuteConsole:!0},r.bind(this))},doSetObjectPropertyValue:function(e,t,n){function i(e,t,r){if(e||r){n(e||t.description);return}n()}var r="function(a, b) { this[a] = b; }";e.type==="number"&&typeof e.value!="number"&&(r="function(a) { this[a] = "+e.description+"; }"),delete e.description,RuntimeAgent.callFunctionOn(this._objectId,r,[{value:t},e],!0,undefined,undefined,i.bind(this))},pushNodeToFrontend:function(e){this._objectId?WebInspector.domAgent.pushNodeToFrontend(this._objectId,e):e(0)},highlightAsDOMNode:function(){WebInspector.domAgent.highlightDOMNode(undefined,undefined,this._objectId)},hideDOMNodeHighlight:function(){WebInspector.domAgent.hideDOMNodeHighlight()},callFunction:function(e,t,n){function r(e,t,r){if(!n)return;n(e||r?null:WebInspector.RemoteObject.fromPayload(t))}RuntimeAgent.callFunctionOn(this._objectId,e.toString(),t,!0,undefined,undefined,r)},callFunctionJSON:function(e,t,n){function r(e,t,r){n(e||r?null:t.value)}RuntimeAgent.callFunctionOn(this._objectId,e.toString(),t,!0,!0,!1,r)},release:function(){if(!this._objectId)return;RuntimeAgent.releaseObject(this._objectId)},arrayLength:function(){if(this.subtype!=="array")return 0;var e=this._description.match(/\[([0-9]+)\]/);return e?parseInt(e[1],10):0}},WebInspector.RemoteObject.loadFromObject=function(e,t,n){t?e.getAllProperties(!1,n):WebInspector.RemoteObject.loadFromObjectPerProto(e,n)},WebInspector.RemoteObject.loadFromObjectPerProto=function(e,t){function o(){if(--s)return;if(n&&r){var e=r.slice(0);for(var o=0;o<n.length;o++){var u=n[o];u.isAccessorProperty()||e.push(u)}return t(e,i?i:null)}t(null,null)}function u(e,t){r=e,o()}function a(e,t){n=e,i=t,o()}var n,r,i,s=2;e.getAllProperties(!0,u),e.getOwnProperties(a)},WebInspector.ScopeRemoteObject=function(e,t,n,r,i,s,o){WebInspector.RemoteObject.call(this,e,n,r,i,s,o),this._scopeRef=t,this._savedScopeProperties=undefined},WebInspector.ScopeRemoteObject.fromPayload=function(e,t){return t?new WebInspector.ScopeRemoteObject(e.objectId,t,e.type,e.subtype,e.value,e.description,e.preview):new WebInspector.RemoteObject(e.objectId,e.type,e.subtype,e.value,e.description,e.preview)},WebInspector.ScopeRemoteObject.prototype={doGetProperties:function(e,t,n){function r(e,t){this._scopeRef&&e instanceof Array&&(this._savedScopeProperties=e.slice()),n(e,t)}if(t){n([],[]);return}if(this._savedScopeProperties){n(this._savedScopeProperties.slice(),[]);return}WebInspector.RemoteObject.prototype.doGetProperties.call(this,e,t,r.bind(this))},doSetObjectPropertyValue:function(e,t,n){function i(r){if(r){n(r);return}if(this._savedScopeProperties)for(var i=0;i<this._savedScopeProperties.length;i++)this._savedScopeProperties[i].name===t&&(this._savedScopeProperties[i].value=WebInspector.RemoteObject.fromPayload(e));n()}var r;switch(e.type){case"undefined":r={};break;case"object":case"function":r={objectId:e.objectId};break;default:r={value:e.value}}DebuggerAgent.setVariableValue(this._scopeRef.number,t,r,this._scopeRef.callFrameId,this._scopeRef.functionId,i.bind(this))},__proto__:WebInspector.RemoteObject.prototype},WebInspector.ScopeRef=function(e,t,n){this.number=e,this.callFrameId=t,this.functionId=n},WebInspector.RemoteObjectProperty=function(e,t,n){this.name=e,this.enumerable=n?!!n.enumerable:!0,this.writable=n?!!n.writable:!0,t===null&&n?(n.value&&(this.value=WebInspector.RemoteObject.fromPayload(n.value)),n.get&&n.get.type!=="undefined"&&(this.getter=WebInspector.RemoteObject.fromPayload(n.get)),n.set&&n.set.type!=="undefined"&&(this.setter=WebInspector.RemoteObject.fromPayload(n.set))):this.value=t,n&&(this.isOwn=n.isOwn,this.wasThrown=!!n.wasThrown)},WebInspector.RemoteObjectProperty.prototype={isAccessorProperty:function(){return this.getter||this.setter}},WebInspector.RemoteObjectProperty.fromPrimitiveValue=function(e,t){return new WebInspector.RemoteObjectProperty(e,WebInspector.RemoteObject.fromPrimitiveValue(t))},WebInspector.RemoteObjectProperty.fromScopeValue=function(e,t){var n=new WebInspector.RemoteObjectProperty(e,t);return n.writable=!1,n},WebInspector.LocalJSONObject=function(e){this._value=e},WebInspector.LocalJSONObject.prototype={get description(){if(this._cachedDescription)return this._cachedDescription;if(this.type==="object")switch(this.subtype){case"array":function e(e){return e.value.description}this._cachedDescription=this._concatenate("[","]",e);break;case"date":this._cachedDescription=""+this._value;break;case"null":this._cachedDescription="null";break;default:function t(e){return e.name+":"+e.value.description}this._cachedDescription=this._concatenate("{","}",t)}else this._cachedDescription=String(this._value);return this._cachedDescription},_concatenate:function(e,t,n){const r=100;var i=e,s=this._children();for(var o=0;o<s.length;++o){var u=n(s[o]);if(i.length+u.length>r){i+=",â€¦";break}o&&(i+=", "),i+=u}return i+=t,i},get type(){return typeof this._value},get subtype(){return this._value===null?"null":this._value instanceof Array?"array":this._value instanceof Date?"date":undefined},get hasChildren(){return typeof this._value!="object"||this._value===null?!1:!!Object.keys(this._value).length},getOwnProperties:function(e){e(this._children())},getAllProperties:function(e,t){e?t([]):t(this._children())},_children:function(){function t(e){return new WebInspector.RemoteObjectProperty(e,new WebInspector.LocalJSONObject(this._value[e]))}if(!this.hasChildren)return[];var e=this._value;return this._cachedChildren||(this._cachedChildren=Object.keys(e).map(t.bind(this))),this._cachedChildren},isError:function(){return!1},arrayLength:function(){return this._value instanceof Array?this._value.length:0}};