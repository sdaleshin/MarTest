/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ScriptSnippetModel=function(e){this._workspace=e,this._uiSourceCodeForScriptId={},this._scriptForUISourceCode=new Map,this._uiSourceCodeForSnippetId={},this._snippetIdForUISourceCode=new Map,this._snippetStorage=new WebInspector.SnippetStorage("script","Script snippet #"),this._lastSnippetEvaluationIndexSetting=WebInspector.settings.createSetting("lastSnippetEvaluationIndex",0),this._snippetScriptMapping=new WebInspector.SnippetScriptMapping(this),this._projectDelegate=new WebInspector.SnippetsProjectDelegate(this),this._project=this._workspace.addProject(this._projectDelegate),this.reset(),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.GlobalObjectCleared,this._debuggerReset,this)},WebInspector.ScriptSnippetModel.prototype={get scriptMapping(){return this._snippetScriptMapping},project:function(){return this._project},_loadSnippets:function(){var e=this._snippetStorage.snippets();for(var t=0;t<e.length;++t)this._addScriptSnippet(e[t])},createScriptSnippet:function(){var e=this._snippetStorage.createSnippet();return this._addScriptSnippet(e)},_addScriptSnippet:function(e){var t=this._projectDelegate.addSnippet(e.name,new WebInspector.SnippetContentProvider(e)),n=this._workspace.uiSourceCode(this._projectDelegate.id(),t),r=new WebInspector.SnippetScriptFile(this,n);return n.setScriptFile(r),this._snippetIdForUISourceCode.put(n,e.id),n.setSourceMapping(this._snippetScriptMapping),this._uiSourceCodeForSnippetId[e.id]=n,t},deleteScriptSnippet:function(e){var t=this._workspace.uiSourceCode(this._projectDelegate.id(),e),n=this._snippetIdForUISourceCode.get(t)||"",r=this._snippetStorage.snippetForId(n);this._snippetStorage.deleteSnippet(r),this._removeBreakpoints(t),this._releaseSnippetScript(t),delete this._uiSourceCodeForSnippetId[r.id],this._snippetIdForUISourceCode.remove(t),this._projectDelegate.removeFile(r.name)},renameScriptSnippet:function(e,t,n){t=t.trim();if(!t||t.indexOf("/")!==-1||e===t||this._snippetStorage.snippetForName(t)){n(!1);return}var r=this._snippetStorage.snippetForName(e);console.assert(r,"Snippet '"+e+"' was not found.");var i=this._uiSourceCodeForSnippetId[r.id];console.assert(i,"No uiSourceCode was found for snippet '"+e+"'.");var s=this._removeBreakpoints(i);r.name=t,this._restoreBreakpoints(i,s),n(!0,t)},_setScriptSnippetContent:function(e,t){var n=this._snippetStorage.snippetForName(e);n.content=t},_scriptSnippetEdited:function(e){var t=this._scriptForUISourceCode.get(e);if(!t)return;var n=this._removeBreakpoints(e);this._releaseSnippetScript(e),this._restoreBreakpoints(e,n);var r=t.rawLocationToUILocation(0,0).uiSourceCode;r&&this._restoreBreakpoints(r,n)},_nextEvaluationIndex:function(e){var t=this._lastSnippetEvaluationIndexSetting.get()+1;return this._lastSnippetEvaluationIndexSetting.set(t),t},evaluateScriptSnippet:function(e){function o(t,n,i){if(!e||e._evaluationIndex!==r)return;if(t){console.error(t);return}if(!n){var s=WebInspector.ConsoleMessage.create(WebInspector.ConsoleMessage.MessageSource.JS,WebInspector.ConsoleMessage.MessageLevel.Error,i||"");WebInspector.console.addMessage(s);return}var o=this._removeBreakpoints(e);this._restoreBreakpoints(e,o),this._runScript(n)}var t=this._removeBreakpoints(e);this._releaseSnippetScript(e),this._restoreBreakpoints(e,t);var n=this._snippetIdForUISourceCode.get(e)||"",r=this._nextEvaluationIndex(n);e._evaluationIndex=r;var i=this._evaluationSourceURL(e),s=e.workingCopy();if(WebInspector.debuggerModel.selectedCallFrame()){s=e.workingCopy()+"\n//# sourceURL="+i+"\n",WebInspector.evaluateInConsole(s,!0);return}WebInspector.showConsole(),DebuggerAgent.compileScript(s,i,o.bind(this))},_runScript:function(e){function n(e,t,n){if(e){console.error(e);return}this._printRunScriptResult(t,n)}var t=WebInspector.runtimeModel.currentExecutionContext();DebuggerAgent.runScript(e,t?t.id:undefined,"console",!1,n.bind(this))},_printRunScriptResult:function(e,t){var n=t?WebInspector.ConsoleMessage.MessageLevel.Error:WebInspector.ConsoleMessage.MessageLevel.Log,r=WebInspector.ConsoleMessage.create(WebInspector.ConsoleMessage.MessageSource.JS,n,"",undefined,undefined,undefined,undefined,undefined,[e]);WebInspector.console.addMessage(r)},_rawLocationToUILocation:function(e){var t=this._uiSourceCodeForScriptId[e.scriptId];return t?new WebInspector.UILocation(t,e.lineNumber,e.columnNumber||0):null},_uiLocationToRawLocation:function(e,t,n){var r=this._scriptForUISourceCode.get(e);return r?WebInspector.debuggerModel.createRawLocation(r,t,n):null},_addScript:function(e){var t=this._snippetIdForSourceURL(e.sourceURL);if(!t)return;var n=this._uiSourceCodeForSnippetId[t];if(!n||this._evaluationSourceURL(n)!==e.sourceURL)return;console.assert(!this._scriptForUISourceCode.get(n)),this._uiSourceCodeForScriptId[e.scriptId]=n,this._scriptForUISourceCode.put(n,e),n.scriptFile().setHasDivergedFromVM(!1),e.pushSourceMapping(this._snippetScriptMapping)},_removeBreakpoints:function(e){var t=WebInspector.breakpointManager.breakpointLocationsForUISourceCode(e);for(var n=0;n<t.length;++n)t[n].breakpoint.remove();return t},_restoreBreakpoints:function(e,t){for(var n=0;n<t.length;++n){var r=t[n].uiLocation,i=t[n].breakpoint;WebInspector.breakpointManager.setBreakpoint(e,r.lineNumber,i.condition(),i.enabled())}},_releaseSnippetScript:function(e){var t=this._scriptForUISourceCode.get(e);if(!t)return null;e.scriptFile().setIsDivergingFromVM(!0),e.scriptFile().setHasDivergedFromVM(!0),delete this._uiSourceCodeForScriptId[t.scriptId],this._scriptForUISourceCode.remove(e),delete e._evaluationIndex,e.scriptFile().setIsDivergingFromVM(!1)},_debuggerReset:function(){for(var e in this._uiSourceCodeForSnippetId){var t=this._uiSourceCodeForSnippetId[e];this._releaseSnippetScript(t)}},_evaluationSourceURL:function(e){var t="_"+e._evaluationIndex,n=this._snippetIdForUISourceCode.get(e);return WebInspector.Script.snippetSourceURLPrefix+n+t},_snippetIdForSourceURL:function(e){var t=WebInspector.Script.snippetSourceURLPrefix;if(!e.startsWith(t))return null;var n=e.substring(t.length).split("_"),r=n[0];return r},reset:function(){this._uiSourceCodeForScriptId={},this._scriptForUISourceCode=new Map,this._uiSourceCodeForSnippetId={},this._snippetIdForUISourceCode=new Map,this._projectDelegate.reset(),this._loadSnippets()},__proto__:WebInspector.Object.prototype},WebInspector.SnippetScriptFile=function(e,t){WebInspector.ScriptFile.call(this),this._scriptSnippetModel=e,this._uiSourceCode=t,this._hasDivergedFromVM=!0,this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this)},WebInspector.SnippetScriptFile.prototype={hasDivergedFromVM:function(){return this._hasDivergedFromVM},setHasDivergedFromVM:function(e){this._hasDivergedFromVM=e},isDivergingFromVM:function(){return this._isDivergingFromVM},checkMapping:function(){},isMergingToVM:function(){return!1},setIsDivergingFromVM:function(e){this._isDivergingFromVM=e},_workingCopyChanged:function(){this._scriptSnippetModel._scriptSnippetEdited(this._uiSourceCode)},__proto__:WebInspector.Object.prototype},WebInspector.SnippetScriptMapping=function(e){this._scriptSnippetModel=e},WebInspector.SnippetScriptMapping.prototype={rawLocationToUILocation:function(e){var t=e;return this._scriptSnippetModel._rawLocationToUILocation(t)},uiLocationToRawLocation:function(e,t,n){return this._scriptSnippetModel._uiLocationToRawLocation(e,t,n)},isIdentity:function(){return!0},snippetIdForSourceURL:function(e){return this._scriptSnippetModel._snippetIdForSourceURL(e)},addScript:function(e){this._scriptSnippetModel._addScript(e)}},WebInspector.SnippetContentProvider=function(e){this._snippet=e},WebInspector.SnippetContentProvider.prototype={contentURL:function(){return""},contentType:function(){return WebInspector.resourceTypes.Script},requestContent:function(e){e(this._snippet.content,!1,WebInspector.resourceTypes.Script.canonicalMimeType())},searchInContent:function(e,t,n,r){function i(){r(WebInspector.ContentProvider.performSearchInContent(this._snippet.content,e,t,n))}window.setTimeout(i.bind(this),0)},__proto__:WebInspector.ContentProvider.prototype},WebInspector.SnippetsProjectDelegate=function(e){WebInspector.ContentProviderBasedProjectDelegate.call(this,WebInspector.projectTypes.Snippets),this._model=e},WebInspector.SnippetsProjectDelegate.prototype={id:function(){return WebInspector.projectTypes.Snippets+":"},addSnippet:function(e,t){return this.addContentProvider("",e,e,t,!0,!1)},canSetFileContent:function(){return!0},setFileContent:function(e,t,n){this._model._setScriptSnippetContent(e,t),n("")},canRename:function(){return!0},performRename:function(e,t,n){this._model.renameScriptSnippet(e,t,n)},createFile:function(e,t,n){var r=this._model.createScriptSnippet();n(r)},deleteFile:function(e){this._model.deleteScriptSnippet(e)},__proto__:WebInspector.ContentProviderBasedProjectDelegate.prototype},WebInspector.scriptSnippetModel=null;