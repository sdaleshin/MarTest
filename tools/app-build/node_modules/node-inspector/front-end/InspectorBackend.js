/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

function InspectorBackendClass(){this._lastCallbackId=1,this._pendingResponsesCount=0,this._callbacks={},this._domainDispatchers={},this._eventArgs={},this._replyArgs={},this._hasErrorData={},this.dumpInspectorTimeStats=!1,this.dumpInspectorProtocolMessages=!1,this._initialized=!1}InspectorBackendClass.prototype={nextCallbackId:function(){return this._lastCallbackId++},_wrap:function(e,t){var n=this.nextCallbackId();return e||(e=function(){}),this._callbacks[n]=e,e.methodName=t,this.dumpInspectorTimeStats&&(e.sendRequestTime=Date.now()),n},_getAgent:function(e){var t=e+"Agent";return window[t]||(window[t]={}),window[t]},registerCommand:function(e,t,n,r){var i=e.split("."),s=this._getAgent(i[0]);s[i[1]]=this._sendMessageToBackend.bind(this,e,t),s[i[1]].invoke=this._invoke.bind(this,e,t),this._replyArgs[e]=n,r&&(this._hasErrorData[e]=!0),this._initialized=!0},registerEnum:function(e,t){var n=e.split("."),r=this._getAgent(n[0]);r[n[1]]=t,this._initialized=!0},registerEvent:function(e,t){this._eventArgs[e]=t,this._initialized=!0},_invoke:function(e,t,n,r){this._wrapCallbackAndSendMessageObject(e,n,r)},_sendMessageToBackend:function(e,t,n){var r=Array.prototype.slice.call(arguments,2),i=r.length&&typeof r[r.length-1]=="function"?r.pop():null,s={},o=!1;for(var u=0;u<t.length;++u){var a=t[u],f=a.name,l=a.type,c=a.optional;if(!r.length&&!c){console.error("Protocol Error: Invalid number of arguments for method '"+e+"' call. It must have the following arguments '"+JSON.stringify(t)+"'.");return}var h=r.shift();if(c&&typeof h=="undefined")continue;if(typeof h!==l){console.error("Protocol Error: Invalid type of argument '"+f+"' for method '"+e+"' call. It must be '"+l+"' but it is '"+typeof h+"'.");return}s[f]=h,o=!0}if(r.length===1&&!i&&typeof r[0]!="undefined"){console.error("Protocol Error: Optional callback argument for method '"+e+"' call must be a function but its type is '"+typeof r[0]+"'.");return}this._wrapCallbackAndSendMessageObject(e,o?s:null,i)},_wrapCallbackAndSendMessageObject:function(e,t,n){var r={};r.method=e,t&&(r.params=t),r.id=this._wrap(n,e),this.dumpInspectorProtocolMessages&&console.log("frontend: "+JSON.stringify(r)),++this._pendingResponsesCount,this.sendMessageObjectToBackend(r)},sendMessageObjectToBackend:function(e){var t=JSON.stringify(e);InspectorFrontendHost.sendMessageToBackend(t)},registerDomainDispatcher:function(e,t){this._domainDispatchers[e]=t},dispatch:function(e){this.dumpInspectorProtocolMessages&&console.log("backend: "+(typeof e=="string"?e:JSON.stringify(e)));var t=typeof e=="string"?JSON.parse(e):e;if("id"in t){t.error&&t.error.code!==-32e3&&this.reportProtocolError(t);var n=this._callbacks[t.id];if(n){var r=[null];t.error&&(r[0]=t.error.message),this._hasErrorData[n.methodName]&&(r.push(null),t.error&&(r[1]=t.error.data));if(t.result){var i=this._replyArgs[n.methodName];if(i)for(var s=0;s<i.length;++s)r.push(t.result[i[s]])}var o;this.dumpInspectorTimeStats&&n.methodName&&(o=Date.now()),n.apply(null,r),--this._pendingResponsesCount,delete this._callbacks[t.id],this.dumpInspectorTimeStats&&n.methodName&&console.log("time-stats: "+n.methodName+" = "+(o-n.sendRequestTime)+" + "+(Date.now()-o))}this._scripts&&!this._pendingResponsesCount&&this.runAfterPendingDispatches();return}var u=t.method.split("."),a=u[0],f=u[1];if(!(a in this._domainDispatchers)){console.error("Protocol Error: the message is for non-existing domain '"+a+"'");return}var l=this._domainDispatchers[a];if(!(f in l)){console.error("Protocol Error: Attempted to dispatch an unimplemented method '"+t.method+"'");return}if(!this._eventArgs[t.method]){console.error("Protocol Error: Attempted to dispatch an unspecified method '"+t.method+"'");return}var c=[];if(t.params){var i=this._eventArgs[t.method];for(var s=0;s<i.length;++s)c.push(t.params[i[s]])}var o;this.dumpInspectorTimeStats&&(o=Date.now()),l[f].apply(l,c),this.dumpInspectorTimeStats&&console.log("time-stats: "+t.method+" = "+(Date.now()-o))},reportProtocolError:function(e){console.error("Request with id = "+e.id+" failed. "+e.error)},runAfterPendingDispatches:function(e){this._scripts||(this._scripts=[]),e&&this._scripts.push(e);if(!this._pendingResponsesCount){var t=this._scripts;this._scripts=[];for(var n=0;n<t.length;++n)t[n].call(this)}},loadFromJSONIfNeeded:function(jsonUrl){if(this._initialized)return;var xhr=new XMLHttpRequest;xhr.open("GET",jsonUrl,!1),xhr.send(null);var schema=JSON.parse(xhr.responseText),code=InspectorBackendClass._generateCommands(schema);eval(code)}},InspectorBackendClass._generateCommands=function(e){function f(e,t,n){return[t,n][e].toUpperCase()}function l(e,t){var n=[];for(var r=0;r<t.length;++r){var i=t[r],s=i.replace(/-(\w)/g,f.bind(null,1)).toTitleCase();s=s.replace(/HTML|XML|WML|API/ig,f.bind(null,0)),n.push(s+': "'+i+'"')}return'InspectorBackend.registerEnum("'+e+'", {'+n.join(", ")+"});"}var t={integer:"number",array:"object"},n={},r=[],i=e.domains||[];for(var s=0;s<i.length;++s){var o=i[s];for(var u=0;o.types&&u<o.types.length;++u){var a=o.types[u];n[o.domain+"."+a.id]=t[a.type]||a.type}}for(var s=0;s<i.length;++s){var o=i[s],c=o.types||[];for(var u=0;u<c.length;++u){var a=c[u];if(a.type==="string"&&a["enum"])r.push(l(o.domain+"."+a.id,a["enum"]));else if(a.type==="object"){var h=a.properties||[];for(var p=0;p<h.length;++p){var d=h[p];d.type==="string"&&d["enum"]&&r.push(l(o.domain+"."+a.id+d.name.toTitleCase(),d["enum"]))}}}var v=o.commands||[];for(var u=0;u<v.length;++u){var m=v[u],g=m.parameters,y=[];for(var p=0;g&&p<g.length;++p){var b=g[p],a;if(b.type)a=t[b.type]||b.type;else{var w=b.$ref;w.indexOf(".")!==-1?a=n[w]:a=n[o.domain+"."+w]}var E='{"name": "'+b.name+'", "type": "'+a+'", "optional": '+(b.optional?"true":"false")+"}";y.push(E)}var S=[],x=m.returns||[];for(var p=0;p<x.length;++p){var b=x[p];S.push('"'+b.name+'"')}var T=String(Boolean(m.error));r.push('InspectorBackend.registerCommand("'+o.domain+"."+m.name+'", ['+y.join(", ")+"], ["+S.join(", ")+"], "+T+");")}for(var u=0;o.events&&u<o.events.length;++u){var N=o.events[u],y=[];for(var p=0;N.parameters&&p<N.parameters.length;++p){var b=N.parameters[p];y.push('"'+b.name+'"')}r.push('InspectorBackend.registerEvent("'+o.domain+"."+N.name+'", ['+y.join(", ")+"]);")}r.push("InspectorBackend.register"+o.domain+'Dispatcher = InspectorBackend.registerDomainDispatcher.bind(InspectorBackend, "'+o.domain+'");')}return r.join("\n")},InspectorBackend=new InspectorBackendClass;