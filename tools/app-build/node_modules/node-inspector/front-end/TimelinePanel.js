/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 * Copyright (C) 2012 Intel Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

importScript("MemoryStatistics.js"),importScript("DOMCountersGraph.js"),importScript("TimelineModel.js"),importScript("TimelineOverviewPane.js"),importScript("TimelinePresentationModel.js"),importScript("TimelineFrameController.js"),WebInspector.TimelinePanel=function(){WebInspector.Panel.call(this,"timeline"),this.registerRequiredCSS("timelinePanel.css"),this._model=new WebInspector.TimelineModel,this._presentationModel=new WebInspector.TimelinePresentationModel,this._overviewModeSetting=WebInspector.settings.createSetting("timelineOverviewMode",WebInspector.TimelineOverviewPane.Mode.Events),this._glueRecordsSetting=WebInspector.settings.createSetting("timelineGlueRecords",!1),this._overviewPane=new WebInspector.TimelineOverviewPane(this._model),this._overviewPane.addEventListener(WebInspector.TimelineOverviewPane.Events.WindowChanged,this._invalidateAndScheduleRefresh.bind(this,!1,!0)),this._overviewPane.addEventListener(WebInspector.TimelineOverviewPane.Events.ModeChanged,this._overviewModeChanged,this),this._overviewPane.show(this.element),this.element.addEventListener("contextmenu",this._contextMenu.bind(this),!1),this.createSidebarViewWithTree(),this._containerElement=this.splitView.element,this._containerElement.tabIndex=0,this._containerElement.id="timeline-container",this._containerElement.addEventListener("scroll",this._onScroll.bind(this),!1),this._timelineMemorySplitter=this.element.createChild("div"),this._timelineMemorySplitter.id="timeline-memory-splitter",WebInspector.installDragHandle(this._timelineMemorySplitter,this._startSplitterDragging.bind(this),this._splitterDragging.bind(this),this._endSplitterDragging.bind(this),"ns-resize"),this._timelineMemorySplitter.addStyleClass("hidden"),this._includeDomCounters=!1,this._memoryStatistics=new WebInspector.DOMCountersGraph(this,this._model,this.splitView.sidebarWidth()),this._includeDomCounters=!0,WebInspector.settings.memoryCounterGraphsHeight=WebInspector.settings.createSetting("memoryCounterGraphsHeight",150);var e=new WebInspector.SidebarSectionTreeElement(WebInspector.UIString("RECORDS"),{},!0);this.sidebarTree.appendChild(e),this.sidebarTree.setFocusable(!1),this._sidebarListElement=document.createElement("div"),this.sidebarElement.appendChild(this._sidebarListElement),this._containerContentElement=this.splitView.mainElement,this._containerContentElement.id="resources-container-content",this._timelineGrid=new WebInspector.TimelineGrid,this._itemsGraphsElement=this._timelineGrid.itemsGraphsElement,this._itemsGraphsElement.id="timeline-graphs",this._containerContentElement.appendChild(this._timelineGrid.element),this._timelineGrid.gridHeaderElement.id="timeline-grid-header",this._memoryStatistics.setMainTimelineGrid(this._timelineGrid),this.element.appendChild(this._timelineGrid.gridHeaderElement),this._topGapElement=document.createElement("div"),this._topGapElement.className="timeline-gap",this._itemsGraphsElement.appendChild(this._topGapElement),this._graphRowsElement=document.createElement("div"),this._itemsGraphsElement.appendChild(this._graphRowsElement),this._bottomGapElement=document.createElement("div"),this._bottomGapElement.className="timeline-gap",this._itemsGraphsElement.appendChild(this._bottomGapElement),this._expandElements=document.createElement("div"),this._expandElements.id="orphan-expand-elements",this._itemsGraphsElement.appendChild(this._expandElements),this._calculator=new WebInspector.TimelineCalculator(this._model),this._createStatusBarItems(),this._frameMode=!1,this._boundariesAreValid=!0,this._scrollTop=0,this._popoverHelper=new WebInspector.PopoverHelper(this.element,this._getPopoverAnchor.bind(this),this._showPopover.bind(this)),this.element.addEventListener("mousemove",this._mouseMove.bind(this),!1),this.element.addEventListener("mouseout",this._mouseOut.bind(this),!1),this._durationFilter=new WebInspector.TimelineIsLongFilter,this._expandOffset=15,this._headerLineCount=1,this._adjustHeaderHeight(),this._mainThreadTasks=[],this._cpuBarsElement=this._timelineGrid.gridHeaderElement.createChild("div","timeline-cpu-bars"),this._mainThreadMonitoringEnabled=WebInspector.settings.showCpuOnTimelineRuler.get(),WebInspector.settings.showCpuOnTimelineRuler.addChangeListener(this._showCpuOnTimelineRulerChanged,this),this._createFileSelector(),this._model.addEventListener(WebInspector.TimelineModel.Events.RecordAdded,this._onTimelineEventRecorded,this),this._model.addEventListener(WebInspector.TimelineModel.Events.RecordsCleared,this._onRecordsCleared,this),this._registerShortcuts(),this._allRecordsCount=0,this._presentationModel.addFilter(new WebInspector.TimelineWindowFilter(this._overviewPane)),this._presentationModel.addFilter(new WebInspector.TimelineCategoryFilter),this._presentationModel.addFilter(this._durationFilter)},WebInspector.TimelinePanel.rowHeight=18,WebInspector.TimelinePanel.durationFilterPresetsMs=[0,1,15],WebInspector.TimelinePanel.prototype={_showCpuOnTimelineRulerChanged:function(){var e=WebInspector.settings.showCpuOnTimelineRuler.get();this._mainThreadMonitoringEnabled!==e&&(this._mainThreadMonitoringEnabled=e,this._refreshMainThreadBars())},_startSplitterDragging:function(e){return this._dragOffset=this._timelineMemorySplitter.offsetTop+2-e.pageY,!0},_splitterDragging:function(e){var t=e.pageY+this._dragOffset;this._setSplitterPosition(t),e.preventDefault()},_endSplitterDragging:function(e){delete this._dragOffset,this._memoryStatistics.show(),WebInspector.settings.memoryCounterGraphsHeight.set(this.splitView.element.offsetHeight)},_setSplitterPosition:function(e){const t=90,n=100;e=Number.constrain(e,t+n,this.element.offsetHeight-n),this.splitView.element.style.height=e-t+"px",this._timelineMemorySplitter.style.top=e-2+"px",this._memoryStatistics.setTopPosition(e),this._containerElementHeight=this._containerElement.clientHeight,this.onResize()},get calculator(){return this._calculator},get statusBarItems(){return this._statusBarItems.select("element").concat([this._miscStatusBarItems])},defaultFocusedElement:function(){return this.element},_createStatusBarItems:function(){function u(){return this.frameStatistics}this._statusBarItems=[],this.toggleTimelineButton=new WebInspector.StatusBarButton(WebInspector.UIString("Record"),"record-profile-status-bar-item"),this.toggleTimelineButton.addEventListener("click",this._toggleTimelineButtonClicked,this),this._statusBarItems.push(this.toggleTimelineButton),this.clearButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear"),"clear-status-bar-item"),this.clearButton.addEventListener("click",this._clearPanel,this),this._statusBarItems.push(this.clearButton),this.garbageCollectButton=new WebInspector.StatusBarButton(WebInspector.UIString("Collect Garbage"),"garbage-collect-status-bar-item"),this.garbageCollectButton.addEventListener("click",this._garbageCollectButtonClicked,this),this._statusBarItems.push(this.garbageCollectButton),this._glueParentButton=new WebInspector.StatusBarButton(WebInspector.UIString("Glue asynchronous events to causes"),"glue-async-status-bar-item"),this._glueParentButton.toggled=this._glueRecordsSetting.get(),this._presentationModel.setGlueRecords(this._glueParentButton.toggled),this._glueParentButton.addEventListener("click",this._glueParentButtonClicked,this),this._statusBarItems.push(this._glueParentButton),this._durationFilterSelector=new WebInspector.StatusBarComboBox(this._durationFilterChanged.bind(this));for(var e=0;e<WebInspector.TimelinePanel.durationFilterPresetsMs.length;++e){var t=WebInspector.TimelinePanel.durationFilterPresetsMs[e],n=document.createElement("option");t?(n.text=WebInspector.UIString("â‰¥ %dms",t),n.title=WebInspector.UIString("Hide records shorter than %dms",t)):(n.text=WebInspector.UIString("All"),n.title=WebInspector.UIString("Show all records")),n._durationMs=t,this._durationFilterSelector.addOption(n),this._durationFilterSelector.element.title=this._durationFilterSelector.selectedOption().title}this._statusBarItems.push(this._durationFilterSelector),this._miscStatusBarItems=document.createElement("div"),this._miscStatusBarItems.className="status-bar-items timeline-misc-status-bar-items",this._statusBarFilters=this._miscStatusBarItems.createChild("div","timeline-misc-status-bar-filters");var r=WebInspector.TimelinePresentationModel.categories();for(var i in r){var s=r[i];if(s.overviewStripGroupIndex<0)continue;this._statusBarFilters.appendChild(this._createTimelineCategoryStatusBarCheckbox(s))}var o=this._statusBarFilters.createChild("div","timeline-records-stats-container");this.recordsCounter=o.createChild("div","timeline-records-stats"),this.frameStatistics=o.createChild("div","timeline-records-stats hidden"),this._frameStatisticsPopoverHelper=new WebInspector.PopoverHelper(this.frameStatistics,u.bind(this),this._showFrameStatistics.bind(this))},_createTimelineCategoryStatusBarCheckbox:function(e){function s(t){var n=!i.checked;i.checked=n,e.hidden=!n,i.enableStyleClass("timeline-category-checkbox-checked",i.checked),this._invalidateAndScheduleRefresh(!0,!0)}var t=document.createElement("div");t.addStyleClass("timeline-category-statusbar-item"),t.addStyleClass("timeline-category-"+e.name),t.addStyleClass("status-bar-item");var n=t.createChild("label"),r=n.createChild("div","timeline-category-checkbox"),i=r.createChild("div","timeline-category-checkbox-check timeline-category-checkbox-checked");i.type="checkbox",i.checked=!0,t.addEventListener("click",s.bind(this),!1);var o=n.createChild("span","type");return o.textContent=e.title,t},_setOperationInProgress:function(e){this._operationInProgress=!!e;for(var t=0;t<this._statusBarItems.length;++t)this._statusBarItems[t].setEnabled(!this._operationInProgress);this._glueParentButton.setEnabled(!this._operationInProgress&&!this._frameController),this._miscStatusBarItems.removeChildren(),this._miscStatusBarItems.appendChild(e?e.element:this._statusBarFilters)},_registerShortcuts:function(){this.registerShortcuts(WebInspector.TimelinePanelDescriptor.ShortcutKeys.StartStopRecording,this._toggleTimelineButtonClicked.bind(this)),this.registerShortcuts(WebInspector.TimelinePanelDescriptor.ShortcutKeys.SaveToFile,this._saveToFile.bind(this)),this.registerShortcuts(WebInspector.TimelinePanelDescriptor.ShortcutKeys.LoadFromFile,this._selectFileToLoad.bind(this))},_createFileSelector:function(){this._fileSelectorElement&&this.element.removeChild(this._fileSelectorElement),this._fileSelectorElement=WebInspector.createFileSelectorElement(this._loadFromFile.bind(this)),this.element.appendChild(this._fileSelectorElement)},_contextMenu:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Save Timeline dataâ€¦":"Save Timeline Dataâ€¦"),this._saveToFile.bind(this),this._operationInProgress),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Load Timeline dataâ€¦":"Load Timeline Dataâ€¦"),this._selectFileToLoad.bind(this),this._operationInProgress),t.show()},_saveToFile:function(e){return this._operationInProgress?!0:(this._model.saveToFile(),!0)},_selectFileToLoad:function(e){return this._fileSelectorElement.click(),!0},_loadFromFile:function(e){var t=this._prepareToLoadTimeline();if(!t)return;this._model.loadFromFile(e,t),this._createFileSelector()},loadFromURL:function(e){var t=this._prepareToLoadTimeline();if(!t)return;this._model.loadFromURL(e,t)},_prepareToLoadTimeline:function(){if(this._operationInProgress)return null;this.toggleTimelineButton.toggled&&(this.toggleTimelineButton.toggled=!1,this._model.stopRecord());var e=new WebInspector.ProgressIndicator;return e.addEventListener(WebInspector.ProgressIndicator.Events.Done,this._setOperationInProgress.bind(this,null)),this._setOperationInProgress(e),e},_rootRecord:function(){return this._presentationModel.rootRecord()},_updateRecordsCounter:function(e){this.recordsCounter.textContent=WebInspector.UIString("%d of %d records shown",e,this._allRecordsCount)},_updateFrameStatistics:function(e){if(e.length){this._lastFrameStatistics=new WebInspector.FrameStatistics(e);var t=WebInspector.UIString("avg: %s, Ïƒ: %s",Number.secondsToString(this._lastFrameStatistics.average,!0),Number.secondsToString(this._lastFrameStatistics.stddev,!0))}else this._lastFrameStatistics=null;this.frameStatistics.textContent=WebInspector.UIString("%d of %d frames shown",e.length,this._presentationModel.frames().length),t&&(this.frameStatistics.appendChild(document.createTextNode(" (")),this.frameStatistics.createChild("span","timeline-frames-stats").textContent=t,this.frameStatistics.appendChild(document.createTextNode(")")))},_showFrameStatistics:function(e,t){t.show(WebInspector.TimelinePresentationModel.generatePopupContentForFrameStatistics(this._lastFrameStatistics),e)},_updateEventDividers:function(){this._timelineGrid.removeEventDividers();var e=this._graphRowsElementWidth,t=[],n=this._presentationModel.eventDividerRecords();for(var r=0;r<n.length;++r){var i=n[r],s=this._calculator.computeBarGraphWindowPosition(i),o=Math.round(s.left);if(o<0||o>=e||t[o])continue;var u=WebInspector.TimelinePresentationModel.createEventDivider(i.type,i.title);u.style.left=o+"px",t[o]=u}this._timelineGrid.addEventDividers(t)},_updateFrameBars:function(e){var t=this._graphRowsElementWidth;if(this._frameContainer)this._frameContainer.removeChildren();else{const n=1;this._frameContainer=document.createElement("div"),this._frameContainer.addStyleClass("fill"),this._frameContainer.addStyleClass("timeline-frame-container"),this._frameContainer.style.height=this._headerLineCount*WebInspector.TimelinePanel.rowHeight+n+"px",this._frameContainer.addEventListener("dblclick",this._onFrameDoubleClicked.bind(this),!1)}var r=[this._frameContainer];for(var i=0;i<e.length;++i){var s=e[i],o=this._calculator.computePosition(s.startTime),u=this._calculator.computePosition(s.endTime),a=document.createElement("div");a.className="timeline-frame-strip";var f=Math.max(o,0),l=u-f;a.style.left=f+"px",a.style.width=l+"px",a._frame=s;const c=60;l>c&&(a.textContent=Number.secondsToString(s.endTime-s.startTime,!0)),this._frameContainer.appendChild(a);if(f>0){var h=WebInspector.TimelinePresentationModel.createEventDivider(WebInspector.TimelineModel.RecordType.BeginFrame);h.style.left=o+"px",r.push(h)}}this._timelineGrid.addEventDividers(r)},_onFrameDoubleClicked:function(e){var t=e.target.enclosingNodeOrSelfWithClass("timeline-frame-strip");if(!t)return;this._overviewPane.zoomToFrame(t._frame)},_overviewModeChanged:function(e){var t=e.data,n=t===WebInspector.TimelineOverviewPane.Mode.Memory,r=t===WebInspector.TimelineOverviewPane.Mode.Frames;this._overviewModeSetting.set(t),r!==this._frameMode&&(this._frameMode=r,this._glueParentButton.setEnabled(!r),this._presentationModel.setGlueRecords(this._glueParentButton.toggled&&!r),this._repopulateRecords(),r?(this.element.addStyleClass("timeline-frame-overview"),this.recordsCounter.addStyleClass("hidden"),this.frameStatistics.removeStyleClass("hidden"),this._frameController=new WebInspector.TimelineFrameController(this._model,this._overviewPane,this._presentationModel)):(this._frameController.dispose(),this._frameController=null,this.element.removeStyleClass("timeline-frame-overview"),this.recordsCounter.removeStyleClass("hidden"),this.frameStatistics.addStyleClass("hidden")));if(n===this._memoryStatistics.visible())return;n?(this._timelineMemorySplitter.removeStyleClass("hidden"),this._memoryStatistics.show(),this.splitView.element.style.bottom="auto",this._setSplitterPosition(WebInspector.settings.memoryCounterGraphsHeight.get())):(this._timelineMemorySplitter.addStyleClass("hidden"),this._memoryStatistics.hide(),this.splitView.element.style.height="auto",this.splitView.element.style.bottom="0",this.onResize())},_toggleTimelineButtonClicked:function(){return this._operationInProgress?!0:(this.toggleTimelineButton.toggled?(this._model.stopRecord(),this.toggleTimelineButton.title=WebInspector.UIString("Record")):(this._model.startRecord(this._includeDomCounters),this.toggleTimelineButton.title=WebInspector.UIString("Stop"),WebInspector.userMetrics.TimelineStarted.record()),this.toggleTimelineButton.toggled=!this.toggleTimelineButton.toggled,!0)},_durationFilterChanged:function(){var e=this._durationFilterSelector.selectedOption(),t=+e._durationMs/1e3;this._durationFilter.setMinimumRecordDuration(t),this._durationFilterSelector.element.title=e.title,this._invalidateAndScheduleRefresh(!0,!0)},_garbageCollectButtonClicked:function(){HeapProfilerAgent.collectGarbage()},_glueParentButtonClicked:function(){var e=!this._glueParentButton.toggled;this._glueParentButton.toggled=e,this._presentationModel.setGlueRecords(e),this._glueRecordsSetting.set(e),this._repopulateRecords()},_repopulateRecords:function(){this._resetPanel(),this._automaticallySizeWindow=!1;var e=this._model.records;for(var t=0;t<e.length;++t)this._innerAddRecordToTimeline(e[t]);this._invalidateAndScheduleRefresh(!1,!1)},_onTimelineEventRecorded:function(e){this._innerAddRecordToTimeline(e.data)&&this._invalidateAndScheduleRefresh(!1,!1)},_innerAddRecordToTimeline:function(e){function i(e){n|=r.isVisible(e)}function s(e){return e.parent!==r.rootRecord}e.type===WebInspector.TimelineModel.RecordType.Program&&this._mainThreadTasks.push({startTime:WebInspector.TimelineModel.startTimeInSeconds(e),endTime:WebInspector.TimelineModel.endTimeInSeconds(e)});var t=this._presentationModel.addRecord(e);this._allRecordsCount+=t.length;var n=!1,r=this._presentationModel;return WebInspector.TimelinePresentationModel.forAllRecords(t,i),n||t.some(s)},sidebarResized:function(e){var t=e.data;this._resize(t),this._overviewPane.sidebarResized(t),this._memoryStatistics.setSidebarWidth(t),this._timelineGrid.gridHeaderElement.style.left=t+"px"},onResize:function(){this._resize(this.splitView.sidebarWidth())},_resize:function(e){this._closeRecordDetails(),this._graphRowsElementWidth=this._graphRowsElement.offsetWidth,this._containerElementHeight=this._containerElement.clientHeight,this._scheduleRefresh(!1,!0);var t=this._statusBarItems[this._statusBarItems.length-1].element,n=t.totalOffsetLeft()+t.offsetWidth;this._timelineGrid.gridHeaderElement.style.width=this._itemsGraphsElement.offsetWidth+"px",this._miscStatusBarItems.style.left=Math.max(n,e)+"px"},_clearPanel:function(){this._model.reset()},_onRecordsCleared:function(){this._resetPanel(),this._invalidateAndScheduleRefresh(!0,!0)},_resetPanel:function(){this._presentationModel.reset(),this._boundariesAreValid=!1,this._adjustScrollPosition(0),this._closeRecordDetails(),this._allRecordsCount=0,this._automaticallySizeWindow=!0,this._mainThreadTasks=[]},elementsToRestoreScrollPositionsFor:function(){return[this._containerElement]},wasShown:function(){WebInspector.Panel.prototype.wasShown.call(this),WebInspector.TimelinePanel._categoryStylesInitialized||(WebInspector.TimelinePanel._categoryStylesInitialized=!0,this._injectCategoryStyles()),this._overviewPane.setMode(this._overviewModeSetting.get()),this._refresh()},willHide:function(){this._closeRecordDetails(),WebInspector.Panel.prototype.willHide.call(this)},_onScroll:function(e){this._closeRecordDetails(),this._scrollTop=this._containerElement.scrollTop;var t=Math.max(0,this._scrollTop);this._timelineGrid.setScrollAndDividerTop(this._scrollTop,t),this._scheduleRefresh(!0,!0)},_invalidateAndScheduleRefresh:function(e,t){this._presentationModel.invalidateFilteredRecords(),delete this._searchResults,this._scheduleRefresh(e,t)},_scheduleRefresh:function(e,t){this._closeRecordDetails(),this._boundariesAreValid&=e;if(!this.isShowing())return;e||t?this._refresh():this._refreshTimeout||(this._refreshTimeout=setTimeout(this._refresh.bind(this),300))},_refresh:function(){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),delete this._refreshTimeout),this._timelinePaddingLeft=this._expandOffset,this._calculator.setWindow(this._overviewPane.windowStartTime(),this._overviewPane.windowEndTime()),this._calculator.setDisplayWindow(this._timelinePaddingLeft,this._graphRowsElementWidth);var e=this._refreshRecords();this._updateRecordsCounter(e);if(!this._boundariesAreValid){this._updateEventDividers();var t=this._frameController&&this._presentationModel.filteredFrames(this._overviewPane.windowStartTime(),this._overviewPane.windowEndTime());if(t){this._updateFrameStatistics(t);const n=30;t.length&&t.length<n?(this._timelineGrid.removeDividers(),this._updateFrameBars(t)):this._timelineGrid.updateDividers(this._calculator)}else this._timelineGrid.updateDividers(this._calculator);this._mainThreadMonitoringEnabled&&this._refreshMainThreadBars()}this._memoryStatistics.visible()&&this._memoryStatistics.refresh(),this._boundariesAreValid=!0},revealRecordAt:function(e){function n(n){if(n.containsTime(e))return t=n,!0;if(!t||n.endTime<e&&t.endTime<n.endTime)t=n;return!1}var t;WebInspector.TimelinePresentationModel.forAllRecords(this._presentationModel.rootRecord().children,null,n);if(!t){this._containerElement.scrollTop=0;return}this._revealRecord(t)},_revealRecord:function(e){for(var t=e.parent;t!==this._rootRecord();t=t.parent){if(!t.collapsed)continue;this._presentationModel.invalidateFilteredRecords(),t.collapsed=!1}var n=this._presentationModel.filteredRecords(),r=n.indexOf(e);this._recordToHighlight=e;var i=this._containerElement.scrollTop;this._containerElement.scrollTop=r*WebInspector.TimelinePanel.rowHeight,this._containerElement.scrollTop===i&&this._refresh()},_refreshRecords:function(){var e=this._presentationModel.filteredRecords(),t=this._scrollTop,n=t+this._containerElementHeight;const r=WebInspector.TimelinePanel.rowHeight;var i=Math.max(0,Math.min(Math.floor(t/r)-this._headerLineCount,e.length-1)),s=Math.min(e.length,Math.ceil(n/r)),o=Math.max(0,Math.floor(n/r)-this._headerLineCount);if(this._automaticallySizeWindow&&e.length>o){this._automaticallySizeWindow=!1;var u=i?e[i].startTime:this._model.minimumRecordTime();this._overviewPane.setWindowTimes(u,e[Math.max(0,o-1)].endTime),e=this._presentationModel.filteredRecords(),s=Math.min(e.length,o)}this._topGapElement.style.height=i*r+"px",this.sidebarTreeElement.style.height=(i+this._headerLineCount)*r+"px",this._bottomGapElement.style.height=(e.length-s)*r+"px";var a=this._sidebarListElement.firstChild,f=this._graphRowsElementWidth;this._itemsGraphsElement.removeChild(this._graphRowsElement);var l=this._graphRowsElement.firstChild,c=this._invalidateAndScheduleRefresh.bind(this,!0,!0);this._itemsGraphsElement.removeChild(this._expandElements),this._expandElements.removeChildren();var h=this._recordToHighlight;delete this._recordToHighlight;var p,d;for(var v=0;v<s;++v){var m=e[v],g=!(v%2);if(v<i){var y=v+m.visibleChildrenCount;if(y>=i&&y<s){var b=new WebInspector.TimelineExpandableElement(this._expandElements),w=this._calculator.computeBarGraphWindowPosition(m);b._update(m,v,w.left-this._expandOffset,w.width)}}else a||(a=(new WebInspector.TimelineRecordListRow).element,this._sidebarListElement.appendChild(a)),l||(l=(new WebInspector.TimelineRecordGraphRow(this._itemsGraphsElement,c)).element,this._graphRowsElement.appendChild(l)),h===m&&(p=a,d=l),a.row.update(m,g,t),l.row.update(m,g,this._calculator,this._expandOffset,v),a=a.nextSibling,l=l.nextSibling}while(a){var E=a.nextSibling;a.row.dispose(),a=E}while(l){var E=l.nextSibling;l.row.dispose(),l=E}return this._itemsGraphsElement.insertBefore(this._graphRowsElement,this._bottomGapElement),this._itemsGraphsElement.appendChild(this._expandElements),this._adjustScrollPosition((e.length+this._headerLineCount)*r),this._updateSearchHighlight(!1,!0),p&&(p.addStyleClass("highlighted-timeline-record"),d.addStyleClass("highlighted-timeline-record")),e.length},_refreshMainThreadBars:function(){function l(e,t){return e<t.endTime?-1:1}const e=3,t=3;var n=WebInspector.TimelineCalculator._minWidth,r=n/2,i=this._graphRowsElementWidth,s=this._overviewPane.windowEndTime()-this._overviewPane.windowStartTime(),o=s/(i-n-this._timelinePaddingLeft),u=this._overviewPane.windowStartTime()-this._timelinePaddingLeft*o,a=u+i*o,f=this._mainThreadMonitoringEnabled?this._mainThreadTasks:[],c=insertionIndexForObjectInListSortedByFunction(u,f,l),h=this._cpuBarsElement,p=h.firstChild,d,v,m;for(;c<f.length;++c){var g=f[c];if(g.startTime>a)break;var y=Math.max(0,this._calculator.computePosition(g.startTime)+e-r),b=Math.min(i,this._calculator.computePosition(g.endTime)+e+r);if(d){var w=Math.floor(y)-Math.ceil(m);if(w<t){m=b,d._tasksInfo.lastTaskIndex=c;continue}d.style.width=m-v+"px"}p||(p=h.createChild("div","timeline-graph-bar")),p.style.left=y+"px",p._tasksInfo={tasks:f,firstTaskIndex:c,lastTaskIndex:c},v=y,m=b,d=p,p=p.nextSibling}d&&(d.style.width=m-v+"px");while(p){var E=p.nextSibling;p._tasksInfo=null,h.removeChild(p),p=E}},_adjustHeaderHeight:function(){const e=1,t=2;var n=this._headerLineCount*WebInspector.TimelinePanel.rowHeight;this.sidebarElement.firstChild.style.height=n+"px",this._timelineGrid.dividersLabelBarElement.style.height=n+t+"px",this._itemsGraphsElement.style.top=n+e+"px"},_adjustScrollPosition:function(e){this._scrollTop+this._containerElementHeight>e+1&&(this._containerElement.scrollTop=e-this._containerElement.offsetHeight)},_getPopoverAnchor:function(e){return e.enclosingNodeOrSelfWithClass("timeline-graph-bar")||e.enclosingNodeOrSelfWithClass("timeline-tree-item")||e.enclosingNodeOrSelfWithClass("timeline-frame-strip")},_mouseOut:function(e){this._hideQuadHighlight()},_mouseMove:function(e){var t=this._getPopoverAnchor(e.target);t&&t.row&&t.row._record.highlightQuad?this._highlightQuad(t.row._record.highlightQuad):this._hideQuadHighlight();if(t&&t._tasksInfo){var n=t.offsetLeft;this._timelineGrid.showCurtains(n>=0?n:0,t.offsetWidth)}else this._timelineGrid.hideCurtains()},_highlightQuad:function(e){if(this._highlightedQuad===e)return;this._highlightedQuad=e,DOMAgent.highlightQuad(e,WebInspector.Color.PageHighlight.Content.toProtocolRGBA(),WebInspector.Color.PageHighlight.ContentOutline.toProtocolRGBA())},_hideQuadHighlight:function(){this._highlightedQuad&&(delete this._highlightedQuad,DOMAgent.hideHighlight())},_showPopover:function(e,t){function r(n){t.show(n,e)}if(e.hasStyleClass("timeline-frame-strip")){var n=e._frame;t.show(WebInspector.TimelinePresentationModel.generatePopupContentForFrame(n),e)}else e.row&&e.row._record?e.row._record.generatePopupContent(r):e._tasksInfo&&t.show(this._presentationModel.generateMainThreadBarPopupContent(e._tasksInfo),e,null,null,WebInspector.Popover.Orientation.Bottom)},_closeRecordDetails:function(){this._popoverHelper.hidePopover()},_injectCategoryStyles:function(){var e=document.createElement("style"),t=WebInspector.TimelinePresentationModel.categories();e.textContent=Object.values(t).map(WebInspector.TimelinePresentationModel.createStyleRuleForCategory).join("\n"),document.head.appendChild(e)},jumpToNextSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;var e=this._selectedSearchResult?this._searchResults.indexOf(this._selectedSearchResult):-1;this._jumpToSearchResult(e+1)},jumpToPreviousSearchResult:function(){if(!this._searchResults||!this._searchResults.length)return;var e=this._selectedSearchResult?this._searchResults.indexOf(this._selectedSearchResult):0;this._jumpToSearchResult(e-1)},_jumpToSearchResult:function(e){this._selectSearchResult((e+this._searchResults.length)%this._searchResults.length),this._highlightSelectedSearchResult(!0)},_selectSearchResult:function(e){this._selectedSearchResult=this._searchResults[e],WebInspector.searchController.updateCurrentMatchIndex(e,this)},_highlightSelectedSearchResult:function(e){this._clearHighlight();if(this._searchFilter)return;var t=this._selectedSearchResult;if(!t)return;for(var n=this._sidebarListElement.firstChild;n;n=n.nextSibling)if(n.row._record===t){n.row.highlight(this._searchRegExp,this._highlightDomChanges);return}e&&this._revealRecord(t)},_clearHighlight:function(){this._highlightDomChanges&&WebInspector.revertDomChanges(this._highlightDomChanges),this._highlightDomChanges=[]},_updateSearchHighlight:function(e,t){if(this._searchFilter||!this._searchRegExp){this._clearHighlight();return}this._searchResults||this._updateSearchResults(t),this._highlightSelectedSearchResult(e)},_updateSearchResults:function(e){function i(e){return r.isVisible(e)&&WebInspector.TimelineRecordListRow.testContentMatching(e,t)&&n.push(e),!1}var t=this._searchRegExp;if(!t)return;var n=[],r=this._presentationModel;WebInspector.TimelinePresentationModel.forAllRecords(r.rootRecord().children,i);var s=n.length;if(s){this._searchResults=n,WebInspector.searchController.updateSearchMatchesCount(s,this);var o=n.indexOf(this._selectedSearchResult);e&&o===-1&&(o=0),this._selectSearchResult(o)}else WebInspector.searchController.updateSearchMatchesCount(0,this),delete this._selectedSearchResult},searchCanceled:function(){this._clearHighlight(),delete this._searchResults,delete this._selectedSearchResult,delete this._searchRegExp},canFilter:function(){return!0},performFilter:function(e){function t(e){delete e.clicked}this._presentationModel.setSearchFilter(null),delete this._searchFilter,WebInspector.TimelinePresentationModel.forAllRecords(this._presentationModel.rootRecord().children,t),this.searchCanceled(),e&&(this._searchFilter=new WebInspector.TimelineSearchFilter(createPlainTextSearchRegex(e,"i")),this._presentationModel.setSearchFilter(this._searchFilter)),this._invalidateAndScheduleRefresh(!0,!0)},performSearch:function(e,t){this._searchRegExp=createPlainTextSearchRegex(e,"i"),delete this._searchResults,this._updateSearchHighlight(!0,t)},__proto__:WebInspector.Panel.prototype},WebInspector.TimelineCalculator=function(e){this._model=e},WebInspector.TimelineCalculator._minWidth=5,WebInspector.TimelineCalculator.prototype={computePosition:function(e){return(e-this._minimumBoundary)/this.boundarySpan()*this._workingArea+this.paddingLeft},computeBarGraphPercentages:function(e){var t=(e.startTime-this._minimumBoundary)/this.boundarySpan()*100,n=(e.startTime+e.selfTime-this._minimumBoundary)/this.boundarySpan()*100,r=(e.lastChildEndTime-this._minimumBoundary)/this.boundarySpan()*100,i=e.coalesced?r-t:e.cpuTime/this.boundarySpan()*100;return{start:t,end:n,endWithChildren:r,cpuWidth:i}},computeBarGraphWindowPosition:function(e){var t=this.computeBarGraphPercentages(e),n=0,r=this.computePosition(e.startTime),i=(t.end-t.start)/100*this._workingArea;i<WebInspector.TimelineCalculator._minWidth&&(n=WebInspector.TimelineCalculator._minWidth-i,i=WebInspector.TimelineCalculator._minWidth);var s=(t.endWithChildren-t.start)/100*this._workingArea+n,o=t.cpuWidth/100*this._workingArea+n;return t.endWithChildren>t.end&&(s+=n),{left:r,width:i,widthWithChildren:s,cpuWidth:o}},setWindow:function(e,t){this._minimumBoundary=e,this._maximumBoundary=t},setDisplayWindow:function(e,t){this._workingArea=t-WebInspector.TimelineCalculator._minWidth-e,this.paddingLeft=e},formatTime:function(e){return Number.secondsToString(e+this._minimumBoundary-this._model.minimumRecordTime())},maximumBoundary:function(){return this._maximumBoundary},minimumBoundary:function(){return this._minimumBoundary},zeroTime:function(){return this._model.minimumRecordTime()},boundarySpan:function(){return this._maximumBoundary-this._minimumBoundary}},WebInspector.TimelineRecordListRow=function(){this.element=document.createElement("div"),this.element.row=this,this.element.style.cursor="pointer";var e=document.createElement("span");e.className="timeline-tree-icon",this.element.appendChild(e),this._typeElement=document.createElement("span"),this._typeElement.className="type",this.element.appendChild(this._typeElement);var t=document.createElement("span");t.className="separator",t.textContent=" ",this._dataElement=document.createElement("span"),this._dataElement.className="data dimmed",this.element.appendChild(t),this.element.appendChild(this._dataElement)},WebInspector.TimelineRecordListRow.prototype={update:function(e,t,n){this._record=e,this._offset=n,this.element.className="timeline-tree-item timeline-category-"+e.category.name,t&&this.element.addStyleClass("even"),e.hasWarning?this.element.addStyleClass("warning"):e.childHasWarning&&this.element.addStyleClass("child-warning"),e.isBackground&&this.element.addStyleClass("background"),this._typeElement.textContent=e.title,this._dataElement.firstChild&&this._dataElement.removeChildren(),e.detailsNode()&&this._dataElement.appendChild(e.detailsNode())},highlight:function(e,t){var n=this.element.textContent.match(e);n&&WebInspector.highlightSearchResult(this.element,n.index,n[0].length,t)},dispose:function(){this.element.remove()}},WebInspector.TimelineRecordListRow.testContentMatching=function(e,t){var n=e.title;return e.detailsNode()&&(n+=" "+e.detailsNode().textContent),t.test(n)},WebInspector.TimelineRecordGraphRow=function(e,t){this.element=document.createElement("div"),this.element.row=this,this._barAreaElement=document.createElement("div"),this._barAreaElement.className="timeline-graph-bar-area",this.element.appendChild(this._barAreaElement),this._barWithChildrenElement=document.createElement("div"),this._barWithChildrenElement.className="timeline-graph-bar with-children",this._barWithChildrenElement.row=this,this._barAreaElement.appendChild(this._barWithChildrenElement),this._barCpuElement=document.createElement("div"),this._barCpuElement.className="timeline-graph-bar cpu",this._barCpuElement.row=this,this._barAreaElement.appendChild(this._barCpuElement),this._barElement=document.createElement("div"),this._barElement.className="timeline-graph-bar",this._barElement.row=this,this._barAreaElement.appendChild(this._barElement),this._expandElement=new WebInspector.TimelineExpandableElement(e),this._expandElement._element.addEventListener("click",this._onClick.bind(this)),this._scheduleRefresh=t},WebInspector.TimelineRecordGraphRow.prototype={update:function(e,t,n,r,i){this._record=e,this.element.className="timeline-graph-side timeline-category-"+e.category.name,t&&this.element.addStyleClass("even"),e.isBackground&&this.element.addStyleClass("background");var s=n.computeBarGraphWindowPosition(e);this._barWithChildrenElement.style.left=s.left+"px",this._barWithChildrenElement.style.width=s.widthWithChildren+"px",this._barElement.style.left=s.left+"px",this._barElement.style.width=s.width+"px",this._barCpuElement.style.left=s.left+"px",this._barCpuElement.style.width=s.cpuWidth+"px",this._expandElement._update(e,i,s.left-r,s.width)},_onClick:function(e){this._record.collapsed=!this._record.collapsed,this._record.clicked=!0,this._scheduleRefresh(!1,!0)},dispose:function(){this.element.remove(),this._expandElement._dispose()}},WebInspector.TimelineExpandableElement=function(e){this._element=e.createChild("div","timeline-expandable"),this._element.createChild("div","timeline-expandable-left"),this._element.createChild("div","timeline-expandable-arrow")},WebInspector.TimelineExpandableElement.prototype={_update:function(e,t,n,r){const i=WebInspector.TimelinePanel.rowHeight;e.visibleChildrenCount||e.expandable?(this._element.style.top=t*i+"px",this._element.style.left=n+"px",this._element.style.width=Math.max(12,r+25)+"px",e.collapsed?(this._element.style.height=i+"px",this._element.addStyleClass("timeline-expandable-collapsed"),this._element.removeStyleClass("timeline-expandable-expanded")):(this._element.style.height=(e.visibleChildrenCount+1)*i+"px",this._element.addStyleClass("timeline-expandable-expanded"),this._element.removeStyleClass("timeline-expandable-collapsed")),this._element.removeStyleClass("hidden")):this._element.addStyleClass("hidden")},_dispose:function(){this._element.remove()}},WebInspector.TimelineCategoryFilter=function(){},WebInspector.TimelineCategoryFilter.prototype={accept:function(e){return!e.category.hidden&&e.type!==WebInspector.TimelineModel.RecordType.BeginFrame}},WebInspector.TimelineIsLongFilter=function(){this._minimumRecordDuration=0},WebInspector.TimelineIsLongFilter.prototype={setMinimumRecordDuration:function(e){this._minimumRecordDuration=e},accept:function(e){return this._minimumRecordDuration?e.lastChildEndTime-e.startTime>=this._minimumRecordDuration:!0}},WebInspector.TimelineSearchFilter=function(e){this._regExp=e},WebInspector.TimelineSearchFilter.prototype={accept:function(e){return WebInspector.TimelineRecordListRow.testContentMatching(e,this._regExp)}};