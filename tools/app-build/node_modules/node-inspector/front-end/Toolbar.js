/*
 * Copyright (C) 2006, 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2007 Matt Lilek (pewtermoose@gmail.com).
 * Copyright (C) 2009 Joseph Pecoraro
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.Toolbar=function(){this.element=document.getElementById("toolbar"),WebInspector.installDragHandle(this.element,this._toolbarDragStart.bind(this),this._toolbarDrag.bind(this),this._toolbarDragEnd.bind(this),"default"),this._dropdownButton=document.getElementById("toolbar-dropdown-arrow"),this._dropdownButton.addEventListener("click",this._toggleDropdown.bind(this),!1),this._panelsMenuButton=document.getElementById("toolbar-panels-menu"),this._isToolbarCustomizable()&&(this._panelsMenuButton.addEventListener("mousedown",this._togglePanelsMenu.bind(this),!1),this._panelsMenuButton.removeStyleClass("hidden")),document.getElementById("close-button-left").addEventListener("click",this._onClose,!0),document.getElementById("close-button-right").addEventListener("click",this._onClose,!0),this._panelDescriptors=[]},WebInspector.Toolbar.prototype={resize:function(){this._updateDropdownButtonAndHideDropdown()},addPanel:function(e){this._panelDescriptors.push(e),e._toolbarElement=this._createPanelToolbarItem(e),(!this._isToolbarCustomizable()||this._isPanelVisible(e.name()))&&this.element.insertBefore(e._toolbarElement,this._panelInsertLocation(e)),this._updatePanelsMenuState(),this.resize()},_panelInsertLocation:function(e){return this._isToolbarCustomizable()?this._isDefaultPanel(e.name())?this._firstNonDefaultPanel||null:(this._firstNonDefaultPanel||(this._firstNonDefaultPanel=e._toolbarElement),null):null},_isDefaultPanel:function(e){var t={elements:!0,resources:!0,scripts:!0,console:!0,network:!0,timeline:!0};return!!t[e]},_isPanelVisibleByDefault:function(e){var t={elements:!0,console:!0,network:!0,scripts:!0,timeline:!0,profiles:!0,"cpu-profiler":!0,"heap-profiler":!0,audits:!0,resources:!0};return!!t[e]},_isToolbarCustomizable:function(){return WebInspector.experimentsSettings.customizableToolbar.isEnabled()},_isPanelVisible:function(e){if(!this._isToolbarCustomizable())return!0;var t=WebInspector.settings.visiblePanels.get();return t.hasOwnProperty(e)?t[e]:this._isPanelVisibleByDefault(e)},_setPanelVisible:function(e,t){var n=WebInspector.settings.visiblePanels.get();n[e]=t,WebInspector.settings.visiblePanels.set(n)},_hidePanel:function(e){if(!this._isPanelVisible(e.name()))return;var t=e._toolbarElement.nextSibling;if(!t||!t.classList.contains("toggleable"))t=e._toolbarElement.previousSibling;if(!t||!t.classList||!t.classList.contains("toggleable"))return;this._setPanelVisible(e.name(),!1),this.element.removeChild(e._toolbarElement);if(WebInspector.inspectorView.currentPanel().name===e.name())for(var n=0;n<this._panelDescriptors.length;++n){var r=this._panelDescriptors[n];if(r._toolbarElement===t){WebInspector.showPanel(r.name());break}}this._updatePanelsMenuState(),this.resize()},_updatePanelsMenuState:function(){this._panelDescriptors.every(function(e){return this._isPanelVisible(e.name())},this)&&this._allItemsFitOntoToolbar()?document.getElementById("toolbar-panels-menu").addStyleClass("disabled"):document.getElementById("toolbar-panels-menu").removeStyleClass("disabled")},_allItemsFitOntoToolbar:function(){var e=this.element.querySelectorAll(".toolbar-item.toggleable");return e.length===0||this.element.scrollHeight<e[0].offsetHeight*2},_showPanel:function(e){if(this._isPanelVisible(e.name()))return;this.element.appendChild(e._toolbarElement),e._toolbarElement.removeStyleClass("hidden"),this._setPanelVisible(e.name(),!0),this._updatePanelsMenuState(),this.resize()},_createPanelToolbarItem:function(e,t){function r(t){var n=new WebInspector.ContextMenu(t);n.appendItem(WebInspector.UIString("Close"),this._hidePanel.bind(this,e)),n.show()}function i(){this._showPanel(e),this._updateDropdownButtonAndHideDropdown(),WebInspector.inspectorView.setCurrentPanel(e.panel())}function s(t){t.stopPropagation(),this._hidePanel(e)}function o(){WebInspector.inspectorView.currentPanel()&&e.name()===WebInspector.inspectorView.currentPanel().name?n.addStyleClass("toggled-on"):n.removeStyleClass("toggled-on")}var n=document.createElement("button");n.className="toolbar-item toggleable",n.panelDescriptor=e,n.addStyleClass(e.name()),this._isDefaultPanel(e.name())||n.addEventListener("contextmenu",r.bind(this),!0),n.addEventListener("click",i.bind(this),!1),WebInspector.inspectorView.addEventListener(WebInspector.InspectorView.Events.PanelSelected,o),n.createChild("div","toolbar-label").textContent=e.title();if(this._isToolbarCustomizable()&&!this._isDefaultPanel(e.name())&&!t){var u=n.createChild("div","close-button");u.addEventListener("click",s.bind(this),!1)}return o(),n},_isDockedToBottom:function(){return!!WebInspector.dockController&&WebInspector.dockController.dockSide()==WebInspector.DockController.State.DockedToBottom},_isUndocked:function(){return!!WebInspector.dockController&&WebInspector.dockController.dockSide()==WebInspector.DockController.State.Undocked},_toolbarDragStart:function(e){if(this._isUndocked())return!1;var t=e.target;return t.hasStyleClass("toolbar-item")&&t.hasStyleClass("toggleable")?!1:t!==this.element&&!t.hasStyleClass("toolbar-item")?!1:(this._lastScreenX=e.screenX,this._lastScreenY=e.screenY,this._lastHeightDuringDrag=window.innerHeight,this._startDistanceToRight=window.innerWidth-e.clientX,this._startDinstanceToBottom=window.innerHeight-e.clientY,!0)},_toolbarDragEnd:function(e){this._toolbarDrag(e),delete this._lastScreenX,delete this._lastScreenY,delete this._lastHeightDuringDrag,delete this._startDistanceToRight,delete this._startDinstanceToBottom},_toolbarDrag:function(e){return e.preventDefault(),this._isUndocked()?this._toolbarDragMoveWindow(e):this._toolbarDragChangeDocking(e)},_toolbarDragMoveWindow:function(e){var t=e.screenX-this._lastScreenX,n=e.screenY-this._lastScreenY;this._lastScreenX=e.screenX,this._lastScreenY=e.screenY,InspectorFrontendHost.moveWindowBy(t,n)},_toolbarDragChangeDocking:function(e){if(this._isDockedToBottom()){var t=window.innerWidth-e.clientX;if(t<this._startDistanceToRight*2/3)return InspectorFrontendHost.requestSetDockSide(WebInspector.DockController.State.DockedToRight),!0}else{var n=window.innerHeight-e.clientY;if(n<this._startDinstanceToBottom*2/3)return InspectorFrontendHost.requestSetDockSide(WebInspector.DockController.State.DockedToBottom),!0}},_onClose:function(){WebInspector.close()},_setDropdownVisible:function(e){if(!this._dropdown){if(!e)return;this._dropdown=new WebInspector.ToolbarDropdown(this)}e?this._dropdown.show():this._dropdown.hide()},_toggleDropdown:function(){this._setDropdownVisible(!this._dropdown||!this._dropdown.visible)},_togglePanelsMenu:function(e){function t(e){this._showPanel(e),WebInspector.showPanel(e.name())}var n=new WebInspector.ContextMenu(e),r=WebInspector.inspectorView.currentPanel().name,i=this.element.querySelectorAll(".toolbar-item.toggleable");for(var s=0;s<i.length;++s)if(i[s].offsetTop>=i[0].offsetHeight){var o=i[s].panelDescriptor;o.name()===r?n.appendCheckboxItem(o.title(),t.bind(this,o),!0):n.appendItem(o.title(),t.bind(this,o))}n.appendSeparator();for(var s=0;s<this._panelDescriptors.length;++s){var o=this._panelDescriptors[s];if(this._isPanelVisible(o.name()))continue;n.appendItem(o.title(),t.bind(this,o))}n.showSoftMenu()},_updateDropdownButtonAndHideDropdown:function(){WebInspector.invokeOnceAfterBatchUpdate(this,this._innerUpdateDropdownButtonAndHideDropdown)},_innerUpdateDropdownButtonAndHideDropdown:function(){if(this._isToolbarCustomizable()){this._updatePanelsMenuState();return}this._setDropdownVisible(!1),this.element.scrollHeight>this.element.offsetHeight?this._dropdownButton.removeStyleClass("hidden"):this._dropdownButton.addStyleClass("hidden")}},WebInspector.ToolbarDropdown=function(e){this._toolbar=e,this._arrow=document.getElementById("toolbar-dropdown-arrow"),this.element=document.createElement("div"),this.element.id="toolbar-dropdown",this.element.className="toolbar-small",this._contentElement=this.element.createChild("div","scrollable-content"),this._contentElement.tabIndex=0,this._contentElement.addEventListener("keydown",this._onKeyDown.bind(this),!0)},WebInspector.ToolbarDropdown.prototype={show:function(){if(this.visible)return;var e=this.element.style;this._populate();var t=this._arrow.totalOffsetTop()+this._arrow.clientHeight;this._arrow.addStyleClass("dropdown-visible"),this.element.style.top=t+"px",this.element.style.right=window.innerWidth-this._arrow.totalOffsetLeft()-this._arrow.clientWidth+"px",this._contentElement.style.maxHeight=window.innerHeight-t-20+"px",this._toolbar.element.appendChild(this.element)},hide:function(){if(!this.visible)return;this._arrow.removeStyleClass("dropdown-visible"),this.element.remove(),this._contentElement.removeChildren()},get visible(){return!!this.element.parentNode},_populate:function(){var e=this._toolbar.element.querySelectorAll(".toolbar-item.toggleable"),t=!1;for(var n=0;n<e.length;++n)e[n].offsetTop>=e[0].offsetHeight&&(this._contentElement.appendChild(this._toolbar._createPanelToolbarItem(e[n].panelDescriptor,!0)),t=!0);var r=this._toolbar._panelDescriptors;for(var n=0;n<r.length;++n){var i=r[n];if(this._toolbar._isPanelVisible(i.name()))continue;t&&(this._contentElement.createChild("div","toolbar-items-separator"),t=!1),this._contentElement.appendChild(this._toolbar._createPanelToolbarItem(i,!0))}},_onKeyDown:function(e){if(e.keyCode!==WebInspector.KeyboardShortcut.Keys.Esc.code)return;e.consume(),this.hide()}},WebInspector.toolbar=null;