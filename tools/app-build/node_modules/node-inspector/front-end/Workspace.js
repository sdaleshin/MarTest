/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.FileDescriptor=function(e,t,n,r,i,s,o){this.parentPath=e,this.name=t,this.originURL=n,this.url=r,this.contentType=i,this.isEditable=s,this.isContentScript=o||!1},WebInspector.ProjectDelegate=function(){},WebInspector.ProjectDelegate.Events={FileAdded:"FileAdded",FileRemoved:"FileRemoved",Reset:"Reset"},WebInspector.ProjectDelegate.prototype={id:function(){},type:function(){},displayName:function(){},requestMetadata:function(e,t){},requestFileContent:function(e,t){},canSetFileContent:function(){},setFileContent:function(e,t,n){},canRename:function(){},rename:function(e,t,n){},refresh:function(e){},excludeFolder:function(e){},createFile:function(e,t,n){},deleteFile:function(e){},remove:function(){},searchInFileContent:function(e,t,n,r,i){},searchInContent:function(e,t,n,r,i){},indexContent:function(e,t){}},WebInspector.Project=function(e,t){this._uiSourceCodesMap={},this._uiSourceCodesList=[],this._workspace=e,this._projectDelegate=t,this._displayName=this._projectDelegate.displayName(),this._projectDelegate.addEventListener(WebInspector.ProjectDelegate.Events.FileAdded,this._fileAdded,this),this._projectDelegate.addEventListener(WebInspector.ProjectDelegate.Events.FileRemoved,this._fileRemoved,this),this._projectDelegate.addEventListener(WebInspector.ProjectDelegate.Events.Reset,this._reset,this)},WebInspector.Project.prototype={id:function(){return this._projectDelegate.id()},type:function(){return this._projectDelegate.type()},displayName:function(){return this._displayName},isServiceProject:function(){return this._projectDelegate.type()===WebInspector.projectTypes.Debugger||this._projectDelegate.type()===WebInspector.projectTypes.LiveEdit},_fileAdded:function(e){var t=e.data,n=t.parentPath?t.parentPath+"/"+t.name:t.name,r=this.uiSourceCode(n);if(r)return;r=new WebInspector.UISourceCode(this,t.parentPath,t.name,t.originURL,t.url,t.contentType,t.isEditable),r.isContentScript=t.isContentScript,this._uiSourceCodesMap[n]={uiSourceCode:r,index:this._uiSourceCodesList.length},this._uiSourceCodesList.push(r),this._workspace.dispatchEventToListeners(WebInspector.Workspace.Events.UISourceCodeAdded,r)},_fileRemoved:function(e){var t=e.data;this._removeFile(t)},_removeFile:function(e){var t=this.uiSourceCode(e);if(!t)return;var n=this._uiSourceCodesMap[e],r=this._uiSourceCodesList[this._uiSourceCodesList.length-1];this._uiSourceCodesList[n.index]=r;var i=this._uiSourceCodesMap[r.path()];i.index=n.index,this._uiSourceCodesList.splice(this._uiSourceCodesList.length-1,1),delete this._uiSourceCodesMap[e],this._workspace.dispatchEventToListeners(WebInspector.Workspace.Events.UISourceCodeRemoved,n.uiSourceCode)},_reset:function(){this._workspace.dispatchEventToListeners(WebInspector.Workspace.Events.ProjectWillReset,this),this._uiSourceCodesMap={},this._uiSourceCodesList=[]},uiSourceCode:function(e){var t=this._uiSourceCodesMap[e];return t?t.uiSourceCode:null},uiSourceCodeForOriginURL:function(e){for(var t=0;t<this._uiSourceCodesList.length;++t){var n=this._uiSourceCodesList[t];if(n.originURL()===e)return n}return null},uiSourceCodes:function(){return this._uiSourceCodesList},requestMetadata:function(e,t){this._projectDelegate.requestMetadata(e.path(),t)},requestFileContent:function(e,t){this._projectDelegate.requestFileContent(e.path(),t)},canSetFileContent:function(){return this._projectDelegate.canSetFileContent()},setFileContent:function(e,t,n){function r(r){this._workspace.dispatchEventToListeners(WebInspector.Workspace.Events.UISourceCodeContentCommitted,{uiSourceCode:e,content:t}),n(r)}this._projectDelegate.setFileContent(e.path(),t,r.bind(this))},canRename:function(){return this._projectDelegate.canRename()},rename:function(e,t,n){function r(t,r){if(!t||!r){n(!1);return}var i=e.path(),s=e.parentPath()?e.parentPath()+"/"+r:r;this._uiSourceCodesMap[s]=this._uiSourceCodesMap[i],delete this._uiSourceCodesMap[i],n(!0,r)}if(t===e.name()){n(!0,t);return}this._projectDelegate.rename(e.path(),t,r.bind(this))},refresh:function(e){this._projectDelegate.refresh(e)},excludeFolder:function(e){this._projectDelegate.excludeFolder(e);var t=this._uiSourceCodesList.slice();for(var n=0;n<t.length;++n){var r=t[n];r.path().startsWith(e.substr(1))&&this._removeFile(r.path())}},createFile:function(e,t,n){function r(e){n(e)}this._projectDelegate.createFile(e,t,r)},deleteFile:function(e){this._projectDelegate.deleteFile(e.path())},remove:function(){this._projectDelegate.remove()},searchInFileContent:function(e,t,n,r,i){this._projectDelegate.searchInFileContent(e.path(),t,n,r,i)},searchInContent:function(e,t,n,r,i){this._projectDelegate.searchInContent(e,t,n,r,i)},indexContent:function(e,t){this._projectDelegate.indexContent(e,t)},dispose:function(){this._projectDelegate.reset()}},WebInspector.projectTypes={Debugger:"debugger",LiveEdit:"liveedit",Network:"network",Snippets:"snippets",FileSystem:"filesystem"},WebInspector.Workspace=function(e){this._fileSystemMapping=e,this._projects={}},WebInspector.Workspace.Events={UISourceCodeAdded:"UISourceCodeAdded",UISourceCodeRemoved:"UISourceCodeRemoved",UISourceCodeContentCommitted:"UISourceCodeContentCommitted",ProjectWillReset:"ProjectWillReset"},WebInspector.Workspace.prototype={uiSourceCode:function(e,t){var n=this._projects[e];return n?n.uiSourceCode(t):null},uiSourceCodeForOriginURL:function(e){var t=this.projectsForType(WebInspector.projectTypes.Network);for(var n=0;n<t.length;++n){var r=t[n],i=r.uiSourceCodeForOriginURL(e);if(i)return i}return null},uiSourceCodesForProjectType:function(e){var t=[];for(var n in this._projects){var r=this._projects[n];r.type()===e&&(t=t.concat(r.uiSourceCodes()))}return t},addProject:function(e){var t=e.id();return this._projects[t]=new WebInspector.Project(this,e),this._projects[t]},removeProject:function(e){var t=this._projects[e];if(!t)return;t.dispose(),delete this._projects[e]},project:function(e){return this._projects[e]},projects:function(){return Object.values(this._projects)},projectsForType:function(e){function t(t){return t.type()===e}return this.projects().filter(t)},uiSourceCodes:function(){var e=[];for(var t in this._projects){var n=this._projects[t];e=e.concat(n.uiSourceCodes())}return e},hasMappingForURL:function(e){return InspectorFrontendHost.supportsFileSystems()?this._fileSystemMapping.hasMappingForURL(e):!1},_networkUISourceCodeForURL:function(e){var t=WebInspector.ParsedURL.splitURL(e),n=WebInspector.SimpleProjectDelegate.projectId(t[0],WebInspector.projectTypes.Network),r=this.project(n);return r?r.uiSourceCode(t.slice(1).join("/")):null},uiSourceCodeForURL:function(e){if(!InspectorFrontendHost.supportsFileSystems())return this._networkUISourceCodeForURL(e);var t=this._fileSystemMapping.fileForURL(e);if(!t)return this._networkUISourceCodeForURL(e);var n=WebInspector.FileSystemProjectDelegate.projectId(t.fileSystemPath),r=this.project(n);return r?r.uiSourceCode(t.filePath):null},urlForPath:function(e,t){return this._fileSystemMapping.urlForPath(e,t)},addMapping:function(e,t,n){var r=e.url,i=t.path(),s=n.fileSystemPath(t);this._fileSystemMapping.addMappingForResource(r,s,i),WebInspector.suggestReload()},removeMapping:function(e){this._fileSystemMapping.removeMappingForURL(e.url),WebInspector.suggestReload()},__proto__:WebInspector.Object.prototype},WebInspector.workspace=null;