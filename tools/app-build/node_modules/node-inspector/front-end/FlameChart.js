/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.FlameChart=function(e){WebInspector.View.call(this),this.registerRequiredCSS("flameChart.css"),this.element.className="fill",this.element.id="cpu-flame-chart",this._overviewContainer=this.element.createChild("div","overview-container"),this._overviewGrid=new WebInspector.OverviewGrid("flame-chart"),this._overviewCanvas=this._overviewContainer.createChild("canvas","flame-chart-overview-canvas"),this._overviewContainer.appendChild(this._overviewGrid.element),this._overviewCalculator=new WebInspector.FlameChart.OverviewCalculator,this._overviewGrid.addEventListener(WebInspector.OverviewGrid.Events.WindowChanged,this._onWindowChanged,this),this._chartContainer=this.element.createChild("div","chart-container"),this._timelineGrid=new WebInspector.TimelineGrid,this._chartContainer.appendChild(this._timelineGrid.element),this._calculator=new WebInspector.FlameChart.Calculator,this._canvas=this._chartContainer.createChild("canvas"),this._canvas.addEventListener("mousemove",this._onMouseMove.bind(this)),WebInspector.installDragHandle(this._canvas,this._startCanvasDragging.bind(this),this._canvasDragging.bind(this),this._endCanvasDragging.bind(this),"col-resize"),this._cpuProfileView=e,this._windowLeft=0,this._windowRight=1,this._barHeight=15,this._minWidth=2,this._paddingLeft=15,this._canvas.addEventListener("mousewheel",this._onMouseWheel.bind(this),!1),this._canvas.addEventListener("click",this._onClick.bind(this),!1),this._linkifier=new WebInspector.Linkifier,this._highlightedEntryIndex=-1,WebInspector.FlameChart._colorGenerator||(WebInspector.FlameChart._colorGenerator=new WebInspector.FlameChart.ColorGenerator)},WebInspector.FlameChart.Calculator=function(){},WebInspector.FlameChart.Calculator.prototype={_updateBoundaries:function(e){this._minimumBoundaries=e._windowLeft*e._timelineData.totalTime,this._maximumBoundaries=e._windowRight*e._timelineData.totalTime,this.paddingLeft=e._paddingLeft,this._width=e._canvas.width-this.paddingLeft,this._timeToPixel=this._width/this.boundarySpan()},computePosition:function(e){return(e-this._minimumBoundaries)*this._timeToPixel+this.paddingLeft},formatTime:function(e){return WebInspector.UIString("%s ms",Number.withThousandsSeparator(Math.round(e+this._minimumBoundaries)))},maximumBoundary:function(){return this._maximumBoundaries},minimumBoundary:function(){return this._minimumBoundaries},zeroTime:function(){return 0},boundarySpan:function(){return this._maximumBoundaries-this._minimumBoundaries}},WebInspector.FlameChart.OverviewCalculator=function(){},WebInspector.FlameChart.OverviewCalculator.prototype={_updateBoundaries:function(e){this._minimumBoundaries=0,this._maximumBoundaries=e._timelineData.totalTime,this._xScaleFactor=e._canvas.width/e._timelineData.totalTime},computePosition:function(e){return(e-this._minimumBoundaries)*this._xScaleFactor},formatTime:function(e){return Number.secondsToString((e+this._minimumBoundaries)/1e3)},maximumBoundary:function(){return this._maximumBoundaries},minimumBoundary:function(){return this._minimumBoundaries},zeroTime:function(){return this._minimumBoundaries},boundarySpan:function(){return this._maximumBoundaries-this._minimumBoundaries}},WebInspector.FlameChart.Events={SelectedNode:"SelectedNode"},WebInspector.FlameChart.ColorGenerator=function(){this._colorPairs={},this._currentColorIndex=0,this._colorPairs["(idle)::0"]=this._createPair(0,50),this._colorPairs["(program)::0"]=this._createPair(5,50),this._colorPairs["(garbage collector)::0"]=this._createPair(10,50)},WebInspector.FlameChart.ColorGenerator.prototype={_colorPairForID:function(e){var t=this._colorPairs,n=t[e];return n||(t[e]=n=this._createPair(++this._currentColorIndex)),n},_createPair:function(e,t){var n=(e*7+12*(e%2))%360;return typeof t!="number"&&(t=100),{highlighted:"hsla("+n+", "+t+"%, 33%, 0.7)",normal:"hsla("+n+", "+t+"%, 66%, 0.7)"}}},WebInspector.FlameChart.Entry=function(e,t,n,r,i){this.colorPair=e,this.depth=t,this.duration=n,this.startTime=r,this.node=i,this.selfTime=0},WebInspector.FlameChart.prototype={selectRange:function(e,t){this._overviewGrid.setWindow(e/this._totalTime,t/this._totalTime)},_onWindowChanged:function(e){this._scheduleUpdate()},_startCanvasDragging:function(e){return this._timelineData?(this._isDragging=!0,this._wasDragged=!1,this._dragStartPoint=e.pageX,this._dragStartWindowLeft=this._windowLeft,this._dragStartWindowRight=this._windowRight,!0):!1},_canvasDragging:function(e){var t=this._dragStartPoint-e.pageX,n=t/this._totalPixels,r=Math.max(0,this._dragStartWindowLeft+n);if(r===this._windowLeft)return;n=r-this._dragStartWindowLeft;var i=Math.min(1,this._dragStartWindowRight+n);if(i===this._windowRight)return;n=i-this._dragStartWindowRight,this._overviewGrid.setWindow(this._dragStartWindowLeft+n,this._dragStartWindowRight+n),this._wasDragged=!0},_endCanvasDragging:function(){this._isDragging=!1},_calculateTimelineData:function(){function n(e,t){for(var n=t.length-1;n>=0;--n)e.push(t[n])}if(this._cpuProfileView.samples)return this._calculateTimelineDataForSamples();if(this._timelineData)return this._timelineData;if(!this._cpuProfileView.profileHead)return null;var e=0,t=[],r=[];n(r,this._cpuProfileView.profileHead.children);var i=[0],s=[0],o=WebInspector.FlameChart._colorGenerator;while(r.length){var u=i.length-1,a=r.pop(),f=i[u],l=o._colorPairForID(a.functionName+":"+a.url+":"+a.lineNumber);t.push(new WebInspector.FlameChart.Entry(l,u,a.totalTime,f,a)),++e,i[u]+=a.totalTime,a.children.length&&(s.push(r.length),i.push(f+a.selfTime/2),n(r,a.children));while(r.length===s[s.length-1])i.pop(),s.pop()}return this._timelineData={entries:t,totalTime:this._cpuProfileView.profileHead.totalTime},this._timelineData},_calculateTimelineDataForSamples:function(){if(this._timelineData)return this._timelineData;if(!this._cpuProfileView.profileHead)return null;var e=this._cpuProfileView.samples,t=this._cpuProfileView._idToNode,n=this._cpuProfileView._gcNode,r=e.length,i=0,s=[],o=[],u=[],a=WebInspector.FlameChart._colorGenerator;for(var f=0;f<r;f++){var l=t[e[f]];u.length=0;while(l)u.push(l),l=l.parent;u.pop();var c=0;l=u.pop();var h;if(l===n){while(c<o.length)h=o[c].index,s[h].duration+=1,++c;if(o.length>0&&o.peekLast().node===l){s[h].selfTime+=1;continue}}while(l&&c<o.length&&l===o[c].node)h=o[c].index,s[h].duration+=1,l=u.pop(),++c;c<o.length&&(o.length=c);if(!l){s[h].selfTime+=1;continue}while(l){var p=a._colorPairForID(l.functionName+":"+l.url+":"+l.lineNumber);s.push(new WebInspector.FlameChart.Entry(p,c,1,f,l)),o.push({node:l,index:i}),++i,l=u.pop(),++c}s[s.length-1].selfTime+=1}return this._timelineData={entries:s,totalTime:r},this._timelineData},_onMouseMove:function(e){if(this._isDragging)return;var t=this._coordinatesToEntryIndex(e.offsetX,e.offsetY);if(this._highlightedEntryIndex===t)return;t===-1||this._timelineData.entries[t].node.scriptId==="0"?this._canvas.style.cursor="default":this._canvas.style.cursor="pointer",this._highlightedEntryIndex=t,this._scheduleUpdate()},_millisecondsToString:function(e){return e===0?"0":e<1e3?WebInspector.UIString("%.1f ms",e):Number.secondsToString(e/1e3,!0)},_prepareHighlightedEntryInfo:function(){function r(e,t){var r={};r.title=e,r.text=t,n.push(r)}if(this._isDragging)return null;var e=this._timelineData.entries[this._highlightedEntryIndex];if(!e)return null;var t=e.node;if(!t)return null;var n=[];r(WebInspector.UIString("Name"),t.functionName);if(this._cpuProfileView.samples){var i=this._cpuProfileView.samplesPerMs,s=this._millisecondsToString(e.selfTime/i),o=this._millisecondsToString(e.duration/i);r(WebInspector.UIString("Self time"),s),r(WebInspector.UIString("Total time"),o)}return t.url&&r(WebInspector.UIString("URL"),t.url+":"+t.lineNumber),r(WebInspector.UIString("Aggregated self time"),Number.secondsToString(t.selfTime/1e3,!0)),r(WebInspector.UIString("Aggregated total time"),Number.secondsToString(t.totalTime/1e3,!0)),n},_onClick:function(e){if(this._wasDragged)return;if(this._highlightedEntryIndex===-1)return;var t=this._timelineData.entries[this._highlightedEntryIndex].node;this.dispatchEventToListeners(WebInspector.FlameChart.Events.SelectedNode,t)},_onMouseWheel:function(e){if(e.wheelDeltaY){const t=1.1,n=1/120;var r=Math.pow(t,-e.wheelDeltaY*n),i=(this._pixelWindowLeft+e.offsetX-this._paddingLeft)/this._totalPixels;this._overviewGrid.zoom(r,i)}else{var s=Number.constrain(-1*this._windowWidth/4*e.wheelDeltaX/120,-this._windowLeft,1-this._windowRight);this._overviewGrid.setWindow(this._windowLeft+s,this._windowRight+s)}},_coordinatesToEntryIndex:function(e,t){var n=this._timelineData;if(!n)return-1;var r=n.entries,i=(e+this._pixelWindowLeft-this._paddingLeft)*this._pixelToTime,s=Math.floor((this._canvas.height/window.devicePixelRatio-t)/this._barHeight);for(var o=0;o<r.length;++o){if(i<r[o].startTime)return-1;if(i<r[o].startTime+r[o].duration&&s===r[o].depth)return o}return-1},onResize:function(){this._updateOverviewCanvas=!0,this._scheduleUpdate()},_drawOverviewCanvas:function(e,t){if(!this._timelineData)return;var n=this._timelineData.entries,r=new Uint8Array(e),i=e/this._totalTime,s=5;for(var o=0;o<n.length;++o){var u=n[o],a=Math.floor(u.startTime*i),f=Math.floor((u.startTime+u.duration)*i);for(var l=a;l<f;++l)r[l]=Math.max(r[l],u.depth+1),s=Math.max(s,u.depth+1)}var c=window.devicePixelRatio,h=e*c,p=t*c;this._overviewCanvas.width=h,this._overviewCanvas.height=p,this._overviewCanvas.style.width=e+"px",this._overviewCanvas.style.height=t+"px";var d=this._overviewCanvas.getContext("2d"),v=p/(s*1.1);d.lineWidth=1,d.translate(.5,.5),d.strokeStyle="rgba(20,0,0,0.4)",d.fillStyle="rgba(214,225,254,0.8)",d.moveTo(-1,p-1),r&&d.lineTo(-1,Math.round(t-r[0]*v-1));var m;for(var l=0;l<e;++l)m=Math.round(p-r[l]*v-1),d.lineTo(l*c,m);d.lineTo(h+1,m),d.lineTo(h+1,p-1),d.fill(),d.stroke(),d.closePath()},_entryToAnchorBox:function(e,t){t.x=Math.floor(e.startTime*this._timeToPixel)-this._pixelWindowLeft+this._paddingLeft,t.y=this._canvas.height/window.devicePixelRatio-(e.depth+1)*this._barHeight,t.width=Math.max(Math.ceil(e.duration*this._timeToPixel),this._minWidth),t.height=this._barHeight,t.x<0&&(t.width+=t.x,t.x=0),t.width=Number.constrain(t.width,0,this._canvas.width-t.x)},draw:function(e,t){function c(e,t){var n=new AnchorBox;for(var i=0;i<r.length;++i){var s=r[i],o=s.startTime;if(o>l)break;if(o+s.duration<f)continue;e._entryToAnchorBox(s,n),t(e,a,s,n,e._highlightedEntryIndex===i)}}function h(e,t,n,r,i){t.beginPath(),t.rect(r.x,r.y,r.width-1,r.height-1);var s=n.colorPair;t.fillStyle=i?s.highlighted:s.normal,t.fill()}function d(e,t,n,r,i){var s=Math.max(0,r.x),o=r.width-p+r.x-s,a=e._prepareText(t,n.node.functionName,o);a&&t.fillText(a,s+p,r.y+u-4)}var n=this._calculateTimelineData();if(!n)return;var r=n.entries,i=window.devicePixelRatio,s=e*i,o=t*i;this._canvas.width=s,this._canvas.height=o,this._canvas.style.width=e+"px",this._canvas.style.height=t+"px";var u=this._barHeight,a=this._canvas.getContext("2d");a.scale(i,i);var f=this._timeWindowLeft-this._paddingLeftTime,l=this._timeWindowRight;c(this,h),a.font=u-4+"px "+window.getComputedStyle(this.element,null).getPropertyValue("font-family"),a.textBaseline="alphabetic",a.fillStyle="#333",this._dotsWidth=a.measureText("…").width;var p=2;c(this,d);var v=this._prepareHighlightedEntryInfo();v&&this._printEntryInfo(a,v,0,25,e)},_printEntryInfo:function(e,t,n,r,i){const s=18,o=10,u=5;var a=0,f="100% "+window.getComputedStyle(this.element,null).getPropertyValue("font-family");e.font="bold "+f,e.textBaseline="top";for(var l=0;l<t.length;++l)a=Math.max(a,e.measureText(t[l].title).width);var c=0;for(var l=0;l<t.length;++l)c=Math.max(c,e.measureText(t[l].text).width);c=Math.min(c,i-2*o-a),e.beginPath(),e.rect(n,r,a+c+5,s*t.length+5),e.strokeStyle="rgba(0,0,0,0)",e.fillStyle="rgba(254,254,254,0.8)",e.fill(),e.stroke(),e.fillStyle="#333";for(var l=0;l<t.length;++l)e.fillText(t[l].title,n+o,r+s*l);e.font=f;for(var l=0;l<t.length;++l){var h=this._prepareText(e,t[l].text,c);e.fillText(h,n+o+a+o,r+s*l)}},_prepareText:function(e,t,n){if(n<this._dotsWidth)return null;var r=e.measureText(t).width;if(n>r)return t;n-=this._dotsWidth;var i=/[\.\$]/g,s=i.exec(t);if(!s){var o=n/r,u=Math.floor(t.length*o)+1,a=4;if(u<a)return null;var f;do--u,f=t.substring(0,u);while(e.measureText(f).width>n);return t.substring(0,u)+"…"}while(s){var f=t.substring(s.index+1),l=e.measureText(f).width;if(n>l)return"…"+f;s=i.exec(t)}var c=0;do++c;while(e.measureText(t.substring(0,c)).width<n);return t.substring(0,c-1)+"…"},_scheduleUpdate:function(){if(this._updateTimerId)return;this._updateTimerId=setTimeout(this.update.bind(this),10)},_updateBoundaries:function(){this._windowLeft=this._overviewGrid.windowLeft(),this._windowRight=this._overviewGrid.windowRight(),this._windowWidth=this._windowRight-this._windowLeft,this._totalTime=this._timelineData.totalTime,this._timeWindowLeft=this._windowLeft*this._totalTime,this._timeWindowRight=this._windowRight*this._totalTime,this._pixelWindowWidth=this._chartContainer.clientWidth,this._totalPixels=Math.floor(this._pixelWindowWidth/this._windowWidth),this._pixelWindowLeft=Math.floor(this._totalPixels*this._windowLeft),this._pixelWindowRight=Math.floor(this._totalPixels*this._windowRight),this._timeToPixel=this._totalPixels/this._totalTime,this._pixelToTime=this._totalTime/this._totalPixels,this._paddingLeftTime=this._paddingLeft/this._timeToPixel},update:function(){this._updateTimerId=0,this._timelineData||this._calculateTimelineData();if(!this._timelineData)return;this._updateBoundaries(),this.draw(this._chartContainer.clientWidth,this._chartContainer.clientHeight),this._calculator._updateBoundaries(this),this._overviewCalculator._updateBoundaries(this),this._timelineGrid.element.style.width=this.element.clientWidth,this._timelineGrid.updateDividers(this._calculator),this._overviewGrid.updateDividers(this._overviewCalculator),this._updateOverviewCanvas&&(this._drawOverviewCanvas(this._overviewContainer.clientWidth,this._overviewContainer.clientHeight-20),this._updateOverviewCanvas=!1)},__proto__:WebInspector.View.prototype};