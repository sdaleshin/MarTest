/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.StylesSourceMapping=function(e,t){this._cssModel=e,this._workspace=t,this._workspace.addEventListener(WebInspector.Workspace.Events.ProjectWillReset,this._projectWillReset,this),this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAddedToWorkspace,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.MainFrameCreatedOrNavigated,this._mainFrameCreatedOrNavigated,this),this._initialize()},WebInspector.StylesSourceMapping.prototype={rawLocationToUILocation:function(e){var t=e,n=this._workspace.uiSourceCodeForURL(t.url);return n?new WebInspector.UILocation(n,t.lineNumber,t.columnNumber):null},uiLocationToRawLocation:function(e,t,n){return new WebInspector.CSSLocation(e.url||"",t,n)},isIdentity:function(){return!0},addHeader:function(e){var t=e.resourceURL();if(!t)return;e.pushSourceMapping(this);var n=this._urlToHeadersByFrameId[t];n||(n=new StringMap,this._urlToHeadersByFrameId[t]=n);var r=n.get(e.frameId);r||(r=new StringMap,n.put(e.frameId,r)),r.put(e.id,e);var i=this._workspace.uiSourceCodeForURL(t);i&&this._bindUISourceCode(i,e)},removeHeader:function(e){var t=e.resourceURL();if(!t)return;var n=this._urlToHeadersByFrameId[t];console.assert(n);var r=n.get(e.frameId);console.assert(r),r.remove(e.id);if(!r.size()){n.remove(e.frameId);if(!n.size()){delete this._urlToHeadersByFrameId[t];var i=this._workspace.uiSourceCodeForURL(t);i&&this._unbindUISourceCode(i)}}},_unbindUISourceCode:function(e){e.styleFile()&&(e.styleFile().dispose(),e.setStyleFile(null)),e.setSourceMapping(null)},_uiSourceCodeAddedToWorkspace:function(e){var t=e.data,n=t.url;if(!n||!this._urlToHeadersByFrameId[n])return;this._bindUISourceCode(t,this._urlToHeadersByFrameId[n].values()[0].values()[0])},_bindUISourceCode:function(e,t){if(e.styleFile()||t.isInline)return;var n=e.url;e.setSourceMapping(this),e.setStyleFile(new WebInspector.StyleFile(e)),t.updateLocations()},_projectWillReset:function(e){var t=e.data,n=t.uiSourceCodes();for(var r=0;r<n;++r)delete this._urlToHeadersByFrameId[n[r].url]},_initialize:function(){this._urlToHeadersByFrameId={}},_mainFrameCreatedOrNavigated:function(e){for(var t in this._urlToHeadersByFrameId){var n=this._workspace.uiSourceCodeForURL(t);if(!n)continue;this._unbindUISourceCode(n)}this._initialize()}},WebInspector.StyleFile=function(e){this._uiSourceCode=e,this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this)},WebInspector.StyleFile.updateTimeout=200,WebInspector.StyleFile.sourceURLRegex=/\n[\040\t]*\/\*#[\040\t]sourceURL=[\040\t]*([^\s]*)[\040\t]*\*\/[\040\t]*$/m,WebInspector.StyleFile.prototype={_workingCopyCommitted:function(e){if(this._isAddingRevision)return;this._commitIncrementalEdit(!0)},_workingCopyChanged:function(e){if(this._isAddingRevision)return;WebInspector.StyleFile.updateTimeout>=0?this._incrementalUpdateTimer=setTimeout(this._commitIncrementalEdit.bind(this,!1),WebInspector.StyleFile.updateTimeout):this._commitIncrementalEdit(!1)},_commitIncrementalEdit:function(e){this._clearIncrementalUpdateTimer(),WebInspector.styleContentBinding.setStyleContent(this._uiSourceCode,this._uiSourceCode.workingCopy(),e,this._styleContentSet.bind(this))},_styleContentSet:function(e){e&&WebInspector.showErrorMessage(e)},_clearIncrementalUpdateTimer:function(){if(!this._incrementalUpdateTimer)return;clearTimeout(this._incrementalUpdateTimer),delete this._incrementalUpdateTimer},addRevision:function(e){this._isAddingRevision=!0,this._uiSourceCode.project().type()===WebInspector.projectTypes.FileSystem&&(e=e.replace(WebInspector.StyleFile.sourceURLRegex,"")),this._uiSourceCode.addRevision(e),delete this._isAddingRevision},dispose:function(){this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this)}},WebInspector.StyleContentBinding=function(e,t){this._cssModel=e,this._workspace=t,this._cssModel.addEventListener(WebInspector.CSSStyleModel.Events.StyleSheetChanged,this._styleSheetChanged,this)},WebInspector.StyleContentBinding.prototype={setStyleContent:function(e,t,n,r){function s(e){r(e),delete this._isSettingContent}var i=this._cssModel.styleSheetIdsForURL(e.url);if(!i.length){r("No stylesheet found: "+e.url);return}this._isSettingContent=!0,this._cssModel.setStyleSheetText(i[0],t,n,s.bind(this))},_styleSheetChanged:function(e){function t(t,n){t||this._innerStyleSheetChanged(e.data.styleSheetId,n)}if(this._isSettingContent)return;if(!e.data.majorChange)return;CSSAgent.getStyleSheetText(e.data.styleSheetId,t.bind(this))},_innerStyleSheetChanged:function(e,t){var n=this._cssModel.styleSheetHeaderForId(e);if(!n)return;var r=n.resourceURL();if(!r)return;var i=this._workspace.uiSourceCodeForURL(r);if(!i)return;i.styleFile()&&i.styleFile().addRevision(t)}},WebInspector.styleContentBinding=null;