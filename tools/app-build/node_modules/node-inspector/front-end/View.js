/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 * Copyright (C) 2011 Google Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.View=function(){this.element=document.createElement("div"),this.element.__view=this,this._visible=!0,this._isRoot=!1,this._isShowing=!1,this._children=[],this._hideOnDetach=!1,this._cssFiles=[],this._notificationDepth=0},WebInspector.View._cssFileToVisibleViewCount={},WebInspector.View._cssFileToStyleElement={},WebInspector.View._cssUnloadTimeout=2e3,WebInspector.View.prototype={statusBarText:function(){return null},markAsRoot:function(){WebInspector.View._assert(!this.element.parentElement,"Attempt to mark as root attached node"),this._isRoot=!0},parentView:function(){return this._parentView},isShowing:function(){return this._isShowing},setHideOnDetach:function(){this._hideOnDetach=!0},_inNotification:function(){return!!this._notificationDepth||this._parentView&&this._parentView._inNotification()},_parentIsShowing:function(){return this._isRoot?!0:this._parentView&&this._parentView.isShowing()},_callOnVisibleChildren:function(e){var t=this._children.slice();for(var n=0;n<t.length;++n)t[n]._parentView===this&&t[n]._visible&&e.call(t[n])},_processWillShow:function(){this._loadCSSIfNeeded(),this._callOnVisibleChildren(this._processWillShow),this._isShowing=!0},_processWasShown:function(){if(this._inNotification())return;this.restoreScrollPositions(),this._notify(this.wasShown),this._notify(this.onResize),this._callOnVisibleChildren(this._processWasShown)},_processWillHide:function(){if(this._inNotification())return;this.storeScrollPositions(),this._callOnVisibleChildren(this._processWillHide),this._notify(this.willHide),this._isShowing=!1},_processWasHidden:function(){this._disableCSSIfNeeded(),this._callOnVisibleChildren(this._processWasHidden)},_processOnResize:function(){if(this._inNotification())return;if(!this.isShowing())return;this._notify(this.onResize),this._callOnVisibleChildren(this._processOnResize)},_notify:function(e){++this._notificationDepth;try{e.call(this)}finally{--this._notificationDepth}},wasShown:function(){},willHide:function(){},onResize:function(){},show:function(e,t){WebInspector.View._assert(e,"Attempt to attach view with no parent element");if(this.element.parentElement!==e){this.element.parentElement&&this.detach();var n=e;while(n&&!n.__view)n=n.parentElement;n?(this._parentView=n.__view,this._parentView._children.push(this),this._isRoot=!1):WebInspector.View._assert(this._isRoot,"Attempt to attach view to orphan node")}else if(this._visible)return;this._visible=!0,this._parentIsShowing()&&this._processWillShow(),this.element.addStyleClass("visible"),this.element.parentElement!==e&&(WebInspector.View._incrementViewCounter(e,this.element),t?WebInspector.View._originalInsertBefore.call(e,this.element,t):WebInspector.View._originalAppendChild.call(e,this.element)),this._parentIsShowing()&&this._processWasShown()},detach:function(e){var t=this.element.parentElement;if(!t)return;this._parentIsShowing()&&this._processWillHide();if(this._hideOnDetach&&!e){this.element.removeStyleClass("visible"),this._visible=!1,this._parentIsShowing()&&this._processWasHidden();return}WebInspector.View._decrementViewCounter(t,this.element),WebInspector.View._originalRemoveChild.call(t,this.element),this._visible=!1,this._parentIsShowing()&&this._processWasHidden();if(this._parentView){var n=this._parentView._children.indexOf(this);WebInspector.View._assert(n>=0,"Attempt to remove non-child view"),this._parentView._children.splice(n,1),this._parentView=null}else WebInspector.View._assert(this._isRoot,"Removing non-root view from DOM")},detachChildViews:function(){var e=this._children.slice();for(var t=0;t<e.length;++t)e[t].detach()},elementsToRestoreScrollPositionsFor:function(){return[this.element]},storeScrollPositions:function(){var e=this.elementsToRestoreScrollPositionsFor();for(var t=0;t<e.length;++t){var n=e[t];n._scrollTop=n.scrollTop,n._scrollLeft=n.scrollLeft}},restoreScrollPositions:function(){var e=this.elementsToRestoreScrollPositionsFor();for(var t=0;t<e.length;++t){var n=e[t];n._scrollTop&&(n.scrollTop=n._scrollTop),n._scrollLeft&&(n.scrollLeft=n._scrollLeft)}},canHighlightPosition:function(){return!1},highlightPosition:function(e,t){},doResize:function(){this._processOnResize()},registerRequiredCSS:function(e){window.flattenImports&&(e=e.split("/").reverse()[0]),this._cssFiles.push(e)},_loadCSSIfNeeded:function(){for(var e=0;e<this._cssFiles.length;++e){var t=this._cssFiles[e],n=WebInspector.View._cssFileToVisibleViewCount[t];WebInspector.View._cssFileToVisibleViewCount[t]=(n||0)+1,n||this._doLoadCSS(t)}},_doLoadCSS:function(e){var t=WebInspector.View._cssFileToStyleElement[e];if(t){t.disabled=!1;return}if(window.debugCSS)t=document.createElement("link"),t.rel="stylesheet",t.type="text/css",t.href=e;else{var n=new XMLHttpRequest;n.open("GET",e,!1),n.send(null),t=document.createElement("style"),t.type="text/css",t.textContent=n.responseText+this._buildSourceURL(e)}document.head.insertBefore(t,document.head.firstChild),WebInspector.View._cssFileToStyleElement[e]=t},_buildSourceURL:function(e){return"\n/*# sourceURL="+WebInspector.ParsedURL.completeURL(window.location.href,e)+" */"},_disableCSSIfNeeded:function(){function r(){delete WebInspector.View._cssUnloadTimer;for(n in WebInspector.View._cssFileToVisibleViewCount)WebInspector.View._cssFileToVisibleViewCount.hasOwnProperty(n)&&!WebInspector.View._cssFileToVisibleViewCount[n]&&(WebInspector.View._cssFileToStyleElement[n].disabled=!0)}var e=!!WebInspector.View._cssUnloadTimer;for(var t=0;t<this._cssFiles.length;++t){var n=this._cssFiles[t];--WebInspector.View._cssFileToVisibleViewCount[n]||(e=!0)}e&&(WebInspector.View._cssUnloadTimer&&clearTimeout(WebInspector.View._cssUnloadTimer),WebInspector.View._cssUnloadTimer=setTimeout(r,WebInspector.View._cssUnloadTimeout))},printViewHierarchy:function(){var e=[];this._collectViewHierarchy("",e),console.log(e.join("\n"))},_collectViewHierarchy:function(e,t){t.push(e+"["+this.element.className+"]"+(this._children.length?" {":""));for(var n=0;n<this._children.length;++n)this._children[n]._collectViewHierarchy(e+"    ",t);this._children.length&&t.push(e+"}")},defaultFocusedElement:function(){return this._defaultFocusedElement||this.element},setDefaultFocusedElement:function(e){this._defaultFocusedElement=e},focus:function(){var e=this.defaultFocusedElement();if(!e||e.isAncestor(document.activeElement))return;WebInspector.setCurrentFocusElement(e)},measurePreferredSize:function(){this._loadCSSIfNeeded(),WebInspector.View._originalAppendChild.call(document.body,this.element),this.element.positionAt(0,0);var e=new Size(this.element.offsetWidth,this.element.offsetHeight);return this.element.positionAt(undefined,undefined),WebInspector.View._originalRemoveChild.call(document.body,this.element),this._disableCSSIfNeeded(),e},__proto__:WebInspector.Object.prototype},WebInspector.View._originalAppendChild=Element.prototype.appendChild,WebInspector.View._originalInsertBefore=Element.prototype.insertBefore,WebInspector.View._originalRemoveChild=Element.prototype.removeChild,WebInspector.View._originalRemoveChildren=Element.prototype.removeChildren,WebInspector.View._incrementViewCounter=function(e,t){var n=(t.__viewCounter||0)+(t.__view?1:0);if(!n)return;while(e)e.__viewCounter=(e.__viewCounter||0)+n,e=e.parentElement},WebInspector.View._decrementViewCounter=function(e,t){var n=(t.__viewCounter||0)+(t.__view?1:0);if(!n)return;while(e)e.__viewCounter-=n,e=e.parentElement},WebInspector.View._assert=function(e,t){if(!e)throw console.trace(),new Error(t)},Element.prototype.appendChild=function(e){return WebInspector.View._assert(!e.__view,"Attempt to add view via regular DOM operation."),WebInspector.View._originalAppendChild.call(this,e)},Element.prototype.insertBefore=function(e,t){return WebInspector.View._assert(!e.__view,"Attempt to add view via regular DOM operation."),WebInspector.View._originalInsertBefore.call(this,e,t)},Element.prototype.removeChild=function(e){return WebInspector.View._assert(!e.__viewCounter&&!e.__view,"Attempt to remove element containing view via regular DOM operation"),WebInspector.View._originalRemoveChild.call(this,e)},Element.prototype.removeChildren=function(){WebInspector.View._assert(!this.__viewCounter,"Attempt to remove element containing view via regular DOM operation"),WebInspector.View._originalRemoveChildren.call(this)};