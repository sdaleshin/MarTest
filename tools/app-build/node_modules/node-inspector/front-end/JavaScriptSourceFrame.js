/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.JavaScriptSourceFrame=function(e,t){this._scriptsPanel=e,this._breakpointManager=WebInspector.breakpointManager,this._uiSourceCode=t,WebInspector.UISourceCodeFrame.call(this,t),t.project().type()===WebInspector.projectTypes.Debugger&&this.element.addStyleClass("source-frame-debugger-script"),this._popoverHelper=new WebInspector.ObjectPopoverHelper(this.textEditor.element,this._getPopoverAnchor.bind(this),this._resolveObjectForPopover.bind(this),this._onHidePopover.bind(this),!0),this.textEditor.element.addEventListener("keydown",this._onKeyDown.bind(this),!0),this.textEditor.addEventListener(WebInspector.TextEditor.Events.GutterClick,this._handleGutterClick.bind(this),this),this.textEditor.element.addEventListener("mousedown",this._onMouseDownAndClick.bind(this,!0),!0),this.textEditor.element.addEventListener("click",this._onMouseDownAndClick.bind(this,!1),!0),this._breakpointManager.addEventListener(WebInspector.BreakpointManager.Events.BreakpointAdded,this._breakpointAdded,this),this._breakpointManager.addEventListener(WebInspector.BreakpointManager.Events.BreakpointRemoved,this._breakpointRemoved,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.ConsoleMessageAdded,this._consoleMessageAdded,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.ConsoleMessageRemoved,this._consoleMessageRemoved,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.ConsoleMessagesCleared,this._consoleMessagesCleared,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.SourceMappingChanged,this._onSourceMappingChanged,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._registerShortcuts(),this._updateScriptFile()},WebInspector.JavaScriptSourceFrame.prototype={_registerShortcuts:function(){var e=WebInspector.KeyboardShortcut.Modifiers;this.addShortcut(WebInspector.KeyboardShortcut.makeKey("e",e.Shift|e.Ctrl),this._evaluateSelectionInConsole.bind(this))},_evaluateSelectionInConsole:function(e){var t=this.textEditor.selection();return!t||t.isEmpty()?!1:(WebInspector.evaluateInConsole(this.textEditor.copyRange(t)),!0)},wasShown:function(){WebInspector.UISourceCodeFrame.prototype.wasShown.call(this)},willHide:function(){WebInspector.UISourceCodeFrame.prototype.willHide.call(this),this._popoverHelper.hidePopover()},onUISourceCodeContentChanged:function(){this._removeAllBreakpoints(),WebInspector.UISourceCodeFrame.prototype.onUISourceCodeContentChanged.call(this)},populateLineGutterContextMenu:function(e,t){e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Continue to here":"Continue to Here"),this._continueToLine.bind(this,t));var n=this._breakpointManager.findBreakpoint(this._uiSourceCode,t);n?(e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove breakpoint":"Remove Breakpoint"),n.remove.bind(n)),e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Edit breakpoint…":"Edit Breakpoint…"),this._editBreakpointCondition.bind(this,t,n)),n.enabled()?e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Disable breakpoint":"Disable Breakpoint"),n.setEnabled.bind(n,!1)):e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Enable breakpoint":"Enable Breakpoint"),n.setEnabled.bind(n,!0))):(e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add breakpoint":"Add Breakpoint"),this._setBreakpoint.bind(this,t,"",!0)),e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add conditional breakpoint…":"Add Conditional Breakpoint…"),this._editBreakpointCondition.bind(this,t)))},populateTextAreaContextMenu:function(e,t){var n=this.textEditor.selection();if(n&&!n.isEmpty()){var r=this.textEditor.copyRange(n),i=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add to watch":"Add to Watch");e.appendItem(i,this._scriptsPanel.addToWatch.bind(this._scriptsPanel,r));var s=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Evaluate in console":"Evaluate in Console");e.appendItem(s,WebInspector.evaluateInConsole.bind(WebInspector,r)),e.appendSeparator()}else if(!this._uiSourceCode.isEditable()&&this._uiSourceCode.contentType()===WebInspector.resourceTypes.Script){function o(e){var n=WebInspector.liveEditSupport.uiSourceCodeForLiveEdit(this._uiSourceCode);this._scriptsPanel.showUISourceCode(n,t)}var u=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Live edit":"Live Edit");e.appendItem(u,o.bind(this)),e.appendSeparator()}WebInspector.UISourceCodeFrame.prototype.populateTextAreaContextMenu.call(this,e,t)},_workingCopyChanged:function(e){if(this._supportsEnabledBreakpointsWhileEditing()||this._scriptFile)return;this._uiSourceCode.isDirty()?this._muteBreakpointsWhileEditing():this._restoreBreakpointsAfterEditing()},_workingCopyCommitted:function(e){if(this._supportsEnabledBreakpointsWhileEditing()||this._scriptFile)return;this._restoreBreakpointsAfterEditing()},_didMergeToVM:function(){if(this._supportsEnabledBreakpointsWhileEditing())return;this._restoreBreakpointsAfterEditing()},_didDivergeFromVM:function(){if(this._supportsEnabledBreakpointsWhileEditing())return;this._muteBreakpointsWhileEditing()},_muteBreakpointsWhileEditing:function(){if(this._muted)return;for(var e=0;e<this._textEditor.linesCount;++e){var t=this._textEditor.getAttribute(e,"breakpoint");if(!t)continue;this._removeBreakpointDecoration(e),this._addBreakpointDecoration(e,t.condition,t.enabled,!0)}this._muted=!0},_supportsEnabledBreakpointsWhileEditing:function(){return this._uiSourceCode.project().type()===WebInspector.projectTypes.Snippets},_restoreBreakpointsAfterEditing:function(){delete this._muted;var e={};for(var t=0;t<this._textEditor.linesCount;++t){var n=this._textEditor.getAttribute(t,"breakpoint");n&&(e[t]=n,this._removeBreakpointDecoration(t))}this._removeAllBreakpoints();for(var r in e){var t=parseInt(r,10);if(isNaN(t))continue;var n=e[r];this._setBreakpoint(t,n.condition,n.enabled)}},_removeAllBreakpoints:function(){var e=this._breakpointManager.breakpointsForUISourceCode(this._uiSourceCode);for(var t=0;t<e.length;++t)e[t].remove()},_getPopoverAnchor:function(e,t){if(!WebInspector.debuggerModel.isPaused())return null;var n=this.textEditor.coordinatesToCursorPosition(t.x,t.y);if(!n)return null;var r=n.startLine,i=n.startColumn,s=this.textEditor.selection().normalize();if(s&&!s.isEmpty()){if(s.startLine!==s.endLine||s.startLine!==r||i<s.startColumn||i>s.endColumn)return null;var o=this.textEditor.cursorPositionToCoordinates(s.startLine,s.startColumn),u=this.textEditor.cursorPositionToCoordinates(s.endLine,s.endColumn),a=new AnchorBox(o.x,o.y,u.x-o.x,o.height);return a.highlight={lineNumber:s.startLine,startColumn:s.startColumn,endColumn:s.endColumn-1},a.forSelection=!0,a}var f=this.textEditor.tokenAtTextPosition(n.startLine,n.startColumn);if(!f)return null;var l=n.startLine,c=this.textEditor.line(l),h=c.substring(f.startColumn,f.endColumn+1);if(f.type==="javascript-ident"||f.type==="javascript-keyword"&&h==="this"){var o=this.textEditor.cursorPositionToCoordinates(l,f.startColumn),u=this.textEditor.cursorPositionToCoordinates(l,f.endColumn+1),a=new AnchorBox(o.x,o.y,u.x-o.x,o.height);return a.highlight={lineNumber:l,startColumn:f.startColumn,endColumn:f.endColumn},a}return null},_resolveObjectForPopover:function(e,t,n){function r(n,r){if(!WebInspector.debuggerModel.isPaused()){this._popoverHelper.hidePopover();return}this._popoverAnchorBox=e,t(WebInspector.RemoteObject.fromPayload(n),r,this._popoverAnchorBox);if(this._popoverAnchorBox){var u=new WebInspector.TextRange(i,s,i,o);this._popoverAnchorBox._highlightDescriptor=this.textEditor.highlightRange(u,"source-frame-eval-expression")}}if(!WebInspector.debuggerModel.isPaused()){this._popoverHelper.hidePopover();return}var i=e.highlight.lineNumber,s=e.highlight.startColumn,o=e.highlight.endColumn,u=this.textEditor.line(i);if(!e.forSelection)while(s>1&&u.charAt(s-1)===".")s=this.textEditor.tokenAtTextPosition(i,s-2).startColumn;var a=u.substring(s,o+1),f=WebInspector.debuggerModel.selectedCallFrame();f.evaluate(a,n,!1,!0,!1,!1,r.bind(this))},_onHidePopover:function(){if(!this._popoverAnchorBox)return;this._popoverAnchorBox._highlightDescriptor&&this.textEditor.removeHighlight(this._popoverAnchorBox._highlightDescriptor),delete this._popoverAnchorBox},_addBreakpointDecoration:function(e,t,n,r){var i={condition:t,enabled:n};this.textEditor.setAttribute(e,"breakpoint",i);var s=!n||r;this.textEditor.addBreakpoint(e,s,!!t)},_removeBreakpointDecoration:function(e){this.textEditor.removeAttribute(e,"breakpoint"),this.textEditor.removeBreakpoint(e)},_onKeyDown:function(e){if(e.keyIdentifier==="U+001B"){if(this._popoverHelper.isPopoverVisible()){this._popoverHelper.hidePopover(),e.consume();return}if(this._stepIntoMarkup&&WebInspector.KeyboardShortcut.eventHasCtrlOrMeta(e)){this._stepIntoMarkup.stoptIteratingSelection(),e.consume();return}}},_editBreakpointCondition:function(e,t){function n(n,r,i){this.textEditor.removeDecoration(e,this._conditionElement),delete this._conditionEditorElement,delete this._conditionElement;if(!n)return;t?t.setCondition(i):this._setBreakpoint(e,i,!0)}this._conditionElement=this._createConditionElement(e),this.textEditor.addDecoration(e,this._conditionElement);var r=new WebInspector.EditingConfig(n.bind(this,!0),n.bind(this,!1));WebInspector.startEditing(this._conditionEditorElement,r),this._conditionEditorElement.value=t?t.condition():"",this._conditionEditorElement.select()},_createConditionElement:function(e){var t=document.createElement("div");t.className="source-frame-breakpoint-condition";var n=document.createElement("label");n.className="source-frame-breakpoint-message",n.htmlFor="source-frame-breakpoint-condition",n.appendChild(document.createTextNode(WebInspector.UIString("The breakpoint on line %d will stop only if this expression is true:",e))),t.appendChild(n);var r=document.createElement("input");return r.id="source-frame-breakpoint-condition",r.className="monospace",r.type="text",t.appendChild(r),this._conditionEditorElement=r,t},setExecutionLine:function(e,t){this._executionLineNumber=e,this._executionCallFrame=t;if(this.loaded){this.textEditor.setExecutionLine(e);if(WebInspector.experimentsSettings.stepIntoSelection.isEnabled()){function n(e){if(this._executionCallFrame!==t||this._stepIntoMarkup)return;this._stepIntoMarkup=WebInspector.JavaScriptSourceFrame.StepIntoMarkup.create(this,e),this._stepIntoMarkup&&this._stepIntoMarkup.show()}t.getStepIntoLocations(n.bind(this))}}},clearExecutionLine:function(){this._stepIntoMarkup&&(this._stepIntoMarkup.dispose(),delete this._stepIntoMarkup),this.loaded&&typeof this._executionLineNumber=="number"&&this.textEditor.clearExecutionLine(),delete this._executionLineNumber,delete this._executionCallFrame},_lineNumberAfterEditing:function(e,t,n){var r=e<=t.startLine?0:n.linesCount-t.linesCount;if(e===t.startLine){var i=/^[\s\xA0]*$/;for(var s=0;e+s<=n.endLine;++s)if(!i.test(this.textEditor.line(e+s))){r=s;break}}var o=Math.max(0,e+r);return t.startLine<e&&e<t.endLine&&(o=t.startLine),o},_onMouseDownAndClick:function(e,t){var n=this._stepIntoMarkup;if(!n)return;var r=n.findItemByCoordinates(t.x,t.y);if(typeof r=="undefined")return;if(e)t.consume();else{var i=n.getRawPosition(r);this._scriptsPanel.doStepIntoSelection(i)}},_shouldIgnoreExternalBreakpointEvents:function(){return this._supportsEnabledBreakpointsWhileEditing()?!1:this._muted?!0:this._scriptFile&&(this._scriptFile.isDivergingFromVM()||this._scriptFile.isMergingToVM())},_breakpointAdded:function(e){var t=e.data.uiLocation;if(t.uiSourceCode!==this._uiSourceCode)return;if(this._shouldIgnoreExternalBreakpointEvents())return;var n=e.data.breakpoint;this.loaded&&this._addBreakpointDecoration(t.lineNumber,n.condition(),n.enabled(),!1)},_breakpointRemoved:function(e){var t=e.data.uiLocation;if(t.uiSourceCode!==this._uiSourceCode)return;if(this._shouldIgnoreExternalBreakpointEvents())return;var n=e.data.breakpoint,r=this._breakpointManager.findBreakpoint(this._uiSourceCode,t.lineNumber);!r&&this.loaded&&this._removeBreakpointDecoration(t.lineNumber)},_consoleMessageAdded:function(e){var t=e.data;this.loaded&&this.addMessageToSource(t.lineNumber,t.originalMessage)},_consoleMessageRemoved:function(e){var t=e.data;this.loaded&&this.removeMessageFromSource(t.lineNumber,t.originalMessage)},_consoleMessagesCleared:function(e){this.clearMessages()},_onSourceMappingChanged:function(e){this._updateScriptFile()},_updateScriptFile:function(){this._scriptFile&&(this._scriptFile.removeEventListener(WebInspector.ScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),this._scriptFile.removeEventListener(WebInspector.ScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this),this._muted&&!this._uiSourceCode.isDirty()&&this._restoreBreakpointsAfterEditing()),this._scriptFile=this._uiSourceCode.scriptFile(),this._scriptFile&&(this._scriptFile.addEventListener(WebInspector.ScriptFile.Events.DidMergeToVM,this._didMergeToVM,this),this._scriptFile.addEventListener(WebInspector.ScriptFile.Events.DidDivergeFromVM,this._didDivergeFromVM,this),this.loaded&&this._scriptFile.checkMapping())},onTextEditorContentLoaded:function(){typeof this._executionLineNumber=="number"&&this.setExecutionLine(this._executionLineNumber,this._executionCallFrame);var e=this._breakpointManager.breakpointLocationsForUISourceCode(this._uiSourceCode);for(var t=0;t<e.length;++t)this._breakpointAdded({data:e[t]});var n=this._uiSourceCode.consoleMessages();for(var t=0;t<n.length;++t){var r=n[t];this.addMessageToSource(r.lineNumber,r.originalMessage)}this._scriptFile&&this._scriptFile.checkMapping()},_handleGutterClick:function(e){if(this._muted)return;var t=e.data,n=t.lineNumber,r=t.event;if(r.button!=0||r.altKey||r.ctrlKey||r.metaKey)return;this._toggleBreakpoint(n,r.shiftKey),r.consume(!0)},_toggleBreakpoint:function(e,t){var n=this._breakpointManager.findBreakpoint(this._uiSourceCode,e);n?t?n.setEnabled(!n.enabled()):n.remove():this._setBreakpoint(e,"",!0)},toggleBreakpointOnCurrentLine:function(){if(this._muted)return;var e=this.textEditor.selection();if(!e)return;this._toggleBreakpoint(e.startLine,!1)},_setBreakpoint:function(e,t,n){this._breakpointManager.setBreakpoint(this._uiSourceCode,e,t,n),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.SetBreakpoint,url:this._uiSourceCode.originURL(),line:e,enabled:n})},_continueToLine:function(e){var t=this._uiSourceCode.uiLocationToRawLocation(e,0);this._scriptsPanel.continueToLocation(t)},stepIntoMarkup:function(){return this._stepIntoMarkup},dispose:function(){this._breakpointManager.removeEventListener(WebInspector.BreakpointManager.Events.BreakpointAdded,this._breakpointAdded,this),this._breakpointManager.removeEventListener(WebInspector.BreakpointManager.Events.BreakpointRemoved,this._breakpointRemoved,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.ConsoleMessageAdded,this._consoleMessageAdded,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.ConsoleMessageRemoved,this._consoleMessageRemoved,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.ConsoleMessagesCleared,this._consoleMessagesCleared,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.SourceMappingChanged,this._onSourceMappingChanged,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),WebInspector.UISourceCodeFrame.prototype.dispose.call(this)},__proto__:WebInspector.UISourceCodeFrame.prototype},WebInspector.JavaScriptSourceFrame.StepIntoMarkup=function(e,t,n,r){this._positions=e,this._editorRanges=t,this._highlightDescriptors=new Array(e.length),this._currentHighlight=undefined,this._firstToExecute=n,this._currentSelection=undefined,this._sourceFrame=r},WebInspector.JavaScriptSourceFrame.StepIntoMarkup.prototype={show:function(){var e=this._getVisibleHighlight();for(var t=0;t<this._positions.length;++t)this._highlightItem(t,t===e);this._shownVisibleHighlight=e},startIteratingSelection:function(){this._currentSelection=this._positions.length,this._redrawHighlight()},stopIteratingSelection:function(){this._currentSelection=undefined,this._redrawHighlight()},iterateSelection:function(e){if(typeof this._currentSelection=="undefined")return;var t=e?this._currentSelection-1:this._currentSelection+1,n=this._positions.length+1;t=(t+n)%n,this._currentSelection=t,this._redrawHighlight()},_redrawHighlight:function(){var e=this._getVisibleHighlight();if(this._shownVisibleHighlight===e)return;this._hideItemHighlight(this._shownVisibleHighlight),this._hideItemHighlight(e),this._highlightItem(this._shownVisibleHighlight,!1),this._highlightItem(e,!0),this._shownVisibleHighlight=e},_getVisibleHighlight:function(){return typeof this._currentSelection=="undefined"?this._firstToExecute:this._currentSelection},_highlightItem:function(e,t){if(e===this._positions.length)return;var n=t?"source-frame-stepin-mark-highlighted":"source-frame-stepin-mark",r=this._sourceFrame.textEditor,i=r.highlightRange(this._editorRanges[e],n);this._highlightDescriptors[e]=i},_hideItemHighlight:function(e){if(e===this._positions.length)return;var t=this._highlightDescriptors[e];console.assert(t);var n=this._sourceFrame.textEditor;n.removeHighlight(t),this._highlightDescriptors[e]=undefined},dispose:function(){for(var e=0;e<this._positions.length;++e)this._hideItemHighlight(e)},findItemByCoordinates:function(e,t){var n=this._sourceFrame.textEditor.coordinatesToCursorPosition(e,t);if(!n)return;var r=this._editorRanges;for(var i=0;i<r.length;++i){var s=r[i];if(s.startLine==n.startLine&&s.startColumn<=n.startColumn&&s.endColumn>=n.startColumn)return i}},getSelectedItemIndex:function(){return this._currentSelection===this._positions.length?undefined:this._currentSelection},getRawPosition:function(e){return this._positions[e]}},WebInspector.JavaScriptSourceFrame.StepIntoMarkup.create=function(e,t){if(!t.length)return null;var n=t[0];t.sort(WebInspector.JavaScriptSourceFrame.StepIntoMarkup._Comparator);var r=t.indexOf(n),i=e.textEditor,s=[];for(var o=0;o<t.length;++o){var u=WebInspector.debuggerModel.rawLocationToUILocation(t[o]),a=i.tokenAtTextPosition(u.lineNumber,u.columnNumber),f,l;a?(f=a.startColumn,l=a.endColumn):(f=u.columnNumber,l=u.columnNumber);var c=new WebInspector.TextRange(u.lineNumber,f,u.lineNumber,l);s.push(c)}return new WebInspector.JavaScriptSourceFrame.StepIntoMarkup(t,s,r,e)},WebInspector.JavaScriptSourceFrame.StepIntoMarkup._Comparator=function(e,t){return e.lineNumber===t.lineNumber?e.columnNumber-t.columnNumber:e.lineNumber-t.lineNumber};