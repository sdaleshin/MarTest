/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ResourceTreeModel=function(e){e.addEventListener(WebInspector.NetworkManager.EventTypes.RequestFinished,this._onRequestFinished,this),e.addEventListener(WebInspector.NetworkManager.EventTypes.RequestUpdateDropped,this._onRequestUpdateDropped,this),WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.MessageAdded,this._consoleMessageAdded,this),WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.RepeatCountUpdated,this._consoleMessageAdded,this),WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.ConsoleCleared,this._consoleCleared,this),PageAgent.enable(),NetworkAgent.enable(),this._fetchResourceTree(),InspectorBackend.registerPageDispatcher(new WebInspector.PageDispatcher(this)),this._pendingConsoleMessages={},this._securityOriginFrameCount={}},WebInspector.ResourceTreeModel.EventTypes={FrameAdded:"FrameAdded",FrameNavigated:"FrameNavigated",FrameDetached:"FrameDetached",MainFrameNavigated:"MainFrameNavigated",MainFrameCreatedOrNavigated:"MainFrameCreatedOrNavigated",ResourceAdded:"ResourceAdded",WillLoadCachedResources:"WillLoadCachedResources",CachedResourcesLoaded:"CachedResourcesLoaded",DOMContentLoaded:"DOMContentLoaded",Load:"Load",InspectedURLChanged:"InspectedURLChanged",SecurityOriginAdded:"SecurityOriginAdded",SecurityOriginRemoved:"SecurityOriginRemoved",ScreencastFrame:"ScreencastFrame"},WebInspector.ResourceTreeModel.prototype={_fetchResourceTree:function(){this._frames={},delete this._cachedResourcesProcessed,PageAgent.getResourceTree(this._processCachedResources.bind(this))},_processCachedResources:function(e,t){if(e){console.error(JSON.stringify(e));return}this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.WillLoadCachedResources),WebInspector.inspectedPageURL=t.frame.url,this._addFramesRecursively(null,t),this._dispatchInspectedURLChanged(),this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.CachedResourcesLoaded),this._cachedResourcesProcessed=!0},cachedResourcesLoaded:function(){return this._cachedResourcesProcessed},_dispatchInspectedURLChanged:function(){InspectorFrontendHost.inspectedURLChanged(WebInspector.inspectedPageURL),this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.InspectedURLChanged,WebInspector.inspectedPageURL)},_addFrame:function(e,t){this._frames[e.id]=e,e.isMainFrame()&&(this.mainFrame=e),this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.FrameAdded,e),t||this._addSecurityOrigin(e.securityOrigin),e.isMainFrame()&&this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.MainFrameCreatedOrNavigated,e)},_addSecurityOrigin:function(e){if(!this._securityOriginFrameCount[e]){this._securityOriginFrameCount[e]=1,this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.SecurityOriginAdded,e);return}this._securityOriginFrameCount[e]+=1},_removeSecurityOrigin:function(e){console.assert(this._securityOriginFrameCount[e]);if(this._securityOriginFrameCount[e]===1){delete this._securityOriginFrameCount[e],this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.SecurityOriginRemoved,e);return}this._securityOriginFrameCount[e]-=1},securityOrigins:function(){return Object.keys(this._securityOriginFrameCount)},_handleMainFrameDetached:function(e){function t(e){for(var n=0;n<e.childFrames.length;++n)t.call(this,e.childFrames[n]);e.isMainFrame()||this._removeSecurityOrigin(e.securityOrigin)}t.call(this,WebInspector.resourceTreeModel.mainFrame)},_frameNavigated:function(e){if(!this._cachedResourcesProcessed)return;var t=this._frames[e.id],n;if(t)this._removeSecurityOrigin(t.securityOrigin),t._navigate(e),n=t.securityOrigin;else{var r=e.parentId?this._frames[e.parentId]:null;t=new WebInspector.ResourceTreeFrame(this,r,e),t.isMainFrame()&&this.mainFrame&&(this._handleMainFrameDetached(this.mainFrame),this._frameDetached(this.mainFrame.id)),this._addFrame(t,!0),n=t.securityOrigin}t.isMainFrame()&&(WebInspector.inspectedPageURL=t.url),this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.FrameNavigated,t),t.isMainFrame()&&(this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.MainFrameNavigated,t),this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.MainFrameCreatedOrNavigated,t)),n&&this._addSecurityOrigin(n);var i=t.resources();for(var s=0;s<i.length;++s)this.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.ResourceAdded,i[s]);t.isMainFrame()&&this._dispatchInspectedURLChanged()},_frameDetached:function(e){if(!this._cachedResourcesProcessed)return;var t=this._frames[e];if(!t)return;this._removeSecurityOrigin(t.securityOrigin),t.parentFrame?t.parentFrame._removeChildFrame(t):t._remove()},_onRequestFinished:function(e){if(!this._cachedResourcesProcessed)return;var t=e.data;if(t.failed||t.type===WebInspector.resourceTypes.XHR)return;var n=this._frames[t.frameId];if(n){var r=n._addRequest(t);this._addPendingConsoleMessagesToResource(r)}},_onRequestUpdateDropped:function(e){if(!this._cachedResourcesProcessed)return;var t=e.data.frameId,n=this._frames[t];if(!n)return;var r=e.data.url;if(n._resourcesMap[r])return;var i=new WebInspector.Resource(null,r,n.url,t,e.data.loaderId,WebInspector.resourceTypes[e.data.resourceType],e.data.mimeType);n.addResource(i)},frameForId:function(e){return this._frames[e]},forAllResources:function(e){return this.mainFrame?this.mainFrame._callForFrameResources(e):!1},frames:function(){return Object.values(this._frames)},_consoleMessageAdded:function(e){var t=e.data,n=t.url?this.resourceForURL(t.url):null;n?this._addConsoleMessageToResource(t,n):this._addPendingConsoleMessage(t)},_addPendingConsoleMessage:function(e){if(!e.url)return;this._pendingConsoleMessages[e.url]||(this._pendingConsoleMessages[e.url]=[]),this._pendingConsoleMessages[e.url].push(e)},_addPendingConsoleMessagesToResource:function(e){var t=this._pendingConsoleMessages[e.url];if(t){for(var n=0;n<t.length;n++)this._addConsoleMessageToResource(t[n],e);delete this._pendingConsoleMessages[e.url]}},_addConsoleMessageToResource:function(e,t){switch(e.level){case WebInspector.ConsoleMessage.MessageLevel.Warning:t.warnings+=e.repeatDelta;break;case WebInspector.ConsoleMessage.MessageLevel.Error:t.errors+=e.repeatDelta}t.addMessage(e)},_consoleCleared:function(){function e(e){e.clearErrorsAndWarnings()}this._pendingConsoleMessages={},this.forAllResources(e)},resourceForURL:function(e){return this.mainFrame?this.mainFrame.resourceForURL(e):null},_addFramesRecursively:function(e,t){var n=t.frame,r=new WebInspector.ResourceTreeFrame(this,e,n);this._addFrame(r);var i=this._createResourceFromFramePayload(n,n.url,WebInspector.resourceTypes.Document,n.mimeType);r.isMainFrame()&&(WebInspector.inspectedPageURL=i.url),r.addResource(i);for(var s=0;t.childFrames&&s<t.childFrames.length;++s)this._addFramesRecursively(r,t.childFrames[s]);for(var s=0;s<t.resources.length;++s){var o=t.resources[s],u=this._createResourceFromFramePayload(n,o.url,WebInspector.resourceTypes[o.type],o.mimeType);r.addResource(u)}},_createResourceFromFramePayload:function(e,t,n,r){return new WebInspector.Resource(null,t,e.url,e.id,e.loaderId,n,r)},__proto__:WebInspector.Object.prototype},WebInspector.ResourceTreeFrame=function(e,t,n){this._model=e,this._parentFrame=t,this._id=n.id,this._loaderId=n.loaderId,this._name=n.name,this._url=n.url,this._securityOrigin=n.securityOrigin,this._mimeType=n.mimeType,this._childFrames=[],this._resourcesMap={},this._parentFrame&&this._parentFrame._childFrames.push(this)},WebInspector.ResourceTreeFrame.prototype={get id(){return this._id},get name(){return this._name||""},get url(){return this._url},get securityOrigin(){return this._securityOrigin},get loaderId(){return this._loaderId},get parentFrame(){return this._parentFrame},get childFrames(){return this._childFrames},isMainFrame:function(){return!this._parentFrame},_navigate:function(e){this._loaderId=e.loaderId,this._name=e.name,this._url=e.url,this._securityOrigin=e.securityOrigin,this._mimeType=e.mimeType;var t=this._resourcesMap[this._url];this._resourcesMap={},this._removeChildFrames(),t&&t.loaderId===this._loaderId&&this.addResource(t)},get mainResource(){return this._resourcesMap[this._url]},_removeChildFrame:function(e){this._childFrames.remove(e),e._remove()},_removeChildFrames:function(){var e=this._childFrames;this._childFrames=[];for(var t=0;t<e.length;++t)e[t]._remove()},_remove:function(){this._removeChildFrames(),delete this._model._frames[this.id],this._model.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.FrameDetached,this)},addResource:function(e){if(this._resourcesMap[e.url]===e)return;this._resourcesMap[e.url]=e,this._model.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.ResourceAdded,e)},_addRequest:function(e){var t=this._resourcesMap[e.url];return t&&t.request===e?t:(t=new WebInspector.Resource(e,e.url,e.documentURL,e.frameId,e.loaderId,e.type,e.mimeType),this._resourcesMap[t.url]=t,this._model.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.ResourceAdded,t),t)},resources:function(){var e=[];for(var t in this._resourcesMap)e.push(this._resourcesMap[t]);return e},resourceForURL:function(e){function n(n){if(n.url===e)return t=n,!0}var t;return this._callForFrameResources(n),t},_callForFrameResources:function(e){for(var t in this._resourcesMap)if(e(this._resourcesMap[t]))return!0;for(var n=0;n<this._childFrames.length;++n)if(this._childFrames[n]._callForFrameResources(e))return!0;return!1}},WebInspector.PageDispatcher=function(e){this._resourceTreeModel=e},WebInspector.PageDispatcher.prototype={domContentEventFired:function(e){this._resourceTreeModel.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.DOMContentLoaded,e)},loadEventFired:function(e){this._resourceTreeModel.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.Load,e)},frameAttached:function(e){},frameNavigated:function(e){this._resourceTreeModel._frameNavigated(e)},frameDetached:function(e){this._resourceTreeModel._frameDetached(e)},frameStartedLoading:function(e){},frameStoppedLoading:function(e){},frameScheduledNavigation:function(e,t){},frameClearedScheduledNavigation:function(e){},javascriptDialogOpening:function(e){},javascriptDialogClosed:function(){},scriptsEnabled:function(e){WebInspector.settings.javaScriptDisabled.set(!e)},screencastFrame:function(e,t,n,r,i,s){this._resourceTreeModel.dispatchEventToListeners(WebInspector.ResourceTreeModel.EventTypes.ScreencastFrame,{data:e,deviceScaleFactor:t,pageScaleFactor:n,viewport:r,offsetTop:i,offsetBottom:s})}},WebInspector.resourceTreeModel=null;