/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.Layers3DView=function(e){WebInspector.View.call(this),this.element.classList.add("fill"),this.element.classList.add("layers-3d-view"),this._emptyView=new WebInspector.EmptyView(WebInspector.UIString("Not in the composited mode.\nConsider forcing composited mode in Settings.")),this._model=e,this._model.addEventListener(WebInspector.LayerTreeModel.Events.LayerTreeChanged,this._update,this),this._rotatingContainerElement=this.element.createChild("div","fill rotating-container"),this.element.addEventListener("mousemove",this._onMouseMove.bind(this),!1),this.element.addEventListener("mouseout",this._onMouseMove.bind(this),!1),this.element.addEventListener("mousedown",this._onMouseDown.bind(this),!1),this.element.addEventListener("mouseup",this._onMouseUp.bind(this),!1),this.element.addEventListener("contextmenu",this._onContextMenu.bind(this),!1),this.element.addEventListener("click",this._onClick.bind(this),!1),this._elementsByLayerId={},this._rotateX=0,this._rotateY=0,this._scaleAdjustmentStylesheet=this.element.ownerDocument.head.createChild("style"),this._scaleAdjustmentStylesheet.disabled=!0,this._lastOutlinedElement={}},WebInspector.Layers3DView.OutlineType={Hovered:"hovered",Selected:"selected"},WebInspector.Layers3DView.Events={LayerHovered:"LayerHovered",LayerSelected:"LayerSelected"},WebInspector.Layers3DView.prototype={onResize:function(){this._update()},willHide:function(){this._scaleAdjustmentStylesheet.disabled=!0},wasShown:function(){this._scaleAdjustmentStylesheet.disabled=!1,this._needsUpdate&&this._update()},_setOutline:function(e,t){var n=t?this._elementForLayer(t):null,r=this._lastOutlinedElement[e];if(r===n)return;this._lastOutlinedElement[e]=n,r&&(r.removeStyleClass(e),this._updateElementColor(r)),n&&(n.addStyleClass(e),this._updateElementColor(n))},hoverLayer:function(e){this._setOutline(WebInspector.Layers3DView.OutlineType.Hovered,e)},selectLayer:function(e){this._setOutline(WebInspector.Layers3DView.OutlineType.Hovered,null),this._setOutline(WebInspector.Layers3DView.OutlineType.Selected,e)},_scaleToFit:function(){var e=this._model.contentRoot();if(!e)return;const t=40;var n=this._clientWidth/(e.width()+2*t),r=this._clientHeight/(e.height()+2*t);this._scale=Math.min(n,r);const i=20;this._layerSpacing=Math.ceil(i/this._scale)+"px";const s=4;var o=Math.ceil(s/this._scale)+"px",u=".layer-container .side-wall { height: "+o+"; width: "+o+"; } "+".layer-container .back-wall { -webkit-transform: translateZ(-"+o+"); } "+".layer-container { -webkit-transform: translateZ("+this._layerSpacing+"); }",a=this._scaleAdjustmentStylesheet.firstChild;!a||a.nodeType!==Node.TEXT_NODE||a.nextSibling?this._scaleAdjustmentStylesheet.textContent=u:a.nodeValue=u;var f=this._elementForLayer(e);f.style.webkitTransform="scale3d("+this._scale+","+this._scale+","+this._scale+")",f.style.left=(this._clientWidth-e.width()*this._scale>>1)+"px",f.style.top=(this._clientHeight-e.height()*this._scale>>1)+"px"},_update:function(){function e(e){var t=this._elementForLayer(e);this._updateLayerElement(t);for(var n=t.firstElementChild;n;){var r=n.nextSibling;n.__layer&&!this._model.layerById(n.__layer.id())&&n.remove(),n=r}}if(!this.isShowing()){this._needsUpdate=!0;return}if(!this._model.contentRoot()){this._emptyView.show(this.element);return}this._emptyView.detach(),this._clientWidth=this.element.clientWidth,this._clientHeight=this.element.clientHeight,this._scaleToFit(),this._model.forEachLayer(e.bind(this),this._model.contentRoot()),this._needsUpdate=!1},_elementForLayer:function(e){var t=this._elementsByLayerId[e.id()];return t?t:(t=document.createElement("div"),t.className="layer-container",t.__layer=e,["fill back-wall","side-wall top","side-wall right","side-wall bottom","side-wall left"].forEach(t.createChild.bind(t,"div")),this._elementsByLayerId[e.id()]=t,t)},_updateLayerElement:function(e){var t=e.__layer,n=e.style,r=t===this._model.contentRoot(),i=r?this._rotatingContainerElement:this._elementForLayer(t.parent());e.__depth=(i.__depth||0)+1,e.enableStyleClass("invisible",t.invisible()),this._updateElementColor(e),i!==e.parentElement&&i.appendChild(e),n.width=t.width()+"px",n.height=t.height()+"px";if(r)return;n.left=t.offsetX()+"px",n.top=t.offsetY()+"px";var s=t.transform();if(s){function o(e){return e.toFixed(5)}n.webkitTransform="matrix3d("+s.map(o).join(",")+") translateZ("+this._layerSpacing+")";var u=t.anchorPoint();n.webkitTransformOrigin=Math.round(u[0]*100)+"% "+Math.round(u[1]*100)+"% "+u[2]}else n.webkitTransform="",n.webkitTransformOrigin=""},_updateElementColor:function(e){var t;if(e===this._lastOutlinedElement[WebInspector.Layers3DView.OutlineType.Selected])t=WebInspector.Color.PageHighlight.Content.toString(WebInspector.Color.Format.RGBA)||"";else{const n=144;var r=n+20*((e.__depth-1)%5);t="rgba("+r+","+r+","+r+", 0.8)"}e.style.backgroundColor=t},_onMouseDown:function(e){if(e.which!==1)return;this._setReferencePoint(e)},_setReferencePoint:function(e){this._originX=e.clientX,this._originY=e.clientY,this._oldRotateX=this._rotateX,this._oldRotateY=this._rotateY},_resetReferencePoint:function(){delete this._originX,delete this._originY,delete this._oldRotateX,delete this._oldRotateY},_onMouseUp:function(e){if(e.which!==1)return;this._resetReferencePoint()},_layerFromEventPoint:function(e){var t=this.element.ownerDocument.elementFromPoint(e.pageX,e.pageY);return t?(t=t.enclosingNodeOrSelfWithClass("layer-container"),t&&t.__layer):null},_onMouseMove:function(e){if(!e.which){this.dispatchEventToListeners(WebInspector.Layers3DView.Events.LayerHovered,this._layerFromEventPoint(e));return}e.which===1&&(typeof this._originX!="number"&&this._setReferencePoint(e),this._rotateX=this._oldRotateX+(this._originY-e.clientY)/2,this._rotateY=this._oldRotateY-(this._originX-e.clientX)/4,this._rotatingContainerElement.style.webkitTransform="translateZ(10000px) rotateX("+this._rotateX+"deg) rotateY("+this._rotateY+"deg)")},_onContextMenu:function(e){var t=this._layerFromEventPoint(e),n=t&&t.nodeId();if(!n)return;var r=WebInspector.domAgent.nodeForId(n);if(!r)return;var i=new WebInspector.ContextMenu(e);i.appendApplicableItems(r),i.show()},_onClick:function(e){this.dispatchEventToListeners(WebInspector.Layers3DView.Events.LayerSelected,this._layerFromEventPoint(e))},__proto__:WebInspector.View.prototype};