/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.DOMBreakpointsSidebarPane=function(){WebInspector.NativeBreakpointsSidebarPane.call(this,WebInspector.UIString("DOM Breakpoints")),this._breakpointElements={},this._breakpointTypes={SubtreeModified:"subtree-modified",AttributeModified:"attribute-modified",NodeRemoved:"node-removed"},this._breakpointTypeLabels={},this._breakpointTypeLabels[this._breakpointTypes.SubtreeModified]=WebInspector.UIString("Subtree Modified"),this._breakpointTypeLabels[this._breakpointTypes.AttributeModified]=WebInspector.UIString("Attribute Modified"),this._breakpointTypeLabels[this._breakpointTypes.NodeRemoved]=WebInspector.UIString("Node Removed"),this._contextMenuLabels={},this._contextMenuLabels[this._breakpointTypes.SubtreeModified]=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Subtree modifications":"Subtree Modifications"),this._contextMenuLabels[this._breakpointTypes.AttributeModified]=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Attributes modifications":"Attributes Modifications"),this._contextMenuLabels[this._breakpointTypes.NodeRemoved]=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Node removal":"Node Removal"),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.InspectedURLChanged,this._inspectedURLChanged,this),WebInspector.domAgent.addEventListener(WebInspector.DOMAgent.Events.NodeRemoved,this._nodeRemoved,this)},WebInspector.DOMBreakpointsSidebarPane.prototype={_inspectedURLChanged:function(e){this._breakpointElements={},this._reset();var t=e.data;this._inspectedURL=t.removeURLFragment()},populateNodeContextMenu:function(e,t){function s(t){n[t]?this._removeBreakpoint(e,t):this._setBreakpoint(e,t,!0),this._saveBreakpoints()}var n={};for(var r in this._breakpointElements){var i=this._breakpointElements[r];i._node===e&&(n[i._type]=!0)}var o=t.appendSubMenuItem(WebInspector.UIString("Break on..."));for(var u in this._breakpointTypes){var a=this._breakpointTypes[u],f=this._contextMenuLabels[a];o.appendCheckboxItem(f,s.bind(this,a),n[a])}},createBreakpointHitStatusMessage:function(e,t){if(e.type===this._breakpointTypes.SubtreeModified){var n=WebInspector.RemoteObject.fromPayload(e.targetNode);function r(r){r&&n.release(),this._doCreateBreakpointHitStatusMessage(e,r,t)}n.pushNodeToFrontend(r.bind(this))}else this._doCreateBreakpointHitStatusMessage(e,null,t)},_doCreateBreakpointHitStatusMessage:function(e,t,n){function l(e,t){typeof t=="string"&&(t=document.createTextNode(t)),a.appendChild(t)}var r,i=this._breakpointTypeLabels[e.type],s=WebInspector.DOMPresentationUtils.linkifyNodeById(e.nodeId),o=[i,s],u="";t&&(u=WebInspector.DOMPresentationUtils.linkifyNodeById(t)),e.type===this._breakpointTypes.SubtreeModified?e.insertion?t!==e.nodeId?(r='Paused on a "%s" breakpoint set on %s, because a new child was added to its descendant %s.',o.push(u)):r='Paused on a "%s" breakpoint set on %s, because a new child was added to that node.':(r='Paused on a "%s" breakpoint set on %s, because its descendant %s was removed.',o.push(u)):r='Paused on a "%s" breakpoint set on %s.';var a=document.createElement("span"),f={s:function(e){return e}};WebInspector.formatLocalized(r,o,f,"",l),n(a)},_nodeRemoved:function(e){var t=e.data.node;this._removeBreakpointsForNode(e.data.node);var n=t.children();if(!n)return;for(var r=0;r<n.length;++r)this._removeBreakpointsForNode(n[r]);this._saveBreakpoints()},_removeBreakpointsForNode:function(e){for(var t in this._breakpointElements){var n=this._breakpointElements[t];n._node===e&&this._removeBreakpoint(n._node,n._type)}},_setBreakpoint:function(e,t,n){var r=this._createBreakpointId(e.id,t);if(r in this._breakpointElements)return;var i=document.createElement("li");i._node=e,i._type=t,i.addEventListener("contextmenu",this._contextMenu.bind(this,e,t),!0);var s=document.createElement("input");s.className="checkbox-elem",s.type="checkbox",s.checked=n,s.addEventListener("click",this._checkboxClicked.bind(this,e,t),!1),i._checkboxElement=s,i.appendChild(s);var o=document.createElement("span");i.appendChild(o);var u=WebInspector.DOMPresentationUtils.linkifyNodeById(e.id);u.addStyleClass("monospace"),o.appendChild(u);var a=document.createElement("div");a.className="source-text",a.textContent=this._breakpointTypeLabels[t],o.appendChild(a);var f=this.listElement.firstChild;while(f){if(f._type&&f._type<i._type)break;f=f.nextSibling}this._addListElement(i,f),this._breakpointElements[r]=i,n&&DOMDebuggerAgent.setDOMBreakpoint(e.id,t)},_removeAllBreakpoints:function(){for(var e in this._breakpointElements){var t=this._breakpointElements[e];this._removeBreakpoint(t._node,t._type)}this._saveBreakpoints()},_removeBreakpoint:function(e,t){var n=this._createBreakpointId(e.id,t),r=this._breakpointElements[n];if(!r)return;this._removeListElement(r),delete this._breakpointElements[n],r._checkboxElement.checked&&DOMDebuggerAgent.removeDOMBreakpoint(e.id,t)},_contextMenu:function(e,t,n){function i(){this._removeBreakpoint(e,t),this._saveBreakpoints()}var r=new WebInspector.ContextMenu(n);r.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove breakpoint":"Remove Breakpoint"),i.bind(this)),r.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove all DOM breakpoints":"Remove All DOM Breakpoints"),this._removeAllBreakpoints.bind(this)),r.show()},_checkboxClicked:function(e,t,n){n.target.checked?DOMDebuggerAgent.setDOMBreakpoint(e.id,t):DOMDebuggerAgent.removeDOMBreakpoint(e.id,t),this._saveBreakpoints()},highlightBreakpoint:function(e){var t=this._createBreakpointId(e.nodeId,e.type),n=this._breakpointElements[t];if(!n)return;this.expand(),n.addStyleClass("breakpoint-hit"),this._highlightedElement=n},clearBreakpointHighlight:function(){this._highlightedElement&&(this._highlightedElement.removeStyleClass("breakpoint-hit"),delete this._highlightedElement)},_createBreakpointId:function(e,t){return e+":"+t},_saveBreakpoints:function(){var e=[],t=WebInspector.settings.domBreakpoints.get();for(var n=0;n<t.length;++n){var r=t[n];r.url!==this._inspectedURL&&e.push(r)}for(var i in this._breakpointElements){var s=this._breakpointElements[i];e.push({url:this._inspectedURL,path:s._node.path(),type:s._type,enabled:s._checkboxElement.checked})}WebInspector.settings.domBreakpoints.set(e)},restoreBreakpoints:function(){function t(t,n){var r=n?WebInspector.domAgent.nodeForId(n):null;if(!r)return;var i=e[t];for(var s=0;s<i.length;++s)this._setBreakpoint(r,i[s].type,i[s].enabled)}var e={},n=WebInspector.settings.domBreakpoints.get();for(var r=0;r<n.length;++r){var i=n[r];if(i.url!==this._inspectedURL)continue;var s=i.path;e[s]||(e[s]=[],WebInspector.domAgent.pushNodeByPathToFrontend(s,t.bind(this,s))),e[s].push(i)}},createProxy:function(e){var t=new WebInspector.DOMBreakpointsSidebarPane.Proxy(this,e);return this._proxies||(this._proxies=[]),this._proxies.push(t),t},onContentReady:function(){for(var e=0;e!=this._proxies.length;e++)this._proxies[e].onContentReady()},__proto__:WebInspector.NativeBreakpointsSidebarPane.prototype},WebInspector.DOMBreakpointsSidebarPane.Proxy=function(e,t){WebInspector.View._assert(!e.titleElement.firstChild,"Cannot create proxy for a sidebar pane with a toolbar"),WebInspector.SidebarPane.call(this,e.title()),this.registerRequiredCSS("breakpointsList.css"),this._wrappedPane=e,this._panel=t,this.bodyElement.remove(),this.bodyElement=this._wrappedPane.bodyElement},WebInspector.DOMBreakpointsSidebarPane.Proxy.prototype={expand:function(){this._wrappedPane.expand()},onContentReady:function(){this._panel.isShowing()&&this._reattachBody(),WebInspector.SidebarPane.prototype.onContentReady.call(this)},wasShown:function(){WebInspector.SidebarPane.prototype.wasShown.call(this),this._reattachBody()},_reattachBody:function(){this.bodyElement.parentNode!==this.element&&this.element.appendChild(this.bodyElement)},__proto__:WebInspector.SidebarPane.prototype},WebInspector.domBreakpointsSidebarPane=null;