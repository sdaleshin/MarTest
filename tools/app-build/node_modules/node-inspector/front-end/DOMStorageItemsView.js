/*
 * Copyright (C) 2008 Nokia Inc.  All rights reserved.
 * Copyright (C) 2013 Samsung Electronics. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.DOMStorageItemsView=function(e){WebInspector.View.call(this),this.domStorage=e,this.element.addStyleClass("storage-view"),this.element.addStyleClass("table"),this.deleteButton=new WebInspector.StatusBarButton(WebInspector.UIString("Delete"),"delete-storage-status-bar-item"),this.deleteButton.visible=!1,this.deleteButton.addEventListener("click",this._deleteButtonClicked,this),this.refreshButton=new WebInspector.StatusBarButton(WebInspector.UIString("Refresh"),"refresh-storage-status-bar-item"),this.refreshButton.addEventListener("click",this._refreshButtonClicked,this),this.domStorage.addEventListener(WebInspector.DOMStorage.Events.DOMStorageItemsCleared,this._domStorageItemsCleared,this),this.domStorage.addEventListener(WebInspector.DOMStorage.Events.DOMStorageItemRemoved,this._domStorageItemRemoved,this),this.domStorage.addEventListener(WebInspector.DOMStorage.Events.DOMStorageItemAdded,this._domStorageItemAdded,this),this.domStorage.addEventListener(WebInspector.DOMStorage.Events.DOMStorageItemUpdated,this._domStorageItemUpdated,this)},WebInspector.DOMStorageItemsView.prototype={get statusBarItems(){return[this.refreshButton.element,this.deleteButton.element]},wasShown:function(){this._update()},willHide:function(){this.deleteButton.visible=!1},_domStorageItemsCleared:function(e){if(!this.isShowing()||!this._dataGrid)return;this._dataGrid.rootNode().removeChildren(),this._dataGrid.addCreationNode(!1),this.deleteButton.visible=!1,e.consume(!0)},_domStorageItemRemoved:function(e){if(!this.isShowing()||!this._dataGrid)return;var t=e.data,n=this._dataGrid.rootNode(),r=n.children;e.consume(!0);for(var i=0;i<r.length;++i){var s=r[i];if(s.data.key===t.key){n.removeChild(s),this.deleteButton.visible=r.length>1;return}}},_domStorageItemAdded:function(e){if(!this.isShowing()||!this._dataGrid)return;var t=e.data,n=this._dataGrid.rootNode(),r=n.children;e.consume(!0),this.deleteButton.visible=!0;for(var i=0;i<r.length;++i)if(r[i].data.key===t.key)return;var s=new WebInspector.DataGridNode({key:t.key,value:t.value},!1);n.insertChild(s,r.length-1)},_domStorageItemUpdated:function(e){if(!this.isShowing()||!this._dataGrid)return;var t=e.data,n=this._dataGrid.rootNode(),r=n.children;e.consume(!0);var i=!1;for(var s=0;s<r.length;++s){var o=r[s];if(o.data.key===t.key){if(i){n.removeChild(o);return}i=!0,o.data.value!==t.value&&(o.data.value=t.value,o.refresh(),o.select(),o.reveal()),this.deleteButton.visible=!0}}},_update:function(){this.detachChildViews(),this.domStorage.getItems(this._showDOMStorageItems.bind(this))},_showDOMStorageItems:function(e,t){if(e)return;this._dataGrid=this._dataGridForDOMStorageItems(t),this._dataGrid.show(this.element),this.deleteButton.visible=this._dataGrid.rootNode().children.length>1},_dataGridForDOMStorageItems:function(e){var t=[{id:"key",title:WebInspector.UIString("Key"),editable:!0,weight:50},{id:"value",title:WebInspector.UIString("Value"),editable:!0,weight:50}],n=[],r=[],i=e.length;for(var s=0;s<e.length;s++){var o=e[s][0],u=e[s][1],a=new WebInspector.DataGridNode({key:o,value:u},!1);a.selectable=!0,n.push(a),r.push(o)}var f=new WebInspector.DataGrid(t,this._editingCallback.bind(this),this._deleteCallback.bind(this));f.setName("DOMStorageItemsView"),i=n.length;for(var s=0;s<i;++s)f.rootNode().appendChild(n[s]);return f.addCreationNode(!1),i>0&&(n[0].selected=!0),f},_deleteButtonClicked:function(e){if(!this._dataGrid||!this._dataGrid.selectedNode)return;this._deleteCallback(this._dataGrid.selectedNode),this._dataGrid.changeNodeAfterDeletion()},_refreshButtonClicked:function(e){this._update()},_editingCallback:function(e,t,n,r){var i=this.domStorage;"key"===t?(typeof n=="string"&&i.removeItem(n),i.setItem(r,e.data.value||""),this._removeDupes(e)):i.setItem(e.data.key||"",r)},_removeDupes:function(e){var t=this._dataGrid.rootNode(),n=t.children;for(var r=n.length-1;r>=0;--r){var i=n[r];i.data.key===e.data.key&&e!==i&&t.removeChild(i)}},_deleteCallback:function(e){if(!e||e.isCreationNode)return;this.domStorage&&this.domStorage.removeItem(e.data.key)},__proto__:WebInspector.View.prototype};