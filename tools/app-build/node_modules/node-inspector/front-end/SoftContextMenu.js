/*
 * Copyright (C) 2011 Google Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.SoftContextMenu=function(e,t){this._items=e,this._parentMenu=t},WebInspector.SoftContextMenu.prototype={show:function(e,t){this._x=e.x,this._y=e.y,this._time=(new Date).getTime();var n=e.pageX,r=e.pageY,i=e.target;while(i&&window!==i.ownerDocument.defaultView){var s=i.ownerDocument.defaultView.frameElement;r+=s.totalOffsetTop(),n+=s.totalOffsetLeft(),i=s}var o;this._contextMenuElement=document.createElement("div"),this._contextMenuElement.className="soft-context-menu",this._contextMenuElement.tabIndex=0,t&&(o=e.currentTarget.getBoundingClientRect(),n=o.left,r=o.bottom),this._contextMenuElement.style.top=r+"px",this._contextMenuElement.style.left=n+"px",this._contextMenuElement.addEventListener("mouseup",consumeEvent,!1),this._contextMenuElement.addEventListener("keydown",this._menuKeyDown.bind(this),!1);for(var u=0;u<this._items.length;++u)this._contextMenuElement.appendChild(this._createMenuItem(this._items[u]));this._parentMenu?this._parentMenu._parentGlassPaneElement().appendChild(this._contextMenuElement):(this._glassPaneElement=document.createElement("div"),this._glassPaneElement.className="soft-context-menu-glass-pane",this._glassPaneElement.tabIndex=0,this._glassPaneElement.addEventListener("mouseup",this._glassPaneMouseUp.bind(this),!1),this._glassPaneElement.appendChild(this._contextMenuElement),document.body.appendChild(this._glassPaneElement),this._focus()),document.body.offsetWidth<this._contextMenuElement.offsetLeft+this._contextMenuElement.offsetWidth&&(t?this._contextMenuElement.style.left=Math.max(0,o.right-this._contextMenuElement.offsetWidth)+"px":this._contextMenuElement.style.left=n-this._contextMenuElement.offsetWidth+"px"),document.body.offsetHeight<this._contextMenuElement.offsetTop+this._contextMenuElement.offsetHeight&&(t?this._contextMenuElement.style.top=Math.max(0,o.top-this._contextMenuElement.offsetHeight)+"px":this._contextMenuElement.style.top=document.body.offsetHeight-this._contextMenuElement.offsetHeight+"px"),e.consume(!0)},_parentGlassPaneElement:function(){return this._glassPaneElement?this._glassPaneElement:this._parentMenu?this._parentMenu._parentGlassPaneElement():null},_createMenuItem:function(e){if(e.type==="separator")return this._createSeparator();if(e.type==="subMenu")return this._createSubMenu(e);var t=document.createElement("div");t.className="soft-context-menu-item";var n=document.createElement("span");return n.textContent="✓ ",n.className="soft-context-menu-item-checkmark",e.checked||(n.style.opacity="0"),t.appendChild(n),t.appendChild(document.createTextNode(e.label)),t.addEventListener("mousedown",this._menuItemMouseDown.bind(this),!1),t.addEventListener("mouseup",this._menuItemMouseUp.bind(this),!1),t.addEventListener("mouseover",this._menuItemMouseOver.bind(this),!1),t.addEventListener("mouseout",this._menuItemMouseOut.bind(this),!1),t._actionId=e.id,t},_createSubMenu:function(e){var t=document.createElement("div");t.className="soft-context-menu-item",t._subItems=e.subItems;var n=document.createElement("span");n.textContent="✓ ",n.className="soft-context-menu-item-checkmark",n.style.opacity="0",t.appendChild(n);var r=document.createElement("span");return r.textContent="▶",r.className="soft-context-menu-item-submenu-arrow",t.appendChild(document.createTextNode(e.label)),t.appendChild(r),t.addEventListener("mousedown",this._menuItemMouseDown.bind(this),!1),t.addEventListener("mouseup",this._menuItemMouseUp.bind(this),!1),t.addEventListener("mouseover",this._menuItemMouseOver.bind(this),!1),t.addEventListener("mouseout",this._menuItemMouseOut.bind(this),!1),t},_createSeparator:function(){var e=document.createElement("div");return e.className="soft-context-menu-separator",e._isSeparator=!0,e.addEventListener("mouseover",this._hideSubMenu.bind(this),!1),e.createChild("div","separator-line"),e},_menuItemMouseDown:function(e){e.consume(!0)},_menuItemMouseUp:function(e){this._triggerAction(e.target,e),e.consume()},_focus:function(){this._contextMenuElement.focus()},_triggerAction:function(e,t){if(!e._subItems){this._discardMenu(!0,t),typeof e._actionId!="undefined"&&(WebInspector.contextMenuItemSelected(e._actionId),delete e._actionId);return}this._showSubMenu(e,t),t.consume()},_showSubMenu:function(e,t){e._subMenuTimer&&(clearTimeout(e._subMenuTimer),delete e._subMenuTimer);if(this._subMenu)return;this._subMenu=new WebInspector.SoftContextMenu(e._subItems,this),this._subMenu.show(this._buildMouseEventForSubMenu(e))},_buildMouseEventForSubMenu:function(e){var t={x:e.offsetWidth-3,y:e.offsetTop-1},n=this._x+t.x,r=this._y+t.y,i=parseInt(this._contextMenuElement.style.left,10)+t.x,s=parseInt(this._contextMenuElement.style.top,10)+t.y;return{x:n,y:r,pageX:i,pageY:s,consume:function(){}}},_hideSubMenu:function(){if(!this._subMenu)return;this._subMenu._discardSubMenus(),this._focus()},_menuItemMouseOver:function(e){this._highlightMenuItem(e.target)},_menuItemMouseOut:function(e){if(!this._subMenu||!e.relatedTarget){this._highlightMenuItem(null);return}var t=e.relatedTarget;(this._contextMenuElement.isSelfOrAncestor(t)||t.hasStyleClass("soft-context-menu-glass-pane"))&&this._highlightMenuItem(null)},_highlightMenuItem:function(e){if(this._highlightedMenuItemElement===e)return;this._hideSubMenu(),this._highlightedMenuItemElement&&(this._highlightedMenuItemElement.removeStyleClass("soft-context-menu-item-mouse-over"),this._highlightedMenuItemElement._subItems&&this._highlightedMenuItemElement._subMenuTimer&&(clearTimeout(this._highlightedMenuItemElement._subMenuTimer),delete this._highlightedMenuItemElement._subMenuTimer)),this._highlightedMenuItemElement=e,this._highlightedMenuItemElement&&(this._highlightedMenuItemElement.addStyleClass("soft-context-menu-item-mouse-over"),this._contextMenuElement.focus(),this._highlightedMenuItemElement._subItems&&!this._highlightedMenuItemElement._subMenuTimer&&(this._highlightedMenuItemElement._subMenuTimer=setTimeout(this._showSubMenu.bind(this,this._highlightedMenuItemElement,this._buildMouseEventForSubMenu(this._highlightedMenuItemElement)),150)))},_highlightPrevious:function(){var e=this._highlightedMenuItemElement?this._highlightedMenuItemElement.previousSibling:this._contextMenuElement.lastChild;while(e&&e._isSeparator)e=e.previousSibling;e&&this._highlightMenuItem(e)},_highlightNext:function(){var e=this._highlightedMenuItemElement?this._highlightedMenuItemElement.nextSibling:this._contextMenuElement.firstChild;while(e&&e._isSeparator)e=e.nextSibling;e&&this._highlightMenuItem(e)},_menuKeyDown:function(e){switch(e.keyIdentifier){case"Up":this._highlightPrevious();break;case"Down":this._highlightNext();break;case"Left":this._parentMenu&&(this._highlightMenuItem(null),this._parentMenu._focus());break;case"Right":if(!this._highlightedMenuItemElement)break;this._highlightedMenuItemElement._subItems&&(this._showSubMenu(this._highlightedMenuItemElement,this._buildMouseEventForSubMenu(this._highlightedMenuItemElement)),this._subMenu._focus(),this._subMenu._highlightNext());break;case"U+001B":this._discardMenu(!0,e);break;case"Enter":if(!isEnterKey(e))break;case"U+0020":this._highlightedMenuItemElement&&this._triggerAction(this._highlightedMenuItemElement,e)}e.consume(!0)},_glassPaneMouseUp:function(e){if(e.x===this._x&&e.y===this._y&&(new Date).getTime()-this._time<300)return;this._discardMenu(!0,e),e.consume()},_discardMenu:function(e,t){if(this._subMenu&&!e)return;if(this._glassPaneElement){var n=this._glassPaneElement;delete this._glassPaneElement,document.body.removeChild(n),this._parentMenu&&(delete this._parentMenu._subMenu,e&&this._parentMenu._discardMenu(e,t)),t&&t.consume(!0)}else this._parentMenu&&this._contextMenuElement.parentElement&&(this._discardSubMenus(),e&&this._parentMenu._discardMenu(e,t),t&&t.consume(!0))},_discardSubMenus:function(){this._subMenu&&this._subMenu._discardSubMenus(),this._contextMenuElement.remove(),this._parentMenu&&delete this._parentMenu._subMenu}},InspectorFrontendHost.showContextMenu||(InspectorFrontendHost.showContextMenu=function(e,t){(new WebInspector.SoftContextMenu(t)).show(e)});