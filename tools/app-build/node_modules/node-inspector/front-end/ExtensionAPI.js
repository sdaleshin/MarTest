/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

function defineCommonExtensionSymbols(e){e.audits||(e.audits={}),e.audits.Severity={Info:"info",Warning:"warning",Severe:"severe"},e.console||(e.console={}),e.console.Severity={Debug:"debug",Log:"log",Warning:"warning",Error:"error"},e.panels||(e.panels={}),e.panels.SearchAction={CancelSearch:"cancelSearch",PerformSearch:"performSearch",NextSearchResult:"nextSearchResult",PreviousSearchResult:"previousSearchResult"},e.Events={AuditStarted:"audit-started-",ButtonClicked:"button-clicked-",ConsoleMessageAdded:"console-message-added",ElementsPanelObjectSelected:"panel-objectSelected-elements",NetworkRequestFinished:"network-request-finished",OpenResource:"open-resource",PanelSearch:"panel-search-",ResourceAdded:"resource-added",ResourceContentCommitted:"resource-content-committed",TimelineEventRecorded:"timeline-event-recorded",ViewShown:"view-shown-",ViewHidden:"view-hidden-"},e.Commands={AddAuditCategory:"addAuditCategory",AddAuditResult:"addAuditResult",AddConsoleMessage:"addConsoleMessage",AddRequestHeaders:"addRequestHeaders",CreatePanel:"createPanel",CreateSidebarPane:"createSidebarPane",CreateStatusBarButton:"createStatusBarButton",EvaluateOnInspectedPage:"evaluateOnInspectedPage",ForwardKeyboardEvent:"_forwardKeyboardEvent",GetConsoleMessages:"getConsoleMessages",GetHAR:"getHAR",GetPageResources:"getPageResources",GetRequestContent:"getRequestContent",GetResourceContent:"getResourceContent",Reload:"Reload",Subscribe:"subscribe",SetOpenResourceHandler:"setOpenResourceHandler",SetResourceContent:"setResourceContent",SetSidebarContent:"setSidebarContent",SetSidebarHeight:"setSidebarHeight",SetSidebarPage:"setSidebarPage",ShowPanel:"showPanel",StopAuditCategoryRun:"stopAuditCategoryRun",OpenResource:"openResource",Reload:"Reload",Unsubscribe:"unsubscribe",UpdateAuditProgress:"updateAuditProgress",UpdateButton:"updateButton",InspectedURLChanged:"inspectedURLChanged"}}function injectedExtensionAPI(e){function s(e,t){this._type=e,this._listeners=[],this._customDispatch=t}function o(){this.audits=new g,this.inspectedWindow=new E,this.panels=new l,this.network=new a,L(this,"webInspector","resources","network"),this.timeline=new I,this.console=new u}function u(){this.onMessageAdded=new D(r.ConsoleMessageAdded)}function a(){function e(e){var t=e.arguments[1];t.__proto__=new j(e.arguments[0]),this._fire(t)}this.onRequestFinished=new D(r.NetworkRequestFinished,e),L(this,"network","onFinished","onRequestFinished"),this.onNavigated=new D(r.InspectedURLChanged)}function f(e){this._id=e}function l(){function t(t){return e[t]}var e={elements:new p};for(var n in e)this.__defineGetter__(n,t.bind(null,n))}function c(e){function t(e){var t=e.arguments[0];this._fire(window.parent.frames[t])}this._id=e,this.onShown=new D(r.ViewShown+e,t),this.onHidden=new D(r.ViewHidden+e)}function h(e){this._id=e}function p(){var e="elements";B.call(this,e),this.onSelectionChanged=new D(r.ElementsPanelObjectSelected)}function d(e){c.call(this,e),this.onSearch=new D(r.PanelSearch+e)}function v(e){c.call(this,e)}function m(e){this._id=e,this.onClicked=new D(r.ButtonClicked+e)}function g(){}function y(e){function t(e){var t=new M(e.arguments[0]);try{this._fire(t)}catch(n){console.error("Uncaught exception in extension audit event handler: "+n),t.done()}}this._id=e,this.onAuditStarted=new D(r.AuditStarted+e,t)}function b(e){this._id=e,this.createURL=this._nodeFactory.bind(null,"url"),this.createSnippet=this._nodeFactory.bind(null,"snippet"),this.createText=this._nodeFactory.bind(null,"text"),this.createObject=this._nodeFactory.bind(null,"object"),this.createNode=this._nodeFactory.bind(null,"node")}function w(e){this.contents=e,this.children=[],this.expanded=!1}function E(){function e(e){this._fire(new F(e.arguments[0]))}function t(e){this._fire(new F(e.arguments[0]),e.arguments[1])}this.onResourceAdded=new D(r.ResourceAdded,e),this.onResourceContentCommitted=new D(r.ResourceContentCommitted,t)}function S(e){this._url=e.url,this._type=e.type}function x(){this.onEventRecorded=new D(r.TimelineEventRecorded)}function T(e){const t="U+001B";if(!e.ctrlKey&&!e.altKey&&!e.metaKey&&!/^F\d+$/.test(e.keyIdentifier)&&e.keyIdentifier!==t)return;var r={command:n.ForwardKeyboardEvent,eventType:e.type,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,keyIdentifier:e.keyIdentifier,location:e.location};extensionServer.sendRequest(r)}function N(){this._callbacks={},this._handlers={},this._lastRequestId=0,this._lastObjectId=0,this.registerHandler("callback",this._onCallback.bind(this));var e=new MessageChannel;this._port=e.port1,this._port.addEventListener("message",this._onMessage.bind(this),!1),this._port.start(),window.parent.postMessage("registerExtension",[e.port2],"*")}function C(e,t){for(var n in t){if(n.charAt(0)==="_")continue;var r=null;for(var i=t;i&&!r;i=i.__proto__)r=Object.getOwnPropertyDescriptor(i,n);if(!r)continue;typeof r.value=="function"?e[n]=r.value.bind(t):typeof r.get=="function"?e.__defineGetter__(n,r.get.bind(t)):Object.defineProperty(e,n,r)}}function k(e){return function(){var t={__proto__:e.prototype};e.apply(t,arguments),C(this,t)}}function L(e,t,n,r){function s(){return i||(console.warn(t+"."+n+" is deprecated. Use "+t+"."+r+" instead"),i=!0),e[r]}var i=!1;e.__defineGetter__(n,s)}function A(e){var t=e[e.length-1];return typeof t=="function"?t:undefined}var t={};defineCommonExtensionSymbols(t);var n=t.Commands,r=t.Events,i=!1;s.prototype={addListener:function(e){if(typeof e!="function")throw"addListener: callback is not a function";this._listeners.length===0&&extensionServer.sendRequest({command:n.Subscribe,type:this._type}),this._listeners.push(e),extensionServer.registerHandler("notify-"+this._type,this._dispatch.bind(this))},removeListener:function(e){var t=this._listeners;for(var r=0;r<t.length;++r)if(t[r]===e){t.splice(r,1);break}this._listeners.length===0&&extensionServer.sendRequest({command:n.Unsubscribe,type:this._type})},_fire:function(){var e=this._listeners.slice();for(var t=0;t<e.length;++t)e[t].apply(null,arguments)},_dispatch:function(e){this._customDispatch?this._customDispatch.call(this,e):this._fire.apply(this,e.arguments)}},u.prototype={getMessages:function(e){extensionServer.sendRequest({command:n.GetConsoleMessages},e)},addMessage:function(e,t,r,i){extensionServer.sendRequest({command:n.AddConsoleMessage,severity:e,text:t,url:r,line:i})},get Severity(){return t.console.Severity}},a.prototype={getHAR:function(e){function t(t){var n=t&&t.entries||[];for(var r=0;r<n.length;++r)n[r].__proto__=new j(n[r]._requestId),delete n[r]._requestId;e(t)}return extensionServer.sendRequest({command:n.GetHAR},e&&t)},addRequestHeaders:function(e){return extensionServer.sendRequest({command:n.AddRequestHeaders,headers:e,extensionId:window.location.hostname})}},f.prototype={getContent:function(e){function t(t){e(t.content,t.encoding)}extensionServer.sendRequest({command:n.GetRequestContent,id:this._id},e&&t)}},l.prototype={create:function(e,t,r,i){var s="extension-panel-"+extensionServer.nextObjectId(),o={command:n.CreatePanel,id:s,title:e,icon:t,page:r};extensionServer.sendRequest(o,i&&i.bind(this,new P(s)))},setOpenResourceHandler:function(e){var t=extensionServer.hasHandler(r.OpenResource);if(!e)extensionServer.unregisterHandler(r.OpenResource);else{function s(t){i=!0;try{e.call(null,new F(t.resource),t.lineNumber)}finally{i=!1}}extensionServer.registerHandler(r.OpenResource,s)}t===!e&&extensionServer.sendRequest({command:n.SetOpenResourceHandler,handlerPresent:!!e})},openResource:function(e,t,r){extensionServer.sendRequest({command:n.OpenResource,url:e,lineNumber:t},r)},get SearchAction(){return t.panels.SearchAction}},h.prototype={createSidebarPane:function(e,t){function s(){t(new H(r))}var r="extension-sidebar-"+extensionServer.nextObjectId(),i={command:n.CreateSidebarPane,panel:this._id,id:r,title:e};extensionServer.sendRequest(i,t&&s)},__proto__:c.prototype},d.prototype={createStatusBarButton:function(e,t,r){var i="button-"+extensionServer.nextObjectId(),s={command:n.CreateStatusBarButton,panel:this._id,id:i,icon:e,tooltip:t,disabled:!!r};return extensionServer.sendRequest(s),new _(i)},show:function(){if(!i)return;var e={command:n.ShowPanel,id:this._id};extensionServer.sendRequest(e)},__proto__:c.prototype},v.prototype={setHeight:function(e){extensionServer.sendRequest({command:n.SetSidebarHeight,id:this._id,height:e})},setExpression:function(e,t,r){var i={command:n.SetSidebarContent,id:this._id,expression:e,rootTitle:t,evaluateOnPage:!0};typeof r=="object"&&(i.evaluateOptions=r),extensionServer.sendRequest(i,A(arguments))},setObject:function(e,t,r){extensionServer.sendRequest({command:n.SetSidebarContent,id:this._id,expression:e,rootTitle:t},r)},setPage:function(e){extensionServer.sendRequest({command:n.SetSidebarPage,id:this._id,page:e})}},m.prototype={update:function(e,t,r){var i={command:n.UpdateButton,id:this._id,icon:e,tooltip:t,disabled:!!r};extensionServer.sendRequest(i)}},g.prototype={addCategory:function(e,t){var r="extension-audit-category-"+extensionServer.nextObjectId();return typeof t!="undefined"&&console.warn("Passing resultCount to audits.addCategory() is deprecated. Use AuditResult.updateProgress() instead."),extensionServer.sendRequest({command:n.AddAuditCategory,id:r,displayName:e,resultCount:t}),new O(r)}},b.prototype={addResult:function(e,t,r,i){i&&!(i instanceof w)&&(i=new w(i instanceof Array?i:[i]));var s={command:n.AddAuditResult,resultId:this._id,displayName:e,description:t,severity:r,details:i};extensionServer.sendRequest(s)},createResult:function(){return new w(Array.prototype.slice.call(arguments))},updateProgress:function(e,t){extensionServer.sendRequest({command:n.UpdateAuditProgress,resultId:this._id,progress:e/t})},done:function(){extensionServer.sendRequest({command:n.StopAuditCategoryRun,resultId:this._id})},get Severity(){return t.audits.Severity},createResourceLink:function(e,t){return{type:"resourceLink",arguments:[e,t&&t-1]}},_nodeFactory:function(e){return{type:e,arguments:Array.prototype.slice.call(arguments,1)}}},w.prototype={addChild:function(){var e=new w(Array.prototype.slice.call(arguments));return this.children.push(e),e}},E.prototype={reload:function(e){var t=null;return typeof e=="object"?t=e:typeof e=="string"&&(t={userAgent:e},console.warn("Passing userAgent as string parameter to inspectedWindow.reload() is deprecated. Use inspectedWindow.reload({ userAgent: value}) instead.")),extensionServer.sendRequest({command:n.Reload,options:t})},eval:function(e,t){function i(e){e.isError||e.isException?r(undefined,e):r(e.value)}var r=A(arguments),s={command:n.EvaluateOnInspectedPage,expression:e};return typeof t=="object"&&(s.evaluateOptions=t),extensionServer.sendRequest(s,r&&i)},getResources:function(e){function t(e){return new F(e)}function r(n){e(n.map(t))}return extensionServer.sendRequest({command:n.GetPageResources},e&&r)}},S.prototype={get url(){return this._url},get type(){return this._type},getContent:function(e){function t(t){e(t.content,t.encoding)}return extensionServer.sendRequest({command:n.GetResourceContent,url:this._url},e&&t)},setContent:function(e,t,r){return extensionServer.sendRequest({command:n.SetResourceContent,url:this._url,content:e,commit:t},r)}},document.addEventListener("keydown",T,!1),document.addEventListener("keypress",T,!1),N.prototype={sendRequest:function(e,t){return typeof t=="function"&&(e.requestId=this._registerCallback(t)),this._port.postMessage(e)},hasHandler:function(e){return!!this._handlers[e]},registerHandler:function(e,t){this._handlers[e]=t},unregisterHandler:function(e){delete this._handlers[e]},nextObjectId:function(){return e+"_"+ ++this._lastObjectId},_registerCallback:function(e){var t=++this._lastRequestId;return this._callbacks[t]=e,t},_onCallback:function(e){if(e.requestId in this._callbacks){var t=this._callbacks[e.requestId];delete this._callbacks[e.requestId],t(e.result)}},_onMessage:function(e){var t=e.data,n=this._handlers[t.command];n&&n.call(this,t)}};var O=k(y),M=k(b),_=k(m),D=k(s),P=k(d),H=k(v),B=k(h),j=k(f),F=k(S),I=k(x);return extensionServer||(extensionServer=new N),new o}function buildExtensionAPIInjectedScript(e){return"(function(injectedScriptId){ var extensionServer;"+defineCommonExtensionSymbols.toString()+";"+injectedExtensionAPI.toString()+";"+buildPlatformExtensionAPI(e)+";"+"platformExtensionAPI(injectedExtensionAPI(injectedScriptId));"+"return {};"+"})"};