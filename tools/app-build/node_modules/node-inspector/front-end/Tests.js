/*
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

if(window.domAutomationController){var ___interactiveUiTestsMode=!0;TestSuite=function(){this.controlTaken_=!1,this.timerId_=-1},TestSuite.prototype.fail=function(e){if(!this.controlTaken_)throw e;this.reportFailure_(e)},TestSuite.prototype.assertEquals=function(e,t,n){if(e!==t){var r="Expected: '"+e+"', but was '"+t+"'";n&&(r=n+"("+r+")"),this.fail(r)}},TestSuite.prototype.assertTrue=function(e,t){this.assertEquals(!0,!!e,t)},TestSuite.prototype.assertHasKey=function(e,t){e.hasOwnProperty(t)||this.fail("Expected object to contain key '"+t+"'")},TestSuite.prototype.assertContains=function(e,t){e.indexOf(t)===-1&&this.fail("Expected to: '"+e+"' to contain '"+t+"'")},TestSuite.prototype.takeControl=function(){this.controlTaken_=!0;var e=this;this.timerId_=setTimeout(function(){e.reportFailure_("Timeout exceeded: 20 sec")},2e4)},TestSuite.prototype.releaseControl=function(){this.timerId_!==-1&&(clearTimeout(this.timerId_),this.timerId_=-1),this.reportOk_()},TestSuite.prototype.reportOk_=function(){window.domAutomationController.send("[OK]")},TestSuite.prototype.reportFailure_=function(e){this.timerId_!==-1&&(clearTimeout(this.timerId_),this.timerId_=-1),window.domAutomationController.send("[FAILED] "+e)},TestSuite.prototype.runTest=function(e){try{this[e](),this.controlTaken_||this.reportOk_()}catch(t){this.reportFailure_(t)}},TestSuite.prototype.showPanel=function(e){var t=document.getElementById("toolbar"),n=t.getElementsByClassName(e)[0];n.click(),this.assertEquals(WebInspector.panels[e],WebInspector.inspectorView.currentPanel())},TestSuite.prototype.addSniffer=function(e,t,n,r){var i=e[t];typeof i!="function"&&this.fail("Cannot find method to override: "+t);var s=this;e[t]=function(o){try{var u=i.apply(this,arguments)}finally{r||(e[t]=i)}try{n.apply(this,arguments)}catch(a){s.fail("Exception in overriden method '"+t+"': "+a)}return u}},TestSuite.prototype.testEnableResourcesTab=function(){},TestSuite.prototype.testCompletionOnPause=function(){},TestSuite.prototype.testShowScriptsTab=function(){this.showPanel("scripts");var e=this;this._waitUntilScriptsAreParsed(["debugger_test_page.html"],function(){e.releaseControl()}),this.takeControl()},TestSuite.prototype.testScriptsTabIsPopulatedOnInspectedPageRefresh=function(){function t(){WebInspector.debuggerModel.removeEventListener(WebInspector.DebuggerModel.Events.GlobalObjectCleared,t),e.showPanel("scripts"),e._waitUntilScriptsAreParsed(["debugger_test_page.html"],function(){e.releaseControl()})}var e=this;this.assertEquals(WebInspector.panels.elements,WebInspector.inspectorView.currentPanel(),"Elements panel should be current one."),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.GlobalObjectCleared,t),e.evaluateInConsole_("window.location.reload(true);",function(e){}),this.takeControl()},TestSuite.prototype.testContentScriptIsPresent=function(){this.showPanel("scripts");var e=this;e._waitUntilScriptsAreParsed(["page_with_content_script.html","simple_content_script.js"],function(){e.releaseControl()}),this.takeControl()},TestSuite.prototype.testNoScriptDuplicatesOnPanelSwitch=function(){function r(){e.showPanel("elements"),setTimeout(i,0)}function i(){e.showPanel("scripts"),setTimeout(s,0)}function s(){e.assertTrue(e._scriptsAreParsed(["debugger_test_page.html"]),"Some scripts are missing."),o(),e.releaseControl()}function o(){var t=e.nonAnonymousUISourceCodes_();for(var n=0;n<t.length;n++){var r=t[n].url;for(var i=n+1;i<t.length;i++)e.assertTrue(r!==t[i].url,"Found script duplicates: "+e.uiSourceCodesToString_(t))}}var e=this,t=2,n=[];this.showPanel("scripts"),e._waitUntilScriptsAreParsed(["debugger_test_page.html"],function(){o(),setTimeout(r,0)}),this.takeControl()},TestSuite.prototype.testPauseWhenLoadingDevTools=function(){this.showPanel("scripts");if(WebInspector.debuggerModel.debuggerPausedDetails)return;this._waitForScriptPause(this.releaseControl.bind(this)),this.takeControl()},TestSuite.prototype.testPauseWhenScriptIsRunning=function(){function e(e){this.assertTrue(!isNaN(e),"Failed to get timer id: "+e),setTimeout(t.bind(this),300)}function t(){WebInspector.panels.scripts._pauseButton.element.click(),this._waitForScriptPause(this.releaseControl.bind(this))}this.showPanel("scripts"),this.evaluateInConsole_('setTimeout("handleClick()" , 0)',e.bind(this)),this.takeControl()},TestSuite.prototype.testNetworkSize=function(){function t(t,n){e.assertEquals(219,t.transferSize,"Incorrect total encoded data length"),e.assertEquals(25,t.resourceSize,"Incorrect total data length"),e.releaseControl()}var e=this;this.addSniffer(WebInspector.NetworkDispatcher.prototype,"_finishNetworkRequest",t),e.evaluateInConsole_("window.location.reload(true);",function(e){}),this.takeControl()},TestSuite.prototype.testNetworkSyncSize=function(){function t(t,n){e.assertEquals(219,t.transferSize,"Incorrect total encoded data length"),e.assertEquals(25,t.resourceSize,"Incorrect total data length"),e.releaseControl()}var e=this;this.addSniffer(WebInspector.NetworkDispatcher.prototype,"_finishNetworkRequest",t),e.evaluateInConsole_('var xhr = new XMLHttpRequest(); xhr.open("GET", "chunked", false); xhr.send(null);',function(){}),this.takeControl()},TestSuite.prototype.testNetworkRawHeadersText=function(){function t(t,n){t.responseHeadersText||e.fail("Failure: resource does not have response headers text"),e.assertEquals(164,t.responseHeadersText.length,"Incorrect response headers text length"),e.releaseControl()}var e=this;this.addSniffer(WebInspector.NetworkDispatcher.prototype,"_finishNetworkRequest",t),e.evaluateInConsole_("window.location.reload(true);",function(e){}),this.takeControl()},TestSuite.prototype.testNetworkTiming=function(){function t(t,n){e.assertTrue(t.timing.receiveHeadersEnd-t.timing.connectStart>=70,"Time between receiveHeadersEnd and connectStart should be >=70ms, but was receiveHeadersEnd="+t.timing.receiveHeadersEnd+", connectStart="+t.timing.connectStart+"."),e.assertTrue(t.responseReceivedTime-t.startTime>=.07,"Time between responseReceivedTime and startTime should be >=0.07s, but was responseReceivedTime="+t.responseReceivedTime+", startTime="+t.startTime+"."),e.assertTrue(t.endTime-t.startTime>=.14,"Time between endTime and startTime should be >=0.14s, but was endtime="+t.endTime+", startTime="+t.startTime+"."),e.releaseControl()}var e=this;this.addSniffer(WebInspector.NetworkDispatcher.prototype,"_finishNetworkRequest",t),e.evaluateInConsole_("window.location.reload(true);",function(e){}),this.takeControl()},TestSuite.prototype.testConsoleOnNavigateBack=function(){function e(){WebInspector.console.removeEventListener(WebInspector.ConsoleModel.Events.MessageAdded,e,this),this.evaluateInConsole_("clickLink();",t.bind(this))}function t(){this.assertEquals(3,WebInspector.console.messages.length),this.assertEquals(1,WebInspector.console.messages[0].totalRepeatCount),this.evaluateInConsole_("history.back();",n.bind(this))}function n(){this.evaluateInConsole_("void 0;",r.bind(this))}function r(){this.assertEquals(7,WebInspector.console.messages.length),this.assertEquals(1,WebInspector.console.messages[0].totalRepeatCount),this.releaseControl()}WebInspector.console.messages.length===1?e.call(this):WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.MessageAdded,e,this),this.takeControl()},TestSuite.prototype.testReattachAfterCrash=function(){this.evaluateInConsole_("1+1;",this.releaseControl.bind(this)),this.takeControl()},TestSuite.prototype.testSharedWorker=function(){function e(e){this.assertEquals("2011",e),this.releaseControl()}this.evaluateInConsole_("globalVar",e.bind(this)),this.takeControl()},TestSuite.prototype.testPauseInSharedWorkerInitialization=function(){if(WebInspector.debuggerModel.debuggerPausedDetails)return;this._waitForScriptPause(this.releaseControl.bind(this)),this.takeControl()},TestSuite.prototype.testTimelineFrames=function(){function t(){e.recordTimeline(n),e.evaluateInConsole_("runTest()",function(){})}function n(t){var n=0,r={};for(var i=0;i<t.length;++i){var s=t[i];if(s.type!=="BeginFrame"){r[s.type]=(r[s.type]||0)+1;continue}if(!(n++))continue;e.assertHasKey(r,"FireAnimationFrame"),e.assertHasKey(r,"Layout"),e.assertHasKey(r,"RecalculateStyles"),e.assertHasKey(r,"Paint"),r={}}e.assertTrue(n>=5,"Not enough frames"),e.releaseControl()}var e=this;t(),e.takeControl()},TestSuite.prototype.testPageOverlayUpdate=function(){function t(){var e=document.createElement("div");e.id="div1",e.style.webkitTransform="translateZ(0)",document.body.appendChild(e);var t=document.createElement("div");t.id="div2",document.body.appendChild(t)}function n(){e.evaluateInConsole_(t.toString()+"; populatePage();"+"inspect(document.getElementById('div1'))",function(){}),WebInspector.notifications.addEventListener(WebInspector.ElementsTreeOutline.Events.SelectedNodeChanged,r)}function r(){WebInspector.notifications.removeEventListener(WebInspector.ElementsTreeOutline.Events.SelectedNodeChanged,r),e.recordTimeline(o),setTimeout(i,500)}function i(){e.evaluateInConsole_("inspect(document.getElementById('div2'))",function(){}),WebInspector.notifications.addEventListener(WebInspector.ElementsTreeOutline.Events.SelectedNodeChanged,s)}function s(){WebInspector.notifications.removeEventListener(WebInspector.ElementsTreeOutline.Events.SelectedNodeChanged,s),e.stopTimeline()}function o(t){var n={};for(var r=0;r<t.length;++r)n[t[r].type]=(n[t[r].type]||0)+1;var i=n.BeginFrame;e.assertTrue(i>=2,"Not enough DevTools overlay updates"),e.assertTrue(i<6,"Too many updates caused by DevTools overlay"),e.releaseControl()}var e=this;n(),this.takeControl()},TestSuite.prototype.recordTimeline=function(e){function r(e){i(e.data)}function i(e){t.push(e),e.type==="TimeStamp"&&e.data.message==="ready"&&s(),e.children&&e.children.forEach(i)}function s(){WebInspector.timelineManager.stop(),WebInspector.timelineManager.removeEventListener(WebInspector.TimelineManager.EventTypes.TimelineEventRecorded,r),e(t)}var t=[],n={};WebInspector.timelineManager.addEventListener(WebInspector.TimelineManager.EventTypes.TimelineEventRecorded,r),WebInspector.timelineManager.start()},TestSuite.prototype.stopTimeline=function(){this.evaluateInConsole_("console.timeStamp('ready')",function(){})},TestSuite.prototype.waitForTestResultsInConsole=function(){function r(e){var t=e.data.text;t==="PASS"?this.releaseControl():/^FAIL/.test(t)&&this.fail(t)}var e=WebInspector.console.messages;for(var t=0;t<e.length;++t){var n=e[t].text;if(n==="PASS")return;/^FAIL/.test(n)&&this.fail(n)}WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.MessageAdded,r,this),this.takeControl()},TestSuite.prototype.checkLogAndErrorMessages=function(){function n(e){return e.text==="log"&&e.level===WebInspector.ConsoleMessage.MessageLevel.Log?(++t,!0):e.text==="error"&&e.level===WebInspector.ConsoleMessage.MessageLevel.Error?(++t,!0):!1}function i(i){var s=i.data;if(n(s)){if(t===2){this.releaseControl();return}}else this.fail(s.text+":"+e[r].level)}var e=WebInspector.console.messages,t=0;for(var r=0;r<e.length;++r){if(n(e[r]))continue;this.fail(e[r].text+":"+e[r].level)}if(t===2)return;WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.MessageAdded,i,this),this.takeControl()},TestSuite.prototype.uiSourceCodesToString_=function(e){var t=[];for(var n=0;n<e.length;n++)t.push('"'+e[n].url+'"');return t.join(",")},TestSuite.prototype.nonAnonymousUISourceCodes_=function(){function e(e){return!!e.url}function t(e){return!e.project().isServiceProject()}var n=WebInspector.workspace.uiSourceCodes();return n=n.filter(t),n.filter(e)},TestSuite.prototype.evaluateInConsole_=function(e,t){WebInspector.showConsole(),WebInspector.consoleView.prompt.text=e,WebInspector.consoleView.promptElement.dispatchEvent(TestSuite.createKeyEvent("Enter")),this.addSniffer(WebInspector.ConsoleView.prototype,"_showConsoleMessage",function(e){var n=WebInspector.console.messages[e];t(n.toMessageElement().textContent)})},TestSuite.prototype._scriptsAreParsed=function(e){var t=this.nonAnonymousUISourceCodes_(),n=e.slice(0);for(var r=0;r<t.length;++r)for(var i=0;i<n.length;++i)if(t[r].name().search(n[i])!==-1){n.splice(i,1);break}return n.length===0},TestSuite.prototype._waitForScriptPause=function(e){function t(n){WebInspector.debuggerModel.removeEventListener(WebInspector.DebuggerModel.Events.DebuggerPaused,t,this),e()}WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.DebuggerPaused,t,this)},TestSuite.prototype._executeCodeWhenScriptsAreParsed=function(e,t){function r(){n.evaluateInConsole_('setTimeout("'+e+'" , 0)',function(t){n.assertTrue(!isNaN(t),"Failed to get timer id: "+t+". Code: "+e)})}var n=this;n._waitUntilScriptsAreParsed(t,r)},TestSuite.prototype._waitUntilScriptsAreParsed=function(e,t){function r(){n._scriptsAreParsed(e)?t():n.addSniffer(WebInspector.panels.scripts,"_addUISourceCode",r)}var n=this;r()},TestSuite.createKeyEvent=function(e){var t=document.createEvent("KeyboardEvent");return t.initKeyboardEvent("keydown",!0,!0,null,e,""),t};var uiTests={};uiTests.runAllTests=function(){for(var e in TestSuite.prototype)e.substring(0,4)==="test"&&typeof TestSuite.prototype[e]=="function"&&uiTests.runTest(e)},uiTests.runTest=function(e){uiTests._populatedInterface?(new TestSuite).runTest(e):uiTests._pendingTestName=e},function(){function e(){uiTests._populatedInterface=!0;var e=uiTests._pendingTestName;delete uiTests._pendingTestName,e&&(new TestSuite).runTest(e)}var t=InspectorFrontendAPI.loadCompleted;InspectorFrontendAPI.loadCompleted=function(){t.call(InspectorFrontendAPI),e()}}()};