/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.HeapSnapshotSortableDataGrid=function(e){WebInspector.DataGrid.call(this,e),this._recursiveSortingDepth=0,this._highlightedNode=null,this._populatedAndSorted=!1,this.addEventListener("sorting complete",this._sortingComplete,this),this.addEventListener(WebInspector.DataGrid.Events.SortingChanged,this.sortingChanged,this)},WebInspector.HeapSnapshotSortableDataGrid.Events={ContentShown:"ContentShown"},WebInspector.HeapSnapshotSortableDataGrid.prototype={defaultPopulateCount:function(){return 100},dispose:function(){var e=this.topLevelNodes();for(var t=0,n=e.length;t<n;++t)e[t].dispose()},wasShown:function(){this._populatedAndSorted&&this.dispatchEventToListeners(WebInspector.HeapSnapshotSortableDataGrid.Events.ContentShown,this)},_sortingComplete:function(){this.removeEventListener("sorting complete",this._sortingComplete,this),this._populatedAndSorted=!0,this.dispatchEventToListeners(WebInspector.HeapSnapshotSortableDataGrid.Events.ContentShown,this)},willHide:function(){this._clearCurrentHighlight()},populateContextMenu:function(e,t,n){function s(){e.showObject(i.snapshotNodeId,"Dominators")}function o(){e.showObject(i.snapshotNodeId,"Summary")}var r=n.target.enclosingNodeOrSelfWithNodeName("td");if(!r)return;var i=r.heapSnapshotNode;i&&i.showRetainingEdges?(t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Reveal in Summary view":"Reveal in Summary View"),o.bind(this)),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Reveal in Dominators view":"Reveal in Dominators View"),s.bind(this))):i instanceof WebInspector.HeapSnapshotInstanceNode||i instanceof WebInspector.HeapSnapshotObjectNode?t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Reveal in Dominators view":"Reveal in Dominators View"),s.bind(this)):i instanceof WebInspector.HeapSnapshotDominatorObjectNode&&t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Reveal in Summary view":"Reveal in Summary View"),o.bind(this))},resetSortingCache:function(){delete this._lastSortColumnIdentifier,delete this._lastSortAscending},topLevelNodes:function(){return this.rootNode().children},highlightObjectByHeapSnapshotId:function(e){},highlightNode:function(e){var t=this._highlightedNode;this._clearCurrentHighlight(),this._highlightedNode=e,this._highlightedNode.element.addStyleClass("highlighted-row");if(e===t){var n=e.element,r=n.parentElement,i=n.nextSibling;r.removeChild(n),r.insertBefore(n,i)}},nodeWasDetached:function(e){this._highlightedNode===e&&this._clearCurrentHighlight()},_clearCurrentHighlight:function(){if(!this._highlightedNode)return;this._highlightedNode.element.removeStyleClass("highlighted-row"),this._highlightedNode=null},changeNameFilter:function(e){e=e.toLowerCase();var t=this.topLevelNodes();for(var n=0,r=t.length;n<r;++n){var i=t[n];i.depth===0&&(i.revealed=i._name.toLowerCase().indexOf(e)!==-1)}this.updateVisibleNodes()},sortingChanged:function(){function r(e,t){var r=e[n[0]],i=t[n[0]],s=r<i?-1:r>i?1:0;return n[1]||(s=-s),s!==0?s:(r=e[n[2]],i=t[n[2]],s=r<i?-1:r>i?1:0,n[3]||(s=-s),s)}var e=this.isSortOrderAscending(),t=this.sortColumnIdentifier();if(this._lastSortColumnIdentifier===t&&this._lastSortAscending===e)return;this._lastSortColumnIdentifier=t,this._lastSortAscending=e;var n=this._sortFields(t,e);this._performSorting(r)},_performSorting:function(e){this.recursiveSortingEnter();var t=this._topLevelNodes;this.rootNode().removeChildren(),t.sort(e);for(var n=0,r=t.length;n<r;++n){var i=t[n];this.appendChildAfterSorting(i),i.expanded&&i.sort()}this.updateVisibleNodes(),this.recursiveSortingLeave()},appendChildAfterSorting:function(e){var t=e.revealed;this.rootNode().appendChild(e),e.revealed=t},updateVisibleNodes:function(){},recursiveSortingEnter:function(){++this._recursiveSortingDepth},recursiveSortingLeave:function(){if(!this._recursiveSortingDepth)return;--this._recursiveSortingDepth||this.dispatchEventToListeners("sorting complete")},__proto__:WebInspector.DataGrid.prototype},WebInspector.HeapSnapshotViewportDataGrid=function(e){WebInspector.HeapSnapshotSortableDataGrid.call(this,e),this.scrollContainer.addEventListener("scroll",this._onScroll.bind(this),!0),this._topLevelNodes=[],this._topPadding=new WebInspector.HeapSnapshotPaddingNode,this._bottomPadding=new WebInspector.HeapSnapshotPaddingNode,this._nodeToHighlightAfterScroll=null},WebInspector.HeapSnapshotViewportDataGrid.prototype={topLevelNodes:function(){return this._topLevelNodes},appendChildAfterSorting:function(e){},updateVisibleNodes:function(){var e=this.scrollContainer.scrollTop,t=this.scrollContainer.offsetHeight;this._removePaddingRows();var n=this._topLevelNodes,r=0,i=0;while(r<n.length){if(n[r].revealed){var s=i+n[r].nodeHeight();if(s>e)break;i=s}++r}var o=this.selectedNode;this.rootNode().removeChildren();var u=t+(e-i),a=0;while(r<n.length&&a<u)n[r].revealed&&(this.rootNode().appendChild(n[r]),a+=n[r].nodeHeight()),++r;var f=0;while(r<n.length)f+=n[r].nodeHeight(),++r;this._addPaddingRows(i,f),o&&(o.parent?o.select(!0):this.selectedNode=o)},appendTopLevelNode:function(e){this._topLevelNodes.push(e)},removeTopLevelNodes:function(){this.rootNode().removeChildren(),this._topLevelNodes=[]},highlightNode:function(e){this._isScrolledIntoView(e.element)?WebInspector.HeapSnapshotSortableDataGrid.prototype.highlightNode.call(this,e):(e.element.scrollIntoViewIfNeeded(!0),this._nodeToHighlightAfterScroll=e)},_isScrolledIntoView:function(e){var t=this.scrollContainer.scrollTop,n=t+this.scrollContainer.clientHeight,r=e.offsetTop,i=r+e.offsetHeight;return i<=n&&r>=t},_addPaddingRows:function(e,t){this._topPadding.element.parentNode!==this.dataTableBody&&this.dataTableBody.insertBefore(this._topPadding.element,this.dataTableBody.firstChild),this._bottomPadding.element.parentNode!==this.dataTableBody&&this.dataTableBody.insertBefore(this._bottomPadding.element,this.dataTableBody.lastChild),this._topPadding.setHeight(e),this._bottomPadding.setHeight(t)},_removePaddingRows:function(){this._bottomPadding.removeFromTable(),this._topPadding.removeFromTable()},onResize:function(){WebInspector.HeapSnapshotSortableDataGrid.prototype.onResize.call(this),this.updateVisibleNodes()},_onScroll:function(e){this.updateVisibleNodes(),this._nodeToHighlightAfterScroll&&(WebInspector.HeapSnapshotSortableDataGrid.prototype.highlightNode.call(this,this._nodeToHighlightAfterScroll),this._nodeToHighlightAfterScroll=null)},__proto__:WebInspector.HeapSnapshotSortableDataGrid.prototype},WebInspector.HeapSnapshotPaddingNode=function(){this.element=document.createElement("tr"),this.element.addStyleClass("revealed")},WebInspector.HeapSnapshotPaddingNode.prototype={setHeight:function(e){this.element.style.height=e+"px"},removeFromTable:function(){var e=this.element.parentNode;e&&e.removeChild(this.element)}},WebInspector.HeapSnapshotContainmentDataGrid=function(e){e=e||[{id:"object",title:WebInspector.UIString("Object"),disclosure:!0,sortable:!0},{id:"distance",title:WebInspector.UIString("Distance"),width:"80px",sortable:!0},{id:"shallowSize",title:WebInspector.UIString("Shallow Size"),width:"120px",sortable:!0},{id:"retainedSize",title:WebInspector.UIString("Retained Size"),width:"120px",sortable:!0,sort:WebInspector.DataGrid.Order.Descending}],WebInspector.HeapSnapshotSortableDataGrid.call(this,e)},WebInspector.HeapSnapshotContainmentDataGrid.prototype={setDataSource:function(e,t){this.snapshot=e;var n=new WebInspector.HeapSnapshotNode(e,t||e.rootNodeIndex),r={node:n};this.setRootNode(new WebInspector.HeapSnapshotObjectNode(this,!1,r,null)),this.rootNode().sort()},sortingChanged:function(){this.rootNode().sort()},__proto__:WebInspector.HeapSnapshotSortableDataGrid.prototype},WebInspector.HeapSnapshotRetainmentDataGrid=function(){this.showRetainingEdges=!0;var e=[{id:"object",title:WebInspector.UIString("Object"),disclosure:!0,sortable:!0},{id:"distance",title:WebInspector.UIString("Distance"),width:"80px",sortable:!0,sort:WebInspector.DataGrid.Order.Ascending},{id:"shallowSize",title:WebInspector.UIString("Shallow Size"),width:"120px",sortable:!0},{id:"retainedSize",title:WebInspector.UIString("Retained Size"),width:"120px",sortable:!0}];WebInspector.HeapSnapshotContainmentDataGrid.call(this,e)},WebInspector.HeapSnapshotRetainmentDataGrid.Events={ExpandRetainersComplete:"ExpandRetainersComplete"},WebInspector.HeapSnapshotRetainmentDataGrid.prototype={_sortFields:function(e,t){return{object:["_name",t,"_count",!1],count:["_count",t,"_name",!0],shallowSize:["_shallowSize",t,"_name",!0],retainedSize:["_retainedSize",t,"_name",!0],distance:["_distance",t,"_name",!0]}[e]},reset:function(){this.rootNode().removeChildren(),this.resetSortingCache()},setDataSource:function(e,t){function i(){this.removeEventListener(WebInspector.HeapSnapshotGridNode.Events.PopulateComplete,i,this),this.expand();if(--r>0&&this.children.length>0){var e=this.children[0];if(e._distance>1){e.addEventListener(WebInspector.HeapSnapshotGridNode.Events.PopulateComplete,i,e),e.populate();return}}n.dispatchEventToListeners(WebInspector.HeapSnapshotRetainmentDataGrid.Events.ExpandRetainersComplete)}WebInspector.HeapSnapshotContainmentDataGrid.prototype.setDataSource.call(this,e,t);var n=this,r=20;this.rootNode().addEventListener(WebInspector.HeapSnapshotGridNode.Events.PopulateComplete,i,this.rootNode())},__proto__:WebInspector.HeapSnapshotContainmentDataGrid.prototype},WebInspector.HeapSnapshotConstructorsDataGrid=function(){var e=[{id:"object",title:WebInspector.UIString("Constructor"),disclosure:!0,sortable:!0},{id:"distance",title:WebInspector.UIString("Distance"),width:"90px",sortable:!0},{id:"count",title:WebInspector.UIString("Objects Count"),width:"90px",sortable:!0},{id:"shallowSize",title:WebInspector.UIString("Shallow Size"),width:"120px",sortable:!0},{id:"retainedSize",title:WebInspector.UIString("Retained Size"),width:"120px",sort:WebInspector.DataGrid.Order.Descending,sortable:!0}];WebInspector.HeapSnapshotViewportDataGrid.call(this,e),this._profileIndex=-1,this._topLevelNodes=[],this._objectIdToSelect=null},WebInspector.HeapSnapshotConstructorsDataGrid.Request=function(e,t){typeof e=="number"?(this.key=e+".."+t,this.filter="function(node) { var id = node.id(); return id > "+e+" && id <= "+t+"; }"):(this.key="allObjects",this.filter=null)},WebInspector.HeapSnapshotConstructorsDataGrid.prototype={_sortFields:function(e,t){return{object:["_name",t,"_count",!1],distance:["_distance",t,"_retainedSize",!0],count:["_count",t,"_name",!0],shallowSize:["_shallowSize",t,"_name",!0],retainedSize:["_retainedSize",t,"_name",!0]}[e]},highlightObjectByHeapSnapshotId:function(e){function t(t){var n=this.topLevelNodes();for(var r=0;r<n.length;r++){var i=n[r];if(i._name===t){i.revealNodeBySnapshotObjectId(parseInt(e,10));return}}}if(!this.snapshot){this._objectIdToSelect=e;return}this.snapshot.nodeClassName(parseInt(e,10),t.bind(this))},setDataSource:function(e){this.snapshot=e,this._profileIndex===-1&&this._populateChildren(),this._objectIdToSelect&&(this.highlightObjectByHeapSnapshotId(this._objectIdToSelect),this._objectIdToSelect=null)},setSelectionRange:function(e,t){this._populateChildren(new WebInspector.HeapSnapshotConstructorsDataGrid.Request(e,t))},_aggregatesReceived:function(e,t){this._requestInProgress=null,this._nextRequest&&(this.snapshot.aggregates(!1,this._nextRequest.key,this._nextRequest.filter,this._aggregatesReceived.bind(this,this._nextRequest.key)),this._requestInProgress=this._nextRequest,this._nextRequest=null),this.dispose(),this.removeTopLevelNodes(),this.resetSortingCache();for(var n in t)this.appendTopLevelNode(new WebInspector.HeapSnapshotConstructorNode(this,n,t[n],e));this.sortingChanged(),this._lastKey=e},_populateChildren:function(e){e=e||new WebInspector.HeapSnapshotConstructorsDataGrid.Request;if(this._requestInProgress){this._nextRequest=this._requestInProgress.key===e.key?null:e;return}if(this._lastKey===e.key)return;this._requestInProgress=e,this.snapshot.aggregates(!1,e.key,e.filter,this._aggregatesReceived.bind(this,e.key))},filterSelectIndexChanged:function(e,t){this._profileIndex=t;var n=null;if(t!==-1){var r=t>0?e[t-1].maxJSObjectId:0,i=e[t].maxJSObjectId;n=new WebInspector.HeapSnapshotConstructorsDataGrid.Request(r,i)}this._populateChildren(n)},__proto__:WebInspector.HeapSnapshotViewportDataGrid.prototype},WebInspector.HeapSnapshotDiffDataGrid=function(){var e=[{id:"object",title:WebInspector.UIString("Constructor"),disclosure:!0,sortable:!0},{id:"addedCount",title:WebInspector.UIString("# New"),width:"72px",sortable:!0},{id:"removedCount",title:WebInspector.UIString("# Deleted"),width:"72px",sortable:!0},{id:"countDelta",title:"# Delta",width:"64px",sortable:!0},{id:"addedSize",title:WebInspector.UIString("Alloc. Size"),width:"72px",sortable:!0,sort:WebInspector.DataGrid.Order.Descending},{id:"removedSize",title:WebInspector.UIString("Freed Size"),width:"72px",sortable:!0},{id:"sizeDelta",title:"Size Delta",width:"72px",sortable:!0}];WebInspector.HeapSnapshotViewportDataGrid.call(this,e)},WebInspector.HeapSnapshotDiffDataGrid.prototype={defaultPopulateCount:function(){return 50},_sortFields:function(e,t){return{object:["_name",t,"_count",!1],addedCount:["_addedCount",t,"_name",!0],removedCount:["_removedCount",t,"_name",!0],countDelta:["_countDelta",t,"_name",!0],addedSize:["_addedSize",t,"_name",!0],removedSize:["_removedSize",t,"_name",!0],sizeDelta:["_sizeDelta",t,"_name",!0]}[e]},setDataSource:function(e){this.snapshot=e},setBaseDataSource:function(e){this.baseSnapshot=e,this.dispose(),this.removeTopLevelNodes(),this.resetSortingCache();if(this.baseSnapshot===this.snapshot){this.dispatchEventToListeners("sorting complete");return}this._populateChildren()},_populateChildren:function(){function e(e){function t(e){for(var t in e){var n=e[t];this.appendTopLevelNode(new WebInspector.HeapSnapshotDiffNode(this,t,n))}this.sortingChanged()}this.snapshot.calculateSnapshotDiff(this.baseSnapshot.uid,e,t.bind(this))}this.baseSnapshot.aggregatesForDiff(e.bind(this))},__proto__:WebInspector.HeapSnapshotViewportDataGrid.prototype},WebInspector.HeapSnapshotDominatorsDataGrid=function(){var e=[{id:"object",title:WebInspector.UIString("Object"),disclosure:!0,sortable:!0},{id:"shallowSize",title:WebInspector.UIString("Shallow Size"),width:"120px",sortable:!0},{id:"retainedSize",title:WebInspector.UIString("Retained Size"),width:"120px",sort:WebInspector.DataGrid.Order.Descending,sortable:!0}];WebInspector.HeapSnapshotSortableDataGrid.call(this,e),this._objectIdToSelect=null},WebInspector.HeapSnapshotDominatorsDataGrid.prototype={defaultPopulateCount:function(){return 25},setDataSource:function(e){this.snapshot=e;var t={nodeIndex:this.snapshot.rootNodeIndex};this.setRootNode(new WebInspector.HeapSnapshotDominatorObjectNode(this,t)),this.rootNode().sort(),this._objectIdToSelect&&(this.highlightObjectByHeapSnapshotId(this._objectIdToSelect),this._objectIdToSelect=null)},sortingChanged:function(){this.rootNode().sort()},highlightObjectByHeapSnapshotId:function(e){function t(e){if(!e){WebInspector.log(WebInspector.UIString("Cannot find corresponding heap snapshot node"));return}var t=this.rootNode();n.call(this,e,t)}function n(e,t){if(!t){console.error("Cannot find dominator node");return}if(!e.length){this.highlightNode(t),t.element.scrollIntoViewIfNeeded(!0);return}var r=e.pop();t.retrieveChildBySnapshotObjectId(r,n.bind(this,e))}if(!this.snapshot){this._objectIdToSelect=e;return}this.snapshot.dominatorIdsForNode(parseInt(e,10),t.bind(this))},__proto__:WebInspector.HeapSnapshotSortableDataGrid.prototype};