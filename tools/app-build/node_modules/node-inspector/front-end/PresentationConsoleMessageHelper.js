/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.PresentationConsoleMessageHelper=function(e){this._pendingConsoleMessages={},this._presentationConsoleMessages=[],this._workspace=e,WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.MessageAdded,this._consoleMessageAdded,this),WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.RepeatCountUpdated,this._consoleMessageAdded,this),WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.ConsoleCleared,this._consoleCleared,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.ParsedScriptSource,this._parsedScriptSource,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.FailedToParseScriptSource,this._parsedScriptSource,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.GlobalObjectCleared,this._debuggerReset,this)},WebInspector.PresentationConsoleMessageHelper.prototype={_consoleMessageAdded:function(e){var t=e.data;if(!t.url||!t.isErrorOrWarning())return;var n=t.location();n?this._addConsoleMessageToScript(t,n):this._addPendingConsoleMessage(t)},_addConsoleMessageToScript:function(e,t){this._presentationConsoleMessages.push(new WebInspector.PresentationConsoleMessage(e,t))},_addPendingConsoleMessage:function(e){if(!e.url)return;this._pendingConsoleMessages[e.url]||(this._pendingConsoleMessages[e.url]=[]),this._pendingConsoleMessages[e.url].push(e)},_parsedScriptSource:function(e){var t=e.data,n=this._pendingConsoleMessages[t.sourceURL];if(!n)return;var r=[];for(var i=0;i<n.length;i++){var s=n[i],o=s.location();t.scriptId===o.scriptId?this._addConsoleMessageToScript(s,o):r.push(s)}r.length?this._pendingConsoleMessages[t.sourceURL]=r:delete this._pendingConsoleMessages[t.sourceURL]},_consoleCleared:function(){this._pendingConsoleMessages={};for(var e=0;e<this._presentationConsoleMessages.length;++e)this._presentationConsoleMessages[e].dispose();this._presentationConsoleMessages=[];var t=this._workspace.uiSourceCodes();for(var e=0;e<t.length;++e)t[e].consoleMessagesCleared()},_debuggerReset:function(){this._pendingConsoleMessages={},this._presentationConsoleMessages=[]}},WebInspector.PresentationConsoleMessage=function(e,t){this.originalMessage=e,this._liveLocation=WebInspector.debuggerModel.createLiveLocation(t,this._updateLocation.bind(this))},WebInspector.PresentationConsoleMessage.prototype={_updateLocation:function(e){this._uiLocation&&this._uiLocation.uiSourceCode.consoleMessageRemoved(this),this._uiLocation=e,this._uiLocation.uiSourceCode.consoleMessageAdded(this)},get lineNumber(){return this._uiLocation.lineNumber},dispose:function(){this._liveLocation.dispose()}};