/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.NetworkRequest=function(e,t,n,r,i){this._requestId=e,this.url=t,this._documentURL=n,this._frameId=r,this._loaderId=i,this._startTime=-1,this._endTime=-1,this.statusCode=0,this.statusText="",this.requestMethod="",this.requestTime=0,this.receiveHeadersEnd=0,this._type=WebInspector.resourceTypes.Other,this._contentEncoded=!1,this._pendingContentCallbacks=[],this._frames=[],this._responseHeaderValues={}},WebInspector.NetworkRequest.Events={FinishedLoading:"FinishedLoading",TimingChanged:"TimingChanged",RequestHeadersChanged:"RequestHeadersChanged",ResponseHeadersChanged:"ResponseHeadersChanged"},WebInspector.NetworkRequest.InitiatorType={Other:"other",Parser:"parser",Redirect:"redirect",Script:"script"},WebInspector.NetworkRequest.NameValue,WebInspector.NetworkRequest.prototype={get requestId(){return this._requestId},set requestId(e){this._requestId=e},get url(){return this._url},set url(e){if(this._url===e)return;this._url=e,this._parsedURL=new WebInspector.ParsedURL(e),delete this._parsedQueryParameters,delete this._name,delete this._path},get documentURL(){return this._documentURL},get parsedURL(){return this._parsedURL},get frameId(){return this._frameId},get loaderId(){return this._loaderId},get startTime(){return this._startTime||-1},set startTime(e){this._startTime=e},get responseReceivedTime(){return this._responseReceivedTime||-1},set responseReceivedTime(e){this._responseReceivedTime=e},get endTime(){return this._endTime||-1},set endTime(e){this.timing&&this.timing.requestTime?this._endTime=Math.max(e,this.responseReceivedTime):(this._endTime=e,this._responseReceivedTime>e&&(this._responseReceivedTime=e))},get duration(){return this._endTime===-1||this._startTime===-1?-1:this._endTime-this._startTime},get latency(){return this._responseReceivedTime===-1||this._startTime===-1?-1:this._responseReceivedTime-this._startTime},get receiveDuration(){return this._endTime===-1||this._responseReceivedTime===-1?-1:this._endTime-this._responseReceivedTime},get resourceSize(){return this._resourceSize||0},set resourceSize(e){this._resourceSize=e},get transferSize(){if(typeof this._transferSize=="number")return this._transferSize;if(this.statusCode===304)return this.responseHeadersSize;if(this._cached)return 0;var e=Number(this.responseHeaderValue("Content-Length")||this.resourceSize);return this.responseHeadersSize+e},increaseTransferSize:function(e){this._transferSize=(this._transferSize||0)+e},get finished(){return this._finished},set finished(e){if(this._finished===e)return;this._finished=e,e&&(this.dispatchEventToListeners(WebInspector.NetworkRequest.Events.FinishedLoading,this),this._pendingContentCallbacks.length&&this._innerRequestContent())},get failed(){return this._failed},set failed(e){this._failed=e},get canceled(){return this._canceled},set canceled(e){this._canceled=e},get cached(){return this._cached&&!this._transferSize},set cached(e){this._cached=e,e&&delete this._timing},get timing(){return this._timing},set timing(e){e&&!this._cached&&(this._startTime=e.requestTime,this._responseReceivedTime=e.requestTime+e.receiveHeadersEnd/1e3,this._timing=e,this.dispatchEventToListeners(WebInspector.NetworkRequest.Events.TimingChanged,this))},get mimeType(){return this._mimeType},set mimeType(e){this._mimeType=e},get displayName(){return this._parsedURL.displayName},name:function(){return this._name?this._name:(this._parseNameAndPathFromURL(),this._name)},path:function(){return this._path?this._path:(this._parseNameAndPathFromURL(),this._path)},_parseNameAndPathFromURL:function(){this._parsedURL.isDataURL()?(this._name=this._parsedURL.dataURLDisplayName(),this._path=""):this._parsedURL.isAboutBlank()?(this._name=this._parsedURL.url,this._path=""):(this._path=this._parsedURL.host+this._parsedURL.folderPathComponents,this._path=this._path.trimURL(WebInspector.inspectedPageDomain?WebInspector.inspectedPageDomain:""),this._parsedURL.lastPathComponent||this._parsedURL.queryParams?this._name=this._parsedURL.lastPathComponent+(this._parsedURL.queryParams?"?"+this._parsedURL.queryParams:""):this._parsedURL.folderPathComponents?(this._name=this._parsedURL.folderPathComponents.substring(this._parsedURL.folderPathComponents.lastIndexOf("/")+1)+"/",this._path=this._path.substring(0,this._path.lastIndexOf("/"))):(this._name=this._parsedURL.host,this._path=""))},get folder(){var e=this._parsedURL.path,t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));var n=e.lastIndexOf("/");return n!==-1?e.substring(0,n):""},get type(){return this._type},set type(e){this._type=e},get domain(){return this._parsedURL.host},get scheme(){return this._parsedURL.scheme},get redirectSource(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1]:this._redirectSource},set redirectSource(e){this._redirectSource=e,delete this._initiatorInfo},get requestHeaders(){return this._requestHeaders||[]},set requestHeaders(e){this._requestHeaders=e,delete this._sortedRequestHeaders,delete this._requestCookies,this.dispatchEventToListeners(WebInspector.NetworkRequest.Events.RequestHeadersChanged)},get requestHeadersText(){if(typeof this._requestHeadersText=="undefined"){this._requestHeadersText=this.requestMethod+" "+this.url+" HTTP/1.1\r\n";for(var e=0;e<this.requestHeaders.length;++e)this._requestHeadersText+=this.requestHeaders[e].name+": "+this.requestHeaders[e].value+"\r\n"}return this._requestHeadersText},set requestHeadersText(e){this._requestHeadersText=e,this.dispatchEventToListeners(WebInspector.NetworkRequest.Events.RequestHeadersChanged)},get requestHeadersSize(){return this.requestHeadersText.length},get sortedRequestHeaders(){return this._sortedRequestHeaders!==undefined?this._sortedRequestHeaders:(this._sortedRequestHeaders=[],this._sortedRequestHeaders=this.requestHeaders.slice(),this._sortedRequestHeaders.sort(function(e,t){return e.name.toLowerCase().compareTo(t.name.toLowerCase())}),this._sortedRequestHeaders)},requestHeaderValue:function(e){return this._headerValue(this.requestHeaders,e)},get requestCookies(){return this._requestCookies||(this._requestCookies=WebInspector.CookieParser.parseCookie(this.requestHeaderValue("Cookie"))),this._requestCookies},get requestFormData(){return this._requestFormData},set requestFormData(e){this._requestFormData=e,delete this._parsedFormParameters},get requestHttpVersion(){var e=this.requestHeadersText.split(/\r\n/)[0],t=e.match(/(HTTP\/\d+\.\d+)$/);return t?t[1]:undefined},get responseHeaders(){return this._responseHeaders||[]},set responseHeaders(e){this._responseHeaders=e,delete this._sortedResponseHeaders,delete this._responseCookies,this._responseHeaderValues={},this.dispatchEventToListeners(WebInspector.NetworkRequest.Events.ResponseHeadersChanged)},get responseHeadersText(){if(typeof this._responseHeadersText=="undefined"){this._responseHeadersText="HTTP/1.1 "+this.statusCode+" "+this.statusText+"\r\n";for(var e=0;e<this.responseHeaders.length;++e)this._responseHeadersText+=this.responseHeaders[e].name+": "+this.responseHeaders[e].value+"\r\n"}return this._responseHeadersText},set responseHeadersText(e){this._responseHeadersText=e,this.dispatchEventToListeners(WebInspector.NetworkRequest.Events.ResponseHeadersChanged)},get responseHeadersSize(){return this.responseHeadersText.length},get sortedResponseHeaders(){return this._sortedResponseHeaders!==undefined?this._sortedResponseHeaders:(this._sortedResponseHeaders=[],this._sortedResponseHeaders=this.responseHeaders.slice(),this._sortedResponseHeaders.sort(function(e,t){return e.name.toLowerCase().compareTo(t.name.toLowerCase())}),this._sortedResponseHeaders)},responseHeaderValue:function(e){var t=this._responseHeaderValues[e];return t===undefined&&(t=this._headerValue(this.responseHeaders,e),this._responseHeaderValues[e]=t!==undefined?t:null),t!==null?t:undefined},get responseCookies(){return this._responseCookies||(this._responseCookies=WebInspector.CookieParser.parseSetCookie(this.responseHeaderValue("Set-Cookie"))),this._responseCookies},queryString:function(){if(this._queryString)return this._queryString;var e=this.url.split("?",2)[1];return e?(this._queryString=e.split("#",2)[0],this._queryString):null},get queryParameters(){if(this._parsedQueryParameters)return this._parsedQueryParameters;var e=this.queryString();return e?(this._parsedQueryParameters=this._parseParameters(e),this._parsedQueryParameters):null},get formParameters(){if(this._parsedFormParameters)return this._parsedFormParameters;if(!this.requestFormData)return null;var e=this.requestContentType();return!e||!e.match(/^application\/x-www-form-urlencoded\s*(;.*)?$/i)?null:(this._parsedFormParameters=this._parseParameters(this.requestFormData),this._parsedFormParameters)},get responseHttpVersion(){var e=this.responseHeadersText.match(/^(HTTP\/\d+\.\d+)/);return e?e[1]:undefined},_parseParameters:function(e){function t(e){var t=e.split("=",2);return{name:t[0],value:t[1]||""}}return e.split("&").map(t)},_headerValue:function(e,t){t=t.toLowerCase();var n=[];for(var r=0;r<e.length;++r)e[r].name.toLowerCase()===t&&n.push(e[r].value);return n.length?t==="set-cookie"?n.join("\n"):n.join(", "):undefined},get content(){return this._content},get contentEncoded(){return this._contentEncoded},contentURL:function(){return this._url},contentType:function(){return this._type},requestContent:function(e){if(this.type===WebInspector.resourceTypes.WebSocket){e(null,!1,this._mimeType);return}if(typeof this._content!="undefined"){e(this.content||null,this._contentEncoded,this.type.canonicalMimeType()||this._mimeType);return}this._pendingContentCallbacks.push(e),this.finished&&this._innerRequestContent()},searchInContent:function(e,t,n,r){r([])},isHttpFamily:function(){return!!this.url.match(/^https?:/i)},requestContentType:function(){return this.requestHeaderValue("Content-Type")},isPingRequest:function(){return"text/ping"===this.requestContentType()},hasErrorStatusCode:function(){return this.statusCode>=400},populateImageSource:function(e){function t(t,n,r){var i=this.asDataURL();i===null&&(i=this.url),e.src=i}this.requestContent(t.bind(this))},asDataURL:function(){return WebInspector.contentAsDataURL(this._content,this.mimeType,this._contentEncoded)},_innerRequestContent:function(){function e(e,t,n){this._content=e?null:t,this._contentEncoded=n;var r=this._pendingContentCallbacks.slice();for(var i=0;i<r.length;++i)r[i](this._content,this._contentEncoded,this._mimeType);this._pendingContentCallbacks.length=0,delete this._contentRequested}if(this._contentRequested)return;this._contentRequested=!0,NetworkAgent.getResponseBody(this._requestId,e.bind(this))},initiatorInfo:function(){if(this._initiatorInfo)return this._initiatorInfo;var e=WebInspector.NetworkRequest.InitiatorType.Other,t="",n=-Infinity,r=-Infinity;if(this.redirectSource)e=WebInspector.NetworkRequest.InitiatorType.Redirect,t=this.redirectSource.url;else if(this.initiator)if(this.initiator.type===NetworkAgent.InitiatorType.Parser)e=WebInspector.NetworkRequest.InitiatorType.Parser,t=this.initiator.url,n=this.initiator.lineNumber;else if(this.initiator.type===NetworkAgent.InitiatorType.Script){var i=this.initiator.stackTrace[0];i.url&&(e=WebInspector.NetworkRequest.InitiatorType.Script,t=i.url,n=i.lineNumber,r=i.columnNumber)}return this._initiatorInfo={type:e,url:t,source:WebInspector.displayNameForURL(t),lineNumber:n,columnNumber:r},this._initiatorInfo},frames:function(){return this._frames},frame:function(e){return this._frames[e]},addFrameError:function(e,t){this._pushFrame({errorMessage:e,time:t})},addFrame:function(e,t,n){e.time=t,n&&(e.sent=n),this._pushFrame(e)},_pushFrame:function(e){this._frames.length>=100&&this._frames.splice(0,10),this._frames.push(e)},__proto__:WebInspector.Object.prototype};