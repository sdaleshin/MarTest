/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.FilteredItemSelectionDialog=function(e){WebInspector.DialogDelegate.call(this);var t=new XMLHttpRequest;t.open("GET","filteredItemSelectionDialog.css",!1),t.send(null),this.element=document.createElement("div"),this.element.className="filtered-item-list-dialog",this.element.addEventListener("keydown",this._onKeyDown.bind(this),!1);var n=this.element.createChild("style");n.type="text/css",n.textContent=t.responseText,this._promptElement=this.element.createChild("input","monospace"),this._promptElement.addEventListener("input",this._onInput.bind(this),!1),this._promptElement.type="text",this._promptElement.setAttribute("spellcheck","false"),this._filteredItems=[],this._viewportControl=new WebInspector.ViewportControl(this),this._itemElementsContainer=this._viewportControl.element,this._itemElementsContainer.addStyleClass("container"),this._itemElementsContainer.addStyleClass("monospace"),this._itemElementsContainer.addEventListener("click",this._onClick.bind(this),!1),this.element.appendChild(this._itemElementsContainer),this._delegate=e,this._delegate.setRefreshCallback(this._itemsLoaded.bind(this)),this._itemsLoaded(),this._shouldShowMatchingItems=!0},WebInspector.FilteredItemSelectionDialog.prototype={position:function(e,t){const n=500,r=204;var i=Math.max(t.offsetWidth*2/3,n),s=Math.max(t.offsetHeight*2/3,r);this.element.style.width=i+"px";const o=20;e.positionAt(t.totalOffsetLeft()+Math.max((t.offsetWidth-i-2*o)/2,o),t.totalOffsetTop()+Math.max((t.offsetHeight-s-2*o)/2,o)),this._dialogHeight=s,this._updateShowMatchingItems()},focus:function(){WebInspector.setCurrentFocusElement(this._promptElement),this._filteredItems.length&&this._viewportControl.lastVisibleIndex()===-1&&this._viewportControl.refresh()},willHide:function(){if(this._isHiding)return;this._isHiding=!0,this._delegate.dispose(),this._filterTimer&&clearTimeout(this._filterTimer)},renderAsTwoRows:function(){this._renderAsTwoRows=!0},onEnter:function(){if(!this._delegate.itemCount())return;this._delegate.selectItem(this._filteredItems[this._selectedIndexInFiltered],this._promptElement.value.trim())},_itemsLoaded:function(){if(this._loadTimeout)return;this._loadTimeout=setTimeout(this._updateAfterItemsLoaded.bind(this),0)},_updateAfterItemsLoaded:function(){delete this._loadTimeout,this._filterItems()},_createItemElement:function(e){var t=document.createElement("div");return t.className="filtered-item-list-dialog-item "+(this._renderAsTwoRows?"two-rows":"one-row"),t._titleElement=t.createChild("span"),t._titleSuffixElement=t.createChild("span"),t._subtitleElement=t.createChild("div","filtered-item-list-dialog-subtitle"),t._subtitleElement.textContent="â€‹",t._index=e,this._delegate.renderItem(e,this._promptElement.value.trim(),t._titleElement,t._subtitleElement),t},setQuery:function(e){this._promptElement.value=e,this._scheduleFilter()},_filterItems:function(){function l(e,t){return t-e}function c(t){var h=1e3,p=0;for(var d=t;d<this._delegate.itemCount()&&p<h;++d){if(n&&!n.test(this._delegate.itemKeyAt(d)))continue;var v=this._delegate.itemScoreAt(d,e);e&&p++;if(v>a||s.length<u){var m=insertionIndexForObjectInListSortedByFunction(v,s,l,!0);s.splice(m,0,v),o.splice(m,0,d),s.length>u&&(f.push(o.peekLast()),s.length=u,o.length=u),a=s.peekLast()}else i.push(d)}if(d<this._delegate.itemCount()){this._scoringTimer=setTimeout(c.bind(this,d),0);return}delete this._scoringTimer,this._filteredItems=o.concat(f).concat(i);for(var d=0;d<this._filteredItems.length;++d)if(this._filteredItems[d]===r){this._selectedIndexInFiltered=d;break}this._viewportControl.refresh(),e||(this._selectedIndexInFiltered=0),this._updateSelection(this._selectedIndexInFiltered,!1)}delete this._filterTimer,this._scoringTimer&&(clearTimeout(this._scoringTimer),delete this._scoringTimer);var e=this._delegate.rewriteQuery(this._promptElement.value.trim());this._query=e;var t=e.length,n=e?WebInspector.FilePathScoreFunction.filterRegex(e):null,r=this._selectedIndexInFiltered?this._filteredItems[this._selectedIndexInFiltered]:null,i=[];this._selectedIndexInFiltered=0;var s=[],o=[],u=100,a=0,f=[];c.call(this,0)},_onInput:function(e){this._shouldShowMatchingItems=this._delegate.shouldShowMatchingItems(this._promptElement.value),this._updateShowMatchingItems(),this._scheduleFilter()},_updateShowMatchingItems:function(){this._itemElementsContainer.enableStyleClass("hidden",!this._shouldShowMatchingItems),this.element.style.height=this._shouldShowMatchingItems?this._dialogHeight+"px":"auto"},_onKeyDown:function(e){var t=this._selectedIndexInFiltered;switch(e.keyCode){case WebInspector.KeyboardShortcut.Keys.Down.code:++t>=this._filteredItems.length&&(t=this._filteredItems.length-1),this._updateSelection(t,!0),e.consume(!0);break;case WebInspector.KeyboardShortcut.Keys.Up.code:--t<0&&(t=0),this._updateSelection(t,!1),e.consume(!0);break;case WebInspector.KeyboardShortcut.Keys.PageDown.code:t=Math.min(t+this._viewportControl.rowsPerViewport(),this._filteredItems.length-1),this._updateSelection(t,!0),e.consume(!0);break;case WebInspector.KeyboardShortcut.Keys.PageUp.code:t=Math.max(t-this._viewportControl.rowsPerViewport(),0),this._updateSelection(t,!1),e.consume(!0);break;default:}},_scheduleFilter:function(){if(this._filterTimer)return;this._filterTimer=setTimeout(this._filterItems.bind(this),0)},_updateSelection:function(e,t){var n=this._viewportControl.renderedElementAt(this._selectedIndexInFiltered);n&&n.removeStyleClass("selected"),this._viewportControl.scrollItemIntoView(e,t),this._selectedIndexInFiltered=e,n=this._viewportControl.renderedElementAt(e),n&&n.addStyleClass("selected")},_onClick:function(e){var t=e.target.enclosingNodeOrSelfWithClass("filtered-item-list-dialog-item");if(!t)return;this._delegate.selectItem(t._index,this._promptElement.value.trim()),WebInspector.Dialog.hide()},itemCount:function(){return this._filteredItems.length},itemElement:function(e){var t=this._filteredItems[e],n=this._createItemElement(t);return e===this._selectedIndexInFiltered&&n.addStyleClass("selected"),n},__proto__:WebInspector.DialogDelegate.prototype},WebInspector.SelectionDialogContentProvider=function(){},WebInspector.SelectionDialogContentProvider.prototype={setRefreshCallback:function(e){this._refreshCallback=e},shouldShowMatchingItems:function(e){return!0},itemCount:function(){return 0},itemKeyAt:function(e){return""},itemScoreAt:function(e,t){return 1},renderItem:function(e,t,n,r){},highlightRanges:function(e,t){function n(e,t){var n=new difflib.SequenceMatcher(t,e),r=n.get_opcodes(),i=[];for(var s=0;s<r.length;++s){var o=r[s];if(o[0]==="equal")i.push({offset:o[3],length:o[4]-o[3]});else if(o[0]!=="insert")return null}return i}if(!t)return!1;var r=e.textContent,i=n(r,t);return i||(i=n(r.toUpperCase(),t.toUpperCase())),i?(WebInspector.highlightRangesWithStyleClass(e,i,"highlight"),!0):!1},selectItem:function(e,t){},refresh:function(){this._refreshCallback()},rewriteQuery:function(e){return e},dispose:function(){}},WebInspector.JavaScriptOutlineDialog=function(e,t){WebInspector.SelectionDialogContentProvider.call(this),this._functionItems=[],this._view=e,t.requestContent(this._contentAvailable.bind(this))},WebInspector.JavaScriptOutlineDialog.show=function(e,t){if(WebInspector.Dialog.currentInstance())return null;var n=new WebInspector.FilteredItemSelectionDialog(new WebInspector.JavaScriptOutlineDialog(e,t));WebInspector.Dialog.show(e.element,n)},WebInspector.JavaScriptOutlineDialog.prototype={_contentAvailable:function(e,t,n){this._outlineWorker=new Worker("ScriptFormatterWorker.js"),this._outlineWorker.onmessage=this._didBuildOutlineChunk.bind(this);const r="outline";this._outlineWorker.postMessage({method:r,params:{content:e}})},_didBuildOutlineChunk:function(e){var t=e.data,n=t.chunk;for(var r=0;r<n.length;++r)this._functionItems.push(n[r]);t.total===t.index&&this.dispose(),this.refresh()},itemCount:function(){return this._functionItems.length},itemKeyAt:function(e){return this._functionItems[e].name},itemScoreAt:function(e,t){var n=this._functionItems[e];return-n.line},renderItem:function(e,t,n,r){var i=this._functionItems[e];n.textContent=i.name+(i.arguments?i.arguments:""),this.highlightRanges(n,t),r.textContent=":"+(i.line+1)},selectItem:function(e,t){var n=this._functionItems[e].line;!isNaN(n)&&n>=0&&this._view.highlightPosition(n,this._functionItems[e].column),this._view.focus()},dispose:function(){this._outlineWorker&&(this._outlineWorker.terminate(),delete this._outlineWorker)},__proto__:WebInspector.SelectionDialogContentProvider.prototype},WebInspector.SelectUISourceCodeDialog=function(e){WebInspector.SelectionDialogContentProvider.call(this),this._uiSourceCodes=[];var t=WebInspector.workspace.projects().filter(this.filterProject.bind(this));for(var n=0;n<t.length;++n)this._uiSourceCodes=this._uiSourceCodes.concat(t[n].uiSourceCodes());this._defaultScores=e,this._scorer=new WebInspector.FilePathScoreFunction(""),WebInspector.workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this)},WebInspector.SelectUISourceCodeDialog.prototype={uiSourceCodeSelected:function(e,t){},filterProject:function(e){return!0},itemCount:function(){return this._uiSourceCodes.length},itemKeyAt:function(e){return this._uiSourceCodes[e].fullDisplayName()},itemScoreAt:function(e,t){var n=this._uiSourceCodes[e],r=this._defaultScores?this._defaultScores.get(n)||0:0;if(!t||t.length<2)return r;this._query!==t&&(this._query=t,this._scorer=new WebInspector.FilePathScoreFunction(t));var i=n.fullDisplayName();return r+10*this._scorer.score(i,null)},renderItem:function(e,t,n,r){t=this.rewriteQuery(t);var i=this._uiSourceCodes[e];n.textContent=i.displayName()+(this._queryLineNumber?this._queryLineNumber:""),r.textContent=i.fullDisplayName().trimEnd(100);var s=[],o=(new WebInspector.FilePathScoreFunction(t)).score(r.textContent,s),u=r.textContent.lastIndexOf("/"),a=[];for(var f=0;f<s.length;++f)a.push({offset:s[f],length:1});if(s[0]>u){for(var f=0;f<a.length;++f)a[f].offset-=u+1;return WebInspector.highlightRangesWithStyleClass(n,a,"highlight")}return WebInspector.highlightRangesWithStyleClass(r,a,"highlight")},selectItem:function(e,t){if(/^:\d+$/.test(t.trimRight())){var n=parseInt(t.trimRight().substring(1),10)-1;!isNaN(n)&&n>=0&&this.uiSourceCodeSelected(null,n);return}var r=t.match(/[^:]+\:([\d]*)$/),n=r?Math.max(parseInt(r[1],10)-1,0):undefined;this.uiSourceCodeSelected(this._uiSourceCodes[e],n)},rewriteQuery:function(e){if(!e)return e;e=e.trim();var t=e.match(/([^:]+)(\:[\d]*)$/);return this._queryLineNumber=t?t[2]:"",t?t[1]:e},_uiSourceCodeAdded:function(e){var t=e.data;if(!this.filterProject(t.project()))return;this._uiSourceCodes.push(t),this.refresh()},dispose:function(){WebInspector.workspace.removeEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this)},__proto__:WebInspector.SelectionDialogContentProvider.prototype},WebInspector.OpenResourceDialog=function(e,t){WebInspector.SelectUISourceCodeDialog.call(this,t),this._panel=e},WebInspector.OpenResourceDialog.prototype={uiSourceCodeSelected:function(e,t){e||(e=this._panel.currentUISourceCode());if(!e)return;this._panel.showUISourceCode(e,t)},shouldShowMatchingItems:function(e){return!e.startsWith(":")},filterProject:function(e){return!e.isServiceProject()},__proto__:WebInspector.SelectUISourceCodeDialog.prototype},WebInspector.OpenResourceDialog.show=function(e,t,n,r){if(WebInspector.Dialog.currentInstance())return;var i=new WebInspector.FilteredItemSelectionDialog(new WebInspector.OpenResourceDialog(e,r));i.renderAsTwoRows(),n&&i.setQuery(n),WebInspector.Dialog.show(t,i)},WebInspector.SelectUISourceCodeForProjectTypeDialog=function(e,t){this._type=e,WebInspector.SelectUISourceCodeDialog.call(this),this._callback=t},WebInspector.SelectUISourceCodeForProjectTypeDialog.prototype={uiSourceCodeSelected:function(e,t){this._callback(e)},filterProject:function(e){return e.type()===this._type},__proto__:WebInspector.SelectUISourceCodeDialog.prototype},WebInspector.SelectUISourceCodeForProjectTypeDialog.show=function(e,t,n,r){if(WebInspector.Dialog.currentInstance())return;var i=new WebInspector.FilteredItemSelectionDialog(new WebInspector.SelectUISourceCodeForProjectTypeDialog(t,n));i.setQuery(e),i.renderAsTwoRows(),WebInspector.Dialog.show(r,i)};