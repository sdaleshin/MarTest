/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

function HeapSnapshotMetainfo(){this.node_fields=[],this.node_types=[],this.edge_fields=[],this.edge_types=[],this.type_strings={},this.fields=[],this.types=[]}function HeapSnapshotHeader(){this.title="",this.uid=0,this.meta=new HeapSnapshotMetainfo,this.node_count=0,this.edge_count=0}WebInspector.HeapSnapshotArraySlice=function(e,t,n){this._array=e,this._start=t,this.length=n-t},WebInspector.HeapSnapshotArraySlice.prototype={item:function(e){return this._array[this._start+e]},slice:function(e,t){return typeof t=="undefined"&&(t=this.length),this._array.subarray(this._start+e,this._start+t)}},WebInspector.HeapSnapshotEdge=function(e,t,n){this._snapshot=e,this._edges=t,this.edgeIndex=n||0},WebInspector.HeapSnapshotEdge.prototype={clone:function(){return new WebInspector.HeapSnapshotEdge(this._snapshot,this._edges,this.edgeIndex)},hasStringName:function(){throw new Error("Not implemented")},name:function(){throw new Error("Not implemented")},node:function(){return this._snapshot.createNode(this.nodeIndex())},nodeIndex:function(){return this._edges.item(this.edgeIndex+this._snapshot._edgeToNodeOffset)},rawEdges:function(){return this._edges},toString:function(){return"HeapSnapshotEdge: "+this.name()},type:function(){return this._snapshot._edgeTypes[this._type()]},serialize:function(){var e=this.node();return{name:this.name(),node:e.serialize(),nodeIndex:this.nodeIndex(),type:this.type(),distance:e.distance()}},_type:function(){return this._edges.item(this.edgeIndex+this._snapshot._edgeTypeOffset)}},WebInspector.HeapSnapshotEdgeIterator=function(e){this.edge=e},WebInspector.HeapSnapshotEdgeIterator.prototype={rewind:function(){this.edge.edgeIndex=0},hasNext:function(){return this.edge.edgeIndex<this.edge._edges.length},index:function(){return this.edge.edgeIndex},setIndex:function(e){this.edge.edgeIndex=e},item:function(){return this.edge},next:function(){this.edge.edgeIndex+=this.edge._snapshot._edgeFieldsCount}},WebInspector.HeapSnapshotRetainerEdge=function(e,t,n){this._snapshot=e,this._retainedNodeIndex=t;var r=t/e._nodeFieldCount;this._firstRetainer=e._firstRetainerIndex[r],this._retainersCount=e._firstRetainerIndex[r+1]-this._firstRetainer,this.setRetainerIndex(n)},WebInspector.HeapSnapshotRetainerEdge.prototype={clone:function(){return new WebInspector.HeapSnapshotRetainerEdge(this._snapshot,this._retainedNodeIndex,this.retainerIndex())},hasStringName:function(){return this._edge().hasStringName()},name:function(){return this._edge().name()},node:function(){return this._node()},nodeIndex:function(){return this._nodeIndex},retainerIndex:function(){return this._retainerIndex},setRetainerIndex:function(e){e!==this._retainerIndex&&(this._retainerIndex=e,this.edgeIndex=e)},set edgeIndex(e){var t=this._firstRetainer+e;this._globalEdgeIndex=this._snapshot._retainingEdges[t],this._nodeIndex=this._snapshot._retainingNodes[t],delete this._edgeInstance,delete this._nodeInstance},_node:function(){return this._nodeInstance||(this._nodeInstance=this._snapshot.createNode(this._nodeIndex)),this._nodeInstance},_edge:function(){if(!this._edgeInstance){var e=this._globalEdgeIndex-this._node()._edgeIndexesStart();this._edgeInstance=this._snapshot.createEdge(this._node().rawEdges(),e)}return this._edgeInstance},toString:function(){return this._edge().toString()},serialize:function(){var e=this.node();return{name:this.name(),node:e.serialize(),nodeIndex:this.nodeIndex(),type:this.type(),distance:e.distance()}},type:function(){return this._edge().type()}},WebInspector.HeapSnapshotRetainerEdgeIterator=function(e){this.retainer=e},WebInspector.HeapSnapshotRetainerEdgeIterator.prototype={rewind:function(){this.retainer.setRetainerIndex(0)},hasNext:function(){return this.retainer.retainerIndex()<this.retainer._retainersCount},index:function(){return this.retainer.retainerIndex()},setIndex:function(e){this.retainer.setRetainerIndex(e)},item:function(){return this.retainer},next:function(){this.retainer.setRetainerIndex(this.retainer.retainerIndex()+1)}},WebInspector.HeapSnapshotNode=function(e,t){this._snapshot=e,this._firstNodeIndex=t,this.nodeIndex=t},WebInspector.HeapSnapshotNode.prototype={distance:function(){return this._snapshot._nodeDistances[this.nodeIndex/this._snapshot._nodeFieldCount]},className:function(){throw new Error("Not implemented")},classIndex:function(){throw new Error("Not implemented")},dominatorIndex:function(){var e=this._snapshot._nodeFieldCount;return this._snapshot._dominatorsTree[this.nodeIndex/this._snapshot._nodeFieldCount]*e},edges:function(){return new WebInspector.HeapSnapshotEdgeIterator(this._snapshot.createEdge(this.rawEdges(),0))},edgesCount:function(){return(this._edgeIndexesEnd()-this._edgeIndexesStart())/this._snapshot._edgeFieldsCount},id:function(){throw new Error("Not implemented")},isRoot:function(){return this.nodeIndex===this._snapshot._rootNodeIndex},name:function(){return this._snapshot._strings[this._name()]},rawEdges:function(){return new WebInspector.HeapSnapshotArraySlice(this._snapshot._containmentEdges,this._edgeIndexesStart(),this._edgeIndexesEnd())},retainedSize:function(){var e=this._snapshot;return e._nodes[this.nodeIndex+e._nodeRetainedSizeOffset]},retainers:function(){return new WebInspector.HeapSnapshotRetainerEdgeIterator(this._snapshot.createRetainingEdge(this.nodeIndex,0))},selfSize:function(){var e=this._snapshot;return e._nodes[this.nodeIndex+e._nodeSelfSizeOffset]},type:function(){return this._snapshot._nodeTypes[this._type()]},serialize:function(){return{id:this.id(),name:this.name(),distance:this.distance(),nodeIndex:this.nodeIndex,retainedSize:this.retainedSize(),selfSize:this.selfSize(),type:this.type()}},_name:function(){var e=this._snapshot;return e._nodes[this.nodeIndex+e._nodeNameOffset]},_edgeIndexesStart:function(){return this._snapshot._firstEdgeIndexes[this._ordinal()]},_edgeIndexesEnd:function(){return this._snapshot._firstEdgeIndexes[this._ordinal()+1]},_ordinal:function(){return this.nodeIndex/this._snapshot._nodeFieldCount},_nextNodeIndex:function(){return this.nodeIndex+this._snapshot._nodeFieldCount},_type:function(){var e=this._snapshot;return e._nodes[this.nodeIndex+e._nodeTypeOffset]}},WebInspector.HeapSnapshotNodeIterator=function(e){this.node=e,this._nodesLength=e._snapshot._nodes.length},WebInspector.HeapSnapshotNodeIterator.prototype={rewind:function(){this.node.nodeIndex=this.node._firstNodeIndex},hasNext:function(){return this.node.nodeIndex<this._nodesLength},index:function(){return this.node.nodeIndex},setIndex:function(e){this.node.nodeIndex=e},item:function(){return this.node},next:function(){this.node.nodeIndex=this.node._nextNodeIndex()}},WebInspector.HeapSnapshotProgress=function(e){this._dispatcher=e},WebInspector.HeapSnapshotProgress.Event={Update:"ProgressUpdate"},WebInspector.HeapSnapshotProgress.prototype={updateStatus:function(e){this._sendUpdateEvent(WebInspector.UIString(e))},updateProgress:function(e,t,n){var r=((n?t/n:0)*100).toFixed(0);this._sendUpdateEvent(WebInspector.UIString(e,r))},_sendUpdateEvent:function(e){this._dispatcher&&this._dispatcher.sendEvent(WebInspector.HeapSnapshotProgress.Event.Update,e)}},WebInspector.HeapSnapshot=function(e,t){this.uid=e.snapshot.uid,this._nodes=e.nodes,this._containmentEdges=e.edges,this._metaNode=e.snapshot.meta,this._strings=e.strings,this._progress=t,this._noDistance=-5,this._rootNodeIndex=0,e.snapshot.root_index&&(this._rootNodeIndex=e.snapshot.root_index),this._snapshotDiffs={},this._aggregatesForDiff=null,this._init()},WebInspector.HeapSnapshot.prototype={_init:function(){var e=this._metaNode;this._nodeTypeOffset=e.node_fields.indexOf("type"),this._nodeNameOffset=e.node_fields.indexOf("name"),this._nodeIdOffset=e.node_fields.indexOf("id"),this._nodeSelfSizeOffset=e.node_fields.indexOf("self_size"),this._nodeEdgeCountOffset=e.node_fields.indexOf("edge_count"),this._nodeFieldCount=e.node_fields.length,this._nodeTypes=e.node_types[this._nodeTypeOffset],this._nodeHiddenType=this._nodeTypes.indexOf("hidden"),this._nodeObjectType=this._nodeTypes.indexOf("object"),this._nodeNativeType=this._nodeTypes.indexOf("native"),this._nodeCodeType=this._nodeTypes.indexOf("code"),this._nodeSyntheticType=this._nodeTypes.indexOf("synthetic"),this._edgeFieldsCount=e.edge_fields.length,this._edgeTypeOffset=e.edge_fields.indexOf("type"),this._edgeNameOffset=e.edge_fields.indexOf("name_or_index"),this._edgeToNodeOffset=e.edge_fields.indexOf("to_node"),this._edgeTypes=e.edge_types[this._edgeTypeOffset],this._edgeTypes.push("invisible"),this._edgeElementType=this._edgeTypes.indexOf("element"),this._edgeHiddenType=this._edgeTypes.indexOf("hidden"),this._edgeInternalType=this._edgeTypes.indexOf("internal"),this._edgeShortcutType=this._edgeTypes.indexOf("shortcut"),this._edgeWeakType=this._edgeTypes.indexOf("weak"),this._edgeInvisibleType=this._edgeTypes.indexOf("invisible"),this.nodeCount=this._nodes.length/this._nodeFieldCount,this._edgeCount=this._containmentEdges.length/this._edgeFieldsCount,this._progress.updateStatus("Building edge indexes…"),this._buildEdgeIndexes(),this._progress.updateStatus("Marking invisible edges…"),this._markInvisibleEdges(),this._progress.updateStatus("Building retainers…"),this._buildRetainers(),this._progress.updateStatus("Calculating node flags…"),this._calculateFlags(),this._progress.updateStatus("Calculating distances…"),this._calculateDistances(),this._progress.updateStatus("Building postorder index…");var t=this._buildPostOrderIndex();this._progress.updateStatus("Building dominator tree…"),this._dominatorsTree=this._buildDominatorTree(t.postOrderIndex2NodeOrdinal,t.nodeOrdinal2PostOrderIndex),this._progress.updateStatus("Calculating retained sizes…"),this._calculateRetainedSizes(t.postOrderIndex2NodeOrdinal),this._progress.updateStatus("Buiding dominated nodes…"),this._buildDominatedNodes(),this._progress.updateStatus("Finished processing.")},_buildEdgeIndexes:function(){var e=this._nodes,t=this.nodeCount,n=this._firstEdgeIndexes=new Uint32Array(t+1),r=this._nodeFieldCount,i=this._edgeFieldsCount,s=this._nodeEdgeCountOffset;n[t]=this._containmentEdges.length;for(var o=0,u=0;o<t;++o)n[o]=u,u+=e[o*r+s]*i},_buildRetainers:function(){var e=this._retainingNodes=new Uint32Array(this._edgeCount),t=this._retainingEdges=new Uint32Array(this._edgeCount),n=this._firstRetainerIndex=new Uint32Array(this.nodeCount+1),r=this._containmentEdges,i=this._edgeFieldsCount,s=this._nodeFieldCount,o=this._edgeToNodeOffset,u=this._nodes,a=this._firstEdgeIndexes,f=this.nodeCount;for(var l=o,c=r.length;l<c;l+=i){var h=r[l];if(h%s)throw new Error("Invalid toNodeIndex "+h);++n[h/s]}for(var p=0,d=0;p<f;p++){var v=n[p];n[p]=d,e[d]=v,d+=v}n[f]=e.length;var m=a[0];for(var g=0;g<f;++g){var y=m;m=a[g+1];var b=g*s;for(var w=y;w<m;w+=i){var h=r[w+o];if(h%s)throw new Error("Invalid toNodeIndex "+h);var E=n[h/s],S=E+ --e[E];e[S]=b,t[S]=w}}},createNode:function(e){throw new Error("Not implemented")},createEdge:function(e,t){throw new Error("Not implemented")},createRetainingEdge:function(e,t){throw new Error("Not implemented")},dispose:function(){delete this._nodes,delete this._strings,delete this._retainingEdges,delete this._retainingNodes,delete this._firstRetainerIndex,this._aggregates&&(delete this._aggregates,delete this._aggregatesSortedFlags),delete this._dominatedNodes,delete this._firstDominatedNodeIndex,delete this._nodeDistances,delete this._dominatorsTree},_allNodes:function(){return new WebInspector.HeapSnapshotNodeIterator(this.rootNode())},rootNode:function(){return this.createNode(this._rootNodeIndex)},get rootNodeIndex(){return this._rootNodeIndex},get totalSize(){return this.rootNode().retainedSize()},_getDominatedIndex:function(e){if(e%this._nodeFieldCount)throw new Error("Invalid nodeIndex: "+e);return this._firstDominatedNodeIndex[e/this._nodeFieldCount]},_dominatedNodesOfNode:function(e){var t=this._getDominatedIndex(e.nodeIndex),n=this._getDominatedIndex(e._nextNodeIndex());return new WebInspector.HeapSnapshotArraySlice(this._dominatedNodes,t,n)},aggregates:function(e,t,n){this._aggregates||(this._aggregates={},this._aggregatesSortedFlags={});var r=this._aggregates[t];if(r)return e&&!this._aggregatesSortedFlags[t]&&(this._sortAggregateIndexes(r),this._aggregatesSortedFlags[t]=e),r;var i;n&&(i=this._parseFilter(n));var s=this._buildAggregates(i);return this._calculateClassesRetainedSize(s.aggregatesByClassIndex,i),r=s.aggregatesByClassName,e&&this._sortAggregateIndexes(r),this._aggregatesSortedFlags[t]=e,this._aggregates[t]=r,r},aggregatesForDiff:function(){if(this._aggregatesForDiff)return this._aggregatesForDiff;var e=this.aggregates(!0,"allObjects");this._aggregatesForDiff={};var t=this.createNode();for(var n in e){var r=e[n],i=r.idxs,s=new Array(i.length),o=new Array(i.length);for(var u=0;u<i.length;u++)t.nodeIndex=i[u],s[u]=t.id(),o[u]=t.selfSize();this._aggregatesForDiff[n]={indexes:i,ids:s,selfSizes:o}}return this._aggregatesForDiff},_isUserRoot:function(e){return!0},forEachRoot:function(e,t){for(var n=this.rootNode().edges();n.hasNext();n.next()){var r=n.edge.node();(!t||this._isUserRoot(r))&&e(r)}},_calculateDistances:function(){function u(e){var t=e._ordinal();if(n[t]!==r)return;n[t]=0,s[o++]=e.nodeIndex}var e=this._nodeFieldCount,t=this.nodeCount,n=new Int32Array(t),r=this._noDistance;for(var i=0;i<t;++i)n[i]=r;var s=new Uint32Array(this.nodeCount),o=0;this.forEachRoot(u,!0),this._bfs(s,o,n),o=0,this.forEachRoot(u),this._bfs(s,o,n),this._nodeDistances=n},_bfs:function(e,t,n){var r=this._edgeFieldsCount,i=this._nodeFieldCount,s=this._containmentEdges,o=this._firstEdgeIndexes,u=this._edgeToNodeOffset,a=this._edgeTypeOffset,f=this._nodes,l=this.nodeCount,c=s.length,h=this._edgeWeakType,p=this._noDistance,d=0;while(d<t){var v=e[d++],m=v/i,g=n[m]+1,y=o[m],b=o[m+1];for(var w=y;w<b;w+=r){var E=s[w+a];if(E==h)continue;var S=s[w+u],x=S/i;if(n[x]!==p)continue;n[x]=g,e[t++]=S}}if(t>l)throw new Error("BFS failed. Nodes to visit ("+t+") is more than nodes count ("+l+")")},_buildAggregates:function(e){var t={},n={},r=[],i=this._nodes,s=this.userObjectsMapAndFlag(),o=s?s.map:null,u=s?s.flag:0,a=i.length,f=this._nodeNativeType,l=this._nodeFieldCount,c=this._nodeSelfSizeOffset,h=this._nodeTypeOffset,p=this.rootNode(),d=this._nodeDistances;for(var v=0;v<a;v+=l){var m=v/l;if(o&&!(o[m]&u))continue;p.nodeIndex=v;if(e&&!e(p))continue;var g=i[v+c];if(!g&&i[v+h]!==f)continue;var y=p.classIndex();if(y in t){var S=t[y];S.distance=Math.min(S.distance,d[m]),++S.count,S.self+=g,S.idxs.push(v)}else{var b=p.type(),w=b==="object"||b==="native",E={count:1,distance:d[m],self:g,maxRet:0,type:b,name:w?p.name():null,idxs:[v]};t[y]=E,r.push(y),n[p.className()]=E}}for(var x=0,T=r.length;x<T;++x){var y=r[x];t[y].idxs=t[y].idxs.slice()}return{aggregatesByClassName:n,aggregatesByClassIndex:t}},_calculateClassesRetainedSize:function(e,t){var n=this._rootNodeIndex,r=this.createNode(n),i=[n],s=[-1],o=[],u={},a=this._nodeFieldCount,f=this._nodeTypeOffset,l=this._nodeNativeType,c=this._dominatedNodes,h=this._nodes,p=this.userObjectsMapAndFlag(),d=p?p.map:null,v=p?p.flag:0,m=this._firstDominatedNodeIndex;while(i.length){var g=i.pop();r.nodeIndex=g;var y=r.classIndex(),b=!!u[y],w=g/a,E=m[w],S=m[w+1];!b&&(!d||d[w]&v)&&(!t||t(r))&&(r.selfSize()||h[g+f]===l)&&(e[y].maxRet+=r.retainedSize(),E!==S&&(u[y]=!0,s.push(i.length),o.push(y)));for(var x=E;x<S;x++)i.push(c[x]);var T=i.length;while(s[s.length-1]===T)s.pop(),y=o.pop(),u[y]=!1}},_sortAggregateIndexes:function(e){var t=this.createNode(),n=this.createNode();for(var r in e)e[r].idxs.sort(function(e,r){return t.nodeIndex=e,n.nodeIndex=r,t.id()<n.id()?-1:1})},_buildPostOrderIndex:function(){var e=this._nodeFieldCount,t=this._nodes,n=this.nodeCount,r=this._rootNodeIndex/e,i=this._edgeFieldsCount,s=this._edgeTypeOffset,o=this._edgeToNodeOffset,u=this._edgeShortcutType,a=this._firstEdgeIndexes,f=this._containmentEdges,l=this._containmentEdges.length,c=this.userObjectsMapAndFlag(),h=c?c.map:null,p=c?c.flag:0,d=new Uint32Array(n),v=new Uint32Array(n),m=new Uint32Array(n),g=new Uint8Array(n),y=0,b=0,w=1,E=2;d[y++]=r,g[r]=w;while(y){var S=d[y-1];if(g[S]===w){g[S]=E;var x=!h||h[S]&p,T=a[S],N=a[S+1];for(var C=T;C<N;C+=i){if(S!==r&&f[C+s]===u)continue;var k=f[C+o],L=k/e,A=!h||h[L]&p;if(S!==r&&A&&!x)continue;g[L]||(g[L]=w,d[y++]=L)}}else m[S]=b,v[b++]=S,--y}if(b!==n){console.log("Error: Corrupted snapshot. "+(n-b)+" nodes are unreachable from the root:");var O=this.rootNode();for(var M=0;M<n;++M)if(g[M]!==E){m[M]=b,v[b++]=M,O.nodeIndex=M*e,console.log(JSON.stringify(O.serialize()));for(var _=O.retainers();_.hasNext();_=_.item().node().retainers())console.log("  edgeName: "+_.item().name()+" nodeClassName: "+_.item().node().className())}}return{postOrderIndex2NodeOrdinal:v,nodeOrdinal2PostOrderIndex:m}},_buildDominatorTree:function(e,t){var n=this._nodeFieldCount,r=this._nodes,i=this._firstRetainerIndex,s=this._retainingNodes,o=this._retainingEdges,u=this._edgeFieldsCount,a=this._edgeTypeOffset,f=this._edgeToNodeOffset,l=this._edgeShortcutType,c=this._firstEdgeIndexes,h=this._containmentEdges,p=this._containmentEdges.length,d=this._rootNodeIndex,v=this.userObjectsMapAndFlag(),m=v?v.map:null,g=v?v.flag:0,y=e.length,b=y-1,w=y,E=new Uint32Array(y);for(var S=0;S<b;++S)E[S]=w;E[b]=b;var x=new Uint8Array(y),T;T=this._rootNodeIndex/n;var N=c[T]+f,C=c[T+1];for(var k=N;k<C;k+=u){var L=h[k]/n;x[t[L]]=1}var A=!0;while(A){A=!1;for(var O=b-1;O>=0;--O){if(x[O]===0)continue;x[O]=0;if(E[O]===b)continue;T=e[O];var M=!m||m[T]&g,_=w,D=i[T],P=i[T+1];for(var H=D;H<P;++H){var B=o[H],j=h[B+a],F=s[H];if(F!==d&&j===l)continue;var I=F/n,q=!m||m[I]&g;if(F!==d&&M&&!q)continue;var R=t[I];if(E[R]!==w){if(_===w)_=R;else while(R!==_){while(R<_)R=E[R];while(_<R)_=E[_]}if(_===b)break}}if(_!==w&&E[O]!==_){E[O]=_,A=!0,T=e[O],N=c[T]+f,C=c[T+1];for(var k=N;k<C;k+=u){var L=h[k]/n;x[t[L]]=1}}}}var U=new Uint32Array(y);for(var O=0,z=E.length;O<z;++O)T=e[O],U[T]=e[E[O]];return U},_calculateRetainedSizes:function(e){var t=this.nodeCount,n=this._nodes,r=this._nodeSelfSizeOffset,i=this._nodeFieldCount,s=this._dominatorsTree,o=this._nodeRetainedSizeOffset=this._nodeEdgeCountOffset;delete this._nodeEdgeCountOffset;for(var u=0,a=n.length;u<a;u+=i)n[u+o]=n[u+r];for(var f=0;f<t-1;++f){var l=e[f],u=l*i,c=s[l]*i;n[c+o]+=n[u+o]}},_buildDominatedNodes:function(){var e=this._firstDominatedNodeIndex=new Uint32Array(this.nodeCount+1),t=this._dominatedNodes=new Uint32Array(this.nodeCount-1),n=this._nodeFieldCount,r=this._dominatorsTree,i=0,s=this.nodeCount,o=this._rootNodeIndex/n;if(o===i)i=1;else{if(o!==s-1)throw new Error("Root node is expected to be either first or last");s-=1}for(var u=i;u<s;++u)++e[r[u]];var a=0;for(var f=0,l=this.nodeCount;f<l;++f){var c=t[a]=e[f];e[f]=a,a+=c}e[this.nodeCount]=t.length;for(var u=i;u<s;++u){var h=r[u],p=e[h];p+=--t[p],t[p]=u*n}},_markInvisibleEdges:function(){throw new Error("Not implemented")},_calculateFlags:function(){throw new Error("Not implemented")},userObjectsMapAndFlag:function(){throw new Error("Not implemented")},calculateSnapshotDiff:function(e,t){var n=this._snapshotDiffs[e];if(n)return n;n={};var r=this.aggregates(!0,"allObjects");for(var i in t){var s=t[i],o=this._calculateDiffForClass(s,r[i]);o&&(n[i]=o)}var u={ids:[],indexes:[],selfSizes:[]};for(var i in r){if(i in t)continue;n[i]=this._calculateDiffForClass(u,r[i])}return this._snapshotDiffs[e]=n,n},_calculateDiffForClass:function(e,t){var n=e.ids,r=e.indexes,i=e.selfSizes,s=t?t.idxs:[],o=0,u=n.length,a=0,f=s.length,l={addedCount:0,removedCount:0,addedSize:0,removedSize:0,deletedIndexes:[],addedIndexes:[]},c=this.createNode(s[a]);while(o<u&&a<f){var h=n[o];h<c.id()?(l.deletedIndexes.push(r[o]),l.removedCount++,l.removedSize+=i[o],++o):h>c.id()?(l.addedIndexes.push(s[a]),l.addedCount++,l.addedSize+=c.selfSize(),c.nodeIndex=s[++a]):(++o,c.nodeIndex=s[++a])}while(o<u)l.deletedIndexes.push(r[o]),l.removedCount++,l.removedSize+=i[o],++o;while(a<f)l.addedIndexes.push(s[a]),l.addedCount++,l.addedSize+=c.selfSize(),c.nodeIndex=s[++a];return l.countDelta=l.addedCount-l.removedCount,l.sizeDelta=l.addedSize-l.removedSize,!l.addedCount&&!l.removedCount?null:l},_nodeForSnapshotObjectId:function(e){for(var t=this._allNodes();t.hasNext();t.next())if(t.node.id()===e)return t.node;return null},nodeClassName:function(e){var t=this._nodeForSnapshotObjectId(e);return t?t.className():null},dominatorIdsForNode:function(e){var t=this._nodeForSnapshotObjectId(e);if(!t)return null;var n=[];while(!t.isRoot())n.push(t.id()),t.nodeIndex=t.dominatorIndex();return n},_parseFilter:function(filter){if(!filter)return null;var parsedFilter=eval("(function(){return "+filter+"})()");return parsedFilter.bind(this)},createEdgesProvider:function(e,t){var n=this.createNode(e),r=this.containmentEdgesFilter(t);return new WebInspector.HeapSnapshotEdgesProvider(this,r,n.edges())},createEdgesProviderForTest:function(e,t){var n=this.createNode(e);return new WebInspector.HeapSnapshotEdgesProvider(this,t,n.edges())},retainingEdgesFilter:function(e){return null},containmentEdgesFilter:function(e){return null},createRetainingEdgesProvider:function(e,t){var n=this.createNode(e),r=this.retainingEdgesFilter(t);return new WebInspector.HeapSnapshotEdgesProvider(this,r,n.retainers())},createAddedNodesProvider:function(e,t){var n=this._snapshotDiffs[e],r=n[t];return new WebInspector.HeapSnapshotNodesProvider(this,null,r.addedIndexes)},createDeletedNodesProvider:function(e){return new WebInspector.HeapSnapshotNodesProvider(this,null,e)},classNodesFilter:function(){return null},createNodesProviderForClass:function(e,t){return new WebInspector.HeapSnapshotNodesProvider(this,this.classNodesFilter(),this.aggregates(!1,t)[e].idxs)},createNodesProviderForDominator:function(e){var t=this.createNode(e);return new WebInspector.HeapSnapshotNodesProvider(this,null,this._dominatedNodesOfNode(t))},updateStaticData:function(){return{nodeCount:this.nodeCount,rootNodeIndex:this._rootNodeIndex,totalSize:this.totalSize,uid:this.uid}}},WebInspector.HeapSnapshotFilteredOrderedIterator=function(e,t,n){this._filter=t,this._iterator=e,this._unfilteredIterationOrder=n,this._iterationOrder=null,this._position=0,this._currentComparator=null,this._sortedPrefixLength=0},WebInspector.HeapSnapshotFilteredOrderedIterator.prototype={_createIterationOrder:function(){if(this._iterationOrder)return;if(this._unfilteredIterationOrder&&!this._filter){this._iterationOrder=this._unfilteredIterationOrder.slice(0),this._unfilteredIterationOrder=null;return}this._iterationOrder=[];var e=this._iterator;if(!this._unfilteredIterationOrder&&!this._filter)for(e.rewind();e.hasNext();e.next())this._iterationOrder.push(e.index());else if(!this._unfilteredIterationOrder)for(e.rewind();e.hasNext();e.next())this._filter(e.item())&&this._iterationOrder.push(e.index());else{var t=this._unfilteredIterationOrder.constructor===Array?this._unfilteredIterationOrder:this._unfilteredIterationOrder.slice(0);for(var n=0,r=t.length;n<r;++n)e.setIndex(t[n]),this._filter(e.item())&&this._iterationOrder.push(e.index());this._unfilteredIterationOrder=null}},rewind:function(){this._position=0},hasNext:function(){return this._position<this._iterationOrder.length},isEmpty:function(){if(this._iterationOrder)return!this._iterationOrder.length;if(this._unfilteredIterationOrder&&!this._filter)return!this._unfilteredIterationOrder.length;var e=this._iterator;if(!this._unfilteredIterationOrder&&!this._filter)return e.rewind(),!e.hasNext();if(!this._unfilteredIterationOrder){for(e.rewind();e.hasNext();e.next())if(this._filter(e.item()))return!1}else{var t=this._unfilteredIterationOrder.constructor===Array?this._unfilteredIterationOrder:this._unfilteredIterationOrder.slice(0);for(var n=0,r=t.length;n<r;++n){e.setIndex(t[n]);if(this._filter(e.item()))return!1}}return!0},item:function(){return this._iterator.setIndex(this._iterationOrder[this._position]),this._iterator.item()},get length(){return this._createIterationOrder(),this._iterationOrder.length},next:function(){++this._position},serializeItemsRange:function(e,t){this._createIterationOrder();if(e>t)throw new Error("Start position > end position: "+e+" > "+t);t>=this._iterationOrder.length&&(t=this._iterationOrder.length),this._sortedPrefixLength<t&&(this.sort(this._currentComparator,this._sortedPrefixLength,this._iterationOrder.length-1,t-this._sortedPrefixLength),this._sortedPrefixLength=t),this._position=e;var n=this._position,r=t-e,i=new Array(r);for(var s=0;s<r&&this.hasNext();++s,this.next())i[s]=this.item().serialize();return i.length=s,i.totalLength=this._iterationOrder.length,i.startPosition=n,i.endPosition=this._position,i},sortAll:function(){this._createIterationOrder();if(this._sortedPrefixLength===this._iterationOrder.length)return;this.sort(this._currentComparator,this._sortedPrefixLength,this._iterationOrder.length-1,this._iterationOrder.length),this._sortedPrefixLength=this._iterationOrder.length},sortAndRewind:function(e){this._currentComparator=e,this._sortedPrefixLength=0,this.rewind()}},WebInspector.HeapSnapshotFilteredOrderedIterator.prototype.createComparator=function(e){return{fieldName1:e[0],ascending1:e[1],fieldName2:e[2],ascending2:e[3]}},WebInspector.HeapSnapshotEdgesProvider=function(e,t,n){this.snapshot=e,WebInspector.HeapSnapshotFilteredOrderedIterator.call(this,n,t)},WebInspector.HeapSnapshotEdgesProvider.prototype={sort:function(e,t,n,r){function h(e,t,n){a.edgeIndex=t,f.edgeIndex=n;if(f.name()==="__proto__")return-1;if(a.name()==="__proto__")return 1;var r=a.hasStringName()===f.hasStringName()?a.name()<f.name()?-1:a.name()>f.name()?1:0:a.hasStringName()?-1:1;return e?r:-r}function p(e,t,n,r){a.edgeIndex=n,l.nodeIndex=a.nodeIndex();var i=l[e]();f.edgeIndex=r,c.nodeIndex=f.nodeIndex();var s=c[e](),o=i<s?-1:i>s?1:0;return t?o:-o}function d(e,t){var n=h(o,e,t);return n===0&&(n=p(s,u,e,t)),n}function v(e,t){var n=p(i,o,e,t);return n===0&&(n=h(u,e,t)),n}function m(e,t){var n=p(i,o,e,t);return n===0&&(n=p(s,u,e,t)),n}var i=e.fieldName1,s=e.fieldName2,o=e.ascending1,u=e.ascending2,a=this._iterator.item().clone(),f=a.clone(),l=this.snapshot.createNode(),c=this.snapshot.createNode();i==="!edgeName"?this._iterationOrder.sortRange(d,t,n,r):s==="!edgeName"?this._iterationOrder.sortRange(v,t,n,r):this._iterationOrder.sortRange(m,t,n,r)},__proto__:WebInspector.HeapSnapshotFilteredOrderedIterator.prototype},WebInspector.HeapSnapshotNodesProvider=function(e,t,n){this.snapshot=e,WebInspector.HeapSnapshotFilteredOrderedIterator.call(this,e._allNodes(),t,n)},WebInspector.HeapSnapshotNodesProvider.prototype={nodePosition:function(e){this._createIterationOrder();if(this.isEmpty())return-1;this.sortAll();var t=this.snapshot.createNode();for(var n=0;n<this._iterationOrder.length;n++){t.nodeIndex=this._iterationOrder[n];if(t.id()===e)return n}return-1},sort:function(e,t,n,r){function l(e,t){var n=a[e],r=typeof n!="function"?n:n.call(a),i=f[e],s=typeof i!="function"?i:i.call(f),o=r<s?-1:r>s?1:0;return t?o:-o}function c(e,t){a.nodeIndex=e,f.nodeIndex=t;var n=l(i,o);return n===0&&(n=l(s,u)),n}var i=e.fieldName1,s=e.fieldName2,o=e.ascending1,u=e.ascending2,a=this.snapshot.createNode(),f=this.snapshot.createNode();this._iterationOrder.sortRange(c,t,n,r)},__proto__:WebInspector.HeapSnapshotFilteredOrderedIterator.prototype};