/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ResourceScriptMapping=function(e){this._workspace=e,this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAddedToWorkspace,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.GlobalObjectCleared,this._debuggerReset,this),this._initialize()},WebInspector.ResourceScriptMapping.prototype={rawLocationToUILocation:function(e){var t=e,n=WebInspector.debuggerModel.scriptForId(t.scriptId),r=this._workspaceUISourceCodeForScript(n);if(!r)return null;var i=r.scriptFile();return i&&(i.hasDivergedFromVM()&&!i.isMergingToVM()||i.isDivergingFromVM())?null:new WebInspector.UILocation(r,t.lineNumber,t.columnNumber||0)},uiLocationToRawLocation:function(e,t,n){var r=this._scriptsForUISourceCode(e);return console.assert(r.length),WebInspector.debuggerModel.createRawLocation(r[0],t,n)},isIdentity:function(){return!0},addScript:function(e){if(e.isAnonymousScript())return;e.pushSourceMapping(this);var t=e.isInlineScript()?this._inlineScriptsForSourceURL:this._nonInlineScriptsForSourceURL;t[e.sourceURL]=t[e.sourceURL]||[],t[e.sourceURL].push(e);var n=this._workspaceUISourceCodeForScript(e);if(!n)return;this._bindUISourceCodeToScripts(n,[e])},_uiSourceCodeAddedToWorkspace:function(e){var t=e.data;if(!t.url)return;var n=this._scriptsForUISourceCode(t);if(!n.length)return;this._bindUISourceCodeToScripts(t,n)},_hasMergedToVM:function(e){var t=this._scriptsForUISourceCode(e);if(!t.length)return;for(var n=0;n<t.length;++n)t[n].updateLocations()},_hasDivergedFromVM:function(e){var t=this._scriptsForUISourceCode(e);if(!t.length)return;for(var n=0;n<t.length;++n)t[n].updateLocations()},_workspaceUISourceCodeForScript:function(e){return e.isAnonymousScript()?null:this._workspace.uiSourceCodeForURL(e.sourceURL)},_scriptsForUISourceCode:function(e){var t;switch(e.contentType()){case WebInspector.resourceTypes.Document:t=!0;break;case WebInspector.resourceTypes.Script:t=!1;break;default:return[]}if(!e.url)return[];var n=t?this._inlineScriptsForSourceURL:this._nonInlineScriptsForSourceURL;return n[e.url]||[]},_bindUISourceCodeToScripts:function(e,t){console.assert(t.length);var n=new WebInspector.ResourceScriptFile(this,e,t);e.setScriptFile(n);for(var r=0;r<t.length;++r)t[r].updateLocations();e.setSourceMapping(this)},_unbindUISourceCodeFromScripts:function(e,t){console.assert(t.length);var n=e.scriptFile();n&&(n.dispose(),e.setScriptFile(null)),e.setSourceMapping(null)},_initialize:function(){this._inlineScriptsForSourceURL={},this._nonInlineScriptsForSourceURL={}},_debuggerReset:function(){function e(e){for(var t in e){var n=e[t];if(!n.length)continue;var r=this._workspaceUISourceCodeForScript(n[0]);if(!r)continue;this._unbindUISourceCodeFromScripts(r,n)}}e.call(this,this._inlineScriptsForSourceURL),e.call(this,this._nonInlineScriptsForSourceURL),this._initialize()}},WebInspector.ScriptFile=function(){},WebInspector.ScriptFile.Events={DidMergeToVM:"DidMergeToVM",DidDivergeFromVM:"DidDivergeFromVM"},WebInspector.ScriptFile.prototype={hasDivergedFromVM:function(){return!1},isDivergingFromVM:function(){return!1},isMergingToVM:function(){return!1},checkMapping:function(){}},WebInspector.ResourceScriptFile=function(e,t,n){console.assert(n.length),WebInspector.ScriptFile.call(this),this._resourceScriptMapping=e,this._uiSourceCode=t,this._uiSourceCode.contentType()===WebInspector.resourceTypes.Script&&(this._script=n[0]),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._update()},WebInspector.ResourceScriptFile.prototype={_workingCopyCommitted:function(e){function t(e,t){if(e){this._update(),WebInspector.LiveEditSupport.logDetailedError(e,t,this._script);return}this._scriptSource=n,this._update()}if(!this._script)return;var n=this._uiSourceCode.workingCopy();this._script.hasSourceURL&&!this._sourceEndsWithSourceURL(n)&&(n+="\n //# sourceURL="+this._script.sourceURL),WebInspector.debuggerModel.setScriptSource(this._script.scriptId,n,t.bind(this))},_isDiverged:function(){return this._uiSourceCode.formatted()?!1:this._uiSourceCode.isDirty()?!0:this._script?typeof this._scriptSource=="undefined"?!1:!this._sourceMatchesScriptSource(this._uiSourceCode.workingCopy(),this._scriptSource):!1},_sourceMatchesScriptSource:function(e,t){if(!t.startsWith(e))return!1;var n=t.substr(e.length).trim();return!n||!!n.match(/^\/\/[@#]\ssourceURL=\s*(\S*?)\s*$/m)},_sourceEndsWithSourceURL:function(e){return!!e.match(/\/\/[@#]\ssourceURL=\s*(\S*?)\s*$/m)},_workingCopyChanged:function(e){this._update()},_update:function(){this._isDiverged()&&!this._hasDivergedFromVM?this._divergeFromVM():!this._isDiverged()&&this._hasDivergedFromVM&&this._mergeToVM()},_divergeFromVM:function(){this._isDivergingFromVM=!0,this._resourceScriptMapping._hasDivergedFromVM(this._uiSourceCode),delete this._isDivergingFromVM,this._hasDivergedFromVM=!0,this.dispatchEventToListeners(WebInspector.ScriptFile.Events.DidDivergeFromVM,this._uiSourceCode)},_mergeToVM:function(){delete this._hasDivergedFromVM,this._isMergingToVM=!0,this._resourceScriptMapping._hasMergedToVM(this._uiSourceCode),delete this._isMergingToVM,this.dispatchEventToListeners(WebInspector.ScriptFile.Events.DidMergeToVM,this._uiSourceCode)},hasDivergedFromVM:function(){return this._hasDivergedFromVM},isDivergingFromVM:function(){return this._isDivergingFromVM},isMergingToVM:function(){return this._isMergingToVM},checkMapping:function(){function e(e,t,n){this._scriptSource=e,this._update()}if(!this._script)return;if(typeof this._scriptSource!="undefined")return;this._script.requestContent(e.bind(this))},dispose:function(){this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this)},__proto__:WebInspector.Object.prototype};