/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 * Copyright (C) 2012 Intel Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.TimelinePresentationModel=function(){this._linkifier=new WebInspector.Linkifier,this._glueRecords=!1,this._filters=[],this.reset()},WebInspector.TimelinePresentationModel.categories=function(){return WebInspector.TimelinePresentationModel._categories?WebInspector.TimelinePresentationModel._categories:(WebInspector.TimelinePresentationModel._categories={loading:new WebInspector.TimelineCategory("loading",WebInspector.UIString("Loading"),0,"#5A8BCC","#8EB6E9","#70A2E3"),scripting:new WebInspector.TimelineCategory("scripting",WebInspector.UIString("Scripting"),1,"#D8AA34","#F3D07A","#F1C453"),rendering:new WebInspector.TimelineCategory("rendering",WebInspector.UIString("Rendering"),2,"#8266CC","#AF9AEB","#9A7EE6"),painting:new WebInspector.TimelineCategory("painting",WebInspector.UIString("Painting"),2,"#5FA050","#8DC286","#71B363"),other:new WebInspector.TimelineCategory("other",WebInspector.UIString("Other"),-1,"#BBBBBB","#DDDDDD","#DDDDDD")},WebInspector.TimelinePresentationModel._categories)},WebInspector.TimelinePresentationModel._initRecordStyles=function(){if(WebInspector.TimelinePresentationModel._recordStylesMap)return WebInspector.TimelinePresentationModel._recordStylesMap;var e=WebInspector.TimelineModel.RecordType,t=WebInspector.TimelinePresentationModel.categories(),n={};return n[e.Root]={title:"#root",category:t.loading},n[e.Program]={title:WebInspector.UIString("Other"),category:t.other},n[e.EventDispatch]={title:WebInspector.UIString("Event"),category:t.scripting},n[e.BeginFrame]={title:WebInspector.UIString("Frame Start"),category:t.rendering},n[e.ScheduleStyleRecalculation]={title:WebInspector.UIString("Schedule Style Recalculation"),category:t.rendering},n[e.RecalculateStyles]={title:WebInspector.UIString("Recalculate Style"),category:t.rendering},n[e.InvalidateLayout]={title:WebInspector.UIString("Invalidate Layout"),category:t.rendering},n[e.Layout]={title:WebInspector.UIString("Layout"),category:t.rendering},n[e.PaintSetup]={title:WebInspector.UIString("Paint Setup"),category:t.painting},n[e.Paint]={title:WebInspector.UIString("Paint"),category:t.painting},n[e.Rasterize]={title:WebInspector.UIString("Rasterize"),category:t.painting},n[e.ScrollLayer]={title:WebInspector.UIString("Scroll"),category:t.rendering},n[e.DecodeImage]={title:WebInspector.UIString("Image Decode"),category:t.painting},n[e.ResizeImage]={title:WebInspector.UIString("Image Resize"),category:t.painting},n[e.CompositeLayers]={title:WebInspector.UIString("Composite Layers"),category:t.painting},n[e.ParseHTML]={title:WebInspector.UIString("Parse HTML"),category:t.loading},n[e.TimerInstall]={title:WebInspector.UIString("Install Timer"),category:t.scripting},n[e.TimerRemove]={title:WebInspector.UIString("Remove Timer"),category:t.scripting},n[e.TimerFire]={title:WebInspector.UIString("Timer Fired"),category:t.scripting},n[e.XHRReadyStateChange]={title:WebInspector.UIString("XHR Ready State Change"),category:t.scripting},n[e.XHRLoad]={title:WebInspector.UIString("XHR Load"),category:t.scripting},n[e.EvaluateScript]={title:WebInspector.UIString("Evaluate Script"),category:t.scripting},n[e.ResourceSendRequest]={title:WebInspector.UIString("Send Request"),category:t.loading},n[e.ResourceReceiveResponse]={title:WebInspector.UIString("Receive Response"),category:t.loading},n[e.ResourceFinish]={title:WebInspector.UIString("Finish Loading"),category:t.loading},n[e.FunctionCall]={title:WebInspector.UIString("Function Call"),category:t.scripting},n[e.ResourceReceivedData]={title:WebInspector.UIString("Receive Data"),category:t.loading},n[e.GCEvent]={title:WebInspector.UIString("GC Event"),category:t.scripting},n[e.MarkDOMContent]={title:WebInspector.UIString("DOMContentLoaded event"),category:t.scripting},n[e.MarkLoad]={title:WebInspector.UIString("Load event"),category:t.scripting},n[e.TimeStamp]={title:WebInspector.UIString("Stamp"),category:t.scripting},n[e.Time]={title:WebInspector.UIString("Time"),category:t.scripting},n[e.TimeEnd]={title:WebInspector.UIString("Time End"),category:t.scripting},n[e.ScheduleResourceRequest]={title:WebInspector.UIString("Schedule Request"),category:t.loading},n[e.RequestAnimationFrame]={title:WebInspector.UIString("Request Animation Frame"),category:t.scripting},n[e.CancelAnimationFrame]={title:WebInspector.UIString("Cancel Animation Frame"),category:t.scripting},n[e.FireAnimationFrame]={title:WebInspector.UIString("Animation Frame Fired"),category:t.scripting},n[e.WebSocketCreate]={title:WebInspector.UIString("Create WebSocket"),category:t.scripting},n[e.WebSocketSendHandshakeRequest]={title:WebInspector.UIString("Send WebSocket Handshake"),category:t.scripting},n[e.WebSocketReceiveHandshakeResponse]={title:WebInspector.UIString("Receive WebSocket Handshake"),category:t.scripting},n[e.WebSocketDestroy]={title:WebInspector.UIString("Destroy WebSocket"),category:t.scripting},WebInspector.TimelinePresentationModel._recordStylesMap=n,n},WebInspector.TimelinePresentationModel.recordStyle=function(e){var t=WebInspector.TimelinePresentationModel._initRecordStyles(),n=t[e.type];return n||(n={title:WebInspector.UIString("Unknown: %s",e.type),category:WebInspector.TimelinePresentationModel.categories().other},t[e.type]=n),n},WebInspector.TimelinePresentationModel.categoryForRecord=function(e){return WebInspector.TimelinePresentationModel.recordStyle(e).category},WebInspector.TimelinePresentationModel.isEventDivider=function(e){var t=WebInspector.TimelineModel.RecordType;if(e.type===t.TimeStamp)return!0;if(e.type===t.MarkDOMContent||e.type===t.MarkLoad)if(e.data&&typeof e.data.isMainFrame=="boolean")return e.data.isMainFrame;return!1},WebInspector.TimelinePresentationModel.forAllRecords=function(e,t,n){if(!e)return;var r=[{array:e,index:0}];while(r.length){var i=r[r.length-1],s=i.array;if(i.index<s.length){var o=s[i.index];if(t&&t(o))return;if(o.children)r.push({array:o.children,index:0,record:o});else if(n&&n(o))return;++i.index}else{if(i.record&&n&&n(i.record))return;r.pop()}}},WebInspector.TimelinePresentationModel.needsPreviewElement=function(e){if(!e)return!1;const t=WebInspector.TimelineModel.RecordType;switch(e){case t.ScheduleResourceRequest:case t.ResourceSendRequest:case t.ResourceReceiveResponse:case t.ResourceReceivedData:case t.ResourceFinish:return!0;default:return!1}},WebInspector.TimelinePresentationModel.createEventDivider=function(e,t){var n=document.createElement("div");n.className="resources-event-divider";var r=WebInspector.TimelineModel.RecordType;return e===r.MarkDOMContent?n.className+=" resources-blue-divider":e===r.MarkLoad?n.className+=" resources-red-divider":e===r.TimeStamp?n.className+=" resources-orange-divider":e===r.BeginFrame&&(n.className+=" timeline-frame-divider"),t&&(n.title=t),n},WebInspector.TimelinePresentationModel._hiddenRecords={},WebInspector.TimelinePresentationModel._hiddenRecords[WebInspector.TimelineModel.RecordType.MarkDOMContent]=1,WebInspector.TimelinePresentationModel._hiddenRecords[WebInspector.TimelineModel.RecordType.MarkLoad]=1,WebInspector.TimelinePresentationModel._hiddenRecords[WebInspector.TimelineModel.RecordType.ScheduleStyleRecalculation]=1,WebInspector.TimelinePresentationModel._hiddenRecords[WebInspector.TimelineModel.RecordType.InvalidateLayout]=1,WebInspector.TimelinePresentationModel.prototype={addFilter:function(e){this._filters.push(e)},setSearchFilter:function(e){this._searchFilter=e},rootRecord:function(){return this._rootRecord},frames:function(){return this._frames},reset:function(){this._linkifier.reset(),this._rootRecord=new WebInspector.TimelinePresentationModel.Record(this,{type:WebInspector.TimelineModel.RecordType.Root},null,null,null,!1),this._sendRequestRecords={},this._scheduledResourceRequests={},this._timerRecords={},this._requestAnimationFrameRecords={},this._eventDividerRecords=[],this._timeRecords={},this._timeRecordStack=[],this._frames=[],this._minimumRecordTime=-1,this._layoutInvalidateStack={},this._lastScheduleStyleRecalculation={},this._webSocketCreateRecords={},this._coalescingBuckets={}},addFrame:function(e){this._frames.push(e)},addRecord:function(e){if(this._minimumRecordTime===-1||e.startTime<this._minimumRecordTime)this._minimumRecordTime=WebInspector.TimelineModel.startTimeInSeconds(e);var t;e.type===WebInspector.TimelineModel.RecordType.Program?t=e.children:t=[e];var n=[],r=t.length;for(var i=0;i<r;++i)n.push(this._innerAddRecord(t[i],this._rootRecord));return n},_innerAddRecord:function(e,t){const n=WebInspector.TimelineModel.RecordType;var r=e.type in WebInspector.TimelinePresentationModel._hiddenRecords,i,s;if(!r){var o=this._findParentRecord(e);o&&(i=t,t=o),t===this._rootRecord&&(s=e.thread?e.type:"mainThread");var u=this._findCoalescedParent(e,t,s);u&&(i||(i=t),t=u)}var a=e.children,f;e.data&&e.data.scriptName&&(f={scriptName:e.data.scriptName,scriptLine:e.data.scriptLine});if((e.type===n.TimerFire||e.type===n.FireAnimationFrame)&&a&&a.length){var l=a[0];l.type===n.FunctionCall&&(f={scriptName:l.data.scriptName,scriptLine:l.data.scriptLine},a=l.children.concat(a.slice(1)))}var c=new WebInspector.TimelinePresentationModel.Record(this,e,t,i,f,r);WebInspector.TimelinePresentationModel.isEventDivider(c)&&this._eventDividerRecords.push(c);if(r)return c;c.collapsed=t===this._rootRecord,s&&(this._coalescingBuckets[s]=c);var h=a?a.length:0;for(var p=0;p<h;++p)this._innerAddRecord(a[p],c);return c.calculateAggregatedStats(),i&&this._updateAncestorStats(c),t.coalesced&&t.startTime>c.startTime&&(t._record.startTime=e.startTime),i=c.origin(),!i.isRoot()&&!i.coalesced&&(i.selfTime-=c.endTime-c.startTime),c},_updateAncestorStats:function(e){var t=e.lastChildEndTime,n=e.aggregatedStats;for(var r=e.parent;r&&!r.isRoot();r=r.parent){r._cpuTime+=e._cpuTime,r.lastChildEndTime<t&&(r.lastChildEndTime=t);for(var i in n)r.aggregatedStats[i]+=n[i]}},_findCoalescedParent:function(e,t,n){const r=.005;var i=n?this._coalescingBuckets[n]:t.children.peekLast();i&&i.coalesced&&(i=i.children.peekLast());var s=WebInspector.TimelineModel.startTimeInSeconds(e),o=WebInspector.TimelineModel.endTimeInSeconds(e);return i?i.type!==e.type?null:i.endTime+r<s?null:o+r<i.startTime?null:WebInspector.TimelinePresentationModel.coalescingKeyForRecord(e)!==WebInspector.TimelinePresentationModel.coalescingKeyForRecord(i._record)?null:i.parent.coalesced?i.parent:this._replaceWithCoalescedRecord(i):null},_replaceWithCoalescedRecord:function(e){var t={type:e._record.type,startTime:e._record.startTime,endTime:e._record.endTime,data:{}};e._record.thread&&(t.thread="aggregated"),e.type===WebInspector.TimelineModel.RecordType.TimeStamp&&(t.data.message=e.data.message);var n=new WebInspector.TimelinePresentationModel.Record(this,t,null,null,null,!1),r=e.parent;n.coalesced=!0,n.collapsed=!0,n._children.push(e),e.parent=n,n.calculateAggregatedStats();if(e.hasWarning||e.childHasWarning)n.childHasWarning=!0;return n.parent=r,r._children[r._children.indexOf(e)]=n,n},_findParentRecord:function(e){if(!this._glueRecords)return null;var t=WebInspector.TimelineModel.RecordType;switch(e.type){case t.ResourceReceiveResponse:case t.ResourceFinish:case t.ResourceReceivedData:return this._sendRequestRecords[e.data.requestId];case t.ResourceSendRequest:return this._rootRecord;case t.TimerFire:return this._timerRecords[e.data.timerId];case t.ResourceSendRequest:return this._scheduledResourceRequests[e.data.url];case t.FireAnimationFrame:return this._requestAnimationFrameRecords[e.data.id];case t.Time:return this._rootRecord;case t.TimeEnd:return this._timeRecords[e.data.message]}},setGlueRecords:function(e){this._glueRecords=e},invalidateFilteredRecords:function(){delete this._filteredRecords},filteredRecords:function(){function r(){for(var r=n+1;r<t.length;++r){if(t[r-1].parentIsCollapsed){t[r].parentRecord.parent._expandable=!0;return}t[r-1].parentRecord.collapsed=!1,e.push(t[r].parentRecord),t[r].windowLengthBeforeChildrenTraversal=e.length,t[r].parentIsRevealed=!0,n=r}}if(this._filteredRecords)return this._filteredRecords;var e=[],t=[{children:this._rootRecord.children,index:0,parentIsCollapsed:!1,parentRecord:{}}],n=0;while(t.length){var i=t[t.length-1],s=i.children;if(s&&i.index<s.length){var o=s[i.index];++i.index,this.isVisible(o)&&(o.parent._expandable=!0,this._searchFilter&&r(),i.parentIsCollapsed||(e.push(o),n=t.length,i.parentRecord.collapsed=!1)),o._expandable=!1,t.push({children:o.children,index:0,parentIsCollapsed:i.parentIsCollapsed||o.collapsed&&(!this._searchFilter||o.clicked),parentRecord:o,windowLengthBeforeChildrenTraversal:e.length})}else t.pop(),n=Math.min(n,t.length-1),i.parentRecord._visibleChildrenCount=e.length-i.windowLengthBeforeChildrenTraversal}return this._filteredRecords=e,e},filteredFrames:function(e,t){function n(e,t){return e-t.startTime}function r(e,t){return e-t.endTime}var i=insertionIndexForObjectInListSortedByFunction(e,this._frames,n),s=insertionIndexForObjectInListSortedByFunction(t,this._frames,r);while(s<this._frames.length&&this._frames[s].endTime<=t)++s;return this._frames.slice(i,s)},eventDividerRecords:function(){return this._eventDividerRecords},isVisible:function(e){for(var t=0;t<this._filters.length;++t)if(!this._filters[t].accept(e))return!1;return!this._searchFilter||this._searchFilter.accept(e)},generateMainThreadBarPopupContent:function(e){var t=e.firstTaskIndex,n=e.lastTaskIndex,r=e.tasks,i=n-t+1,s=0;for(var o=t;o<=n;++o){var u=r[o];s+=u.endTime-u.startTime}var a=r[t].startTime,f=r[n].endTime,l=f-a,c=this._minimumRecordTime,h=new WebInspector.PopoverContentHelper(WebInspector.UIString("CPU")),p=WebInspector.UIString("%s (at %s)",Number.secondsToString(l,!0),Number.secondsToString(a-c,!0));return h.appendTextRow(WebInspector.UIString("Duration"),p),h.appendTextRow(WebInspector.UIString("CPU time"),Number.secondsToString(s,!0)),h.appendTextRow(WebInspector.UIString("Message Count"),i),h.contentTable()},__proto__:WebInspector.Object.prototype},WebInspector.TimelinePresentationModel.Record=function(e,t,n,r,i,s){this._linkifier=e._linkifier,this._aggregatedStats={},this._record=t,this._children=[],!s&&n&&(this.parent=n,this.isBackground?WebInspector.TimelinePresentationModel.insertRetrospectiveRecord(n,this):n.children.push(this)),r&&(this._origin=r),this._selfTime=this.endTime-this.startTime,this._lastChildEndTime=this.endTime,this._startTimeOffset=this.startTime-e._minimumRecordTime,t.data&&(t.data.url&&(this.url=t.data.url),t.data.layerRootNode?this._relatedBackendNodeId=t.data.layerRootNode:t.data.elementId&&(this._relatedBackendNodeId=t.data.elementId)),i&&(this.scriptName=i.scriptName,this.scriptLine=i.scriptLine),n&&n.callSiteStackTrace&&(this.callSiteStackTrace=n.callSiteStackTrace);var o=WebInspector.TimelineModel.RecordType;switch(t.type){case o.ResourceSendRequest:e._sendRequestRecords[t.data.requestId]=this;break;case o.ScheduleResourceRequest:e._scheduledResourceRequests[t.data.url]=this;break;case o.ResourceReceiveResponse:var u=e._sendRequestRecords[t.data.requestId];u&&(this.url=u.url,u._refreshDetails(),u.parent!==e._rootRecord&&u.parent.type===o.ScheduleResourceRequest&&u.parent._refreshDetails());break;case o.ResourceReceivedData:case o.ResourceFinish:var u=e._sendRequestRecords[t.data.requestId];u&&(this.url=u.url);break;case o.TimerInstall:this.timeout=t.data.timeout,this.singleShot=t.data.singleShot,e._timerRecords[t.data.timerId]=this;break;case o.TimerFire:var a=e._timerRecords[t.data.timerId];a&&(this.callSiteStackTrace=a.stackTrace,this.timeout=a.timeout,this.singleShot=a.singleShot);break;case o.RequestAnimationFrame:e._requestAnimationFrameRecords[t.data.id]=this;break;case o.FireAnimationFrame:var f=e._requestAnimationFrameRecords[t.data.id];f&&(this.callSiteStackTrace=f.stackTrace);break;case o.Time:var l=t.data.message,c=e._timeRecords[l];if(c)break;e._timeRecords[l]=this,r&&e._timeRecordStack.push(this);break;case o.TimeEnd:var l=t.data.message,h=e._timeRecords[l];delete e._timeRecords[l];if(h){this.timeRecord=h,h.timeEndRecord=this;var p=this.startTime-h.startTime;this.intervalDuration=p,h.intervalDuration=p;if(!r)break;var d=e._timeRecordStack;d.splice(d.indexOf(h),1);for(var v=d.length;v;--v){var m=d[v-1];if(m.startTime>h.startTime)continue;WebInspector.TimelinePresentationModel.adoptRecord(m,h);break}}break;case o.ScheduleStyleRecalculation:e._lastScheduleStyleRecalculation[this.frameId]=this;break;case o.RecalculateStyles:var g=e._lastScheduleStyleRecalculation[this.frameId];if(!g)break;this.callSiteStackTrace=g.stackTrace;break;case o.InvalidateLayout:var y;if(!e._layoutInvalidateStack[this.frameId])for(var b=n;b;b=t.parent)if(b.type===o.RecalculateStyles){y=b.callSiteStackTrace;break}e._layoutInvalidateStack[this.frameId]=y||this.stackTrace;break;case o.Layout:var w=e._layoutInvalidateStack[this.frameId];w&&(this.callSiteStackTrace=w),this.stackTrace&&this.setHasWarning(),e._layoutInvalidateStack[this.frameId]=null,this.highlightQuad=t.data.root||WebInspector.TimelinePresentationModel.quadFromRectData(t.data),this._relatedBackendNodeId=t.data.rootNode;break;case o.Paint:this.highlightQuad=t.data.clip||WebInspector.TimelinePresentationModel.quadFromRectData(t.data);break;case o.WebSocketCreate:this.webSocketURL=t.data.url,typeof t.data["webSocketProtocol"]!="undefined"&&(this.webSocketProtocol=t.data.webSocketProtocol),e._webSocketCreateRecords[t.data.identifier]=this;break;case o.WebSocketSendHandshakeRequest:case o.WebSocketReceiveHandshakeResponse:case o.WebSocketDestroy:var E=e._webSocketCreateRecords[t.data.identifier];E&&(this.webSocketURL=E.webSocketURL,typeof E.webSocketProtocol!="undefined"&&(this.webSocketProtocol=E.webSocketProtocol))}},WebInspector.TimelinePresentationModel.adoptRecord=function(e,t){t.parent.children.splice(t.parent.children.indexOf(t)),WebInspector.TimelinePresentationModel.insertRetrospectiveRecord(e,t),t.parent=e},WebInspector.TimelinePresentationModel.insertRetrospectiveRecord=function(e,t){function n(e,t){return e<t.startTime?-1:1}e.children.splice(insertionIndexForObjectInListSortedByFunction(t.startTime,e.children,n),0,t)},WebInspector.TimelinePresentationModel.Record.prototype={get lastChildEndTime(){return this._lastChildEndTime},set lastChildEndTime(e){this._lastChildEndTime=e},get selfTime(){return this.coalesced?this._lastChildEndTime-this.startTime:this._selfTime},set selfTime(e){this._selfTime=e},get cpuTime(){return this._cpuTime},isRoot:function(){return this.type===WebInspector.TimelineModel.RecordType.Root},origin:function(){return this._origin||this.parent},get children(){return this._children},get visibleChildrenCount(){return this._visibleChildrenCount||0},get expandable(){return!!this._expandable},get category(){return WebInspector.TimelinePresentationModel.recordStyle(this._record).category},get title(){return this.type===WebInspector.TimelineModel.RecordType.TimeStamp?this._record.data.message:WebInspector.TimelinePresentationModel.recordStyle(this._record).title},get startTime(){return WebInspector.TimelineModel.startTimeInSeconds(this._record)},get endTime(){return WebInspector.TimelineModel.endTimeInSeconds(this._record)},get isBackground(){return!!this._record.thread},get data(){return this._record.data},get type(){return this._record.type},get frameId(){return this._record.frameId},get usedHeapSizeDelta(){return this._record.usedHeapSizeDelta||0},get usedHeapSize(){return this._record.usedHeapSize},get stackTrace(){return this._record.stackTrace&&this._record.stackTrace.length?this._record.stackTrace:null},containsTime:function(e){return this.startTime<=e&&e<=this.endTime},generatePopupContent:function(e){function n(){e(this._generatePopupContentSynchronously())}var t=new CallbackBarrier;WebInspector.TimelinePresentationModel.needsPreviewElement(this.type)&&!this._imagePreviewElement&&WebInspector.DOMPresentationUtils.buildImagePreviewContents(this.url,!1,t.createCallback(this._setImagePreviewElement.bind(this))),this._relatedBackendNodeId&&!this._relatedNode&&WebInspector.domAgent.pushNodeByBackendIdToFrontend(this._relatedBackendNodeId,t.createCallback(this._setRelatedNode.bind(this))),t.callWhenDone(n.bind(this))},_setImagePreviewElement:function(e){this._imagePreviewElement=e},_setRelatedNode:function(e){typeof e=="number"&&(this._relatedNode=WebInspector.domAgent.nodeForId(e))},_generatePopupContentSynchronously:function(){var e=new WebInspector.PopoverContentHelper(this.title),t=WebInspector.UIString("%s (at %s)",Number.secondsToString(this._lastChildEndTime-this.startTime,!0),Number.secondsToString(this._startTimeOffset));e.appendTextRow(WebInspector.UIString("Duration"),t),this._children.length&&(this.coalesced||e.appendTextRow(WebInspector.UIString("Self Time"),Number.secondsToString(this._selfTime,!0)),e.appendTextRow(WebInspector.UIString("CPU Time"),Number.secondsToString(this._cpuTime,!0)),e.appendElementRow(WebInspector.UIString("Aggregated Time"),WebInspector.TimelinePresentationModel._generateAggregatedInfo(this._aggregatedStats)));if(this.coalesced)return e.contentTable();const n=WebInspector.TimelineModel.RecordType;var r,i;switch(this.type){case n.GCEvent:e.appendTextRow(WebInspector.UIString("Collected"),Number.bytesToString(this.data.usedHeapSizeDelta));break;case n.TimerFire:r=WebInspector.UIString("Timer installed");case n.TimerInstall:case n.TimerRemove:e.appendTextRow(WebInspector.UIString("Timer ID"),this.data.timerId),typeof this.timeout=="number"&&(e.appendTextRow(WebInspector.UIString("Timeout"),Number.secondsToString(this.timeout/1e3)),e.appendTextRow(WebInspector.UIString("Repeats"),!this.singleShot));break;case n.FireAnimationFrame:r=WebInspector.UIString("Animation frame requested"),e.appendTextRow(WebInspector.UIString("Callback ID"),this.data.id);break;case n.FunctionCall:e.appendElementRow(WebInspector.UIString("Location"),this._linkifyScriptLocation());break;case n.ScheduleResourceRequest:case n.ResourceSendRequest:case n.ResourceReceiveResponse:case n.ResourceReceivedData:case n.ResourceFinish:e.appendElementRow(WebInspector.UIString("Resource"),WebInspector.linkifyResourceAsNode(this.url)),this._imagePreviewElement&&e.appendElementRow(WebInspector.UIString("Preview"),this._imagePreviewElement),this.data.requestMethod&&e.appendTextRow(WebInspector.UIString("Request Method"),this.data.requestMethod),typeof this.data["statusCode"]=="number"&&e.appendTextRow(WebInspector.UIString("Status Code"),this.data.statusCode),this.data.mimeType&&e.appendTextRow(WebInspector.UIString("MIME Type"),this.data.mimeType),this.data.encodedDataLength&&e.appendTextRow(WebInspector.UIString("Encoded Data Length"),WebInspector.UIString("%d Bytes",this.data.encodedDataLength));break;case n.EvaluateScript:this.data&&this.url&&e.appendElementRow(WebInspector.UIString("Script"),this._linkifyLocation(this.url,this.data.lineNumber));break;case n.Paint:var s=this.data.clip;if(s){e.appendTextRow(WebInspector.UIString("Location"),WebInspector.UIString("(%d, %d)",s[0],s[1]));var o=WebInspector.TimelinePresentationModel.quadWidth(s),u=WebInspector.TimelinePresentationModel.quadHeight(s);e.appendTextRow(WebInspector.UIString("Dimensions"),WebInspector.UIString("%d × %d",o,u))}else typeof this.data.x!="undefined"&&typeof this.data.y!="undefined"&&e.appendTextRow(WebInspector.UIString("Location"),WebInspector.UIString("(%d, %d)",this.data.x,this.data.y)),typeof this.data.width!="undefined"&&typeof this.data.height!="undefined"&&e.appendTextRow(WebInspector.UIString("Dimensions"),WebInspector.UIString("%d × %d",this.data.width,this.data.height));case n.PaintSetup:case n.Rasterize:case n.ScrollLayer:this._relatedNode&&e.appendElementRow(WebInspector.UIString("Layer root"),this._createNodeAnchor(this._relatedNode));break;case n.DecodeImage:case n.ResizeImage:this._relatedNode&&e.appendElementRow(WebInspector.UIString("Image element"),this._createNodeAnchor(this._relatedNode)),this.url&&e.appendElementRow(WebInspector.UIString("Image URL"),WebInspector.linkifyResourceAsNode(this.url));break;case n.RecalculateStyles:this.data.elementCount&&e.appendTextRow(WebInspector.UIString("Elements affected"),this.data.elementCount),i=WebInspector.UIString("Styles recalculation forced");break;case n.Layout:this.data.dirtyObjects&&e.appendTextRow(WebInspector.UIString("Nodes that need layout"),this.data.dirtyObjects),this.data.totalObjects&&e.appendTextRow(WebInspector.UIString("Layout tree size"),this.data.totalObjects),typeof this.data["partialLayout"]=="boolean"&&e.appendTextRow(WebInspector.UIString("Layout scope"),this.data.partialLayout?WebInspector.UIString("Partial"):WebInspector.UIString("Whole document")),r=WebInspector.UIString("Layout invalidated"),this.stackTrace&&(i=WebInspector.UIString("Layout forced"),e.appendTextRow(WebInspector.UIString("Note"),WebInspector.UIString("Forced synchronous layout is a possible performance bottleneck."))),this._relatedNode&&e.appendElementRow(WebInspector.UIString("Layout root"),this._createNodeAnchor(this._relatedNode));break;case n.Time:case n.TimeEnd:e.appendTextRow(WebInspector.UIString("Message"),this.data.message),typeof this.intervalDuration=="number"&&e.appendTextRow(WebInspector.UIString("Interval Duration"),Number.secondsToString(this.intervalDuration,!0));break;case n.WebSocketCreate:case n.WebSocketSendHandshakeRequest:case n.WebSocketReceiveHandshakeResponse:case n.WebSocketDestroy:typeof this.webSocketURL!="undefined"&&e.appendTextRow(WebInspector.UIString("URL"),this.webSocketURL),typeof this.webSocketProtocol!="undefined"&&e.appendTextRow(WebInspector.UIString("WebSocket Protocol"),this.webSocketProtocol),typeof this.data["message"]!="undefined"&&e.appendTextRow(WebInspector.UIString("Message"),this.data.message);break;default:this.detailsNode()&&e.appendElementRow(WebInspector.UIString("Details"),this.detailsNode().childNodes[1].cloneNode())}this.scriptName&&this.type!==n.FunctionCall&&e.appendElementRow(WebInspector.UIString("Function Call"),this._linkifyScriptLocation());if(this.usedHeapSize)if(this.usedHeapSizeDelta){var a=this.usedHeapSizeDelta>0?"+":"-";e.appendTextRow(WebInspector.UIString("Used Heap Size"),WebInspector.UIString("%s (%s%s)",Number.bytesToString(this.usedHeapSize),a,Number.bytesToString(Math.abs(this.usedHeapSizeDelta))))}else this.category===WebInspector.TimelinePresentationModel.categories().scripting&&e.appendTextRow(WebInspector.UIString("Used Heap Size"),Number.bytesToString(this.usedHeapSize));return this.callSiteStackTrace&&e.appendStackTrace(r||WebInspector.UIString("Call Site stack"),this.callSiteStackTrace,this._linkifyCallFrame.bind(this)),this.stackTrace&&e.appendStackTrace(i||WebInspector.UIString("Call Stack"),this.stackTrace,this._linkifyCallFrame.bind(this)),e.contentTable()},_createNodeAnchor:function(e){function n(){WebInspector.showPanel("elements").revealAndSelectNode(e.id)}var t=document.createElement("span");return t.classList.add("node-link"),t.addEventListener("click",n,!1),WebInspector.DOMPresentationUtils.decorateNodeLabel(e,t),t},_refreshDetails:function(){delete this._detailsNode},detailsNode:function(){return typeof this._detailsNode=="undefined"&&(this._detailsNode=this._getRecordDetails(),this._detailsNode&&!this.coalesced&&(this._detailsNode.insertBefore(document.createTextNode("("),this._detailsNode.firstChild),this._detailsNode.appendChild(document.createTextNode(")")))),this._detailsNode},_createSpanWithText:function(e){var t=document.createElement("span");return t.textContent=e,t},_getRecordDetails:function(){var e;if(this.coalesced)return this._createSpanWithText(WebInspector.UIString("× %d",this.children.length));switch(this.type){case WebInspector.TimelineModel.RecordType.GCEvent:e=WebInspector.UIString("%s collected",Number.bytesToString(this.data.usedHeapSizeDelta));break;case WebInspector.TimelineModel.RecordType.TimerFire:e=this._linkifyScriptLocation(this.data.timerId);break;case WebInspector.TimelineModel.RecordType.FunctionCall:e=this._linkifyScriptLocation();break;case WebInspector.TimelineModel.RecordType.FireAnimationFrame:e=this._linkifyScriptLocation(this.data.id);break;case WebInspector.TimelineModel.RecordType.EventDispatch:e=this.data?this.data.type:null;break;case WebInspector.TimelineModel.RecordType.Paint:var t=this.data.clip?WebInspector.TimelinePresentationModel.quadWidth(this.data.clip):this.data.width,n=this.data.clip?WebInspector.TimelinePresentationModel.quadHeight(this.data.clip):this.data.height;t&&n&&(e=WebInspector.UIString("%d × %d",t,n));break;case WebInspector.TimelineModel.RecordType.TimerInstall:case WebInspector.TimelineModel.RecordType.TimerRemove:e=this._linkifyTopCallFrame(this.data.timerId);break;case WebInspector.TimelineModel.RecordType.RequestAnimationFrame:case WebInspector.TimelineModel.RecordType.CancelAnimationFrame:e=this._linkifyTopCallFrame(this.data.id);break;case WebInspector.TimelineModel.RecordType.ParseHTML:case WebInspector.TimelineModel.RecordType.RecalculateStyles:e=this._linkifyTopCallFrame();break;case WebInspector.TimelineModel.RecordType.EvaluateScript:e=this.url?this._linkifyLocation(this.url,this.data.lineNumber,0):null;break;case WebInspector.TimelineModel.RecordType.XHRReadyStateChange:case WebInspector.TimelineModel.RecordType.XHRLoad:case WebInspector.TimelineModel.RecordType.ScheduleResourceRequest:case WebInspector.TimelineModel.RecordType.ResourceSendRequest:case WebInspector.TimelineModel.RecordType.ResourceReceivedData:case WebInspector.TimelineModel.RecordType.ResourceReceiveResponse:case WebInspector.TimelineModel.RecordType.ResourceFinish:case WebInspector.TimelineModel.RecordType.DecodeImage:case WebInspector.TimelineModel.RecordType.ResizeImage:e=WebInspector.displayNameForURL(this.url);break;case WebInspector.TimelineModel.RecordType.Time:case WebInspector.TimelineModel.RecordType.TimeEnd:e=this.data.message;break;default:e=this._linkifyScriptLocation()||this._linkifyTopCallFrame()||null}if(e){if(!(e instanceof Node))return this._createSpanWithText(""+e);e.tabIndex=-1}return e||null},_linkifyLocation:function(e,t,n){return n=n?n-1:0,this._linkifier.linkifyLocation(e,t-1,n,"timeline-details")},_linkifyCallFrame:function(e){return this._linkifyLocation(e.url,e.lineNumber,e.columnNumber)},_linkifyTopCallFrame:function(e){return this.stackTrace?this._linkifyCallFrame(this.stackTrace[0]):this.callSiteStackTrace?this._linkifyCallFrame(this.callSiteStackTrace[0]):e},_linkifyScriptLocation:function(e){return this.scriptName?this._linkifyLocation(this.scriptName,this.scriptLine,0):e?""+e:null},calculateAggregatedStats:function(){this._aggregatedStats={},this._cpuTime=this._selfTime;for(var e=this._children.length;e;--e){var t=this._children[e-1];for(var n in t._aggregatedStats)this._aggregatedStats[n]=(this._aggregatedStats[n]||0)+t._aggregatedStats[n]}for(var n in this._aggregatedStats)this._cpuTime+=this._aggregatedStats[n];this._aggregatedStats[this.category.name]=(this._aggregatedStats[this.category.name]||0)+this._selfTime},get aggregatedStats(){return this._aggregatedStats},setHasWarning:function(){this.hasWarning=!0;for(var e=this.parent;e&&!e.childHasWarning;e=e.parent)e.childHasWarning=!0}},WebInspector.TimelinePresentationModel._generateAggregatedInfo=function(e){var t=document.createElement("span");t.className="timeline-aggregated-info";for(var n in e){var r=document.createElement("div");r.className="timeline-aggregated-category timeline-"+n,t.appendChild(r);var i=document.createElement("span");i.textContent=Number.secondsToString(e[n],!0),t.appendChild(i)}return t},WebInspector.TimelinePresentationModel.generatePopupContentForFrame=function(e){var t=new WebInspector.PopoverContentHelper(WebInspector.UIString("Frame")),n=e.endTime-e.startTime,r=WebInspector.UIString("%s (at %s)",Number.secondsToString(e.endTime-e.startTime,!0),Number.secondsToString(e.startTimeOffset,!0));return t.appendTextRow(WebInspector.UIString("Duration"),r),t.appendTextRow(WebInspector.UIString("FPS"),Math.floor(1/n)),t.appendTextRow(WebInspector.UIString("CPU time"),Number.secondsToString(e.cpuTime,!0)),t.appendElementRow(WebInspector.UIString("Aggregated Time"),WebInspector.TimelinePresentationModel._generateAggregatedInfo(e.timeByCategory)),t.contentTable()},WebInspector.TimelinePresentationModel.generatePopupContentForFrameStatistics=function(e){function t(e){return WebInspector.UIString("%s (%.0f FPS)",Number.secondsToString(e,!0),1/e)}var n=new WebInspector.PopoverContentHelper(WebInspector.UIString("Selected Range"));return n.appendTextRow(WebInspector.UIString("Selected range"),WebInspector.UIString("%s–%s (%d frames)",Number.secondsToString(e.startOffset,!0),Number.secondsToString(e.endOffset,!0),e.frameCount)),n.appendTextRow(WebInspector.UIString("Minimum Time"),t(e.minDuration)),n.appendTextRow(WebInspector.UIString("Average Time"),t(e.average)),n.appendTextRow(WebInspector.UIString("Maximum Time"),t(e.maxDuration)),n.appendTextRow(WebInspector.UIString("Standard Deviation"),Number.secondsToString(e.stddev,!0)),n.appendElementRow(WebInspector.UIString("Time by category"),WebInspector.TimelinePresentationModel._generateAggregatedInfo(e.timeByCategory)),n.contentTable()},WebInspector.TimelinePresentationModel.createFillStyle=function(e,t,n,r,i,s){var o=e.createLinearGradient(0,0,t,n);return o.addColorStop(0,r),o.addColorStop(.25,i),o.addColorStop(.75,i),o.addColorStop(1,s),o},WebInspector.TimelinePresentationModel.createFillStyleForCategory=function(e,t,n,r){return WebInspector.TimelinePresentationModel.createFillStyle(e,t,n,r.fillColorStop0,r.fillColorStop1,r.borderColor)},WebInspector.TimelinePresentationModel.createStyleRuleForCategory=function(e){var t=".timeline-category-"+e.name+" .timeline-graph-bar, "+".timeline-category-statusbar-item.timeline-category-"+e.name+" .timeline-category-checkbox, "+".popover .timeline-"+e.name+", "+".timeline-category-"+e.name+" .timeline-tree-icon";return t+" { background-image: -webkit-linear-gradient("+e.fillColorStop0+", "+e.fillColorStop1+" 25%, "+e.fillColorStop1+" 25%, "+e.fillColorStop1+");"+" border-color: "+e.borderColor+"}"},WebInspector.TimelinePresentationModel.coalescingKeyForRecord=function(e){var t=WebInspector.TimelineModel.RecordType;switch(e.type){case t.EventDispatch:return e.data.type;case t.TimeStamp:return e.data.message;default:return null}},WebInspector.TimelinePresentationModel.quadWidth=function(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[2],2)+Math.pow(e[1]-e[3],2)))},WebInspector.TimelinePresentationModel.quadHeight=function(e){return Math.round(Math.sqrt(Math.pow(e[0]-e[6],2)+Math.pow(e[1]-e[7],2)))},WebInspector.TimelinePresentationModel.quadFromRectData=function(e){if(typeof e.x=="undefined"||typeof e.y=="undefined")return null;var t=e.x,n=e.x+e.width,r=e.y,i=e.y+e.height;return[t,r,n,r,n,i,t,i]},WebInspector.TimelinePresentationModel.Filter=function(){},WebInspector.TimelinePresentationModel.Filter.prototype={accept:function(e){return!1}},WebInspector.TimelineCategory=function(e,t,n,r,i,s){this.name=e,this.title=t,this.overviewStripGroupIndex=n,this.borderColor=r,this.fillColorStop0=i,this.fillColorStop1=s,this.hidden=!1},WebInspector.TimelineCategory.Events={VisibilityChanged:"VisibilityChanged"},WebInspector.TimelineCategory.prototype={get hidden(){return this._hidden},set hidden(e){this._hidden=e,this.dispatchEventToListeners(WebInspector.TimelineCategory.Events.VisibilityChanged,this)},__proto__:WebInspector.Object.prototype};