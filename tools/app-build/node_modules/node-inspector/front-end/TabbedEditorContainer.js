/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * 1. Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY GOOGLE INC. AND ITS CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL GOOGLE INC.
 * OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.TabbedEditorContainerDelegate=function(){},WebInspector.TabbedEditorContainerDelegate.prototype={viewForFile:function(e){}},WebInspector.TabbedEditorContainer=function(e,t,n){WebInspector.Object.call(this),this._delegate=e,this._tabbedPane=new WebInspector.TabbedPane,this._tabbedPane.setPlaceholderText(n),this._tabbedPane.setTabDelegate(new WebInspector.EditorContainerTabDelegate(this)),this._tabbedPane.closeableTabs=!0,this._tabbedPane.element.id="scripts-editor-container-tabbed-pane",this._tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabClosed,this._tabClosed,this),this._tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabSelected,this._tabSelected,this),this._tabIds=new Map,this._files={},this._previouslyViewedFilesSetting=WebInspector.settings.createSetting(t,[]),this._history=WebInspector.TabbedEditorContainer.History.fromObject(this._previouslyViewedFilesSetting.get())},WebInspector.TabbedEditorContainer.Events={EditorSelected:"EditorSelected",EditorClosed:"EditorClosed"},WebInspector.TabbedEditorContainer._tabId=0,WebInspector.TabbedEditorContainer.maximalPreviouslyViewedFilesCount=30,WebInspector.TabbedEditorContainer.prototype={get view(){return this._tabbedPane},get visibleView(){return this._tabbedPane.visibleView},show:function(e){this._tabbedPane.show(e)},showFile:function(e){this._innerShowFile(e,!0)},historyUISourceCodes:function(){var e={};for(var t in this._files){var n=this._files[t];e[n.uri()]=n}var r=[],i=this._history._urls();for(var s=0;s<i.length;++s){var n=e[i[s]];n&&r.push(n)}return r},_addScrollAndSelectionListeners:function(){if(!this._currentView)return;this._currentView.addEventListener(WebInspector.SourceFrame.Events.ScrollChanged,this._scrollChanged,this),this._currentView.addEventListener(WebInspector.SourceFrame.Events.SelectionChanged,this._selectionChanged,this)},_removeScrollAndSelectionListeners:function(){if(!this._currentView)return;this._currentView.removeEventListener(WebInspector.SourceFrame.Events.ScrollChanged,this._scrollChanged,this),this._currentView.removeEventListener(WebInspector.SourceFrame.Events.SelectionChanged,this._selectionChanged,this)},_scrollChanged:function(e){var t=e.data;this._history.updateScrollLineNumber(this._currentFile.uri(),t),this._history.save(this._previouslyViewedFilesSetting)},_selectionChanged:function(e){var t=e.data;this._history.updateSelectionRange(this._currentFile.uri(),t),this._history.save(this._previouslyViewedFilesSetting)},_innerShowFile:function(e,t){if(this._currentFile===e)return;this._removeScrollAndSelectionListeners(),this._currentFile=e;var n=this._tabIds.get(e)||this._appendFileTab(e,t);this._tabbedPane.selectTab(n,t),t&&this._editorSelectedByUserAction(),this._currentView=this.visibleView,this._addScrollAndSelectionListeners(),this.dispatchEventToListeners(WebInspector.TabbedEditorContainer.Events.EditorSelected,this._currentFile)},_titleForFile:function(e){var t=30,n=e.displayName(!0).trimMiddle(t);if(e.isDirty()||e.hasUnsavedCommittedChanges())n+="*";return n},_maybeCloseTab:function(e,t){var n=this._files[e],r=n.isDirty()&&n.project().canSetFileContent();return!r||confirm(WebInspector.UIString("Are you sure you want to close unsaved file: %s?",n.name()))?(n.resetWorkingCopy(),t&&this._tabbedPane.selectTab(t,!0),this._tabbedPane.closeTab(e,!0),!0):!1},_closeTabs:function(e){var t=[],n=[];for(var r=0;r<e.length;++r){var i=e[r],s=this._files[i];s.isDirty()?t.push(i):n.push(i)}t.length&&this._tabbedPane.selectTab(t[0],!0),this._tabbedPane.closeTabs(n,!0);for(var r=0;r<t.length;++r){var o=r+1<t.length?t[r+1]:null;if(!this._maybeCloseTab(t[r],o))break}},addUISourceCode:function(e){var t=e.uri();if(this._userSelectedFiles)return;var n=this._history.index(t);if(n===-1)return;var r=this._tabIds.get(e)||this._appendFileTab(e,!1);if(!this._currentFile)return;if(!n){this._innerShowFile(e,!1);return}var i=this._currentFile.project().type(),s=e.project().type(),o=WebInspector.projectTypes.Snippets;this._history.index(this._currentFile.uri())&&i===o&&s!==o&&this._innerShowFile(e,!1)},removeUISourceCode:function(e){this.removeUISourceCodes([e])},removeUISourceCodes:function(e){var t=[];for(var n=0;n<e.length;++n){var r=e[n],i=this._tabIds.get(r);i&&t.push(i)}this._tabbedPane.closeTabs(t)},_editorClosedByUserAction:function(e){this._userSelectedFiles=!0,this._history.remove(e.uri()),this._updateHistory()},_editorSelectedByUserAction:function(){this._userSelectedFiles=!0,this._updateHistory()},_updateHistory:function(){function t(e){return this._files[e].uri()}var e=this._tabbedPane.lastOpenedTabIds(WebInspector.TabbedEditorContainer.maximalPreviouslyViewedFilesCount);this._history.update(e.map(t.bind(this))),this._history.save(this._previouslyViewedFilesSetting)},_tooltipForFile:function(e){return e.originURL()},_appendFileTab:function(e,t){var n=this._delegate.viewForFile(e),r=this._titleForFile(e),i=this._tooltipForFile(e),s=this._generateTabId();this._tabIds.put(e,s),this._files[s]=e;var o=this._history.selectionRange(e.uri());o&&n.setSelection(o);var u=this._history.scrollLineNumber(e.uri());return u&&n.scrollToLine(u),this._tabbedPane.appendTab(s,r,n,i,t),this._updateFileTitle(e),this._addUISourceCodeListeners(e),s},_tabClosed:function(e){var t=e.data.tabId,n=e.data.isUserGesture,r=this._files[t];this._currentFile===r&&(this._removeScrollAndSelectionListeners(),delete this._currentView,delete this._currentFile),this._tabIds.remove(r),delete this._files[t],this._removeUISourceCodeListeners(r),this.dispatchEventToListeners(WebInspector.TabbedEditorContainer.Events.EditorClosed,r),n&&this._editorClosedByUserAction(r)},_tabSelected:function(e){var t=e.data.tabId,n=e.data.isUserGesture,r=this._files[t];this._innerShowFile(r,n)},_addUISourceCodeListeners:function(e){e.addEventListener(WebInspector.UISourceCode.Events.TitleChanged,this._uiSourceCodeTitleChanged,this),e.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._uiSourceCodeWorkingCopyChanged,this),e.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._uiSourceCodeWorkingCopyCommitted,this),e.addEventListener(WebInspector.UISourceCode.Events.SavedStateUpdated,this._uiSourceCodeSavedStateUpdated,this),e.addEventListener(WebInspector.UISourceCode.Events.FormattedChanged,this._uiSourceCodeFormattedChanged,this)},_removeUISourceCodeListeners:function(e){e.removeEventListener(WebInspector.UISourceCode.Events.TitleChanged,this._uiSourceCodeTitleChanged,this),e.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._uiSourceCodeWorkingCopyChanged,this),e.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._uiSourceCodeWorkingCopyCommitted,this),e.removeEventListener(WebInspector.UISourceCode.Events.SavedStateUpdated,this._uiSourceCodeSavedStateUpdated,this),e.removeEventListener(WebInspector.UISourceCode.Events.FormattedChanged,this._uiSourceCodeFormattedChanged,this)},_updateFileTitle:function(e){var t=this._tabIds.get(e);if(t){var n=this._titleForFile(e);this._tabbedPane.changeTabTitle(t,n),e.hasUnsavedCommittedChanges()?this._tabbedPane.setTabIcon(t,"editor-container-unsaved-committed-changes-icon",WebInspector.UIString("Changes to this file were not saved to file system.")):this._tabbedPane.setTabIcon(t,"")}},_uiSourceCodeTitleChanged:function(e){var t=e.target;this._updateFileTitle(t),this._updateHistory()},_uiSourceCodeWorkingCopyChanged:function(e){var t=e.target;this._updateFileTitle(t)},_uiSourceCodeWorkingCopyCommitted:function(e){var t=e.target;this._updateFileTitle(t)},_uiSourceCodeSavedStateUpdated:function(e){var t=e.target;this._updateFileTitle(t)},_uiSourceCodeFormattedChanged:function(e){var t=e.target;this._updateFileTitle(t)},reset:function(){delete this._userSelectedFiles},_generateTabId:function(){return"tab_"+WebInspector.TabbedEditorContainer._tabId++},currentFile:function(){return this._currentFile},__proto__:WebInspector.Object.prototype},WebInspector.TabbedEditorContainer.HistoryItem=function(e,t,n){this.url=e,this._isSerializable=e.length<WebInspector.TabbedEditorContainer.HistoryItem.serializableUrlLengthLimit,this.selectionRange=t,this.scrollLineNumber=n},WebInspector.TabbedEditorContainer.HistoryItem.serializableUrlLengthLimit=4096,WebInspector.TabbedEditorContainer.HistoryItem.fromObject=function(e){var t=e.selectionRange?WebInspector.TextRange.fromObject(e.selectionRange):null;return new WebInspector.TabbedEditorContainer.HistoryItem(e.url,t,e.scrollLineNumber)},WebInspector.TabbedEditorContainer.HistoryItem.prototype={serializeToObject:function(){if(!this._isSerializable)return null;var e={};return e.url=this.url,e.selectionRange=this.selectionRange,e.scrollLineNumber=this.scrollLineNumber,e},__proto__:WebInspector.Object.prototype},WebInspector.TabbedEditorContainer.History=function(e){this._items=e,this._rebuildItemIndex()},WebInspector.TabbedEditorContainer.History.fromObject=function(e){var t=[];for(var n=0;n<e.length;++n)t.push(WebInspector.TabbedEditorContainer.HistoryItem.fromObject(e[n]));return new WebInspector.TabbedEditorContainer.History(t)},WebInspector.TabbedEditorContainer.History.prototype={index:function(e){var t=this._itemsIndex[e];return typeof t=="number"?t:-1},_rebuildItemIndex:function(){this._itemsIndex={};for(var e=0;e<this._items.length;++e)console.assert(!this._itemsIndex.hasOwnProperty(this._items[e].url)),this._itemsIndex[this._items[e].url]=e},selectionRange:function(e){var t=this.index(e);return t!==-1?this._items[t].selectionRange:undefined},updateSelectionRange:function(e,t){if(!t)return;var n=this.index(e);if(n===-1)return;this._items[n].selectionRange=t},scrollLineNumber:function(e){var t=this.index(e);return t!==-1?this._items[t].scrollLineNumber:undefined},updateScrollLineNumber:function(e,t){var n=this.index(e);if(n===-1)return;this._items[n].scrollLineNumber=t},update:function(e){for(var t=e.length-1;t>=0;--t){var n=this.index(e[t]),r;n!==-1?(r=this._items[n],this._items.splice(n,1)):r=new WebInspector.TabbedEditorContainer.HistoryItem(e[t]),this._items.unshift(r),this._rebuildItemIndex()}},remove:function(e){var t=this.index(e);t!==-1&&(this._items.splice(t,1),this._rebuildItemIndex())},save:function(e){e.set(this._serializeToObject())},_serializeToObject:function(){var e=[];for(var t=0;t<this._items.length;++t){var n=this._items[t].serializeToObject();n&&e.push(n);if(e.length===WebInspector.TabbedEditorContainer.maximalPreviouslyViewedFilesCount)break}return e},_urls:function(){var e=[];for(var t=0;t<this._items.length;++t)e.push(this._items[t].url);return e},__proto__:WebInspector.Object.prototype},WebInspector.EditorContainerTabDelegate=function(e){this._editorContainer=e},WebInspector.EditorContainerTabDelegate.prototype={closeTabs:function(e,t){this._editorContainer._closeTabs(t)}};