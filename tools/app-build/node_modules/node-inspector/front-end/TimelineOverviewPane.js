/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.TimelineOverviewPane=function(e){WebInspector.View.call(this),this.element.id="timeline-overview-panel",this._windowStartTime=0,this._windowEndTime=Infinity,this._eventDividers=[],this._model=e,this._topPaneSidebarElement=document.createElement("div"),this._topPaneSidebarElement.id="timeline-overview-sidebar";var t=document.createElement("ol");t.className="sidebar-tree",this._topPaneSidebarElement.appendChild(t),this.element.appendChild(this._topPaneSidebarElement);var n=new TreeOutline(t);this._overviewItems={},this._overviewItems[WebInspector.TimelineOverviewPane.Mode.Events]=new WebInspector.SidebarTreeElement("timeline-overview-sidebar-events",WebInspector.UIString("Events")),this._overviewItems[WebInspector.TimelineOverviewPane.Mode.Frames]=new WebInspector.SidebarTreeElement("timeline-overview-sidebar-frames",WebInspector.UIString("Frames")),this._overviewItems[WebInspector.TimelineOverviewPane.Mode.Memory]=new WebInspector.SidebarTreeElement("timeline-overview-sidebar-memory",WebInspector.UIString("Memory"));for(var r in this._overviewItems){var i=this._overviewItems[r];i.onselect=this.setMode.bind(this,r),n.appendChild(i)}this._overviewGrid=new WebInspector.OverviewGrid("timeline"),this.element.appendChild(this._overviewGrid.element);var s=document.createElement("div");s.id="timeline-overview-separator",this.element.appendChild(s),this._innerSetMode(WebInspector.TimelineOverviewPane.Mode.Events);var o=WebInspector.TimelinePresentationModel.categories();for(var u in o)o[u].addEventListener(WebInspector.TimelineCategory.Events.VisibilityChanged,this._onCategoryVisibilityChanged,this);this._overviewCalculator=new WebInspector.TimelineOverviewCalculator,e.addEventListener(WebInspector.TimelineModel.Events.RecordAdded,this._onRecordAdded,this),e.addEventListener(WebInspector.TimelineModel.Events.RecordsCleared,this._reset,this),this._overviewGrid.addEventListener(WebInspector.OverviewGrid.Events.WindowChanged,this._onWindowChanged,this)},WebInspector.TimelineOverviewPane.Mode={Events:"Events",Frames:"Frames",Memory:"Memory"},WebInspector.TimelineOverviewPane.Events={ModeChanged:"ModeChanged",WindowChanged:"WindowChanged"},WebInspector.TimelineOverviewPane.prototype={wasShown:function(){this._update()},onResize:function(){this._update()},setMode:function(e){if(this._currentMode===e)return;var t;this._overviewControl&&(t=this._overviewControl.windowTimes(this.windowLeft(),this.windowRight())),this._innerSetMode(e),this.dispatchEventToListeners(WebInspector.TimelineOverviewPane.Events.ModeChanged,this._currentMode),t&&t.startTime>=0&&this.setWindowTimes(t.startTime,t.endTime),this._update()},_innerSetMode:function(e){var t;this._overviewControl&&this._overviewControl.detach(),this._currentMode=e,this._overviewControl=this._createOverviewControl(),this._overviewControl.show(this._overviewGrid.element),this._overviewItems[this._currentMode].revealAndSelect(!1)},_createOverviewControl:function(){switch(this._currentMode){case WebInspector.TimelineOverviewPane.Mode.Events:return new WebInspector.TimelineEventOverview(this._model);case WebInspector.TimelineOverviewPane.Mode.Frames:return new WebInspector.TimelineFrameOverview(this._model);case WebInspector.TimelineOverviewPane.Mode.Memory:return new WebInspector.TimelineMemoryOverview(this._model)}throw new Error("Invalid overview mode: "+this._currentMode)},_onCategoryVisibilityChanged:function(e){this._overviewControl.categoryVisibilityChanged()},_update:function(){delete this._refreshTimeout,this._updateWindow(),this._overviewCalculator.setWindow(this._model.minimumRecordTime(),this._model.maximumRecordTime()),this._overviewCalculator.setDisplayWindow(0,this._overviewGrid.clientWidth()),this._overviewControl.update(),this._overviewGrid.updateDividers(this._overviewCalculator),this._updateEventDividers()},_updateEventDividers:function(){var e=this._eventDividers;this._overviewGrid.removeEventDividers();var t=[];for(var n=0;n<e.length;++n){var r=e[n],i=this._overviewCalculator.computeBarGraphPercentages(r),s=Math.round(i.start*10);if(t[s])continue;var o=WebInspector.TimelinePresentationModel.createEventDivider(r.type);o.style.left=i.start+"%",t[s]=o}this._overviewGrid.addEventDividers(t)},sidebarResized:function(e){this._overviewGrid.element.style.left=e+"px",this._topPaneSidebarElement.style.width=e+"px",this._update()},addFrame:function(e){this._overviewControl.addFrame(e),this._scheduleRefresh()},zoomToFrame:function(e){var t=this._overviewControl,n=t.framePosition(e);if(!n)return;this._overviewGrid.setWindowPosition(n.start,n.end)},_onRecordAdded:function(e){function r(e){WebInspector.TimelinePresentationModel.isEventDivider(e)&&n.push(e)}var t=e.data,n=this._eventDividers;WebInspector.TimelinePresentationModel.forAllRecords([t],r),this._scheduleRefresh()},_reset:function(){this._windowStartTime=0,this._windowEndTime=Infinity,this._overviewCalculator.reset(),this._overviewGrid.reset(),this._overviewGrid.setResizeEnabled(!1),this._eventDividers=[],this._overviewGrid.updateDividers(this._overviewCalculator),this._overviewControl.reset(),this._update()},windowStartTime:function(){return this._windowStartTime||this._model.minimumRecordTime()},windowEndTime:function(){return this._windowEndTime<Infinity?this._windowEndTime:this._model.maximumRecordTime()},windowLeft:function(){return this._overviewGrid.windowLeft()},windowRight:function(){return this._overviewGrid.windowRight()},_onWindowChanged:function(){if(this._ignoreWindowChangedEvent)return;var e=this._overviewControl.windowTimes(this.windowLeft(),this.windowRight());this._windowStartTime=e.startTime,this._windowEndTime=e.endTime,this.dispatchEventToListeners(WebInspector.TimelineOverviewPane.Events.WindowChanged)},setWindowTimes:function(e,t){this._windowStartTime=e,this._windowEndTime=t,this._updateWindow()},_updateWindow:function(){var e=this._overviewControl.windowBoundaries(this._windowStartTime,this._windowEndTime);this._ignoreWindowChangedEvent=!0,this._overviewGrid.setWindow(e.left,e.right),this._overviewGrid.setResizeEnabled(this._model.records.length),this._ignoreWindowChangedEvent=!1},_scheduleRefresh:function(){if(this._refreshTimeout)return;if(!this.isShowing())return;this._refreshTimeout=setTimeout(this._update.bind(this),300)},__proto__:WebInspector.View.prototype},WebInspector.TimelineOverviewCalculator=function(){},WebInspector.TimelineOverviewCalculator.prototype={computePosition:function(e){return(e-this._minimumBoundary)/this.boundarySpan()*this._workingArea+this.paddingLeft},computeBarGraphPercentages:function(e){var t=(WebInspector.TimelineModel.startTimeInSeconds(e)-this._minimumBoundary)/this.boundarySpan()*100,n=(WebInspector.TimelineModel.endTimeInSeconds(e)-this._minimumBoundary)/this.boundarySpan()*100;return{start:t,end:n}},setWindow:function(e,t){this._minimumBoundary=e>=0?e:undefined,this._maximumBoundary=t>=0?t:undefined},setDisplayWindow:function(e,t){this._workingArea=t-e,this.paddingLeft=e},reset:function(){this.setWindow()},formatTime:function(e){return Number.secondsToString(e)},maximumBoundary:function(){return this._maximumBoundary},minimumBoundary:function(){return this._minimumBoundary},zeroTime:function(){return this._minimumBoundary},boundarySpan:function(){return this._maximumBoundary-this._minimumBoundary}},WebInspector.TimelineOverviewBase=function(e){WebInspector.View.call(this),this.element.classList.add("fill"),this._model=e,this._canvas=this.element.createChild("canvas","fill"),this._context=this._canvas.getContext("2d")},WebInspector.TimelineOverviewBase.prototype={update:function(){},reset:function(){},categoryVisibilityChanged:function(){},addFrame:function(e){},windowTimes:function(e,t){var n=this._model.minimumRecordTime(),r=this._model.maximumRecordTime()-n;return{startTime:n+r*e,endTime:n+r*t}},windowBoundaries:function(e,t){var n=this._model.minimumRecordTime(),r=this._model.maximumRecordTime()-n,i=n>=0;return{left:i&&e?Math.min((e-n)/r,1):0,right:i&&t<Infinity?(t-n)/r:1}},_resetCanvas:function(){this._canvas.width=this.element.clientWidth*window.devicePixelRatio,this._canvas.height=this.element.clientHeight*window.devicePixelRatio},__proto__:WebInspector.View.prototype},WebInspector.TimelineMemoryOverview=function(e){WebInspector.TimelineOverviewBase.call(this,e),this.element.id="timeline-overview-memory",this._maxHeapSizeLabel=this.element.createChild("div","max memory-graph-label"),this._minHeapSizeLabel=this.element.createChild("div","min memory-graph-label")},WebInspector.TimelineMemoryOverview.prototype={update:function(){this._resetCanvas();var e=this._model.records;if(!e.length)return;const t=3;var n=0,r=1e11,i=this._model.minimumRecordTime(),s=this._model.maximumRecordTime();WebInspector.TimelinePresentationModel.forAllRecords(e,function(e){n=Math.max(n,e.usedHeapSize||n),r=Math.min(r,e.usedHeapSize||r)}),r=Math.min(r,n);var o=this._canvas.width,u=this._canvas.height-t,a=o/(s-i),f=u/Math.max(n-r,1),l=new Array(o);WebInspector.TimelinePresentationModel.forAllRecords(e,function(e){if(!e.usedHeapSize)return;var t=Math.round((WebInspector.TimelineModel.endTimeInSeconds(e)-i)*a),n=Math.round((e.usedHeapSize-r)*f);l[t]=Math.max(l[t]||0,n)}),u++;var c=0,h=!0,p=this._context;p.beginPath(),p.moveTo(0,this._canvas.height);for(var d=0;d<l.length;d++){if(typeof l[d]=="undefined")continue;h&&(h=!1,c=l[d],p.lineTo(0,u-c)),p.lineTo(d,u-c),c=l[d],p.lineTo(d,u-c)}p.lineTo(o,u-c),p.lineTo(o,this._canvas.height),p.lineTo(0,this._canvas.height),p.closePath(),p.lineWidth=.5,p.strokeStyle="rgba(20,0,0,0.8)",p.stroke(),p.fillStyle="rgba(214,225,254, 0.8);",p.fill(),this._maxHeapSizeLabel.textContent=Number.bytesToString(n),this._minHeapSizeLabel.textContent=Number.bytesToString(r)},__proto__:WebInspector.TimelineOverviewBase.prototype},WebInspector.TimelineEventOverview=function(e){WebInspector.TimelineOverviewBase.call(this,e),this.element.id="timeline-overview-events",this._fillStyles={};var t=WebInspector.TimelinePresentationModel.categories();for(var n in t)this._fillStyles[n]=WebInspector.TimelinePresentationModel.createFillStyleForCategory(this._context,0,WebInspector.TimelineEventOverview._stripGradientHeight,t[n]);this._disabledCategoryFillStyle=WebInspector.TimelinePresentationModel.createFillStyle(this._context,0,WebInspector.TimelineEventOverview._stripGradientHeight,"rgb(218, 218, 218)","rgb(170, 170, 170)","rgb(143, 143, 143)"),this._disabledCategoryBorderStyle="rgb(143, 143, 143)"},WebInspector.TimelineEventOverview._numberOfStrips=3,WebInspector.TimelineEventOverview._stripGradientHeight=120,WebInspector.TimelineEventOverview.prototype={update:function(){function o(n){if(n.type===WebInspector.TimelineModel.RecordType.BeginFrame)return;var s=Math.floor((WebInspector.TimelineModel.startTimeInSeconds(n)-t)*r),o=Math.ceil((WebInspector.TimelineModel.endTimeInSeconds(n)-t)*r),u=WebInspector.TimelinePresentationModel.categoryForRecord(n);if(u.overviewStripGroupIndex<0)return;var a=i[u.overviewStripGroupIndex];const f=2;if(a&&a.category===u&&a.end+f>=s){o>a.end&&(a.end=o);return}a&&this._renderBar(a.start,a.end,e,a.category),i[u.overviewStripGroupIndex]={start:s,end:o,category:u}}this._resetCanvas();var e=Math.round(this._canvas.height/WebInspector.TimelineEventOverview._numberOfStrips),t=this._model.minimumRecordTime(),n=this._model.maximumRecordTime()-t,r=this._canvas.width/n,i=[];this._context.fillStyle="rgba(0, 0, 0, 0.05)";for(var s=1;s<WebInspector.TimelineEventOverview._numberOfStrips;s+=2)this._context.fillRect(.5,s*e+.5,this._canvas.width,e);WebInspector.TimelinePresentationModel.forAllRecords(this._model.records,o.bind(this));for(var s=0;s<i.length;++s)i[s]&&this._renderBar(i[s].start,i[s].end,e,i[s].category)},categoryVisibilityChanged:function(){this.update()},_renderBar:function(e,t,n,r){const i=4*window.devicePixelRatio,s=n-2*i;var o=e+.5,u=r.overviewStripGroupIndex*n+i+.5,a=Math.max(t-e,1);this._context.save(),this._context.translate(o,u),this._context.scale(1,s/WebInspector.TimelineEventOverview._stripGradientHeight),this._context.fillStyle=r.hidden?this._disabledCategoryFillStyle:this._fillStyles[r.name],this._context.fillRect(0,0,a,WebInspector.TimelineEventOverview._stripGradientHeight),this._context.strokeStyle=r.hidden?this._disabledCategoryBorderStyle:r.borderColor,this._context.strokeRect(0,0,a,WebInspector.TimelineEventOverview._stripGradientHeight),this._context.restore()},__proto__:WebInspector.TimelineOverviewBase.prototype},WebInspector.TimelineFrameOverview=function(e){WebInspector.TimelineOverviewBase.call(this,e),this.element.id="timeline-overview-frames",this.reset(),this._outerPadding=4*window.devicePixelRatio,this._maxInnerBarWidth=10*window.devicePixelRatio,this._actualPadding=5*window.devicePixelRatio,this._actualOuterBarWidth=this._maxInnerBarWidth+this._actualPadding,this._fillStyles={};var t=WebInspector.TimelinePresentationModel.categories();for(var n in t)this._fillStyles[n]=WebInspector.TimelinePresentationModel.createFillStyleForCategory(this._context,this._maxInnerBarWidth,0,t[n])},WebInspector.TimelineFrameOverview.prototype={reset:function(){this._recordsPerBar=1,this._barTimes=[],this._frames=[]},update:function(){const e=4*window.devicePixelRatio;this._resetCanvas(),this._framesPerBar=Math.max(1,this._frames.length*e/this._canvas.width),this._barTimes=[];var t=this._aggregateFrames(this._framesPerBar);const n=4*window.devicePixelRatio,r=30;var i=1/r;i<this._medianFrameLength&&(i=Math.min(this._medianFrameLength*2,this._maxFrameLength));var s=(this._canvas.height-n)/i;this._renderBars(t,s)},addFrame:function(e){this._frames.push(e)},framePosition:function(e){var t=this._frames.indexOf(e);if(t<0)return;var n=Math.floor(t/this._framesPerBar),r=this._framesPerBar>1?n:Math.max(n-1,0),i=this._framesPerBar>1?n:Math.min(n+1,this._barTimes.length-1);return{start:Math.ceil(this._barNumberToScreenPosition(r)-this._actualPadding/2),end:Math.floor(this._barNumberToScreenPosition(i+1)-this._actualPadding/2)}},_aggregateFrames:function(e){var t=[],n=[];this._maxFrameLength=0;for(var r=0,i=0;i<this._frames.length;++r){var s=this._frames[i].startTime,o=null;for(var u=Math.min(Math.floor((r+1)*e),this._frames.length);i<u;++i)if(!o||o.duration<this._frames[i].duration)o=this._frames[i];var a=this._frames[i-1].endTime;o&&(this._maxFrameLength=Math.max(this._maxFrameLength,o.duration),t.push(o),this._barTimes.push({startTime:s,endTime:a}),n.push(o.duration))}return this._medianFrameLength=n.qselect(Math.floor(n.length/2)),t},_renderBars:function(e,t){const n=5*window.devicePixelRatio;this._actualOuterBarWidth=Math.min((this._canvas.width-2*this._outerPadding)/e.length,this._maxInnerBarWidth+n),this._actualPadding=Math.min(Math.floor(this._actualOuterBarWidth/3),n);var r=this._actualOuterBarWidth-this._actualPadding;for(var i=0;i<e.length;++i)this._renderBar(this._barNumberToScreenPosition(i),r,e[i],t);this._drawFPSMarks(t)},_barNumberToScreenPosition:function(e){return this._outerPadding+this._actualOuterBarWidth*e},_drawFPSMarks:function(e){const t=[30,60];this._context.save(),this._context.beginPath(),this._context.font=10*window.devicePixelRatio+"px "+window.getComputedStyle(this.element,null).getPropertyValue("font-family"),this._context.textAlign="right",this._context.textBaseline="alphabetic";const n=4*window.devicePixelRatio,r=3*window.devicePixelRatio;var i=12*window.devicePixelRatio,s=0,o=0;for(var u=0;u<t.length;++u){var a=t[u],f=this._canvas.height-Math.floor(1/a*e)-.5,l=WebInspector.UIString("%d fps",a),c=this._context.measureText(l).width+2*n,h=this._canvas.width;!u&&s<f-i&&(o=-i);var p=f+o;if(p<s||p+i>this._canvas.height)break;this._context.moveTo(0,f),this._context.lineTo(this._canvas.width,f),this._context.fillStyle="rgba(255, 255, 255, 0.5)",this._context.fillRect(h-c,p,c,i),this._context.fillStyle="black",this._context.fillText(l,h-n,p+i-r),s=p+i}this._context.strokeStyle="rgba(128, 128, 128, 0.5)",this._context.stroke(),this._context.restore()},_renderBar:function(e,t,n,r){var i=Object.keys(WebInspector.TimelinePresentationModel.categories());if(!i.length)return;var s=Math.floor(e)+.5;t=Math.floor(t);for(var o=0,u=this._canvas.height;o<i.length;++o){var a=i[o],f=n.timeByCategory[a];if(!f)continue;var l=f*r,c=Math.floor(u-l)+.5;this._context.save(),this._context.translate(s,0),this._context.scale(t/this._maxInnerBarWidth,1),this._context.fillStyle=this._fillStyles[a],this._context.fillRect(0,c,this._maxInnerBarWidth,Math.floor(l)),this._context.strokeStyle=WebInspector.TimelinePresentationModel.categories()[a].borderColor,this._context.beginPath(),this._context.moveTo(0,c),this._context.lineTo(this._maxInnerBarWidth,c),this._context.stroke(),this._context.restore(),u-=l-1}var h=Math.floor(this._canvas.height-n.duration*r)+.5,p=this._canvas.height+.5;this._context.strokeStyle="rgba(90, 90, 90, 0.3)",this._context.beginPath(),this._context.moveTo(s,p),this._context.lineTo(s,h),this._context.lineTo(s+t,h),this._context.lineTo(s+t,p),this._context.stroke()},windowTimes:function(e,t){if(!this._barTimes.length)return WebInspector.TimelineOverviewBase.prototype.windowTimes.call(this,e,t);var n=this._canvas.width,r=e*n-this._outerPadding+this._actualPadding,i=t*n-this._outerPadding,s=Math.floor(Math.max(r,0)/this._actualOuterBarWidth),o=Math.min(Math.floor(i/this._actualOuterBarWidth),this._barTimes.length-1);if(s>=this._barTimes.length)return{startTime:Infinity,endTime:Infinity};const u=3;return{startTime:this._barTimes[s].startTime,endTime:i+u>n||o>=this._barTimes.length?Infinity:this._barTimes[o].endTime}},windowBoundaries:function(e,t){function n(e,t){return e-t.startTime}function r(e,t){return e===t.endTime?1:e-t.endTime}return{left:this._windowBoundaryFromTime(e,r),right:this._windowBoundaryFromTime(t,n)}},_windowBoundaryFromTime:function(e,t){if(e===Infinity)return 1;var n=this._firstBarAfter(e,t);return n?(this._barNumberToScreenPosition(n)-this._actualPadding/2)/this._canvas.width:0},_firstBarAfter:function(e,t){return insertionIndexForObjectInListSortedByFunction(e,this._barTimes,t)},__proto__:WebInspector.TimelineOverviewBase.prototype},WebInspector.TimelineWindowFilter=function(e){this._pane=e},WebInspector.TimelineWindowFilter.prototype={accept:function(e){return e.lastChildEndTime>=this._pane._windowStartTime&&e.startTime<=this._pane._windowEndTime}};