/*
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.TabbedPane=function(){WebInspector.View.call(this),this.registerRequiredCSS("tabbedPane.css"),this.element.addStyleClass("tabbed-pane"),this._headerElement=this.element.createChild("div","tabbed-pane-header"),this._headerContentsElement=this._headerElement.createChild("div","tabbed-pane-header-contents"),this._tabsElement=this._headerContentsElement.createChild("div","tabbed-pane-header-tabs"),this._contentElement=this.element.createChild("div","tabbed-pane-content scroll-target"),this._tabs=[],this._tabsHistory=[],this._tabsById={},this.element.addEventListener("click",this.focus.bind(this),!0),this.element.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this._dropDownButton=this._createDropDownButton()},WebInspector.TabbedPane.EventTypes={TabSelected:"TabSelected",TabClosed:"TabClosed"},WebInspector.TabbedPane.prototype={get visibleView(){return this._currentTab?this._currentTab.view:null},get selectedTabId(){return this._currentTab?this._currentTab.id:null},set shrinkableTabs(e){this._shrinkableTabs=e},set verticalTabLayout(e){this._verticalTabLayout=e},set closeableTabs(e){this._closeableTabs=e},setRetainTabsOrder:function(e){this._retainTabsOrder=e},defaultFocusedElement:function(){return this.visibleView?this.visibleView.defaultFocusedElement():null},setTabDelegate:function(e){var t=this._tabs.slice();for(var n=0;n<t.length;++n)t[n].setDelegate(e);this._delegate=e},onMouseUp:function(e){e.button===1&&e.consume(!0)},appendTab:function(e,t,n,r,i){var s=new WebInspector.TabbedPaneTab(this,e,t,this._closeableTabs,n,r);s.setDelegate(this._delegate),this._tabsById[e]=s,this._tabs.push(s),this._tabsHistory.push(s),this._tabsHistory[0]===s&&this.selectTab(s.id,i),this._updateTabElements()},closeTab:function(e,t){this.closeTabs([e],t)},closeTabs:function(e,t){for(var n=0;n<e.length;++n)this._innerCloseTab(e[n],t);this._updateTabElements(),this._tabsHistory.length&&this.selectTab(this._tabsHistory[0].id,t)},_innerCloseTab:function(e,t){this._currentTab&&this._currentTab.id===e&&this._hideCurrentTab();var n=this._tabsById[e];delete this._tabsById[e],this._tabsHistory.splice(this._tabsHistory.indexOf(n),1),this._tabs.splice(this._tabs.indexOf(n),1),n._shown&&this._hideTabElement(n);var r={tabId:e,view:n.view,isUserGesture:t};return this.dispatchEventToListeners(WebInspector.TabbedPane.EventTypes.TabClosed,r),!0},allTabs:function(){var e=[],t=this._tabs.slice();for(var n=0;n<t.length;++n)e.push(t[n].id);return e},otherTabs:function(e){var t=[],n=this._tabs.slice();for(var r=0;r<n.length;++r)n[r].id!==e&&t.push(n[r].id);return t},selectTab:function(e,t){var n=this._tabsById[e];if(!n)return;if(this._currentTab&&this._currentTab.id===e)return;this._hideCurrentTab(),this._showTab(n),this._currentTab=n,this._tabsHistory.splice(this._tabsHistory.indexOf(n),1),this._tabsHistory.splice(0,0,n),this._updateTabElements();var r={tabId:e,view:n.view,isUserGesture:t};return this.dispatchEventToListeners(WebInspector.TabbedPane.EventTypes.TabSelected,r),!0},lastOpenedTabIds:function(e){function t(e){return e.id}return this._tabsHistory.slice(0,e).map(t)},setTabIcon:function(e,t,n){var r=this._tabsById[e];r._setIconClass(t,n),this._updateTabElements()},changeTabTitle:function(e,t){var n=this._tabsById[e];n.title=t,this._updateTabElements()},changeTabView:function(e,t){var n=this._tabsById[e];this._currentTab&&this._currentTab.id===n.id?(this._hideTab(n),n.view=t,this._showTab(n)):n.view=t},changeTabTooltip:function(e,t){var n=this._tabsById[e];n.tooltip=t},onResize:function(){this._updateTabElements()},_updateTabElements:function(){WebInspector.invokeOnceAfterBatchUpdate(this,this._innerUpdateTabElements)},setPlaceholderText:function(e){this._noTabsMessage=e},_innerUpdateTabElements:function(){if(!this.isShowing())return;this._tabs.length?(this._contentElement.removeStyleClass("has-no-tabs"),this._noTabsMessageElement&&(this._noTabsMessageElement.remove(),delete this._noTabsMessageElement)):(this._contentElement.addStyleClass("has-no-tabs"),this._noTabsMessage&&!this._noTabsMessageElement&&(this._noTabsMessageElement=this._contentElement.createChild("div","tabbed-pane-placeholder fill"),this._noTabsMessageElement.textContent=this._noTabsMessage)),this._measuredDropDownButtonWidth||this._measureDropDownButton(),this._updateWidths(),this._updateTabsDropDown()},_showTabElement:function(e,t){e>=this._tabsElement.children.length?this._tabsElement.appendChild(t.tabElement):this._tabsElement.insertBefore(t.tabElement,this._tabsElement.children[e]),t._shown=!0},_hideTabElement:function(e){this._tabsElement.removeChild(e.tabElement),e._shown=!1},_createDropDownButton:function(){var e=document.createElement("div");e.addStyleClass("tabbed-pane-header-tabs-drop-down-container");var t=e.createChild("div","tabbed-pane-header-tabs-drop-down");return t.appendChild(document.createTextNode("Â»")),this._tabsSelect=t.createChild("select","tabbed-pane-header-tabs-drop-down-select"),this._tabsSelect.addEventListener("change",this._tabsSelectChanged.bind(this),!1),e},_totalWidth:function(){return this._headerContentsElement.getBoundingClientRect().width},_updateTabsDropDown:function(){var e=this._tabsToShowIndexes(this._tabs,this._tabsHistory,this._totalWidth(),this._measuredDropDownButtonWidth);for(var t=0;t<this._tabs.length;++t)this._tabs[t]._shown&&e.indexOf(t)===-1&&this._hideTabElement(this._tabs[t]);for(var t=0;t<e.length;++t){var n=this._tabs[e[t]];n._shown||this._showTabElement(t,n)}this._populateDropDownFromIndex()},_populateDropDownFromIndex:function(){function n(e,t){return e.title.localeCompare(t.title)}this._dropDownButton.parentElement&&this._headerContentsElement.removeChild(this._dropDownButton),this._tabsSelect.removeChildren();var e=[];for(var t=0;t<this._tabs.length;++t){this._tabs[t]._shown||e.push(this._tabs[t]);continue}e.sort(n);var r=-1;for(var t=0;t<e.length;++t){var i=new Option(e[t].title);i.tab=e[t],this._tabsSelect.appendChild(i),this._tabsHistory[0]===e[t]&&(r=t)}this._tabsSelect.options.length&&(this._headerContentsElement.appendChild(this._dropDownButton),this._tabsSelect.selectedIndex=r)},_tabsSelectChanged:function(){var e=this._tabsSelect.options,t=e[this._tabsSelect.selectedIndex];this.selectTab(t.tab.id,!0)},_measureDropDownButton:function(){this._dropDownButton.addStyleClass("measuring"),this._headerContentsElement.appendChild(this._dropDownButton),this._measuredDropDownButtonWidth=this._dropDownButton.getBoundingClientRect().width,this._headerContentsElement.removeChild(this._dropDownButton),this._dropDownButton.removeStyleClass("measuring")},_updateWidths:function(){var e=this._measureWidths(),t=this._shrinkableTabs?this._calculateMaxWidth(e.slice(),this._totalWidth()):Number.MAX_VALUE,n=0;for(var r in this._tabs){var i=this._tabs[r];i.setWidth(this._verticalTabLayout?-1:Math.min(t,e[n++]))}},_measureWidths:function(){var e=[];for(var t in this._tabs){var n=this._tabs[t];if(typeof n._measuredWidth=="number")continue;var r=n._createTabElement(!0);r.__tab=n,e.push(r),this._tabsElement.appendChild(r)}for(var i=0;i<e.length;++i)e[i].__tab._measuredWidth=e[i].getBoundingClientRect().width;for(var i=0;i<e.length;++i)e[i].remove();var s=[];for(var t in this._tabs)s.push(this._tabs[t]._measuredWidth);return s},_calculateMaxWidth:function(e,t){if(!e.length)return 0;e.sort(function(e,t){return e-t});var n=0;for(var r=0;r<e.length;++r)n+=e[r];if(t>=n)return e[e.length-1];var i=0;for(var r=e.length-1;r>0;--r){var s=e[r]-e[r-1];i+=(e.length-r)*s;if(t+i>=n)return e[r-1]+(t+i-n)/(e.length-r)}return t/e.length},_tabsToShowIndexes:function(e,t,n,r){var i=[],s=0,o=e.length;for(var u=0;u<o;++u){var a=this._retainTabsOrder?e[u]:t[u];s+=a.width();var f=s;u!==o-1&&(f+=r);if(!this._verticalTabLayout&&f>n)break;i.push(e.indexOf(a))}return i.sort(function(e,t){return e-t}),i},_hideCurrentTab:function(){if(!this._currentTab)return;this._hideTab(this._currentTab),delete this._currentTab},_showTab:function(e){e.tabElement.addStyleClass("selected"),e.view.show(this._contentElement)},_hideTab:function(e){e.tabElement.removeStyleClass("selected"),e.view.detach()},canHighlightPosition:function(){return this._currentTab&&this._currentTab.view&&this._currentTab.view.canHighlightPosition()},highlightPosition:function(e,t){this.canHighlightPosition()&&this._currentTab.view.highlightPosition(e,t)},elementsToRestoreScrollPositionsFor:function(){return[this._contentElement]},_insertBefore:function(e,t){this._tabsElement.insertBefore(e._tabElement,this._tabsElement.childNodes[t]);var n=this._tabs.indexOf(e);this._tabs.splice(n,1),n<t&&--t,this._tabs.splice(t,0,e)},__proto__:WebInspector.View.prototype},WebInspector.TabbedPaneTab=function(e,t,n,r,i,s){this._closeable=r,this._tabbedPane=e,this._id=t,this._title=n,this._tooltip=s,this._view=i,this._shown=!1,this._measuredWidth,this._tabElement},WebInspector.TabbedPaneTab.prototype={get id(){return this._id},get title(){return this._title},set title(e){if(e===this._title)return;this._title=e,this._titleElement&&(this._titleElement.textContent=e),delete this._measuredWidth},iconClass:function(){return this._iconClass},_setIconClass:function(e,t){if(e===this._iconClass&&t===this._iconTooltip)return;this._iconClass=e,this._iconTooltip=t,this._iconElement&&this._iconElement.remove(),this._iconClass&&this._tabElement&&(this._iconElement=this._createIconElement(this._tabElement,this._titleElement)),delete this._measuredWidth},get view(){return this._view},set view(e){this._view=e},get tooltip(){return this._tooltip},set tooltip(e){this._tooltip=e,this._titleElement&&(this._titleElement.title=e||"")},get tabElement(){return typeof this._tabElement!="undefined"?this._tabElement:(this._createTabElement(!1),this._tabElement)},width:function(){return this._width},setWidth:function(e){this.tabElement.style.width=e===-1?"":e+"px",this._width=e},setDelegate:function(e){this._delegate=e},_createIconElement:function(e,t){var n=document.createElement("span");return n.className="tabbed-pane-header-tab-icon "+this._iconClass,this._iconTooltip&&(n.title=this._iconTooltip),e.insertBefore(n,t),n},_createTabElement:function(e){var t=document.createElement("div");t.addStyleClass("tabbed-pane-header-tab"),t.id="tab-"+this._id,t.tabIndex=-1;var n=t.createChild("span","tabbed-pane-header-tab-title");return n.textContent=this.title,n.title=this.tooltip||"",this._iconClass&&this._createIconElement(t,n),e||(this._titleElement=n),this._closeable&&t.createChild("div","close-button-gray"),e?t.addStyleClass("measuring"):(this._tabElement=t,t.addEventListener("click",this._tabClicked.bind(this),!1),t.addEventListener("mousedown",this._tabMouseDown.bind(this),!1),this._closeable&&(t.addEventListener("contextmenu",this._tabContextMenu.bind(this),!1),WebInspector.installDragHandle(t,this._startTabDragging.bind(this),this._tabDragging.bind(this),this._endTabDragging.bind(this),"pointer"))),t},_tabClicked:function(e){var t=e.button===1,n=this._closeable&&(t||e.target.hasStyleClass("close-button-gray"));if(!n)return;this._closeTabs([this.id]),e.consume(!0)},_tabMouseDown:function(e){if(e.target.hasStyleClass("close-button-gray")||e.button===1)return;this._tabbedPane.selectTab(this.id,!0)},_closeTabs:function(e){if(this._delegate){this._delegate.closeTabs(this._tabbedPane,e);return}this._tabbedPane.closeTabs(e,!0)},_tabContextMenu:function(e){function t(){this._closeTabs([this.id])}function n(){this._closeTabs(this._tabbedPane.otherTabs(this.id))}function r(){this._closeTabs(this._tabbedPane.allTabs(this.id))}var i=new WebInspector.ContextMenu(e);i.appendItem(WebInspector.UIString("Close"),t.bind(this)),i.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Close others":"Close Others"),n.bind(this)),i.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Close all":"Close All"),r.bind(this)),i.show()},_startTabDragging:function(e){return e.target.hasStyleClass("close-button-gray")?!1:(this._dragStartX=e.pageX,!0)},_tabDragging:function(e){var t=this._tabbedPane._tabsElement.childNodes;for(var n=0;n<t.length;++n){var r=t[n];if(r===this._tabElement)continue;var i=r.offsetLeft+r.clientWidth>this._tabElement.offsetLeft&&this._tabElement.offsetLeft+this._tabElement.clientWidth>r.offsetLeft;if(!i)continue;if(Math.abs(e.pageX-this._dragStartX)<r.clientWidth/2+5)break;e.pageX-this._dragStartX>0&&(r=r.nextSibling,++n);var s=this._tabElement.offsetLeft;this._tabbedPane._insertBefore(this,n),this._dragStartX+=this._tabElement.offsetLeft-s;break}if(!this._tabElement.previousSibling&&e.pageX-this._dragStartX<0){this._tabElement.style.setProperty("left","0px");return}if(!this._tabElement.nextSibling&&e.pageX-this._dragStartX>0){this._tabElement.style.setProperty("left","0px");return}this._tabElement.style.setProperty("position","relative"),this._tabElement.style.setProperty("left",e.pageX-this._dragStartX+"px")},_endTabDragging:function(e){this._tabElement.style.removeProperty("position"),this._tabElement.style.removeProperty("left"),delete this._dragStartX}},WebInspector.TabbedPaneTabDelegate=function(){},WebInspector.TabbedPaneTabDelegate.prototype={closeTabs:function(e,t){}};