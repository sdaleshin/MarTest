/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *        notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *        notice, this list of conditions and the following disclaimer in the
 *        documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.         IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.DataGrid=function(e,t,n,r,i){WebInspector.View.call(this),this.registerRequiredCSS("dataGrid.css"),this.element.className="data-grid",this.element.tabIndex=0,this.element.addEventListener("keydown",this._keyDown.bind(this),!1),this._headerTable=document.createElement("table"),this._headerTable.className="header",this._headerTableHeaders={},this._dataTable=document.createElement("table"),this._dataTable.className="data",this._dataTable.addEventListener("mousedown",this._mouseDownInDataTable.bind(this),!0),this._dataTable.addEventListener("click",this._clickInDataTable.bind(this),!0),this._dataTable.addEventListener("contextmenu",this._contextMenuInDataTable.bind(this),!0),t&&this._dataTable.addEventListener("dblclick",this._ondblclick.bind(this),!1),this._editCallback=t,this._deleteCallback=n,this._refreshCallback=r,this._contextMenuCallback=i,this._scrollContainer=document.createElement("div"),this._scrollContainer.className="data-container",this._scrollContainer.appendChild(this._dataTable),this.element.appendChild(this._headerTable),this.element.appendChild(this._scrollContainer);var s=document.createElement("tr"),o=document.createElement("colgroup");o.span=e.length;var u=document.createElement("tr");u.className="filler",this._columnsArray=e,this.columns={};for(var a=0;a<e.length;++a){var f=e[a];f.ordinal=a;var l=f.identifier=f.id||a;this.columns[l]=f,f.disclosure&&(this.disclosureColumnIdentifier=l);var c=document.createElement("col");f.width&&(c.style.width=f.width),f.element=c,o.appendChild(c);var h=document.createElement("th");h.className=l+"-column",h.columnIdentifier=l,this._headerTableHeaders[l]=h;var p=document.createElement("div");f.titleDOMFragment?p.appendChild(f.titleDOMFragment):p.textContent=f.title,h.appendChild(p),f.sort&&(h.addStyleClass("sort-"+f.sort),this._sortColumnCell=h),f.sortable&&(h.addEventListener("click",this._clickInHeaderCell.bind(this),!1),h.addStyleClass("sortable")),s.appendChild(h),u.createChild("td",l+"-column")}s.createChild("th","corner"),u.createChild("td","corner"),o.createChild("col","corner"),this._headerTableColumnGroup=o,this._headerTable.appendChild(this._headerTableColumnGroup),this.headerTableBody.appendChild(s),this._dataTableColumnGroup=o.cloneNode(!0),this._dataTable.appendChild(this._dataTableColumnGroup),this.dataTableBody.appendChild(u),this.selectedNode=null,this.expandNodesWhenArrowing=!1,this.setRootNode(new WebInspector.DataGridNode),this.indentWidth=15,this.resizers=[],this._columnWidthsInitialized=!1},WebInspector.DataGrid.ColumnDescriptor,WebInspector.DataGrid.Events={SelectedNode:"SelectedNode",DeselectedNode:"DeselectedNode",SortingChanged:"SortingChanged",ColumnsResized:"ColumnsResized"},WebInspector.DataGrid.Order={Ascending:"ascending",Descending:"descending"},WebInspector.DataGrid.Align={Center:"center",Right:"right"},WebInspector.DataGrid.createSortableDataGrid=function(e,t){function c(){function o(e,i){var s=e.data[t],o=i.data[t];s=s instanceof Node?s.textContent:String(s),o=o instanceof Node?o.textContent:String(o);var u;if(r){var a=parseFloat(s),f=parseFloat(o);u=a<f?-1:a>f?1:0}else u=s<o?-1:s>o?1:0;return n*u}var e=f._rootNode.children.slice(),t=f.sortColumnIdentifier(),n=f.isSortOrderAscending()?1:-1,r=!0;for(var i=0;i<e.length;i++){var s=e[i].data[t];s=s instanceof Node?Number(s.textContent):Number(s);if(isNaN(s)){r=!1;break}}e.sort(o),f.rootNode().removeChildren();for(var i=0;i<e.length;i++)f._rootNode.appendChild(e[i])}var n=e.length;if(!n)return null;var r=[];for(var i=0;i<e.length;++i)r.push({title:e[i],width:e[i].length,sortable:!0});var s=[];for(var i=0;i<t.length/n;++i){var o={};for(var u=0;u<e.length;++u)o[u]=t[n*i+u];var a=new WebInspector.DataGridNode(o,!1);a.selectable=!1,s.push(a)}var f=new WebInspector.DataGrid(r),l=s.length;for(var i=0;i<l;++i)f.rootNode().appendChild(s[i]);return f.addEventListener(WebInspector.DataGrid.Events.SortingChanged,c,this),f},WebInspector.DataGrid.prototype={setRootNode:function(e){this._rootNode&&(this._rootNode.removeChildren(),this._rootNode.dataGrid=null,this._rootNode._isRoot=!1),this._rootNode=e,e._isRoot=!0,e.hasChildren=!1,e._expanded=!0,e._revealed=!0,e.dataGrid=this},rootNode:function(){return this._rootNode},_ondblclick:function(e){if(this._editing||this._editingNode)return;var t=this.columnIdentifierFromNode(e.target);if(!t||!this.columns[t].editable)return;this._startEditing(e.target)},_startEditingColumnOfDataGridNode:function(e,t){this._editing=!0,this._editingNode=e,this._editingNode.select();var n=this._editingNode._element.children[t];WebInspector.startEditing(n,this._startEditingConfig(n)),window.getSelection().setBaseAndExtent(n,0,n,1)},_startEditing:function(e){var t=e.enclosingNodeOrSelfWithNodeName("td");if(!t)return;this._editingNode=this.dataGridNodeFromNode(e);if(!this._editingNode){if(!this.creationNode)return;this._editingNode=this.creationNode}if(this._editingNode.isCreationNode)return this._startEditingColumnOfDataGridNode(this._editingNode,this._nextEditableColumn(-1));this._editing=!0,WebInspector.startEditing(t,this._startEditingConfig(t)),window.getSelection().setBaseAndExtent(t,0,t,1)},renderInline:function(){this.element.addStyleClass("inline")},_startEditingConfig:function(e){return new WebInspector.EditingConfig(this._editingCommitted.bind(this),this._editingCancelled.bind(this),e.textContent)},_editingCommitted:function(e,t,n,r,i){function f(e){if(!i)return;if(i==="forward"){var t=this._nextEditableColumn(-1);if(a.isCreationNode&&o===t&&!e)return;var n=this._nextEditableColumn(o);if(n!==-1)return this._startEditingColumnOfDataGridNode(a,n);var r=a.traverseNextNode(!0,null,!0);if(r)return this._startEditingColumnOfDataGridNode(r,t);if(a.isCreationNode&&e)return this.addCreationNode(!1),this._startEditingColumnOfDataGridNode(this.creationNode,t);return}if(i==="backward"){var s=this._nextEditableColumn(o,!0);if(s!==-1)return this._startEditingColumnOfDataGridNode(a,s);var u=this._nextEditableColumn(this._columnsArray.length,!0),r=a.traversePreviousNode(!0,!0);if(r)return this._startEditingColumnOfDataGridNode(r,u);return}}var s=this.columnIdentifierFromNode(e);if(!s){this._editingCancelled(e);return}var o=this.columns[s].ordinal,u=this._editingNode.data[s],a=this._editingNode;if(u==t){this._editingCancelled(e),f.call(this,!1);return}this._editingNode.data[s]=t,this._editCallback(this._editingNode,s,u,t),this._editingNode.isCreationNode&&this.addCreationNode(!1),this._editingCancelled(e),f.call(this,!0)},_editingCancelled:function(e){delete this._editing,this._editingNode=null},_nextEditableColumn:function(e,t){var n=t?-1:1,r=this._columnsArray;for(var i=e+n;i>=0&&i<r.length;i+=n)if(r[i].editable)return i;return-1},sortColumnIdentifier:function(){return this._sortColumnCell?this._sortColumnCell.columnIdentifier:null},sortOrder:function(){return!this._sortColumnCell||this._sortColumnCell.hasStyleClass("sort-ascending")?WebInspector.DataGrid.Order.Ascending:this._sortColumnCell.hasStyleClass("sort-descending")?WebInspector.DataGrid.Order.Descending:null},isSortOrderAscending:function(){return!this._sortColumnCell||this._sortColumnCell.hasStyleClass("sort-ascending")},get headerTableBody(){return"_headerTableBody"in this?this._headerTableBody:(this._headerTableBody=this._headerTable.getElementsByTagName("tbody")[0],this._headerTableBody||(this._headerTableBody=this.element.ownerDocument.createElement("tbody"),this._headerTable.insertBefore(this._headerTableBody,this._headerTable.tFoot)),this._headerTableBody)},get dataTableBody(){return"_dataTableBody"in this?this._dataTableBody:(this._dataTableBody=this._dataTable.getElementsByTagName("tbody")[0],this._dataTableBody||(this._dataTableBody=this.element.ownerDocument.createElement("tbody"),this._dataTable.insertBefore(this._dataTableBody,this._dataTable.tFoot)),this._dataTableBody)},_autoSizeWidths:function(e,t,n){t&&(t=Math.min(t,Math.floor(100/e.length)));var r=0;for(var i=0;i<e.length;++i)r+=e[i];var s=0;for(var i=0;i<e.length;++i){var o=Math.round(100*e[i]/r);t&&o<t?o=t:n&&o>n&&(o=n),s+=o,e[i]=o}var u=s-100;while(t&&u>0)for(var i=0;i<e.length;++i)if(e[i]>t){--e[i],--u;if(!u)break}while(n&&u<0)for(var i=0;i<e.length;++i)if(e[i]<n){++e[i],++u;if(!u)break}return e},autoSizeColumns:function(e,t,n){var r=[];for(var i=0;i<this._columnsArray.length;++i)r.push((this._columnsArray[i].title||"").length);n=n||0;var s=this._enumerateChildren(this._rootNode,[],n+1);for(var i=0;i<s.length;++i){var o=s[i];for(var u=0;u<this._columnsArray.length;++u){var a=o.data[this._columnsArray[u].identifier]||"";a.length>r[u]&&(r[u]=a.length)}}r=this._autoSizeWidths(r,e,t);for(var i=0;i<this._columnsArray.length;++i)this._columnsArray[i].element.style.width=r[i]+"%";this._columnWidthsInitialized=!1,this.updateWidths()},_enumerateChildren:function(e,t,n){e._isRoot||t.push(e);if(!n)return;for(var r=0;r<e.children.length;++r)this._enumerateChildren(e.children[r],t,n-1);return t},onResize:function(){this.updateWidths()},updateWidths:function(){var e=this._headerTableColumnGroup.children,t=this._dataTable.offsetWidth,n=e.length-1;if(!this._columnWidthsInitialized&&this.element.offsetWidth){for(var r=0;r<n;r++){var i=this.headerTableBody.rows[0].cells[r].offsetWidth,s=i/t*100+"%";this._headerTableColumnGroup.children[r].style.width=s,this._dataTableColumnGroup.children[r].style.width=s}this._columnWidthsInitialized=!0}this._positionResizers(),this.dispatchEventToListeners(WebInspector.DataGrid.Events.ColumnsResized)},setName:function(e){this._columnWeightsSetting=WebInspector.settings.createSetting("dataGrid-"+e+"-columnWeights",{}),this._loadColumnWeights()},_loadColumnWeights:function(){if(!this._columnWeightsSetting)return;var e=this._columnWeightsSetting.get();for(var t=0;t<this._columnsArray.length;++t){var n=this._columnsArray[t],r=e[n.identifier];r&&(n.weight=r)}this.applyColumnWeights()},_saveColumnWeights:function(){if(!this._columnWeightsSetting)return;var e={};for(var t=0;t<this._columnsArray.length;++t){var n=this._columnsArray[t];e[n.identifier]=n.weight}this._columnWeightsSetting.set(e)},wasShown:function(){this._loadColumnWeights()},applyColumnWeights:function(){var e=0;for(var t=0;t<this._columnsArray.length;++t){var n=this._columnsArray[t];this.isColumnVisible(n)&&(e+=n.weight)}var r=100/e;for(var t=0;t<this._columnsArray.length;++t){var n=this._columnsArray[t],i=this.isColumnVisible(n)?r*n.weight+"%":"0%";this._headerTableColumnGroup.children[t].style.width=i,this._dataTableColumnGroup.children[t].style.width=i}this._positionResizers(),this.dispatchEventToListeners(WebInspector.DataGrid.Events.ColumnsResized)},isColumnVisible:function(e){return!e.hidden},setColumnVisible:function(e,t){if(t===!this.columns[e].hidden)return;this.columns[e].hidden=!t,this.element.enableStyleClass("hide-"+e+"-column",!t)},get scrollContainer(){return this._scrollContainer},isScrolledToLastRow:function(){return this._scrollContainer.isScrolledToBottom()},scrollToLastRow:function(){this._scrollContainer.scrollTop=this._scrollContainer.scrollHeight-this._scrollContainer.offsetHeight},_positionResizers:function(){var e=this._headerTableColumnGroup.children,t=e.length-1,n=0,r=null;for(var i=0;i<t-1;i++){var s=this.resizers[i];s||(s=document.createElement("div"),s.addStyleClass("data-grid-resizer"),WebInspector.installDragHandle(s,this._startResizerDragging.bind(this),this._resizerDragging.bind(this),this._endResizerDragging.bind(this),"col-resize"),this.element.appendChild(s),this.resizers[i]=s),n+=this.headerTableBody.rows[0].cells[i].offsetWidth,this._columnsArray[i].hidden?(r&&r._position!==n&&(r._position=n,r.style.left=n+"px"),s.style.setProperty("display","none"),s.leftNeighboringColumnIndex=0,s.rightNeighboringColumnIndex=0):(s.style.removeProperty("display"),s._position!==n&&(s._position=n,s.style.left=n+"px"),s.leftNeighboringColumnIndex=i,r&&(r.rightNeighboringColumnIndex=i),r=s)}r&&(r.rightNeighboringColumnIndex=t-1)},addCreationNode:function(e){this.creationNode&&this.creationNode.makeNormal();var t={};for(var n in this.columns)t[n]=null;this.creationNode=new WebInspector.CreationDataGridNode(t,e),this.rootNode().appendChild(this.creationNode)},sortNodes:function(e,t){function n(n,r){if(n._dataGridNode._data.summaryRow)return 1;if(r._dataGridNode._data.summaryRow)return-1;var i=n._dataGridNode,s=r._dataGridNode;return t?e(s,i):e(i,s)}var r=this.dataTableBody,i=r.parentElement;i.removeChild(r);var s=r.childNodes,o=s[s.length-1],u=Array.prototype.slice.call(s,0,s.length-1);u.sort(n);var a=u.length;r.removeChildren();var f=null;for(var l=0;l<a;++l){var c=u[l],h=c._dataGridNode;h.previousSibling=f,f&&(f.nextSibling=h),r.appendChild(c),f=h}f&&(f.nextSibling=null),r.appendChild(o),i.appendChild(r)},_keyDown:function(e){if(!this.selectedNode||e.shiftKey||e.metaKey||e.ctrlKey||this._editing)return;var t=!1,n;if(e.keyIdentifier==="Up"&&!e.altKey){n=this.selectedNode.traversePreviousNode(!0);while(n&&!n.selectable)n=n.traversePreviousNode(!0);t=n?!0:!1}else if(e.keyIdentifier==="Down"&&!e.altKey){n=this.selectedNode.traverseNextNode(!0);while(n&&!n.selectable)n=n.traverseNextNode(!0);t=n?!0:!1}else e.keyIdentifier==="Left"?this.selectedNode.expanded?(e.altKey?this.selectedNode.collapseRecursively():this.selectedNode.collapse(),t=!0):this.selectedNode.parent&&!this.selectedNode.parent._isRoot&&(t=!0,this.selectedNode.parent.selectable?(n=this.selectedNode.parent,t=n?!0:!1):this.selectedNode.parent&&this.selectedNode.parent.collapse()):e.keyIdentifier==="Right"?this.selectedNode.revealed?this.selectedNode.hasChildren&&(t=!0,this.selectedNode.expanded?(n=this.selectedNode.children[0],t=n?!0:!1):e.altKey?this.selectedNode.expandRecursively():this.selectedNode.expand()):(this.selectedNode.reveal(),t=!0):e.keyCode===8||e.keyCode===46?this._deleteCallback&&(t=!0,this._deleteCallback(this.selectedNode),this.changeNodeAfterDeletion()):isEnterKey(e)&&this._editCallback&&(t=!0,this._startEditing(this.selectedNode._element.children[this._nextEditableColumn(-1)]));n&&(n.reveal(),n.select()),t&&e.consume(!0)},changeNodeAfterDeletion:function(){var e=this.selectedNode.traverseNextNode(!0);while(e&&!e.selectable)e=e.traverseNextNode(!0);if(!e||e.isCreationNode){e=this.selectedNode.traversePreviousNode(!0);while(e&&!e.selectable)e=e.traversePreviousNode(!0)}e&&(e.reveal(),e.select())},dataGridNodeFromNode:function(e){var t=e.enclosingNodeOrSelfWithNodeName("tr");return t&&t._dataGridNode},columnIdentifierFromNode:function(e){var t=e.enclosingNodeOrSelfWithNodeName("td");return t&&t.columnIdentifier_},_clickInHeaderCell:function(e){var t=e.target.enclosingNodeOrSelfWithNodeName("th");if(!t||typeof t.columnIdentifier=="undefined"||!t.hasStyleClass("sortable"))return;var n=WebInspector.DataGrid.Order.Ascending;t===this._sortColumnCell&&this.isSortOrderAscending()&&(n=WebInspector.DataGrid.Order.Descending),this._sortColumnCell&&this._sortColumnCell.removeMatchingStyleClasses("sort-\\w+"),this._sortColumnCell=t,t.addStyleClass("sort-"+n),this.dispatchEventToListeners(WebInspector.DataGrid.Events.SortingChanged)},markColumnAsSortedBy:function(e,t){this._sortColumnCell&&this._sortColumnCell.removeMatchingStyleClasses("sort-\\w+"),this._sortColumnCell=this._headerTableHeaders[e],this._sortColumnCell.addStyleClass("sort-"+t)},headerTableHeader:function(e){return this._headerTableHeaders[e]},_mouseDownInDataTable:function(e){var t=this.dataGridNodeFromNode(e.target);if(!t||!t.selectable)return;if(t.isEventWithinDisclosureTriangle(e))return;e.metaKey?t.selected?t.deselect():t.select():t.select()},_contextMenuInDataTable:function(e){var t=new WebInspector.ContextMenu(e),n=this.dataGridNodeFromNode(e.target);this._refreshCallback&&(!n||n!==this.creationNode)&&t.appendItem(WebInspector.UIString("Refresh"),this._refreshCallback.bind(this));if(n&&n.selectable&&!n.isEventWithinDisclosureTriangle(e)){if(this._editCallback)if(n===this.creationNode)t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add new":"Add New"),this._startEditing.bind(this,e.target));else{var r=this.columnIdentifierFromNode(e.target);r&&this.columns[r].editable&&t.appendItem(WebInspector.UIString("Edit"),this._startEditing.bind(this,e.target))}this._deleteCallback&&n!==this.creationNode&&t.appendItem(WebInspector.UIString("Delete"),this._deleteCallback.bind(this,n)),this._contextMenuCallback&&this._contextMenuCallback(t,n)}t.show()},_clickInDataTable:function(e){var t=this.dataGridNodeFromNode(e.target);if(!t||!t.hasChildren)return;if(!t.isEventWithinDisclosureTriangle(e))return;t.expanded?e.altKey?t.collapseRecursively():t.collapse():e.altKey?t.expandRecursively():t.expand()},get resizeMethod(){return typeof this._resizeMethod=="undefined"?WebInspector.DataGrid.ResizeMethod.Nearest:this._resizeMethod},set resizeMethod(e){this._resizeMethod=e},_startResizerDragging:function(e){return this._currentResizer=e.target,!!this._currentResizer.rightNeighboringColumnIndex},_resizerDragging:function(e){var t=this._currentResizer;if(!t)return;var n=this._dataTable.offsetWidth,r=e.clientX-this.element.totalOffsetLeft(),i=t.leftNeighboringColumnIndex,s=t.rightNeighboringColumnIndex,o=this.headerTableBody.rows[0].cells,u=0;for(var a=0;a<i;a++)u+=o[a].offsetWidth;this.resizeMethod==WebInspector.DataGrid.ResizeMethod.Last?s=this.resizers.length:this.resizeMethod==WebInspector.DataGrid.ResizeMethod.First&&(u+=o[i].offsetWidth-o[0].offsetWidth,i=0);var f=u+o[i].offsetWidth+o[s].offsetWidth,l=u+this.ColumnResizePadding,c=f-this.ColumnResizePadding;if(l>c)return;r=Number.constrain(r,l,c),t.style.left=r-this.CenterResizerOverBorderAdjustment+"px";var h=(r-u)/n*100+"%";this._headerTableColumnGroup.children[i].style.width=h,this._dataTableColumnGroup.children[i].style.width=h;var p=(f-r)/n*100+"%";this._headerTableColumnGroup.children[s].style.width=p,this._dataTableColumnGroup.children[s].style.width=p;var d=this._columnsArray[i],v=this._columnsArray[s];if(d.weight||v.weight){var m=d.weight+v.weight,g=f-u;d.weight=(r-u)*m/g,v.weight=(f-r)*m/g}this._positionResizers(),e.preventDefault(),this.dispatchEventToListeners(WebInspector.DataGrid.Events.ColumnsResized)},_endResizerDragging:function(e){this._currentResizer=null,this._saveColumnWeights(),this.dispatchEventToListeners(WebInspector.DataGrid.Events.ColumnsResized)},ColumnResizePadding:24,CenterResizerOverBorderAdjustment:3,__proto__:WebInspector.View.prototype},WebInspector.DataGrid.ResizeMethod={Nearest:"nearest",First:"first",Last:"last"},WebInspector.DataGridNode=function(e,t){this._expanded=!1,this._selected=!1,this._shouldRefreshChildren=!0,this._data=e||{},this.hasChildren=t||!1,this.children=[],this.dataGrid=null,this.parent=null,this.previousSibling=null,this.nextSibling=null,this.disclosureToggleWidth=10},WebInspector.DataGridNode.prototype={selectable:!0,_isRoot:!1,get element(){return this._element?this._element:this.dataGrid?(this._element=document.createElement("tr"),this._element._dataGridNode=this,this.hasChildren&&this._element.addStyleClass("parent"),this.expanded&&this._element.addStyleClass("expanded"),this.selected&&this._element.addStyleClass("selected"),this.revealed&&this._element.addStyleClass("revealed"),this.createCells(),this._element.createChild("td","corner"),this._element):null},createCells:function(){var e=this.dataGrid._columnsArray;for(var t=0;t<e.length;++t){var n=this.createCell(e[t].identifier);this._element.appendChild(n)}},get data(){return this._data},set data(e){this._data=e||{},this.refresh()},get revealed(){if("_revealed"in this)return this._revealed;var e=this.parent;while(e&&!e._isRoot){if(!e.expanded)return this._revealed=!1,!1;e=e.parent}return this._revealed=!0,!0},set hasChildren(e){if(this._hasChildren===e)return;this._hasChildren=e;if(!this._element)return;this._element.enableStyleClass("parent",this._hasChildren),this._element.enableStyleClass("expanded",this._hasChildren&&this.expanded)},get hasChildren(){return this._hasChildren},set revealed(e){if(this._revealed===e)return;this._revealed=e,this._element&&this._element.enableStyleClass("revealed",this._revealed);for(var t=0;t<this.children.length;++t)this.children[t].revealed=e&&this.expanded},get depth(){return"_depth"in this?this._depth:(this.parent&&!this.parent._isRoot?this._depth=this.parent.depth+1:this._depth=0,this._depth)},get leftPadding(){return typeof this._leftPadding=="number"?this._leftPadding:(this._leftPadding=this.depth*this.dataGrid.indentWidth,this._leftPadding)},get shouldRefreshChildren(){return this._shouldRefreshChildren},set shouldRefreshChildren(e){this._shouldRefreshChildren=e,e&&this.expanded&&this.expand()},get selected(){return this._selected},set selected(e){e?this.select():this.deselect()},get expanded(){return this._expanded},set expanded(e){e?this.expand():this.collapse()},refresh:function(){if(!this._element||!this.dataGrid)return;this._element.removeChildren(),this.createCells(),this._element.createChild("td","corner")},createTD:function(e){var t=document.createElement("td");t.className=e+"-column",t.columnIdentifier_=e;var n=this.dataGrid.columns[e].align;return n&&t.addStyleClass(n),t},createCell:function(e){var t=this.createTD(e),n=this.data[e],r=document.createElement("div");return n instanceof Node?r.appendChild(n):(r.textContent=n,this.dataGrid.columns[e].longText&&(r.title=n)),t.appendChild(r),e===this.dataGrid.disclosureColumnIdentifier&&(t.addStyleClass("disclosure"),this.leftPadding&&t.style.setProperty("padding-left",this.leftPadding+"px")),t},nodeHeight:function(){var e=16;if(!this.revealed)return 0;if(!this.expanded)return e;var t=e;for(var n=0;n<this.children.length;n++)t+=this.children[n].nodeHeight();return t},appendChild:function(e){this.insertChild(e,this.children.length)},insertChild:function(e,t){if(!e)throw"insertChild: Node can't be undefined or null.";if(e.parent===this)throw"insertChild: Node is already a child of this node.";e.parent&&e.parent.removeChild(e),this.children.splice(t,0,e),this.hasChildren=!0,e.parent=this,e.dataGrid=this.dataGrid,e._recalculateSiblings(t),delete e._depth,delete e._revealed,delete e._attached,e._shouldRefreshChildren=!0;var n=e.children[0];while(n)n.dataGrid=this.dataGrid,delete n._depth,delete n._revealed,delete n._attached,n._shouldRefreshChildren=!0,n=n.traverseNextNode(!1,e,!0);this.expanded&&e._attach(),this.revealed||(e.revealed=!1)},removeChild:function(e){if(!e)throw"removeChild: Node can't be undefined or null.";if(e.parent!==this)throw"removeChild: Node is not a child of this node.";e.deselect(),e._detach(),this.children.remove(e,!0),e.previousSibling&&(e.previousSibling.nextSibling=e.nextSibling),e.nextSibling&&(e.nextSibling.previousSibling=e.previousSibling),e.dataGrid=null,e.parent=null,e.nextSibling=null,e.previousSibling=null,this.children.length<=0&&(this.hasChildren=!1)},removeChildren:function(){for(var e=0;e<this.children.length;++e){var t=this.children[e];t.deselect(),t._detach(),t.dataGrid=null,t.parent=null,t.nextSibling=null,t.previousSibling=null}this.children=[],this.hasChildren=!1},_recalculateSiblings:function(e){if(!this.parent)return;var t=e>0?this.parent.children[e-1]:null;t?(t.nextSibling=this,this.previousSibling=t):this.previousSibling=null;var n=this.parent.children[e+1];n?(n.previousSibling=this,this.nextSibling=n):this.nextSibling=null},collapse:function(){if(this._isRoot)return;this._element&&this._element.removeStyleClass("expanded"),this._expanded=!1;for(var e=0;e<this.children.length;++e)this.children[e].revealed=!1},collapseRecursively:function(){var e=this;while(e)e.expanded&&e.collapse(),e=e.traverseNextNode(!1,this,!0)},populate:function(){},expand:function(){if(!this.hasChildren||this.expanded)return;if(this._isRoot)return;if(this.revealed&&!this._shouldRefreshChildren)for(var e=0;e<this.children.length;++e)this.children[e].revealed=!0;if(this._shouldRefreshChildren){for(var e=0;e<this.children.length;++e)this.children[e]._detach();this.populate();if(this._attached)for(var e=0;e<this.children.length;++e){var t=this.children[e];this.revealed&&(t.revealed=!0),t._attach()}delete this._shouldRefreshChildren}this._element&&this._element.addStyleClass("expanded"),this._expanded=!0},expandRecursively:function(){var e=this;while(e)e.expand(),e=e.traverseNextNode(!1,this)},reveal:function(){if(this._isRoot)return;var e=this.parent;while(e&&!e._isRoot)e.expanded||e.expand(),e=e.parent;this.element.scrollIntoViewIfNeeded(!1)},select:function(e){if(!this.dataGrid||!this.selectable||this.selected)return;this.dataGrid.selectedNode&&this.dataGrid.selectedNode.deselect(),this._selected=!0,this.dataGrid.selectedNode=this,this._element&&this._element.addStyleClass("selected"),e||this.dataGrid.dispatchEventToListeners(WebInspector.DataGrid.Events.SelectedNode)},revealAndSelect:function(){if(this._isRoot)return;this.reveal(),this.select()},deselect:function(e){if(!this.dataGrid||this.dataGrid.selectedNode!==this||!this.selected)return;this._selected=!1,this.dataGrid.selectedNode=null,this._element&&this._element.removeStyleClass("selected"),e||this.dataGrid.dispatchEventToListeners(WebInspector.DataGrid.Events.DeselectedNode)},traverseNextNode:function(e,t,n,r){!n&&this.hasChildren&&this.populate(),r&&(r.depthChange=0);var i=!e||this.revealed?this.children[0]:null;if(i&&(!e||this.expanded))return r&&(r.depthChange=1),i;if(this===t)return null;i=!e||this.revealed?this.nextSibling:null;if(i)return i;i=this;while(i&&!i._isRoot&&(!e||i.revealed?!i.nextSibling:!0)&&i.parent!==t)r&&(r.depthChange-=1),i=i.parent;return i?!e||i.revealed?i.nextSibling:null:null},traversePreviousNode:function(e,t){var n=!e||this.revealed?this.previousSibling:null;!t&&n&&n.hasChildren&&n.populate();while(n&&(!e||n.revealed&&n.expanded?n.children[n.children.length-1]:null))!t&&n.hasChildren&&n.populate(),n=!e||n.revealed&&n.expanded?n.children[n.children.length-1]:null;return n?n:!this.parent||this.parent._isRoot?null:this.parent},isEventWithinDisclosureTriangle:function(e){if(!this.hasChildren)return!1;var t=e.target.enclosingNodeOrSelfWithNodeName("td");if(!t.hasStyleClass("disclosure"))return!1;var n=t.totalOffsetLeft()+this.leftPadding;return e.pageX>=n&&e.pageX<=n+this.disclosureToggleWidth},_attach:function(){if(!this.dataGrid||this._attached)return;this._attached=!0;var e=null,t=this.traversePreviousNode(!0,!0);t&&t.element.parentNode&&t.element.nextSibling&&(e=t.element.nextSibling),e||(e=this.dataGrid.dataTableBody.firstChild),this.dataGrid.dataTableBody.insertBefore(this.element,e);if(this.expanded)for(var n=0;n<this.children.length;++n)this.children[n]._attach()},_detach:function(){if(!this._attached)return;this._attached=!1,this._element&&this._element.remove();for(var e=0;e<this.children.length;++e)this.children[e]._detach();this.wasDetached()},wasDetached:function(){},savePosition:function(){if(this._savedPosition)return;if(!this.parent)throw"savePosition: Node must have a parent.";this._savedPosition={parent:this.parent,index:this.parent.children.indexOf(this)}},restorePosition:function(){if(!this._savedPosition)return;this.parent!==this._savedPosition.parent&&this._savedPosition.parent.insertChild(this,this._savedPosition.index),delete this._savedPosition},__proto__:WebInspector.Object.prototype},WebInspector.CreationDataGridNode=function(e,t){WebInspector.DataGridNode.call(this,e,t),this.isCreationNode=!0},WebInspector.CreationDataGridNode.prototype={makeNormal:function(){delete this.isCreationNode,delete this.makeNormal},__proto__:WebInspector.DataGridNode.prototype};