/*
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) IBM Corp. 2009  All rights reserved.
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.RequestHeadersView=function(e){WebInspector.View.call(this),this.registerRequiredCSS("resourceView.css"),this.element.addStyleClass("resource-headers-view"),this._request=e,this._headersListElement=document.createElement("ol"),this._headersListElement.className="outline-disclosure",this.element.appendChild(this._headersListElement),this._headersTreeOutline=new TreeOutline(this._headersListElement),this._headersTreeOutline.expandTreeElementsWhenArrowing=!0,this._urlTreeElement=new TreeElement("",null,!1),this._urlTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._urlTreeElement),this._requestMethodTreeElement=new TreeElement("",null,!1),this._requestMethodTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._requestMethodTreeElement),this._statusCodeTreeElement=new TreeElement("",null,!1),this._statusCodeTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._statusCodeTreeElement),this._requestHeadersTreeElement=new TreeElement("",null,!0),this._requestHeadersTreeElement.expanded=!0,this._requestHeadersTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._requestHeadersTreeElement),this._decodeRequestParameters=!0,this._showRequestHeadersText=!1,this._showResponseHeadersText=!1,this._queryStringTreeElement=new TreeElement("",null,!0),this._queryStringTreeElement.expanded=!0,this._queryStringTreeElement.selectable=!1,this._queryStringTreeElement.hidden=!0,this._headersTreeOutline.appendChild(this._queryStringTreeElement),this._urlFragmentTreeElement=new TreeElement("",null,!0),this._urlFragmentTreeElement.expanded=!0,this._urlFragmentTreeElement.selectable=!1,this._urlFragmentTreeElement.hidden=!0,this._headersTreeOutline.appendChild(this._urlFragmentTreeElement),this._formDataTreeElement=new TreeElement("",null,!0),this._formDataTreeElement.expanded=!0,this._formDataTreeElement.selectable=!1,this._formDataTreeElement.hidden=!0,this._headersTreeOutline.appendChild(this._formDataTreeElement),this._requestPayloadTreeElement=new TreeElement(WebInspector.UIString("Request Payload"),null,!0),this._requestPayloadTreeElement.expanded=!0,this._requestPayloadTreeElement.selectable=!1,this._requestPayloadTreeElement.hidden=!0,this._headersTreeOutline.appendChild(this._requestPayloadTreeElement),this._responseHeadersTreeElement=new TreeElement("",null,!0),this._responseHeadersTreeElement.expanded=!0,this._responseHeadersTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._responseHeadersTreeElement)},WebInspector.RequestHeadersView.prototype={wasShown:function(){this._request.addEventListener(WebInspector.NetworkRequest.Events.RequestHeadersChanged,this._refreshRequestHeaders,this),this._request.addEventListener(WebInspector.NetworkRequest.Events.ResponseHeadersChanged,this._refreshResponseHeaders,this),this._request.addEventListener(WebInspector.NetworkRequest.Events.FinishedLoading,this._refreshHTTPInformation,this),this._refreshURL(),this._refreshQueryString(),this._refreshUrlFragment(),this._refreshRequestHeaders(),this._refreshResponseHeaders(),this._refreshHTTPInformation()},willHide:function(){this._request.removeEventListener(WebInspector.NetworkRequest.Events.RequestHeadersChanged,this._refreshRequestHeaders,this),this._request.removeEventListener(WebInspector.NetworkRequest.Events.ResponseHeadersChanged,this._refreshResponseHeaders,this),this._request.removeEventListener(WebInspector.NetworkRequest.Events.FinishedLoading,this._refreshHTTPInformation,this)},_formatHeader:function(e,t){var n=document.createDocumentFragment();return n.createChild("div","header-name").textContent=e+":",n.createChild("div","header-value source-code").textContent=t,n},_formatParameter:function(e,t,n){var r=!1;if(n){e=e.replace(/\+/g," ");if(e.indexOf("%")>=0)try{e=decodeURIComponent(e)}catch(i){r=!0}}var s=document.createElement("div");return s.className=t,r?s.createChild("span","error-message").textContent=WebInspector.UIString("(unable to decode value)"):s.textContent=e,s},_refreshURL:function(){this._urlTreeElement.title=this._formatHeader(WebInspector.UIString("Request URL"),this._request.url)},_refreshQueryString:function(){var e=this._request.queryString(),t=this._request.queryParameters;this._queryStringTreeElement.hidden=!t,t&&this._refreshParams(WebInspector.UIString("Query String Parameters"),t,e,this._queryStringTreeElement)},_refreshUrlFragment:function(){var e=this._request.parsedURL.fragment;this._urlFragmentTreeElement.hidden=!e;if(!e)return;var t=WebInspector.UIString("URL fragment");this._urlFragmentTreeElement.removeChildren(),this._urlFragmentTreeElement.listItemElement.removeChildren(),this._urlFragmentTreeElement.listItemElement.appendChild(document.createTextNode(t));var n=new TreeElement(null,null,!1);n.title=this._formatHeader("#",e),n.selectable=!1,this._urlFragmentTreeElement.appendChild(n)},_refreshFormData:function(){this._formDataTreeElement.hidden=!0,this._requestPayloadTreeElement.hidden=!0;var e=this._request.requestFormData;if(!e)return;var t=this._request.formParameters;if(t)this._formDataTreeElement.hidden=!1,this._refreshParams(WebInspector.UIString("Form Data"),t,e,this._formDataTreeElement);else{this._requestPayloadTreeElement.hidden=!1;try{var n=JSON.parse(e);this._refreshRequestJSONPayload(n,e,!1)}catch(r){this._populateTreeElementWithSourceText(this._requestPayloadTreeElement,e)}}},_populateTreeElementWithSourceText:function(e,t){e.removeChildren();var n=new TreeElement(null,null,!1);n.selectable=!1,e.appendChild(n);var r=document.createElement("span");r.addStyleClass("header-value"),r.addStyleClass("source-code"),r.textContent=String(t).trim(),n.listItemElement.appendChild(r)},_refreshParams:function(e,t,n,r){function s(){r._viewSource=!r._viewSource,this._refreshParams(e,t,n,r)}r.removeChildren(),r.listItemElement.removeChildren(),r.listItemElement.appendChild(document.createTextNode(e));var i=document.createElement("span");i.addStyleClass("header-count"),i.textContent=WebInspector.UIString(" (%d)",t.length),r.listItemElement.appendChild(i),r.listItemElement.appendChild(this._createViewSourceToggle(r._viewSource,s.bind(this)));if(r._viewSource){this._populateTreeElementWithSourceText(r,n);return}var o=this._decodeRequestParameters?WebInspector.UIString("view URL encoded"):WebInspector.UIString("view decoded"),u=this._createToggleButton(o);u.addEventListener("click",this._toggleURLDecoding.bind(this)),r.listItemElement.appendChild(u);for(var a=0;a<t.length;++a){var f=document.createDocumentFragment(),l=this._formatParameter(t[a].name+":","header-name",this._decodeRequestParameters),c=this._formatParameter(t[a].value,"header-value source-code",this._decodeRequestParameters);f.appendChild(l),f.appendChild(c);var h=new TreeElement(f,null,!1);h.selectable=!1,r.appendChild(h)}},_refreshRequestJSONPayload:function(e,t,n){this._requestPayloadTreeElement.removeChildren();var r=this._requestPayloadTreeElement.listItemElement;r.removeChildren(),r.appendChild(document.createTextNode(this._requestPayloadTreeElement.title));var i=this._refreshRequestJSONPayload.bind(this,e,t);if(n)r.appendChild(this._createViewSourceToggle(!0,i.bind(this,!1))),this._populateTreeElementWithSourceText(this._requestPayloadTreeElement,t);else{r.appendChild(this._createViewSourceToggle(!1,i.bind(this,!0)));var s=WebInspector.RemoteObject.fromLocalObject(e),o=new WebInspector.ObjectPropertiesSection(s,s.description);o.expand(),o.editable=!1,r.appendChild(o.element)}},_createViewSourceToggle:function(e,t){var n=e?WebInspector.UIString("view parsed"):WebInspector.UIString("view source"),r=this._createToggleButton(n);return r.addEventListener("click",t),r},_toggleURLDecoding:function(e){this._decodeRequestParameters=!this._decodeRequestParameters,this._refreshQueryString(),this._refreshFormData()},_getHeaderValue:function(e,t){var n=t.toLowerCase();for(var r in e)if(r.toLowerCase()===n)return e[r]},_refreshRequestHeaders:function(){this._showRequestHeadersText?this._refreshHeadersText(WebInspector.UIString("Request Headers"),this._request.sortedRequestHeaders,this._request.requestHeadersText,this._requestHeadersTreeElement):this._refreshHeaders(WebInspector.UIString("Request Headers"),this._request.sortedRequestHeaders,this._requestHeadersTreeElement);if(this._request.requestHeadersText){var e=this._createHeadersToggleButton(this._showRequestHeadersText);e.addEventListener("click",this._toggleRequestHeadersText.bind(this)),this._requestHeadersTreeElement.listItemElement.appendChild(e)}this._refreshFormData()},_refreshResponseHeaders:function(){this._showResponseHeadersText?this._refreshHeadersText(WebInspector.UIString("Response Headers"),this._request.sortedResponseHeaders,this._request.responseHeadersText,this._responseHeadersTreeElement):this._refreshHeaders(WebInspector.UIString("Response Headers"),this._request.sortedResponseHeaders,this._responseHeadersTreeElement);if(this._request.responseHeadersText){var e=this._createHeadersToggleButton(this._showResponseHeadersText);e.addEventListener("click",this._toggleResponseHeadersText.bind(this)),this._responseHeadersTreeElement.listItemElement.appendChild(e)}},_refreshHTTPInformation:function(){var e=this._requestMethodTreeElement;e.hidden=!this._request.statusCode;var t=this._statusCodeTreeElement;t.hidden=!this._request.statusCode;if(this._request.statusCode){var n=document.createDocumentFragment();n.createChild("div","header-name").textContent=WebInspector.UIString("Status Code")+":";var r=n.createChild("div","resource-status-image");r.title=this._request.statusCode+" "+this._request.statusText,this._request.statusCode<300||this._request.statusCode===304?r.addStyleClass("green-ball"):this._request.statusCode<400?r.addStyleClass("orange-ball"):r.addStyleClass("red-ball"),e.title=this._formatHeader(WebInspector.UIString("Request Method"),this._request.requestMethod);var i=n.createChild("div","header-value source-code");i.textContent=this._request.statusCode+" "+this._request.statusText,this._request.cached&&(i.createChild("span","status-from-cache").textContent=" "+WebInspector.UIString("(from cache)")),t.title=n}},_refreshHeadersTitle:function(e,t,n){t.listItemElement.removeChildren(),t.listItemElement.appendChild(document.createTextNode(e));var r=document.createElement("span");r.addStyleClass("header-count"),r.textContent=WebInspector.UIString(" (%d)",n),t.listItemElement.appendChild(r)},_refreshHeaders:function(e,t,n){n.removeChildren();var r=t.length;this._refreshHeadersTitle(e,n,r),n.hidden=!r;for(var i=0;i<r;++i){var s=new TreeElement(null,null,!1);s.title=this._formatHeader(t[i].name,t[i].value),s.selectable=!1,n.appendChild(s)}},_refreshHeadersText:function(e,t,n,r){this._populateTreeElementWithSourceText(r,n),this._refreshHeadersTitle(e,r,t.length)},_toggleRequestHeadersText:function(e){this._showRequestHeadersText=!this._showRequestHeadersText,this._refreshRequestHeaders()},_toggleResponseHeadersText:function(e){this._showResponseHeadersText=!this._showResponseHeadersText,this._refreshResponseHeaders()},_createToggleButton:function(e){var t=document.createElement("span");return t.addStyleClass("header-toggle"),t.textContent=e,t},_createHeadersToggleButton:function(e){var t=e?WebInspector.UIString("view parsed"):WebInspector.UIString("view source");return this._createToggleButton(t)},__proto__:WebInspector.View.prototype};