/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.BreakpointManager=function(e,t,n){this._storage=new WebInspector.BreakpointManager.Storage(this,e),this._debuggerModel=t,this._workspace=n,this._breakpoints=new Map,this._breakpointForDebuggerId={},this._breakpointsForUISourceCode=new Map,this._sourceFilesWithRestoredBreakpoints={},this._debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.BreakpointResolved,this._breakpointResolved,this),this._workspace.addEventListener(WebInspector.Workspace.Events.ProjectWillReset,this._projectWillReset,this),this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this)},WebInspector.BreakpointManager.Events={BreakpointAdded:"breakpoint-added",BreakpointRemoved:"breakpoint-removed"},WebInspector.BreakpointManager.sourceFileId=function(e){if(!e.url)return"";var t=e.formatted()?"deobfuscated:":"";return t+e.uri()},WebInspector.BreakpointManager.prototype={_restoreBreakpoints:function(e){var t=WebInspector.BreakpointManager.sourceFileId(e);if(!t||this._sourceFilesWithRestoredBreakpoints[t])return;this._sourceFilesWithRestoredBreakpoints[t]=!0;for(var n in this._breakpointForDebuggerId){var r=this._breakpointForDebuggerId[n];if(r._sourceFileId!==t)continue;r.remove(!0)}this._storage._restoreBreakpoints(e)},_uiSourceCodeAdded:function(e){var t=e.data;this._restoreBreakpoints(t);if(t.contentType()===WebInspector.resourceTypes.Script||t.contentType()===WebInspector.resourceTypes.Document)t.addEventListener(WebInspector.UISourceCode.Events.SourceMappingChanged,this._uiSourceCodeMappingChanged,this),t.addEventListener(WebInspector.UISourceCode.Events.FormattedChanged,this._uiSourceCodeFormatted,this)},_uiSourceCodeFormatted:function(e){var t=e.target;this._restoreBreakpoints(t)},_resetBreakpoints:function(e){var t=WebInspector.BreakpointManager.sourceFileId(e),n=this._breakpoints.keys();for(var r=0;r<n.length;++r){var i=n[r];if(i._sourceFileId!==t)return;i.enabled()&&(i._removeFromDebugger(),i._setInDebugger())}},_uiSourceCodeMappingChanged:function(e){var t=e.data.identityHasChanged;if(!t)return;var n=e.target;this._resetBreakpoints(n)},setBreakpoint:function(e,t,n,r){return this._debuggerModel.setBreakpointsActive(!0),this._innerSetBreakpoint(e,t,n,r)},_innerSetBreakpoint:function(e,t,n,r){var i=this.findBreakpoint(e,t);return i?(i._updateBreakpoint(n,r),i):(i=new WebInspector.BreakpointManager.Breakpoint(this,e,t,n,r),this._breakpoints.put(i),i)},findBreakpoint:function(e,t){var n=this._breakpointsForUISourceCode.get(e),r=n?n[t]:null;return r?r[0]:null},breakpointsForUISourceCode:function(e){var t=[],n=this._breakpoints.keys();for(var r=0;r<n.length;++r){var i=n[r],s=i._primaryUILocation;s.uiSourceCode===e&&t.push(i)}return t},allBreakpoints:function(){var e=[],t=this._breakpoints.keys();return t},breakpointLocationsForUISourceCode:function(e){var t=[],n=this._breakpoints.keys();for(var r=0;r<n.length;++r){var i=n[r],s=Object.values(i._uiLocations);for(var o=0;o<s.length;++o){var u=s[o];u.uiSourceCode===e&&t.push({breakpoint:i,uiLocation:s[o]})}}return t},allBreakpointLocations:function(){var e=[],t=this._breakpoints.keys();for(var n=0;n<t.length;++n){var r=t[n],i=Object.values(r._uiLocations);for(var s=0;s<i.length;++s)e.push({breakpoint:r,uiLocation:i[s]})}return e},toggleAllBreakpoints:function(e){var t=this._breakpoints.keys();for(var n=0;n<t.length;++n){var r=t[n];r.enabled()!=e&&r.setEnabled(e)}},removeAllBreakpoints:function(){var e=this._breakpoints.keys();for(var t=0;t<e.length;++t)e[t].remove()},reset:function(){this._storage._muted=!0,this.removeAllBreakpoints(),delete this._storage._muted;for(var e in this._breakpointForDebuggerId)this._debuggerModel.removeBreakpoint(e);this._breakpointForDebuggerId={},this._sourceFilesWithRestoredBreakpoints={}},_projectWillReset:function(e){var t=e.data,n=t.uiSourceCodes();for(var r=0;r<n.length;++r){var i=n[r],s=this._breakpointsForUISourceCode.get(i)||[];for(var o in s){var u=s[o];for(var a=0;a<u.length;++a){var f=u[a];f._resetLocations()}}this._breakpointsForUISourceCode.remove(i),s=this.breakpointsForUISourceCode(i);for(var a=0;a<s.length;++a){var f=s[a];this._breakpoints.remove(f)}var l=WebInspector.BreakpointManager.sourceFileId(i);delete this._sourceFilesWithRestoredBreakpoints[l]}},_breakpointResolved:function(e){var t=e.data.breakpointId,n=e.data.location,r=this._breakpointForDebuggerId[t];if(!r)return;this._breakpoints.contains(r)||this._breakpoints.put(r),r._addResolvedLocation(n)},_removeBreakpoint:function(e,t){console.assert(!e._debuggerId),this._breakpoints.remove(e),t&&this._storage._removeBreakpoint(e)},_uiLocationAdded:function(e,t){var n=this._breakpointsForUISourceCode.get(t.uiSourceCode);n||(n={},this._breakpointsForUISourceCode.put(t.uiSourceCode,n));var r=n[t.lineNumber];r||(r=[],n[t.lineNumber]=r),r.push(e),this.dispatchEventToListeners(WebInspector.BreakpointManager.Events.BreakpointAdded,{breakpoint:e,uiLocation:t})},_uiLocationRemoved:function(e,t){var n=this._breakpointsForUISourceCode.get(t.uiSourceCode);if(!n)return;var r=n[t.lineNumber];if(!r)return;r.remove(e),r.length||delete n[t.lineNumber],this.dispatchEventToListeners(WebInspector.BreakpointManager.Events.BreakpointRemoved,{breakpoint:e,uiLocation:t})},__proto__:WebInspector.Object.prototype},WebInspector.BreakpointManager.Breakpoint=function(e,t,n,r,i){this._breakpointManager=e,this._primaryUILocation=new WebInspector.UILocation(t,n,0),this._sourceFileId=WebInspector.BreakpointManager.sourceFileId(t),this._liveLocations=[],this._uiLocations={},this._condition,this._enabled,this._updateBreakpoint(r,i)},WebInspector.BreakpointManager.Breakpoint.prototype={primaryUILocation:function(){return this._primaryUILocation},_addResolvedLocation:function(e){this._liveLocations.push(this._breakpointManager._debuggerModel.createLiveLocation(e,this._locationUpdated.bind(this,e)))},_locationUpdated:function(e,t){var n=e.scriptId+":"+e.lineNumber+":"+e.columnNumber,r=this._uiLocations[n];r&&this._breakpointManager._uiLocationRemoved(this,r),this._uiLocations[""]&&(delete this._uiLocations[""],this._breakpointManager._uiLocationRemoved(this,this._primaryUILocation)),this._uiLocations[n]=t,this._breakpointManager._uiLocationAdded(this,t)},enabled:function(){return this._enabled},setEnabled:function(e){this._updateBreakpoint(this._condition,e)},condition:function(){return this._condition},setCondition:function(e){this._updateBreakpoint(e,this._enabled)},_updateBreakpoint:function(e,t){if(this._enabled===t&&this._condition===e)return;this._enabled&&this._removeFromDebugger(),this._enabled=t,this._condition=e,this._breakpointManager._storage._updateBreakpoint(this);var n=this._primaryUILocation.uiSourceCode.scriptFile();if(this._enabled&&(!n||!n.hasDivergedFromVM())&&this._setInDebugger())return;this._fakeBreakpointAtPrimaryLocation()},remove:function(e){var t=!e;this._resetLocations(),this._removeFromDebugger(),this._breakpointManager._removeBreakpoint(this,t)},_setInDebugger:function(){console.assert(!this._debuggerId);var e=this._primaryUILocation.uiLocationToRawLocation(),t=e;return t?(this._breakpointManager._debuggerModel.setBreakpointByScriptLocation(t,this._condition,this._didSetBreakpointInDebugger.bind(this)),!0):this._primaryUILocation.uiSourceCode.url?(this._breakpointManager._debuggerModel.setBreakpointByURL(this._primaryUILocation.uiSourceCode.url,this._primaryUILocation.lineNumber,0,this._condition,this._didSetBreakpointInDebugger.bind(this)),!0):!1},_didSetBreakpointInDebugger:function(e,t){if(!e){this._resetLocations(),this._breakpointManager._removeBreakpoint(this,!1);return}this._debuggerId=e,this._breakpointManager._breakpointForDebuggerId[e]=this;if(!t.length){this._fakeBreakpointAtPrimaryLocation();return}this._resetLocations();for(var n=0;n<t.length;++n){var r=this._breakpointManager._debuggerModel.scriptForId(t[n].scriptId),i=r.rawLocationToUILocation(t[n].lineNumber,t[n].columnNumber);if(this._breakpointManager.findBreakpoint(i.uiSourceCode,i.lineNumber)){this.remove();return}}for(var n=0;n<t.length;++n)this._addResolvedLocation(t[n])},_removeFromDebugger:function(){this._debuggerId&&(this._breakpointManager._debuggerModel.removeBreakpoint(this._debuggerId),delete this._breakpointManager._breakpointForDebuggerId[this._debuggerId],delete this._debuggerId)},_resetLocations:function(){for(var e in this._uiLocations)this._breakpointManager._uiLocationRemoved(this,this._uiLocations[e]);for(var t=0;t<this._liveLocations.length;++t)this._liveLocations[t].dispose();this._liveLocations=[],this._uiLocations={}},_breakpointStorageId:function(){return this._sourceFileId?this._sourceFileId+":"+this._primaryUILocation.lineNumber:""},_fakeBreakpointAtPrimaryLocation:function(){this._resetLocations(),this._uiLocations[""]=this._primaryUILocation,this._breakpointManager._uiLocationAdded(this,this._primaryUILocation)}},WebInspector.BreakpointManager.Storage=function(e,t){this._breakpointManager=e,this._setting=t;var n=this._setting.get();this._breakpoints={};for(var r=0;r<n.length;++r){var i=n[r];this._breakpoints[i.sourceFileId+":"+i.lineNumber]=i}},WebInspector.BreakpointManager.Storage.prototype={_restoreBreakpoints:function(e){this._muted=!0;var t=WebInspector.BreakpointManager.sourceFileId(e);for(var n in this._breakpoints){var r=this._breakpoints[n];r.sourceFileId===t&&this._breakpointManager._innerSetBreakpoint(e,r.lineNumber,r.condition,r.enabled)}delete this._muted},_updateBreakpoint:function(e){if(this._muted||!e._breakpointStorageId())return;this._breakpoints[e._breakpointStorageId()]=new WebInspector.BreakpointManager.Storage.Item(e),this._save()},_removeBreakpoint:function(e){if(this._muted)return;delete this._breakpoints[e._breakpointStorageId()],this._save()},_save:function(){var e=[];for(var t in this._breakpoints)e.push(this._breakpoints[t]);this._setting.set(e)}},WebInspector.BreakpointManager.Storage.Item=function(e){var t=e.primaryUILocation();this.sourceFileId=e._sourceFileId,this.lineNumber=t.lineNumber,this.condition=e.condition(),this.enabled=e.enabled()},WebInspector.breakpointManager=null;