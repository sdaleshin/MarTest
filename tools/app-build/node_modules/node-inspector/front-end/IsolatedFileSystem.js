/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.IsolatedFileSystem=function(e,t,n,r){this._manager=e,this._path=t,this._name=n,this._rootURL=r},WebInspector.IsolatedFileSystem.errorMessage=function(e){var t;switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:t="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:t="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:t="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:t="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:t="INVALID_STATE_ERR";break;default:t="Unknown Error"}return"File system error: "+t},WebInspector.IsolatedFileSystem.prototype={path:function(){return this._path},name:function(){return this._name},rootURL:function(){return this._rootURL},_requestFileSystem:function(e){this._manager.requestDOMFileSystem(this._path,e)},requestFilesRecursive:function(e,t){function r(t){n=t,this._requestEntries(n,e,i.bind(this))}function i(e){for(var r=0;r<e.length;++r){var s=e[r];if(!s.isDirectory){if(this._manager.mapping().isFileExcluded(this._path,s.fullPath))continue;t(s.fullPath.substr(1))}else{if(this._manager.mapping().isFileExcluded(this._path,s.fullPath+"/"))continue;this._requestEntries(n,s.fullPath,i.bind(this))}}}this._requestFileSystem(r.bind(this));var n},createFile:function(e,t,n){function s(t){t.root.getDirectory(e,null,o.bind(this),u.bind(this))}function o(i){function u(e){n(e.fullPath.substr(1))}function a(t){if(t.code===FileError.INVALID_MODIFICATION_ERR){o(i);return}var r=WebInspector.IsolatedFileSystem.errorMessage(t);console.error(r+" when testing if file exists '"+(this._path+"/"+e+"/"+s)+"'"),n(null)}var s=t;r>1&&(s+=r),++r,i.getFile(s,{create:!0,exclusive:!0},u,a)}function u(t){var r=WebInspector.IsolatedFileSystem.errorMessage(t),s=this._path+"/"+e;i&&(s+="/"+i),console.error(r+" when getting content for file '"+s+"'"),n(null)}this._requestFileSystem(s.bind(this));var r=1;t||(t="NewFile");var i},deleteFile:function(e){function t(t){t.root.getFile(e,null,n.bind(this),i.bind(this))}function n(e){e.remove(r.bind(this),i.bind(this))}function r(){}function i(t){var n=WebInspector.IsolatedFileSystem.errorMessage(t);console.error(n+" when deleting file '"+(this._path+"/"+e)+"'")}this._requestFileSystem(t.bind(this))},requestMetadata:function(e,t){function n(t){t.root.getFile(e,null,r,s)}function r(e){e.getMetadata(i,s)}function i(e){t(e.modificationTime,e.size)}function s(e){t(null,null)}this._requestFileSystem(n.bind(this))},requestFileContent:function(e,t){function n(t){t.root.getFile(e,null,r,o.bind(this))}function r(e){e.file(i,o.bind(this))}function i(e){var t=new FileReader;t.onloadend=s,t.readAsText(e)}function s(){t(this.result)}function o(n){if(n.code===FileError.NOT_FOUND_ERR){t(null);return}var r=WebInspector.IsolatedFileSystem.errorMessage(n);console.error(r+" when getting content for file '"+(this._path+"/"+e)+"'"),t(null)}this._requestFileSystem(n.bind(this))},setFileContent:function(e,t,n){function r(t){t.root.getFile(e,{create:!0},i,u.bind(this))}function i(e){e.createWriter(s,u.bind(this))}function s(e){function n(){e.onwriteend=o;var n=new Blob([t],{type:"text/plain"});e.write(n)}e.onerror=u.bind(this),e.onwriteend=n,e.truncate(0)}function o(){n()}function u(t){var r=WebInspector.IsolatedFileSystem.errorMessage(t);console.error(r+" when setting content for file '"+(this._path+"/"+e)+"'"),n()}this._requestFileSystem(r)},renameFile:function(e,t,n){function o(t){t.root.getFile(e,null,u,h.bind(this))}function u(e){if(e.name===t){n(!1);return}r=e,r.getParent(a,h.bind(this))}function a(e){i=e,i.getFile(t,null,f,l)}function f(e){n(!1)}function l(e){if(e.code!==FileError.NOT_FOUND_ERR){n(!1);return}r.moveTo(i,t,c,h.bind(this))}function c(e){n(!0,e.name)}function h(r){var i=WebInspector.IsolatedFileSystem.errorMessage(r);console.error(i+" when renaming file '"+(this._path+"/"+e)+"' to '"+t+"'"),n(!1)}t=t?t.trim():t;if(!t||t.indexOf("/")!==-1){n(!1);return}var r,i,s;this._requestFileSystem(o)},_readDirectory:function(e,t){function i(e){e.length?(r=r.concat(s(e)),n.readEntries(i,o)):t(r.sort())}function s(e){return Array.prototype.slice.call(e||[],0)}function o(n){var r=WebInspector.IsolatedFileSystem.errorMessage(n);console.error(r+" when reading directory '"+e.fullPath+"'"),t([])}var n=e.createReader(),r=[];n.readEntries(i,o)},_requestEntries:function(e,t,n){function r(e){this._readDirectory(e,n)}function i(e){var r=WebInspector.IsolatedFileSystem.errorMessage(e);console.error(r+" when requesting entry '"+t+"'"),n([])}e.root.getDirectory(t,null,r.bind(this),i)}};