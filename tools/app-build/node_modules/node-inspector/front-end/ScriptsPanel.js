/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

importScript("BreakpointsSidebarPane.js"),importScript("CallStackSidebarPane.js"),importScript("FilePathScoreFunction.js"),importScript("FilteredItemSelectionDialog.js"),importScript("UISourceCodeFrame.js"),importScript("JavaScriptSourceFrame.js"),importScript("NavigatorOverlayController.js"),importScript("NavigatorView.js"),importScript("RevisionHistoryView.js"),importScript("ScopeChainSidebarPane.js"),importScript("ScriptsNavigator.js"),importScript("ScriptsSearchScope.js"),importScript("StyleSheetOutlineDialog.js"),importScript("TabbedEditorContainer.js"),importScript("WatchExpressionsSidebarPane.js"),importScript("WorkersSidebarPane.js"),WebInspector.ScriptsPanel=function(e){function t(){return this.visibleView}WebInspector.Panel.call(this,"scripts"),this.registerRequiredCSS("scriptsPanel.css"),this.registerRequiredCSS("textPrompt.css"),WebInspector.settings.navigatorWasOnceHidden=WebInspector.settings.createSetting("navigatorWasOnceHidden",!1),WebInspector.settings.debuggerSidebarHidden=WebInspector.settings.createSetting("debuggerSidebarHidden",!1),this._workspace=e||WebInspector.workspace,WebInspector.GoToLineDialog.install(this,t.bind(this));var n=WebInspector.shortcutsScreen.section(WebInspector.UIString("Sources Panel"));this.debugToolbar=this._createDebugToolbar();const r=225,i=.5;this.createSidebarView(this.element,WebInspector.SidebarView.SidebarPosition.End,r),this.splitView.element.id="scripts-split-view",this.splitView.setSidebarElementConstraints(Preferences.minScriptsSidebarWidth),this.splitView.setMainElementConstraints(i);const s=225,o=.5;this.editorView=new WebInspector.SidebarView(WebInspector.SidebarView.SidebarPosition.Start,"scriptsPanelNavigatorSidebarWidth",s),this.editorView.element.tabIndex=0,this.editorView.setSidebarElementConstraints(Preferences.minScriptsSidebarWidth),this.editorView.setMainElementConstraints(o),this.editorView.show(this.splitView.mainElement),this._navigator=new WebInspector.ScriptsNavigator,this._navigator.view.show(this.editorView.sidebarElement);var u=WebInspector.isMac()?WebInspector.UIString("Hit Cmd+O to open a file"):WebInspector.UIString("Hit Ctrl+O to open a file");this._editorContentsElement=this.editorView.mainElement.createChild("div","fill"),this._editorFooterElement=this.editorView.mainElement.createChild("div","inspector-footer status-bar hidden"),this._editorContainer=new WebInspector.TabbedEditorContainer(this,"previouslyViewedFiles",u),this._editorContainer.show(this._editorContentsElement),this._navigatorController=new WebInspector.NavigatorOverlayController(this.editorView,this._navigator.view,this._editorContainer.view),this._navigator.addEventListener(WebInspector.ScriptsNavigator.Events.ScriptSelected,this._scriptSelected,this),this._navigator.addEventListener(WebInspector.ScriptsNavigator.Events.ItemSearchStarted,this._itemSearchStarted,this),this._navigator.addEventListener(WebInspector.ScriptsNavigator.Events.ItemCreationRequested,this._itemCreationRequested,this),this._navigator.addEventListener(WebInspector.ScriptsNavigator.Events.ItemRenamingRequested,this._itemRenamingRequested,this),this._editorContainer.addEventListener(WebInspector.TabbedEditorContainer.Events.EditorSelected,this._editorSelected,this),this._editorContainer.addEventListener(WebInspector.TabbedEditorContainer.Events.EditorClosed,this._editorClosed,this),this._debugSidebarResizeWidgetElement=this.splitView.mainElement.createChild("div","resizer-widget"),this._debugSidebarResizeWidgetElement.id="scripts-debug-sidebar-resizer-widget",this.splitView.installResizer(this._debugSidebarResizeWidgetElement),this.sidebarPanes={},this.sidebarPanes.watchExpressions=new WebInspector.WatchExpressionsSidebarPane,this.sidebarPanes.callstack=new WebInspector.CallStackSidebarPane,this.sidebarPanes.callstack.addEventListener(WebInspector.CallStackSidebarPane.Events.CallFrameSelected,this._callFrameSelectedInSidebar.bind(this)),this.sidebarPanes.scopechain=new WebInspector.ScopeChainSidebarPane,this.sidebarPanes.jsBreakpoints=new WebInspector.JavaScriptBreakpointsSidebarPane(WebInspector.breakpointManager,this._showSourceLocation.bind(this)),this.sidebarPanes.domBreakpoints=WebInspector.domBreakpointsSidebarPane.createProxy(this),this.sidebarPanes.xhrBreakpoints=new WebInspector.XHRBreakpointsSidebarPane,this.sidebarPanes.eventListenerBreakpoints=new WebInspector.EventListenerBreakpointsSidebarPane,Capabilities.canInspectWorkers&&!WebInspector.WorkerManager.isWorkerFrontend()&&(WorkerAgent.enable(),this.sidebarPanes.workerList=new WebInspector.WorkersSidebarPane(WebInspector.workerManager)),this.sidebarPanes.callstack.registerShortcuts(this.registerShortcuts.bind(this)),this.registerShortcuts(WebInspector.ScriptsPanelDescriptor.ShortcutKeys.GoToMember,this._showOutlineDialog.bind(this)),this.registerShortcuts(WebInspector.ScriptsPanelDescriptor.ShortcutKeys.ToggleBreakpoint,this._toggleBreakpoint.bind(this)),this._pauseOnExceptionButton=new WebInspector.StatusBarButton("","scripts-pause-on-exceptions-status-bar-item",3),this._pauseOnExceptionButton.addEventListener("click",this._togglePauseOnExceptions,this),this._toggleFormatSourceButton=new WebInspector.StatusBarButton(WebInspector.UIString("Pretty print"),"scripts-toggle-pretty-print-status-bar-item"),this._toggleFormatSourceButton.toggled=!1,this._toggleFormatSourceButton.addEventListener("click",this._toggleFormatSource,this),this._scriptViewStatusBarItemsContainer=document.createElement("div"),this._scriptViewStatusBarItemsContainer.className="inline-block",this._scriptViewStatusBarTextContainer=document.createElement("div"),this._scriptViewStatusBarTextContainer.className="inline-block",this._installDebuggerSidebarController(),WebInspector.dockController.addEventListener(WebInspector.DockController.Events.DockSideChanged,this._dockSideChanged.bind(this)),WebInspector.settings.splitVerticallyWhenDockedToRight.addChangeListener(this._dockSideChanged.bind(this)),this._dockSideChanged(),this._sourceFramesByUISourceCode=new Map,this._updateDebuggerButtons(),this._pauseOnExceptionStateChanged(),WebInspector.debuggerModel.isPaused()&&this._debuggerPaused(),WebInspector.settings.pauseOnExceptionStateString.addChangeListener(this._pauseOnExceptionStateChanged,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.DebuggerWasEnabled,this._debuggerWasEnabled,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.DebuggerWasDisabled,this._debuggerWasDisabled,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.DebuggerPaused,this._debuggerPaused,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.DebuggerResumed,this._debuggerResumed,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.CallFrameSelected,this._callFrameSelected,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.ConsoleCommandEvaluatedInSelectedCallFrame,this._consoleCommandEvaluatedInSelectedCallFrame,this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.BreakpointsActiveStateChanged,this._breakpointsActiveStateChanged,this),WebInspector.startBatchUpdate(),this._workspace.uiSourceCodes().forEach(this._addUISourceCode.bind(this)),WebInspector.endBatchUpdate(),this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this),this._workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeRemoved,this._uiSourceCodeRemoved,this),this._workspace.addEventListener(WebInspector.Workspace.Events.ProjectWillReset,this._projectWillReset.bind(this),this),WebInspector.debuggerModel.addEventListener(WebInspector.DebuggerModel.Events.GlobalObjectCleared,this._debuggerReset,this),WebInspector.advancedSearchController.registerSearchScope(new WebInspector.ScriptsSearchScope(this._workspace)),this._boundOnKeyUp=this._onKeyUp.bind(this),this._boundOnKeyDown=this._onKeyDown.bind(this)},WebInspector.ScriptsPanel.prototype={get statusBarItems(){return[this._pauseOnExceptionButton.element,this._toggleFormatSourceButton.element,this._scriptViewStatusBarItemsContainer]},statusBarText:function(){return this._scriptViewStatusBarTextContainer},defaultFocusedElement:function(){return this._editorContainer.view.defaultFocusedElement()||this._navigator.view.defaultFocusedElement()},get paused(){return this._paused},wasShown:function(){WebInspector.Panel.prototype.wasShown.call(this),this._navigatorController.wasShown(),this.element.addEventListener("keydown",this._boundOnKeyDown,!1),this.element.addEventListener("keyup",this._boundOnKeyUp,!1)},willHide:function(){this.element.removeEventListener("keydown",this._boundOnKeyDown,!1),this.element.removeEventListener("keyup",this._boundOnKeyUp,!1),WebInspector.Panel.prototype.willHide.call(this),WebInspector.closeViewInDrawer()},_uiSourceCodeAdded:function(e){var t=e.data;this._addUISourceCode(t)},_addUISourceCode:function(e){this._toggleFormatSourceButton.toggled&&e.setFormatted(!0);if(e.project().isServiceProject())return;this._navigator.addUISourceCode(e),this._editorContainer.addUISourceCode(e);var t=this._currentUISourceCode;t&&t.project().isServiceProject()&&t!==e&&t.url===e.url&&(this._showFile(e),this._editorContainer.removeUISourceCode(t))},_uiSourceCodeRemoved:function(e){var t=e.data;this._removeUISourceCodes([t])},_removeUISourceCodes:function(e){for(var t=0;t<e.length;++t)this._navigator.removeUISourceCode(e[t]),this._removeSourceFrame(e[t]);this._editorContainer.removeUISourceCodes(e)},_consoleCommandEvaluatedInSelectedCallFrame:function(e){this.sidebarPanes.scopechain.update(WebInspector.debuggerModel.selectedCallFrame())},_debuggerPaused:function(){var e=WebInspector.debuggerModel.debuggerPausedDetails();this._paused=!0,this._waitingToPause=!1,this._stepping=!1,this._updateDebuggerButtons(),WebInspector.inspectorView.setCurrentPanel(this),this.sidebarPanes.callstack.update(e.callFrames);if(e.reason===WebInspector.DebuggerModel.BreakReason.DOM){WebInspector.domBreakpointsSidebarPane.highlightBreakpoint(e.auxData);function t(e){this.sidebarPanes.callstack.setStatus(e)}WebInspector.domBreakpointsSidebarPane.createBreakpointHitStatusMessage(e.auxData,t.bind(this))}else if(e.reason===WebInspector.DebuggerModel.BreakReason.EventListener){var n=e.auxData.eventName;this.sidebarPanes.eventListenerBreakpoints.highlightBreakpoint(e.auxData.eventName);var r=WebInspector.EventListenerBreakpointsSidebarPane.eventNameForUI(n,e.auxData);this.sidebarPanes.callstack.setStatus(WebInspector.UIString('Paused on a "%s" Event Listener.',r))}else if(e.reason===WebInspector.DebuggerModel.BreakReason.XHR)this.sidebarPanes.xhrBreakpoints.highlightBreakpoint(e.auxData.breakpointURL),this.sidebarPanes.callstack.setStatus(WebInspector.UIString("Paused on a XMLHttpRequest."));else if(e.reason===WebInspector.DebuggerModel.BreakReason.Exception)this.sidebarPanes.callstack.setStatus(WebInspector.UIString("Paused on exception: '%s'.",e.auxData.description));else if(e.reason===WebInspector.DebuggerModel.BreakReason.Assert)this.sidebarPanes.callstack.setStatus(WebInspector.UIString("Paused on assertion."));else if(e.reason===WebInspector.DebuggerModel.BreakReason.CSPViolation)this.sidebarPanes.callstack.setStatus(WebInspector.UIString('Paused on a script blocked due to Content Security Policy directive: "%s".',e.auxData.directiveText));else if(e.reason===WebInspector.DebuggerModel.BreakReason.DebugCommand)this.sidebarPanes.callstack.setStatus(WebInspector.UIString("Paused on a debugged function"));else{function i(e){var t=WebInspector.breakpointManager.findBreakpoint(e.uiSourceCode,e.lineNumber);if(!t)return;this.sidebarPanes.jsBreakpoints.highlightBreakpoint(t),this.sidebarPanes.callstack.setStatus(WebInspector.UIString("Paused on a JavaScript breakpoint."))}e.callFrames.length?e.callFrames[0].createLiveLocation(i.bind(this)):console.warn("ScriptsPanel paused, but callFrames.length is zero.")}this._enableDebuggerSidebar(!0),this._toggleDebuggerSidebarButton.setEnabled(!1),window.focus(),InspectorFrontendHost.bringToFront()},_debuggerResumed:function(){this._paused=!1,this._waitingToPause=!1,this._stepping=!1,this._clearInterface(),this._toggleDebuggerSidebarButton.setEnabled(!0)},_debuggerWasEnabled:function(){this._updateDebuggerButtons()},_debuggerWasDisabled:function(){this._debuggerReset()},_debuggerReset:function(){this._debuggerResumed(),this.sidebarPanes.watchExpressions.reset(),delete this._skipExecutionLineRevealing},_projectWillReset:function(e){var t=e.data,n=t.uiSourceCodes();this._removeUISourceCodes(n),t.type()===WebInspector.projectTypes.Network&&this._editorContainer.reset()},get visibleView(){return this._editorContainer.visibleView},_updateScriptViewStatusBarItems:function(){this._scriptViewStatusBarItemsContainer.removeChildren(),this._scriptViewStatusBarTextContainer.removeChildren();var e=this.visibleView;if(e){var t=e.statusBarItems()||[];for(var n=0;n<t.length;++n)this._scriptViewStatusBarItemsContainer.appendChild(t[n]);var r=e.statusBarText();r&&this._scriptViewStatusBarTextContainer.appendChild(r)}},canShowAnchorLocation:function(e){if(WebInspector.debuggerModel.debuggerEnabled()&&e.uiSourceCode)return!0;var t=WebInspector.workspace.uiSourceCodeForURL(e.href);return t?(e.uiSourceCode=t,!0):!1},showAnchorLocation:function(e){this._showSourceLocation(e.uiSourceCode,e.lineNumber,e.columnNumber)},showUISourceCode:function(e,t,n){this._showSourceLocation(e,t,n)},currentUISourceCode:function(){return this._currentUISourceCode},showUILocation:function(e){this._showSourceLocation(e.uiSourceCode,e.lineNumber,e.columnNumber)},_showSourceLocation:function(e,t,n){var r=this._showFile(e);typeof t=="number"&&r.highlightPosition(t,n),r.focus(),WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.OpenSourceLink,url:e.originURL(),lineNumber:t})},_showFile:function(e){var t=this._getOrCreateSourceFrame(e);return this._currentUISourceCode===e?t:(this._currentUISourceCode=e,e.project().isServiceProject()||this._navigator.revealUISourceCode(e,!0),this._editorContainer.showFile(e),this._updateScriptViewStatusBarItems(),this._currentUISourceCode.project().type()===WebInspector.projectTypes.Snippets?this._runSnippetButton.element.removeStyleClass("hidden"):this._runSnippetButton.element.addStyleClass("hidden"),t)},_createSourceFrame:function(e){var t;switch(e.contentType()){case WebInspector.resourceTypes.Script:t=new WebInspector.JavaScriptSourceFrame(this,e);break;case WebInspector.resourceTypes.Document:t=new WebInspector.JavaScriptSourceFrame(this,e);break;case WebInspector.resourceTypes.Stylesheet:default:t=new WebInspector.UISourceCodeFrame(e)}return this._sourceFramesByUISourceCode.put(e,t),t},_getOrCreateSourceFrame:function(e){return this._sourceFramesByUISourceCode.get(e)||this._createSourceFrame(e)},viewForFile:function(e){return this._getOrCreateSourceFrame(e)},_removeSourceFrame:function(e){var t=this._sourceFramesByUISourceCode.get(e);if(!t)return;this._sourceFramesByUISourceCode.remove(e),t.dispose()},_clearCurrentExecutionLine:function(){this._executionSourceFrame&&this._executionSourceFrame.clearExecutionLine(),delete this._executionSourceFrame},_setExecutionLine:function(e){var t=WebInspector.debuggerModel.selectedCallFrame(),n=this._getOrCreateSourceFrame(e.uiSourceCode);n.setExecutionLine(e.lineNumber,t),this._executionSourceFrame=n},_executionLineChanged:function(e){this._clearCurrentExecutionLine(),this._setExecutionLine(e);var t=e.uiSourceCode,n=this._currentUISourceCode?this._currentUISourceCode.scriptFile():null;if(this._skipExecutionLineRevealing)return;this._skipExecutionLineRevealing=!0;var r=this._showFile(t);r.revealLine(e.lineNumber),r.canEditSource()&&r.setSelection(WebInspector.TextRange.createFromLocation(e.lineNumber,0)),r.focus()},_callFrameSelected:function(e){var t=e.data;if(!t)return;this.sidebarPanes.scopechain.update(t),this.sidebarPanes.watchExpressions.refreshExpressions(),this.sidebarPanes.callstack.setSelectedCallFrame(t),t.createLiveLocation(this._executionLineChanged.bind(this))},_editorClosed:function(e){this._navigatorController.hideNavigatorOverlay();var t=e.data;this._currentUISourceCode===t&&delete this._currentUISourceCode,this._updateScriptViewStatusBarItems(),WebInspector.searchController.resetSearch()},_editorSelected:function(e){var t=e.data,n=this._showFile(t);this._navigatorController.hideNavigatorOverlay(),this._navigatorController.isNavigatorPinned()||n.focus(),WebInspector.searchController.resetSearch()},_scriptSelected:function(e){var t=e.data.uiSourceCode,n=this._showFile(t);this._navigatorController.hideNavigatorOverlay(),n&&(!this._navigatorController.isNavigatorPinned()||e.data.focusSource)&&n.focus()},_itemSearchStarted:function(e){var t=e.data;WebInspector.OpenResourceDialog.show(this,this.editorView.mainElement,t)},_pauseOnExceptionStateChanged:function(){var e=WebInspector.settings.pauseOnExceptionStateString.get();switch(e){case WebInspector.DebuggerModel.PauseOnExceptionsState.DontPauseOnExceptions:this._pauseOnExceptionButton.title=WebInspector.UIString("Don't pause on exceptions.\nClick to Pause on all exceptions.");break;case WebInspector.DebuggerModel.PauseOnExceptionsState.PauseOnAllExceptions:this._pauseOnExceptionButton.title=WebInspector.UIString("Pause on all exceptions.\nClick to Pause on uncaught exceptions.");break;case WebInspector.DebuggerModel.PauseOnExceptionsState.PauseOnUncaughtExceptions:this._pauseOnExceptionButton.title=WebInspector.UIString("Pause on uncaught exceptions.\nClick to Not pause on exceptions.")}this._pauseOnExceptionButton.state=e},_updateDebuggerButtons:function(){WebInspector.debuggerModel.debuggerEnabled()?this._pauseOnExceptionButton.visible=!0:this._pauseOnExceptionButton.visible=!1,this._paused?(this._updateButtonTitle(this._pauseButton,WebInspector.UIString("Resume script execution (%s).")),this._pauseButton.state=!0,this._pauseButton.setLongClickOptionsEnabled(function(){return[this._longResumeButton]}.bind(this)),this._pauseButton.setEnabled(!0),this._stepOverButton.setEnabled(!0),this._stepIntoButton.setEnabled(!0),this._stepOutButton.setEnabled(!0),this.debuggerStatusElement.textContent=WebInspector.UIString("Paused")):(this._updateButtonTitle(this._pauseButton,WebInspector.UIString("Pause script execution (%s).")),this._pauseButton.state=!1,this._pauseButton.setLongClickOptionsEnabled(null),this._pauseButton.setEnabled(!this._waitingToPause),this._stepOverButton.setEnabled(!1),this._stepIntoButton.setEnabled(!1),this._stepOutButton.setEnabled(!1),this._waitingToPause?this.debuggerStatusElement.textContent=WebInspector.UIString("Pausing"):this._stepping?this.debuggerStatusElement.textContent=WebInspector.UIString("Stepping"):this.debuggerStatusElement.textContent="")},_clearInterface:function(){this.sidebarPanes.callstack.update(null),this.sidebarPanes.scopechain.update(null),this.sidebarPanes.jsBreakpoints.clearBreakpointHighlight(),WebInspector.domBreakpointsSidebarPane.clearBreakpointHighlight(),this.sidebarPanes.eventListenerBreakpoints.clearBreakpointHighlight(),this.sidebarPanes.xhrBreakpoints.clearBreakpointHighlight(),this._clearCurrentExecutionLine(),this._updateDebuggerButtons()},_togglePauseOnExceptions:function(){var e={},t=WebInspector.DebuggerModel.PauseOnExceptionsState;e[t.DontPauseOnExceptions]=t.PauseOnAllExceptions,e[t.PauseOnAllExceptions]=t.PauseOnUncaughtExceptions,e[t.PauseOnUncaughtExceptions]=t.DontPauseOnExceptions,WebInspector.settings.pauseOnExceptionStateString.set(e[this._pauseOnExceptionButton.state])},_runSnippet:function(e){return this._currentUISourceCode.project().type()!==WebInspector.projectTypes.Snippets?!1:(WebInspector.scriptSnippetModel.evaluateScriptSnippet(this._currentUISourceCode),!0)},_togglePause:function(e){return this._paused?(delete this._skipExecutionLineRevealing,this._paused=!1,this._waitingToPause=!1,DebuggerAgent.resume()):(this._stepping=!1,this._waitingToPause=!0,DebuggerAgent.setSkipAllPauses(!1),DebuggerAgent.pause()),this._clearInterface(),!0},_longResume:function(e){return this._paused?(this._paused=!1,this._waitingToPause=!1,DebuggerAgent.setSkipAllPauses(!0,!0),setTimeout(DebuggerAgent.setSkipAllPauses.bind(DebuggerAgent,!1),500),DebuggerAgent.resume(),this._clearInterface(),!0):!0},_stepOverClicked:function(e){return this._paused?(delete this._skipExecutionLineRevealing,this._paused=!1,this._stepping=!0,this._clearInterface(),DebuggerAgent.stepOver(),!0):!0},_stepIntoClicked:function(e){return this._paused?(delete this._skipExecutionLineRevealing,this._paused=!1,this._stepping=!0,this._clearInterface(),DebuggerAgent.stepInto(),!0):!0},_stepIntoSelectionClicked:function(e){if(!this._paused)return!0;if(this._executionSourceFrame){var t=this._executionSourceFrame.stepIntoMarkup();t&&t.iterateSelection(e.shiftKey)}return!0},doStepIntoSelection:function(e){if(!this._paused)return;delete this._skipExecutionLineRevealing,this._paused=!1,this._stepping=!0,this._clearInterface(),WebInspector.debuggerModel.stepIntoSelection(e)},_stepOutClicked:function(e){return this._paused?(delete this._skipExecutionLineRevealing,this._paused=!1,this._stepping=!0,this._clearInterface(),DebuggerAgent.stepOut(),!0):!0},_callFrameSelectedInSidebar:function(e){var t=e.data;delete this._skipExecutionLineRevealing,WebInspector.debuggerModel.setSelectedCallFrame(t)},continueToLocation:function(e){if(!this._paused)return;delete this._skipExecutionLineRevealing,this._paused=!1,this._stepping=!0,this._clearInterface(),WebInspector.debuggerModel.continueToLocation(e)},_toggleBreakpointsClicked:function(e){WebInspector.debuggerModel.setBreakpointsActive(!WebInspector.debuggerModel.breakpointsActive())},_breakpointsActiveStateChanged:function(e){var t=e.data;this._toggleBreakpointsButton.toggled=!t,t?(this._toggleBreakpointsButton.title=WebInspector.UIString("Deactivate breakpoints."),WebInspector.inspectorView.element.removeStyleClass("breakpoints-deactivated"),this.sidebarPanes.jsBreakpoints.listElement.removeStyleClass("breakpoints-list-deactivated")):(this._toggleBreakpointsButton.title=WebInspector.UIString("Activate breakpoints."),WebInspector.inspectorView.element.addStyleClass("breakpoints-deactivated"),this.sidebarPanes.jsBreakpoints.listElement.addStyleClass("breakpoints-list-deactivated"))},_createDebugToolbar:function(){var e=document.createElement("div");e.className="status-bar",e.id="scripts-debug-toolbar";var t,n,r=WebInspector.KeyboardShortcut.Modifiers.CtrlOrMeta;return t=WebInspector.UIString("Run snippet (%s)."),n=this._runSnippet.bind(this),this._runSnippetButton=this._createButtonAndRegisterShortcuts("scripts-run-snippet",t,n,WebInspector.ScriptsPanelDescriptor.ShortcutKeys.RunSnippet),e.appendChild(this._runSnippetButton.element),this._runSnippetButton.element.addStyleClass("hidden"),n=this._togglePause.bind(this),this._pauseButton=this._createButtonAndRegisterShortcuts("scripts-pause","",n,WebInspector.ScriptsPanelDescriptor.ShortcutKeys.PauseContinue),e.appendChild(this._pauseButton.element),t=WebInspector.UIString("Resume with all pauses blocked for 500 ms"),this._longResumeButton=new WebInspector.StatusBarButton(t,"scripts-long-resume"),this._longResumeButton.addEventListener("click",this._longResume.bind(this),this),t=WebInspector.UIString("Step over next function call (%s)."),n=this._stepOverClicked.bind(this),this._stepOverButton=this._createButtonAndRegisterShortcuts("scripts-step-over",t,n,WebInspector.ScriptsPanelDescriptor.ShortcutKeys.StepOver),e.appendChild(this._stepOverButton.element),t=WebInspector.UIString("Step into next function call (%s)."),n=this._stepIntoClicked.bind(this),this._stepIntoButton=this._createButtonAndRegisterShortcuts("scripts-step-into",t,n,WebInspector.ScriptsPanelDescriptor.ShortcutKeys.StepInto),e.appendChild(this._stepIntoButton.element),this.registerShortcuts(WebInspector.ScriptsPanelDescriptor.ShortcutKeys.StepIntoSelection,this._stepIntoSelectionClicked.bind(this)),t=WebInspector.UIString("Step out of current function (%s)."),n=this._stepOutClicked.bind(this),this._stepOutButton=this._createButtonAndRegisterShortcuts("scripts-step-out",t,n,WebInspector.ScriptsPanelDescriptor.ShortcutKeys.StepOut),e.appendChild(this._stepOutButton.element),this._toggleBreakpointsButton=new WebInspector.StatusBarButton(WebInspector.UIString("Deactivate breakpoints."),"scripts-toggle-breakpoints"),this._toggleBreakpointsButton.toggled=!1,this._toggleBreakpointsButton.addEventListener("click",this._toggleBreakpointsClicked,this),e.appendChild(this._toggleBreakpointsButton.element),this.debuggerStatusElement=document.createElement("div"),this.debuggerStatusElement.id="scripts-debugger-status",e.appendChild(this.debuggerStatusElement),e},_updateButtonTitle:function(e,t){var n=e.shortcuts&&e.shortcuts.length;n?e.title=String.vsprintf(t,[e.shortcuts[0].name]):e.title=t},_createButtonAndRegisterShortcuts:function(e,t,n,r){var i=new WebInspector.StatusBarButton(t,e);return i.element.addEventListener("click",n,!1),i.shortcuts=r,this._updateButtonTitle(i,t),this.registerShortcuts(r,n),i},searchCanceled:function(){this._searchView&&this._searchView.searchCanceled(),delete this._searchView,delete this._searchQuery},performSearch:function(e,t){function n(e,t){if(!t)return;WebInspector.searchController.updateSearchMatchesCount(t,this)}function r(e){WebInspector.searchController.updateCurrentMatchIndex(e,this)}WebInspector.searchController.updateSearchMatchesCount(0,this);if(!this.visibleView)return;this._searchView=this.visibleView,this._searchQuery=e,this._searchView.performSearch(e,t,n.bind(this),r.bind(this))},minimalSearchQuerySize:function(){return 0},jumpToNextSearchResult:function(){if(!this._searchView)return;if(this._searchView!==this.visibleView){this.performSearch(this._searchQuery,!0);return}return this._searchView.jumpToNextSearchResult(),!0},jumpToPreviousSearchResult:function(){if(!this._searchView)return;if(this._searchView!==this.visibleView){this.performSearch(this._searchQuery,!0),this._searchView&&this._searchView.jumpToLastSearchResult();return}this._searchView.jumpToPreviousSearchResult()},canSearchAndReplace:function(){var e=this.visibleView;return!!e&&e.canEditSource()},replaceSelectionWith:function(e){var t=this.visibleView;t.replaceSearchMatchWith(e)},replaceAllWith:function(e,t){var n=this.visibleView;n.replaceAllWith(e,t)},_onKeyDown:function(e){if(e.keyCode!==WebInspector.KeyboardShortcut.Keys.CtrlOrMeta.code)return;if(!this._paused||!this._executionSourceFrame)return;var t=this._executionSourceFrame.stepIntoMarkup();t&&t.startIteratingSelection()},_onKeyUp:function(e){if(e.keyCode!==WebInspector.KeyboardShortcut.Keys.CtrlOrMeta.code)return;if(!this._paused||!this._executionSourceFrame)return;var t=this._executionSourceFrame.stepIntoMarkup();if(!t)return;var n=t.getSelectedItemIndex();if(typeof n=="undefined")t.stopIteratingSelection();else{var r=t.getRawPosition(n);this.doStepIntoSelection(r)}},_toggleFormatSource:function(){delete this._skipExecutionLineRevealing,this._toggleFormatSourceButton.toggled=!this._toggleFormatSourceButton.toggled;var e=this._workspace.uiSourceCodes();for(var t=0;t<e.length;++t)e[t].setFormatted(this._toggleFormatSourceButton.toggled);var n=this._editorContainer.currentFile();WebInspector.notifications.dispatchEventToListeners(WebInspector.UserMetrics.UserAction,{action:WebInspector.UserMetrics.UserActionNames.TogglePrettyPrint,enabled:this._toggleFormatSourceButton.toggled,url:n?n.originURL():null})},addToWatch:function(e){this.sidebarPanes.watchExpressions.addExpression(e)},_toggleBreakpoint:function(){var e=this.visibleView;if(!e)return!1;if(e instanceof WebInspector.JavaScriptSourceFrame){var t=e;return t.toggleBreakpointOnCurrentLine(),!0}return!1},_showOutlineDialog:function(e){var t=this._editorContainer.currentFile();if(!t)return!1;switch(t.contentType()){case WebInspector.resourceTypes.Document:case WebInspector.resourceTypes.Script:return WebInspector.JavaScriptOutlineDialog.show(this.visibleView,t),!0;case WebInspector.resourceTypes.Stylesheet:return WebInspector.StyleSheetOutlineDialog.show(this.visibleView,t),!0}return!1},_installDebuggerSidebarController:function(){function e(){this._enableDebuggerSidebar(this._toggleDebuggerSidebarButton.state==="left")}this._toggleDebuggerSidebarButton=new WebInspector.StatusBarButton("","right-sidebar-show-hide-button scripts-debugger-show-hide-button",3),this._toggleDebuggerSidebarButton.addEventListener("click",e,this),this.editorView.element.appendChild(this._toggleDebuggerSidebarButton.element),this._enableDebuggerSidebar(!WebInspector.settings.debuggerSidebarHidden.get())},_enableDebuggerSidebar:function(e){this._toggleDebuggerSidebarButton.state=e?"right":"left",this._toggleDebuggerSidebarButton.title=e?WebInspector.UIString("Hide debugger"):WebInspector.UIString("Show debugger"),e?this.splitView.showSidebarElement():this.splitView.hideSidebarElement(),this._debugSidebarResizeWidgetElement.enableStyleClass("hidden",!e),WebInspector.settings.debuggerSidebarHidden.set(!e)},_itemCreationRequested:function(e){function o(e){if(!e)return;r=e,s=t.uiSourceCode(r),this._showSourceLocation(s),i=!this._navigatorController.isNavigatorPinned(),this._navigatorController.isNavigatorHidden()&&this._navigatorController.showNavigatorOverlay(),this._navigator.rename(s,u.bind(this))}function u(e){i&&this._navigatorController.hideNavigatorOverlay();if(!e){t.deleteFile(s);return}this._showSourceLocation(s)}var t=e.data.project,n=e.data.path,r,i,s;t.createFile(n,null,o.bind(this))},_itemRenamingRequested:function(e){function r(e){n&&e&&(this._navigatorController.hideNavigatorOverlay(),this._showSourceLocation(t))}var t=e.data,n=!this._navigatorController.isNavigatorPinned();this._navigatorController.isNavigatorHidden()&&this._navigatorController.showNavigatorOverlay(),this._navigator.rename(t,r.bind(this))},_showLocalHistory:function(e){WebInspector.RevisionHistoryView.showHistory(e)},appendApplicableItems:function(e,t,n){this._appendUISourceCodeItems(t,n),this._appendFunctionItems(t,n)},_mapFileSystemToNetwork:function(e){function t(t){this._workspace.addMapping(t,e,WebInspector.fileSystemWorkspaceProvider)}WebInspector.SelectUISourceCodeForProjectTypeDialog.show(e.name(),WebInspector.projectTypes.Network,t.bind(this),this.editorView.mainElement)},_removeNetworkMapping:function(e){confirm(WebInspector.UIString("Are you sure you want to remove network mapping?"))&&this._workspace.removeMapping(e)},_mapNetworkToFileSystem:function(e){function t(t){this._workspace.addMapping(e,t,WebInspector.fileSystemWorkspaceProvider)}WebInspector.SelectUISourceCodeForProjectTypeDialog.show(e.name(),WebInspector.projectTypes.FileSystem,t.bind(this),this.editorView.mainElement)},_appendUISourceCodeMappingItems:function(e,t){if(t.project().type()===WebInspector.projectTypes.FileSystem){var n=!!t.url;n?e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove network mapping":"Remove Network Mapping"),this._removeNetworkMapping.bind(this,t)):e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Map to network resource…":"Map to Network Resource…"),this._mapFileSystemToNetwork.bind(this,t))}if(t.project().type()===WebInspector.projectTypes.Network){function r(e){return e.type()===WebInspector.projectTypes.FileSystem}if(!this._workspace.projects().filter(r).length)return;this._workspace.uiSourceCodeForURL(t.url)===t&&e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Map to file system resource…":"Map to File System Resource…"),this._mapNetworkToFileSystem.bind(this,t))}},_appendUISourceCodeItems:function(e,t){if(!(t instanceof WebInspector.UISourceCode))return;var n=t;e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Local modifications…":"Local Modifications…"),this._showLocalHistory.bind(this,n)),WebInspector.isolatedFileSystemManager.supportsFileSystems()&&this._appendUISourceCodeMappingItems(e,n)},_appendFunctionItems:function(e,t){function r(e,t){if(e){console.error(e);return}WebInspector.inspectorView.setCurrentPanel(this);var n=WebInspector.debuggerModel.rawLocationToUILocation(t.location);this._showSourceLocation(n.uiSourceCode,n.lineNumber,n.columnNumber)}function i(){DebuggerAgent.getFunctionDetails(n.objectId,r.bind(this))}if(!(t instanceof WebInspector.RemoteObject))return;var n=t;if(n.type!=="function")return;e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Show function definition":"Show Function Definition"),i.bind(this))},showGoToSourceDialog:function(){var e=this._editorContainer.historyUISourceCodes(),t=new Map;for(var n=1;n<e.length;++n)t.put(e[n],e.length-n);WebInspector.OpenResourceDialog.show(this,this.editorView.mainElement,undefined,t)},_dockSideChanged:function(){var e=WebInspector.dockController.dockSide(),t=e===WebInspector.DockController.State.DockedToRight&&WebInspector.settings.splitVerticallyWhenDockedToRight.get();this._splitVertically(t)},_splitVertically:function(e){if(this.sidebarPaneView&&e===!this.splitView.isVertical())return;this.sidebarPaneView&&this.sidebarPaneView.detach(),this.splitView.setVertical(!e);if(!e){this.sidebarPaneView=new WebInspector.SidebarPaneStack;for(var t in this.sidebarPanes)this.sidebarPaneView.addPane(this.sidebarPanes[t]);this.sidebarElement.appendChild(this.debugToolbar)}else{this._enableDebuggerSidebar(!0),this.sidebarPaneView=new WebInspector.SplitView(!0,this.name+"PanelSplitSidebarRatio",.5);var n=new WebInspector.SidebarPaneStack;n.show(this.sidebarPaneView.firstElement()),n.element.id="scripts-sidebar-stack-pane",n.addPane(this.sidebarPanes.callstack),n.addPane(this.sidebarPanes.jsBreakpoints),n.addPane(this.sidebarPanes.domBreakpoints),n.addPane(this.sidebarPanes.xhrBreakpoints),n.addPane(this.sidebarPanes.eventListenerBreakpoints),this.sidebarPanes.workerList&&n.addPane(this.sidebarPanes.workerList);var r=new WebInspector.SidebarTabbedPane;r.show(this.sidebarPaneView.secondElement()),r.addPane(this.sidebarPanes.scopechain),r.addPane(this.sidebarPanes.watchExpressions),this.sidebarPaneView.firstElement().appendChild(this.debugToolbar)}this.sidebarPaneView.element.id="scripts-debug-sidebar-contents",this.sidebarPaneView.show(this.splitView.sidebarElement),this.sidebarPanes.scopechain.expand(),this.sidebarPanes.jsBreakpoints.expand(),this.sidebarPanes.callstack.expand(),WebInspector.settings.watchExpressions.get().length>0&&this.sidebarPanes.watchExpressions.expand()},canSetFooterElement:function(){return!0},setFooterElement:function(e){e?(this._editorFooterElement.removeStyleClass("hidden"),this._editorFooterElement.appendChild(e),this._editorContentsElement.style.bottom=this._editorFooterElement.offsetHeight+"px"):(this._editorFooterElement.addStyleClass("hidden"),this._editorFooterElement.removeChildren(),this._editorContentsElement.style.bottom=0),this.doResize()},__proto__:WebInspector.Panel.prototype};