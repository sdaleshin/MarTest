/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.SourceFrame=function(e){WebInspector.View.call(this),this.element.addStyleClass("script-view"),this.element.addStyleClass("fill"),this._url=e.contentURL(),this._contentProvider=e;var t=new WebInspector.TextEditorDelegateForSourceFrame(this);loadScript("CodeMirrorTextEditor.js"),this._textEditor=new WebInspector.CodeMirrorTextEditor(this._url,t),this._currentSearchResultIndex=-1,this._searchResults=[],this._messages=[],this._rowMessages={},this._messageBubbles={},this._textEditor.setReadOnly(!this.canEditSource()),this._shortcuts={},this.addShortcut(WebInspector.KeyboardShortcut.makeKey("s",WebInspector.KeyboardShortcut.Modifiers.CtrlOrMeta),this._commitEditing.bind(this)),this.element.addEventListener("keydown",this._handleKeyDown.bind(this),!1),this._sourcePosition=new WebInspector.StatusBarText("","source-frame-cursor-position")},WebInspector.SourceFrame.createSearchRegex=function(e,t){var n;t=t||"";try{/^\/.+\/$/.test(e)&&(n=new RegExp(e.substring(1,e.length-1),t),n.__fromRegExpQuery=!0)}catch(r){}return n||(n=createPlainTextSearchRegex(e,"i"+t)),n},WebInspector.SourceFrame.Events={ScrollChanged:"ScrollChanged",SelectionChanged:"SelectionChanged"},WebInspector.SourceFrame.prototype={addShortcut:function(e,t){this._shortcuts[e]=t},wasShown:function(){this._ensureContentLoaded(),this._textEditor.show(this.element),this._editorAttached=!0,this._wasShownOrLoaded()},_isEditorShowing:function(){return this.isShowing()&&this._editorAttached},willHide:function(){WebInspector.View.prototype.willHide.call(this),this._clearPositionHighlight(),this._clearLineToReveal()},statusBarText:function(){return this._sourcePosition.element},statusBarItems:function(){return[]},defaultFocusedElement:function(){return this._textEditor.defaultFocusedElement()},get loaded(){return this._loaded},hasContent:function(){return!0},get textEditor(){return this._textEditor},_ensureContentLoaded:function(){this._contentRequested||(this._contentRequested=!0,this._contentProvider.requestContent(this.setContent.bind(this)))},addMessage:function(e){this._messages.push(e),this.loaded&&this.addMessageToSource(e.line-1,e)},clearMessages:function(){for(var e in this._messageBubbles){var t=this._messageBubbles[e],n=parseInt(e,10);this._textEditor.removeDecoration(n,t)}this._messages=[],this._rowMessages={},this._messageBubbles={}},canHighlightPosition:function(){return!0},highlightPosition:function(e,t){this._clearLineToReveal(),this._clearLineToScrollTo(),this._clearSelectionToSet(),this._positionToHighlight={line:e,column:t},this._innerHighlightPositionIfNeeded()},_innerHighlightPositionIfNeeded:function(){if(!this._positionToHighlight)return;if(!this.loaded||!this._isEditorShowing())return;this._textEditor.highlightPosition(this._positionToHighlight.line,this._positionToHighlight.column),delete this._positionToHighlight},_clearPositionHighlight:function(){this._textEditor.clearPositionHighlight(),delete this._positionToHighlight},revealLine:function(e){this._clearPositionHighlight(),this._clearLineToScrollTo(),this._clearSelectionToSet(),this._lineToReveal=e,this._innerRevealLineIfNeeded()},_innerRevealLineIfNeeded:function(){typeof this._lineToReveal=="number"&&this.loaded&&this._isEditorShowing()&&(this._textEditor.revealLine(this._lineToReveal),delete this._lineToReveal)},_clearLineToReveal:function(){delete this._lineToReveal},scrollToLine:function(e){this._clearPositionHighlight(),this._clearLineToReveal(),this._lineToScrollTo=e,this._innerScrollToLineIfNeeded()},_innerScrollToLineIfNeeded:function(){typeof this._lineToScrollTo=="number"&&this.loaded&&this._isEditorShowing()&&(this._textEditor.scrollToLine(this._lineToScrollTo),delete this._lineToScrollTo)},_clearLineToScrollTo:function(){delete this._lineToScrollTo},setSelection:function(e){this._selectionToSet=e,this._innerSetSelectionIfNeeded()},_innerSetSelectionIfNeeded:function(){this._selectionToSet&&this.loaded&&this._isEditorShowing()&&(this._textEditor.setSelection(this._selectionToSet),delete this._selectionToSet)},_clearSelectionToSet:function(){delete this._selectionToSet},_wasShownOrLoaded:function(){this._innerHighlightPositionIfNeeded(),this._innerRevealLineIfNeeded(),this._innerSetSelectionIfNeeded(),this._innerScrollToLineIfNeeded()},onTextChanged:function(e,t){this._isReplacing||WebInspector.searchController.cancelSearch(),this.clearMessages()},_simplifyMimeType:function(e,t){return t?t.indexOf("javascript")>=0||t.indexOf("jscript")>=0||t.indexOf("ecmascript")>=0?"text/javascript":t==="text/x-php"&&e.match(/\<\?.*\?\>/g)?"application/x-httpd-php":t:""},setContent:function(e,t,n){if(!this._loaded)this._loaded=!0,this._textEditor.setText(e||""),this._textEditor.markClean();else{var r=this._textEditor.firstVisibleLine(),i=this._textEditor.selection();this._textEditor.setText(e||""),this._textEditor.scrollToLine(r),this._textEditor.setSelection(i)}this._textEditor.setMimeType(this._simplifyMimeType(e,n)),this._textEditor.beginUpdates(),this._setTextEditorDecorations(),this._wasShownOrLoaded(),this._delayedFindSearchMatches&&(this._delayedFindSearchMatches(),delete this._delayedFindSearchMatches),this.onTextEditorContentLoaded(),this._textEditor.endUpdates()},onTextEditorContentLoaded:function(){},_setTextEditorDecorations:function(){this._rowMessages={},this._messageBubbles={},this._textEditor.beginUpdates(),this._addExistingMessagesToSource(),this._textEditor.endUpdates()},performSearch:function(e,t,n,r){function i(e){this._currentSearchResultIndex=-1,this._searchResults=[];var r=WebInspector.SourceFrame.createSearchRegex(e);this._searchRegex=r,this._searchResults=this._collectRegexMatches(r),this._searchResults.length?t?this.jumpToNextSearchResult():this._textEditor.highlightSearchResults(r,null):this._textEditor.cancelSearchResultsHighlight(),n(this,this._searchResults.length)}this._resetSearch(),this._currentSearchMatchChangedCallback=r,this.loaded?i.call(this,e):this._delayedFindSearchMatches=i.bind(this,e),this._ensureContentLoaded()},_editorFocused:function(){if(!this._searchResults.length)return;this._currentSearchResultIndex=-1,this._currentSearchMatchChangedCallback&&this._currentSearchMatchChangedCallback(this._currentSearchResultIndex),this._textEditor.highlightSearchResults(this._searchRegex,null)},_searchResultAfterSelectionIndex:function(e){if(!e)return 0;for(var t=0;t<this._searchResults.length;++t)if(this._searchResults[t].compareTo(e)>=0)return t;return 0},_resetSearch:function(){delete this._delayedFindSearchMatches,delete this._currentSearchMatchChangedCallback,this._currentSearchResultIndex=-1,this._searchResults=[],delete this._searchRegex},searchCanceled:function(){var e=this._currentSearchResultIndex!==-1?this._searchResults[this._currentSearchResultIndex]:null;this._resetSearch();if(!this.loaded)return;this._textEditor.cancelSearchResultsHighlight(),e&&this._textEditor.setSelection(e)},hasSearchResults:function(){return this._searchResults.length>0},jumpToFirstSearchResult:function(){this.jumpToSearchResult(0)},jumpToLastSearchResult:function(){this.jumpToSearchResult(this._searchResults.length-1)},jumpToNextSearchResult:function(){var e=this._searchResultAfterSelectionIndex(this._textEditor.selection()),t=this._currentSearchResultIndex===-1?e:e+1;this.jumpToSearchResult(t)},jumpToPreviousSearchResult:function(){var e=this._searchResultAfterSelectionIndex(this._textEditor.selection());this.jumpToSearchResult(e-1)},showingFirstSearchResult:function(){return this._searchResults.length&&this._currentSearchResultIndex===0},showingLastSearchResult:function(){return this._searchResults.length&&this._currentSearchResultIndex===this._searchResults.length-1},get currentSearchResultIndex(){return this._currentSearchResultIndex},jumpToSearchResult:function(e){if(!this.loaded||!this._searchResults.length)return;this._currentSearchResultIndex=(e+this._searchResults.length)%this._searchResults.length,this._currentSearchMatchChangedCallback&&this._currentSearchMatchChangedCallback(this._currentSearchResultIndex),this._textEditor.highlightSearchResults(this._searchRegex,this._searchResults[this._currentSearchResultIndex])},replaceSearchMatchWith:function(e){var t=this._searchResults[this._currentSearchResultIndex];if(!t)return;this._textEditor.highlightSearchResults(this._searchRegex,null),this._isReplacing=!0;var n=this._textEditor.editRange(t,e);delete this._isReplacing,this._textEditor.setSelection(n.collapseToEnd())},replaceAllWith:function(e,t){this._textEditor.highlightSearchResults(this._searchRegex,null);var n=this._textEditor.text(),r=this._textEditor.range(),i=WebInspector.SourceFrame.createSearchRegex(e,"g");i.__fromRegExpQuery?n=n.replace(i,t):n=n.replace(i,function(){return t}),this._isReplacing=!0,this._textEditor.editRange(r,n),delete this._isReplacing},_collectRegexMatches:function(e){var t=[];for(var n=0;n<this._textEditor.linesCount;++n){var r=this._textEditor.line(n),i=0;do{var s=e.exec(r);s&&(s[0].length&&t.push(new WebInspector.TextRange(n,i+s.index,n,i+s.index+s[0].length)),i+=s.index+1,r=r.substring(s.index+1))}while(s&&r)}return t},_addExistingMessagesToSource:function(){var e=this._messages.length;for(var t=0;t<e;++t)this.addMessageToSource(this._messages[t].line-1,this._messages[t])},addMessageToSource:function(e,t){e>=this._textEditor.linesCount&&(e=this._textEditor.linesCount-1),e<0&&(e=0);var n=this._rowMessages[e];n||(n=[],this._rowMessages[e]=n);for(var r=0;r<n.length;++r)if(n[r].consoleMessage.isEqual(t)){n[r].repeatCount=t.totalRepeatCount,this._updateMessageRepeatCount(n[r]);return}var i={consoleMessage:t};n.push(i),this._textEditor.beginUpdates();var s=this._messageBubbles[e];s||(s=document.createElement("div"),s.className="webkit-html-message-bubble",this._messageBubbles[e]=s,this._textEditor.addDecoration(e,s));var o=document.createElement("div");switch(t.level){case WebInspector.ConsoleMessage.MessageLevel.Error:s.addStyleClass("webkit-html-error-message"),o.className="error-icon-small";break;case WebInspector.ConsoleMessage.MessageLevel.Warning:s.addStyleClass("webkit-html-warning-message"),o.className="warning-icon-small"}var u=document.createElement("div");u.className="webkit-html-message-line",s.appendChild(u),u.appendChild(o),u.appendChild(document.createTextNode(t.message)),i.element=u,i.repeatCount=t.totalRepeatCount,this._updateMessageRepeatCount(i),this._textEditor.endUpdates()},_updateMessageRepeatCount:function(e){if(e.repeatCount<2)return;if(!e.repeatCountElement){var t=document.createElement("span");e.element.appendChild(t),e.repeatCountElement=t}e.repeatCountElement.textContent=WebInspector.UIString(" (repeated %d times)",e.repeatCount)},removeMessageFromSource:function(e,t){e>=this._textEditor.linesCount&&(e=this._textEditor.linesCount-1),e<0&&(e=0);var n=this._rowMessages[e];for(var r=0;n&&r<n.length;++r){var i=n[r];if(i.consoleMessage!==t)continue;var s=i.element,o=s.parentElement;o.removeChild(s),n.remove(i),n.length||delete this._rowMessages[e],o.childElementCount||(this._textEditor.removeDecoration(e,o),delete this._messageBubbles[e]);break}},populateLineGutterContextMenu:function(e,t){},populateTextAreaContextMenu:function(e,t){},inheritScrollPositions:function(e){this._textEditor.inheritScrollPositions(e._textEditor)},canEditSource:function(){return!1},commitEditing:function(e){},selectionChanged:function(e){this._updateSourcePosition(e),this.dispatchEventToListeners(WebInspector.SourceFrame.Events.SelectionChanged,e)},_updateSourcePosition:function(e){if(!e)return;if(e.isEmpty()){this._sourcePosition.setText(WebInspector.UIString("Line %d, Column %d",e.endLine+1,e.endColumn+1));return}e=e.normalize();var t=this._textEditor.copyRange(e);e.startLine===e.endLine?this._sourcePosition.setText(WebInspector.UIString("%d characters selected",t.length)):this._sourcePosition.setText(WebInspector.UIString("%d lines, %d characters selected",e.endLine-e.startLine+1,t.length))},scrollChanged:function(e){this.dispatchEventToListeners(WebInspector.SourceFrame.Events.ScrollChanged,e)},_handleKeyDown:function(e){var t=WebInspector.KeyboardShortcut.makeKeyFromEvent(e),n=this._shortcuts[t];n&&n()&&e.consume(!0)},_commitEditing:function(){if(this._textEditor.readOnly())return!1;var e=this._textEditor.text();return this.commitEditing(e),!0},__proto__:WebInspector.View.prototype},WebInspector.TextEditorDelegateForSourceFrame=function(e){this._sourceFrame=e},WebInspector.TextEditorDelegateForSourceFrame.prototype={onTextChanged:function(e,t){this._sourceFrame.onTextChanged(e,t)},selectionChanged:function(e){this._sourceFrame.selectionChanged(e)},scrollChanged:function(e){this._sourceFrame.scrollChanged(e)},editorFocused:function(){this._sourceFrame._editorFocused()},populateLineGutterContextMenu:function(e,t){this._sourceFrame.populateLineGutterContextMenu(e,t)},populateTextAreaContextMenu:function(e,t){this._sourceFrame.populateTextAreaContextMenu(e,t)},createLink:function(e,t){var n=WebInspector.ParsedURL.completeURL(this._sourceFrame._url,e);return WebInspector.linkifyURLAsNode(n||e,e,undefined,t)},__proto__:WebInspector.TextEditorDelegate.prototype};