/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.AuditsPanel=function(){WebInspector.Panel.call(this,"audits"),this.registerRequiredCSS("panelEnablerView.css"),this.registerRequiredCSS("auditsPanel.css"),this.createSidebarViewWithTree(),this.auditsTreeElement=new WebInspector.SidebarSectionTreeElement("",{},!0),this.sidebarTree.appendChild(this.auditsTreeElement),this.auditsTreeElement.listItemElement.addStyleClass("hidden"),this.auditsItemTreeElement=new WebInspector.AuditsSidebarTreeElement(this),this.auditsTreeElement.appendChild(this.auditsItemTreeElement),this.auditResultsTreeElement=new WebInspector.SidebarSectionTreeElement(WebInspector.UIString("RESULTS"),{},!0),this.sidebarTree.appendChild(this.auditResultsTreeElement),this.auditResultsTreeElement.expand(),this.clearResultsButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear audit results."),"clear-status-bar-item"),this.clearResultsButton.addEventListener("click",this._clearButtonClicked,this),this.viewsContainerElement=this.splitView.mainElement,this._constructCategories(),this._auditController=new WebInspector.AuditController(this),this._launcherView=new WebInspector.AuditLauncherView(this._auditController);for(var e in this.categoriesById)this._launcherView.addCategory(this.categoriesById[e])},WebInspector.AuditsPanel.prototype={get statusBarItems(){return[this.clearResultsButton.element]},get categoriesById(){return this._auditCategoriesById},addCategory:function(e){this.categoriesById[e.id]=e,this._launcherView.addCategory(e)},getCategory:function(e){return this.categoriesById[e]},_constructCategories:function(){this._auditCategoriesById={};for(var e in WebInspector.AuditCategories){var t=new WebInspector.AuditCategories[e];t._id=e,this.categoriesById[e]=t}},auditFinishedCallback:function(e,t){var n=this.auditResultsTreeElement.children,r=1;for(var i=0;i<n.length;++i)n[i].mainResourceURL===e&&r++;var s=new WebInspector.AuditResultSidebarTreeElement(this,t,e,r);this.auditResultsTreeElement.appendChild(s),s.revealAndSelect()},showResults:function(e){e._resultView||(e._resultView=new WebInspector.AuditResultView(e)),this.visibleView=e._resultView},showLauncherView:function(){this.visibleView=this._launcherView},get visibleView(){return this._visibleView},set visibleView(e){if(this._visibleView===e)return;this._visibleView&&this._visibleView.detach(),this._visibleView=e,e&&e.show(this.viewsContainerElement)},wasShown:function(){WebInspector.Panel.prototype.wasShown.call(this),this._visibleView||this.auditsItemTreeElement.select()},_clearButtonClicked:function(){this.auditsItemTreeElement.revealAndSelect(),this.auditResultsTreeElement.removeChildren()},__proto__:WebInspector.Panel.prototype},WebInspector.AuditCategory=function(e){this._displayName=e,this._rules=[]},WebInspector.AuditCategory.prototype={get id(){return this._id},get displayName(){return this._displayName},addRule:function(e,t){e.severity=t,this._rules.push(e)},run:function(e,t,n,r){function s(e){t(e),r.worked(),--i||n()}this._ensureInitialized();var i=this._rules.length;r.setTotalWork(i);for(var o=0;o<this._rules.length;++o)this._rules[o].run(e,s,r)},_ensureInitialized:function(){this._initialized||("initialize"in this&&this.initialize(),this._initialized=!0)}},WebInspector.AuditRule=function(e,t){this._id=e,this._displayName=t},WebInspector.AuditRule.Severity={Info:"info",Warning:"warning",Severe:"severe"},WebInspector.AuditRule.SeverityOrder={info:3,warning:2,severe:1},WebInspector.AuditRule.prototype={get id(){return this._id},get displayName(){return this._displayName},set severity(e){this._severity=e},run:function(e,t,n){if(n.isCanceled())return;var r=new WebInspector.AuditRuleResult(this.displayName);r.severity=this._severity,this.doRun(e,r,t,n)},doRun:function(e,t,n,r){throw new Error("doRun() not implemented")}},WebInspector.AuditCategoryResult=function(e){this.title=e.displayName,this.ruleResults=[]},WebInspector.AuditCategoryResult.prototype={addRuleResult:function(e){this.ruleResults.push(e)}},WebInspector.AuditRuleResult=function(e,t,n){this.value=e,this.className=n,this.expanded=t,this.violationCount=0,this._formatters={r:WebInspector.AuditRuleResult.linkifyDisplayName};var r=Object.keys(String.standardFormatters);for(var i=0;i<r.length;++i)this._formatters[r[i]]=String.standardFormatters[r[i]]},WebInspector.AuditRuleResult.linkifyDisplayName=function(e){return WebInspector.linkifyURLAsNode(e,WebInspector.displayNameForURL(e))},WebInspector.AuditRuleResult.resourceDomain=function(e){return e||WebInspector.UIString("[empty domain]")},WebInspector.AuditRuleResult.prototype={addChild:function(e,t,n){this.children||(this.children=[]);var r=new WebInspector.AuditRuleResult(e,t,n);return this.children.push(r),r},addURL:function(e){this.addChild(WebInspector.AuditRuleResult.linkifyDisplayName(e))},addURLs:function(e){for(var t=0;t<e.length;++t)this.addURL(e[t])},addSnippet:function(e){this.addChild(e,!1,"source-code")},addFormatted:function(e,t){function i(e,t){return t instanceof Node||(t=document.createTextNode(t)),e.appendChild(t),e}var n=Array.prototype.slice.call(arguments,1),r=document.createDocumentFragment(),s=String.format(e,n,this._formatters,r,i).formattedResult;return s instanceof Node&&s.normalize(),this.addChild(s)}},WebInspector.AuditsSidebarTreeElement=function(e){this._panel=e,this.small=!1,WebInspector.SidebarTreeElement.call(this,"audits-sidebar-tree-item",WebInspector.UIString("Audits"),"",null,!1)},WebInspector.AuditsSidebarTreeElement.prototype={onattach:function(){WebInspector.SidebarTreeElement.prototype.onattach.call(this)},onselect:function(){this._panel.showLauncherView()},get selectable(){return!0},refresh:function(){this.refreshTitles()},__proto__:WebInspector.SidebarTreeElement.prototype},WebInspector.AuditResultSidebarTreeElement=function(e,t,n,r){this._panel=e,this.results=t,this.mainResourceURL=n,WebInspector.SidebarTreeElement.call(this,"audit-result-sidebar-tree-item",String.sprintf("%s (%d)",n,r),"",{},!1)},WebInspector.AuditResultSidebarTreeElement.prototype={onselect:function(){this._panel.showResults(this.results)},get selectable(){return!0},__proto__:WebInspector.SidebarTreeElement.prototype},WebInspector.AuditRules={},WebInspector.AuditCategories={},importScript("AuditCategories.js"),importScript("AuditController.js"),importScript("AuditFormatters.js"),importScript("AuditLauncherView.js"),importScript("AuditResultView.js"),importScript("AuditRules.js");