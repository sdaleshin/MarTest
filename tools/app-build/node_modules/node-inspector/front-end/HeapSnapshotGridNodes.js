/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.HeapSnapshotGridNode=function(e,t){WebInspector.DataGridNode.call(this,null,t),this._dataGrid=e,this._instanceCount=0,this._savedChildren=null,this._retrievedChildrenRanges=[]},WebInspector.HeapSnapshotGridNode.Events={PopulateComplete:"PopulateComplete"},WebInspector.HeapSnapshotGridNode.prototype={createProvider:function(){throw new Error("Needs implemented.")},_provider:function(){return this._providerObject||(this._providerObject=this.createProvider()),this._providerObject},createCell:function(e){var t=WebInspector.DataGridNode.prototype.createCell.call(this,e);return this._searchMatched&&t.addStyleClass("highlight"),t},collapse:function(){WebInspector.DataGridNode.prototype.collapse.call(this),this._dataGrid.updateVisibleNodes()},dispose:function(){this._provider()&&this._provider().dispose();for(var e=this.children[0];e;e=e.traverseNextNode(!0,this,!0))e.dispose&&e.dispose()},_reachableFromWindow:!1,queryObjectContent:function(e){},wasDetached:function(){this._dataGrid.nodeWasDetached(this)},_toPercentString:function(e){return e.toFixed(0)+" %"},childForPosition:function(e){var t=0;for(var n=0;n<this._retrievedChildrenRanges.length;n++){var r=this._retrievedChildrenRanges[n];if(r.from<=e&&e<r.to){var i=t+e-r.from;return this.children[i]}t+=r.to-r.from+1}return null},_createValueCell:function(e){var t=document.createElement("td");t.className=e+"-column";if(this.dataGrid.snapshot.totalSize!==0){var n=document.createElement("div"),r=document.createElement("span");r.textContent=this.data[e],n.appendChild(r);var i=e+"-percent";if(i in this.data){var s=document.createElement("span");s.className="percent-column",s.textContent=this.data[i],n.appendChild(s),n.addStyleClass("heap-snapshot-multiple-values")}t.appendChild(n)}return t},populate:function(e){function t(){this._populateChildren()}if(this._populated)return;this._populated=!0,this._provider().sortAndRewind(this.comparator(),t.bind(this))},expandWithoutPopulate:function(e){this._populated=!0,this.expand(),this._provider().sortAndRewind(this.comparator(),e)},_populateChildren:function(e,t,n){function i(){if(r>=t)return;var e=Math.min(r+this._dataGrid.defaultPopulateCount(),t);this._provider().serializeItemsRange(r,e,u.bind(this)),r=e}function s(e,t){if(this._savedChildren){var n=this._childHashForEntity(e);if(n in this._savedChildren){this.insertChild(this._savedChildren[n],t);return}}this.insertChild(this._createChildNode(e),t)}function o(e,t,n){var r=new WebInspector.ShowMoreDataGridNode(this._populateChildren.bind(this),e,t,this._dataGrid.defaultPopulateCount());this.insertChild(r,n)}function u(e){var u=0,a=e.startPosition,f=0;if(!this._retrievedChildrenRanges.length){e.startPosition>0&&(this._retrievedChildrenRanges.push({from:0,to:0}),o.call(this,0,e.startPosition,f++)),this._retrievedChildrenRanges.push({from:e.startPosition,to:e.endPosition});for(var l=0,c=e.length;l<c;++l)s.call(this,e[l],f++);e.endPosition<e.totalLength&&o.call(this,e.endPosition,e.totalLength,f++)}else{var h=0,p=!1,d;while(h<this._retrievedChildrenRanges.length){d=this._retrievedChildrenRanges[h];if(d.to>=a){p=!0;break}f+=d.to-d.from,d.to<e.totalLength&&(f+=1),++h}!p||e.startPosition<d.from?(this.children[f-1].setEndPosition(e.startPosition),o.call(this,e.startPosition,p?d.from:e.totalLength,f),d={from:e.startPosition,to:e.startPosition},p||(h=this._retrievedChildrenRanges.length),this._retrievedChildrenRanges.splice(h,0,d)):f+=a-d.from;while(d.to<e.endPosition){var v=d.to-a;f+=v,u+=v,a=d.to;var m=this._retrievedChildrenRanges[h+1],g=m?m.from:e.totalLength;g>e.endPosition&&(g=e.endPosition);while(a<g)s.call(this,e[u++],f++),++a;m&&g===m.from?(d.to=m.to,this.removeChild(this.children[f]),this._retrievedChildrenRanges.splice(h+1,1)):(d.to=g,g===e.totalLength?this.removeChild(this.children[f]):this.children[f].setStartPosition(e.endPosition))}}this._instanceCount+=e.length;if(r<t){i.call(this);return}n&&n(),this.dispatchEventToListeners(WebInspector.HeapSnapshotGridNode.Events.PopulateComplete)}e=e||0,t=t||e+this._dataGrid.defaultPopulateCount();var r=e;i.call(this)},_saveChildren:function(){this._savedChildren=null;for(var e=0,t=this.children.length;e<t;++e){var n=this.children[e];if(!n.expanded)continue;this._savedChildren||(this._savedChildren={}),this._savedChildren[this._childHashForNode(n)]=n}},sort:function(){function e(){function e(){for(var e=0,t=this.children.length;e<t;++e){var n=this.children[e];n.expanded&&n.sort()}this._dataGrid.recursiveSortingLeave()}this._saveChildren(),this.removeChildren(),this._retrievedChildrenRanges=[];var t=this._instanceCount;this._instanceCount=0,this._populateChildren(0,t,e.bind(this))}this._dataGrid.recursiveSortingEnter(),this._provider().sortAndRewind(this.comparator(),e.bind(this))},__proto__:WebInspector.DataGridNode.prototype},WebInspector.HeapSnapshotGenericObjectNode=function(e,t){this.snapshotNodeIndex=0,WebInspector.HeapSnapshotGridNode.call(this,e,!1);if(!t)return;this._name=t.name,this._displayName=t.displayName,this._type=t.type,this._distance=t.distance,this._shallowSize=t.selfSize,this._retainedSize=t.retainedSize,this.snapshotNodeId=t.id,this.snapshotNodeIndex=t.nodeIndex,this._type==="string"?this._reachableFromWindow=!0:this._type==="object"&&this._name.startsWith("Window")?(this._name=this.shortenWindowURL(this._name,!1),this._reachableFromWindow=!0):t.canBeQueried&&(this._reachableFromWindow=!0),t.detachedDOMTreeNode&&(this.detachedDOMTreeNode=!0)},WebInspector.HeapSnapshotGenericObjectNode.prototype={createCell:function(e){var t=e!=="object"?this._createValueCell(e):this._createObjectCell();return this._searchMatched&&t.addStyleClass("highlight"),t},_createObjectCell:function(){var e=document.createElement("td");e.className="object-column";var t=document.createElement("div");t.className="source-code event-properties",t.style.overflow="visible";var n=this.data.object;this._prefixObjectCell&&this._prefixObjectCell(t,n);var r=document.createElement("span");r.className="value console-formatted-"+n.valueStyle,r.textContent=n.value,t.appendChild(r);if(this.data.displayName){var i=document.createElement("span");i.className="name console-formatted-name",i.textContent=" "+this.data.displayName,t.appendChild(i)}var s=document.createElement("span");return s.className="console-formatted-id",s.textContent=" @"+n.nodeId,t.appendChild(s),this._postfixObjectCell&&this._postfixObjectCell(t,n),e.appendChild(t),e.addStyleClass("disclosure"),this.depth&&e.style.setProperty("padding-left",this.depth*this.dataGrid.indentWidth+"px"),e.heapSnapshotNode=this,e},get data(){var e=this._emptyData(),t=this._name,n="object";switch(this._type){case"string":t='"'+t+'"',n="string";break;case"regexp":t="/"+t+"/",n="string";break;case"closure":t="function"+(t?" ":"")+t+"()",n="function";break;case"number":n="number";break;case"hidden":n="null";break;case"array":t?t+="[]":t="[]"}return this._reachableFromWindow&&(n+=" highlight"),t==="Object"&&(t=""),this.detachedDOMTreeNode&&(n+=" detached-dom-tree-node"),e.object={valueStyle:n,value:t,nodeId:this.snapshotNodeId},e.displayName=this._displayName,e.distance=this._distance,e.shallowSize=Number.withThousandsSeparator(this._shallowSize),e.retainedSize=Number.withThousandsSeparator(this._retainedSize),e["shallowSize-percent"]=this._toPercentString(this._shallowSizePercent),e["retainedSize-percent"]=this._toPercentString(this._retainedSizePercent),this._enhanceData?this._enhanceData(e):e},queryObjectContent:function(e,t){if(this._type==="string")e(WebInspector.RemoteObject.fromPrimitiveValue(this._name));else{function n(t,n){!t&&n.type?e(WebInspector.RemoteObject.fromPayload(n),!!t):e(WebInspector.RemoteObject.fromPrimitiveValue(WebInspector.UIString("Not available")))}HeapProfilerAgent.getObjectByHeapObjectId(String(this.snapshotNodeId),t,n)}},get _retainedSizePercent(){return this._retainedSize/this.dataGrid.snapshot.totalSize*100},get _shallowSizePercent(){return this._shallowSize/this.dataGrid.snapshot.totalSize*100},updateHasChildren:function(){function e(e){this.hasChildren=!e}this._provider().isEmpty(e.bind(this))},shortenWindowURL:function(e,t){var n=e.indexOf("/"),r=t?e.indexOf("@"):e.length;if(n!==-1&&r!==-1){var i=e.substring(n+1,r).trimLeft(),s=i.trimURL();return s.length>40&&(s=s.trimMiddle(40)),e.substr(0,n+2)+s+e.substr(r)}return e},__proto__:WebInspector.HeapSnapshotGridNode.prototype},WebInspector.HeapSnapshotObjectNode=function(e,t,n,r){WebInspector.HeapSnapshotGenericObjectNode.call(this,e,n.node),this._referenceName=n.name,this._referenceType=n.type,this._distance=n.distance,this.showRetainingEdges=e.showRetainingEdges,this._isFromBaseSnapshot=t,this._parentGridNode=r,this._cycledWithAncestorGridNode=this._findAncestorWithSameSnapshotNodeId(),this._cycledWithAncestorGridNode||this.updateHasChildren()},WebInspector.HeapSnapshotObjectNode.prototype={createProvider:function(){var e=this._dataGrid,t=WebInspector.settings.showAdvancedHeapSnapshotProperties.get(),n=this._isFromBaseSnapshot?e.baseSnapshot:e.snapshot;return this.showRetainingEdges?n.createRetainingEdgesProvider(this.snapshotNodeIndex,t):n.createEdgesProvider(this.snapshotNodeIndex,t)},_findAncestorWithSameSnapshotNodeId:function(){var e=this._parentGridNode;while(e){if(e.snapshotNodeId===this.snapshotNodeId)return e;e=e._parentGridNode}return null},_createChildNode:function(e){return new WebInspector.HeapSnapshotObjectNode(this._dataGrid,this._isFromBaseSnapshot,e,this)},_childHashForEntity:function(e){var t=this.showRetainingEdges?e.node.id+"#":"";return t+e.type+"#"+e.name},_childHashForNode:function(e){var t=this.showRetainingEdges?e.snapshotNodeId+"#":"";return t+e._referenceType+"#"+e._referenceName},comparator:function(){var e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnIdentifier(),n={object:["!edgeName",e,"retainedSize",!1],count:["!edgeName",!0,"retainedSize",!1],shallowSize:["selfSize",e,"!edgeName",!0],retainedSize:["retainedSize",e,"!edgeName",!0],distance:["distance",e,"_name",!0]}[t]||["!edgeName",!0,"retainedSize",!1];return WebInspector.HeapSnapshotFilteredOrderedIterator.prototype.createComparator(n)},_emptyData:function(){return{count:"",addedCount:"",removedCount:"",countDelta:"",addedSize:"",removedSize:"",sizeDelta:""}},_enhanceData:function(e){var t=this._referenceName;t===""&&(t="(empty)");var n="name";switch(this._referenceType){case"context":n="console-formatted-number";break;case"internal":case"hidden":n="console-formatted-null";break;case"element":t="["+t+"]"}return e.object.nameClass=n,e.object.name=t,e.distance=this._distance,e},_prefixObjectCell:function(e,t){this._cycledWithAncestorGridNode&&(e.className+=" cycled-ancessor-node");var n=document.createElement("span");n.className=t.nameClass,n.textContent=t.name,e.appendChild(n);var r=document.createElement("span");r.className="grayed",r.textContent=this.showRetainingEdges?" in ":" :: ",e.appendChild(r)},__proto__:WebInspector.HeapSnapshotGenericObjectNode.prototype},WebInspector.HeapSnapshotInstanceNode=function(e,t,n,r){WebInspector.HeapSnapshotGenericObjectNode.call(this,e,r),this._baseSnapshotOrSnapshot=t||n,this._isDeletedNode=!!t,this.updateHasChildren()},WebInspector.HeapSnapshotInstanceNode.prototype={createProvider:function(){var e=WebInspector.settings.showAdvancedHeapSnapshotProperties.get();return this._baseSnapshotOrSnapshot.createEdgesProvider(this.snapshotNodeIndex,e)},_createChildNode:function(e){return new WebInspector.HeapSnapshotObjectNode(this._dataGrid,this._isDeletedNode,e,null)},_childHashForEntity:function(e){return e.type+"#"+e.name},_childHashForNode:function(e){return e._referenceType+"#"+e._referenceName},comparator:function(){var e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnIdentifier(),n={object:["!edgeName",e,"retainedSize",!1],distance:["distance",e,"retainedSize",!1],count:["!edgeName",!0,"retainedSize",!1],addedSize:["selfSize",e,"!edgeName",!0],removedSize:["selfSize",e,"!edgeName",!0],shallowSize:["selfSize",e,"!edgeName",!0],retainedSize:["retainedSize",e,"!edgeName",!0]}[t]||["!edgeName",!0,"retainedSize",!1];return WebInspector.HeapSnapshotFilteredOrderedIterator.prototype.createComparator(n)},_emptyData:function(){return{count:"",countDelta:"",sizeDelta:""}},_enhanceData:function(e){return this._isDeletedNode?(e.addedCount="",e.addedSize="",e.removedCount="•",e.removedSize=Number.withThousandsSeparator(this._shallowSize)):(e.addedCount="•",e.addedSize=Number.withThousandsSeparator(this._shallowSize),e.removedCount="",e.removedSize=""),e},get isDeletedNode(){return this._isDeletedNode},__proto__:WebInspector.HeapSnapshotGenericObjectNode.prototype},WebInspector.HeapSnapshotConstructorNode=function(e,t,n,r){WebInspector.HeapSnapshotGridNode.call(this,e,n.count>0),this._name=t,this._aggregatesKey=r,this._distance=n.distance,this._count=n.count,this._shallowSize=n.self,this._retainedSize=n.maxRet},WebInspector.HeapSnapshotConstructorNode.prototype={createProvider:function(){return this._dataGrid.snapshot.createNodesProviderForClass(this._name,this._aggregatesKey)},revealNodeBySnapshotObjectId:function(e){function t(){this._provider().nodePosition(e,n.bind(this))}function n(e){e===-1?this.collapse():this._populateChildren(e,null,r.bind(this,e))}function r(e){var t=0;for(var n=0;n<this._retrievedChildrenRanges.length;n++){var r=this._retrievedChildrenRanges[n];if(r.from<=e&&e<r.to){var i=t+e-r.from,s=this.children[i];this._dataGrid.highlightNode(s);return}t+=r.to-r.from+1}}this.expandWithoutPopulate(t.bind(this))},createCell:function(e){var t=e!=="object"?this._createValueCell(e):WebInspector.HeapSnapshotGridNode.prototype.createCell.call(this,e);return this._searchMatched&&t.addStyleClass("highlight"),t},_createChildNode:function(e){return new WebInspector.HeapSnapshotInstanceNode(this._dataGrid,null,this._dataGrid.snapshot,e)},comparator:function(){var e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnIdentifier(),n={object:["id",e,"retainedSize",!1],distance:["distance",!0,"retainedSize",!1],count:["id",!0,"retainedSize",!1],shallowSize:["selfSize",e,"id",!0],retainedSize:["retainedSize",e,"id",!0]}[t];return WebInspector.HeapSnapshotFilteredOrderedIterator.prototype.createComparator(n)},_childHashForEntity:function(e){return e.id},_childHashForNode:function(e){return e.snapshotNodeId},get data(){var e={object:this._name};return e.count=Number.withThousandsSeparator(this._count),e.distance=this._distance,e.shallowSize=Number.withThousandsSeparator(this._shallowSize),e.retainedSize=Number.withThousandsSeparator(this._retainedSize),e["count-percent"]=this._toPercentString(this._countPercent),e["shallowSize-percent"]=this._toPercentString(this._shallowSizePercent),e["retainedSize-percent"]=this._toPercentString(this._retainedSizePercent),e},get _countPercent(){return this._count/this.dataGrid.snapshot.nodeCount*100},get _retainedSizePercent(){return this._retainedSize/this.dataGrid.snapshot.totalSize*100},get _shallowSizePercent(){return this._shallowSize/this.dataGrid.snapshot.totalSize*100},__proto__:WebInspector.HeapSnapshotGridNode.prototype},WebInspector.HeapSnapshotDiffNodesProvider=function(e,t,n,r){this._addedNodesProvider=e,this._deletedNodesProvider=t,this._addedCount=n,this._removedCount=r},WebInspector.HeapSnapshotDiffNodesProvider.prototype={dispose:function(){this._addedNodesProvider.dispose(),this._deletedNodesProvider.dispose()},isEmpty:function(e){e(!1)},serializeItemsRange:function(e,t,n){function r(e){e.totalLength=this._addedCount+this._removedCount,n(e)}function i(e,t){e.length||(e.startPosition=this._addedCount+t.startPosition);for(var n=0;n<t.length;n++)t[n].isAddedNotRemoved=!1,e.push(t[n]);e.endPosition=this._addedCount+t.endPosition,r.call(this,e)}function s(e){for(var n=0;n<e.length;n++)e[n].isAddedNotRemoved=!0;if(e.endPosition<t)return this._deletedNodesProvider.serializeItemsRange(0,t-e.endPosition,i.bind(this,e));e.totalLength=this._addedCount+this._removedCount,r.call(this,e)}e<this._addedCount?this._addedNodesProvider.serializeItemsRange(e,t,s.bind(this)):this._deletedNodesProvider.serializeItemsRange(e-this._addedCount,t-this._addedCount,i.bind(this,[]))},sortAndRewind:function(e,t){function n(){this._deletedNodesProvider.sortAndRewind(e,t)}this._addedNodesProvider.sortAndRewind(e,n.bind(this))}},WebInspector.HeapSnapshotDiffNode=function(e,t,n){WebInspector.HeapSnapshotGridNode.call(this,e,!0),this._name=t,this._addedCount=n.addedCount,this._removedCount=n.removedCount,this._countDelta=n.countDelta,this._addedSize=n.addedSize,this._removedSize=n.removedSize,this._sizeDelta=n.sizeDelta,this._deletedIndexes=n.deletedIndexes},WebInspector.HeapSnapshotDiffNode.prototype={createProvider:function(){var e=this._dataGrid;return new WebInspector.HeapSnapshotDiffNodesProvider(e.snapshot.createAddedNodesProvider(e.baseSnapshot.uid,this._name),e.baseSnapshot.createDeletedNodesProvider(this._deletedIndexes),this._addedCount,this._removedCount)},_createChildNode:function(e){return e.isAddedNotRemoved?new WebInspector.HeapSnapshotInstanceNode(this._dataGrid,null,this._dataGrid.snapshot,e):new WebInspector.HeapSnapshotInstanceNode(this._dataGrid,this._dataGrid.baseSnapshot,null,e)},_childHashForEntity:function(e){return e.id},_childHashForNode:function(e){return e.snapshotNodeId},comparator:function(){var e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnIdentifier(),n={object:["id",e,"selfSize",!1],addedCount:["selfSize",e,"id",!0],removedCount:["selfSize",e,"id",!0],countDelta:["selfSize",e,"id",!0],addedSize:["selfSize",e,"id",!0],removedSize:["selfSize",e,"id",!0],sizeDelta:["selfSize",e,"id",!0]}[t];return WebInspector.HeapSnapshotFilteredOrderedIterator.prototype.createComparator(n)},_signForDelta:function(e){return e===0?"":e>0?"+":"−"},get data(){var e={object:this._name};return e.addedCount=Number.withThousandsSeparator(this._addedCount),e.removedCount=Number.withThousandsSeparator(this._removedCount),e.countDelta=this._signForDelta(this._countDelta)+Number.withThousandsSeparator(Math.abs(this._countDelta)),e.addedSize=Number.withThousandsSeparator(this._addedSize),e.removedSize=Number.withThousandsSeparator(this._removedSize),e.sizeDelta=this._signForDelta(this._sizeDelta)+Number.withThousandsSeparator(Math.abs(this._sizeDelta)),e},__proto__:WebInspector.HeapSnapshotGridNode.prototype},WebInspector.HeapSnapshotDominatorObjectNode=function(e,t){WebInspector.HeapSnapshotGenericObjectNode.call(this,e,t),this.updateHasChildren()},WebInspector.HeapSnapshotDominatorObjectNode.prototype={createProvider:function(){return this._dataGrid.snapshot.createNodesProviderForDominator(this.snapshotNodeIndex)},retrieveChildBySnapshotObjectId:function(e,t){function n(){this._provider().nodePosition(e,r.bind(this))}function r(e){e===-1?(this.collapse(),t(null)):this._populateChildren(e,null,i.bind(this,e))}function i(e){var n=this.childForPosition(e);t(n)}this.hasChildren=!0,this.expandWithoutPopulate(n.bind(this))},_createChildNode:function(e){return new WebInspector.HeapSnapshotDominatorObjectNode(this._dataGrid,e)},_childHashForEntity:function(e){return e.id},_childHashForNode:function(e){return e.snapshotNodeId},comparator:function(){var e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnIdentifier(),n={object:["id",e,"retainedSize",!1],shallowSize:["selfSize",e,"id",!0],retainedSize:["retainedSize",e,"id",!0]}[t];return WebInspector.HeapSnapshotFilteredOrderedIterator.prototype.createComparator(n)},_emptyData:function(){return{}},__proto__:WebInspector.HeapSnapshotGenericObjectNode.prototype};