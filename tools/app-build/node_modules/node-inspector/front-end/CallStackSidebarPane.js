/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CallStackSidebarPane=function(){WebInspector.SidebarPane.call(this,WebInspector.UIString("Call Stack")),this._model=WebInspector.debuggerModel,this.bodyElement.addEventListener("keydown",this._keyDown.bind(this),!0),this.bodyElement.tabIndex=0},WebInspector.CallStackSidebarPane.Events={CallFrameSelected:"CallFrameSelected"},WebInspector.CallStackSidebarPane.prototype={update:function(e){this.bodyElement.removeChildren(),delete this._statusMessageElement,this.placards=[];if(!e){var t=document.createElement("div");t.className="info",t.textContent=WebInspector.UIString("Not Paused"),this.bodyElement.appendChild(t);return}for(var n=0;n<e.length;++n){var r=e[n],i=new WebInspector.CallStackSidebarPane.Placard(r,this);i.element.addEventListener("click",this._placardSelected.bind(this,i),!1),this.placards.push(i),this.bodyElement.appendChild(i.element)}},setSelectedCallFrame:function(e){for(var t=0;t<this.placards.length;++t){var n=this.placards[t];n.selected=n._callFrame===e}},_selectNextCallFrameOnStack:function(e){var t=this._selectedCallFrameIndex();return t==-1?!0:(this._selectedPlacardByIndex(t+1),!0)},_selectPreviousCallFrameOnStack:function(e){var t=this._selectedCallFrameIndex();return t==-1?!0:(this._selectedPlacardByIndex(t-1),!0)},_selectedPlacardByIndex:function(e){if(e<0||e>=this.placards.length)return;this._placardSelected(this.placards[e])},_selectedCallFrameIndex:function(){if(!this._model.selectedCallFrame())return-1;for(var e=0;e<this.placards.length;++e){var t=this.placards[e];if(t._callFrame===this._model.selectedCallFrame())return e}return-1},_placardSelected:function(e){this.dispatchEventToListeners(WebInspector.CallStackSidebarPane.Events.CallFrameSelected,e._callFrame)},_copyStackTrace:function(){var e="";for(var t=0;t<this.placards.length;++t)e+=this.placards[t].title+" ("+this.placards[t].subtitle+")\n";InspectorFrontendHost.copyText(e)},registerShortcuts:function(e){e(WebInspector.ScriptsPanelDescriptor.ShortcutKeys.NextCallFrame,this._selectNextCallFrameOnStack.bind(this)),e(WebInspector.ScriptsPanelDescriptor.ShortcutKeys.PrevCallFrame,this._selectPreviousCallFrameOnStack.bind(this))},setStatus:function(e){this._statusMessageElement||(this._statusMessageElement=document.createElement("div"),this._statusMessageElement.className="info",this.bodyElement.appendChild(this._statusMessageElement)),typeof e=="string"?this._statusMessageElement.textContent=e:(this._statusMessageElement.removeChildren(),this._statusMessageElement.appendChild(e))},_keyDown:function(e){if(e.altKey||e.shiftKey||e.metaKey||e.ctrlKey)return;e.keyIdentifier==="Up"?(this._selectPreviousCallFrameOnStack(),e.consume()):e.keyIdentifier==="Down"&&(this._selectNextCallFrameOnStack(),e.consume())},__proto__:WebInspector.SidebarPane.prototype},WebInspector.CallStackSidebarPane.Placard=function(e,t){WebInspector.Placard.call(this,e.functionName||WebInspector.UIString("(anonymous function)"),""),e.createLiveLocation(this._update.bind(this)),this.element.addEventListener("contextmenu",this._placardContextMenu.bind(this),!0),this._callFrame=e,this._pane=t},WebInspector.CallStackSidebarPane.Placard.prototype={_update:function(e){this.subtitle=e.linkText().trimMiddle(100)},_placardContextMenu:function(e){var t=new WebInspector.ContextMenu(e);WebInspector.debuggerModel.canSetScriptSource()&&(t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Restart frame":"Restart Frame"),this._restartFrame.bind(this)),t.appendSeparator()),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Copy stack trace":"Copy Stack Trace"),this._pane._copyStackTrace.bind(this._pane)),t.show()},_restartFrame:function(){this._callFrame.restart(undefined)},__proto__:WebInspector.Placard.prototype};