/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.TimelineModel=function(){this._records=[],this._stringPool=new StringPool,this._minimumRecordTime=-1,this._maximumRecordTime=-1,this._collectionEnabled=!1,WebInspector.timelineManager.addEventListener(WebInspector.TimelineManager.EventTypes.TimelineEventRecorded,this._onRecordAdded,this)},WebInspector.TimelineModel.TransferChunkLengthBytes=5e6,WebInspector.TimelineModel.RecordType={Root:"Root",Program:"Program",EventDispatch:"EventDispatch",BeginFrame:"BeginFrame",ScheduleStyleRecalculation:"ScheduleStyleRecalculation",RecalculateStyles:"RecalculateStyles",InvalidateLayout:"InvalidateLayout",Layout:"Layout",PaintSetup:"PaintSetup",Paint:"Paint",Rasterize:"Rasterize",ScrollLayer:"ScrollLayer",DecodeImage:"DecodeImage",ResizeImage:"ResizeImage",CompositeLayers:"CompositeLayers",ParseHTML:"ParseHTML",TimerInstall:"TimerInstall",TimerRemove:"TimerRemove",TimerFire:"TimerFire",XHRReadyStateChange:"XHRReadyStateChange",XHRLoad:"XHRLoad",EvaluateScript:"EvaluateScript",MarkLoad:"MarkLoad",MarkDOMContent:"MarkDOMContent",TimeStamp:"TimeStamp",Time:"Time",TimeEnd:"TimeEnd",ScheduleResourceRequest:"ScheduleResourceRequest",ResourceSendRequest:"ResourceSendRequest",ResourceReceiveResponse:"ResourceReceiveResponse",ResourceReceivedData:"ResourceReceivedData",ResourceFinish:"ResourceFinish",FunctionCall:"FunctionCall",GCEvent:"GCEvent",RequestAnimationFrame:"RequestAnimationFrame",CancelAnimationFrame:"CancelAnimationFrame",FireAnimationFrame:"FireAnimationFrame",WebSocketCreate:"WebSocketCreate",WebSocketSendHandshakeRequest:"WebSocketSendHandshakeRequest",WebSocketReceiveHandshakeResponse:"WebSocketReceiveHandshakeResponse",WebSocketDestroy:"WebSocketDestroy"},WebInspector.TimelineModel.Events={RecordAdded:"RecordAdded",RecordsCleared:"RecordsCleared"},WebInspector.TimelineModel.startTimeInSeconds=function(e){return e.startTime/1e3},WebInspector.TimelineModel.endTimeInSeconds=function(e){return(typeof e.endTime=="undefined"?e.startTime:e.endTime)/1e3},WebInspector.TimelineModel.durationInSeconds=function(e){return WebInspector.TimelineModel.endTimeInSeconds(e)-WebInspector.TimelineModel.startTimeInSeconds(e)},WebInspector.TimelineModel.aggregateTimeForRecord=function(e,t){var n=0,r=t.children||[];for(var i=0;i<r.length;++i)WebInspector.TimelineModel.aggregateTimeForRecord(e,r[i]),n+=WebInspector.TimelineModel.durationInSeconds(r[i]);var s=WebInspector.TimelinePresentationModel.recordStyle(t).category.name,o=WebInspector.TimelineModel.durationInSeconds(t)-n;e[s]=(e[s]||0)+o},WebInspector.TimelineModel.aggregateTimeByCategory=function(e,t){for(var n in t)e[n]=(e[n]||0)+t[n]},WebInspector.TimelineModel.prototype={startRecord:function(e){if(this._collectionEnabled)return;this.reset();var t=WebInspector.settings.timelineLimitStackFramesFlag.get()?WebInspector.settings.timelineStackFramesToCapture.get():30;WebInspector.timelineManager.start(t,e),this._collectionEnabled=!0},stopRecord:function(){if(!this._collectionEnabled)return;WebInspector.timelineManager.stop(),this._collectionEnabled=!1},get records(){return this._records},_onRecordAdded:function(e){this._collectionEnabled&&this._addRecord(e.data)},_addRecord:function(e){this._stringPool.internObjectStrings(e),this._records.push(e),this._updateBoundaries(e),this.dispatchEventToListeners(WebInspector.TimelineModel.Events.RecordAdded,e)},loadFromFile:function(e,t){var n=new WebInspector.TimelineModelLoadFromFileDelegate(this,t),r=this._createFileReader(e,n),i=new WebInspector.TimelineModelLoader(this,r,t);r.start(i)},loadFromURL:function(e,t){var n=new WebInspector.TimelineModelLoadFromFileDelegate(this,t),r=new WebInspector.ChunkedXHRReader(e,n),i=new WebInspector.TimelineModelLoader(this,r,t);r.start(i)},_createFileReader:function(e,t){return new WebInspector.ChunkedFileReader(e,WebInspector.TimelineModel.TransferChunkLengthBytes,t)},_createFileWriter:function(e,t){var n=new WebInspector.FileOutputStream;n.open(e,t)},saveToFile:function(){function n(e){var t=new WebInspector.TimelineSaver(e);t.save(this._records,window.navigator.appVersion)}var e=new Date,t="TimelineRawData-"+e.toISO8601Compact()+".json";this._createFileWriter(t,n.bind(this))},reset:function(){this._records=[],this._stringPool.reset(),this._minimumRecordTime=-1,this._maximumRecordTime=-1,this.dispatchEventToListeners(WebInspector.TimelineModel.Events.RecordsCleared)},minimumRecordTime:function(){return this._minimumRecordTime},maximumRecordTime:function(){return this._maximumRecordTime},_updateBoundaries:function(e){var t=WebInspector.TimelineModel.startTimeInSeconds(e),n=WebInspector.TimelineModel.endTimeInSeconds(e);if(this._minimumRecordTime===-1||t<this._minimumRecordTime)this._minimumRecordTime=t;if(this._maximumRecordTime===-1||n>this._maximumRecordTime)this._maximumRecordTime=n},recordOffsetInSeconds:function(e){return WebInspector.TimelineModel.startTimeInSeconds(e)-this._minimumRecordTime},__proto__:WebInspector.Object.prototype},WebInspector.TimelineModelLoader=function(e,t,n){this._model=e,this._reader=t,this._progress=n,this._buffer="",this._firstChunk=!0},WebInspector.TimelineModelLoader.prototype={write:function(e){var t=this._buffer+e,n=0,r;do r=n,n=WebInspector.findBalancedCurlyBrackets(t,r);while(n!==-1);var i=t.slice(0,r)+"]";this._buffer=t.slice(r);if(!r)return;this._firstChunk||(i="[0"+i);var s;try{s=JSON.parse(i)}catch(o){WebInspector.showErrorMessage("Malformed timeline data."),this._model.reset(),this._reader.cancel(),this._progress.done();return}this._firstChunk&&(this._version=s[0],this._firstChunk=!1,this._model.reset());for(var u=1,a=s.length;u<a;++u)this._model._addRecord(s[u])},close:function(){}},WebInspector.TimelineModelLoadFromFileDelegate=function(e,t){this._model=e,this._progress=t},WebInspector.TimelineModelLoadFromFileDelegate.prototype={onTransferStarted:function(){this._progress.setTitle(WebInspector.UIString("Loadingâ€¦"))},onChunkTransferred:function(e){if(this._progress.isCanceled()){e.cancel(),this._progress.done(),this._model.reset();return}var t=e.fileSize();t&&(this._progress.setTotalWork(t),this._progress.setWorked(e.loadedSize()))},onTransferFinished:function(){this._progress.done()},onError:function(e,t){this._progress.done(),this._model.reset();switch(t.target.error.code){case FileError.NOT_FOUND_ERR:WebInspector.showErrorMessage(WebInspector.UIString('File "%s" not found.',e.fileName()));break;case FileError.NOT_READABLE_ERR:WebInspector.showErrorMessage(WebInspector.UIString('File "%s" is not readable',e.fileName()));break;case FileError.ABORT_ERR:break;default:WebInspector.showErrorMessage(WebInspector.UIString('An error occurred while reading the file "%s"',e.fileName()))}}},WebInspector.TimelineSaver=function(e){this._stream=e},WebInspector.TimelineSaver.prototype={save:function(e,t){this._records=e,this._recordIndex=0,this._prologue="["+JSON.stringify(t),this._writeNextChunk(this._stream)},_writeNextChunk:function(e){const t=",\n";var n=[],r=0;if(this._prologue)n.push(this._prologue),r+=this._prologue.length,delete this._prologue;else{if(this._recordIndex===this._records.length){e.close();return}n.push("")}while(this._recordIndex<this._records.length){var i=JSON.stringify(this._records[this._recordIndex]),s=i.length+t.length;if(r+s>WebInspector.TimelineModel.TransferChunkLengthBytes)break;r+=s,n.push(i),++this._recordIndex}this._recordIndex===this._records.length&&n.push(n.pop()+"]"),e.write(n.join(t),this._writeNextChunk.bind(this))}};