/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * 1. Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY GOOGLE INC. AND ITS CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL GOOGLE INC.
 * OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.NavigatorView=function(){WebInspector.View.call(this),this.registerRequiredCSS("navigatorView.css");var e=document.createElement("ol");this._scriptsTree=new WebInspector.NavigatorTreeOutline(e),this._scriptsTree.childrenListElement.addEventListener("keypress",this._treeKeyPress.bind(this),!0);var t=document.createElement("div");t.addStyleClass("outline-disclosure"),t.addStyleClass("navigator"),t.appendChild(e),this.element.addStyleClass("fill"),this.element.addStyleClass("navigator-container"),this.element.appendChild(t),this.setDefaultFocusedElement(this._scriptsTree.element),this._uiSourceCodeNodes=new Map,this._subfolderNodes=new Map,this._rootNode=new WebInspector.NavigatorRootTreeNode(this),this._rootNode.populate(),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.InspectedURLChanged,this._inspectedURLChanged,this),this.element.addEventListener("contextmenu",this.handleContextMenu.bind(this),!1)},WebInspector.NavigatorView.Events={ItemSelected:"ItemSelected",ItemSearchStarted:"ItemSearchStarted",ItemRenamingRequested:"ItemRenamingRequested",ItemCreationRequested:"ItemCreationRequested"},WebInspector.NavigatorView.iconClassForType=function(e){return e===WebInspector.NavigatorTreeOutline.Types.Domain?"navigator-domain-tree-item":e===WebInspector.NavigatorTreeOutline.Types.FileSystem?"navigator-folder-tree-item":"navigator-folder-tree-item"},WebInspector.NavigatorView.prototype={addUISourceCode:function(e){var t=this._projectNode(e.project()),n=this._folderNode(t,e.parentPath()),r=new WebInspector.NavigatorUISourceCodeTreeNode(this,e);this._uiSourceCodeNodes.put(e,r),n.appendChild(r),e.url===WebInspector.inspectedPageURL&&this.revealUISourceCode(e)},_inspectedURLChanged:function(e){var t=this._uiSourceCodeNodes.values();for(var n=0;n<t.length;++n){var r=t[n].uiSourceCode();r.url===WebInspector.inspectedPageURL&&this.revealUISourceCode(r)}},_projectNode:function(e){if(!e.displayName())return this._rootNode;var t=this._rootNode.child(e.id());if(!t){var n=e.type()===WebInspector.projectTypes.FileSystem?WebInspector.NavigatorTreeOutline.Types.FileSystem:WebInspector.NavigatorTreeOutline.Types.Domain;t=new WebInspector.NavigatorFolderTreeNode(this,e,e.id(),n,"",e.displayName()),this._rootNode.appendChild(t)}return t},_folderNode:function(e,t){if(!t)return e;var n=this._subfolderNodes.get(e);n||(n=new StringMap,this._subfolderNodes.put(e,n));var r=n.get(t);if(r)return r;var i=e,s=t.lastIndexOf("/");s!==-1&&(i=this._folderNode(e,t.substring(0,s)));var o=t.substring(s+1);return r=new WebInspector.NavigatorFolderTreeNode(this,null,o,WebInspector.NavigatorTreeOutline.Types.Folder,t,o),n.put(t,r),i.appendChild(r),r},revealUISourceCode:function(e,t){var n=this._uiSourceCodeNodes.get(e);if(!n)return null;this._scriptsTree.selectedTreeElement&&this._scriptsTree.selectedTreeElement.deselect(),this._lastSelectedUISourceCode=e,n.reveal(t)},_scriptSelected:function(e,t){this._lastSelectedUISourceCode=e;var n={uiSourceCode:e,focusSource:t};this.dispatchEventToListeners(WebInspector.NavigatorView.Events.ItemSelected,n)},removeUISourceCode:function(e){var t=this._uiSourceCodeNodes.get(e);if(!t)return;var n=this._projectNode(e.project()),r=this._subfolderNodes.get(n),i=t.parent;this._uiSourceCodeNodes.remove(e),i.removeChild(t),t=i;while(t){i=t.parent;if(!i||!t.isEmpty())break;r&&r.remove(t._folderPath),i.removeChild(t),t=i}},requestRename:function(e){this.dispatchEventToListeners(WebInspector.ScriptsNavigator.Events.ItemRenamingRequested,e)},rename:function(e,t){var n=this._uiSourceCodeNodes.get(e);if(!n)return null;n.rename(t)},reset:function(){var e=this._uiSourceCodeNodes.values();for(var t=0;t<e.length;++t)e[t].dispose();this._scriptsTree.removeChildren(),this._uiSourceCodeNodes.clear(),this._subfolderNodes.clear(),this._rootNode.reset()},handleContextMenu:function(e){var t=new WebInspector.ContextMenu(e);this._appendAddFolderItem(t),t.show()},_appendAddFolderItem:function(e){function t(){WebInspector.isolatedFileSystemManager.addFileSystem()}var n=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add folder to workspace":"Add Folder to Workspace");e.appendItem(n,t)},handleFileContextMenu:function(e,t){var n=new WebInspector.ContextMenu(e);n.appendApplicableItems(t),n.appendSeparator(),this._appendAddFolderItem(n),n.show()},handleFolderContextMenu:function(e,t){var n=new WebInspector.ContextMenu(e),r="/",i=t;while(i.parent!==this._rootNode)r="/"+i.id+r,i=i.parent;var s=i._project;if(s.type()===WebInspector.projectTypes.FileSystem){function o(){s.refresh(r)}n.appendItem(WebInspector.UIString("Refresh"),o.bind(this));function u(){var e={};e.project=s,e.path=r,this.dispatchEventToListeners(WebInspector.NavigatorView.Events.ItemCreationRequested,e)}n.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"New file":"New File"),u.bind(this));function a(){var e=window.confirm(WebInspector.UIString("Are you sure you want to exclude this folder?"));e&&(WebInspector.startBatchUpdate(),s.excludeFolder(r),WebInspector.endBatchUpdate())}n.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Exclude folder":"Exclude Folder"),a.bind(this))}n.appendSeparator(),this._appendAddFolderItem(n);if(s.type()===WebInspector.projectTypes.FileSystem&&t===i){function f(){var e=window.confirm(WebInspector.UIString("Are you sure you want to remove this folder?"));e&&s.remove()}var l=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Remove folder from workspace":"Remove Folder from Workspace");n.appendItem(l,f)}n.show()},_treeKeyPress:function(e){if(WebInspector.isBeingEdited(this._scriptsTree.childrenListElement))return;var t=String.fromCharCode(e.charCode);if(t.trim()!==t)return;this.dispatchEventToListeners(WebInspector.NavigatorView.Events.ItemSearchStarted,t),e.consume(!0)},__proto__:WebInspector.View.prototype},WebInspector.NavigatorTreeOutline=function(e){TreeOutline.call(this,e),this.element=e,this.comparator=WebInspector.NavigatorTreeOutline._treeElementsCompare},WebInspector.NavigatorTreeOutline.Types={Root:"Root",Domain:"Domain",Folder:"Folder",UISourceCode:"UISourceCode",FileSystem:"FileSystem"},WebInspector.NavigatorTreeOutline._treeElementsCompare=function(t,n){function r(e){var t=e.type();return t===WebInspector.NavigatorTreeOutline.Types.Domain?e.titleText===WebInspector.inspectedPageDomain?1:2:t===WebInspector.NavigatorTreeOutline.Types.FileSystem?3:t===WebInspector.NavigatorTreeOutline.Types.Folder?4:5}var i=r(t),s=r(n),o;if(i>s)o=1;else if(i<s)o=-1;else{var u=t.titleText,a=n.titleText;o=u.compareTo(a)}return o},WebInspector.NavigatorTreeOutline.prototype={scriptTreeElements:function(){var e=[];if(this.children.length)for(var t=this.children[0];t;t=t.traverseNextTreeElement(!1,this,!0))t instanceof WebInspector.NavigatorSourceTreeElement&&e.push(t.uiSourceCode);return e},__proto__:TreeOutline.prototype},WebInspector.BaseNavigatorTreeElement=function(e,t,n,r,i){this._type=e,TreeElement.call(this,"",null,r),this._titleText=t,this._iconClasses=n,this._noIcon=i},WebInspector.BaseNavigatorTreeElement.prototype={onattach:function(){this.listItemElement.removeChildren();if(this._iconClasses)for(var e=0;e<this._iconClasses.length;++e)this.listItemElement.addStyleClass(this._iconClasses[e]);var t=document.createElement("div");t.className="selection",this.listItemElement.appendChild(t),this._noIcon||(this.imageElement=document.createElement("img"),this.imageElement.className="icon",this.listItemElement.appendChild(this.imageElement)),this.titleElement=document.createElement("div"),this.titleElement.className="base-navigator-tree-element-title",this._titleTextNode=document.createTextNode(""),this._titleTextNode.textContent=this._titleText,this.titleElement.appendChild(this._titleTextNode),this.listItemElement.appendChild(this.titleElement)},onreveal:function(){this.listItemElement&&this.listItemElement.scrollIntoViewIfNeeded(!0)},get titleText(){return this._titleText},set titleText(e){if(this._titleText===e)return;this._titleText=e||"",this.titleElement&&(this.titleElement.textContent=this._titleText)},type:function(){return this._type},__proto__:TreeElement.prototype},WebInspector.NavigatorFolderTreeElement=function(e,t,n){var r=WebInspector.NavigatorView.iconClassForType(t);WebInspector.BaseNavigatorTreeElement.call(this,t,n,[r],!0),this._navigatorView=e},WebInspector.NavigatorFolderTreeElement.prototype={onpopulate:function(){this._node.populate()},onattach:function(){WebInspector.BaseNavigatorTreeElement.prototype.onattach.call(this),this.collapse(),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1)},setNode:function(e){this._node=e;var t=[];while(e&&!e.isRoot())t.push(e._title),e=e.parent;t.reverse(),this.tooltip=t.join("/")},_handleContextMenuEvent:function(e){if(!this._node)return;this.select(),this._navigatorView.handleFolderContextMenu(e,this._node)},__proto__:WebInspector.BaseNavigatorTreeElement.prototype},WebInspector.NavigatorSourceTreeElement=function(e,t,n){WebInspector.BaseNavigatorTreeElement.call(this,WebInspector.NavigatorTreeOutline.Types.UISourceCode,n,["navigator-"+t.contentType().name()+"-tree-item"],!1),this._navigatorView=e,this._uiSourceCode=t,this.tooltip=t.originURL()},WebInspector.NavigatorSourceTreeElement.prototype={get uiSourceCode(){return this._uiSourceCode},onattach:function(){WebInspector.BaseNavigatorTreeElement.prototype.onattach.call(this),this.listItemElement.draggable=!0,this.listItemElement.addEventListener("click",this._onclick.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),this.listItemElement.addEventListener("mousedown",this._onmousedown.bind(this),!1),this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1)},_onmousedown:function(e){function t(e,t,n){this._warmedUpContent=e}e.which===1&&this._uiSourceCode.requestContent(t.bind(this))},_shouldRenameOnMouseDown:function(){if(!this._uiSourceCode.canRename())return!1;var e=this===this.treeOutline.selectedTreeElement,t=this.treeOutline.childrenListElement.isSelfOrAncestor(document.activeElement);return e&&t&&!WebInspector.isBeingEdited(this.treeOutline.element)},selectOnMouseDown:function(e){function t(){this._shouldRenameOnMouseDown()&&this._navigatorView.requestRename(this._uiSourceCode)}if(e.which!==1||!this._shouldRenameOnMouseDown()){TreeElement.prototype.selectOnMouseDown.call(this,e);return}setTimeout(t.bind(this),300)},_ondragstart:function(e){return e.dataTransfer.setData("text/plain",this._warmedUpContent),e.dataTransfer.effectAllowed="copy",!0},onspace:function(){return this._navigatorView._scriptSelected(this.uiSourceCode,!0),!0},_onclick:function(e){this._navigatorView._scriptSelected(this.uiSourceCode,!1)},ondblclick:function(e){var t=e.button===1;this._navigatorView._scriptSelected(this.uiSourceCode,!t)},onenter:function(){return this._navigatorView._scriptSelected(this.uiSourceCode,!0),!0},_handleContextMenuEvent:function(e){this.select(),this._navigatorView.handleFileContextMenu(e,this._uiSourceCode)},__proto__:WebInspector.BaseNavigatorTreeElement.prototype},WebInspector.NavigatorTreeNode=function(e){this.id=e,this._children=new StringMap},WebInspector.NavigatorTreeNode.prototype={treeElement:function(){},dispose:function(){},isRoot:function(){return!1},hasChildren:function(){return!0},populate:function(){if(this.isPopulated())return;this.parent&&this.parent.populate(),this._populated=!0,this.wasPopulated()},wasPopulated:function(){var e=this.children();for(var t=0;t<e.length;++t)this.treeElement().appendChild(e[t].treeElement())},didAddChild:function(e){this.isPopulated()&&this.treeElement().appendChild(e.treeElement())},willRemoveChild:function(e){this.isPopulated()&&this.treeElement().removeChild(e.treeElement())},isPopulated:function(){return this._populated},isEmpty:function(){return!this._children.size()},child:function(e){return this._children.get(e)},children:function(){return this._children.values()},appendChild:function(e){this._children.put(e.id,e),e.parent=this,this.didAddChild(e)},removeChild:function(e){this.willRemoveChild(e),this._children.remove(e.id),delete e.parent,e.dispose()},reset:function(){this._children.clear()}},WebInspector.NavigatorRootTreeNode=function(e){WebInspector.NavigatorTreeNode.call(this,""),this._navigatorView=e},WebInspector.NavigatorRootTreeNode.prototype={isRoot:function(){return!0},treeElement:function(){return this._navigatorView._scriptsTree},__proto__:WebInspector.NavigatorTreeNode.prototype},WebInspector.NavigatorUISourceCodeTreeNode=function(e,t){WebInspector.NavigatorTreeNode.call(this,t.name()),this._navigatorView=e,this._uiSourceCode=t,this._treeElement=null},WebInspector.NavigatorUISourceCodeTreeNode.prototype={uiSourceCode:function(){return this._uiSourceCode},treeElement:function(){return this._treeElement?this._treeElement:(this._treeElement=new WebInspector.NavigatorSourceTreeElement(this._navigatorView,this._uiSourceCode,""),this.updateTitle(),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.TitleChanged,this._titleChanged,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._uiSourceCode.addEventListener(WebInspector.UISourceCode.Events.FormattedChanged,this._formattedChanged,this),this._treeElement)},updateTitle:function(e){if(!this._treeElement)return;var t=this._uiSourceCode.displayName();!e&&(this._uiSourceCode.isDirty()||this._uiSourceCode.hasUnsavedCommittedChanges())&&(t="*"+t),this._treeElement.titleText=t},hasChildren:function(){return!1},dispose:function(){if(!this._treeElement)return;this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.TitleChanged,this._titleChanged,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyChanged,this._workingCopyChanged,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.WorkingCopyCommitted,this._workingCopyCommitted,this),this._uiSourceCode.removeEventListener(WebInspector.UISourceCode.Events.FormattedChanged,this._formattedChanged,this)},_titleChanged:function(e){this.updateTitle()},_workingCopyChanged:function(e){this.updateTitle()},_workingCopyCommitted:function(e){this.updateTitle()},_formattedChanged:function(e){this.updateTitle()},reveal:function(e){this.parent.populate(),this.parent.treeElement().expand(),this._treeElement.reveal(),e&&this._treeElement.select()},rename:function(e){function n(e,t,n){if(t!==n){this._treeElement.titleText=t,this._uiSourceCode.rename(t,r.bind(this));return}s.call(this,!0)}function r(n){if(!n){WebInspector.markBeingEdited(t,!1),this.updateTitle(),this.rename(e);return}s.call(this,!0)}function i(){s.call(this,!1)}function s(n){WebInspector.markBeingEdited(t,!1),this.updateTitle(),this._treeElement.treeOutline.childrenListElement.focus(),e&&e(n)}if(!this._treeElement)return;var t=this._treeElement.treeOutline.element;WebInspector.markBeingEdited(t,!0);var o=new WebInspector.EditingConfig(n.bind(this),i.bind(this));this.updateTitle(!0),WebInspector.startEditing(this._treeElement.titleElement,o),window.getSelection().setBaseAndExtent(this._treeElement.titleElement,0,this._treeElement.titleElement,1)},__proto__:WebInspector.NavigatorTreeNode.prototype},WebInspector.NavigatorFolderTreeNode=function(e,t,n,r,i,s){WebInspector.NavigatorTreeNode.call(this,n),this._navigatorView=e,this._project=t,this._type=r,this._folderPath=i,this._title=s},WebInspector.NavigatorFolderTreeNode.prototype={treeElement:function(){return this._treeElement?this._treeElement:(this._treeElement=this._createTreeElement(this._title,this),this._treeElement)},_createTreeElement:function(e,t){var n=new WebInspector.NavigatorFolderTreeElement(this._navigatorView,this._type,e);return n.setNode(t),n},wasPopulated:function(){if(!this._treeElement||this._treeElement._node!==this)return;this._addChildrenRecursive()},_addChildrenRecursive:function(){var e=this.children();for(var t=0;t<e.length;++t){var n=e[t];this.didAddChild(n),n instanceof WebInspector.NavigatorFolderTreeNode&&n._addChildrenRecursive()}},_shouldMerge:function(e){return this._type!==WebInspector.NavigatorTreeOutline.Types.Domain&&e instanceof WebInspector.NavigatorFolderTreeNode},didAddChild:function(e){function t(e){return e._title}if(!this._treeElement)return;var n=this.children();if(n.length===1&&this._shouldMerge(e)){e._isMerged=!0,this._treeElement.titleText=this._treeElement.titleText+"/"+e._title,e._treeElement=this._treeElement,this._treeElement.setNode(e);return}var r;n.length===2&&(r=n[0]!==e?n[0]:n[1]);if(r&&r._isMerged){delete r._isMerged;var i=[];i.push(this);var s=this;while(s._isMerged)s=s.parent,i.push(s);i.reverse();var o=i.map(t).join("/"),u=[];s=r;do u.push(s),n=s.children(),s=n.length===1?n[0]:null;while(s&&s._isMerged);if(!this.isPopulated()){this._treeElement.titleText=o,this._treeElement.setNode(this);for(var a=0;a<u.length;++a)delete u[a]._treeElement,delete u[a]._isMerged;return}var f=this._treeElement,l=this._createTreeElement(o,this);for(var a=0;a<i.length;++a)i[a]._treeElement=l;f.parent.appendChild(l),f.setNode(u[u.length-1]),f.titleText=u.map(t).join("/"),f.parent.removeChild(f),this._treeElement.appendChild(f),f.expanded&&l.expand()}this.isPopulated()&&this._treeElement.appendChild(e.treeElement())},willRemoveChild:function(e){if(e._isMerged||!this.isPopulated())return;this._treeElement.removeChild(e._treeElement)},__proto__:WebInspector.NavigatorTreeNode.prototype};