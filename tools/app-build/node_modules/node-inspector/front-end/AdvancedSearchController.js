/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * 1. Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY GOOGLE INC. AND ITS CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL GOOGLE INC.
 * OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.AdvancedSearchController=function(){this._shortcut=WebInspector.AdvancedSearchController.createShortcut(),this._searchId=0,WebInspector.settings.advancedSearchConfig=WebInspector.settings.createSetting("advancedSearchConfig",new WebInspector.SearchConfig("",!0,!1)),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameNavigated,this._frameNavigated,this)},WebInspector.AdvancedSearchController.createShortcut=function(){return WebInspector.isMac()?WebInspector.KeyboardShortcut.makeDescriptor("f",WebInspector.KeyboardShortcut.Modifiers.Meta|WebInspector.KeyboardShortcut.Modifiers.Alt):WebInspector.KeyboardShortcut.makeDescriptor("f",WebInspector.KeyboardShortcut.Modifiers.Ctrl|WebInspector.KeyboardShortcut.Modifiers.Shift)},WebInspector.AdvancedSearchController.prototype={handleShortcut:function(e){return WebInspector.KeyboardShortcut.makeKeyFromEvent(e)===this._shortcut.key?(!this._searchView||!this._searchView.isShowing()||this._searchView._search!==document.activeElement?(WebInspector.showPanel("scripts"),this.show()):this.close(),e.consume(!0),!0):!1},_frameNavigated:function(){this.resetSearch()},registerSearchScope:function(e){this._searchScope=e},show:function(){this._searchView||(this._searchView=new WebInspector.SearchView(this)),this._searchView.syncToSelection(),this._searchView.isShowing()?this._searchView.focus():WebInspector.showViewInDrawer(this._searchView._searchPanelElement,this._searchView,this.stopSearch.bind(this)),this.startIndexing()},close:function(){this.stopSearch(),WebInspector.closeViewInDrawer()},_onIndexingFinished:function(e){delete this._isIndexing,this._searchView.indexingFinished(e),e||delete this._pendingSearchConfig;if(!this._pendingSearchConfig)return;var t=this._pendingSearchConfig;delete this._pendingSearchConfig,this._innerStartSearch(t)},startIndexing:function(){this._isIndexing=!0,this._currentSearchScope=this._searchScope,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new WebInspector.ProgressIndicator,this._searchView.indexingStarted(this._progressIndicator),this._currentSearchScope.performIndexing(this._progressIndicator,this._onIndexingFinished.bind(this))},_onSearchResult:function(e,t){if(e!==this._searchId)return;this._searchView.addSearchResult(t);if(!t.searchMatches.length)return;this._searchResultsPane||(this._searchResultsPane=this._currentSearchScope.createSearchResultsPane(this._searchConfig)),this._searchView.resultsPane=this._searchResultsPane,this._searchResultsPane.addSearchResult(t)},_onSearchFinished:function(e,t){if(e!==this._searchId)return;this._searchResultsPane||this._searchView.nothingFound(),this._searchView.searchFinished(t),delete this._searchConfig},startSearch:function(e){this.resetSearch(),++this._searchId,this._isIndexing||this.startIndexing(),this._pendingSearchConfig=e},_innerStartSearch:function(e){this._searchConfig=e,this._currentSearchScope=this._searchScope,this._progressIndicator&&this._progressIndicator.done(),this._progressIndicator=new WebInspector.ProgressIndicator;var t=this._currentSearchScope.performSearch(e,this._progressIndicator,this._onSearchResult.bind(this,this._searchId),this._onSearchFinished.bind(this,this._searchId));this._searchView.searchStarted(this._progressIndicator)},resetSearch:function(){this.stopSearch(),this._searchResultsPane&&(this._searchView.resetResults(),delete this._searchResultsPane)},stopSearch:function(){this._progressIndicator&&this._progressIndicator.cancel(),this._currentSearchScope&&this._currentSearchScope.stopSearch(),delete this._searchConfig}},WebInspector.SearchView=function(e){WebInspector.View.call(this),this._controller=e,this.element.className="search-view",this._searchPanelElement=document.createElement("span"),this._searchPanelElement.className="search-drawer-header",this._searchPanelElement.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._searchResultsElement=this.element.createChild("div"),this._searchResultsElement.className="search-results",this._searchLabel=this._searchPanelElement.createChild("span"),this._searchLabel.textContent=WebInspector.UIString("Search sources"),this._search=this._searchPanelElement.createChild("input"),this._search.setAttribute("type","search"),this._search.addStyleClass("search-config-search"),this._search.setAttribute("results","0"),this._search.setAttribute("size",30),this._ignoreCaseLabel=this._searchPanelElement.createChild("label"),this._ignoreCaseLabel.addStyleClass("search-config-label"),this._ignoreCaseCheckbox=this._ignoreCaseLabel.createChild("input"),this._ignoreCaseCheckbox.setAttribute("type","checkbox"),this._ignoreCaseCheckbox.addStyleClass("search-config-checkbox"),this._ignoreCaseLabel.appendChild(document.createTextNode(WebInspector.UIString("Ignore case"))),this._regexLabel=this._searchPanelElement.createChild("label"),this._regexLabel.addStyleClass("search-config-label"),this._regexCheckbox=this._regexLabel.createChild("input"),this._regexCheckbox.setAttribute("type","checkbox"),this._regexCheckbox.addStyleClass("search-config-checkbox"),this._regexLabel.appendChild(document.createTextNode(WebInspector.UIString("Regular expression"))),this._searchStatusBarElement=document.createElement("div"),this._searchStatusBarElement.className="search-status-bar-item",this._searchMessageElement=this._searchStatusBarElement.createChild("div"),this._searchMessageElement.className="search-status-bar-message",this._searchResultsMessageElement=document.createElement("span"),this._searchResultsMessageElement.className="search-results-status-bar-message",this._load()},WebInspector.SearchView.maxQueriesCount=20,WebInspector.SearchView.prototype={get statusBarItems(){return[this._searchStatusBarElement,this._searchResultsMessageElement]},get searchConfig(){return new WebInspector.SearchConfig(this._search.value,this._ignoreCaseCheckbox.checked,this._regexCheckbox.checked)},syncToSelection:function(){var e=window.getSelection();if(e.rangeCount){var t=e.toString().replace(/\r?\n.*/,"");t&&(this._search.value=t)}},set resultsPane(e){this.resetResults(),this._searchResultsElement.appendChild(e.element)},searchStarted:function(e){this.resetResults(),this._resetCounters(),this._searchMessageElement.textContent=WebInspector.UIString("Searching..."),e.show(this._searchStatusBarElement),this._updateSearchResultsMessage(),this._searchingView||(this._searchingView=new WebInspector.EmptyView(WebInspector.UIString("Searching..."))),this._searchingView.show(this._searchResultsElement)},indexingStarted:function(e){this._searchMessageElement.textContent=WebInspector.UIString("Indexing..."),e.show(this._searchStatusBarElement)},indexingFinished:function(e){this._searchMessageElement.textContent=e?"":WebInspector.UIString("Indexing interrupted.")},_updateSearchResultsMessage:function(){this._searchMatchesCount&&this._searchResultsCount?this._searchResultsMessageElement.textContent=WebInspector.UIString("Found %d matches in %d files.",this._searchMatchesCount,this._nonEmptySearchResultsCount):this._searchResultsMessageElement.textContent=""},resetResults:function(){this._searchingView&&this._searchingView.detach(),this._notFoundView&&this._notFoundView.detach(),this._searchResultsElement.removeChildren()},_resetCounters:function(){this._searchMatchesCount=0,this._searchResultsCount=0,this._nonEmptySearchResultsCount=0},nothingFound:function(){this.resetResults(),this._notFoundView||(this._notFoundView=new WebInspector.EmptyView(WebInspector.UIString("No matches found."))),this._notFoundView.show(this._searchResultsElement),this._searchResultsMessageElement.textContent=WebInspector.UIString("No matches found.")},addSearchResult:function(e){this._searchMatchesCount+=e.searchMatches.length,this._searchResultsCount++,e.searchMatches.length&&this._nonEmptySearchResultsCount++,this._updateSearchResultsMessage()},searchFinished:function(e){this._searchMessageElement.textContent=e?WebInspector.UIString("Search finished."):WebInspector.UIString("Search interrupted.")},focus:function(){WebInspector.setCurrentFocusElement(this._search),this._search.select()},wasShown:function(){this.focus()},willHide:function(){this._controller.stopSearch()},_onKeyDown:function(e){switch(e.keyCode){case WebInspector.KeyboardShortcut.Keys.Enter.code:this._onAction();break;case WebInspector.KeyboardShortcut.Keys.Esc.code:this._controller.close(),e.consume(!0)}},_save:function(){var e=new WebInspector.SearchConfig(this.searchConfig.query,this.searchConfig.ignoreCase,this.searchConfig.isRegex);WebInspector.settings.advancedSearchConfig.set(e)},_load:function(){var e=WebInspector.settings.advancedSearchConfig.get();this._search.value=e.query,this._ignoreCaseCheckbox.checked=e.ignoreCase,this._regexCheckbox.checked=e.isRegex},_onAction:function(){if(!this.searchConfig.query||!this.searchConfig.query.length)return;this._save(),this._controller.startSearch(this.searchConfig)},__proto__:WebInspector.View.prototype},WebInspector.SearchConfig=function(e,t,n){this.query=e,this.ignoreCase=t,this.isRegex=n},WebInspector.SearchScope=function(){},WebInspector.SearchScope.prototype={performSearch:function(e,t,n,r){},stopSearch:function(){},createSearchResultsPane:function(e){}},WebInspector.SearchResult=function(e,t){this.offset=e,this.length=t},WebInspector.SearchResultsPane=function(e){this._searchConfig=e,this.element=document.createElement("div")},WebInspector.SearchResultsPane.prototype={get searchConfig(){return this._searchConfig},addSearchResult:function(e){}},WebInspector.FileBasedSearchResultsPane=function(e){WebInspector.SearchResultsPane.call(this,e),this._searchResults=[],this.element.id="search-results-pane-file-based",this._treeOutlineElement=document.createElement("ol"),this._treeOutlineElement.className="search-results-outline-disclosure",this.element.appendChild(this._treeOutlineElement),this._treeOutline=new TreeOutline(this._treeOutlineElement),this._matchesExpandedCount=0},WebInspector.FileBasedSearchResultsPane.matchesExpandedByDefaultCount=20,WebInspector.FileBasedSearchResultsPane.fileMatchesShownAtOnce=20,WebInspector.FileBasedSearchResultsPane.prototype={_createAnchor:function(e,t,n){var r=document.createElement("a");return r.preferredPanel="scripts",r.href=sanitizeHref(e.originURL()),r.uiSourceCode=e,r.lineNumber=t,r},addSearchResult:function(e){this._searchResults.push(e);var t=e.uiSourceCode;if(!t)return;var n=e.searchMatches,r=this._addFileTreeElement(t.fullDisplayName(),n.length,this._searchResults.length-1)},_fileTreeElementExpanded:function(e,t){if(t._initialized)return;var n=Math.min(e.searchMatches.length,WebInspector.FileBasedSearchResultsPane.fileMatchesShownAtOnce);n<e.searchMatches.length?(this._appendSearchMatches(t,e,0,n-1),this._appendShowMoreMatchesElement(t,e,n-1)):this._appendSearchMatches(t,e,0,n),t._initialized=!0},_appendSearchMatches:function(e,t,n,r){var i=t.uiSourceCode,s=t.searchMatches,o=createSearchRegex(this._searchConfig.query,!this._searchConfig.ignoreCase,this._searchConfig.isRegex);for(var u=n;u<r;++u){var a=s[u].lineNumber,f=s[u].lineContent,l=this._regexMatchRanges(f,o),c=this._createAnchor(i,a,l[0].offset),h=numberToStringWithSpacesPadding(a+1,4),p=document.createElement("span");p.addStyleClass("search-match-line-number"),p.textContent=h,c.appendChild(p);var d=this._createContentSpan(f,l);c.appendChild(d);var v=new TreeElement("",null,!1);v.selectable=!1,e.appendChild(v),v.listItemElement.className="search-match source-code",v.listItemElement.appendChild(c)}},_appendShowMoreMatchesElement:function(e,t,n){var r=t.searchMatches.length-n,i=WebInspector.UIString("Show all matches (%d more).",r),s=new TreeElement(i,null,!1);e.appendChild(s),s.listItemElement.addStyleClass("show-more-matches"),s.onselect=this._showMoreMatchesElementSelected.bind(this,t,n,s)},_showMoreMatchesElementSelected:function(e,t,n){var r=n.parent;r.removeChild(n),this._appendSearchMatches(r,e,t,e.searchMatches.length)},_addFileTreeElement:function(e,t,n){var r=new TreeElement("",null,!0);r.toggleOnClick=!0,r.selectable=!1,this._treeOutline.appendChild(r),r.listItemElement.addStyleClass("search-result");var i=document.createElement("span");i.className="search-result-file-name",i.textContent=e,r.listItemElement.appendChild(i);var s=document.createElement("span");s.className="search-result-matches-count",t===1?s.textContent=WebInspector.UIString("(%d match)",t):s.textContent=WebInspector.UIString("(%d matches)",t),r.listItemElement.appendChild(s);var o=this._searchResults[n];return r.onexpand=this._fileTreeElementExpanded.bind(this,o,r),this._matchesExpandedCount<WebInspector.FileBasedSearchResultsPane.matchesExpandedByDefaultCount&&r.expand(),this._matchesExpandedCount+=o.searchMatches.length,r},_regexMatchRanges:function(e,t){t.lastIndex=0;var n,r=0,i=[];while(t.lastIndex<e.length&&(n=t.exec(e)))i.push(new WebInspector.SearchResult(n.index,n[0].length));return i},_createContentSpan:function(e,t){var n=document.createElement("span");return n.className="search-match-content",n.textContent=e,WebInspector.highlightRangesWithStyleClass(n,t,"highlighted-match"),n},__proto__:WebInspector.SearchResultsPane.prototype},WebInspector.FileBasedSearchResultsPane.SearchResult=function(e,t){this.uiSourceCode=e,this.searchMatches=t},WebInspector.advancedSearchController=null;