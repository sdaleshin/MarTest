/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.RevisionHistoryView=function(){function t(e){e.history.length&&this._createUISourceCodeItem(e)}WebInspector.View.call(this),this.registerRequiredCSS("revisionHistory.css"),this.element.addStyleClass("revision-history-drawer"),this.element.addStyleClass("fill"),this.element.addStyleClass("outline-disclosure"),this._uiSourceCodeItems=new Map;var e=this.element.createChild("ol");this._treeOutline=new TreeOutline(e),WebInspector.workspace.uiSourceCodes().forEach(t.bind(this)),WebInspector.workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeContentCommitted,this._revisionAdded,this),WebInspector.workspace.addEventListener(WebInspector.Workspace.Events.UISourceCodeRemoved,this._uiSourceCodeRemoved,this),WebInspector.workspace.addEventListener(WebInspector.Workspace.Events.ProjectWillReset,this._projectWillReset,this),this._statusElement=document.createElement("span"),this._statusElement.textContent=WebInspector.UIString("Local modifications")},WebInspector.RevisionHistoryView.showHistory=function(e){WebInspector.RevisionHistoryView._view||(WebInspector.RevisionHistoryView._view=new WebInspector.RevisionHistoryView);var t=WebInspector.RevisionHistoryView._view;WebInspector.showViewInDrawer(t._statusElement,t),t._revealUISourceCode(e)},WebInspector.RevisionHistoryView.prototype={_createUISourceCodeItem:function(e){var t=new TreeElement(e.displayName(),null,!0);t.selectable=!1;for(var n=0;n<this._treeOutline.children.length;++n)if(this._treeOutline.children[n].title.localeCompare(e.displayName())>0){this._treeOutline.insertChild(t,n);break}n===this._treeOutline.children.length&&this._treeOutline.appendChild(t),this._uiSourceCodeItems.put(e,t);var r=e.history.length;for(var n=r-1;n>=0;--n){var i=e.history[n],s=new WebInspector.RevisionHistoryTreeElement(i,e.history[n-1],n!==r-1);t.appendChild(s)}var o=new TreeElement("",null,!1);o.selectable=!1,t.appendChild(o);var u=o.listItemElement.createChild("span","revision-history-link revision-history-link-row");u.textContent=WebInspector.UIString("apply original content"),u.addEventListener("click",e.revertToOriginal.bind(e));var a=t.listItemElement.createChild("span","revision-history-link");return a.textContent=WebInspector.UIString("revert"),a.addEventListener("click",this._clearHistory.bind(this,e)),t},_clearHistory:function(e){e.revertAndClearHistory(this._removeUISourceCode.bind(this))},_revisionAdded:function(e){var t=e.data.uiSourceCode,n=this._uiSourceCodeItems.get(t);if(!n){n=this._createUISourceCodeItem(t);return}var r=t.history.length,i=new WebInspector.RevisionHistoryTreeElement(t.history[r-1],t.history[r-2],!1);n.children.length&&n.children[0].allowRevert(),n.insertChild(i,0)},_revealUISourceCode:function(e){var t=this._uiSourceCodeItems.get(e);t&&(t.reveal(),t.expand())},_uiSourceCodeRemoved:function(e){var t=e.data;this._removeUISourceCode(t)},_removeUISourceCode:function(e){var t=this._uiSourceCodeItems.get(e);if(!t)return;this._treeOutline.removeChild(t),this._uiSourceCodeItems.remove(e)},_projectWillReset:function(e){var t=e.data;t.uiSourceCodes().forEach(this._removeUISourceCode.bind(this))},__proto__:WebInspector.View.prototype},WebInspector.RevisionHistoryTreeElement=function(e,t,n){TreeElement.call(this,e.timestamp.toLocaleTimeString(),null,!0),this.selectable=!1,this._revision=e,this._baseRevision=t,this._revertElement=document.createElement("span"),this._revertElement.className="revision-history-link",this._revertElement.textContent=WebInspector.UIString("apply revision content"),this._revertElement.addEventListener("click",this._revision.revertToThis.bind(this._revision),!1),n||this._revertElement.addStyleClass("hidden")},WebInspector.RevisionHistoryTreeElement.prototype={onattach:function(){this.listItemElement.addStyleClass("revision-history-revision")},onexpand:function(){function e(e){this._revision.requestContent(t.bind(this,e))}function t(e,t){var n=difflib.stringAsLines(e),r=difflib.stringAsLines(t),i=new difflib.SequenceMatcher(n,r),s=i.get_opcodes(),o=!1;for(var u=0;u<s.length;u++){var a=s[u],f=a[0],l=a[1],c=a[2],h=a[3],p=a[4],d=Math.max(c-l,p-h),v=[],m=[];for(var g=0;g<d;g++){if(f==="delete"||f==="replace"&&l<c){var y=l++;this._createLine(y,null,n[y],"removed"),o=!1}if(f==="insert"||f==="replace"&&h<p){var y=h++;this._createLine(null,y,r[y],"added"),o=!1}f==="equal"&&(l++,h++,o||this._createLine(null,null,"    â€¦","separator"),o=!0)}}}this.listItemElement.appendChild(this._revertElement);if(this._wasExpandedOnce)return;this._wasExpandedOnce=!0,this.childrenListElement.addStyleClass("source-code"),this._baseRevision?this._baseRevision.requestContent(e.bind(this)):this._revision.uiSourceCode.requestOriginalContent(e.bind(this))},oncollapse:function(){this._revertElement.remove()},_createLine:function(e,t,n,r){function o(e){var t=e!==null?numberToStringWithSpacesPadding(e+1,4):"    ",n=document.createElement("span");n.addStyleClass("webkit-line-number"),n.textContent=t,i.listItemElement.appendChild(n)}var i=new TreeElement("",null,!1);i.selectable=!1,this.appendChild(i);var s=document.createElement("span");o(e),o(t);var u=document.createElement("span");u.textContent=n,i.listItemElement.appendChild(u),i.listItemElement.addStyleClass("revision-history-line"),i.listItemElement.addStyleClass("revision-history-line-"+r)},allowRevert:function(){this._revertElement.removeStyleClass("hidden")},__proto__:TreeElement.prototype};