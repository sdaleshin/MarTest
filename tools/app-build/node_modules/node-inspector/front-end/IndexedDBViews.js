/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.IDBDatabaseView=function(e){WebInspector.View.call(this),this.registerRequiredCSS("indexedDBViews.css"),this.element.addStyleClass("fill"),this.element.addStyleClass("indexed-db-database-view"),this._headersListElement=this.element.createChild("ol","outline-disclosure"),this._headersTreeOutline=new TreeOutline(this._headersListElement),this._headersTreeOutline.expandTreeElementsWhenArrowing=!0,this._securityOriginTreeElement=new TreeElement("",null,!1),this._securityOriginTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._securityOriginTreeElement),this._nameTreeElement=new TreeElement("",null,!1),this._nameTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._nameTreeElement),this._intVersionTreeElement=new TreeElement("",null,!1),this._intVersionTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._intVersionTreeElement),this._stringVersionTreeElement=new TreeElement("",null,!1),this._stringVersionTreeElement.selectable=!1,this._headersTreeOutline.appendChild(this._stringVersionTreeElement),this.update(e)},WebInspector.IDBDatabaseView.prototype={_formatHeader:function(e,t){var n=document.createDocumentFragment();return n.createChild("div","attribute-name").textContent=e+":",n.createChild("div","attribute-value source-code").textContent=t,n},_refreshDatabase:function(){this._securityOriginTreeElement.title=this._formatHeader(WebInspector.UIString("Security origin"),this._database.databaseId.securityOrigin),this._nameTreeElement.title=this._formatHeader(WebInspector.UIString("Name"),this._database.databaseId.name),this._stringVersionTreeElement.title=this._formatHeader(WebInspector.UIString("String Version"),this._database.version),this._intVersionTreeElement.title=this._formatHeader(WebInspector.UIString("Integer Version"),this._database.intVersion)},update:function(e){this._database=e,this._refreshDatabase()},__proto__:WebInspector.View.prototype},WebInspector.IDBDataView=function(e,t,n,r){WebInspector.View.call(this),this.registerRequiredCSS("indexedDBViews.css"),this._model=e,this._databaseId=t,this._isIndex=!!r,this.element.addStyleClass("indexed-db-data-view");var i=this._createEditorToolbar();this.element.appendChild(i),this._dataGridContainer=this.element.createChild("div","fill"),this._dataGridContainer.addStyleClass("data-grid-container"),this._refreshButton=new WebInspector.StatusBarButton(WebInspector.UIString("Refresh"),"refresh-storage-status-bar-item"),this._refreshButton.addEventListener("click",this._refreshButtonClicked,this),this._clearButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear object store"),"clear-storage-status-bar-item"),this._clearButton.addEventListener("click",this._clearButtonClicked,this),this._pageSize=50,this._skipCount=0,this.update(n,r),this._entries=[]},WebInspector.IDBDataView.prototype={_createDataGrid:function(){var e=this._isIndex?this._index.keyPath:this._objectStore.keyPath,t=[];t.push({id:"number",title:WebInspector.UIString("#"),width:"50px"}),t.push({id:"key",titleDOMFragment:this._keyColumnHeaderFragment(WebInspector.UIString("Key"),e)}),this._isIndex&&t.push({id:"primaryKey",titleDOMFragment:this._keyColumnHeaderFragment(WebInspector.UIString("Primary key"),this._objectStore.keyPath)}),t.push({id:"value",title:WebInspector.UIString("Value")});var n=new WebInspector.DataGrid(t);return n},_keyColumnHeaderFragment:function(e,t){var n=document.createDocumentFragment();n.appendChild(document.createTextNode(e));if(t===null)return n;n.appendChild(document.createTextNode(" ("+WebInspector.UIString("Key path: ")));if(t instanceof Array){n.appendChild(document.createTextNode("["));for(var r=0;r<t.length;++r)r!=0&&n.appendChild(document.createTextNode(", ")),n.appendChild(this._keyPathStringFragment(t[r]));n.appendChild(document.createTextNode("]"))}else{var i=t;n.appendChild(this._keyPathStringFragment(i))}return n.appendChild(document.createTextNode(")")),n},_keyPathStringFragment:function(e){var t=document.createDocumentFragment();t.appendChild(document.createTextNode('"'));var n=t.createChild("span","source-code console-formatted-string");return n.textContent=e,t.appendChild(document.createTextNode('"')),t},_createEditorToolbar:function(){var e=document.createElement("div");return e.addStyleClass("status-bar"),e.addStyleClass("data-view-toolbar"),this._pageBackButton=e.createChild("button","back-button"),this._pageBackButton.addStyleClass("status-bar-item"),this._pageBackButton.title=WebInspector.UIString("Show previous page."),this._pageBackButton.disabled=!0,this._pageBackButton.appendChild(document.createElement("img")),this._pageBackButton.addEventListener("click",this._pageBackButtonClicked.bind(this),!1),e.appendChild(this._pageBackButton),this._pageForwardButton=e.createChild("button","forward-button"),this._pageForwardButton.addStyleClass("status-bar-item"),this._pageForwardButton.title=WebInspector.UIString("Show next page."),this._pageForwardButton.disabled=!0,this._pageForwardButton.appendChild(document.createElement("img")),this._pageForwardButton.addEventListener("click",this._pageForwardButtonClicked.bind(this),!1),e.appendChild(this._pageForwardButton),this._keyInputElement=e.createChild("input","key-input"),this._keyInputElement.placeholder=WebInspector.UIString("Start from key"),this._keyInputElement.addEventListener("paste",this._keyInputChanged.bind(this)),this._keyInputElement.addEventListener("cut",this._keyInputChanged.bind(this)),this._keyInputElement.addEventListener("keypress",this._keyInputChanged.bind(this)),this._keyInputElement.addEventListener("keydown",this._keyInputChanged.bind(this)),e},_pageBackButtonClicked:function(){this._skipCount=Math.max(0,this._skipCount-this._pageSize),this._updateData(!1)},_pageForwardButtonClicked:function(){this._skipCount=this._skipCount+this._pageSize,this._updateData(!1)},_keyInputChanged:function(){window.setTimeout(this._updateData.bind(this,!1),0)},update:function(e,t){this._objectStore=e,this._index=t,this._dataGrid&&this._dataGrid.detach(),this._dataGrid=this._createDataGrid(),this._dataGrid.show(this._dataGridContainer),this._skipCount=0,this._updateData(!0)},_parseKey:function(e){var t;try{t=JSON.parse(e)}catch(n){t=e}return t},_stringifyKey:function(e){return typeof e=="string"?e:JSON.stringify(e)},_updateData:function(e){function i(e,t){this._refreshButton.setEnabled(!0),this.clear(),this._entries=e;for(var n=0;n<e.length;++n){var i={};i.number=n+r,i.key=e[n].key,i.primaryKey=e[n].primaryKey,i.value=e[n].value;var s=JSON.stringify(this._isIndex?e[n].primaryKey:e[n].key),o=new WebInspector.IDBDataGridNode(i);this._dataGrid.rootNode().appendChild(o)}this._pageBackButton.disabled=r===0,this._pageForwardButton.disabled=!t}var t=this._parseKey(this._keyInputElement.value),n=this._pageSize,r=this._skipCount;this._refreshButton.setEnabled(!1),this._clearButton.setEnabled(!this._isIndex);if(!e&&this._lastKey===t&&this._lastPageSize===n&&this._lastSkipCount===r)return;if(this._lastKey!==t||this._lastPageSize!==n)r=0,this._skipCount=0;this._lastKey=t,this._lastPageSize=n,this._lastSkipCount=r;var s=t?window.webkitIDBKeyRange.lowerBound(t):null;this._isIndex?this._model.loadIndexData(this._databaseId,this._objectStore.name,this._index.name,s,r,n,i.bind(this)):this._model.loadObjectStoreData(this._databaseId,this._objectStore.name,s,r,n,i.bind(this))},_refreshButtonClicked:function(e){this._updateData(!0)},_clearButtonClicked:function(e){function t(){this._clearButton.setEnabled(!0),this._updateData(!0)}this._clearButton.setEnabled(!1),this._model.clearObjectStore(this._databaseId,this._objectStore.name,t.bind(this))},get statusBarItems(){return[this._refreshButton.element,this._clearButton.element]},clear:function(){this._dataGrid.rootNode().removeChildren();for(var e=0;e<this._entries.length;++e)this._entries[e].key.release(),this._entries[e].primaryKey.release(),this._entries[e].value.release();this._entries=[]},__proto__:WebInspector.View.prototype},WebInspector.IDBDataGridNode=function(e){WebInspector.DataGridNode.call(this,e,!1),this.selectable=!1},WebInspector.IDBDataGridNode.prototype={createCell:function(e){var t=WebInspector.DataGridNode.prototype.createCell.call(this,e),n=this.data[e];switch(e){case"value":case"key":case"primaryKey":t.removeChildren(),this._formatValue(t,n);break;default:}return t},_formatValue:function(e,t){var n=t.subtype||t.type,r=e.createChild("div","source-code console-formatted-"+n);switch(n){case"object":case"array":var i=new WebInspector.ObjectPropertiesSection(t,t.description);i.editable=!1,i.skipProto=!0,r.appendChild(i.element);break;case"string":r.addStyleClass("primitive-value"),r.appendChild(document.createTextNode('"'+t.description+'"'));break;default:r.addStyleClass("primitive-value"),r.appendChild(document.createTextNode(t.description))}},__proto__:WebInspector.DataGridNode.prototype};