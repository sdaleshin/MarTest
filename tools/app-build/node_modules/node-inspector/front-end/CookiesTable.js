/*
 * Copyright (C) 2009 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 * Copyright (C) 2010 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CookiesTable=function(e,t,n){WebInspector.View.call(this),this.element.className="fill";var r=e;this._refreshCallback=t;var i=[{id:"name",title:WebInspector.UIString("Name"),sortable:!0,disclosure:e,sort:WebInspector.DataGrid.Order.Ascending,longText:!0,weight:24},{id:"value",title:WebInspector.UIString("Value"),sortable:!0,longText:!0,weight:34},{id:"domain",title:WebInspector.UIString("Domain"),sortable:!0,weight:7},{id:"path",title:WebInspector.UIString("Path"),sortable:!0,weight:7},{id:"expires",title:WebInspector.UIString("Expires / Max-Age"),sortable:!0,weight:7},{id:"size",title:WebInspector.UIString("Size"),sortable:!0,align:WebInspector.DataGrid.Align.Right,weight:7},{id:"httpOnly",title:WebInspector.UIString("HTTP"),sortable:!0,align:WebInspector.DataGrid.Align.Center,weight:7},{id:"secure",title:WebInspector.UIString("Secure"),sortable:!0,align:WebInspector.DataGrid.Align.Center,weight:7}];r?this._dataGrid=new WebInspector.DataGrid(i):this._dataGrid=new WebInspector.DataGrid(i,undefined,this._onDeleteCookie.bind(this),t,this._onContextMenu.bind(this)),this._dataGrid.setName("cookiesTable"),this._dataGrid.addEventListener(WebInspector.DataGrid.Events.SortingChanged,this._rebuildTable,this),n&&this._dataGrid.addEventListener(WebInspector.DataGrid.Events.SelectedNode,n,this),this._nextSelectedCookie=null,this._dataGrid.show(this.element),this._data=[]},WebInspector.CookiesTable.prototype={_clearAndRefresh:function(e){this.clear(e),this._refresh()},_onContextMenu:function(e,t){if(t===this._dataGrid.creationNode)return;var n=t.cookie,r=n.domain();r&&e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?'Clear all from "%s"':'Clear All from "%s"',r),this._clearAndRefresh.bind(this,r)),e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Clear all":"Clear All"),this._clearAndRefresh.bind(this,null))},setCookies:function(e){this.setCookieFolders([{cookies:e}])},setCookieFolders:function(e){this._data=e,this._rebuildTable()},selectedCookie:function(){var e=this._dataGrid.selectedNode;return e?e.cookie:null},clear:function(e){for(var t=0,n=this._data.length;t<n;++t){var r=this._data[t].cookies;for(var i=0,s=r.length;i<s;++i)(!e||r[i].domain()===e)&&r[i].remove()}},_rebuildTable:function(){var e=this._nextSelectedCookie||this.selectedCookie();this._nextSelectedCookie=null,this._dataGrid.rootNode().removeChildren();for(var t=0;t<this._data.length;++t){var n=this._data[t];if(n.folderName){var r={name:n.folderName,value:"",domain:"",path:"",expires:"",size:this._totalSize(n.cookies),httpOnly:"",secure:""},i=new WebInspector.DataGridNode(r);i.selectable=!0,this._dataGrid.rootNode().appendChild(i),i.element.addStyleClass("row-group"),this._populateNode(i,n.cookies,e),i.expand()}else this._populateNode(this._dataGrid.rootNode(),n.cookies,e)}},_populateNode:function(e,t,n){e.removeChildren();if(!t)return;this._sortCookies(t);for(var r=0;r<t.length;++r){var i=t[r],s=this._createGridNode(i);e.appendChild(s),n&&n.name()===i.name()&&n.domain()===i.domain()&&n.path()===i.path()&&s.select()}},_totalSize:function(e){var t=0;for(var n=0;e&&n<e.length;++n)t+=e[n].size();return t},_sortCookies:function(e){function n(e,n,r){return t*(e.apply(n)+"").compareTo(e.apply(r)+"")}function r(e,n,r){return t*(e.apply(n)-e.apply(r))}function i(e,n){return e.session()!==n.session()?t*(e.session()?1:-1):e.session()?0:e.maxAge()&&n.maxAge()?t*(e.maxAge()-n.maxAge()):e.expires()&&n.expires()?t*(e.expires()-n.expires()):t*(e.expires()?1:-1)}var t=this._dataGrid.isSortOrderAscending()?1:-1,s;switch(this._dataGrid.sortColumnIdentifier()){case"name":s=n.bind(null,WebInspector.Cookie.prototype.name);break;case"value":s=n.bind(null,WebInspector.Cookie.prototype.value);break;case"domain":s=n.bind(null,WebInspector.Cookie.prototype.domain);break;case"path":s=n.bind(null,WebInspector.Cookie.prototype.path);break;case"expires":s=i;break;case"size":s=r.bind(null,WebInspector.Cookie.prototype.size);break;case"httpOnly":s=n.bind(null,WebInspector.Cookie.prototype.httpOnly);break;case"secure":s=n.bind(null,WebInspector.Cookie.prototype.secure);break;default:n.bind(null,WebInspector.Cookie.prototype.name)}e.sort(s)},_createGridNode:function(e){var t={};t.name=e.name(),t.value=e.value(),e.type()===WebInspector.Cookie.Type.Request?(t.domain=WebInspector.UIString("N/A"),t.path=WebInspector.UIString("N/A"),t.expires=WebInspector.UIString("N/A")):(t.domain=e.domain()||"",t.path=e.path()||"",e.maxAge()?t.expires=Number.secondsToString(parseInt(e.maxAge(),10)):e.expires()?t.expires=(new Date(e.expires())).toGMTString():t.expires=WebInspector.UIString("Session")),t.size=e.size();const n="âœ“";t.httpOnly=e.httpOnly()?n:"",t.secure=e.secure()?n:"";var r=new WebInspector.DataGridNode(t);return r.cookie=e,r.selectable=!0,r},_onDeleteCookie:function(e){var t=e.cookie,n=e.traverseNextNode()||e.traversePreviousNode();n&&(this._nextSelectedCookie=n.cookie),t.remove(),this._refresh()},_refresh:function(){this._refreshCallback&&this._refreshCallback()},__proto__:WebInspector.View.prototype};