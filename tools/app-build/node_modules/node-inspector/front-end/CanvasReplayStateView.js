/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CanvasReplayStateView=function(e){WebInspector.View.call(this),this.registerRequiredCSS("canvasProfiler.css"),this.element.addStyleClass("canvas-replay-state-view"),this._traceLogPlayer=e;var t=this.element.createChild("div","status-bar");this._prevButton=this._createControlButton(t,"canvas-replay-state-prev",WebInspector.UIString("Previous resource."),this._onResourceNavigationClick.bind(this,!1)),this._nextButton=this._createControlButton(t,"canvas-replay-state-next",WebInspector.UIString("Next resource."),this._onResourceNavigationClick.bind(this,!0)),this._createControlButton(t,"canvas-replay-state-refresh",WebInspector.UIString("Refresh."),this._onStateRefreshClick.bind(this)),this._resourceSelector=new WebInspector.StatusBarComboBox(this._onReplayResourceChanged.bind(this)),this._currentOption=this._resourceSelector.createOption(WebInspector.UIString("<auto>"),WebInspector.UIString("Show state of the last replayed resource."),""),t.appendChild(this._resourceSelector.element),this._resourceIdToDescription={},this._gridNodesExpandedState={},this._gridScrollPositions={},this._currentResourceId=null,this._prevOptionsStack=[],this._nextOptionsStack=[],this._highlightedGridNodes=[];var n=[{title:WebInspector.UIString("Name"),sortable:!1,width:"50%",disclosure:!0},{title:WebInspector.UIString("Value"),sortable:!1,width:"50%"}];this._stateGrid=new WebInspector.DataGrid(n),this._stateGrid.element.addStyleClass("fill"),this._stateGrid.show(this.element),this._traceLogPlayer.addEventListener(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasReplayStateChanged,this._onReplayResourceChanged,this),this._traceLogPlayer.addEventListener(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasTraceLogReceived,this._onCanvasTraceLogReceived,this),this._traceLogPlayer.addEventListener(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasResourceStateReceived,this._onCanvasResourceStateReceived,this),this._updateButtonsEnabledState()},WebInspector.CanvasReplayStateView.prototype={selectResource:function(e){if(e===this._resourceSelector.selectedOption().value)return;var t=this._resourceSelector.selectElement().firstChild;for(var n=0;t;++n,t=t.nextSibling)if(e===t.value){this._resourceSelector.setSelectedIndex(n),this._onReplayResourceChanged();break}},_createControlButton:function(e,t,n,r){var i=new WebInspector.StatusBarButton(n,t+" canvas-replay-button");return e.appendChild(i.element),i.makeLongClickEnabled(),i.addEventListener("click",r,this),i.addEventListener("longClickDown",r,this),i.addEventListener("longClickPress",r,this),i},_onResourceNavigationClick:function(e){var t=e?this._nextOptionsStack.pop():this._prevOptionsStack.pop();if(!t)return;(e?this._prevOptionsStack:this._nextOptionsStack).push(this._currentOption),this._isNavigationButton=!0,this.selectResource(t.value),delete this._isNavigationButton,this._updateButtonsEnabledState()},_onStateRefreshClick:function(){this._traceLogPlayer.clearResourceStates()},_updateButtonsEnabledState:function(){this._prevButton.setEnabled(this._prevOptionsStack.length>0),this._nextButton.setEnabled(this._nextOptionsStack.length>0)},_updateCurrentOption:function(){const e=256;var t=this._resourceSelector.selectedOption();if(this._currentOption===t)return;this._isNavigationButton||(this._prevOptionsStack.push(this._currentOption),this._nextOptionsStack=[],this._prevOptionsStack.length>e&&this._prevOptionsStack.shift(),this._updateButtonsEnabledState()),this._currentOption=t},_collectResourcesFromTraceLog:function(e){var t=[],n=e.calls;for(var r=0,i=n.length;r<i;++r){var s=n[r],o=s.arguments||[];for(var u=0;u<o.length;++u)this._collectResourceFromCallArgument(o[u],t);this._collectResourceFromCallArgument(s.result,t),this._collectResourceFromCallArgument(s.value,t)}var a=e.contexts;for(var r=0,i=a.length;r<i;++r)this._collectResourceFromCallArgument(a[r],t);this._addCollectedResourcesToSelector(t)},_collectResourcesFromResourceState:function(e){var t=[];this._collectResourceFromResourceStateDescriptors(e.descriptors,t),this._addCollectedResourcesToSelector(t)},_collectResourceFromResourceStateDescriptors:function(e,t){if(!e)return;for(var n=0,r=e.length;n<r;++n){var i=e[n];this._collectResourceFromCallArgument(i.value,t),this._collectResourceFromResourceStateDescriptors(i.values,t)}},_collectResourceFromCallArgument:function(e,t){if(!e)return;var n=e.resourceId;if(!n||this._resourceIdToDescription[n])return;this._resourceIdToDescription[n]=e.description,t.push(e)},_addCollectedResourcesToSelector:function(e){function t(e,t){var n=e.description,r=t.description;return String.naturalOrderComparator(n,r)}if(!e.length)return;e.sort(t);var n=this._resourceSelector.selectElement(),r=n.firstChild;r=r.nextSibling;for(var i=0,s=e.length;i<s;++i){var o=e[i];while(r&&String.naturalOrderComparator(r.text,o.description)<0)r=r.nextSibling;var u=this._resourceSelector.createOption(o.description,WebInspector.UIString("Show state of this resource."),o.resourceId);r&&n.insertBefore(u,r)}},_onReplayResourceChanged:function(){function t(t){if(e!==this._resourceSelector.selectedOption().value)return;this._showResourceState(t)}this._updateCurrentOption();var e=this._resourceSelector.selectedOption().value;this._traceLogPlayer.getResourceState(e,t.bind(this))},_onCanvasTraceLogReceived:function(e){var t=e.data;t&&this._collectResourcesFromTraceLog(t)},_onCanvasResourceStateReceived:function(e){var t=e.data;t&&this._collectResourcesFromResourceState(t)},_showResourceState:function(e){function i(e,t){if(!t)return;for(var n=0,r;r=t.children[n];++n){var s={node:r,children:{}};e[r.name]=s,i(s.children,r)}}function s(e,t){var n=!!e.values,r=!!t.values;return n!==r?n?1:-1:String.naturalOrderComparator(e.name,t.name)}function o(e,t,r){e=e||[],e.sort(s);var i=r||{};for(var u=0,a=e.length;u<a;++u){var f=e[u],l=this._createDataGridNode(f);t.appendChild(l);var c=i[l.name]||{},h=c.node;(!h||h.element.textContent!==l.element.textContent)&&n.push(l),o.call(this,f.values,l,c.children)}}this._saveExpandedState(),this._saveScrollState();var t=this._stateGrid.rootNode();if(!e){this._currentResourceId=null,this._updateDataGridHighlights([]),t.removeChildren();return}var n=[],r={};i(r,t),t.removeChildren(),o.call(this,e.descriptors,t,r);var u=this._resourceKindId(this._currentResourceId)===this._resourceKindId(e.id);this._currentResourceId=e.id,this._restoreExpandedState(),this._updateDataGridHighlights(u?n:[]),this._restoreScrollState()},_updateDataGridHighlights:function(e){for(var t=0,n=this._highlightedGridNodes.length;t<n;++t){var r=this._highlightedGridNodes[t];r.element.removeStyleClass("canvas-grid-node-highlighted")}this._highlightedGridNodes=e;for(var t=0,n=this._highlightedGridNodes.length;t<n;++t){var r=this._highlightedGridNodes[t];r.element.addStyleClass("canvas-grid-node-highlighted"),r.reveal()}},_resourceKindId:function(e){var t=e&&this._resourceIdToDescription[e]||"";return t.replace(/\d+/g,"")},_forEachGridNode:function(e){function t(n,r){for(var i=0,s;s=n.children[i];++i){var o=r+"#"+s.name;e(s,o),t(s,o)}}t(this._stateGrid.rootNode(),"")},_saveExpandedState:function(){function n(t,n){t.expanded&&(e[n]=!0)}if(!this._currentResourceId)return;var e={},t=this._resourceKindId(this._currentResourceId);this._gridNodesExpandedState[t]=e,this._forEachGridNode(n)},_restoreExpandedState:function(){function n(e,n){t[n]&&e.expand()}if(!this._currentResourceId)return;var e=this._resourceKindId(this._currentResourceId),t=this._gridNodesExpandedState[e];if(!t)return;this._forEachGridNode(n)},_saveScrollState:function(){if(!this._currentResourceId)return;var e=this._resourceKindId(this._currentResourceId);this._gridScrollPositions[e]={scrollTop:this._stateGrid.scrollContainer.scrollTop,scrollLeft:this._stateGrid.scrollContainer.scrollLeft}},_restoreScrollState:function(){if(!this._currentResourceId)return;var e=this._resourceKindId(this._currentResourceId),t=this._gridScrollPositions[e];if(!t)return;this._stateGrid.scrollContainer.scrollTop=t.scrollTop,this._stateGrid.scrollContainer.scrollLeft=t.scrollLeft},_createDataGridNode:function(e){var t=e.name,n=e.value,r=n?WebInspector.CanvasProfileDataGridHelper.createCallArgumentElement(n):"",i=t;typeof e.enumValueForName!="undefined"&&(i=WebInspector.CanvasProfileDataGridHelper.createEnumValueElement(t,+e.enumValueForName));if(e.isArray&&e.values)if(typeof i=="string")i+="["+e.values.length+"]";else{var s=document.createElement("span");s.appendChild(i),s.createTextChild("["+e.values.length+"]"),i=s}var o={};o[0]=i,o[1]=r;var u=new WebInspector.DataGridNode(o);return u.selectable=!1,u.name=t,u},__proto__:WebInspector.View.prototype};