/*
 * Copyright (C) 2011 Brian Grinstead All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.Spectrum=function(){function o(e,t,n){this._hsv[0]=(this.slideHeight-n)/this.slideHeight,this._onchange()}function a(e,t,n){u={x:this._dragHelperElement.offsetLeft,y:this._dragHelperElement.offsetTop}}function f(e,t,n,r){r.shiftKey&&(Math.abs(t-u.x)>=Math.abs(n-u.y)?n=u.y:t=u.x),this._hsv[1]=t/this.dragWidth,this._hsv[2]=(this.dragHeight-n)/this.dragHeight,this._onchange()}function l(){this._hsv[3]=this._alphaElement.value/100,this._onchange()}WebInspector.View.call(this),this.registerRequiredCSS("spectrum.css"),this.element.className="spectrum-container",this.element.tabIndex=0;var e=this.element.createChild("div","spectrum-top");e.createChild("div","spectrum-fill");var t=e.createChild("div","spectrum-top-inner fill");this._draggerElement=t.createChild("div","spectrum-color"),this._dragHelperElement=this._draggerElement.createChild("div","spectrum-sat fill").createChild("div","spectrum-val fill").createChild("div","spectrum-dragger"),this._sliderElement=t.createChild("div","spectrum-hue"),this.slideHelper=this._sliderElement.createChild("div","spectrum-slider");var n=this.element.createChild("div","spectrum-range-container"),r=n.createChild("label");r.textContent=WebInspector.UIString("Î±:"),this._alphaElement=n.createChild("input","spectrum-range"),this._alphaElement.setAttribute("type","range"),this._alphaElement.setAttribute("min","0"),this._alphaElement.setAttribute("max","100"),this._alphaElement.addEventListener("change",l.bind(this),!1);var i=document.createElement("span");i.className="swatch",this._swatchInnerElement=i.createChild("span","swatch-inner");var s=this.element.createChild("div");s.appendChild(i),this._displayElement=s.createChild("span","source-code spectrum-display-value"),WebInspector.Spectrum.draggable(this._sliderElement,o.bind(this)),WebInspector.Spectrum.draggable(this._draggerElement,f.bind(this),a.bind(this));var u},WebInspector.Spectrum.Events={ColorChanged:"ColorChanged"},WebInspector.Spectrum.draggable=function(e,t,n,r){function l(e){e.consume(!0)}function c(n){if(s){var r=Math.max(0,Math.min(n.pageX-o.left+u.left,f)),i=Math.max(0,Math.min(n.pageY-o.top+u.top,a));t&&t(e,r,i,n)}}function h(t){var r=t.which?t.which===3:t.button===2;!r&&!s&&(n&&n(e,t),s=!0,a=e.clientHeight,f=e.clientWidth,u=e.scrollOffset(),o=e.totalOffset(),i.addEventListener("selectstart",l,!1),i.addEventListener("dragstart",l,!1),i.addEventListener("mousemove",c,!1),i.addEventListener("mouseup",p,!1),c(t),l(t))}function p(t){s&&(i.removeEventListener("selectstart",l,!1),i.removeEventListener("dragstart",l,!1),i.removeEventListener("mousemove",c,!1),i.removeEventListener("mouseup",p,!1),r&&r(e,t)),s=!1}var i=document,s,o,u,a,f;e.addEventListener("mousedown",h,!1)},WebInspector.Spectrum.prototype={setColor:function(e){this._hsv=e.hsva()},color:function(){return WebInspector.Color.fromHSVA(this._hsv)},_colorString:function(){var e=WebInspector.Color.Format,t=this._originalFormat,n=this.color(),r=n.toString(this._originalFormat);return r?r:n.hasAlpha()?t===e.HSLA||t===e.HSL?n.toString(e.HSLA):n.toString(e.RGBA):t===e.ShortHEX?n.toString(e.HEX):(console.assert(t===e.Nickname),n.toString(e.RGB))},set displayText(e){this._displayElement.textContent=e},_onchange:function(){this._updateUI(),this.dispatchEventToListeners(WebInspector.Spectrum.Events.ColorChanged,this._colorString())},_updateHelperLocations:function(){var e=this._hsv[0],t=this._hsv[1],n=this._hsv[2],r=t*this.dragWidth,i=this.dragHeight-n*this.dragHeight;r=Math.max(-this._dragHelperElementHeight,Math.min(this.dragWidth-this._dragHelperElementHeight,r-this._dragHelperElementHeight)),i=Math.max(-this._dragHelperElementHeight,Math.min(this.dragHeight-this._dragHelperElementHeight,i-this._dragHelperElementHeight)),this._dragHelperElement.positionAt(r,i);var s=this.slideHeight-(e*this.slideHeight+this.slideHelperHeight);this.slideHelper.style.top=s+"px",this._alphaElement.value=this._hsv[3]*100},_updateUI:function(){this._updateHelperLocations(),this._draggerElement.style.backgroundColor=WebInspector.Color.fromHSVA([this._hsv[0],1,1,1]).toString(WebInspector.Color.Format.RGB),this._swatchInnerElement.style.backgroundColor=this.color().toString(WebInspector.Color.Format.RGBA),this._alphaElement.value=this._hsv[3]*100},wasShown:function(){this.slideHeight=this._sliderElement.offsetHeight,this.dragWidth=this._draggerElement.offsetWidth,this.dragHeight=this._draggerElement.offsetHeight,this._dragHelperElementHeight=this._dragHelperElement.offsetHeight/2,this.slideHelperHeight=this.slideHelper.offsetHeight/2,this._updateUI()},__proto__:WebInspector.View.prototype},WebInspector.SpectrumPopupHelper=function(){this._spectrum=new WebInspector.Spectrum,this._spectrum.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),this._popover=new WebInspector.Popover,this._popover.setCanShrink(!1),this._popover.element.addEventListener("mousedown",consumeEvent,!1),this._hideProxy=this.hide.bind(this,!0)},WebInspector.SpectrumPopupHelper.Events={Hidden:"Hidden"},WebInspector.SpectrumPopupHelper.prototype={spectrum:function(){return this._spectrum},toggle:function(e,t,n){return this._popover.isShowing()?this.hide(!0):this.show(e,t,n),this._popover.isShowing()},show:function(e,t,n){if(this._popover.isShowing()){if(this._anchorElement===e)return!1;this.hide(!0)}return this._anchorElement=e,this._spectrum.setColor(t),this._spectrum._originalFormat=n!==WebInspector.Color.Format.Original?n:t.format(),this.reposition(e),document.addEventListener("mousedown",this._hideProxy,!1),window.addEventListener("blur",this._hideProxy,!1),!0},reposition:function(e){this._previousFocusElement||(this._previousFocusElement=WebInspector.currentFocusElement()),this._popover.showView(this._spectrum,e),WebInspector.setCurrentFocusElement(this._spectrum.element)},hide:function(e){if(!this._popover.isShowing())return;this._popover.hide(),document.removeEventListener("mousedown",this._hideProxy,!1),window.removeEventListener("blur",this._hideProxy,!1),this.dispatchEventToListeners(WebInspector.SpectrumPopupHelper.Events.Hidden,!!e),WebInspector.setCurrentFocusElement(this._previousFocusElement),delete this._previousFocusElement,delete this._anchorElement},_onKeyDown:function(e){if(e.keyIdentifier==="Enter"){this.hide(!0),e.consume(!0);return}e.keyIdentifier==="U+001B"&&(this.hide(!1),e.consume(!0))},__proto__:WebInspector.Object.prototype},WebInspector.ColorSwatch=function(){this.element=document.createElement("span"),this._swatchInnerElement=this.element.createChild("span","swatch-inner"),this.element.title=WebInspector.UIString("Click to open a colorpicker. Shift-click to change color format"),this.element.className="swatch",this.element.addEventListener("mousedown",consumeEvent,!1),this.element.addEventListener("dblclick",consumeEvent,!1)},WebInspector.ColorSwatch.prototype={setColorString:function(e){this._swatchInnerElement.style.backgroundColor=e}};