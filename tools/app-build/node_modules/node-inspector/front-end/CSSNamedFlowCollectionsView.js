/*
 * Copyright (C) 2012 Adobe Systems Incorporated. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1. Redistributions of source code must retain the above
 *    copyright notice, this list of conditions and the following
 *    disclaimer.
 * 2. Redistributions in binary form must reproduce the above
 *    copyright notice, this list of conditions and the following
 *    disclaimer in the documentation and/or other materials
 *    provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CSSNamedFlowCollectionsView=function(){WebInspector.SidebarView.call(this,WebInspector.SidebarView.SidebarPosition.Start),this.registerRequiredCSS("cssNamedFlows.css"),this._namedFlows={},this._contentNodes={},this._regionNodes={},this.element.addStyleClass("css-named-flow-collections-view"),this.element.addStyleClass("fill"),this._statusElement=document.createElement("span"),this._statusElement.textContent=WebInspector.UIString("CSS Named Flows");var e=this.firstElement().createChild("div","tabbed-pane-header selected sidebar-header"),t=e.createChild("div","tabbed-pane-header-tab");t.createChild("span","tabbed-pane-header-tab-title").textContent=WebInspector.UIString("CSS Named Flows"),this._sidebarContentElement=this.firstElement().createChild("div","sidebar-content outline-disclosure"),this._flowListElement=this._sidebarContentElement.createChild("ol"),this._flowTree=new TreeOutline(this._flowListElement),this._emptyElement=document.createElement("div"),this._emptyElement.addStyleClass("info"),this._emptyElement.textContent=WebInspector.UIString("No CSS Named Flows"),this._tabbedPane=new WebInspector.TabbedPane,this._tabbedPane.closeableTabs=!0,this._tabbedPane.show(this.secondElement())},WebInspector.CSSNamedFlowCollectionsView.prototype={showInDrawer:function(){WebInspector.showViewInDrawer(this._statusElement,this)},reset:function(){if(!this._document)return;WebInspector.cssModel.getNamedFlowCollectionAsync(this._document.id,this._resetNamedFlows.bind(this))},_setDocument:function(e){this._document=e,this.reset()},_documentUpdated:function(e){var t=e.data;this._setDocument(t)},_setSidebarHasContent:function(e){if(e){if(!this._emptyElement.parentNode)return;this._sidebarContentElement.removeChild(this._emptyElement),this._sidebarContentElement.appendChild(this._flowListElement)}else{if(!this._flowListElement.parentNode)return;this._sidebarContentElement.removeChild(this._flowListElement),this._sidebarContentElement.appendChild(this._emptyElement)}},_appendNamedFlow:function(e){var t=this._hashNamedFlow(e.documentNodeId,e.name),n={flow:e,flowHash:t};for(var r=0;r<e.content.length;++r)this._contentNodes[e.content[r]]=t;for(var r=0;r<e.regions.length;++r)this._regionNodes[e.regions[r].nodeId]=t;var i=new WebInspector.FlowTreeElement(n);i.onselect=this._selectNamedFlowTab.bind(this,t),n.flowTreeItem=i,this._namedFlows[t]=n,this._flowTree.children.length||this._setSidebarHasContent(!0),this._flowTree.appendChild(i)},_removeNamedFlow:function(e){var t=this._namedFlows[e];this._tabbedPane._tabsById[e]&&this._tabbedPane.closeTab(e),this._flowTree.removeChild(t.flowTreeItem);var n=t.flow;for(var r=0;r<n.content.length;++r)delete this._contentNodes[n.content[r]];for(var r=0;r<n.regions.length;++r)delete this._regionNodes[n.regions[r].nodeId];delete this._namedFlows[e],this._flowTree.children.length||this._setSidebarHasContent(!1)},_updateNamedFlow:function(e){var t=this._hashNamedFlow(e.documentNodeId,e.name),n=this._namedFlows[t];if(!n)return;var r=n.flow;n.flow=e;for(var i=0;i<r.content.length;++i)delete this._contentNodes[r.content[i]];for(var i=0;i<r.regions.length;++i)delete this._regionNodes[r.regions[i].nodeId];for(var i=0;i<e.content.length;++i)this._contentNodes[e.content[i]]=t;for(var i=0;i<e.regions.length;++i)this._regionNodes[e.regions[i].nodeId]=t;n.flowTreeItem.setOverset(e.overset),n.flowView&&(n.flowView.flow=e)},_resetNamedFlows:function(e){for(var t in this._namedFlows)this._removeNamedFlow(t);var n=e.namedFlowMap;for(var r in n)this._appendNamedFlow(n[r]);this._flowTree.children.length?this._showNamedFlowForNode(WebInspector.panel("elements").treeOutline.selectedDOMNode()):this._setSidebarHasContent(!1)},_namedFlowCreated:function(e){if(e.data.documentNodeId!==this._document.id)return;var t=e.data;this._appendNamedFlow(t)},_namedFlowRemoved:function(e){if(e.data.documentNodeId!==this._document.id)return;this._removeNamedFlow(this._hashNamedFlow(e.data.documentNodeId,e.data.flowName))},_regionLayoutUpdated:function(e){if(e.data.documentNodeId!==this._document.id)return;var t=e.data;this._updateNamedFlow(t)},_regionOversetChanged:function(e){if(e.data.documentNodeId!==this._document.id)return;var t=e.data;this._updateNamedFlow(t)},_hashNamedFlow:function(e,t){return e+"|"+t},_showNamedFlow:function(e){this._selectNamedFlowInSidebar(e),this._selectNamedFlowTab(e)},_selectNamedFlowInSidebar:function(e){this._namedFlows[e].flowTreeItem.select(!0)},_selectNamedFlowTab:function(e){var t=this._namedFlows[e];if(this._tabbedPane.selectedTabId===e)return;this._tabbedPane.selectTab(e)||(t.flowView||(t.flowView=new WebInspector.CSSNamedFlowView(t.flow)),this._tabbedPane.appendTab(e,t.flow.name,t.flowView),this._tabbedPane.selectTab(e))},_selectedNodeChanged:function(e){var t=e.data;this._showNamedFlowForNode(t)},_tabSelected:function(e){this._selectNamedFlowInSidebar(e.data.tabId)},_tabClosed:function(e){this._namedFlows[e.data.tabId].flowTreeItem.deselect()},_showNamedFlowForNode:function(e){if(!e)return;if(this._regionNodes[e.id]){this._showNamedFlow(this._regionNodes[e.id]);return}while(e){if(this._contentNodes[e.id]){this._showNamedFlow(this._contentNodes[e.id]);return}e=e.parentNode}},wasShown:function(){WebInspector.SidebarView.prototype.wasShown.call(this),WebInspector.domAgent.requestDocument(this._setDocument.bind(this)),WebInspector.domAgent.addEventListener(WebInspector.DOMAgent.Events.DocumentUpdated,this._documentUpdated,this),WebInspector.cssModel.addEventListener(WebInspector.CSSStyleModel.Events.NamedFlowCreated,this._namedFlowCreated,this),WebInspector.cssModel.addEventListener(WebInspector.CSSStyleModel.Events.NamedFlowRemoved,this._namedFlowRemoved,this),WebInspector.cssModel.addEventListener(WebInspector.CSSStyleModel.Events.RegionLayoutUpdated,this._regionLayoutUpdated,this),WebInspector.cssModel.addEventListener(WebInspector.CSSStyleModel.Events.RegionOversetChanged,this._regionOversetChanged,this),WebInspector.panel("elements").treeOutline.addEventListener(WebInspector.ElementsTreeOutline.Events.SelectedNodeChanged,this._selectedNodeChanged,this),this._tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabSelected,this._tabSelected,this),this._tabbedPane.addEventListener(WebInspector.TabbedPane.EventTypes.TabClosed,this._tabClosed,this)},willHide:function(){WebInspector.domAgent.removeEventListener(WebInspector.DOMAgent.Events.DocumentUpdated,this._documentUpdated,this),WebInspector.cssModel.removeEventListener(WebInspector.CSSStyleModel.Events.NamedFlowCreated,this._namedFlowCreated,this),WebInspector.cssModel.removeEventListener(WebInspector.CSSStyleModel.Events.NamedFlowRemoved,this._namedFlowRemoved,this),WebInspector.cssModel.removeEventListener(WebInspector.CSSStyleModel.Events.RegionLayoutUpdated,this._regionLayoutUpdated,this),WebInspector.cssModel.removeEventListener(WebInspector.CSSStyleModel.Events.RegionOversetChanged,this._regionOversetChanged,this),WebInspector.panel("elements").treeOutline.removeEventListener(WebInspector.ElementsTreeOutline.Events.SelectedNodeChanged,this._selectedNodeChanged,this),this._tabbedPane.removeEventListener(WebInspector.TabbedPane.EventTypes.TabSelected,this._tabSelected,this),this._tabbedPane.removeEventListener(WebInspector.TabbedPane.EventTypes.TabClosed,this._tabClosed,this)},__proto__:WebInspector.SidebarView.prototype},WebInspector.FlowTreeElement=function(e){var t=document.createElement("div");t.createChild("div","selection"),t.createChild("span","title").createChild("span").textContent=e.flow.name,TreeElement.call(this,t,e,!1),this._overset=!1,this.setOverset(e.flow.overset)},WebInspector.FlowTreeElement.prototype={setOverset:function(e){if(this._overset===e)return;e?(this.title.addStyleClass("named-flow-overflow"),this.tooltip=WebInspector.UIString("Overflows.")):(this.title.removeStyleClass("named-flow-overflow"),this.tooltip=""),this._overset=e},__proto__:TreeElement.prototype};