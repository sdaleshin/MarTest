/*
 * Copyright (C) 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2011 Google Inc.  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.TextPrompt=function(e,t){this._proxyElement,this._proxyElementDisplay="inline-block",this._loadCompletions=e,this._completionStopCharacters=t||" =:[({;,!+-*/&|^<>.",this._suggestForceable=!0},WebInspector.TextPrompt.Events={ItemApplied:"text-prompt-item-applied",ItemAccepted:"text-prompt-item-accepted"},WebInspector.TextPrompt.prototype={get proxyElement(){return this._proxyElement},setSuggestForceable:function(e){this._suggestForceable=e},setShowSuggestForEmptyInput:function(e){this._showSuggestForEmptyInput=e},setSuggestBoxEnabled:function(e){this._suggestBoxClassName=e},renderAsBlock:function(){this._proxyElementDisplay="block"},attach:function(e){return this._attachInternal(e)},attachAndStartEditing:function(e,t){return this._attachInternal(e),this._startEditing(t),this.proxyElement},_attachInternal:function(e){if(this.proxyElement)throw"Cannot attach an attached TextPrompt";return this._element=e,this._boundOnKeyDown=this.onKeyDown.bind(this),this._boundOnMouseWheel=this.onMouseWheel.bind(this),this._boundSelectStart=this._selectStart.bind(this),this._proxyElement=e.ownerDocument.createElement("span"),this._proxyElement.style.display=this._proxyElementDisplay,e.parentElement.insertBefore(this.proxyElement,e),this.proxyElement.appendChild(e),this._element.addStyleClass("text-prompt"),this._element.addEventListener("keydown",this._boundOnKeyDown,!1),this._element.addEventListener("mousewheel",this._boundOnMouseWheel,!1),this._element.addEventListener("selectstart",this._boundSelectStart,!1),typeof this._suggestBoxClassName=="string"&&(this._suggestBox=new WebInspector.SuggestBox(this,this._element,this._suggestBoxClassName)),this.proxyElement},detach:function(){this._removeFromElement(),this.proxyElement.parentElement.insertBefore(this._element,this.proxyElement),this.proxyElement.remove(),delete this._proxyElement,this._element.removeStyleClass("text-prompt"),this._element.removeEventListener("keydown",this._boundOnKeyDown,!1),this._element.removeEventListener("mousewheel",this._boundOnMouseWheel,!1),this._element.removeEventListener("selectstart",this._boundSelectStart,!1),WebInspector.restoreFocusFromElement(this._element)},get text(){return this._element.textContent},set text(e){this._removeSuggestionAids(),e?this._element.textContent=e:(this._element.removeChildren(),this._element.appendChild(document.createElement("br"))),this.moveCaretToEndOfPrompt(),this._element.scrollIntoView()},_removeFromElement:function(){this.clearAutoComplete(!0),this._element.removeEventListener("keydown",this._boundOnKeyDown,!1),this._element.removeEventListener("selectstart",this._boundSelectStart,!1),this._isEditing&&this._stopEditing(),this._suggestBox&&this._suggestBox.removeFromElement()},_startEditing:function(e){this._isEditing=!0,this._element.addStyleClass("editing"),e&&(this._blurListener=e,this._element.addEventListener("blur",this._blurListener,!1)),this._oldTabIndex=this._element.tabIndex,this._element.tabIndex<0&&(this._element.tabIndex=0),WebInspector.setCurrentFocusElement(this._element),this.text||this._updateAutoComplete()},_stopEditing:function(){this._element.tabIndex=this._oldTabIndex,this._blurListener&&this._element.removeEventListener("blur",this._blurListener,!1),this._element.removeStyleClass("editing"),delete this._isEditing},_removeSuggestionAids:function(){this.clearAutoComplete(),this.hideSuggestBox()},_selectStart:function(){function e(){delete this._selectionTimeout,!this.isCaretInsidePrompt()&&window.getSelection().isCollapsed&&(this.moveCaretToEndOfPrompt(),this.autoCompleteSoon())}this._selectionTimeout&&clearTimeout(this._selectionTimeout),this._removeSuggestionAids(),this._selectionTimeout=setTimeout(e.bind(this),100)},defaultKeyHandler:function(e,t){return this._updateAutoComplete(t),!1},_updateAutoComplete:function(e){this.clearAutoComplete(),this.autoCompleteSoon(e)},onMouseWheel:function(e){},onKeyDown:function(e){var t=!1,n=!0;switch(e.keyIdentifier){case"U+0009":t=this.tabKeyPressed(e);break;case"Left":case"Home":this._removeSuggestionAids(),n=!1;break;case"Right":case"End":this.isCaretAtEndOfPrompt()?t=this.acceptAutoComplete():this._removeSuggestionAids(),n=!1;break;case"U+001B":this.isSuggestBoxVisible()&&(this._removeSuggestionAids(),t=!0);break;case"U+0020":this._suggestForceable&&e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey&&(this.defaultKeyHandler(e,!0),t=!0);break;case"Alt":case"Meta":case"Shift":case"Control":n=!1}return!t&&this.isSuggestBoxVisible()&&(t=this._suggestBox.keyPressed(e)),!t&&n&&(t=this.defaultKeyHandler(e)),t&&e.consume(!0),t},acceptAutoComplete:function(){var e=!1;return this.isSuggestBoxVisible()&&(e=this._suggestBox.acceptSuggestion()),e||(e=this.acceptSuggestion()),e},clearAutoComplete:function(e){e&&this._completeTimeout&&(clearTimeout(this._completeTimeout),delete this._completeTimeout),delete this._waitingForCompletions;if(!this.autoCompleteElement)return;this.autoCompleteElement.remove(),delete this.autoCompleteElement;if(!this._userEnteredRange||!this._userEnteredText)return;this._userEnteredRange.deleteContents(),this._element.normalize();var t=document.createTextNode(this._userEnteredText);this._userEnteredRange.insertNode(t);var n=document.createRange();n.setStart(t,this._userEnteredText.length),n.setEnd(t,this._userEnteredText.length);var r=window.getSelection();r.removeAllRanges(),r.addRange(n),delete this._userEnteredRange,delete this._userEnteredText},autoCompleteSoon:function(e){var t=this.isSuggestBoxVisible()||e;this._completeTimeout||(this._completeTimeout=setTimeout(this.complete.bind(this,e),t?0:250))},complete:function(e,t){this.clearAutoComplete(!0);var n=window.getSelection();if(!n.rangeCount)return;var r=n.getRangeAt(0),i;if(!e&&!this.isCaretAtEndOfPrompt()&&!this.isSuggestBoxVisible())i=!0;else if(!n.isCollapsed)i=!0;else if(!e){var s=r.startContainer.rangeOfWord(r.endOffset,this._completionStopCharacters,this._element,"forward");s.toString().length&&(i=!0)}if(i){this.hideSuggestBox();return}var o=r.startContainer.rangeOfWord(r.startOffset,this._completionStopCharacters,this._element,"backward");this._waitingForCompletions=!0,this._loadCompletions(this.proxyElement,o,e,this._completionsReady.bind(this,n,o,!!t))},_boxForAnchorAtStart:function(e,t){var n=e.getRangeAt(0).cloneRange(),r=document.createElement("span");r.textContent="â€‹",t.insertNode(r);var i=r.boxInWindow(window);return r.remove(),e.removeAllRanges(),e.addRange(n),i},_buildCommonPrefix:function(e,t){var n=e[0];for(var r=0;r<e.length;++r){var i=e[r],s=Math.min(n.length,i.length);for(var o=t;o<s;++o)if(n[o]!==i[o]){n=n.substr(0,o);break}}return n},_completionsReady:function(e,t,n,r,i){if(!this._waitingForCompletions||!r.length){this.hideSuggestBox();return}delete this._waitingForCompletions;var s=e.getRangeAt(0),o=document.createRange();o.setStart(t.startContainer,t.startOffset),o.setEnd(s.endContainer,s.endOffset);if(t.toString()+s.toString()!=o.toString())return;i=i||0,this._userEnteredRange=o,this._userEnteredText=o.toString(),this._suggestBox&&this._suggestBox.updateSuggestions(this._boxForAnchorAtStart(e,o),r,i,!this.isCaretAtEndOfPrompt(),this._userEnteredText);var u=t.toString().length;this._commonPrefix=this._buildCommonPrefix(r,u);if(this.isCaretAtEndOfPrompt()){this._userEnteredRange.deleteContents(),this._element.normalize();var a=document.createRange(),f=r[i],l=f.substring(0,u),c=f.substring(u),h=document.createTextNode(l);o.insertNode(h),this.autoCompleteElement=document.createElement("span"),this.autoCompleteElement.className="auto-complete-text",this.autoCompleteElement.textContent=c,h.parentNode.insertBefore(this.autoCompleteElement,h.nextSibling),a.setStart(h,u),a.setEnd(h,u),e.removeAllRanges(),e.addRange(a)}},_completeCommonPrefix:function(){if(!this.autoCompleteElement||!this._commonPrefix||!this._userEnteredText||!this._commonPrefix.startsWith(this._userEnteredText))return;if(!this.isSuggestBoxVisible()){this.acceptAutoComplete();return}this.autoCompleteElement.textContent=this._commonPrefix.substring(this._userEnteredText.length),this.acceptSuggestion(!0)},applySuggestion:function(e,t){this._applySuggestion(e,t)},_applySuggestion:function(e,t,n){var r;n?r=n.toString().length:r=this._userEnteredText?this._userEnteredText.length:0,this._userEnteredRange.deleteContents(),this._element.normalize();var i=document.createRange(),s=document.createTextNode(e);this._userEnteredRange.insertNode(s),this.autoCompleteElement&&(this.autoCompleteElement.remove(),delete this.autoCompleteElement),t?i.setStart(s,r):i.setStart(s,e.length),i.setEnd(s,e.length);var o=window.getSelection();o.removeAllRanges(),o.addRange(i),t&&this.dispatchEventToListeners(WebInspector.TextPrompt.Events.ItemApplied,{itemText:e})},acceptSuggestion:function(e){if(this._isAcceptingSuggestion)return!1;if(!this.autoCompleteElement||!this.autoCompleteElement.parentNode)return!1;var t=this.autoCompleteElement.textContent,n=document.createTextNode(t);this.autoCompleteElement.parentNode.replaceChild(n,this.autoCompleteElement),delete this.autoCompleteElement;var r=document.createRange();r.setStart(n,t.length),r.setEnd(n,t.length);var i=window.getSelection();return i.removeAllRanges(),i.addRange(r),e?this.autoCompleteSoon(!0):(this.hideSuggestBox(),this.dispatchEventToListeners(WebInspector.TextPrompt.Events.ItemAccepted)),!0},hideSuggestBox:function(){this.isSuggestBoxVisible()&&this._suggestBox.hide()},isSuggestBoxVisible:function(){return this._suggestBox&&this._suggestBox.visible()},isCaretInsidePrompt:function(){return this._element.isInsertionCaretInside()},isCaretAtEndOfPrompt:function(){var e=window.getSelection();if(!e.rangeCount||!e.isCollapsed)return!1;var t=e.getRangeAt(0),n=t.startContainer;if(!n.isSelfOrDescendant(this._element))return!1;if(n.nodeType===Node.TEXT_NODE&&t.startOffset<n.nodeValue.length)return!1;var r=!1;while(n){if(n.nodeType===Node.TEXT_NODE&&n.nodeValue.length){if(r&&(!this.autoCompleteElement||!this.autoCompleteElement.isAncestor(n)))return!1;r=!0}n=n.traverseNextNode(this._element)}return!0},isCaretOnFirstLine:function(){var e=window.getSelection(),t=e.focusNode;if(!t||t.nodeType!==Node.TEXT_NODE||t.parentNode!==this._element)return!0;if(t.textContent.substring(0,e.focusOffset).indexOf("\n")!==-1)return!1;t=t.previousSibling;while(t){if(t.nodeType!==Node.TEXT_NODE)return!0;if(t.textContent.indexOf("\n")!==-1)return!1;t=t.previousSibling}return!0},isCaretOnLastLine:function(){var e=window.getSelection(),t=e.focusNode;if(!t||t.nodeType!==Node.TEXT_NODE||t.parentNode!==this._element)return!0;if(t.textContent.substring(e.focusOffset).indexOf("\n")!==-1)return!1;t=t.nextSibling;while(t){if(t.nodeType!==Node.TEXT_NODE)return!0;if(t.textContent.indexOf("\n")!==-1)return!1;t=t.nextSibling}return!0},moveCaretToEndOfPrompt:function(){var e=window.getSelection(),t=document.createRange(),n=this._element.childNodes.length;t.setStart(this._element,n),t.setEnd(this._element,n),e.removeAllRanges(),e.addRange(t)},tabKeyPressed:function(e){return this._completeCommonPrefix(),!0},__proto__:WebInspector.Object.prototype},WebInspector.TextPromptWithHistory=function(e,t){WebInspector.TextPrompt.call(this,e,t),this._data=[],this._historyOffset=1,this._coalesceHistoryDupes=!0},WebInspector.TextPromptWithHistory.prototype={get historyData(){return this._data},setCoalesceHistoryDupes:function(e){this._coalesceHistoryDupes=e},setHistoryData:function(e){this._data=[].concat(e),this._historyOffset=1},pushHistoryItem:function(e){this._uncommittedIsTop&&(this._data.pop(),delete this._uncommittedIsTop),this._historyOffset=1;if(this._coalesceHistoryDupes&&e===this._currentHistoryItem())return;this._data.push(e)},_pushCurrentText:function(){this._uncommittedIsTop&&this._data.pop(),this._uncommittedIsTop=!0,this.clearAutoComplete(!0),this._data.push(this.text)},_previous:function(){return this._historyOffset>this._data.length?undefined:(this._historyOffset===1&&this._pushCurrentText(),++this._historyOffset,this._currentHistoryItem())},_next:function(){return this._historyOffset===1?undefined:(--this._historyOffset,this._currentHistoryItem())},_currentHistoryItem:function(){return this._data[this._data.length-this._historyOffset]},defaultKeyHandler:function(e,t){var n,r;switch(e.keyIdentifier){case"Up":if(!this.isCaretOnFirstLine())break;n=this._previous(),r=!0;break;case"Down":if(!this.isCaretOnLastLine())break;n=this._next();break;case"U+0050":WebInspector.isMac()&&e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey&&(n=this._previous(),r=!0);break;case"U+004E":WebInspector.isMac()&&e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey&&(n=this._next())}if(n!==undefined){e.consume(!0),this.text=n;if(r){var i=this.text.indexOf("\n");if(i===-1)this.moveCaretToEndOfPrompt();else{var s=window.getSelection(),o=document.createRange();o.setStart(this._element.firstChild,i),o.setEnd(this._element.firstChild,i),s.removeAllRanges(),s.addRange(o)}}return!0}return WebInspector.TextPrompt.prototype.defaultKeyHandler.apply(this,arguments)},__proto__:WebInspector.TextPrompt.prototype};