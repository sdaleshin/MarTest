/*
 * Copyright (C) IBM Corp. 2009  All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of IBM Corp. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.WatchExpressionsSidebarPane=function(){WebInspector.SidebarPane.call(this,WebInspector.UIString("Watch Expressions")),this.section=new WebInspector.WatchExpressionsSection,this.bodyElement.appendChild(this.section.element);var e=document.createElement("button");e.className="pane-title-button refresh",e.addEventListener("click",this._refreshButtonClicked.bind(this),!1),e.title=WebInspector.UIString("Refresh"),this.titleElement.appendChild(e);var t=document.createElement("button");t.className="pane-title-button add",t.addEventListener("click",this._addButtonClicked.bind(this),!1),this.titleElement.appendChild(t),t.title=WebInspector.UIString("Add watch expression"),this._requiresUpdate=!0},WebInspector.WatchExpressionsSidebarPane.prototype={wasShown:function(){this._refreshExpressionsIfNeeded()},reset:function(){this.refreshExpressions()},refreshExpressions:function(){this._requiresUpdate=!0,this._refreshExpressionsIfNeeded()},addExpression:function(e){this.section.addExpression(e),this.expand()},_refreshExpressionsIfNeeded:function(){this._requiresUpdate&&this.isShowing()?(this.section.update(),delete this._requiresUpdate):this._requiresUpdate=!0},_addButtonClicked:function(e){e.consume(),this.expand(),this.section.addNewExpressionAndEdit()},_refreshButtonClicked:function(e){e.consume(),this.refreshExpressions()},__proto__:WebInspector.SidebarPane.prototype},WebInspector.WatchExpressionsSection=function(){this._watchObjectGroupId="watch-group",WebInspector.ObjectPropertiesSection.call(this,WebInspector.RemoteObject.fromPrimitiveValue("")),this.treeElementConstructor=WebInspector.WatchedPropertyTreeElement,this._expandedExpressions={},this._expandedProperties={},this.emptyElement=document.createElement("div"),this.emptyElement.className="info",this.emptyElement.textContent=WebInspector.UIString("No Watch Expressions"),this.watchExpressions=WebInspector.settings.watchExpressions.get(),this.headerElement.className="hidden",this.editable=!0,this.expanded=!0,this.propertiesElement.addStyleClass("watch-expressions"),this.element.addEventListener("mousemove",this._mouseMove.bind(this),!0),this.element.addEventListener("mouseout",this._mouseOut.bind(this),!0),this.element.addEventListener("dblclick",this._sectionDoubleClick.bind(this),!1),this.emptyElement.addEventListener("contextmenu",this._emptyElementContextMenu.bind(this),!1)},WebInspector.WatchExpressionsSection.NewWatchExpression="Â ",WebInspector.WatchExpressionsSection.prototype={update:function(e){function t(e,t,i,s){if(!i)return;var o=new WebInspector.RemoteObjectProperty(e,i);o.watchIndex=t,o.wasThrown=s,n.push(o);if(n.length==r){this.updateProperties(n,[],WebInspector.WatchExpressionTreeElement,WebInspector.WatchExpressionsSection.CompareProperties);if(this._newExpressionAdded){delete this._newExpressionAdded;var u=this.findAddedTreeElement();u&&u.startEditing()}this._lastMouseMovePageY&&this._updateHoveredElement(this._lastMouseMovePageY)}}e&&e.consume(),RuntimeAgent.releaseObjectGroup(this._watchObjectGroupId);var n=[],r=0;for(var i=0;i<this.watchExpressions.length;++i){if(!this.watchExpressions[i])continue;++r}for(var i=0;i<this.watchExpressions.length;++i){var s=this.watchExpressions[i];if(!s)continue;WebInspector.runtimeModel.evaluate(s,this._watchObjectGroupId,!1,!0,!1,!1,t.bind(this,s,i))}r?this.emptyElement.parentNode&&this.element.removeChild(this.emptyElement):this.emptyElement.parentNode||this.element.appendChild(this.emptyElement),this.expanded=r!=0},addExpression:function(e){this.watchExpressions.push(e),this.saveExpressions(),this.update()},addNewExpressionAndEdit:function(){this._newExpressionAdded=!0,this.watchExpressions.push(WebInspector.WatchExpressionsSection.NewWatchExpression),this.update()},_sectionDoubleClick:function(e){if(e.target!==this.element&&e.target!==this.propertiesElement&&e.target!==this.emptyElement)return;e.consume(),this.addNewExpressionAndEdit()},updateExpression:function(e,t){if(t===null){var n=e.property.watchIndex;this.watchExpressions.splice(n,1)}else this.watchExpressions[e.property.watchIndex]=t;this.saveExpressions(),this.update()},_deleteAllExpressions:function(){this.watchExpressions=[],this.saveExpressions(),this.update()},findAddedTreeElement:function(){var e=this.propertiesTreeOutline.children;for(var t=0;t<e.length;++t)if(e[t].property.name===WebInspector.WatchExpressionsSection.NewWatchExpression)return e[t]},saveExpressions:function(){var e=[];for(var t=0;t<this.watchExpressions.length;t++)this.watchExpressions[t]&&e.push(this.watchExpressions[t]);return WebInspector.settings.watchExpressions.set(e),e.length},_mouseMove:function(e){this.propertiesElement.firstChild&&this._updateHoveredElement(e.pageY)},_mouseOut:function(){this._hoveredElement&&(this._hoveredElement.removeStyleClass("hovered"),delete this._hoveredElement),delete this._lastMouseMovePageY},_updateHoveredElement:function(e){var t=this.propertiesElement.firstChild;for(;;){var n=t.nextSibling;while(n&&!n.clientHeight)n=n.nextSibling;if(!n||n.totalOffsetTop()>e)break;t=n}this._hoveredElement!==t&&(this._hoveredElement&&this._hoveredElement.removeStyleClass("hovered"),t&&t.addStyleClass("hovered"),this._hoveredElement=t),this._lastMouseMovePageY=e},_emptyElementContextMenu:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add watch expression":"Add Watch Expression"),this.addNewExpressionAndEdit.bind(this)),t.show()},__proto__:WebInspector.ObjectPropertiesSection.prototype},WebInspector.WatchExpressionsSection.CompareProperties=function(e,t){return e.watchIndex==t.watchIndex?0:e.watchIndex<t.watchIndex?-1:1},WebInspector.WatchExpressionTreeElement=function(e){WebInspector.ObjectPropertyTreeElement.call(this,e)},WebInspector.WatchExpressionTreeElement.prototype={onexpand:function(){WebInspector.ObjectPropertyTreeElement.prototype.onexpand.call(this),this.treeOutline.section._expandedExpressions[this._expression()]=!0},oncollapse:function(){WebInspector.ObjectPropertyTreeElement.prototype.oncollapse.call(this),delete this.treeOutline.section._expandedExpressions[this._expression()]},onattach:function(){WebInspector.ObjectPropertyTreeElement.prototype.onattach.call(this),this.treeOutline.section._expandedExpressions[this._expression()]&&(this.expanded=!0)},_expression:function(){return this.property.name},update:function(){WebInspector.ObjectPropertyTreeElement.prototype.update.call(this),this.property.wasThrown?(this.valueElement.textContent=WebInspector.UIString("<not available>"),this.listItemElement.addStyleClass("dimmed")):this.listItemElement.removeStyleClass("dimmed");var e=document.createElement("input");e.type="button",e.title=WebInspector.UIString("Delete watch expression."),e.addStyleClass("enabled-button"),e.addStyleClass("delete-button"),e.addEventListener("click",this._deleteButtonClicked.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._contextMenu.bind(this),!1),this.listItemElement.insertBefore(e,this.listItemElement.firstChild)},populateContextMenu:function(e){this.isEditing()||(e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Add watch expression":"Add Watch Expression"),this.treeOutline.section.addNewExpressionAndEdit.bind(this.treeOutline.section)),e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Delete watch expression":"Delete Watch Expression"),this._deleteButtonClicked.bind(this))),this.treeOutline.section.watchExpressions.length>1&&e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Delete all watch expressions":"Delete All Watch Expressions"),this._deleteAllButtonClicked.bind(this))},_contextMenu:function(e){var t=new WebInspector.ContextMenu(e);this.populateContextMenu(t),t.show()},_deleteAllButtonClicked:function(){this.treeOutline.section._deleteAllExpressions()},_deleteButtonClicked:function(){this.treeOutline.section.updateExpression(this,null)},renderPromptAsBlock:function(){return!0},elementAndValueToEdit:function(e){return[this.nameElement,this.property.name.trim()]},editingCancelled:function(e,t){t.elementToEdit.textContent||this.treeOutline.section.updateExpression(this,null),WebInspector.ObjectPropertyTreeElement.prototype.editingCancelled.call(this,e,t)},applyExpression:function(e,t){e=e.trim(),e||(e=null),this.property.name=e,this.treeOutline.section.updateExpression(this,e)},__proto__:WebInspector.ObjectPropertyTreeElement.prototype},WebInspector.WatchedPropertyTreeElement=function(e){WebInspector.ObjectPropertyTreeElement.call(this,e)},WebInspector.WatchedPropertyTreeElement.prototype={onattach:function(){WebInspector.ObjectPropertyTreeElement.prototype.onattach.call(this),this.hasChildren&&this.propertyPath()in this.treeOutline.section._expandedProperties&&this.expand()},onexpand:function(){WebInspector.ObjectPropertyTreeElement.prototype.onexpand.call(this),this.treeOutline.section._expandedProperties[this.propertyPath()]=!0},oncollapse:function(){WebInspector.ObjectPropertyTreeElement.prototype.oncollapse.call(this),delete this.treeOutline.section._expandedProperties[this.propertyPath()]},__proto__:WebInspector.ObjectPropertyTreeElement.prototype};