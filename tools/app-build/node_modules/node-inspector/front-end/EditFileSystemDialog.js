/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.EditFileSystemDialog=function(e){WebInspector.DialogDelegate.call(this),this._fileSystemPath=e,this.element=document.createElement("div"),this.element.className="edit-file-system-dialog";var t=this.element.createChild("div","header"),n=t.createChild("span");n.textContent="Edit file system";var r=t.createChild("div","close-button-gray done-button");r.addEventListener("click",this._onDoneClick.bind(this),!1);var i=this.element.createChild("div","contents");WebInspector.isolatedFileSystemManager.mapping().addEventListener(WebInspector.FileSystemMapping.Events.FileMappingAdded,this._fileMappingAdded,this),WebInspector.isolatedFileSystemManager.mapping().addEventListener(WebInspector.FileSystemMapping.Events.FileMappingRemoved,this._fileMappingRemoved,this),WebInspector.isolatedFileSystemManager.mapping().addEventListener(WebInspector.FileSystemMapping.Events.ExcludedFolderAdded,this._excludedFolderAdded,this),WebInspector.isolatedFileSystemManager.mapping().addEventListener(WebInspector.FileSystemMapping.Events.ExcludedFolderRemoved,this._excludedFolderRemoved,this);var s=i.createChild("div","block-header");s.textContent="Mappings",this._fileMappingsSection=i.createChild("div","file-mappings-section"),this._fileMappingsListContainer=this._fileMappingsSection.createChild("div","settings-list-container");var o=WebInspector.isolatedFileSystemManager.mapping().mappingEntries(this._fileSystemPath);this._fileMappingsList=new WebInspector.EditableSettingsList(["url","path"],this._fileMappingValuesProvider.bind(this),this._fileMappingValidate.bind(this),this._fileMappingEdit.bind(this)),this._fileMappingsList.addEventListener(WebInspector.SettingsList.Events.Removed,this._fileMappingRemovedfromList.bind(this)),this._fileMappingsList.element.addStyleClass("file-mappings-list"),this._fileMappingsListContainer.appendChild(this._fileMappingsList.element),this._entries={};for(var u=0;u<o.length;++u)this._addMappingRow(o[u]);s=i.createChild("div","block-header"),s.textContent="Excluded folders",this._excludedFolderListSection=i.createChild("div","excluded-folders-section"),this._excludedFolderListContainer=this._excludedFolderListSection.createChild("div","settings-list-container");var a=WebInspector.isolatedFileSystemManager.mapping().excludedFolders(e);this._excludedFolderList=new WebInspector.EditableSettingsList(["path"],this._excludedFolderValueProvider.bind(this),this._excludedFolderValidate.bind(this),this._excludedFolderEdit.bind(this)),this._excludedFolderList.addEventListener(WebInspector.SettingsList.Events.Removed,this._excludedFolderRemovedfromList.bind(this)),this._excludedFolderList.element.addStyleClass("excluded-folders-list"),this._excludedFolderListContainer.appendChild(this._excludedFolderList.element),this._excludedFolderEntries=new StringMap;for(var u=0;u<a.length;++u)this._addExcludedFolderRow(a[u]);this.element.tabIndex=0},WebInspector.EditFileSystemDialog.show=function(e,t){WebInspector.Dialog.show(e,new WebInspector.EditFileSystemDialog(t));var n=document.getElementById("glass-pane");n.addStyleClass("settings-glass-pane")},WebInspector.EditFileSystemDialog.prototype={show:function(e){e.appendChild(this.element),this.element.addStyleClass("dialog-contents"),e.addStyleClass("settings-dialog"),e.addStyleClass("settings-tab"),this._dialogElement=e},_resize:function(){if(!this._dialogElement)return;const e=540,t=150;var n=document.body.offsetHeight-10;n=Math.max(t,n),this._dialogElement.style.maxHeight=n+"px",this._dialogElement.style.width=e+"px"},position:function(e,t){this._resize()},willHide:function(e){},_fileMappingAdded:function(e){var t=e.data;this._addMappingRow(t)},_fileMappingRemoved:function(e){var t=e.data;if(this._fileSystemPath!==t.fileSystemPath)return;delete this._entries[t.urlPrefix],this._fileMappingsList.itemForId(t.urlPrefix)&&this._fileMappingsList.removeItem(t.urlPrefix),this._resize()},_fileMappingValuesProvider:function(e,t){if(!e)return"";var n=this._entries[e];switch(t){case"url":return n.urlPrefix;case"path":return n.pathPrefix;default:console.assert("Should not be reached.")}return""},_fileMappingValidate:function(e,t){var n=e?this._entries[e].pathPrefix:null;return this._validateMapping(t.url,e,t.path,n)},_fileMappingEdit:function(e,t){if(e){var n=e,r=this._entries[e].pathPrefix,i=this._entries[e].fileSystemPath;WebInspector.isolatedFileSystemManager.mapping().removeFileMapping(i,n,r)}this._addFileMapping(t.url,t.path)},_validateMapping:function(e,t,n,r){var i=[];return this._checkURLPrefix(e,t)||i.push("url"),this._checkPathPrefix(n,r)||i.push("path"),i},_fileMappingRemovedfromList:function(e){var t=e.data;if(!t)return;var n=this._entries[t];WebInspector.isolatedFileSystemManager.mapping().removeFileMapping(n.fileSystemPath,n.urlPrefix,n.pathPrefix)},_addFileMapping:function(e,t){var n=this._normalizePrefix(e),r=this._normalizePrefix(t);return WebInspector.isolatedFileSystemManager.mapping().addFileMapping(this._fileSystemPath,n,r),this._fileMappingsList.selectItem(n),!0},_normalizePrefix:function(e){return e?e+(e[e.length-1]==="/"?"":"/"):""},_addMappingRow:function(e){var t=e.fileSystemPath,n=e.urlPrefix;if(!this._fileSystemPath||this._fileSystemPath!==t)return;this._entries[n]=e;var r=this._fileMappingsList.addItem(n,null);this._resize()},_excludedFolderAdded:function(e){var t=e.data;this._addExcludedFolderRow(t)},_excludedFolderRemoved:function(e){var t=e.data,n=t.fileSystemPath;if(!n||this._fileSystemPath!==n)return;delete this._excludedFolderEntries[t.path],this._excludedFolderList.itemForId(t.path)&&this._excludedFolderList.removeItem(t.path)},_excludedFolderValueProvider:function(e,t){return e},_excludedFolderValidate:function(e,t){var n=this._fileSystemPath,r=[];return this._validateExcludedFolder(t.path,e)||r.push("path"),r},_validateExcludedFolder:function(e,t){return!!e&&(e===t||!this._excludedFolderEntries.contains(e))},_excludedFolderEdit:function(e,t){var n=this._fileSystemPath;e&&WebInspector.isolatedFileSystemManager.mapping().removeExcludedFolder(n,e);var r=t.path;WebInspector.isolatedFileSystemManager.mapping().addExcludedFolder(n,r)},_excludedFolderRemovedfromList:function(e){var t=e.data;if(!t)return;WebInspector.isolatedFileSystemManager.mapping().removeExcludedFolder(this._fileSystemPath,t)},_addExcludedFolderRow:function(e){var t=e.fileSystemPath;if(!t||this._fileSystemPath!==t)return;var n=e.path;this._excludedFolderEntries.put(n,e),this._excludedFolderList.addItem(n,null)},_checkURLPrefix:function(e,t){var n=this._normalizePrefix(e);return!!n&&(n===t||!this._entries[n])},_checkPathPrefix:function(e,t){var n=this._normalizePrefix(e);if(!n)return!1;if(n===t)return!0;for(var r in this._entries){var i=this._entries[r];if(r&&i.pathPrefix===n)return!1}return!0},focus:function(){WebInspector.setCurrentFocusElement(this.element)},_onDoneClick:function(){WebInspector.Dialog.hide()},onEnter:function(){},__proto__:WebInspector.DialogDelegate.prototype};