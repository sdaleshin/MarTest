/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.MemoryStatistics=function(e,t,n){this._timelinePanel=e,this._counters=[],t.addEventListener(WebInspector.TimelineModel.Events.RecordAdded,this._onRecordAdded,this),t.addEventListener(WebInspector.TimelineModel.Events.RecordsCleared,this._onRecordsCleared,this),this._containerAnchor=e.element.lastChild,this._memorySidebarView=new WebInspector.SidebarView(WebInspector.SidebarView.SidebarPosition.Start,undefined,n),this._memorySidebarView.sidebarElement.addStyleClass("sidebar"),this._memorySidebarView.element.id="memory-graphs-container",this._memorySidebarView.addEventListener(WebInspector.SidebarView.EventTypes.Resized,this._sidebarResized.bind(this)),this._canvasContainer=this._memorySidebarView.mainElement,this._canvasContainer.id="memory-graphs-canvas-container",this._createCurrentValuesBar(),this._canvas=this._canvasContainer.createChild("canvas"),this._canvas.id="memory-counters-graph",this._lastMarkerXPosition=0,this._canvas.addEventListener("mouseover",this._onMouseOver.bind(this),!0),this._canvas.addEventListener("mousemove",this._onMouseMove.bind(this),!0),this._canvas.addEventListener("mouseout",this._onMouseOut.bind(this),!0),this._canvas.addEventListener("click",this._onClick.bind(this),!0),this._timelineGrid=new WebInspector.TimelineGrid,this._canvasContainer.appendChild(this._timelineGrid.dividersElement),this._memorySidebarView.sidebarElement.createChild("div","sidebar-tree sidebar-tree-section").textContent=WebInspector.UIString("COUNTERS"),this._counterUI=this._createCounterUIList()},WebInspector.MemoryStatistics.Counter=function(e){this.time=e},WebInspector.SwatchCheckbox=function(e,t){this.element=document.createElement("div"),this._swatch=this.element.createChild("div","swatch"),this.element.createChild("span","title").textContent=e,this._color=t,this.checked=!0,this.element.addEventListener("click",this._toggleCheckbox.bind(this),!0)},WebInspector.SwatchCheckbox.Events={Changed:"Changed"},WebInspector.SwatchCheckbox.prototype={get checked(){return this._checked},set checked(e){this._checked=e,this._checked?this._swatch.style.backgroundColor=this._color:this._swatch.style.backgroundColor=""},_toggleCheckbox:function(e){this.checked=!this.checked,this.dispatchEventToListeners(WebInspector.SwatchCheckbox.Events.Changed)},__proto__:WebInspector.Object.prototype},WebInspector.CounterUIBase=function(e,t,n,r){this._memoryCountersPane=e,this.valueGetter=r;var i=e._memorySidebarView.sidebarElement.createChild("div","memory-counter-sidebar-info"),s=n;this._swatch=new WebInspector.SwatchCheckbox(WebInspector.UIString(t),s),this._swatch.addEventListener(WebInspector.SwatchCheckbox.Events.Changed,this._toggleCounterGraph.bind(this)),i.appendChild(this._swatch.element),this._value=null,this.graphColor=n,this.strokeColor=n,this.graphYValues=[]},WebInspector.CounterUIBase.prototype={_toggleCounterGraph:function(e){this._swatch.checked?this._value.removeStyleClass("hidden"):this._value.addStyleClass("hidden"),this._memoryCountersPane.refresh()},updateCurrentValue:function(e){this._value.textContent=Number.bytesToString(this.valueGetter(e))},clearCurrentValueAndMarker:function(e){this._value.textContent=""},get visible(){return this._swatch.checked}},WebInspector.MemoryStatistics.prototype={_createCurrentValuesBar:function(){throw new Error("Not implemented")},_createCounterUIList:function(){throw new Error("Not implemented")},_onRecordsCleared:function(){this._counters=[]},setMainTimelineGrid:function(e){this._mainTimelineGrid=e},setTopPosition:function(e){this._memorySidebarView.element.style.top=e+"px",this._updateSize()},setSidebarWidth:function(e){if(this._ignoreSidebarResize)return;this._ignoreSidebarResize=!0,this._memorySidebarView.setSidebarWidth(e),this._ignoreSidebarResize=!1},_sidebarResized:function(e){if(this._ignoreSidebarResize)return;this._ignoreSidebarResize=!0,this._timelinePanel.splitView.setSidebarWidth(e.data),this._ignoreSidebarResize=!1},_canvasHeight:function(){throw new Error("Not implemented")},_updateSize:function(){var e=this._mainTimelineGrid.dividersElement.offsetWidth+1;this._canvasContainer.style.width=e+"px";var t=this._canvasHeight();this._canvas.width=e,this._canvas.height=t},_onRecordAdded:function(e){throw new Error("Not implemented")},_draw:function(){this._calculateVisibleIndexes(),this._calculateXValues(),this._clear(),this._setVerticalClip(10,this._canvas.height-20)},_calculateVisibleIndexes:function(){function r(e,t){return e-t.time}var e=this._timelinePanel.calculator,t=e.minimumBoundary()*1e3,n=e.maximumBoundary()*1e3;this._minimumIndex=Number.constrain(this._counters.upperBound(t,r)-1,0,this._counters.length-1),this._maximumIndex=Number.constrain(this._counters.lowerBound(n,r),0,this._counters.length-1),this._minTime=t,this._maxTime=n},_onClick:function(e){var t=e.x-e.target.offsetParent.offsetLeft,n=this._recordIndexAt(t),r=this._counters[n];r&&this._timelinePanel.revealRecordAt(r.time/1e3)},_onMouseOut:function(e){delete this._markerXPosition;var t=this._canvas.getContext("2d");this._clearCurrentValueAndMarker(t)},_clearCurrentValueAndMarker:function(e){for(var t=0;t<this._counterUI.length;t++)this._counterUI[t].clearCurrentValueAndMarker(e)},_onMouseOver:function(e){this._onMouseMove(e)},_onMouseMove:function(e){var t=e.x-e.target.offsetParent.offsetLeft;this._markerXPosition=t,this._refreshCurrentValues()},_refreshCurrentValues:function(){if(!this._counters.length)return;if(this._markerXPosition===undefined)return;if(this._maximumIndex===-1)return;var e=this._recordIndexAt(this._markerXPosition);this._updateCurrentValue(this._counters[e]),this._highlightCurrentPositionOnGraphs(this._markerXPosition,e)},_updateCurrentValue:function(e){for(var t=0;t<this._counterUI.length;t++)this._counterUI[t].updateCurrentValue(e)},_recordIndexAt:function(e){var t;for(t=this._minimumIndex+1;t<=this._maximumIndex;t++){var n=this._counters[t].x;if(e<n)break}return t--,t},_highlightCurrentPositionOnGraphs:function(e,t){var n=this._canvas.getContext("2d");this._restoreImageUnderMarker(n),this._drawMarker(n,e,t)},_restoreImageUnderMarker:function(e){throw new Error("Not implemented")},_drawMarker:function(e,t,n){throw new Error("Not implemented")},visible:function(){return this._memorySidebarView.isShowing()},show:function(){var e=this._containerAnchor.nextSibling,t=this._timelinePanel.splitView.sidebarWidth();this._memorySidebarView.show(this._timelinePanel.element,e),t>0&&(this.setSidebarWidth(t),this._timelinePanel.splitView.setSidebarWidth(t)),this._updateSize(),this._refreshDividers(),setTimeout(this._draw.bind(this),0)},refresh:function(){this._updateSize(),this._refreshDividers(),this._draw(),this._refreshCurrentValues()},hide:function(){this._memorySidebarView.detach()},_refreshDividers:function(){this._timelineGrid.updateDividers(this._timelinePanel.calculator)},_setVerticalClip:function(e,t){this._originY=e,this._clippedHeight=t},_calculateXValues:function(){if(!this._counters.length)return;var e=this._canvas.width,t=e/(this._maxTime-this._minTime);this._counters[this._minimumIndex].x=0;for(var n=this._minimumIndex+1;n<this._maximumIndex;n++)this._counters[n].x=t*(this._counters[n].time-this._minTime);this._counters[this._maximumIndex].x=e},_clear:function(){var e=this._canvas.getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),this._discardImageUnderMarker()},_discardImageUnderMarker:function(){throw new Error("Not implemented")}};