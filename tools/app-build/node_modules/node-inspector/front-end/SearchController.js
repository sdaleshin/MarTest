/*
 * Copyright (C) 2006, 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2007 Matt Lilek (pewtermoose@gmail.com).
 * Copyright (C) 2009 Joseph Pecoraro
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.SearchController=function(){this._element=document.createElement("table"),this._element.className="toolbar-search",this._element.cellSpacing=0,this._firstRowElement=this._element.createChild("tr"),this._secondRowElement=this._element.createChild("tr","hidden");var e=this._firstRowElement.createChild("td");this._searchControlElement=e.createChild("span","toolbar-search-control"),this._searchInputElement=this._searchControlElement.createChild("input","search-replace"),this._searchInputElement.id="search-input-field",this._matchesElement=this._searchControlElement.createChild("label","search-results-matches"),this._matchesElement.setAttribute("for","search-input-field"),this._searchNavigationElement=this._searchControlElement.createChild("div","toolbar-search-navigation-controls"),this._toggleFilterUI(!1),this._searchNavigationPrevElement=this._searchNavigationElement.createChild("div","toolbar-search-navigation toolbar-search-navigation-prev"),this._searchNavigationPrevElement.addEventListener("click",this._onPrevButtonSearch.bind(this),!1),this._searchNavigationPrevElement.title=WebInspector.UIString("Search Previous"),this._searchNavigationNextElement=this._searchNavigationElement.createChild("div","toolbar-search-navigation toolbar-search-navigation-next"),this._searchNavigationNextElement.addEventListener("click",this._onNextButtonSearch.bind(this),!1),this._searchNavigationNextElement.title=WebInspector.UIString("Search Next"),this._searchInputElement.addEventListener("mousedown",this._onSearchFieldManualFocus.bind(this),!1),this._searchInputElement.addEventListener("keydown",this._onKeyDown.bind(this),!0),this._searchInputElement.addEventListener("input",this._onInput.bind(this),!1),this._replaceInputElement=this._secondRowElement.createChild("td").createChild("input","search-replace toolbar-replace-control"),this._replaceInputElement.addEventListener("keydown",this._onKeyDown.bind(this),!0),this._replaceInputElement.placeholder=WebInspector.UIString("Replace"),this._findButtonElement=this._firstRowElement.createChild("td").createChild("button","hidden"),this._findButtonElement.textContent=WebInspector.UIString("Find"),this._findButtonElement.tabIndex=-1,this._findButtonElement.addEventListener("click",this._onNextButtonSearch.bind(this),!1),this._replaceButtonElement=this._secondRowElement.createChild("td").createChild("button"),this._replaceButtonElement.textContent=WebInspector.UIString("Replace"),this._replaceButtonElement.disabled=!0,this._replaceButtonElement.tabIndex=-1,this._replaceButtonElement.addEventListener("click",this._replace.bind(this),!1),this._prevButtonElement=this._firstRowElement.createChild("td").createChild("button","hidden"),this._prevButtonElement.textContent=WebInspector.UIString("Previous"),this._prevButtonElement.disabled=!0,this._prevButtonElement.tabIndex=-1,this._prevButtonElement.addEventListener("click",this._onPrevButtonSearch.bind(this),!1),this._replaceAllButtonElement=this._secondRowElement.createChild("td").createChild("button"),this._replaceAllButtonElement.textContent=WebInspector.UIString("Replace All"),this._replaceAllButtonElement.addEventListener("click",this._replaceAll.bind(this),!1),this._replaceElement=this._firstRowElement.createChild("td").createChild("span"),this._replaceCheckboxElement=this._replaceElement.createChild("input"),this._replaceCheckboxElement.type="checkbox",this._replaceCheckboxElement.id="search-replace-trigger",this._replaceCheckboxElement.addEventListener("click",this._updateSecondRowVisibility.bind(this),!1),this._replaceLabelElement=this._replaceElement.createChild("label"),this._replaceLabelElement.textContent=WebInspector.UIString("Replace"),this._replaceLabelElement.setAttribute("for","search-replace-trigger"),this._filterCheckboxContainer=this._firstRowElement.createChild("td").createChild("label"),this._filterCheckboxContainer.setAttribute("for","filter-trigger"),this._filterCheckboxElement=this._filterCheckboxContainer.createChild("input"),this._filterCheckboxElement.type="checkbox",this._filterCheckboxElement.id="filter-trigger",this._filterCheckboxElement.addEventListener("click",this._filterCheckboxClick.bind(this),!1),this._filterCheckboxContainer.createTextChild(WebInspector.UIString("Filter"));var t=this._firstRowElement.createChild("td").createChild("button");t.textContent=WebInspector.UIString("Cancel"),t.tabIndex=-1,t.addEventListener("click",this.closeSearch.bind(this),!1)},WebInspector.SearchController.prototype={updateSearchMatchesCount:function(e,t){t.currentSearchMatches=e,t===this._searchProvider&&this._updateSearchMatchesCountAndCurrentMatchIndex(t.currentQuery?e:0,-1)},updateCurrentMatchIndex:function(e,t){t===this._searchProvider&&this._updateSearchMatchesCountAndCurrentMatchIndex(t.currentSearchMatches,e)},isSearchVisible:function(){return this._searchIsVisible},closeSearch:function(){this.cancelSearch(),WebInspector.setCurrentFocusElement(WebInspector.previousFocusElement())},cancelSearch:function(){if(!this._searchIsVisible)return;this._filterCheckboxElement.checked?(this._filterCheckboxElement.checked=!1,this._toggleFilterUI(!1),this.resetFilter()):this.resetSearch(),delete this._searchIsVisible,this._searchHost.setFooterElement(null),this.resetSearch(),delete this._searchHost,delete this._searchProvider},resetSearch:function(){this._clearSearch(),this._updateReplaceVisibility(),this._matchesElement.textContent=""},handleShortcut:function(e){var t=WebInspector.isMac();switch(e.keyIdentifier){case"U+0046":if(t)var n=e.metaKey&&!e.ctrlKey&&!e.altKey&&!e.shiftKey;else var n=e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey;if(n)return this.showSearchField(),e.consume(!0),!0;break;case"F3":if(!t)return this.showSearchField(),e.consume(!0),!0;break;case"U+0047":if(t&&e.metaKey&&!e.ctrlKey&&!e.altKey&&this._searchHost)return e.shiftKey?this._searchProvider.jumpToPreviousSearchResult():this._searchProvider.jumpToNextSearchResult(),e.consume(!0),!0}return!1},_updateSearchNavigationButtonState:function(e){this._replaceButtonElement.disabled=!e,this._prevButtonElement.disabled=!e,e?(this._searchNavigationPrevElement.addStyleClass("enabled"),this._searchNavigationNextElement.addStyleClass("enabled")):(this._searchNavigationPrevElement.removeStyleClass("enabled"),this._searchNavigationNextElement.removeStyleClass("enabled"))},_updateSearchMatchesCountAndCurrentMatchIndex:function(e,t){this._currentQuery?e===0||t>=0?this._matchesElement.textContent=WebInspector.UIString("%d of %d",t+1,e):e===1?this._matchesElement.textContent=WebInspector.UIString("1 match"):this._matchesElement.textContent=WebInspector.UIString("%d matches",e):this._matchesElement.textContent="",this._updateSearchNavigationButtonState(e>0)},showSearchField:function(){this._searchIsVisible&&this.cancelSearch(),WebInspector.drawer.element.isAncestor(document.activeElement)&&WebInspector.drawer.getSearchProvider()?this._searchHost=WebInspector.drawer:this._searchHost=WebInspector.inspectorView,this._searchProvider=this._searchHost.getSearchProvider(),this._searchHost.setFooterElement(this._element),this._updateReplaceVisibility(),this._updateFilterVisibility();if(WebInspector.currentFocusElement()!==this._searchInputElement){var e=window.getSelection();if(e.rangeCount){var t=e.toString().replace(/\r?\n.*/,"");t&&(this._searchInputElement.value=t)}}this._performSearch(!1,!1),this._searchInputElement.focus(),this._searchInputElement.select(),this._searchIsVisible=!0},_toggleFilterUI:function(e){this._matchesElement.enableStyleClass("hidden",e),this._searchNavigationElement.enableStyleClass("hidden",e),this._searchInputElement.placeholder=e?WebInspector.UIString("Filter"):WebInspector.UIString("Find")},_updateFilterVisibility:function(){this._searchProvider.canFilter()?this._filterCheckboxContainer.removeStyleClass("hidden"):this._filterCheckboxContainer.addStyleClass("hidden")},_updateReplaceVisibility:function(){if(!this._searchProvider)return;this._searchProvider.canSearchAndReplace()?this._replaceElement.removeStyleClass("hidden"):(this._replaceElement.addStyleClass("hidden"),this._replaceCheckboxElement.checked=!1,this._updateSecondRowVisibility())},_onSearchFieldManualFocus:function(e){WebInspector.setCurrentFocusElement(e.target)},_onKeyDown:function(e){isEnterKey(e)&&(e.target===this._searchInputElement?this._currentQuery?this._jumpToNextSearchResult(e.shiftKey):this._performSearch(!0,!0):e.target===this._replaceInputElement&&this._replace())},_jumpToNextSearchResult:function(e){if(!this._currentQuery||!this._searchNavigationPrevElement.hasStyleClass("enabled"))return;e?this._searchProvider.jumpToPreviousSearchResult():this._searchProvider.jumpToNextSearchResult()},_onNextButtonSearch:function(e){if(!this._searchNavigationNextElement.hasStyleClass("enabled"))return;this._jumpToNextSearchResult(),this._searchInputElement.focus()},_onPrevButtonSearch:function(e){if(!this._searchNavigationPrevElement.hasStyleClass("enabled"))return;this._jumpToNextSearchResult(!0),this._searchInputElement.focus()},_clearSearch:function(){delete this._currentQuery;if(this._searchHost){var e=this._searchHost.getSearchProvider();e&&!!e.currentQuery&&(delete e.currentQuery,e.searchCanceled())}this._updateSearchMatchesCountAndCurrentMatchIndex(0,-1)},_performSearch:function(e,t){var n=this._searchInputElement.value,r=this._searchProvider.minimalSearchQuerySize();if(!n||!this._searchProvider||!e&&n.length<r&&!this._currentQuery){this._clearSearch();return}this._currentQuery=n,this._searchProvider.currentQuery=n,this._searchProvider.performSearch(n,t)},_updateSecondRowVisibility:function(){if(!this._searchIsVisible||!this._searchHost)return;this._replaceCheckboxElement.checked?(this._element.addStyleClass("toolbar-search-replace"),this._secondRowElement.removeStyleClass("hidden"),this._prevButtonElement.removeStyleClass("hidden"),this._findButtonElement.removeStyleClass("hidden"),this._replaceCheckboxElement.tabIndex=-1,this._replaceInputElement.focus()):(this._element.removeStyleClass("toolbar-search-replace"),this._secondRowElement.addStyleClass("hidden"),this._prevButtonElement.addStyleClass("hidden"),this._findButtonElement.addStyleClass("hidden"),this._replaceCheckboxElement.tabIndex=0,this._searchInputElement.focus()),this._searchHost.setFooterElement(this._element)},_replace:function(){this._searchProvider.replaceSelectionWith(this._replaceInputElement.value),delete this._currentQuery,this._performSearch(!0,!0)},_replaceAll:function(){this._searchProvider.replaceAllWith(this._searchInputElement.value,this._replaceInputElement.value)},_filterCheckboxClick:function(){this._searchInputElement.focus(),this._searchInputElement.select(),this._filterCheckboxElement.checked?(this._toggleFilterUI(!0),this.resetSearch(),this._performFilter(this._searchInputElement.value)):(this._toggleFilterUI(!1),this.resetFilter(),this._performSearch(!1,!1))},_performFilter:function(e){this._searchProvider.performFilter(e)},_onInput:function(e){this._filterCheckboxElement.checked?this._performFilter(e.target.value):this._performSearch(!1,!0)},resetFilter:function(){this._performFilter("")}},WebInspector.searchController=null,WebInspector.Searchable=function(){},WebInspector.Searchable.prototype={canSearchAndReplace:function(){},canFilter:function(){},searchCanceled:function(){},performSearch:function(e,t,n){},minimalSearchQuerySize:function(){},jumpToNextSearchResult:function(e){},jumpToPreviousSearchResult:function(e){}};