/*
 * Copyright (C) 2012 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.FileSystemMapping=function(){WebInspector.Object.call(this),this._fileSystemMappingSetting=WebInspector.settings.createSetting("fileSystemMapping",{}),this._excludedFoldersSetting=WebInspector.settings.createSetting("workspaceExcludedFolders",{});var e=["/\\.git/","/\\.sass-cache/","/\\.hg/","/\\.idea/","/\\.svn/","/\\.cache/","/\\.project/"],t=["/Thumbs.db$","/ehthumbs.db$","/Desktop.ini$","/\\$RECYCLE.BIN/"],n=["/\\.DS_Store$","/\\.Trashes$","/\\.Spotlight-V100$","/\\.AppleDouble$","/\\.LSOverride$","/Icon$","/\\._.*$"],r=["/.*~$"],i=e;WebInspector.isWin()?i=i.concat(t):WebInspector.isMac()?i=i.concat(n):i=i.concat(r);var s=i.join("|");WebInspector.settings.workspaceFolderExcludePattern=WebInspector.settings.createSetting("workspaceFolderExcludePattern",s),this._fileSystemMappings={},this._excludedFolders={},this._loadFromSettings()},WebInspector.FileSystemMapping.Events={FileMappingAdded:"FileMappingAdded",FileMappingRemoved:"FileMappingRemoved",ExcludedFolderAdded:"ExcludedFolderAdded",ExcludedFolderRemoved:"ExcludedFolderRemoved"},WebInspector.FileSystemMapping.prototype={_loadFromSettings:function(){var e=this._fileSystemMappingSetting.get();this._fileSystemMappings={};for(var t in e){var n=e[t];this._fileSystemMappings[t]=[];var r=this._fileSystemMappings[t];for(var i=0;i<n.length;++i){var s=n[i],o=new WebInspector.FileSystemMapping.Entry(s.fileSystemPath,s.urlPrefix,s.pathPrefix);r.push(o)}}var u=this._excludedFoldersSetting.get();this._excludedFolders={};for(var t in u){var a=u[t];this._excludedFolders[t]=[];var f=this._excludedFolders[t];for(var i=0;i<a.length;++i){var s=a[i],o=new WebInspector.FileSystemMapping.ExcludedFolderEntry(s.fileSystemPath,s.path);f.push(o)}}var l=WebInspector.settings.workspaceFolderExcludePattern.get();try{var c=WebInspector.isWin()?"i":"";this._workspaceFolderExcludeRegex=l?new RegExp(l,c):null}catch(h){}this._rebuildIndexes()},_saveToSettings:function(){var e=this._fileSystemMappings;this._fileSystemMappingSetting.set(e);var t=this._excludedFolders;this._excludedFoldersSetting.set(t),this._rebuildIndexes()},_rebuildIndexes:function(){this._mappingForURLPrefix={},this._urlPrefixes=[];for(var e in this._fileSystemMappings){var t=this._fileSystemMappings[e];for(var n=0;n<t.length;++n){var r=t[n];this._mappingForURLPrefix[r.urlPrefix]=r,this._urlPrefixes.push(r.urlPrefix)}}this._urlPrefixes.sort()},addFileSystem:function(e){if(this._fileSystemMappings[e])return;this._fileSystemMappings[e]=[],this._saveToSettings()},removeFileSystem:function(e){if(!this._fileSystemMappings[e])return;delete this._fileSystemMappings[e],delete this._excludedFolders[e],this._saveToSettings()},addFileMapping:function(e,t,n){var r=new WebInspector.FileSystemMapping.Entry(e,t,n);this._fileSystemMappings[e].push(r),this._saveToSettings(),this.dispatchEventToListeners(WebInspector.FileSystemMapping.Events.FileMappingAdded,r)},removeFileMapping:function(e,t,n){var r=this._mappingEntryForPathPrefix(e,n);if(!r)return;this._fileSystemMappings[e].remove(r),this._saveToSettings(),this.dispatchEventToListeners(WebInspector.FileSystemMapping.Events.FileMappingRemoved,r)},addExcludedFolder:function(e,t){this._excludedFolders[e]||(this._excludedFolders[e]=[]);var n=new WebInspector.FileSystemMapping.ExcludedFolderEntry(e,t);this._excludedFolders[e].push(n),this._saveToSettings(),this.dispatchEventToListeners(WebInspector.FileSystemMapping.Events.ExcludedFolderAdded,n)},removeExcludedFolder:function(e,t){var n=this._excludedFolderEntryForPath(e,t);if(!n)return;this._excludedFolders[e].remove(n),this._saveToSettings(),this.dispatchEventToListeners(WebInspector.FileSystemMapping.Events.ExcludedFolderRemoved,n)},fileSystemPaths:function(){return Object.keys(this._fileSystemMappings)},_mappingEntryForURL:function(e){for(var t=this._urlPrefixes.length-1;t>=0;--t){var n=this._urlPrefixes[t];if(e.startsWith(n))return this._mappingForURLPrefix[n]}return null},_excludedFolderEntryForPath:function(e,t){var n=this._excludedFolders[e];if(!n)return null;for(var r=0;r<n.length;++r)if(n[r].path===t)return n[r];return null},_mappingEntryForPath:function(e,t){var n=this._fileSystemMappings[e];if(!n)return null;var r=null;for(var i=0;i<n.length;++i){var s=n[i].pathPrefix;if(r&&r.pathPrefix.length>s.length)continue;t.startsWith(s.substr(1))&&(r=n[i])}return r},_mappingEntryForPathPrefix:function(e,t){var n=this._fileSystemMappings[e];for(var r=0;r<n.length;++r)if(t===n[r].pathPrefix)return n[r];return null},isFileExcluded:function(e,t){var n=this._excludedFolders[e]||[];for(var r=0;r<n.length;++r){var i=n[r];if(i.path===t)return!0}return this._workspaceFolderExcludeRegex&&this._workspaceFolderExcludeRegex.test(t)},excludedFolders:function(e){var t=this._excludedFolders[e];return t?t.slice():[]},mappingEntries:function(e){return this._fileSystemMappings[e].slice()},hasMappingForURL:function(e){return!!this._mappingEntryForURL(e)},fileForURL:function(e){var t=this._mappingEntryForURL(e);if(!t)return null;var n={};return n.fileSystemPath=t.fileSystemPath,n.filePath=t.pathPrefix.substr(1)+e.substr(t.urlPrefix.length),n},urlForPath:function(e,t){var n=this._mappingEntryForPath(e,t);return n?n.urlPrefix+t.substring(n.pathPrefix.length-1):""},removeMappingForURL:function(e){var t=this._mappingEntryForURL(e);if(!t)return;this._fileSystemMappings[t.fileSystemPath].remove(t),this._saveToSettings()},addMappingForResource:function(e,t,n){var r=0,i="/"+n;for(var s=0;s<i.length;++s){var o=i[i.length-1-s],u=e[e.length-1-s];if(o!==u)break;o==="/"&&(r=s)}var a=i.substr(0,i.length-r),f=e.substr(0,e.length-r);this.addFileMapping(t,f,a)},__proto__:WebInspector.Object.prototype},WebInspector.FileSystemMapping.Entry=function(e,t,n){this.fileSystemPath=e,this.urlPrefix=t,this.pathPrefix=n},WebInspector.FileSystemMapping.ExcludedFolderEntry=function(e,t){this.fileSystemPath=e,this.path=t};