/*
 * Copyright (C) 2010 Apple Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS''
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 * THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ApplicationCacheItemsView=function(e,t){WebInspector.View.call(this),this._model=e,this.element.addStyleClass("storage-view"),this.element.addStyleClass("table"),this.deleteButton=new WebInspector.StatusBarButton(WebInspector.UIString("Delete"),"delete-storage-status-bar-item"),this.deleteButton.visible=!1,this.deleteButton.addEventListener("click",this._deleteButtonClicked,this),this.connectivityIcon=document.createElement("div"),this.connectivityMessage=document.createElement("span"),this.connectivityMessage.className="storage-application-cache-connectivity",this.connectivityMessage.textContent="",this.divider=document.createElement("span"),this.divider.className="status-bar-item status-bar-divider",this.statusIcon=document.createElement("div"),this.statusMessage=document.createElement("span"),this.statusMessage.className="storage-application-cache-status",this.statusMessage.textContent="",this._frameId=t,this._emptyView=new WebInspector.EmptyView(WebInspector.UIString("No Application Cache information available.")),this._emptyView.show(this.element),this._markDirty();var n=this._model.frameManifestStatus(t);this.updateStatus(n),this.updateNetworkState(this._model.onLine),this.deleteButton.element.style.display="none"},WebInspector.ApplicationCacheItemsView.prototype={get statusBarItems(){return[this.deleteButton.element,this.connectivityIcon,this.connectivityMessage,this.divider,this.statusIcon,this.statusMessage]},wasShown:function(){this._maybeUpdate()},willHide:function(){this.deleteButton.visible=!1},_maybeUpdate:function(){if(!this.isShowing()||!this._viewDirty)return;this._update(),this._viewDirty=!1},_markDirty:function(){this._viewDirty=!0},updateStatus:function(e){var t=this._status;this._status=e;var n={};n[applicationCache.UNCACHED]={className:"red-ball",text:"UNCACHED"},n[applicationCache.IDLE]={className:"green-ball",text:"IDLE"},n[applicationCache.CHECKING]={className:"orange-ball",text:"CHECKING"},n[applicationCache.DOWNLOADING]={className:"orange-ball",text:"DOWNLOADING"},n[applicationCache.UPDATEREADY]={className:"green-ball",text:"UPDATEREADY"},n[applicationCache.OBSOLETE]={className:"red-ball",text:"OBSOLETE"};var r=n[e]||n[applicationCache.UNCACHED];this.statusIcon.className="storage-application-cache-status-icon "+r.className,this.statusMessage.textContent=r.text,this.isShowing()&&this._status===applicationCache.IDLE&&(t===applicationCache.UPDATEREADY||!this._resources)&&this._markDirty(),this._maybeUpdate()},updateNetworkState:function(e){e?(this.connectivityIcon.className="storage-application-cache-connectivity-icon green-ball",this.connectivityMessage.textContent=WebInspector.UIString("Online")):(this.connectivityIcon.className="storage-application-cache-connectivity-icon red-ball",this.connectivityMessage.textContent=WebInspector.UIString("Offline"))},_update:function(){this._model.requestApplicationCache(this._frameId,this._updateCallback.bind(this))},_updateCallback:function(e){if(!e||!e.manifestURL){delete this._manifest,delete this._creationTime,delete this._updateTime,delete this._size,delete this._resources,this._emptyView.show(this.element),this.deleteButton.visible=!1,this._dataGrid&&this._dataGrid.element.addStyleClass("hidden");return}this._manifest=e.manifestURL,this._creationTime=e.creationTime,this._updateTime=e.updateTime,this._size=e.size,this._resources=e.resources,this._dataGrid||this._createDataGrid(),this._populateDataGrid(),this._dataGrid.autoSizeColumns(20,80),this._dataGrid.element.removeStyleClass("hidden"),this._emptyView.detach(),this.deleteButton.visible=!0},_createDataGrid:function(){var e=[{title:WebInspector.UIString("Resource"),sort:WebInspector.DataGrid.Order.Ascending,sortable:!0},{title:WebInspector.UIString("Type"),sortable:!0},{title:WebInspector.UIString("Size"),align:WebInspector.DataGrid.Align.Right,sortable:!0}];this._dataGrid=new WebInspector.DataGrid(e),this._dataGrid.show(this.element),this._dataGrid.addEventListener(WebInspector.DataGrid.Events.SortingChanged,this._populateDataGrid,this)},_populateDataGrid:function(){function n(e,n,r){return t*(n[e]-r[e])}function r(e,n,r){return t*(n[e]+"").localeCompare(r[e]+"")}var e=this._dataGrid.selectedNode?this._dataGrid.selectedNode.resource:null,t=this._dataGrid.isSortOrderAscending()?1:-1,i;switch(parseInt(this._dataGrid.sortColumnIdentifier(),10)){case 0:i=r.bind(this,"name");break;case 1:i=r.bind(this,"type");break;case 2:i=n.bind(this,"size");break;default:r.bind(this,"resource")}this._resources.sort(i),this._dataGrid.rootNode().removeChildren();var s;for(var o=0;o<this._resources.length;++o){var u={},a=this._resources[o];u[0]=a.url,u[1]=a.type,u[2]=Number.bytesToString(a.size);var f=new WebInspector.DataGridNode(u);f.resource=a,f.selectable=!0,this._dataGrid.rootNode().appendChild(f),a===e&&(s=f,s.selected=!0)}!s&&this._dataGrid.rootNode().children.length&&(this._dataGrid.rootNode().children[0].selected=!0)},_deleteButtonClicked:function(e){if(!this._dataGrid||!this._dataGrid.selectedNode)return;this._deleteCallback(this._dataGrid.selectedNode)},_deleteCallback:function(e){},__proto__:WebInspector.View.prototype};