/*
 * Copyright (C) 2007, 2008, 2010 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 * Copyright (C) 2013 Samsung Electronics. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

importScript("ApplicationCacheItemsView.js"),importScript("DOMStorageItemsView.js"),importScript("DatabaseQueryView.js"),importScript("DatabaseTableView.js"),importScript("DirectoryContentView.js"),importScript("IndexedDBViews.js"),importScript("FileContentView.js"),importScript("FileSystemView.js"),WebInspector.ResourcesPanel=function(e){function t(){return this.visibleView}WebInspector.Panel.call(this,"resources"),this.registerRequiredCSS("resourcesPanel.css"),WebInspector.settings.resourcesLastSelectedItem=WebInspector.settings.createSetting("resourcesLastSelectedItem",{}),this.createSidebarViewWithTree(),this.sidebarElement.addStyleClass("outline-disclosure"),this.sidebarElement.addStyleClass("filter-all"),this.sidebarElement.addStyleClass("children"),this.sidebarElement.addStyleClass("small"),this.sidebarTreeElement.removeStyleClass("sidebar-tree"),this.resourcesListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Frames"),"Frames",["frame-storage-tree-item"]),this.sidebarTree.appendChild(this.resourcesListTreeElement),this.databasesListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Web SQL"),"Databases",["database-storage-tree-item"]),this.sidebarTree.appendChild(this.databasesListTreeElement),this.indexedDBListTreeElement=new WebInspector.IndexedDBTreeElement(this),this.sidebarTree.appendChild(this.indexedDBListTreeElement),this.localStorageListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Local Storage"),"LocalStorage",["domstorage-storage-tree-item","local-storage"]),this.sidebarTree.appendChild(this.localStorageListTreeElement),this.sessionStorageListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Session Storage"),"SessionStorage",["domstorage-storage-tree-item","session-storage"]),this.sidebarTree.appendChild(this.sessionStorageListTreeElement),this.cookieListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Cookies"),"Cookies",["cookie-storage-tree-item"]),this.sidebarTree.appendChild(this.cookieListTreeElement),this.applicationCacheListTreeElement=new WebInspector.StorageCategoryTreeElement(this,WebInspector.UIString("Application Cache"),"ApplicationCache",["application-cache-storage-tree-item"]),this.sidebarTree.appendChild(this.applicationCacheListTreeElement),WebInspector.experimentsSettings.fileSystemInspection.isEnabled()&&(this.fileSystemListTreeElement=new WebInspector.FileSystemListTreeElement(this),this.sidebarTree.appendChild(this.fileSystemListTreeElement)),this.storageViews=this.splitView.mainElement,this.storageViews.addStyleClass("diff-container"),this.storageViewStatusBarItemsContainer=document.createElement("div"),this.storageViewStatusBarItemsContainer.className="status-bar-items",this._databaseTableViews=new Map,this._databaseQueryViews=new Map,this._databaseTreeElements=new Map,this._domStorageViews=new Map,this._domStorageTreeElements=new Map,this._cookieViews={},this._domains={},this.sidebarElement.addEventListener("mousemove",this._onmousemove.bind(this),!1),this.sidebarElement.addEventListener("mouseout",this._onmouseout.bind(this),!1),WebInspector.GoToLineDialog.install(this,t.bind(this)),WebInspector.resourceTreeModel.cachedResourcesLoaded()&&this._cachedResourcesLoaded(),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.Load,this._loadEventFired,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.CachedResourcesLoaded,this._cachedResourcesLoaded,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.WillLoadCachedResources,this._resetWithFrames,this),WebInspector.databaseModel.databases().forEach(this._addDatabase.bind(this)),WebInspector.databaseModel.addEventListener(WebInspector.DatabaseModel.Events.DatabaseAdded,this._databaseAdded,this)},WebInspector.ResourcesPanel.prototype={get statusBarItems(){return[this.storageViewStatusBarItemsContainer]},wasShown:function(){WebInspector.Panel.prototype.wasShown.call(this),this._initialize()},_initialize:function(){!this._initialized&&this.isShowing()&&this._cachedResourcesWereLoaded&&(this._populateResourceTree(),this._populateDOMStorageTree(),this._populateApplicationCacheTree(),this._initDefaultSelection(),this._initialized=!0)},_loadEventFired:function(){this._initDefaultSelection()},_initDefaultSelection:function(){if(!this._initialized)return;var e=WebInspector.settings.resourcesLastSelectedItem.get();if(e)for(var t=this.sidebarTree.children[0];t;t=t.traverseNextTreeElement(!1,this.sidebarTree,!0))if(t.itemURL===e){t.revealAndSelect(!0);return}var n=WebInspector.inspectedPageURL&&this.resourcesListTreeElement&&this.resourcesListTreeElement.expanded&&WebInspector.resourceTreeModel.resourceForURL(WebInspector.inspectedPageURL);n&&this.showResource(n)},_resetWithFrames:function(){this.resourcesListTreeElement.removeChildren(),this._treeElementForFrameId={},this._reset()},_reset:function(){this._domains={};var e=this._databaseQueryViews.values();for(var t=0;t<e.length;++t)e[t].removeEventListener(WebInspector.DatabaseQueryView.Events.SchemaUpdated,this._updateDatabaseTables,this);this._databaseTableViews.clear(),this._databaseQueryViews.clear(),this._databaseTreeElements.clear(),this._domStorageViews.clear(),this._domStorageTreeElements.clear(),this._cookieViews={},this.databasesListTreeElement.removeChildren(),this.localStorageListTreeElement.removeChildren(),this.sessionStorageListTreeElement.removeChildren(),this.cookieListTreeElement.removeChildren(),this.visibleView&&!(this.visibleView instanceof WebInspector.StorageCategoryView)&&this.visibleView.detach(),this.storageViewStatusBarItemsContainer.removeChildren(),this.sidebarTree.selectedTreeElement&&this.sidebarTree.selectedTreeElement.deselect()},_populateResourceTree:function(){function e(t){this._frameAdded({data:t});for(var n=0;n<t.childFrames.length;++n)e.call(this,t.childFrames[n]);var r=t.resources();for(var n=0;n<r.length;++n)this._resourceAdded({data:r[n]})}this._treeElementForFrameId={},WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameAdded,this._frameAdded,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameNavigated,this._frameNavigated,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.FrameDetached,this._frameDetached,this),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.ResourceAdded,this._resourceAdded,this),e.call(this,WebInspector.resourceTreeModel.mainFrame)},_frameAdded:function(e){var t=e.data,n=t.parentFrame,r=n?this._treeElementForFrameId[n.id]:this.resourcesListTreeElement;if(!r){console.warn("No frame to route "+t.url+" to.");return}var i=new WebInspector.FrameTreeElement(this,t);this._treeElementForFrameId[t.id]=i,r.appendChild(i)},_frameDetached:function(e){var t=e.data,n=this._treeElementForFrameId[t.id];if(!n)return;delete this._treeElementForFrameId[t.id],n.parent&&n.parent.removeChild(n)},_resourceAdded:function(e){var t=e.data,n=t.frameId;if(t.statusCode>=301&&t.statusCode<=303)return;var r=this._treeElementForFrameId[n];if(!r)return;r.appendResource(t)},_frameNavigated:function(e){var t=e.data;t.parentFrame||this._reset();var n=t.id,r=this._treeElementForFrameId[n];r&&r.frameNavigated(t);var i=this._applicationCacheFrameElements[n];i&&i.frameNavigated(t)},_cachedResourcesLoaded:function(){this._cachedResourcesWereLoaded=!0,this._initialize()},_databaseAdded:function(e){var t=e.data;this._addDatabase(t)},_addDatabase:function(e){var t=new WebInspector.DatabaseTreeElement(this,e);this._databaseTreeElements.put(e,t),this.databasesListTreeElement.appendChild(t)},addDocumentURL:function(e){var t=e.asParsedURL();if(!t)return;var n=t.host;if(!this._domains[n]){this._domains[n]=!0;var r=new WebInspector.CookieTreeElement(this,n);this.cookieListTreeElement.appendChild(r)}},_domStorageAdded:function(e){var t=e.data;this._addDOMStorage(t)},_addDOMStorage:function(e){console.assert(!this._domStorageTreeElements.get(e));var t=new WebInspector.DOMStorageTreeElement(this,e,e.isLocalStorage?"local-storage":"session-storage");this._domStorageTreeElements.put(e,t),e.isLocalStorage?this.localStorageListTreeElement.appendChild(t):this.sessionStorageListTreeElement.appendChild(t)},_domStorageRemoved:function(e){var t=e.data;this._removeDOMStorage(t)},_removeDOMStorage:function(e){var t=this._domStorageTreeElements.get(e);if(!t)return;var n=t.selected,r=t.parent;r.removeChild(t),n&&r.select(),this._domStorageTreeElements.remove(t),this._domStorageViews.remove(e)},selectDatabase:function(e){e&&(this._showDatabase(e),this._databaseTreeElements.get(e).select())},selectDOMStorage:function(e){e&&(this._showDOMStorage(e),this._domStorageTreeElements.get(e).select())},canShowAnchorLocation:function(e){return!!WebInspector.resourceForURL(e.href)},showAnchorLocation:function(e){var t=WebInspector.resourceForURL(e.href);this.showResource(t,e.lineNumber)},showResource:function(e,t,n){var r=this._findTreeElementForResource(e);r&&r.revealAndSelect(!0);if(typeof t=="number"){var i=this._resourceViewForResource(e);i.canHighlightPosition()&&i.highlightPosition(t,n)}return!0},_showResourceView:function(e){var t=this._resourceViewForResource(e);if(!t){this.visibleView.detach();return}t.searchCanceled&&t.searchCanceled(),this._innerShowView(t)},_resourceViewForResource:function(e){if(WebInspector.ResourceView.hasTextContent(e)){var t=this._findTreeElementForResource(e);return t?t.sourceView():null}return WebInspector.ResourceView.nonSourceViewForResource(e)},_showDatabase:function(e,t){if(!e)return;var n;if(t){var r=this._databaseTableViews.get(e);r||(r={},this._databaseTableViews.put(e,r)),n=r[t],n||(n=new WebInspector.DatabaseTableView(e,t),r[t]=n)}else n=this._databaseQueryViews.get(e),n||(n=new WebInspector.DatabaseQueryView(e),this._databaseQueryViews.put(e,n),n.addEventListener(WebInspector.DatabaseQueryView.Events.SchemaUpdated,this._updateDatabaseTables,this));this._innerShowView(n)},showIndexedDB:function(e){this._innerShowView(e)},_showDOMStorage:function(e){if(!e)return;var t;t=this._domStorageViews.get(e),t||(t=new WebInspector.DOMStorageItemsView(e),this._domStorageViews.put(e,t)),this._innerShowView(t)},showCookies:function(e,t){var n=this._cookieViews[t];n||(n=new WebInspector.CookieItemsView(e,t),this._cookieViews[t]=n),this._innerShowView(n)},clearCookies:function(e){this._cookieViews[e].clear()},showApplicationCache:function(e){this._applicationCacheViews[e]||(this._applicationCacheViews[e]=new WebInspector.ApplicationCacheItemsView(this._applicationCacheModel,e)),this._innerShowView(this._applicationCacheViews[e])},showFileSystem:function(e){this._innerShowView(e)},showCategoryView:function(e){this._categoryView||(this._categoryView=new WebInspector.StorageCategoryView),this._categoryView.setText(e),this._innerShowView(this._categoryView)},_innerShowView:function(e){if(this.visibleView===e)return;this.visibleView&&this.visibleView.detach(),e.show(this.storageViews),this.visibleView=e,this.storageViewStatusBarItemsContainer.removeChildren();var t=e.statusBarItems||[];for(var n=0;n<t.length;++n)this.storageViewStatusBarItemsContainer.appendChild(t[n])},closeVisibleView:function(){if(!this.visibleView)return;this.visibleView.detach(),delete this.visibleView},_updateDatabaseTables:function(e){function o(e){var t=e.length;for(var n=0;n<t;++n)i[e[n]]=!0;for(var o in r)o in i||(s.visibleView===r[o]&&s.closeVisibleView(),delete r[o])}var t=e.data;if(!t)return;var n=this._databaseTreeElements.get(t);if(!n)return;n.shouldRefreshChildren=!0;var r=this._databaseTableViews.get(t);if(!r)return;var i={},s=this;t.getTableNames(o)},_populateDOMStorageTree:function(){WebInspector.domStorageModel.storages().forEach(this._addDOMStorage.bind(this)),WebInspector.domStorageModel.addEventListener(WebInspector.DOMStorageModel.Events.DOMStorageAdded,this._domStorageAdded,this),WebInspector.domStorageModel.addEventListener(WebInspector.DOMStorageModel.Events.DOMStorageRemoved,this._domStorageRemoved,this)},_populateApplicationCacheTree:function(){this._applicationCacheModel=new WebInspector.ApplicationCacheModel,this._applicationCacheViews={},this._applicationCacheFrameElements={},this._applicationCacheManifestElements={},this._applicationCacheModel.addEventListener(WebInspector.ApplicationCacheModel.EventTypes.FrameManifestAdded,this._applicationCacheFrameManifestAdded,this),this._applicationCacheModel.addEventListener(WebInspector.ApplicationCacheModel.EventTypes.FrameManifestRemoved,this._applicationCacheFrameManifestRemoved,this),this._applicationCacheModel.addEventListener(WebInspector.ApplicationCacheModel.EventTypes.FrameManifestStatusUpdated,this._applicationCacheFrameManifestStatusChanged,this),this._applicationCacheModel.addEventListener(WebInspector.ApplicationCacheModel.EventTypes.NetworkStateChanged,this._applicationCacheNetworkStateChanged,this)},_applicationCacheFrameManifestAdded:function(e){var t=e.data,n=this._applicationCacheModel.frameManifestURL(t),r=this._applicationCacheModel.frameManifestStatus(t),i=this._applicationCacheManifestElements[n];i||(i=new WebInspector.ApplicationCacheManifestTreeElement(this,n),this.applicationCacheListTreeElement.appendChild(i),this._applicationCacheManifestElements[n]=i);var s=new WebInspector.ApplicationCacheFrameTreeElement(this,t,n);i.appendChild(s),i.expand(),this._applicationCacheFrameElements[t]=s},_applicationCacheFrameManifestRemoved:function(e){var t=e.data,n=this._applicationCacheFrameElements[t];if(!n)return;var r=n.manifestURL;delete this._applicationCacheFrameElements[t],delete this._applicationCacheViews[t],n.parent.removeChild(n);var i=this._applicationCacheManifestElements[r];if(i.children.length!==0)return;delete this._applicationCacheManifestElements[r],i.parent.removeChild(i)},_applicationCacheFrameManifestStatusChanged:function(e){var t=e.data,n=this._applicationCacheModel.frameManifestStatus(t);this._applicationCacheViews[t]&&this._applicationCacheViews[t].updateStatus(n)},_applicationCacheNetworkStateChanged:function(e){var t=e.data;for(var n in this._applicationCacheViews)this._applicationCacheViews[n].updateNetworkState(t)},sidebarResized:function(e){var t=e.data;this.storageViewStatusBarItemsContainer.style.left=t+"px"},performSearch:function(e,t){function i(e,t){this._findTreeElementForResource(e).searchMatchesFound(t),r+=t}function s(e,t){if(e)return;for(var n=0;n<t.length;n++){var r=t[n],s=this._treeElementForFrameId[r.frameId];if(!s)continue;var o=s.resourceByURL(r.url);if(!o)continue;i.call(this,o,r.matchesCount)}--f||u.call(this)}function o(e,t){i.call(this,e,t.length),--f||u.call(this)}function u(){WebInspector.searchController.updateSearchMatchesCount(r,this),this._searchController=new WebInspector.ResourcesSearchController(this.resourcesListTreeElement,r),t&&this.sidebarTree.selectedTreeElement&&this.sidebarTree.selectedTreeElement.searchMatchesCount&&this.jumpToNextSearchResult()}this._resetSearchResults();var n=WebInspector.SourceFrame.createSearchRegex(e),r=0,a=WebInspector.resourceTreeModel.frames(),f=1+a.length;for(var l=0;l<a.length;++l){var c=a[l].mainResource;c.searchInContent(n.source,!n.ignoreCase,!0,o.bind(this,c))}PageAgent.searchInResources(n.source,!n.ignoreCase,!0,s.bind(this))},_ensureViewSearchPerformed:function(e){function t(t){if(t!==this._lastViewSearchId)return;this._viewSearchInProgress=!1,e()}this._viewSearchInProgress||(this.visibleView.hasSearchResults()?e():(this._lastViewSearchId=this._lastViewSearchId?this._lastViewSearchId+1:0,this._viewSearchInProgress=!0,this.visibleView.performSearch(this.currentQuery,!1,t.bind(this,this._lastViewSearchId))))},_showSearchResult:function(e){function t(t){if(this.sidebarTree.selectedTreeElement!==this._lastSearchResultTreeElement)return;this._lastSearchResultIndex!=-1&&this.visibleView.jumpToSearchResult(this._lastSearchResultIndex),WebInspector.searchController.updateCurrentMatchIndex(e.currentMatchIndex-1,this)}this._lastSearchResultIndex=e.index,this._lastSearchResultTreeElement=e.treeElement,e.treeElement!==this.sidebarTree.selectedTreeElement&&this.showResource(e.treeElement.representedObject),this._ensureViewSearchPerformed(t.bind(this))},_resetSearchResults:function(){function e(e){e._resetSearchResults()}this._forAllResourceTreeElements(e),this.visibleView&&this.visibleView.searchCanceled&&this.visibleView.searchCanceled(),this._lastSearchResultTreeElement=null,this._lastSearchResultIndex=-1,this._viewSearchInProgress=!1},searchCanceled:function(){function e(e){e._updateErrorsAndWarningsBubbles()}WebInspector.searchController.updateSearchMatchesCount(0,this),this._resetSearchResults(),this._forAllResourceTreeElements(e)},jumpToNextSearchResult:function(){if(!this.currentSearchMatches)return;var e=this.sidebarTree.selectedTreeElement,t=this._searchController.nextSearchResult(e);this._showSearchResult(t)},jumpToPreviousSearchResult:function(){if(!this.currentSearchMatches)return;var e=this.sidebarTree.selectedTreeElement,t=this._searchController.previousSearchResult(e);this._showSearchResult(t)},_forAllResourceTreeElements:function(e){var t=!1;for(var n=this.resourcesListTreeElement;!t&&n;n=n.traverseNextTreeElement(!1,this.resourcesListTreeElement,!0))n instanceof WebInspector.FrameResourceTreeElement&&(t=e(n))},_findTreeElementForResource:function(e){function t(e,t){return!1}function n(e){return null}return this.sidebarTree.findTreeElement(e,t,n)},showView:function(e){e&&this.showResource(e.resource)},_onmousemove:function(e){var t=document.elementFromPoint(e.pageX,e.pageY);if(!t)return;var n=t.enclosingNodeOrSelfWithNodeName("li");if(!n)return;var r=n.treeElement;if(this._previousHoveredElement===r)return;this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement),r instanceof WebInspector.FrameTreeElement&&(this._previousHoveredElement=r,r.hovered=!0)},_onmouseout:function(e){this._previousHoveredElement&&(this._previousHoveredElement.hovered=!1,delete this._previousHoveredElement)},__proto__:WebInspector.Panel.prototype},WebInspector.BaseStorageTreeElement=function(e,t,n,r,i,s){TreeElement.call(this,"",t,i),this._storagePanel=e,this._titleText=n,this._iconClasses=r,this._noIcon=s},WebInspector.BaseStorageTreeElement.prototype={onattach:function(){this.listItemElement.removeChildren();if(this._iconClasses)for(var e=0;e<this._iconClasses.length;++e)this.listItemElement.addStyleClass(this._iconClasses[e]);var t=document.createElement("div");t.className="selection",this.listItemElement.appendChild(t),this._noIcon||(this.imageElement=document.createElement("img"),this.imageElement.className="icon",this.listItemElement.appendChild(this.imageElement)),this.titleElement=document.createElement("div"),this.titleElement.className="base-storage-tree-element-title",this._titleTextNode=document.createTextNode(""),this.titleElement.appendChild(this._titleTextNode),this._updateTitle(),this._updateSubtitle(),this.listItemElement.appendChild(this.titleElement)},get displayName(){return this._displayName},_updateDisplayName:function(){this._displayName=this._titleText||"",this._subtitleText&&(this._displayName+=" ("+this._subtitleText+")")},_updateTitle:function(){this._updateDisplayName();if(!this.titleElement)return;this._titleTextNode.textContent=this._titleText||""},_updateSubtitle:function(){this._updateDisplayName();if(!this.titleElement)return;this._subtitleText?(this._subtitleElement||(this._subtitleElement=document.createElement("span"),this._subtitleElement.className="base-storage-tree-element-subtitle",this.titleElement.appendChild(this._subtitleElement)),this._subtitleElement.textContent="("+this._subtitleText+")"):this._subtitleElement&&(this.titleElement.removeChild(this._subtitleElement),delete this._subtitleElement)},onselect:function(e){if(!e)return;var t=this.itemURL;t&&WebInspector.settings.resourcesLastSelectedItem.set(t)},onreveal:function(){this.listItemElement&&this.listItemElement.scrollIntoViewIfNeeded(!1)},get titleText(){return this._titleText},set titleText(e){this._titleText=e,this._updateTitle()},get subtitleText(){return this._subtitleText},set subtitleText(e){this._subtitleText=e,this._updateSubtitle()},get searchMatchesCount(){return 0},__proto__:TreeElement.prototype},WebInspector.StorageCategoryTreeElement=function(e,t,n,r,i){WebInspector.BaseStorageTreeElement.call(this,e,null,t,r,!0,i),this._expandedSettingKey="resources"+n+"Expanded",WebInspector.settings[this._expandedSettingKey]=WebInspector.settings.createSetting(this._expandedSettingKey,n==="Frames"),this._categoryName=t},WebInspector.StorageCategoryTreeElement.prototype={get itemURL(){return"category://"+this._categoryName},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel.showCategoryView(this._categoryName)},onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),WebInspector.settings[this._expandedSettingKey].get()&&this.expand()},onexpand:function(){WebInspector.settings[this._expandedSettingKey].set(!0)},oncollapse:function(){WebInspector.settings[this._expandedSettingKey].set(!1)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.FrameTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,null,"",["frame-storage-tree-item"]),this._frame=t,this.frameNavigated(t)},WebInspector.FrameTreeElement.prototype={frameNavigated:function(e){this.removeChildren(),this._frameId=e.id,this.titleText=e.name,this.subtitleText=(new WebInspector.ParsedURL(e.url)).displayName,this._categoryElements={},this._treeElementForResource={},this._storagePanel.addDocumentURL(e.url)},get itemURL(){return"frame://"+encodeURI(this.displayName)},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel.showCategoryView(this.displayName),this.listItemElement.removeStyleClass("hovered"),DOMAgent.hideHighlight()},set hovered(e){e?(this.listItemElement.addStyleClass("hovered"),DOMAgent.highlightFrame(this._frameId,WebInspector.Color.PageHighlight.Content.toProtocolRGBA(),WebInspector.Color.PageHighlight.ContentOutline.toProtocolRGBA())):(this.listItemElement.removeStyleClass("hovered"),DOMAgent.hideHighlight())},appendResource:function(e){if(e.isHidden())return;var t=e.type.name(),n=e.type===WebInspector.resourceTypes.Document?this:this._categoryElements[t];n||(n=new WebInspector.StorageCategoryTreeElement(this._storagePanel,e.type.categoryTitle(),t,null,!0),this._categoryElements[e.type.name()]=n,this._insertInPresentationOrder(this,n));var r=new WebInspector.FrameResourceTreeElement(this._storagePanel,e);this._insertInPresentationOrder(n,r),this._treeElementForResource[e.url]=r},resourceByURL:function(e){var t=this._treeElementForResource[e];return t?t.representedObject:null},appendChild:function(e){this._insertInPresentationOrder(this,e)},_insertInPresentationOrder:function(e,t){function n(e){return e instanceof WebInspector.StorageCategoryTreeElement?2:e instanceof WebInspector.FrameTreeElement?1:3}function r(e,t){var r=n(e),i=n(t),s;if(r>i)s=1;else if(r<i)s=-1;else{var o=e.displayName||e.titleText,u=t.displayName||t.titleText;s=o.localeCompare(u)}return s}var i=e.children,s;for(s=0;s<i.length;++s)if(r(t,i[s])<0)break;e.insertChild(t,s)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.FrameResourceTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,t,t.displayName,["resource-sidebar-tree-item","resources-type-"+t.type.name()]),this._resource=t,this._resource.addEventListener(WebInspector.Resource.Events.MessageAdded,this._consoleMessageAdded,this),this._resource.addEventListener(WebInspector.Resource.Events.MessagesCleared,this._consoleMessagesCleared,this),this.tooltip=t.url},WebInspector.FrameResourceTreeElement.prototype={get itemURL(){return this._resource.url},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel._showResourceView(this._resource)},ondblclick:function(e){InspectorFrontendHost.openInNewTab(this._resource.url)},onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this);if(this._resource.type===WebInspector.resourceTypes.Image){var e=document.createElement("img");e.className="image-resource-icon-preview",this._resource.populateImageSource(e);var t=document.createElement("div");t.className="icon",t.appendChild(e),this.listItemElement.replaceChild(t,this.imageElement)}this._statusElement=document.createElement("div"),this._statusElement.className="status",this.listItemElement.insertBefore(this._statusElement,this.titleElement),this.listItemElement.draggable=!0,this.listItemElement.addEventListener("dragstart",this._ondragstart.bind(this),!1),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0),this._updateErrorsAndWarningsBubbles()},_ondragstart:function(e){return e.dataTransfer.setData("text/plain",this._resource.content),e.dataTransfer.effectAllowed="copy",!0},_handleContextMenuEvent:function(e){var t=new WebInspector.ContextMenu(e);t.appendApplicableItems(this._resource),t.show()},_setBubbleText:function(e){this._bubbleElement||(this._bubbleElement=document.createElement("div"),this._bubbleElement.className="bubble",this._statusElement.appendChild(this._bubbleElement)),this._bubbleElement.textContent=e},_resetBubble:function(){this._bubbleElement&&(this._bubbleElement.textContent="",this._bubbleElement.removeStyleClass("search-matches"),this._bubbleElement.removeStyleClass("warning"),this._bubbleElement.removeStyleClass("error"))},_resetSearchResults:function(){this._resetBubble(),this._searchMatchesCount=0},get searchMatchesCount(){return this._searchMatchesCount},searchMatchesFound:function(e){this._resetSearchResults(),this._searchMatchesCount=e,this._setBubbleText(e),this._bubbleElement.addStyleClass("search-matches");var t=this.parent;while(t&&!t.root)t.expanded||t.expand(),t=t.parent},_updateErrorsAndWarningsBubbles:function(){if(this._storagePanel.currentQuery)return;this._resetBubble(),(this._resource.warnings||this._resource.errors)&&this._setBubbleText(this._resource.warnings+this._resource.errors),this._resource.warnings&&this._bubbleElement.addStyleClass("warning"),this._resource.errors&&this._bubbleElement.addStyleClass("error")},_consoleMessagesCleared:function(){this._sourceView&&this._sourceView.clearMessages(),this._updateErrorsAndWarningsBubbles()},_consoleMessageAdded:function(e){var t=e.data;this._sourceView&&this._sourceView.addMessage(t),this._updateErrorsAndWarningsBubbles()},sourceView:function(){if(!this._sourceView){this._sourceView=new WebInspector.ResourceSourceFrame(this._resource);if(this._resource.messages)for(var e=0;e<this._resource.messages.length;e++)this._sourceView.addMessage(this._resource.messages[e])}return this._sourceView},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.DatabaseTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,null,t.name,["database-storage-tree-item"],!0),this._database=t},WebInspector.DatabaseTreeElement.prototype={get itemURL(){return"database://"+encodeURI(this._database.name)},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel._showDatabase(this._database)},onexpand:function(){this._updateChildren()},_updateChildren:function(){function e(e){var t=e.length;for(var n=0;n<t;++n)this.appendChild(new WebInspector.DatabaseTableTreeElement(this._storagePanel,this._database,e[n]))}this.removeChildren(),this._database.getTableNames(e.bind(this))},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.DatabaseTableTreeElement=function(e,t,n){WebInspector.BaseStorageTreeElement.call(this,e,null,n,["database-storage-tree-item"]),this._database=t,this._tableName=n},WebInspector.DatabaseTableTreeElement.prototype={get itemURL(){return"database://"+encodeURI(this._database.name)+"/"+encodeURI(this._tableName)},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel._showDatabase(this._database,this._tableName)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.IndexedDBTreeElement=function(e){WebInspector.StorageCategoryTreeElement.call(this,e,WebInspector.UIString("IndexedDB"),"IndexedDB",["indexed-db-storage-tree-item"])},WebInspector.IndexedDBTreeElement.prototype={onexpand:function(){WebInspector.StorageCategoryTreeElement.prototype.onexpand.call(this),this._indexedDBModel||this._createIndexedDBModel()},onattach:function(){WebInspector.StorageCategoryTreeElement.prototype.onattach.call(this),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)},_handleContextMenuEvent:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString("Refresh IndexedDB"),this.refreshIndexedDB.bind(this)),t.show()},_createIndexedDBModel:function(){this._indexedDBModel=new WebInspector.IndexedDBModel,this._idbDatabaseTreeElements=[],this._indexedDBModel.addEventListener(WebInspector.IndexedDBModel.EventTypes.DatabaseAdded,this._indexedDBAdded,this),this._indexedDBModel.addEventListener(WebInspector.IndexedDBModel.EventTypes.DatabaseRemoved,this._indexedDBRemoved,this),this._indexedDBModel.addEventListener(WebInspector.IndexedDBModel.EventTypes.DatabaseLoaded,this._indexedDBLoaded,this)},refreshIndexedDB:function(){if(!this._indexedDBModel){this._createIndexedDBModel();return}this._indexedDBModel.refreshDatabaseNames()},_indexedDBAdded:function(e){var t=e.data,n=new WebInspector.IDBDatabaseTreeElement(this._storagePanel,this._indexedDBModel,t);this._idbDatabaseTreeElements.push(n),this.appendChild(n),this._indexedDBModel.refreshDatabase(t)},_indexedDBRemoved:function(e){var t=e.data,n=this._idbDatabaseTreeElement(t);if(!n)return;n.clear(),this.removeChild(n),this._idbDatabaseTreeElements.remove(n)},_indexedDBLoaded:function(e){var t=e.data,n=this._idbDatabaseTreeElement(t.databaseId);if(!n)return;n.update(t)},_idbDatabaseTreeElement:function(e){var t=-1;for(var n=0;n<this._idbDatabaseTreeElements.length;++n)if(this._idbDatabaseTreeElements[n]._databaseId.equals(e)){t=n;break}return t!==-1?this._idbDatabaseTreeElements[n]:null},__proto__:WebInspector.StorageCategoryTreeElement.prototype},WebInspector.FileSystemListTreeElement=function(e){WebInspector.StorageCategoryTreeElement.call(this,e,WebInspector.UIString("FileSystem"),"FileSystem",["file-system-storage-tree-item"])},WebInspector.FileSystemListTreeElement.prototype={onexpand:function(){WebInspector.StorageCategoryTreeElement.prototype.onexpand.call(this),this._refreshFileSystem()},onattach:function(){WebInspector.StorageCategoryTreeElement.prototype.onattach.call(this),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)},_handleContextMenuEvent:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Refresh FileSystem list":"Refresh FileSystem List"),this._refreshFileSystem.bind(this)),t.show()},_fileSystemAdded:function(e){var t=e.data,n=new WebInspector.FileSystemTreeElement(this._storagePanel,t);this.appendChild(n)},_fileSystemRemoved:function(e){var t=e.data,n=this._fileSystemTreeElementByName(t.name);if(!n)return;n.clear(),this.removeChild(n)},_fileSystemTreeElementByName:function(e){for(var t=0;t<this.children.length;++t){var n=this.children[t];if(n.fileSystemName===e)return this.children[t]}return null},_refreshFileSystem:function(){this._fileSystemModel||(this._fileSystemModel=new WebInspector.FileSystemModel,this._fileSystemModel.addEventListener(WebInspector.FileSystemModel.EventTypes.FileSystemAdded,this._fileSystemAdded,this),this._fileSystemModel.addEventListener(WebInspector.FileSystemModel.EventTypes.FileSystemRemoved,this._fileSystemRemoved,this)),this._fileSystemModel.refreshFileSystemList()},__proto__:WebInspector.StorageCategoryTreeElement.prototype},WebInspector.IDBDatabaseTreeElement=function(e,t,n){WebInspector.BaseStorageTreeElement.call(this,e,null,n.name+" - "+n.securityOrigin,["indexed-db-storage-tree-item"]),this._model=t,this._databaseId=n,this._idbObjectStoreTreeElements={}},WebInspector.IDBDatabaseTreeElement.prototype={get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name},onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)},_handleContextMenuEvent:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString("Refresh IndexedDB"),this._refreshIndexedDB.bind(this)),t.show()},_refreshIndexedDB:function(){this._model.refreshDatabaseNames()},update:function(e){this._database=e;var t={};for(var n in this._database.objectStores){var r=this._database.objectStores[n];t[r.name]=!0;if(!this._idbObjectStoreTreeElements[r.name]){var i=new WebInspector.IDBObjectStoreTreeElement(this._storagePanel,this._model,this._databaseId,r);this._idbObjectStoreTreeElements[r.name]=i,this.appendChild(i)}this._idbObjectStoreTreeElements[r.name].update(r)}for(var n in this._idbObjectStoreTreeElements)t[n]||this._objectStoreRemoved(n);this.children.length&&(this.hasChildren=!0,this.expand()),this._view&&this._view.update(e),this._updateTooltip()},_updateTooltip:function(){this.tooltip=WebInspector.UIString("Version")+": "+this._database.version},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._view||(this._view=new WebInspector.IDBDatabaseView(this._database)),this._storagePanel.showIndexedDB(this._view)},_objectStoreRemoved:function(e){var t=this._idbObjectStoreTreeElements[e];t.clear(),this.removeChild(t),delete this._idbObjectStoreTreeElements[e]},clear:function(){for(var e in this._idbObjectStoreTreeElements)this._objectStoreRemoved(e)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.IDBObjectStoreTreeElement=function(e,t,n,r){WebInspector.BaseStorageTreeElement.call(this,e,null,r.name,["indexed-db-object-store-storage-tree-item"]),this._model=t,this._databaseId=n,this._idbIndexTreeElements={}},WebInspector.IDBObjectStoreTreeElement.prototype={get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name},onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)},_handleContextMenuEvent:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString("Clear"),this._clearObjectStore.bind(this)),t.show()},_clearObjectStore:function(){function e(){this.update(this._objectStore)}this._model.clearObjectStore(this._databaseId,this._objectStore.name,e.bind(this))},update:function(e){this._objectStore=e;var t={};for(var n in this._objectStore.indexes){var r=this._objectStore.indexes[n];t[r.name]=!0;if(!this._idbIndexTreeElements[r.name]){var i=new WebInspector.IDBIndexTreeElement(this._storagePanel,this._model,this._databaseId,this._objectStore,r);this._idbIndexTreeElements[r.name]=i,this.appendChild(i)}this._idbIndexTreeElements[r.name].update(r)}for(var n in this._idbIndexTreeElements)t[n]||this._indexRemoved(n);for(var n in this._idbIndexTreeElements)t[n]||(this.removeChild(this._idbIndexTreeElements[n]),delete this._idbIndexTreeElements[n]);this.children.length&&(this.hasChildren=!0,this.expand()),this._view&&this._view.update(this._objectStore),this._updateTooltip()},_updateTooltip:function(){var e=this._objectStore.keyPathString,t=e!==null?WebInspector.UIString("Key path: ")+e:"";this._objectStore.autoIncrement&&(t+="\n"+WebInspector.UIString("autoIncrement")),this.tooltip=t},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._view||(this._view=new WebInspector.IDBDataView(this._model,this._databaseId,this._objectStore,null)),this._storagePanel.showIndexedDB(this._view)},_indexRemoved:function(e){var t=this._idbIndexTreeElements[e];t.clear(),this.removeChild(t),delete this._idbIndexTreeElements[e]},clear:function(){for(var e in this._idbIndexTreeElements)this._indexRemoved(e);this._view&&this._view.clear()},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.IDBIndexTreeElement=function(e,t,n,r,i){WebInspector.BaseStorageTreeElement.call(this,e,null,i.name,["indexed-db-index-storage-tree-item"]),this._model=t,this._databaseId=n,this._objectStore=r,this._index=i},WebInspector.IDBIndexTreeElement.prototype={get itemURL(){return"indexedDB://"+this._databaseId.securityOrigin+"/"+this._databaseId.name+"/"+this._objectStore.name+"/"+this._index.name},update:function(e){this._index=e,this._view&&this._view.update(this._index),this._updateTooltip()},_updateTooltip:function(){var e=[],t=this._index.keyPathString;e.push(WebInspector.UIString("Key path: ")+t),this._index.unique&&e.push(WebInspector.UIString("unique")),this._index.multiEntry&&e.push(WebInspector.UIString("multiEntry")),this.tooltip=e.join("\n")},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._view||(this._view=new WebInspector.IDBDataView(this._model,this._databaseId,this._objectStore,this._index)),this._storagePanel.showIndexedDB(this._view)},clear:function(){this._view&&this._view.clear()},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.DOMStorageTreeElement=function(e,t,n){WebInspector.BaseStorageTreeElement.call(this,e,null,t.securityOrigin?t.securityOrigin:WebInspector.UIString("Local Files"),["domstorage-storage-tree-item",n]),this._domStorage=t},WebInspector.DOMStorageTreeElement.prototype={get itemURL(){return"storage://"+this._domStorage.securityOrigin+"/"+(this._domStorage.isLocalStorage?"local":"session")},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel._showDOMStorage(this._domStorage)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.CookieTreeElement=function(e,t){WebInspector.BaseStorageTreeElement.call(this,e,null,t?t:WebInspector.UIString("Local Files"),["cookie-storage-tree-item"]),this._cookieDomain=t},WebInspector.CookieTreeElement.prototype={get itemURL(){return"cookies://"+this._cookieDomain},onattach:function(){WebInspector.BaseStorageTreeElement.prototype.onattach.call(this),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0)},_handleContextMenuEvent:function(e){var t=new WebInspector.ContextMenu(e);t.appendItem(WebInspector.UIString("Clear"),this._clearCookies.bind(this)),t.show()},_clearCookies:function(e){this._storagePanel.clearCookies(this._cookieDomain)},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel.showCookies(this,this._cookieDomain)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.ApplicationCacheManifestTreeElement=function(e,t){var n=(new WebInspector.ParsedURL(t)).displayName;WebInspector.BaseStorageTreeElement.call(this,e,null,n,["application-cache-storage-tree-item"]),this.tooltip=t,this._manifestURL=t},WebInspector.ApplicationCacheManifestTreeElement.prototype={get itemURL(){return"appcache://"+this._manifestURL},get manifestURL(){return this._manifestURL},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel.showCategoryView(this._manifestURL)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.ApplicationCacheFrameTreeElement=function(e,t,n){WebInspector.BaseStorageTreeElement.call(this,e,null,"",["frame-storage-tree-item"]),this._frameId=t,this._manifestURL=n,this._refreshTitles()},WebInspector.ApplicationCacheFrameTreeElement.prototype={get itemURL(){return"appcache://"+this._manifestURL+"/"+encodeURI(this.displayName)},get frameId(){return this._frameId},get manifestURL(){return this._manifestURL},_refreshTitles:function(){var e=WebInspector.resourceTreeModel.frameForId(this._frameId);if(!e){this.subtitleText=WebInspector.UIString("new frame");return}this.titleText=e.name,this.subtitleText=(new WebInspector.ParsedURL(e.url)).displayName},frameNavigated:function(){this._refreshTitles()},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._storagePanel.showApplicationCache(this._frameId)},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.FileSystemTreeElement=function(e,t){var n=t.type+" - "+t.origin;WebInspector.BaseStorageTreeElement.call(this,e,null,n,["file-system-storage-tree-item"]),this._fileSystem=t},WebInspector.FileSystemTreeElement.prototype={get fileSystemName(){return this._fileSystem.name},get itemURL(){return"filesystem://"+this._fileSystem.name},onselect:function(e){WebInspector.BaseStorageTreeElement.prototype.onselect.call(this,e),this._fileSystemView=new WebInspector.FileSystemView(this._fileSystem),this._storagePanel.showFileSystem(this._fileSystemView)},clear:function(){this.fileSystemView&&this._storagePanel.visibleView===this.fileSystemView&&this._storagePanel.closeVisibleView()},__proto__:WebInspector.BaseStorageTreeElement.prototype},WebInspector.StorageCategoryView=function(){WebInspector.View.call(this),this.element.addStyleClass("storage-view"),this._emptyView=new WebInspector.EmptyView(""),this._emptyView.show(this.element)},WebInspector.StorageCategoryView.prototype={setText:function(e){this._emptyView.text=e},__proto__:WebInspector.View.prototype},WebInspector.ResourcesSearchController=function(e,t){this._root=e,this._matchesCount=t,this._traverser=new WebInspector.SearchResultsTreeElementsTraverser(e),this._lastTreeElement=null,this._lastIndex=-1},WebInspector.ResourcesSearchController.prototype={nextSearchResult:function(e){return e?e.searchMatchesCount?this._lastTreeElement!==e||this._lastIndex===-1?this._searchResult(e,0):this._lastIndex===e.searchMatchesCount-1?this._searchResult(this._traverser.next(e),0,this._currentMatchIndex%this._matchesCount+1):this._searchResult(e,this._lastIndex+1,this._currentMatchIndex+1):this._searchResult(this._traverser.next(e),0):this._searchResult(this._traverser.first(),0,1)},previousSearchResult:function(e){if(!e){var t=this._traverser.last();return this._searchResult(t,t.searchMatchesCount-1,this._matchesCount)}if(e.searchMatchesCount&&this._lastTreeElement===e){if(this._lastIndex>0)return this._searchResult(e,this._lastIndex-1,this._currentMatchIndex-1);var t=this._traverser.previous(e),n=this._currentMatchIndex-1?this._currentMatchIndex-1:this._matchesCount;return this._searchResult(t,t.searchMatchesCount-1,n)}var t=this._traverser.previous(e);return this._searchResult(t,t.searchMatchesCount-1)},_searchResult:function(e,t,n){return this._lastTreeElement=e,this._lastIndex=t,n||(n=this._traverser.matchIndex(e,t)),this._currentMatchIndex=n,{treeElement:e,index:t,currentMatchIndex:n}}},WebInspector.SearchResultsTreeElementsTraverser=function(e){this._root=e},WebInspector.SearchResultsTreeElementsTraverser.prototype={first:function(){return this.next(this._root)},last:function(){return this.previous(this._root)},next:function(e){var t=e;do t=this._traverseNext(t)||this._root;while(t!=e&&!this._elementSearchMatchesCount(t));return t},previous:function(e){var t=e;do t=this._traversePrevious(t)||this._lastTreeElement();while(t!=e&&!this._elementSearchMatchesCount(t));return t},matchIndex:function(e,t){var n=1,r=this._root;while(r!=e){n+=this._elementSearchMatchesCount(r),r=this._traverseNext(r)||this._root;if(r===this._root)return 0}return n+t},_elementSearchMatchesCount:function(e){return e.searchMatchesCount},_traverseNext:function(e){return e.traverseNextTreeElement(!1,this._root,!0)},_traversePrevious:function(e){return e.traversePreviousTreeElement(!1,!0)},_lastTreeElement:function(){var e=this._root,t;while(t=this._traverseNext(e))e=t;return e}};