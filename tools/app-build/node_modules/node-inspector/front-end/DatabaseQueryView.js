/*
 * Copyright (C) 2008 Apple Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.DatabaseQueryView=function(e){WebInspector.View.call(this),this.database=e,this.element.addStyleClass("storage-view"),this.element.addStyleClass("query"),this.element.addStyleClass("monospace"),this.element.addEventListener("selectstart",this._selectStart.bind(this),!1),this._promptElement=document.createElement("div"),this._promptElement.className="database-query-prompt",this._promptElement.appendChild(document.createElement("br")),this._promptElement.addEventListener("keydown",this._promptKeyDown.bind(this),!0),this.element.appendChild(this._promptElement),this.prompt=new WebInspector.TextPromptWithHistory(this.completions.bind(this)," "),this.prompt.attach(this._promptElement),this.element.addEventListener("click",this._messagesClicked.bind(this),!0)},WebInspector.DatabaseQueryView.Events={SchemaUpdated:"SchemaUpdated"},WebInspector.DatabaseQueryView.prototype={_messagesClicked:function(){!this.prompt.isCaretInsidePrompt()&&window.getSelection().isCollapsed&&this.prompt.moveCaretToEndOfPrompt()},completions:function(e,t,n,r){function o(e){for(var t=0;t<e.length;++t){var n=e[t].toLowerCase();if(n.length<i.length)continue;if(!n.startsWith(i))continue;s.push(e[t])}}function u(e){o(e.map(function(e){return e+" "})),o(["SELECT ","FROM ","WHERE ","LIMIT ","DELETE FROM ","CREATE ","DROP ","TABLE ","INDEX ","UPDATE ","INSERT INTO ","VALUES ("]),r(s)}var i=t.toString().toLowerCase();if(!i)return;var s=[];this.database.getTableNames(u)},_selectStart:function(e){function t(){delete this._selectionTimeout,!this.prompt.isCaretInsidePrompt()&&window.getSelection().isCollapsed&&this.prompt.moveCaretToEndOfPrompt(),this.prompt.autoCompleteSoon()}this._selectionTimeout&&clearTimeout(this._selectionTimeout),this.prompt.clearAutoComplete(),this._selectionTimeout=setTimeout(t.bind(this),100)},_promptKeyDown:function(e){if(isEnterKey(e)){this._enterKeyPressed(e);return}},_enterKeyPressed:function(e){e.consume(!0),this.prompt.clearAutoComplete(!0);var t=this.prompt.text;if(!t.length)return;this.prompt.pushHistoryItem(t),this.prompt.text="",this.database.executeSql(t,this._queryFinished.bind(this,t),this._queryError.bind(this,t))},_queryFinished:function(e,t,n){var r=WebInspector.DataGrid.createSortableDataGrid(t,n),i=e.trim();r&&(r.renderInline(),this._appendViewQueryResult(i,r),r.autoSizeColumns(5)),(i.match(/^create /i)||i.match(/^drop table /i))&&this.dispatchEventToListeners(WebInspector.DatabaseQueryView.Events.SchemaUpdated,this.database)},_queryError:function(e,t){this._appendErrorQueryResult(e,t)},_appendViewQueryResult:function(e,t){var n=this._appendQueryResult(e);t.show(n),this._promptElement.scrollIntoView(!1)},_appendErrorQueryResult:function(e,t){var n=this._appendQueryResult(e);n.addStyleClass("error"),n.textContent=t,this._promptElement.scrollIntoView(!1)},_appendQueryResult:function(e){var t=document.createElement("div");t.className="database-user-query",this.element.insertBefore(t,this.prompt.proxyElement);var n=document.createElement("span");n.className="database-query-text",n.textContent=e,t.appendChild(n);var r=document.createElement("div");return r.className="database-query-result",t.appendChild(r),r},__proto__:WebInspector.View.prototype};