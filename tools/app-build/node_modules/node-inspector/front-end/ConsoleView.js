/*
 * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.
 * Copyright (C) 2009 Joseph Pecoraro
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1.  Redistributions of source code must retain the above copyright
 *     notice, this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
 *     its contributors may be used to endorse or promote products derived
 *     from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ConsoleView=function(e){WebInspector.View.call(this),this.element.id="console-view",this._visibleMessagesIndices=[],this._urlToMessageCount={},this._clearConsoleButton=new WebInspector.StatusBarButton(WebInspector.UIString("Clear console log."),"clear-status-bar-item"),this._clearConsoleButton.addEventListener("click",this._requestClearMessages,this),this._frameSelector=new WebInspector.StatusBarComboBox(this._frameChanged.bind(this),"console-context"),this._contextSelector=new WebInspector.StatusBarComboBox(this._contextChanged.bind(this),"console-context"),this._filter=new WebInspector.ConsoleViewFilter,this._filter.addEventListener(WebInspector.ConsoleViewFilter.Events.FilterChanged,this._updateMessageList.bind(this)),e&&(this._frameSelector.element.addStyleClass("hidden"),this._contextSelector.element.addStyleClass("hidden")),this.messagesElement=document.createElement("div"),this.messagesElement.id="console-messages",this.messagesElement.className="monospace",this.messagesElement.addEventListener("click",this._messagesClicked.bind(this),!0),this.element.appendChild(this.messagesElement),this._scrolledToBottom=!0,this.promptElement=document.createElement("div"),this.promptElement.id="console-prompt",this.promptElement.className="source-code",this.promptElement.spellcheck=!1,this.messagesElement.appendChild(this.promptElement),this.messagesElement.appendChild(document.createElement("br")),this.topGroup=new WebInspector.ConsoleGroup(null),this.messagesElement.insertBefore(this.topGroup.element,this.promptElement),this.currentGroup=this.topGroup,this._registerShortcuts(),this.registerRequiredCSS("textPrompt.css"),this.messagesElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),WebInspector.settings.monitoringXHREnabled.addChangeListener(this._monitoringXHREnabledSettingChanged.bind(this)),WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.MessageAdded,this._consoleMessageAdded,this),WebInspector.console.addEventListener(WebInspector.ConsoleModel.Events.ConsoleCleared,this._consoleCleared,this),this._linkifier=new WebInspector.Linkifier,this.prompt=new WebInspector.TextPromptWithHistory(WebInspector.runtimeModel.completionsForTextPrompt.bind(WebInspector.runtimeModel)),this.prompt.setSuggestBoxEnabled("generic-suggest"),this.prompt.renderAsBlock(),this.prompt.attach(this.promptElement),this.prompt.proxyElement.addEventListener("keydown",this._promptKeyDown.bind(this),!1),this.prompt.setHistoryData(WebInspector.settings.consoleHistory.get()),WebInspector.runtimeModel.contextLists().forEach(this._addFrame,this),WebInspector.runtimeModel.addEventListener(WebInspector.RuntimeModel.Events.FrameExecutionContextListAdded,this._frameAdded,this),WebInspector.runtimeModel.addEventListener(WebInspector.RuntimeModel.Events.FrameExecutionContextListRemoved,this._frameRemoved,this),this._filterStatusMessageElement=document.createElement("div"),this._filterStatusMessageElement.classList.add("console-message"),this._filterStatusTextElement=this._filterStatusMessageElement.createChild("span","console-info"),this._filterStatusMessageElement.createTextChild(" ");var t=this._filterStatusMessageElement.createChild("span","console-info node-link");t.textContent=WebInspector.UIString("Show all messages."),t.addEventListener("click",this._filter.reset.bind(this._filter),!0),this.messagesElement.insertBefore(this._filterStatusMessageElement,this.topGroup.element),this._updateFilterStatus()},WebInspector.ConsoleView.prototype={get statusBarItems(){return[this._clearConsoleButton.element,this._frameSelector.element,this._contextSelector.element,this._filter.sourceFilterButton.element,this._filter.filterBarElement]},_frameAdded:function(e){var t=e.data;this._addFrame(t)},_addFrame:function(e){var t=this._frameSelector.createOption(e.displayName,e.url);t._contextList=e,e._consoleOption=t,e.addEventListener(WebInspector.FrameExecutionContextList.EventTypes.ContextsUpdated,this._frameUpdated,this),e.addEventListener(WebInspector.FrameExecutionContextList.EventTypes.ContextAdded,this._contextAdded,this),this._frameChanged()},_frameRemoved:function(e){var t=e.data;this._frameSelector.removeOption(t._consoleOption),this._frameChanged()},_frameChanged:function(){var e=this._currentFrame();if(!e){WebInspector.runtimeModel.setCurrentExecutionContext(null),this._contextSelector.element.addStyleClass("hidden");return}var t=e.executionContexts();t.length&&WebInspector.runtimeModel.setCurrentExecutionContext(t[0]);if(t.length===1){this._contextSelector.element.addStyleClass("hidden");return}this._contextSelector.element.removeStyleClass("hidden"),this._contextSelector.removeOptions();for(var n=0;n<t.length;++n)this._appendContextOption(t[n])},_appendContextOption:function(e){WebInspector.runtimeModel.currentExecutionContext()||WebInspector.runtimeModel.setCurrentExecutionContext(e);var t=this._contextSelector.createOption(e.name,e.id);t._executionContext=e},_contextChanged:function(e){var t=this._contextSelector.selectedOption();WebInspector.runtimeModel.setCurrentExecutionContext(t?t._executionContext:null)},_frameUpdated:function(e){var t=e.data,n=t._consoleOption;n.text=t.displayName,n.title=t.url},_contextAdded:function(e){var t=e.data;t===this._currentFrame()&&this._frameChanged()},_currentFrame:function(){var e=this._frameSelector.selectedOption();return e?e._contextList:undefined},willHide:function(){this.prompt.hideSuggestBox(),this.prompt.clearAutoComplete(!0)},wasShown:function(){this.prompt.isCaretInsidePrompt()||this.prompt.moveCaretToEndOfPrompt()},afterShow:function(){WebInspector.setCurrentFocusElement(this.promptElement)},storeScrollPositions:function(){WebInspector.View.prototype.storeScrollPositions.call(this),this._scrolledToBottom=this.messagesElement.isScrolledToBottom()},restoreScrollPositions:function(){this._scrolledToBottom?this._immediatelyScrollIntoView():WebInspector.View.prototype.restoreScrollPositions.call(this)},onResize:function(){this.restoreScrollPositions()},_isScrollIntoViewScheduled:function(){return!!this._scrollIntoViewTimer},_scheduleScrollIntoView:function(){function e(){delete this._scrollIntoViewTimer,this.promptElement.scrollIntoView(!0)}if(this._scrollIntoViewTimer)return;this._scrollIntoViewTimer=setTimeout(e.bind(this),20)},_immediatelyScrollIntoView:function(){this.promptElement.scrollIntoView(!0),this._cancelScheduledScrollIntoView()},_cancelScheduledScrollIntoView:function(){if(!this._isScrollIntoViewScheduled())return;clearTimeout(this._scrollIntoViewTimer),delete this._scrollIntoViewTimer},_updateFilterStatus:function(e){e=typeof e===undefined?WebInspector.console.messages.length-this._visibleMessagesIndices.length:e,this._filterStatusTextElement.textContent=WebInspector.UIString(e==1?"%d message is hidden by filters.":"%d messages are hidden by filters.",e),this._filterStatusMessageElement.style.display=e?"":"none"},_consoleMessageAdded:function(e){var t=e.data,n=t.index;this._urlToMessageCount[t.url]?this._urlToMessageCount[t.url]++:this._urlToMessageCount[t.url]=1,this._filter.shouldBeVisible(t)?this._showConsoleMessage(n):this._updateFilterStatus()},_showConsoleMessage:function(e){var t=WebInspector.console.messages[e];!this._isScrollIntoViewScheduled()&&(t instanceof WebInspector.ConsoleCommandResult||this.messagesElement.isScrolledToBottom())&&this._scheduleScrollIntoView(),this._visibleMessagesIndices.push(e);if(t.type===WebInspector.ConsoleMessage.MessageType.EndGroup){var n=this.currentGroup.parentGroup;n&&(this.currentGroup=n)}else{if(t.type===WebInspector.ConsoleMessage.MessageType.StartGroup||t.type===WebInspector.ConsoleMessage.MessageType.StartGroupCollapsed){var r=new WebInspector.ConsoleGroup(this.currentGroup);this.currentGroup.messagesElement.appendChild(r.element),this.currentGroup=r,t.group=r}this.currentGroup.addMessage(t)}this._searchRegex&&t.matchesRegex(this._searchRegex)&&(this._searchResultsIndices.push(e),WebInspector.searchController.updateSearchMatchesCount(this._searchResultsIndices.length,this._searchProvider))},_consoleCleared:function(){this._scrolledToBottom=!0;for(var e=0;e<this._visibleMessagesIndices.length;++e)WebInspector.console.messages[this._visibleMessagesIndices[e]].willHide();this._visibleMessagesIndices=[],this._searchResultsIndices=[],this._searchRegex&&WebInspector.searchController.updateSearchMatchesCount(0,this._searchProvider),this.currentGroup=this.topGroup,this.topGroup.messagesElement.removeChildren(),this._clearCurrentSearchResultHighlight(),this._updateFilterStatus(0),this._linkifier.reset()},_handleContextMenuEvent:function(e){function n(){WebInspector.settings.monitoringXHREnabled.set(!WebInspector.settings.monitoringXHREnabled.get())}function r(){WebInspector.settings.preserveConsoleLog.set(!WebInspector.settings.preserveConsoleLog.get())}if(!window.getSelection().isCollapsed)return;if(e.target.enclosingNodeOrSelfWithNodeName("a"))return;var t=new WebInspector.ContextMenu(e);t.appendCheckboxItem(WebInspector.UIString("Log XMLHttpRequests"),n.bind(this),WebInspector.settings.monitoringXHREnabled.get()),t.appendCheckboxItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Preserve log upon navigation":"Preserve Log upon Navigation"),r.bind(this),WebInspector.settings.preserveConsoleLog.get());var i=e.target.enclosingNodeOrSelfWithClass("console-message"),s=t.appendSubMenuItem(WebInspector.UIString("Filter"));if(i&&i.message.url){var o=WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Hide messages from %s":"Hide Messages from %s",(new WebInspector.ParsedURL(i.message.url)).displayName);s.appendItem(o,this._filter.addMessageURLFilter.bind(this._filter,i.message.url))}s.appendSeparator();var u=s.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Unhide all":"Unhide All"),this._filter.removeMessageURLFilter.bind(this._filter));s.appendSeparator();var a=!1;for(var f in this._filter.messageURLFilters)s.appendCheckboxItem(String.sprintf("%s (%d)",(new WebInspector.ParsedURL(f)).displayName,this._urlToMessageCount[f]),this._filter.removeMessageURLFilter.bind(this._filter,f),!0),a=!0;s.setEnabled(a||i&&i.message.url),u.setEnabled(a),t.appendSeparator(),t.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Clear console":"Clear Console"),this._requestClearMessages.bind(this));var l=i&&i.message?i.message.request():null;l&&l.type===WebInspector.resourceTypes.XHR&&(t.appendSeparator(),t.appendItem(WebInspector.UIString("Replay XHR"),NetworkAgent.replayXHR.bind(null,l.requestId))),t.show()},_updateMessageList:function(){var e=this.topGroup,t=WebInspector.console.messages,n=0,r=[];this._searchRegex&&(this._searchResultsIndices=[]);var i=null;for(var s=0;s<t.length;++s){var o=t[s],u=WebInspector.console.messages[this._visibleMessagesIndices[n]];u===o?(this._filter.shouldBeVisible(u)?(r.push(this._visibleMessagesIndices[n]),this._searchRegex&&o.matchesRegex(this._searchRegex)&&this._searchResultsIndices.push(s),o.type===WebInspector.ConsoleMessage.MessageType.EndGroup?(i=e.element,e=e.parentGroup||e):o.type===WebInspector.ConsoleMessage.MessageType.StartGroup||o.type===WebInspector.ConsoleMessage.MessageType.StartGroupCollapsed?(e=o.group,i=e.messagesElement.firstChild):i=u.toMessageElement()):(u.willHide(),u.toMessageElement().remove()),++n):this._filter.shouldBeVisible(o)&&(this._searchRegex&&o.matchesRegex(this._searchRegex)&&this._searchResultsIndices.push(s),e.addMessage(o,i?i.nextSibling:e.messagesElement.firstChild),r.push(s),i=o.toMessageElement())}this._searchRegex&&WebInspector.searchController.updateSearchMatchesCount(this._searchResultsIndices.length,this._searchProvider),this._visibleMessagesIndices=r,this._updateFilterStatus()},_monitoringXHREnabledSettingChanged:function(e){ConsoleAgent.setMonitoringXHREnabled(e.data)},_messagesClicked:function(){!this.prompt.isCaretInsidePrompt()&&window.getSelection().isCollapsed&&this.prompt.moveCaretToEndOfPrompt()},_registerShortcuts:function(){this._shortcuts={};var e=WebInspector.KeyboardShortcut,t=WebInspector.shortcutsScreen.section(WebInspector.UIString("Console")),n=e.makeDescriptor("l",WebInspector.KeyboardShortcut.Modifiers.Ctrl);this._shortcuts[n.key]=this._requestClearMessages.bind(this);var r=[n];if(WebInspector.isMac()){var i=e.makeDescriptor("k",WebInspector.KeyboardShortcut.Modifiers.Meta);this._shortcuts[i.key]=this._requestClearMessages.bind(this),r.unshift(i)}t.addAlternateKeys(r,WebInspector.UIString("Clear console")),t.addKey(e.makeDescriptor(e.Keys.Tab),WebInspector.UIString("Autocomplete common prefix")),t.addKey(e.makeDescriptor(e.Keys.Right),WebInspector.UIString("Accept suggestion")),r=[e.makeDescriptor(e.Keys.Down),e.makeDescriptor(e.Keys.Up)],t.addRelatedKeys(r,WebInspector.UIString("Next/previous line")),WebInspector.isMac()&&(r=[e.makeDescriptor("N",e.Modifiers.Alt),e.makeDescriptor("P",e.Modifiers.Alt)],t.addRelatedKeys(r,WebInspector.UIString("Next/previous command"))),t.addKey(e.makeDescriptor(e.Keys.Enter),WebInspector.UIString("Execute command"))},_requestClearMessages:function(){WebInspector.console.requestClearMessages()},_promptKeyDown:function(e){if(isEnterKey(e)){this._enterKeyPressed(e);return}var t=WebInspector.KeyboardShortcut.makeKeyFromEvent(e),n=this._shortcuts[t];n&&(n(),e.preventDefault())},evaluateUsingTextPrompt:function(e,t){this._appendCommand(e,this.prompt.text,!1,t)},_enterKeyPressed:function(e){if(e.altKey||e.ctrlKey||e.shiftKey)return;e.consume(!0),this.prompt.clearAutoComplete(!0);var t=this.prompt.text;if(!t.length)return;this._appendCommand(t,"",!0,!1)},_printResult:function(e,t,n){function r(r,i,s){var o=new WebInspector.ConsoleCommandResult(e,t,n,this._linkifier,r,i,s);WebInspector.console.addMessage(o)}function i(e,t){if(e){console.error(e),r.call(this);return}var n,i,s,o=WebInspector.debuggerModel.scriptForId(t.location.scriptId);o&&o.sourceURL&&(n=o.sourceURL,i=t.location.lineNumber+1,s=t.location.columnNumber+1),r.call(this,n,i,s)}if(!e)return;if(e.type!=="function"){r.call(this);return}DebuggerAgent.getFunctionDetails(e.objectId,i.bind(this))},_appendCommand:function(e,t,n,r){function s(t,n,s){if(!t)return;r||(this.prompt.pushHistoryItem(e),WebInspector.settings.consoleHistory.set(this.prompt.historyData.slice(-30))),this._printResult(t,n,i)}if(!r){var i=new WebInspector.ConsoleCommand(e);WebInspector.console.addMessage(i)}this.prompt.text=t,WebInspector.runtimeModel.evaluate(e,"console",n,!1,!1,!0,s.bind(this)),WebInspector.userMetrics.ConsoleEvaluated.record()},elementsToRestoreScrollPositionsFor:function(){return[this.messagesElement]},searchCanceled:function(){this._clearCurrentSearchResultHighlight(),delete this._searchProvider,delete this._searchResultsIndices,delete this._searchRegex},canSearchAndReplace:function(){return!1},canFilter:function(){return!0},performSearch:function(e,t,n){this.searchCanceled(),this._searchProvider=n||this,WebInspector.searchController.updateSearchMatchesCount(0,this._searchProvider),this._searchRegex=createPlainTextSearchRegex(e,"gi"),this._searchResultsIndices=[];for(var r=0;r<this._visibleMessagesIndices.length;r++)WebInspector.console.messages[this._visibleMessagesIndices[r]].matchesRegex(this._searchRegex)&&this._searchResultsIndices.push(this._visibleMessagesIndices[r]);WebInspector.searchController.updateSearchMatchesCount(this._searchResultsIndices.length,this._searchProvider),this._currentSearchResultIndex=-1,t&&this._searchResultsIndices.length&&this._jumpToSearchResult(0,n)},minimalSearchQuerySize:function(){return 0},performFilter:function(e){this._filter.performFilter(e)},jumpToNextSearchResult:function(e){if(!this._searchResultsIndices||!this._searchResultsIndices.length)return;this._jumpToSearchResult((this._currentSearchResultIndex+1)%this._searchResultsIndices.length,e)},jumpToPreviousSearchResult:function(e){if(!this._searchResultsIndices||!this._searchResultsIndices.length)return;var t=this._currentSearchResultIndex-1;t===-1&&(t=this._searchResultsIndices.length-1),this._jumpToSearchResult(t,e)},_clearCurrentSearchResultHighlight:function(){if(!this._searchResultsIndices)return;var e=WebInspector.console.messages[this._searchResultsIndices[this._currentSearchResultIndex]];e&&e.clearHighlight(),this._currentSearchResultIndex=-1},_jumpToSearchResult:function(e,t){this._clearCurrentSearchResultHighlight(),this._currentSearchResultIndex=e,WebInspector.searchController.updateCurrentMatchIndex(this._currentSearchResultIndex,this._searchProvider),WebInspector.console.messages[this._searchResultsIndices[e]].highlightSearchResults(this._searchRegex)},__proto__:WebInspector.View.prototype},WebInspector.ConsoleViewFilter=function(){this._messageURLFilters=WebInspector.settings.messageURLFilters.get(),this._messageSourceFilters=WebInspector.settings.messageSourceFilters.get(),this._messageLevelFilters=WebInspector.settings.messageLevelFilters.get(),this._sourceToKeyMap={};for(var e in WebInspector.ConsoleViewFilter._messageSourceGroups){if(!WebInspector.ConsoleViewFilter._messageSourceGroups[e].sources){console.assert(!this._otherKey),this._otherKey=e;continue}for(var t=0;t<WebInspector.ConsoleViewFilter._messageSourceGroups[e].sources.length;++t)this._sourceToKeyMap[WebInspector.ConsoleViewFilter._messageSourceGroups[e].sources[t]]=e}this._filterChanged=this.dispatchEventToListeners.bind(this,WebInspector.ConsoleViewFilter.Events.FilterChanged),WebInspector.settings.messageSourceFilters.addChangeListener(this._updateSourceFilterButton.bind(this)),WebInspector.settings.messageLevelFilters.addChangeListener(this._updateLevelFilterBar.bind(this)),this.sourceFilterButton=new WebInspector.StatusBarButton(WebInspector.UIString("Filter"),"console-filter",2),this.sourceFilterButton.element.addEventListener("mousedown",this._handleSourceFilterButtonClick.bind(this),!1),this._filterBarElements=[],this.filterBarElement=document.createElement("div"),this.filterBarElement.className="scope-bar status-bar-item",this._createLevelFilterBarElement("all",WebInspector.UIString("All"));var n=document.createElement("div");n.addStyleClass("scope-bar-divider"),this.filterBarElement.appendChild(n),this._createLevelFilterBarElement("error",WebInspector.UIString("Errors")),this._createLevelFilterBarElement("warning",WebInspector.UIString("Warnings")),this._createLevelFilterBarElement("log",WebInspector.UIString("Logs")),this._createLevelFilterBarElement("debug",WebInspector.UIString("Debug")),this._updateLevelFilterBar(),this._updateSourceFilterButton()},WebInspector.ConsoleViewFilter.Events={FilterChanged:"FilterChanged"},WebInspector.ConsoleViewFilter._messageSourceGroups={JS:{sources:[WebInspector.ConsoleMessage.MessageSource.JS],title:"JavaScript",styleClass:"filter-type-javascript"},Network:{sources:[WebInspector.ConsoleMessage.MessageSource.Network],title:"Network",styleClass:"filter-type-network"},Logging:{sources:[WebInspector.ConsoleMessage.MessageSource.ConsoleAPI],title:"Logging",styleClass:"filter-type-logging"},CSS:{sources:[WebInspector.ConsoleMessage.MessageSource.CSS],title:"CSS",styleClass:"filter-type-css"},Other:{title:"Other",styleClass:"filter-type-other"}},WebInspector.ConsoleViewFilter.prototype={addMessageURLFilter:function(e){this._messageURLFilters[e]=!0,WebInspector.settings.messageURLFilters.set(this._messageURLFilters),this._filterChanged()},removeMessageURLFilter:function(e){e?delete this._messageURLFilters[e]:this._messageURLFilters={},WebInspector.settings.messageURLFilters.set(this._messageURLFilters),this._filterChanged()},get messageURLFilters(){return this._messageURLFilters},shouldBeVisible:function(e){if(e.type===WebInspector.ConsoleMessage.MessageType.StartGroup||e.type===WebInspector.ConsoleMessage.MessageType.StartGroupCollapsed||e.type===WebInspector.ConsoleMessage.MessageType.EndGroup)return!0;if(e.url&&this._messageURLFilters[e.url])return!1;if(e.level&&this._messageLevelFilters[e.level])return!1;if(this._filterRegex){this._filterRegex.lastIndex=0;if(!e.matchesRegex(this._filterRegex))return!1}return e.source?this._sourceToKeyMap[e.source]?!this._messageSourceFilters[this._sourceToKeyMap[e.source]]:!this._messageSourceFilters[this._otherKey]:!0},reset:function(){this._messageSourceFilters={},WebInspector.settings.messageSourceFilters.set(this._messageSourceFilters),this._messageURLFilters={},WebInspector.settings.messageURLFilters.set(this._messageURLFilters),this._messageLevelFilters={},WebInspector.settings.messageLevelFilters.set(this._messageLevelFilters),this._filterChanged()},performFilter:function(e){e?this._filterRegex=createPlainTextSearchRegex(e,"gi"):delete this._filterRegex,this._filterChanged()},_toggleMessageSourceFilter:function(e){this._messageSourceFilters[e]?delete this._messageSourceFilters[e]:this._messageSourceFilters[e]=!0,WebInspector.settings.messageSourceFilters.set(this._messageSourceFilters),this._filterChanged()},_updateSourceFilterButton:function(){var e=!1;for(var t in WebInspector.ConsoleViewFilter._messageSourceGroups)if(this._messageSourceFilters[t]){e=!0;break}this.sourceFilterButton.state=e},_createSourceFilterMenu:function(e){var t=new WebInspector.ContextMenu(e);for(var n in WebInspector.ConsoleViewFilter._messageSourceGroups){var r=WebInspector.ConsoleViewFilter._messageSourceGroups[n];t.appendCheckboxItem(WebInspector.UIString(WebInspector.UIString(r.title)),this._toggleMessageSourceFilter.bind(this,n),!this._messageSourceFilters[n])}return t},_createLevelFilterBarElement:function(e,t){var n=document.createElement("li");n.category=e,n.className=e,n.textContent=t,n.addEventListener("click",this._toggleLevelFilter.bind(this,e),!1),this._filterBarElements[e]=n,this.filterBarElement.appendChild(n)},_toggleLevelFilter:function(e,t){var n=WebInspector.isMac(),r=!1;n&&t.metaKey&&!t.ctrlKey&&!t.altKey&&!t.shiftKey&&(r=!0),!n&&t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.shiftKey&&(r=!0),e==="all"?this._messageLevelFilters={}:r?this._messageLevelFilters[e]?delete this._messageLevelFilters[e]:this._messageLevelFilters[e]=!0:(this._messageLevelFilters={error:!0,warning:!0,log:!0,debug:!0},delete this._messageLevelFilters[e]),WebInspector.settings.messageLevelFilters.set(this._messageLevelFilters),this._filterChanged()},_updateLevelFilterBar:function(){var e=!(this._messageLevelFilters.error||this._messageLevelFilters.warning||this._messageLevelFilters.log||this._messageLevelFilters.debug);this._filterBarElements.all.enableStyleClass("selected",e),this._filterBarElements.error.enableStyleClass("selected",!e&&!this._messageLevelFilters.error),this._filterBarElements.warning.enableStyleClass("selected",!e&&!this._messageLevelFilters.warning),this._filterBarElements.log.enableStyleClass("selected",!e&&!this._messageLevelFilters.log),this._filterBarElements.debug.enableStyleClass("selected",!e&&!this._messageLevelFilters.debug)},_handleSourceFilterButtonClick:function(e){e.button||this._createSourceFilterMenu(e).showSoftMenu()},__proto__:WebInspector.Object.prototype},WebInspector.ConsoleCommand=function(e){this.text=e},WebInspector.ConsoleCommand.prototype={wasShown:function(){},willHide:function(){},clearHighlight:function(){var e=this._formattedCommand;delete this._formattedCommand,this._formatCommand(),this._element.replaceChild(this._formattedCommand,e)},highlightSearchResults:function(e){e.lastIndex=0;var t=e.exec(this.text),n=[];while(t)n.push({offset:t.index,length:t[0].length}),t=e.exec(this.text);WebInspector.highlightSearchResults(this._formattedCommand,n),this._element.scrollIntoViewIfNeeded()},matchesRegex:function(e){return e.lastIndex=0,e.test(this.text)},toMessageElement:function(){return this._element||(this._element=document.createElement("div"),this._element.command=this,this._element.className="console-user-command",this._formatCommand(),this._element.appendChild(this._formattedCommand)),this._element},_formatCommand:function(){this._formattedCommand=document.createElement("span"),this._formattedCommand.className="console-message-text source-code",this._formattedCommand.textContent=this.text},__proto__:WebInspector.ConsoleMessage.prototype},WebInspector.ConsoleCommandResult=function(e,t,n,r,i,s,o){var u=t?WebInspector.ConsoleMessage.MessageLevel.Error:WebInspector.ConsoleMessage.MessageLevel.Log;this.originatingCommand=n,WebInspector.ConsoleMessageImpl.call(this,WebInspector.ConsoleMessage.MessageSource.JS,u,"",r,WebInspector.ConsoleMessage.MessageType.Result,i,s,o,undefined,[e])},WebInspector.ConsoleCommandResult.prototype={useArrayPreviewInFormatter:function(e){return!1},toMessageElement:function(){var e=WebInspector.ConsoleMessageImpl.prototype.toMessageElement.call(this);return e.addStyleClass("console-user-command-result"),e},__proto__:WebInspector.ConsoleMessageImpl.prototype},WebInspector.ConsoleGroup=function(e){this.parentGroup=e;var t=document.createElement("div");t.className="console-group",t.group=this,this.element=t;if(e){var n=document.createElement("div");n.className="console-group-bracket",t.appendChild(n)}var r=document.createElement("div");r.className="console-group-messages",t.appendChild(r),this.messagesElement=r},WebInspector.ConsoleGroup.prototype={addMessage:function(e,t){var n=e.toMessageElement();if(e.type===WebInspector.ConsoleMessage.MessageType.StartGroup||e.type===WebInspector.ConsoleMessage.MessageType.StartGroupCollapsed){this.messagesElement.parentNode.insertBefore(n,this.messagesElement),n.addEventListener("click",this._titleClicked.bind(this),!1);var r=n.enclosingNodeOrSelfWithClass("console-group");r&&e.type===WebInspector.ConsoleMessage.MessageType.StartGroupCollapsed&&r.addStyleClass("collapsed")}else this.messagesElement.insertBefore(n,t||null),e.wasShown();n.previousSibling&&e.originatingCommand&&n.previousSibling.command===e.originatingCommand&&n.previousSibling.addStyleClass("console-adjacent-user-command-result")},_titleClicked:function(e){var t=e.target.enclosingNodeOrSelfWithClass("console-group-title");if(t){var n=t.enclosingNodeOrSelfWithClass("console-group");n&&(n.hasStyleClass("collapsed")?n.removeStyleClass("collapsed"):n.addStyleClass("collapsed")),t.scrollIntoViewIfNeeded(!0)}e.consume(!0)}},WebInspector.consoleView=null,WebInspector.ConsoleMessage.create=function(e,t,n,r,i,s,o,u,a,f,l,c){return new WebInspector.ConsoleMessageImpl(e,t,n,WebInspector.consoleView._linkifier,r,i,s,o,u,a,f,l,c)};