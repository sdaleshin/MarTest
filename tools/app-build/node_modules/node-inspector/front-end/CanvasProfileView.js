/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.CanvasProfileView=function(e){WebInspector.View.call(this),this.registerRequiredCSS("canvasProfiler.css"),this.element.addStyleClass("canvas-profile-view"),this._profile=e,this._traceLogId=e.traceLogId(),this._traceLogPlayer=e.traceLogPlayer(),this._linkifier=new WebInspector.Linkifier;const t=.34;this._replayInfoSplitView=new WebInspector.SplitView(!0,"canvasProfileViewReplaySplitLocation",t),this._replayInfoSplitView.setMainElementConstraints(t,t),this._replayInfoSplitView.show(this.element),this._imageSplitView=new WebInspector.SplitView(!1,"canvasProfileViewSplitLocation",300),this._imageSplitView.show(this._replayInfoSplitView.firstElement());var n=this._imageSplitView.firstElement();n.id="canvas-replay-image-container",this._replayImageElement=n.createChild("image","canvas-replay-image"),this._debugInfoElement=n.createChild("div","canvas-debug-info hidden"),this._spinnerIcon=n.createChild("img","canvas-spinner-icon hidden");var r=this._imageSplitView.secondElement(),i=r.createChild("div","status-bar"),s=r.createChild("div","canvas-replay-log");this._createControlButton(i,"canvas-replay-first-step",WebInspector.UIString("First call."),this._onReplayFirstStepClick.bind(this)),this._createControlButton(i,"canvas-replay-prev-step",WebInspector.UIString("Previous call."),this._onReplayStepClick.bind(this,!1)),this._createControlButton(i,"canvas-replay-next-step",WebInspector.UIString("Next call."),this._onReplayStepClick.bind(this,!0)),this._createControlButton(i,"canvas-replay-prev-draw",WebInspector.UIString("Previous drawing call."),this._onReplayDrawingCallClick.bind(this,!1)),this._createControlButton(i,"canvas-replay-next-draw",WebInspector.UIString("Next drawing call."),this._onReplayDrawingCallClick.bind(this,!0)),this._createControlButton(i,"canvas-replay-last-step",WebInspector.UIString("Last call."),this._onReplayLastStepClick.bind(this)),this._replayContextSelector=new WebInspector.StatusBarComboBox(this._onReplayContextChanged.bind(this)),this._replayContextSelector.createOption(WebInspector.UIString("<screenshot auto>"),WebInspector.UIString("Show screenshot of the last replayed resource."),""),i.appendChild(this._replayContextSelector.element),this._installReplayInfoSidebarWidgets(i),this._replayStateView=new WebInspector.CanvasReplayStateView(this._traceLogPlayer),this._replayStateView.show(this._replayInfoSplitView.secondElement()),this._replayContexts={};var o=[{title:"#",sortable:!1,width:"5%"},{title:WebInspector.UIString("Call"),sortable:!1,width:"75%",disclosure:!0},{title:WebInspector.UIString("Location"),sortable:!1,width:"20%"}];this._logGrid=new WebInspector.DataGrid(o),this._logGrid.element.addStyleClass("fill"),this._logGrid.show(s),this._logGrid.addEventListener(WebInspector.DataGrid.Events.SelectedNode,this._replayTraceLog,this),this.element.addEventListener("mousedown",this._onMouseClick.bind(this),!0),this._popoverHelper=new WebInspector.ObjectPopoverHelper(this.element,this._popoverAnchor.bind(this),this._resolveObjectForPopover.bind(this),this._onHidePopover.bind(this),!0),this._popoverHelper.setRemoteObjectFormatter(this._hexNumbersFormatter.bind(this)),this._requestTraceLog(0)},WebInspector.CanvasProfileView.TraceLogPollingInterval=500,WebInspector.CanvasProfileView.prototype={dispose:function(){this._linkifier.reset()},get statusBarItems(){return[]},get profile(){return this._profile},elementsToRestoreScrollPositionsFor:function(){return[this._logGrid.scrollContainer]},_installReplayInfoSidebarWidgets:function(e){function t(){this._enableReplayInfoSidebar(this._toggleReplayStateSidebarButton.state==="left")}this._replayInfoResizeWidgetElement=e.createChild("div","resizer-widget"),this._replayInfoSplitView.installResizer(this._replayInfoResizeWidgetElement),this._toggleReplayStateSidebarButton=new WebInspector.StatusBarButton("","right-sidebar-show-hide-button canvas-sidebar-show-hide-button",3),this._toggleReplayStateSidebarButton.addEventListener("click",t,this),e.appendChild(this._toggleReplayStateSidebarButton.element),this._enableReplayInfoSidebar(!1)},_enableReplayInfoSidebar:function(e){e?(this._toggleReplayStateSidebarButton.state="right",this._toggleReplayStateSidebarButton.title=WebInspector.UIString("Hide sidebar."),this._replayInfoSplitView.showBoth()):(this._toggleReplayStateSidebarButton.state="left",this._toggleReplayStateSidebarButton.title=WebInspector.UIString("Show sidebar."),this._replayInfoSplitView.showOnlyFirst()),this._replayInfoResizeWidgetElement.enableStyleClass("hidden",!e)},_onMouseClick:function(e){var t=e.target.enclosingNodeOrSelfWithClass("canvas-formatted-resource");if(t){this._enableReplayInfoSidebar(!0),this._replayStateView.selectResource(t.__resourceId),e.consume(!0);return}e.target.enclosingNodeOrSelfWithClass("webkit-html-resource-link")&&e.consume(!1)},_createControlButton:function(e,t,n,r){var i=new WebInspector.StatusBarButton(n,t+" canvas-replay-button");e.appendChild(i.element),i.makeLongClickEnabled(),i.addEventListener("click",r,this),i.addEventListener("longClickDown",r,this),i.addEventListener("longClickPress",r,this)},_onReplayContextChanged:function(){function t(t){this._enableWaitIcon(!1);if(e!==this._replayContextSelector.selectedOption().value)return;var n=t&&t.imageURL||"";this._replayImageElement.src=n,this._replayImageElement.style.visibility=n?"":"hidden"}var e=this._replayContextSelector.selectedOption().value;this._enableWaitIcon(!0),this._traceLogPlayer.getResourceState(e,t.bind(this))},_onReplayStepClick:function(e){var t=this._logGrid.selectedNode;if(!t)return;var n=t;do n=e?n.traverseNextNode(!1):n.traversePreviousNode(!1);while(n&&typeof n.index!="number");(n||t).revealAndSelect()},_onReplayDrawingCallClick:function(e){var t=this._logGrid.selectedNode;if(!t)return;var n=t;while(n){var r=e?n.nextSibling:n.previousSibling;if(r){n=r;if(n.hasChildren||n.call.isDrawingCall)break}else{n=n.parent;if(!e)break}}!n&&e?this._onReplayLastStepClick():(n||t).revealAndSelect()},_onReplayFirstStepClick:function(){var e=this._logGrid.rootNode().children[0];e&&e.revealAndSelect()},_onReplayLastStepClick:function(){var e=this._logGrid.rootNode().children.peekLast();if(!e)return;while(e.expanded){var t=e.children.peekLast();if(!t)break;e=t}e.revealAndSelect()},_enableWaitIcon:function(e){this._spinnerIcon.enableStyleClass("hidden",!e),this._debugInfoElement.enableStyleClass("hidden",e)},_replayTraceLog:function(){function t(t,n){delete this._pendingReplayTraceLogEvent,this._enableWaitIcon(!1),this._debugInfoElement.textContent="Replay time: "+Number.secondsToString(n/1e3,!0),this._onReplayContextChanged(),e!==this._selectedCallIndex()&&this._replayTraceLog()}if(this._pendingReplayTraceLogEvent)return;var e=this._selectedCallIndex();if(e===-1||e===this._lastReplayCallIndex)return;this._lastReplayCallIndex=e,this._pendingReplayTraceLogEvent=!0,this._enableWaitIcon(!0),this._traceLogPlayer.replayTraceLog(e,t.bind(this))},_requestTraceLog:function(e){function t(e){this._enableWaitIcon(!1);if(!e)return;var t=[],n=e.calls,r=e.startOffset;for(var i=0,s=n.length;i<s;++i)t.push(this._createCallNode(r++,n[i]));var o=e.contexts;for(var i=0,s=o.length;i<s;++i){var u=o[i].resourceId||"",a=o[i].description||"";if(this._replayContexts[u])continue;this._replayContexts[u]=!0,this._replayContextSelector.createOption(a,WebInspector.UIString("Show screenshot of this context's canvas."),u)}this._appendCallNodes(t),e.alive?setTimeout(this._requestTraceLog.bind(this,r),WebInspector.CanvasProfileView.TraceLogPollingInterval):this._flattenSingleFrameNode(),this._profile._updateCapturingStatus(e),this._onReplayLastStepClick()}this._enableWaitIcon(!0),this._traceLogPlayer.getTraceLog(e,undefined,t.bind(this))},_selectedCallIndex:function(){var e=this._logGrid.selectedNode;return e?this._peekLastRecursively(e).index:-1},_peekLastRecursively:function(e){var t;while(t=e.children.peekLast())e=t;return e},_appendCallNodes:function(e){var t=this._logGrid.rootNode(),n=t.children.peekLast();n&&this._peekLastRecursively(n).call.isFrameEndCall&&(n=null);for(var r=0,i=e.length;r<i;++r){if(!n){var s=t.children.length,o={};o[0]="",o[1]="Frame #"+(s+1),o[2]="",n=new WebInspector.DataGridNode(o),n.selectable=!0,t.appendChild(n)}var u=r+1;while(u<i&&!e[u-1].call.isFrameEndCall)++u;this._appendCallNodesToFrameNode(n,e,r,u),r=u-1,n=null}},_appendCallNodesToFrameNode:function(e,t,n,r){function s(){var t=i._drawCallGroupsCount||0,n={};n[0]="",n[1]="Draw call group #"+(t+1),n[2]="";var r=new WebInspector.DataGridNode(n);return r.selectable=!0,i._drawCallGroupsCount=t+1,e.appendChild(r),r}function o(e){var t=0,n;while(n=e.children[t]){if(n.call.isDrawingCall)break;++t}var r=s(),i;while(i=e.children[t+1])r.appendChild(i);return r}var i=this,u=e.children.peekLast(),a=!1;if(u){for(var f=0,l=u.children.length;f<l;++f)if(u.children[f].call.isDrawingCall){a=!0;break}}else u=s();for(var f=n;f<r;++f){var c=t[f];u.appendChild(c),c.call.isDrawingCall&&(a?u=o(u):a=!0)}},_createCallNode:function(e,t){var n=document.createElement("div"),r={};r[0]=e+1,r[1]=n,r[2]="";if(t.sourceURL){var i=Math.max(0,t.lineNumber-1)||0,s=Math.max(0,t.columnNumber-1)||0;r[2]=this._linkifier.linkifyLocation(t.sourceURL,i,s)}n.createChild("span","canvas-function-name").textContent=t.functionName||"context."+t.property;if(t.arguments){n.createTextChild("(");for(var o=0,u=t.arguments.length;o<u;++o){var a=t.arguments[o];o&&n.createTextChild(", ");var f=WebInspector.CanvasProfileDataGridHelper.createCallArgumentElement(a);f.__argumentIndex=o,n.appendChild(f)}n.createTextChild(")")}else t.value&&(n.createTextChild(" = "),n.appendChild(WebInspector.CanvasProfileDataGridHelper.createCallArgumentElement(t.value)));t.result&&(n.createTextChild(" => "),n.appendChild(WebInspector.CanvasProfileDataGridHelper.createCallArgumentElement(t.result)));var l=new WebInspector.DataGridNode(r);return l.index=e,l.selectable=!0,l.call=t,l},_popoverAnchor:function(e,t){var n=e.enclosingNodeOrSelfWithClass("canvas-call-argument");return!n||n.__suppressPopover?null:n},_resolveObjectForPopover:function(e,t,n){function r(n,r,i){if(n)return;if(!r)return;this._popoverAnchorElement=e.cloneNode(!0),this._popoverAnchorElement.addStyleClass("canvas-popover-anchor"),this._popoverAnchorElement.addStyleClass("source-frame-eval-expression"),e.parentElement.appendChild(this._popoverAnchorElement);var s=this._popoverAnchorElement.boxInWindow().x-e.boxInWindow().x;this._popoverAnchorElement.style.left=this._popoverAnchorElement.offsetLeft-s+"px",t(WebInspector.RemoteObject.fromPayload(r),!1,this._popoverAnchorElement)}var i=e.__evalResult;if(i)r.call(this,null,i);else{var s=this._logGrid.dataGridNodeFromNode(e);if(!s||typeof s.index!="number"){this._popoverHelper.hidePopover();return}var o=s.index,u=e.__argumentIndex;typeof u!="number"&&(u=-1),CanvasAgent.evaluateTraceLogCallArgument(this._traceLogId,o,u,n,r.bind(this))}},_hexNumbersFormatter:function(e){if(e.type==="number"){var t="0000"+Number(e.description).toString(16).toUpperCase();return t=t.replace(/^0+(.{4,})$/,"$1"),"0x"+t}return e.description||""},_onHidePopover:function(){this._popoverAnchorElement&&(this._popoverAnchorElement.remove(),delete this._popoverAnchorElement)},_flattenSingleFrameNode:function(){var e=this._logGrid.rootNode();if(e.children.length!==1)return;var t=e.children[0];while(t.children[0])e.appendChild(t.children[0]);e.removeChild(t)},__proto__:WebInspector.View.prototype},WebInspector.CanvasProfileType=function(){WebInspector.ProfileType.call(this,WebInspector.CanvasProfileType.TypeId,WebInspector.UIString("Capture Canvas Frame")),this._nextProfileUid=1,this._recording=!1,this._lastProfileHeader=null,this._capturingModeSelector=new WebInspector.StatusBarComboBox(this._dispatchViewUpdatedEvent.bind(this)),this._capturingModeSelector.element.title=WebInspector.UIString("Canvas capture mode."),this._capturingModeSelector.createOption(WebInspector.UIString("Single Frame"),WebInspector.UIString("Capture a single canvas frame."),""),this._capturingModeSelector.createOption(WebInspector.UIString("Consecutive Frames"),WebInspector.UIString("Capture consecutive canvas frames."),"1"),this._frameOptions={},this._framesWithCanvases={},this._frameSelector=new WebInspector.StatusBarComboBox(this._dispatchViewUpdatedEvent.bind(this)),this._frameSelector.element.title=WebInspector.UIString("Frame containing the canvases to capture."),this._frameSelector.element.addStyleClass("hidden"),WebInspector.runtimeModel.contextLists().forEach(this._addFrame,this),WebInspector.runtimeModel.addEventListener(WebInspector.RuntimeModel.Events.FrameExecutionContextListAdded,this._frameAdded,this),WebInspector.runtimeModel.addEventListener(WebInspector.RuntimeModel.Events.FrameExecutionContextListRemoved,this._frameRemoved,this),this._dispatcher=new WebInspector.CanvasDispatcher(this),this._canvasAgentEnabled=!1,this._decorationElement=document.createElement("div"),this._decorationElement.className="profile-canvas-decoration",this._updateDecorationElement()},WebInspector.CanvasProfileType.TypeId="CANVAS_PROFILE",WebInspector.CanvasProfileType.prototype={get statusBarItems(){return[this._capturingModeSelector.element,this._frameSelector.element]},get buttonTooltip(){return this._isSingleFrameMode()?WebInspector.UIString("Capture next canvas frame."):this._recording?WebInspector.UIString("Stop capturing canvas frames."):WebInspector.UIString("Start capturing canvas frames.")},buttonClicked:function(){return this._canvasAgentEnabled?(this._recording?(this._recording=!1,this._stopFrameCapturing()):this._isSingleFrameMode()?(this._recording=!1,this._runSingleFrameCapturing()):(this._recording=!0,this._startFrameCapturing()),this._recording):!1},_runSingleFrameCapturing:function(){var e=this._selectedFrameId();CanvasAgent.captureFrame(e,this._didStartCapturingFrame.bind(this,e))},_startFrameCapturing:function(){var e=this._selectedFrameId();CanvasAgent.startCapturing(e,this._didStartCapturingFrame.bind(this,e))},_stopFrameCapturing:function(){function n(){e._updateCapturingStatus()}if(!this._lastProfileHeader)return;var e=this._lastProfileHeader,t=e.traceLogId();this._lastProfileHeader=null,CanvasAgent.stopCapturing(t,n.bind(this))},_didStartCapturingFrame:function(e,t,n){if(t||this._lastProfileHeader&&this._lastProfileHeader.traceLogId()===n)return;var r=new WebInspector.CanvasProfileHeader(this,WebInspector.UIString("Trace Log %d",this._nextProfileUid),this._nextProfileUid,n,e);++this._nextProfileUid,this._lastProfileHeader=r,this.addProfile(r),r._updateCapturingStatus()},get treeItemTitle(){return WebInspector.UIString("CANVAS PROFILE")},get description(){return WebInspector.UIString("Canvas calls instrumentation")},decorationElement:function(){return this._decorationElement},_reset:function(){WebInspector.ProfileType.prototype._reset.call(this),this._nextProfileUid=1},removeProfile:function(e){WebInspector.ProfileType.prototype.removeProfile.call(this,e),this._recording&&e===this._lastProfileHeader&&(this._recording=!1)},setRecordingProfile:function(e){this._recording=e},createTemporaryProfile:function(e){return e=e||WebInspector.UIString("Capturing…"),new WebInspector.CanvasProfileHeader(this,e)},createProfile:function(e){return new WebInspector.CanvasProfileHeader(this,e.title,-1)},_updateDecorationElement:function(e){this._decorationElement.removeChildren(),this._decorationElement.createChild("div","warning-icon-small"),this._decorationElement.appendChild(document.createTextNode(this._canvasAgentEnabled?WebInspector.UIString("Canvas Profiler is enabled."):WebInspector.UIString("Canvas Profiler is disabled.")));var t=this._decorationElement.createChild("button");t.type="button",t.textContent=this._canvasAgentEnabled?WebInspector.UIString("Disable"):WebInspector.UIString("Enable"),t.addEventListener("click",this._onProfilerEnableButtonClick.bind(this,!this._canvasAgentEnabled),!1);if(e)if(this._canvasAgentEnabled){function n(e,t){(e||t)&&PageAgent.reload()}CanvasAgent.hasUninstrumentedCanvases(n.bind(this))}else for(var r in this._framesWithCanvases)if(this._framesWithCanvases.hasOwnProperty(r)){PageAgent.reload();break}},_onProfilerEnableButtonClick:function(e){function t(t){if(t)return;this._canvasAgentEnabled=e,this._updateDecorationElement(!0),this._dispatchViewUpdatedEvent()}if(this._canvasAgentEnabled===e)return;e?CanvasAgent.enable(t.bind(this)):CanvasAgent.disable(t.bind(this))},_isSingleFrameMode:function(){return!this._capturingModeSelector.selectedOption().value},_frameAdded:function(e){var t=e.data;this._addFrame(t)},_addFrame:function(e){var t=e.frameId,n=document.createElement("option");n.text=e.displayName,n.title=e.url,n.value=t,this._frameOptions[t]=n,this._framesWithCanvases[t]&&(this._frameSelector.addOption(n),this._dispatchViewUpdatedEvent())},_frameRemoved:function(e){var t=e.data,n=t.frameId,r=this._frameOptions[n];r&&this._framesWithCanvases[n]&&(this._frameSelector.removeOption(r),this._dispatchViewUpdatedEvent()),delete this._frameOptions[n],delete this._framesWithCanvases[n]},_contextCreated:function(e){if(this._framesWithCanvases[e])return;this._framesWithCanvases[e]=!0;var t=this._frameOptions[e];t&&(this._frameSelector.addOption(t),this._dispatchViewUpdatedEvent())},_traceLogsRemoved:function(e,t){var n=[],r=this.treeElement&&this.treeElement.children||[];for(var i=0,s=r.length;i<s;++i){var o=r[i].profile;if(!o)continue;if(e&&e!==o.frameId())continue;if(t&&t!==o.traceLogId())continue;n.push(r[i])}for(var i=0,s=n.length;i<s;++i)n[i].ondelete()},_selectedFrameId:function(){var e=this._frameSelector.selectedOption();return e?e.value:undefined},_dispatchViewUpdatedEvent:function(){this._frameSelector.element.enableStyleClass("hidden",this._frameSelector.size()<=1),this.dispatchEventToListeners(WebInspector.ProfileType.Events.ViewUpdated)},isInstantProfile:function(){return this._isSingleFrameMode()},isEnabled:function(){return this._canvasAgentEnabled},__proto__:WebInspector.ProfileType.prototype},WebInspector.CanvasDispatcher=function(e){this._profileType=e,InspectorBackend.registerCanvasDispatcher(this)},WebInspector.CanvasDispatcher.prototype={contextCreated:function(e){this._profileType._contextCreated(e)},traceLogsRemoved:function(e,t){this._profileType._traceLogsRemoved(e,t)}},WebInspector.CanvasProfileHeader=function(e,t,n,r,i){WebInspector.ProfileHeader.call(this,e,t,n),this._traceLogId=r||"",this._frameId=i,this._alive=!0,this._traceLogSize=0,this._traceLogPlayer=r?new WebInspector.CanvasTraceLogPlayerProxy(r):null},WebInspector.CanvasProfileHeader.prototype={traceLogId:function(){return this._traceLogId},traceLogPlayer:function(){return this._traceLogPlayer},frameId:function(){return this._frameId},createSidebarTreeElement:function(){return new WebInspector.ProfileSidebarTreeElement(this,WebInspector.UIString("Trace Log %d"),"profile-sidebar-tree-item")},createView:function(e){return new WebInspector.CanvasProfileView(this)},dispose:function(){this._traceLogPlayer&&this._traceLogPlayer.dispose(),clearTimeout(this._requestStatusTimer),this._alive=!1},_updateCapturingStatus:function(e){if(!this.sidebarElement||!this._traceLogId)return;e&&(this._alive=e.alive,this._traceLogSize=e.totalAvailableCalls),this.sidebarElement.subtitle=this._alive?WebInspector.UIString("Capturing… %d calls",this._traceLogSize):WebInspector.UIString("Captured %d calls",this._traceLogSize),this.sidebarElement.wait=this._alive,this._alive&&(clearTimeout(this._requestStatusTimer),this._requestStatusTimer=setTimeout(this._requestCapturingStatus.bind(this),WebInspector.CanvasProfileView.TraceLogPollingInterval))},_requestCapturingStatus:function(){function e(e){if(!e)return;this._alive=e.alive,this._traceLogSize=e.totalAvailableCalls,this._updateCapturingStatus()}this._traceLogPlayer.getTraceLog(0,0,e.bind(this))},__proto__:WebInspector.ProfileHeader.prototype},WebInspector.CanvasProfileDataGridHelper={createCallArgumentElement:function(e){if(e.enumName)return WebInspector.CanvasProfileDataGridHelper.createEnumValueElement(e.enumName,+e.description);var t=document.createElement("span");t.className="canvas-call-argument";var n=e.description;if(e.type==="string"){const r=150;t.createTextChild('"'),t.createChild("span","canvas-formatted-string").textContent=n.trimMiddle(r),t.createTextChild('"'),t.__suppressPopover=n.length<=r&&!/[\r\n]/.test(n),t.__suppressPopover||(t.__evalResult=WebInspector.RemoteObject.fromPrimitiveValue(n))}else{var i=e.subtype||e.type;i&&(t.addStyleClass("canvas-formatted-"+i),["null","undefined","boolean","number"].indexOf(i)>=0&&(t.__suppressPopover=!0)),t.textContent=n,e.remoteObject&&(t.__evalResult=WebInspector.RemoteObject.fromPayload(e.remoteObject))}return e.resourceId&&(t.addStyleClass("canvas-formatted-resource"),t.__resourceId=e.resourceId),t},createEnumValueElement:function(e,t){var n=document.createElement("span");return n.className="canvas-call-argument canvas-formatted-number",n.textContent=e,n.__evalResult=WebInspector.RemoteObject.fromPrimitiveValue(t),n}},WebInspector.CanvasTraceLogPlayerProxy=function(e){this._traceLogId=e,this._currentResourceStates={},this._defaultResourceId=null},WebInspector.CanvasTraceLogPlayerProxy.Events={CanvasTraceLogReceived:"CanvasTraceLogReceived",CanvasReplayStateChanged:"CanvasReplayStateChanged",CanvasResourceStateReceived:"CanvasResourceStateReceived"},WebInspector.CanvasTraceLogPlayerProxy.prototype={getTraceLog:function(e,t,n){function r(e,t){if(e||!t){n(null);return}n(t),this.dispatchEventToListeners(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasTraceLogReceived,t)}CanvasAgent.getTraceLog(this._traceLogId,e,t,r.bind(this))},dispose:function(){this._currentResourceStates={},CanvasAgent.dropTraceLog(this._traceLogId),this.dispatchEventToListeners(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasReplayStateChanged)},getResourceState:function(e,t){function n(n,r){if(n||!r){t(null);return}this._currentResourceStates[e]=r,t(r),this.dispatchEventToListeners(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasResourceStateReceived,r)}e=e||this._defaultResourceId;if(!e){t(null);return}if(this._currentResourceStates[e]){t(this._currentResourceStates[e]);return}CanvasAgent.getResourceState(this._traceLogId,e,n.bind(this))},replayTraceLog:function(e,t){function n(e,n,r){this._currentResourceStates={},e||!n?(n=null,t(null,r)):(this._defaultResourceId=n.id,this._currentResourceStates[n.id]=n,t(n,r)),this.dispatchEventToListeners(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasReplayStateChanged),n&&this.dispatchEventToListeners(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasResourceStateReceived,n)}CanvasAgent.replayTraceLog(this._traceLogId,e,n.bind(this))},clearResourceStates:function(){this._currentResourceStates={},this.dispatchEventToListeners(WebInspector.CanvasTraceLogPlayerProxy.Events.CanvasReplayStateChanged)},__proto__:WebInspector.Object.prototype};