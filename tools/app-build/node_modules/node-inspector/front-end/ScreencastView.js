/*
 * Copyright (C) 2013 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.ScreencastView=function(){WebInspector.View.call(this),this.registerRequiredCSS("screencastView.css"),this.element.addStyleClass("fill"),this.element.addStyleClass("screencast"),this._viewportElement=this.element.createChild("div","screencast-viewport hidden"),this._canvasElement=this._viewportElement.createChild("canvas"),this._canvasElement.tabIndex=1,this._canvasElement.addEventListener("mousedown",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("mouseup",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("mousemove",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("mousewheel",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("click",this._handleMouseEvent.bind(this),!1),this._canvasElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),this._canvasElement.addEventListener("keydown",this._handleKeyEvent.bind(this),!1),this._canvasElement.addEventListener("keyup",this._handleKeyEvent.bind(this),!1),this._canvasElement.addEventListener("keypress",this._handleKeyEvent.bind(this),!1),this._titleElement=this._viewportElement.createChild("div","screencast-element-title monospace hidden"),this._tagNameElement=this._titleElement.createChild("span","screencast-tag-name"),this._nodeIdElement=this._titleElement.createChild("span","screencast-node-id"),this._classNameElement=this._titleElement.createChild("span","screencast-class-name"),this._titleElement.appendChild(document.createTextNode(" ")),this._nodeWidthElement=this._titleElement.createChild("span"),this._titleElement.createChild("span","screencast-px").textContent="px",this._titleElement.appendChild(document.createTextNode(" × ")),this._nodeHeightElement=this._titleElement.createChild("span"),this._titleElement.createChild("span","screencast-px").textContent="px",this._imageElement=new Image,this._isCasting=!1,this._context=this._canvasElement.getContext("2d"),this._checkerboardPattern=this._createCheckerboardPattern(this._context),WebInspector.resourceTreeModel.addEventListener(WebInspector.ResourceTreeModel.EventTypes.ScreencastFrame,this._screencastFrame,this)},WebInspector.ScreencastView._bordersSize=40,WebInspector.ScreencastView.prototype={wasShown:function(){this._startCasting()},willHide:function(){this._stopCasting()},_startCasting:function(){if(this._isCasting)return;this._isCasting=!0;const e=800;var t=this._viewportDimensions();if(t.width<0||t.height<0){this._isCasting=!1;return}PageAgent.startScreencast("jpeg",80,Math.min(e,t.width),Math.min(e,t.height)),WebInspector.domAgent.setHighlighter(this)},_stopCasting:function(){if(!this._isCasting)return;this._isCasting=!1,PageAgent.stopScreencast(),WebInspector.domAgent.setHighlighter(null)},_screencastFrame:function(e){var t=e.data.data;this._imageElement.src="data:image/jpg;base64,"+t,this._deviceScaleFactor=e.data.deviceScaleFactor,this._pageScaleFactor=e.data.pageScaleFactor,this._viewport=e.data.viewport;if(!this._viewport)return;var n=e.data.offsetTop||0,r=e.data.offsetBottom||0,i=this._viewport.width*this._pageScaleFactor,s=this._viewport.height*this._pageScaleFactor+n+r;this._screenOffsetTop=n,this._resizeViewport(i,s),this._imageZoom=this._imageElement.naturalWidth?this._canvasElement.offsetWidth/this._imageElement.naturalWidth:1,this.highlightDOMNode(this._highlightNodeId,this._highlightConfig)},_resizeViewport:function(e,t){var n=this._viewportDimensions();this._screenZoom=Math.min(n.width/e,n.height/t);var r=WebInspector.ScreencastView._bordersSize;this._viewportElement.removeStyleClass("hidden"),this._viewportElement.style.width=e*this._screenZoom+r+"px",this._viewportElement.style.height=t*this._screenZoom+r+"px"},_handleMouseEvent:function(e){function n(t,n){if(t)return;e.type==="mousemove"?this.highlightDOMNode(n,this._inspectModeConfig):e.type==="click"&&WebInspector.domAgent.dispatchEventToListeners(WebInspector.DOMAgent.Events.InspectNodeRequested,n)}if(!this._viewport)return;if(!this._inspectModeConfig||e.type==="mousewheel"){this._simulateTouchGestureForMouseEvent(e);return}var t=this._convertIntoScreenSpace(e);DOMAgent.getNodeForLocation(t.x/this._pageScaleFactor,t.y/this._pageScaleFactor,n.bind(this))},_handleKeyEvent:function(e){var t;switch(e.type){case"keydown":t="keyDown";break;case"keyup":t="keyUp";break;case"keypress":t="char";break;default:return}var n=e.type==="keypress"?String.fromCharCode(e.charCode):undefined;InputAgent.dispatchKeyEvent(t,this._modifiersForEvent(e),e.timeStamp/1e3,n,n?n.toLowerCase():undefined,e.keyIdentifier,e.keyCode,e.keyCode,undefined,!1,!1,!1),e.consume(),this._canvasElement.focus()},_handleContextMenuEvent:function(e){e.consume(!0)},_simulateTouchGestureForMouseEvent:function(e){var t=this._convertIntoScreenSpace(e),n=e.timeStamp/1e3,r=t.x,i=t.y;switch(e.which){case 1:if(e.type==="mousedown")InputAgent.dispatchGestureEvent("scrollBegin",r,i,n);else if(e.type==="mousemove"){var s=this._lastScrollPosition?t.x-this._lastScrollPosition.x:0,o=this._lastScrollPosition?t.y-this._lastScrollPosition.y:0;(s||o)&&InputAgent.dispatchGestureEvent("scrollUpdate",r,i,n,s,o)}else e.type==="mouseup"?InputAgent.dispatchGestureEvent("scrollEnd",r,i,n):e.type==="mousewheel"?(InputAgent.dispatchGestureEvent("scrollBegin",r,i,n),InputAgent.dispatchGestureEvent("scrollUpdate",r,i,n,e.wheelDeltaX,e.wheelDeltaY),InputAgent.dispatchGestureEvent("scrollEnd",r,i,n)):e.type==="click"&&(InputAgent.dispatchGestureEvent("tapDown",r,i,n),InputAgent.dispatchGestureEvent("tap",r,i,n));this._lastScrollPosition=t;break;case 2:e.type==="mousedown"?InputAgent.dispatchGestureEvent("tapDown",r,i,n):e.type==="mouseup"&&InputAgent.dispatchGestureEvent("tap",r,i,n);break;case 3:if(e.type==="mousedown")this._pinchStart=t,InputAgent.dispatchGestureEvent("pinchBegin",r,i,n);else if(e.type==="mousemove"){var s=this._pinchStart?t.x-this._pinchStart.x:0,o=this._pinchStart?t.y-this._pinchStart.y:0;if(s||o){var u=Math.pow(o<0?.999:1.001,Math.abs(o));InputAgent.dispatchGestureEvent("pinchUpdate",this._pinchStart.x,this._pinchStart.y,n,0,0,u)}}else e.type==="mouseup"&&InputAgent.dispatchGestureEvent("pinchEnd",r,i,n);break;case 0:default:}},_convertIntoScreenSpace:function(e){var t=this._canvasElement.offsetWidth/this._viewport.width/this._pageScaleFactor,n={};return n.x=Math.round(e.offsetX/t),n.y=Math.round(e.offsetY/t-this._screenOffsetTop),n},_modifiersForEvent:function(e){var t=0;return e.altKey&&(t=1),e.ctrlKey&&(t+=2),e.metaKey&&(t+=4),e.shiftKey&&(t+=8),t},onResize:function(){this._deferredCasting&&(clearTimeout(this._deferredCasting),delete this._deferredCasting),this._stopCasting(),this._deferredCasting=setTimeout(this._startCasting.bind(this),100)},highlightDOMNode:function(e,t,n){function r(e,n){if(e){this._repaint();return}this._model=this._scaleModel(n),this._config=t,this._repaint()}this._highlightNodeId=e,this._highlightConfig=t;if(!e){this._model=null,this._config=null,this._node=null,this._titleElement.addStyleClass("hidden"),this._repaint();return}this._node=WebInspector.domAgent.nodeForId(e),DOMAgent.getBoxModel(e,r.bind(this))},_scaleModel:function(e){function n(e){for(var n=0;n<e.length;n+=2)e[n]=(e[n]-this._viewport.x)*t,e[n+1]=(e[n+1]-this._viewport.y)*t+this._screenOffsetTop*this._screenZoom}var t=this._canvasElement.offsetWidth/this._viewport.width;return n.call(this,e.content),n.call(this,e.padding),n.call(this,e.border),n.call(this,e.margin),e},_repaint:function(){var e=this._model,t=this._config;this._canvasElement.width=window.devicePixelRatio*this._canvasElement.offsetWidth,this._canvasElement.height=window.devicePixelRatio*this._canvasElement.offsetHeight,this._context.save(),this._context.scale(window.devicePixelRatio,window.devicePixelRatio),this._context.save(),this._context.fillStyle=this._checkerboardPattern,this._context.fillRect(0,0,this._canvasElement.offsetWidth,this._screenOffsetTop*this._screenZoom),this._context.fillRect(0,this._screenOffsetTop*this._screenZoom+this._imageElement.naturalHeight*this._imageZoom,this._canvasElement.offsetWidth,this._canvasElement.offsetHeight),this._context.restore();if(e&&t){this._context.save();const n="rgba(0, 0, 0, 0)";var r=e.content&&t.contentColor!==n,i=e.padding&&t.paddingColor!==n,s=e.border&&t.borderColor!==n,o=e.margin&&t.marginColor!==n,u;o&&(!s||!this._quadsAreEqual(e.margin,e.border))&&(this._drawOutlinedQuadWithClip(e.margin,e.border,t.marginColor),u=e.border),s&&(!i||!this._quadsAreEqual(e.border,e.padding))&&(this._drawOutlinedQuadWithClip(e.border,e.padding,t.borderColor),u=e.padding),i&&(!r||!this._quadsAreEqual(e.padding,e.content))&&(this._drawOutlinedQuadWithClip(e.padding,e.content,t.paddingColor),u=e.content),r&&this._drawOutlinedQuad(e.content,t.contentColor),this._context.restore(),this._drawElementTitle(),this._context.globalCompositeOperation="destination-over"}this._context.drawImage(this._imageElement,0,this._screenOffsetTop*this._screenZoom,this._imageElement.naturalWidth*this._imageZoom,this._imageElement.naturalHeight*this._imageZoom),this._context.restore()},_quadsAreEqual:function(e,t){for(var n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0},_cssColor:function(e){return e?WebInspector.Color.fromRGBA([e.r,e.g,e.b,e.a]).toString(WebInspector.Color.Format.RGBA)||"":"transparent"},_quadToPath:function(e){return this._context.beginPath(),this._context.moveTo(e[0],e[1]),this._context.lineTo(e[2],e[3]),this._context.lineTo(e[4],e[5]),this._context.lineTo(e[6],e[7]),this._context.closePath(),this._context},_drawOutlinedQuad:function(e,t){this._context.save(),this._context.lineWidth=2,this._quadToPath(e).clip(),this._context.fillStyle=this._cssColor(t),this._context.fill(),this._context.restore()},_drawOutlinedQuadWithClip:function(e,t,n){this._context.fillStyle=this._cssColor(n),this._context.save(),this._context.lineWidth=0,this._quadToPath(e).fill(),this._context.globalCompositeOperation="destination-out",this._context.fillStyle="red",this._quadToPath(t).fill(),this._context.restore()},_drawElementTitle:function(){if(!this._node)return;var e=this._canvasElement.offsetWidth,t=this._canvasElement.offsetHeight,n=this._node.localName()||this._node.nodeName().toLowerCase();this._tagNameElement.textContent=n,this._nodeIdElement.textContent=this._node.getAttribute("id")?"#"+this._node.getAttribute("id"):"",this._nodeIdElement.textContent=this._node.getAttribute("id")?"#"+this._node.getAttribute("id"):"";var r=this._node.getAttribute("class");r&&r.length>50&&(r=r.substring(0,50)+"…"),this._classNameElement.textContent=r||"",this._nodeWidthElement.textContent=this._model.width,this._nodeHeightElement.textContent=this._model.height;var i=this._model.margin,s=this._titleElement.offsetWidth+6,o=this._titleElement.offsetHeight+4,u=this._model.margin[1],a=this._model.margin[7];const f=7;var l=!1,c=!1,h=Math.max(2,this._model.margin[0]);h+s>e&&(h=e-s-2);var p;u>t?(p=t-o-f,c=!0):a<0?(p=f,l=!0):a+o+f<t?(p=a+f-4,l=!0):u-o-f>0?(p=u-o-f+3,c=!0):p=f,this._context.save(),this._context.translate(.5,.5),this._context.beginPath(),this._context.moveTo(h,p),l&&(this._context.lineTo(h+2*f,p),this._context.lineTo(h+3*f,p-f),this._context.lineTo(h+4*f,p)),this._context.lineTo(h+s,p),this._context.lineTo(h+s,p+o),c&&(this._context.lineTo(h+4*f,p+o),this._context.lineTo(h+3*f,p+o+f),this._context.lineTo(h+2*f,p+o)),this._context.lineTo(h,p+o),this._context.closePath(),this._context.fillStyle="rgb(255, 255, 194)",this._context.fill(),this._context.strokeStyle="rgb(128, 128, 128)",this._context.stroke(),this._context.restore(),this._titleElement.removeStyleClass("hidden"),this._titleElement.style.top=p+3+"px",this._titleElement.style.left=h+3+"px"},_viewportDimensions:function(){const e=30,t=WebInspector.ScreencastView._bordersSize;return{width:this.element.offsetWidth-t-e,height:this.element.offsetHeight-t-e}},setInspectModeEnabled:function(e,t,n,r){this._inspectModeConfig=e?n:null,r(null)},_createCheckerboardPattern:function(e){var t=document.createElement("canvas");const n=32;t.width=n*2,t.height=n*2;var r=t.getContext("2d");return r.fillStyle="rgb(195, 195, 195)",r.fillRect(0,0,n*2,n*2),r.fillStyle="rgb(225, 225, 225)",r.fillRect(0,0,n,n),r.fillRect(n,n,n,n),e.createPattern(t,"repeat")},__proto__:WebInspector.View.prototype};