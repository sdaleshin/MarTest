/*
 * Copyright (C) 2011 Google Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

WebInspector.HandlerRegistry=function(e){WebInspector.Object.call(this),this._handlers={},this._setting=e,this._activeHandler=this._setting.get(),WebInspector.ContextMenu.registerProvider(this)},WebInspector.HandlerRegistry.prototype={get handlerNames(){return Object.getOwnPropertyNames(this._handlers)},get activeHandler(){return this._activeHandler},set activeHandler(e){this._activeHandler=e,this._setting.set(e)},dispatch:function(e){return this.dispatchToHandler(this._activeHandler,e)},dispatchToHandler:function(e,t){var n=this._handlers[e],r=n&&n(t);return!!r},registerHandler:function(e,t){this._handlers[e]=t,this.dispatchEventToListeners(WebInspector.HandlerRegistry.EventTypes.HandlersUpdated)},unregisterHandler:function(e){delete this._handlers[e],this.dispatchEventToListeners(WebInspector.HandlerRegistry.EventTypes.HandlersUpdated)},appendApplicableItems:function(e,t,n){this._appendContentProviderItems(t,n),this._appendHrefItems(t,n)},_appendContentProviderItems:function(e,t){function o(e,t){var r=n.contentURL();WebInspector.fileManager.save(r,t,e),WebInspector.fileManager.close(r)}function u(e){if(n instanceof WebInspector.UISourceCode){var t=n;t.saveToFileSystem(e);return}n.requestContent(o.bind(this,e))}if(!(t instanceof WebInspector.UISourceCode||t instanceof WebInspector.Resource||t instanceof WebInspector.NetworkRequest))return;var n=t;if(!n.contentURL())return;e.appendItem(WebInspector.openLinkExternallyLabel(),WebInspector.openResource.bind(WebInspector,n.contentURL(),!1));for(var r=1;r<this.handlerNames.length;++r){var i=this.handlerNames[r];e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Open using %s":"Open Using %s",i),this.dispatchToHandler.bind(this,i,{url:n.contentURL()}))}e.appendItem(WebInspector.copyLinkAddressLabel(),InspectorFrontendHost.copyText.bind(InspectorFrontendHost,n.contentURL()));if(!n.contentURL())return;var s=n.contentType();if(s!==WebInspector.resourceTypes.Document&&s!==WebInspector.resourceTypes.Stylesheet&&s!==WebInspector.resourceTypes.Script)return;e.appendSeparator(),e.appendItem(WebInspector.UIString("Save"),u.bind(this,!1)),e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Save as...":"Save As..."),u.bind(this,!0))},_appendHrefItems:function(e,t){if(!(t instanceof Node))return;var n=t,r=n.enclosingNodeOrSelfWithClass("webkit-html-resource-link")||n.enclosingNodeOrSelfWithClass("webkit-html-external-link");if(!r)return;var i=r.href;if(!i)return;e.appendItem(WebInspector.openLinkExternallyLabel(),WebInspector.openResource.bind(WebInspector,i,!1)),WebInspector.resourceForURL(i)&&e.appendItem(WebInspector.UIString(WebInspector.useLowerCaseMenuTitles()?"Open link in Resources panel":"Open Link in Resources Panel"),WebInspector.openResource.bind(null,i,!0)),e.appendItem(WebInspector.copyLinkAddressLabel(),InspectorFrontendHost.copyText.bind(InspectorFrontendHost,i))},__proto__:WebInspector.Object.prototype},WebInspector.HandlerRegistry.EventTypes={HandlersUpdated:"HandlersUpdated"},WebInspector.HandlerSelector=function(e){this._handlerRegistry=e,this.element=document.createElement("select"),this.element.addEventListener("change",this._onChange.bind(this),!1),this._update(),this._handlerRegistry.addEventListener(WebInspector.HandlerRegistry.EventTypes.HandlersUpdated,this._update.bind(this))},WebInspector.HandlerSelector.prototype={_update:function(){this.element.removeChildren();var e=this._handlerRegistry.handlerNames,t=this._handlerRegistry.activeHandler;for(var n=0;n<e.length;++n){var r=document.createElement("option");r.textContent=e[n],r.selected=t===e[n],this.element.appendChild(r)}this.element.disabled=e.length<=1},_onChange:function(e){var t=e.target.value;this._handlerRegistry.activeHandler=t}},WebInspector.openAnchorLocationRegistry=null;