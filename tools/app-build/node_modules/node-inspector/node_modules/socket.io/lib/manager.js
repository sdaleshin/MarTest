/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function Manager(e,t){this.server=e,this.namespaces={},this.sockets=this.of(""),this.settings={origins:"*:*",log:!0,store:new MemoryStore,logger:new Logger,"static":new Static(this),heartbeats:!0,resource:"/socket.io",transports:defaultTransports,authorization:!1,blacklist:["disconnect"],"log level":3,"log colors":tty.isatty(process.stdout.fd),"close timeout":60,"heartbeat interval":25,"heartbeat timeout":60,"polling duration":20,"flash policy server":!0,"flash policy port":10843,"destroy upgrade":!0,"destroy buffer size":1e8,"browser client":!0,"browser client cache":!0,"browser client minification":!1,"browser client etag":!1,"browser client expires":31536e4,"browser client gzip":!1,"browser client handler":!1,"client store expiration":15,"match origin protocol":!1};for(var n in t)t.hasOwnProperty(n)&&(this.settings[n]=t[n]);var r=this;e.on("error",function(e){r.log.warn("error raised: "+e)}),this.initStore(),this.on("set:store",function(){r.initStore()}),this.oldListeners=e.listeners("request").splice(0),e.removeAllListeners("request"),e.on("request",function(e,t){r.handleRequest(e,t)}),e.on("upgrade",function(e,t,n){r.handleUpgrade(e,t,n)}),e.on("close",function(){clearInterval(r.gc)}),e.once("listening",function(){r.gc=setInterval(r.garbageCollection.bind(r),1e4)});for(var n in transports)transports.hasOwnProperty(n)&&transports[n].init&&transports[n].init(this);var r=this;this.sockets.on("connection",function(e){r.emit("connection",e)}),this.sequenceNumber=Date.now()|0,this.log.info("socket.io started")}var fs=require("fs"),url=require("url"),tty=require("tty"),crypto=require("crypto"),util=require("./util"),store=require("./store"),client=require("socket.io-client"),transports=require("./transports"),Logger=require("./logger"),Socket=require("./socket"),MemoryStore=require("./stores/memory"),SocketNamespace=require("./namespace"),Static=require("./static"),EventEmitter=process.EventEmitter;exports=module.exports=Manager;var defaultTransports=exports.defaultTransports=["websocket","htmlfile","xhr-polling","jsonp-polling"],parent=module.parent.exports,protocol=parent.protocol,jsonpolling_re=/^\d+$/;Manager.prototype.__proto__=EventEmitter.prototype,Manager.prototype.__defineGetter__("store",function(){var e=this.get("store");return e.manager=this,e}),Manager.prototype.__defineGetter__("log",function(){var e=this.get("logger");return e.level=this.get("log level")||-1,e.colors=this.get("log colors"),e.enabled=this.enabled("log"),e}),Manager.prototype.__defineGetter__("static",function(){return this.get("static")}),Manager.prototype.get=function(e){return this.settings[e]},Manager.prototype.set=function(e,t){return arguments.length==1?this.get(e):(this.settings[e]=t,this.emit("set:"+e,this.settings[e],e),this)},Manager.prototype.enable=function(e){return this.settings[e]=!0,this.emit("set:"+e,this.settings[e],e),this},Manager.prototype.disable=function(e){return this.settings[e]=!1,this.emit("set:"+e,this.settings[e],e),this},Manager.prototype.enabled=function(e){return!!this.settings[e]},Manager.prototype.disabled=function(e){return!this.settings[e]},Manager.prototype.configure=function(e,t){return"function"==typeof e?e.call(this):e==(process.env.NODE_ENV||"development")&&t.call(this),this},Manager.prototype.initStore=function(){this.handshaken={},this.connected={},this.open={},this.closed={},this.rooms={},this.roomClients={};var e=this;this.store.subscribe("handshake",function(t,n){e.onHandshake(t,n)}),this.store.subscribe("connect",function(t){e.onConnect(t)}),this.store.subscribe("open",function(t){e.onOpen(t)}),this.store.subscribe("join",function(t,n){e.onJoin(t,n)}),this.store.subscribe("leave",function(t,n){e.onLeave(t,n)}),this.store.subscribe("close",function(t){e.onClose(t)}),this.store.subscribe("dispatch",function(t,n,r,i){e.onDispatch(t,n,r,i)}),this.store.subscribe("disconnect",function(t){e.onDisconnect(t)})},Manager.prototype.onHandshake=function(e,t){this.handshaken[e]=t},Manager.prototype.onConnect=function(e){this.connected[e]=!0},Manager.prototype.onOpen=function(e){this.open[e]=!0;if(this.closed[e]){var t=this;this.store.unsubscribe("dispatch:"+e,function(){var n=t.transports[e];t.closed[e]&&t.closed[e].length&&n&&n.open&&(n.payload(t.closed[e]),t.closed[e]=[])})}this.transports[e]&&(this.transports[e].discard(),this.transports[e]=null)},Manager.prototype.onDispatch=function(e,t,n,r){if(this.rooms[e])for(var i=0,s=this.rooms[e].length;i<s;i++){var o=this.rooms[e][i];~r.indexOf(o)||(this.transports[o]&&this.transports[o].open?this.transports[o].onDispatch(t,n):n||this.onClientDispatch(o,t))}},Manager.prototype.onJoin=function(e,t){this.roomClients[e]||(this.roomClients[e]={}),this.rooms[t]||(this.rooms[t]=[]),~this.rooms[t].indexOf(e)||(this.rooms[t].push(e),this.roomClients[e][t]=!0)},Manager.prototype.onLeave=function(e,t){if(this.rooms[t]){var n=this.rooms[t].indexOf(e);n>=0&&this.rooms[t].splice(n,1),this.rooms[t].length||delete this.rooms[t],this.roomClients[e]&&delete this.roomClients[e][t]}},Manager.prototype.onClose=function(e){this.open[e]&&delete this.open[e],this.closed[e]=[];var t=this;this.store.subscribe("dispatch:"+e,function(n,r){r||t.onClientDispatch(e,n)})},Manager.prototype.onClientDispatch=function(e,t){this.closed[e]&&this.closed[e].push(t)},Manager.prototype.onClientMessage=function(e,t){this.namespaces[t.endpoint]&&this.namespaces[t.endpoint].handlePacket(e,t)},Manager.prototype.onClientDisconnect=function(e,t){for(var n in this.namespaces)this.namespaces.hasOwnProperty(n)&&this.namespaces[n].handleDisconnect(e,t,typeof this.roomClients[e]!="undefined"&&typeof this.roomClients[e][n]!="undefined");this.onDisconnect(e)},Manager.prototype.onDisconnect=function(e,t){delete this.handshaken[e],this.open[e]&&delete this.open[e],this.connected[e]&&delete this.connected[e],this.transports[e]&&(this.transports[e].discard(),delete this.transports[e]),this.closed[e]&&delete this.closed[e];if(this.roomClients[e]){for(var n in this.roomClients[e])this.roomClients[e].hasOwnProperty(n)&&this.onLeave(e,n);delete this.roomClients[e]}this.store.destroyClient(e,this.get("client store expiration")),this.store.unsubscribe("dispatch:"+e),t&&(this.store.unsubscribe("message:"+e),this.store.unsubscribe("disconnect:"+e))},Manager.prototype.handleRequest=function(e,t){var n=this.checkRequest(e);if(!n){for(var r=0,i=this.oldListeners.length;r<i;r++)this.oldListeners[r].call(this.server,e,t);return}if(n.static||!n.transport&&!n.protocol){n.static&&this.enabled("browser client")?this.static.write(n.path,e,t):(t.writeHead(200),t.end("Welcome to socket.io."),this.log.info("unhandled socket.io url"));return}n.protocol!=protocol?(t.writeHead(500),t.end("Protocol version not supported."),this.log.info("client protocol version unsupported")):n.id?this.handleHTTPRequest(n,e,t):this.handleHandshake(n,e,t)},Manager.prototype.handleUpgrade=function(e,t,n){var r=this.checkRequest(e),i=this;if(!r){this.enabled("destroy upgrade")&&(t.end(),this.log.debug("destroying non-socket.io upgrade"));return}e.head=n,this.handleClient(r,e),e.head=null},Manager.prototype.handleHTTPRequest=function(e,t,n){t.res=n,this.handleClient(e,t)},Manager.prototype.handleClient=function(e,t){var n=t.socket,r=this.store,i=this;if(undefined!=e.query.disconnect){this.transports[e.id]&&this.transports[e.id].open?this.transports[e.id].onForcedDisconnect():this.store.publish("disconnect-force:"+e.id),t.res.writeHead(200),t.res.end();return}if(!~this.get("transports").indexOf(e.transport)){this.log.warn('unknown transport: "'+e.transport+'"'),t.connection.end();return}var s=new transports[e.transport](this,e,t),o=this.handshaken[e.id];if(s.disconnected){t.connection.end();return}if(o){s.open&&(this.closed[e.id]&&this.closed[e.id].length&&(s.payload(this.closed[e.id]),this.closed[e.id]=[]),this.onOpen(e.id),this.store.publish("open",e.id),this.transports[e.id]=s);if(!this.connected[e.id]){this.onConnect(e.id),this.store.publish("connect",e.id),delete o.issued,this.onHandshake(e.id,o),this.store.publish("handshake",e.id,o);for(var u in this.namespaces)if(this.namespaces.hasOwnProperty(u)){var n=this.namespaces[u].socket(e.id,!0);u===""&&this.namespaces[u].handlePacket(e.id,{type:"connect"})}this.store.subscribe("message:"+e.id,function(t){i.onClientMessage(e.id,t)}),this.store.subscribe("disconnect:"+e.id,function(t){i.onClientDisconnect(e.id,t)})}}else s.open&&s.error("client not handshaken","reconnect"),s.discard()},Manager.prototype.generateId=function(){var e=new Buffer(15);return e.writeInt32BE?(this.sequenceNumber=this.sequenceNumber+1|0,e.writeInt32BE(this.sequenceNumber,11),crypto.randomBytes?crypto.randomBytes(12).copy(e):[0,4,8].forEach(function(t){e.writeInt32BE(Math.random()*Math.pow(2,32)|0,t)}),e.toString("base64").replace(/\//g,"_").replace(/\+/g,"-")):Math.abs(Math.random()*Math.random()*Date.now()|0).toString()+Math.abs(Math.random()*Math.random()*Date.now()|0).toString()},Manager.prototype.handleHandshake=function(e,t,n){function o(t,r){e.query.jsonp&&jsonpolling_re.test(e.query.jsonp)?(n.writeHead(200,{"Content-Type":"application/javascript"}),n.end("io.j["+e.query.jsonp+'](new Error("'+r+'"));')):(n.writeHead(t,s),n.end(r))}function u(e){o(500,"handshake error"),r.log.warn("handshake error "+e)}var r=this,i=t.headers.origin,s={"Content-Type":"text/plain"};if(!this.verifyOrigin(t)){o(403,"handshake bad origin");return}var a=this.handshakeData(e);i&&(s["Access-Control-Allow-Origin"]=i,s["Access-Control-Allow-Credentials"]="true"),this.authorize(a,function(t,i,f){if(t)return u(t);if(i){var l=r.generateId(),c=[l,r.enabled("heartbeats")?r.get("heartbeat timeout")||"":"",r.get("close timeout")||"",r.transports(e).join(",")].join(":");e.query.jsonp&&jsonpolling_re.test(e.query.jsonp)?(c="io.j["+e.query.jsonp+"]("+JSON.stringify(c)+");",n.writeHead(200,{"Content-Type":"application/javascript"})):n.writeHead(200,s),n.end(c),r.onHandshake(l,f||a),r.store.publish("handshake",l,f||a),r.log.info("handshake authorized",l)}else o(403,"handshake unauthorized"),r.log.info("handshake unauthorized")})},Manager.prototype.handshakeData=function(e){var t=e.request.connection,n,r=new Date;return t.remoteAddress?n={address:t.remoteAddress,port:t.remotePort}:t.socket&&t.socket.remoteAddress&&(n={address:t.socket.remoteAddress,port:t.socket.remotePort}),{headers:e.headers,address:n,time:r.toString(),query:e.query,url:e.request.url,xdomain:!!e.request.headers.origin,secure:e.request.connection.secure,issued:+r}},Manager.prototype.verifyOrigin=function(e){var t=e.headers.origin||e.headers.referer,n=this.get("origins");t==="null"&&(t="*");if(n.indexOf("*:*")!==-1)return!0;if(t)try{var r=url.parse(t);r.port=r.port||80;var i=~n.indexOf(r.hostname+":"+r.port)||~n.indexOf(r.hostname+":*")||~n.indexOf("*:"+r.port);return i||this.log.warn("illegal origin: "+t),i}catch(s){this.log.warn("error parsing origin")}else this.log.warn("origin missing from handshake, yet required by config");return!1},Manager.prototype.handlePacket=function(e,t){this.of(t.endpoint||"").handlePacket(e,t)},Manager.prototype.authorize=function(e,t){if(this.get("authorization")){var n=this;this.get("authorization").call(this,e,function(e,r){n.log.debug("client "+r?"authorized":"unauthorized"),t(e,r)})}else this.log.debug("client authorized"),t(null,!0);return this},Manager.prototype.transports=function(e){var t=this.get("transports"),n=[];for(var r=0,i=t.length;r<i;r++){var s=t[r];s&&(!s.checkClient||s.checkClient(e))&&n.push(s)}return n};var regexp=/^\/([^\/]+)\/?([^\/]+)?\/?([^\/]+)?\/?$/;Manager.prototype.checkRequest=function(e){var t=this.get("resource"),n;typeof t=="string"?(n=e.url.substr(0,t.length),n!==t&&(n=null)):(n=t.exec(e.url),n&&(n=n[0]));if(n){var r=url.parse(e.url.substr(n.length),!0),i=r.pathname||"",s=i.match(regexp),o={query:r.query||{},headers:e.headers,request:e,path:i};return s&&(o.protocol=Number(s[1]),o.transport=s[2],o.id=s[3],o.static=!!this.static.has(i)),o}return!1},Manager.prototype.of=function(e){return this.namespaces[e]?this.namespaces[e]:this.namespaces[e]=new SocketNamespace(this,e)},Manager.prototype.garbageCollection=function(){var e=Object.keys(this.handshaken),t=e.length,n=Date.now(),r;while(t--)r=this.handshaken[e[t]],"issued"in r&&n-r.issued>=3e4&&this.onDisconnect(e[t])};