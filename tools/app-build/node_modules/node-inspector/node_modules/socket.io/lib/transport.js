/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function Transport(e,t,n){this.manager=e,this.id=t.id,this.disconnected=!1,this.drained=!0,this.handleRequest(n)}var parser=require("./parser");exports=module.exports=Transport,Transport.prototype.__defineGetter__("log",function(){return this.manager.log}),Transport.prototype.__defineGetter__("store",function(){return this.manager.store}),Transport.prototype.handleRequest=function(e){this.log.debug("setting request",e.method,e.url),this.req=e,e.method=="GET"&&(this.socket=e.socket,this.open=!0,this.drained=!0,this.setHeartbeatInterval(),this.setHandlers(),this.onSocketConnect())},Transport.prototype.onSocketConnect=function(){},Transport.prototype.setHandlers=function(){var e=this;this.store.subscribe("heartbeat-clear:"+this.id,function(){e.onHeartbeatClear()}),this.store.subscribe("disconnect-force:"+this.id,function(){e.onForcedDisconnect()}),this.store.subscribe("dispatch:"+this.id,function(t,n){e.onDispatch(t,n)}),this.bound={end:this.onSocketEnd.bind(this),close:this.onSocketClose.bind(this),error:this.onSocketError.bind(this),drain:this.onSocketDrain.bind(this)},this.socket.on("end",this.bound.end),this.socket.on("close",this.bound.close),this.socket.on("error",this.bound.error),this.socket.on("drain",this.bound.drain),this.handlersSet=!0},Transport.prototype.clearHandlers=function(){this.handlersSet&&(this.store.unsubscribe("disconnect-force:"+this.id),this.store.unsubscribe("heartbeat-clear:"+this.id),this.store.unsubscribe("dispatch:"+this.id),this.socket.removeListener("end",this.bound.end),this.socket.removeListener("close",this.bound.close),this.socket.removeListener("error",this.bound.error),this.socket.removeListener("drain",this.bound.drain))},Transport.prototype.onSocketEnd=function(){this.end("socket end")},Transport.prototype.onSocketClose=function(e){this.end(e?"socket error":"socket close")},Transport.prototype.onSocketError=function(e){this.open&&(this.socket.destroy(),this.onClose()),this.log.info("socket error "+e.stack)},Transport.prototype.onSocketDrain=function(){this.drained=!0},Transport.prototype.onHeartbeatClear=function(){this.clearHeartbeatTimeout(),this.setHeartbeatInterval()},Transport.prototype.onForcedDisconnect=function(){this.disconnected||(this.log.info("transport end by forced client disconnection"),this.open&&this.packet({type:"disconnect"}),this.end("booted"))},Transport.prototype.onDispatch=function(e,t){t?this.writeVolatile(e):this.write(e)},Transport.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var e=this;this.closeTimeout=setTimeout(function(){e.log.debug("fired close timeout for client",e.id),e.closeTimeout=null,e.end("close timeout")},this.manager.get("close timeout")*1e3),this.log.debug("set close timeout for client",this.id)}},Transport.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null,this.log.debug("cleared close timeout for client",this.id))},Transport.prototype.setHeartbeatTimeout=function(){if(!this.heartbeatTimeout&&this.manager.enabled("heartbeats")){var e=this;this.heartbeatTimeout=setTimeout(function(){e.log.debug("fired heartbeat timeout for client",e.id),e.heartbeatTimeout=null,e.end("heartbeat timeout")},this.manager.get("heartbeat timeout")*1e3),this.log.debug("set heartbeat timeout for client",this.id)}},Transport.prototype.clearHeartbeatTimeout=function(){this.heartbeatTimeout&&this.manager.enabled("heartbeats")&&(clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null,this.log.debug("cleared heartbeat timeout for client",this.id))},Transport.prototype.setHeartbeatInterval=function(){if(!this.heartbeatInterval&&this.manager.enabled("heartbeats")){var e=this;this.heartbeatInterval=setTimeout(function(){e.heartbeat(),e.heartbeatInterval=null},this.manager.get("heartbeat interval")*1e3),this.log.debug("set heartbeat interval for client",this.id)}},Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.clearHeartbeatTimeout(),this.clearHeartbeatInterval()},Transport.prototype.heartbeat=function(){return this.open&&(this.log.debug("emitting heartbeat for client",this.id),this.packet({type:"heartbeat"}),this.setHeartbeatTimeout()),this},Transport.prototype.onMessage=function(e){var t=this.manager.transports[this.id];if("heartbeat"==e.type)this.log.debug("got heartbeat packet"),t&&t.open?t.onHeartbeatClear():this.store.publish("heartbeat-clear:"+this.id);else{if("disconnect"==e.type&&e.endpoint==""){this.log.debug("got disconnection packet"),t?t.onForcedDisconnect():this.store.publish("disconnect-force:"+this.id);return}if(e.id&&e.ack!="data"){this.log.debug("acknowledging packet automatically");var n=parser.encodePacket({type:"ack",ackId:e.id,endpoint:e.endpoint||""});t&&t.open?t.onDispatch(n):(this.manager.onClientDispatch(this.id,n),this.store.publish("dispatch:"+this.id,n))}t?this.manager.onClientMessage(this.id,e):this.store.publish("message:"+this.id,e)}},Transport.prototype.clearHeartbeatInterval=function(){this.heartbeatInterval&&this.manager.enabled("heartbeats")&&(clearTimeout(this.heartbeatInterval),this.heartbeatInterval=null,this.log.debug("cleared heartbeat interval for client",this.id))},Transport.prototype.disconnect=function(e){return this.packet({type:"disconnect"}),this.end(e),this},Transport.prototype.close=function(){this.open&&(this.doClose(),this.onClose())},Transport.prototype.onClose=function(){this.open&&(this.setCloseTimeout(),this.clearHandlers(),this.open=!1,this.manager.onClose(this.id),this.store.publish("close",this.id))},Transport.prototype.end=function(e){if(!this.disconnected){this.log.info("transport end ("+e+")");var t=this.manager.transports[this.id];this.close(),this.clearTimeouts(),this.disconnected=!0,t?this.manager.onClientDisconnect(this.id,e,!0):this.store.publish("disconnect:"+this.id,e)}},Transport.prototype.discard=function(){return this.log.debug("discarding transport"),this.discarded=!0,this.clearTimeouts(),this.clearHandlers(),this},Transport.prototype.error=function(e,t){this.packet({type:"error",reason:e,advice:t}),this.log.warn(e,t?"client should "+t:""),this.end("error")},Transport.prototype.packet=function(e){return this.write(parser.encodePacket(e))},Transport.prototype.writeVolatile=function(e){this.open?this.drained?this.write(e):this.log.debug("ignoring volatile packet, buffer not drained"):this.log.debug("ignoring volatile packet, transport not open")};