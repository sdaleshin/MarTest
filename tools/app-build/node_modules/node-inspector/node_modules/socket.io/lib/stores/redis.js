/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function Redis(e){e=e||{};var t=e.nodeId||function(){return Math.abs(Math.random()*Math.random()*Date.now()|0)};this.nodeId=t();if(e.pack)this.pack=e.pack,this.unpack=e.unpack;else try{var n=require("msgpack");this.pack=n.pack,this.unpack=n.unpack}catch(r){this.pack=JSON.stringify,this.unpack=JSON.parse}var i=e.redis||require("redis"),s=i.RedisClient;e.redisPub instanceof s?this.pub=e.redisPub:(e.redisPub||(e.redisPub={}),this.pub=i.createClient(e.redisPub.port,e.redisPub.host,e.redisPub)),e.redisSub instanceof s?this.sub=e.redisSub:(e.redisSub||(e.redisSub={}),this.sub=i.createClient(e.redisSub.port,e.redisSub.host,e.redisSub)),e.redisClient instanceof s?this.cmd=e.redisClient:(e.redisClient||(e.redisClient={}),this.cmd=i.createClient(e.redisClient.port,e.redisClient.host,e.redisClient)),Store.call(this,e),this.sub.setMaxListeners(0),this.setMaxListeners(0)}function Client(e,t){Store.Client.call(this,e,t)}var crypto=require("crypto"),Store=require("../store"),assert=require("assert");exports=module.exports=Redis,Redis.Client=Client,Redis.prototype.__proto__=Store.prototype,Redis.prototype.publish=function(e){var t=Array.prototype.slice.call(arguments,1);this.pub.publish(e,this.pack({nodeId:this.nodeId,args:t})),this.emit.apply(this,["publish",e].concat(t))},Redis.prototype.subscribe=function(e,t,n){this.sub.subscribe(e);if(t||n){var r=this;r.sub.on("subscribe",function i(s){if(e==s){function o(n,i){e==n&&(i=r.unpack(i),r.nodeId!=i.nodeId&&t.apply(null,i.args))}r.sub.on("message",o),r.on("unsubscribe",function u(t){e==t&&(r.sub.removeListener("message",o),r.removeListener("unsubscribe",u))}),r.sub.removeListener("subscribe",i),n&&n()}})}this.emit("subscribe",e,t,n)},Redis.prototype.unsubscribe=function(e,t){this.sub.unsubscribe(e);if(t){var n=this.sub;n.on("unsubscribe",function r(i){e==i&&(t(),n.removeListener("unsubscribe",r))})}this.emit("unsubscribe",e,t)},Redis.prototype.destroy=function(){Store.prototype.destroy.call(this),this.pub.end(),this.sub.end(),this.cmd.end()},Client.prototype.__proto__=Store.Client,Client.prototype.get=function(e,t){return this.store.cmd.hget(this.id,e,t),this},Client.prototype.set=function(e,t,n){return this.store.cmd.hset(this.id,e,t,n),this},Client.prototype.del=function(e,t){return this.store.cmd.hdel(this.id,e,t),this},Client.prototype.has=function(e,t){return this.store.cmd.hexists(this.id,e,function(e,n){if(e)return t(e);t(null,!!n)}),this},Client.prototype.destroy=function(e){return"number"!=typeof e?this.store.cmd.del(this.id):this.store.cmd.expire(this.id,e),this};