function SocketNamespace(e,t){this.manager=e,this.name=t||"",this.sockets={},this.auth=!1,this.setFlags()}var Socket=require("./socket"),EventEmitter=process.EventEmitter,parser=require("./parser"),util=require("./util");exports=module.exports=SocketNamespace,SocketNamespace.prototype.__proto__=EventEmitter.prototype,SocketNamespace.prototype.$emit=EventEmitter.prototype.emit,SocketNamespace.prototype.clients=function(e){var e=this.name+(e!==undefined?"/"+e:"");return this.manager.rooms[e]?this.manager.rooms[e].map(function(e){return this.socket(e)},this):[]},SocketNamespace.prototype.__defineGetter__("log",function(){return this.manager.log}),SocketNamespace.prototype.__defineGetter__("store",function(){return this.manager.store}),SocketNamespace.prototype.__defineGetter__("json",function(){return this.flags.json=!0,this}),SocketNamespace.prototype.__defineGetter__("volatile",function(){return this.flags.volatile=!0,this}),SocketNamespace.prototype.in=SocketNamespace.prototype.to=function(e){return this.flags.endpoint=this.name+(e?"/"+e:""),this},SocketNamespace.prototype.except=function(e){return this.flags.exceptions.push(e),this},SocketNamespace.prototype.setFlags=function(){return this.flags={endpoint:this.name,exceptions:[]},this},SocketNamespace.prototype.packet=function(e){e.endpoint=this.name;var t=this.store,n=this.log,r=this.flags.volatile,i=this.flags.exceptions,e=parser.encodePacket(e);return this.manager.onDispatch(this.flags.endpoint,e,r,i),this.store.publish("dispatch",this.flags.endpoint,e,r,i),this.setFlags(),this},SocketNamespace.prototype.send=function(e){return this.packet({type:this.flags.json?"json":"message",data:e})},SocketNamespace.prototype.emit=function(e){return e=="newListener"?this.$emit.apply(this,arguments):this.packet({type:"event",name:e,args:util.toArray(arguments).slice(1)})},SocketNamespace.prototype.socket=function(e,t){return this.sockets[e]||(this.sockets[e]=new Socket(this.manager,e,this,t)),this.sockets[e]},SocketNamespace.prototype.authorization=function(e){return this.auth=e,this},SocketNamespace.prototype.handleDisconnect=function(e,t,n){this.sockets[e]&&this.sockets[e].readable&&(n&&this.sockets[e].onDisconnect(t),delete this.sockets[e])},SocketNamespace.prototype.authorize=function(e,t){if(this.auth){var n=this;this.auth.call(this,e,function(e,r){n.log.debug("client "+(r?"":"un")+"authorized for "+n.name),t(e,r)})}else this.log.debug("client authorized for "+this.name),t(null,!0);return this},SocketNamespace.prototype.handlePacket=function(e,t){function o(){s.log.debug("sending data ack packet"),n.packet({type:"ack",args:util.toArray(arguments),ackId:t.id})}function u(e){s.log.warn("handshake error "+e+" for "+s.name),n.packet({type:"error",reason:e})}function a(){s.manager.onJoin(e,s.name),s.store.publish("join",e,s.name),n.packet({type:"connect"}),s.$emit("connection",n)}var n=this.socket(e),r=t.ack=="data",i=this.manager,s=this;switch(t.type){case"connect":if(t.endpoint=="")a();else{var f=i.handshaken[e];this.authorize(f,function(t,n,r){if(t)return u(t);n?(i.onHandshake(e,r||f),s.store.publish("handshake",e,r||f),a()):u("unauthorized")})}break;case"ack":n.acks[t.ackId]?n.acks[t.ackId].apply(n,t.args):this.log.info("unknown ack packet");break;case"event":if(-~i.get("blacklist").indexOf(t.name))this.log.debug("ignoring blacklisted event `"+t.name+"`");else{var l=[t.name].concat(t.args);r&&l.push(o),n.$emit.apply(n,l)}break;case"disconnect":this.manager.onLeave(e,this.name),this.store.publish("leave",e,this.name),n.$emit("disconnect",t.reason||"packet");break;case"json":case"message":var l=["message",t.data];r&&l.push(o),n.$emit.apply(n,l)}};