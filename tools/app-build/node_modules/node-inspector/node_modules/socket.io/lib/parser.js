/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function parse(e){try{return JSON.parse(e)}catch(t){return!1}}var packets=exports.packets={disconnect:0,connect:1,heartbeat:2,message:3,json:4,event:5,ack:6,error:7,noop:8},packetslist=Object.keys(packets),reasons=exports.reasons={"transport not supported":0,"client not handshaken":1,unauthorized:2},reasonslist=Object.keys(reasons),advice=exports.advice={reconnect:0},advicelist=Object.keys(advice);exports.encodePacket=function(e){var t=packets[e.type],n=e.id||"",r=e.endpoint||"",i=e.ack,s=null;switch(e.type){case"message":e.data!==""&&(s=e.data);break;case"event":var o={name:e.name};e.args&&e.args.length&&(o.args=e.args),s=JSON.stringify(o);break;case"json":s=JSON.stringify(e.data);break;case"ack":s=e.ackId+(e.args&&e.args.length?"+"+JSON.stringify(e.args):"");break;case"connect":e.qs&&(s=e.qs);break;case"error":var u=e.reason?reasons[e.reason]:"",a=e.advice?advice[e.advice]:"";if(u!==""||a!=="")s=u+(a!==""?"+"+a:"")}var f=t+":"+n+(i=="data"?"+":"")+":"+r;return s!==null&&s!==undefined&&(f+=":"+s),f},exports.encodePayload=function(e){var t="";if(e.length==1)return e[0];for(var n=0,r=e.length;n<r;n++){var i=e[n];t+="�"+i.length+"�"+e[n]}return t};var regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;exports.decodePacket=function(e){var t=e.match(regexp);if(!t)return{};var n=t[2]||"",e=t[5]||"",r={type:packetslist[t[1]],endpoint:t[4]||""};n&&(r.id=n,t[3]?r.ack="data":r.ack=!0);switch(r.type){case"message":r.data=e||"";break;case"event":t=parse(e),t&&(r.name=t.name,r.args=t.args),r.args=r.args||[];break;case"json":r.data=parse(e);break;case"connect":r.qs=e||"";break;case"ack":t=e.match(/^([0-9]+)(\+)?(.*)/),t&&(r.ackId=t[1],r.args=[],t[3]&&(r.args=parse(t[3])||[]));break;case"error":t=e.split("+"),r.reason=reasonslist[t[0]]||"",r.advice=advicelist[t[1]]||""}return r},exports.decodePayload=function(e){if(undefined==e||null==e)return[];if(e[0]=="�"){var t=[];for(var n=1,r="";n<e.length;n++)e[n]=="�"?(t.push(exports.decodePacket(e.substr(n+1,r))),n+=Number(r)+1,r=""):r+=e[n];return t}return[exports.decodePacket(e)]};