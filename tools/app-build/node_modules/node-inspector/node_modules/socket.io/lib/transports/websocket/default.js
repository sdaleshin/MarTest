/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function WebSocket(e,t,n){var r=this;this.parser=new Parser,this.parser.on("data",function(e){r.log.debug(r.name+" received data packet",e),r.onMessage(parser.decodePacket(e))}),this.parser.on("close",function(){r.end()}),this.parser.on("error",function(){r.end()}),Transport.call(this,e,t,n)}function Parser(){this.buffer="",this.i=0}var Transport=require("../../transport"),EventEmitter=process.EventEmitter,crypto=require("crypto"),parser=require("../../parser");exports=module.exports=WebSocket,WebSocket.prototype.__proto__=Transport.prototype,WebSocket.prototype.name="websocket",WebSocket.prototype.protocolVersion="hixie-76",WebSocket.prototype.onSocketConnect=function(){var e=this;this.socket.setNoDelay(!0),this.buffer=!0,this.buffered=[];if(this.req.headers.upgrade!=="WebSocket"){this.log.warn(this.name+" connection invalid"),this.end();return}var t=this.req.headers.origin,n=!1;this.manager.settings["match origin protocol"]?location=(t.indexOf("https")>-1?"wss":"ws")+"://"+this.req.headers.host+this.req.url:this.socket.encrypted?location="wss://"+this.req.headers.host+this.req.url:location="ws://"+this.req.headers.host+this.req.url;if(this.req.headers["sec-websocket-key1"]){this.req.head&&this.req.head.length>=8||(n=!0);var r=["HTTP/1.1 101 WebSocket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Origin: "+t,"Sec-WebSocket-Location: "+location];this.req.headers["sec-websocket-protocol"]&&r.push("Sec-WebSocket-Protocol: "+this.req.headers["sec-websocket-protocol"])}else var r=["HTTP/1.1 101 Web Socket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","WebSocket-Origin: "+t,"WebSocket-Location: "+location];try{this.socket.write(r.concat("","").join("\r\n")),this.socket.setTimeout(0),this.socket.setNoDelay(!0),this.socket.setEncoding("utf8")}catch(i){this.end();return}n?this.socket.setEncoding("binary"):this.proveReception(r)&&e.flush();var s="";this.socket.on("data",function(t){if(n){s+=t;if(s.length<8)return;e.socket.setEncoding("utf8"),n=!1,e.req.head=s.substr(0,8),s="",e.proveReception(r)&&e.flush();return}e.parser.add(t)})},WebSocket.prototype.write=function(e){if(this.open){this.drained=!1;if(this.buffer)return this.buffered.push(e),this;var t=Buffer.byteLength(e),n=new Buffer(2+t);n.write("\0","binary"),n.write(e,1,"utf8"),n.write("ÿ",1+t,"binary");try{this.socket.write(n)&&(this.drained=!0)}catch(r){this.end()}this.log.debug(this.name+" writing",e)}},WebSocket.prototype.flush=function(){this.buffer=!1;for(var e=0,t=this.buffered.length;e<t;e++)this.write(this.buffered.splice(0,1)[0])},WebSocket.prototype.proveReception=function(e){var t=this,n=this.req.headers["sec-websocket-key1"],r=this.req.headers["sec-websocket-key2"];if(n&&r){var i=crypto.createHash("md5");[n,r].forEach(function(e){var n=parseInt(e.replace(/[^\d]/g,"")),r=e.replace(/[^ ]/g,"").length;if(r===0||n%r!==0)return t.log.warn("Invalid "+t.name+' key: "'+e+'".'),t.end(),!1;n/=r,i.update(String.fromCharCode(n>>24&255,n>>16&255,n>>8&255,n&255))}),i.update(this.req.head.toString("binary"));try{this.socket.write(i.digest("binary"),"binary")}catch(s){this.end()}}return!0},WebSocket.prototype.payload=function(e){for(var t=0,n=e.length;t<n;t++)this.write(e[t]);return this},WebSocket.prototype.doClose=function(){this.socket.end()},Parser.prototype.__proto__=EventEmitter.prototype,Parser.prototype.add=function(e){this.buffer+=e,this.parse()},Parser.prototype.parse=function(){for(var e=this.i,t,n=this.buffer.length;e<n;e++){t=this.buffer[e];if(this.buffer.length==2&&this.buffer[1]=="\0"){this.emit("close"),this.buffer="",this.i=0;return}if(e===0){if(t=="\0")continue;this.error("Bad framing. Expected null byte as first frame")}if(t=="�")return this.emit("data",this.buffer.substr(1,e-1)),this.buffer=this.buffer.substr(e+1),this.i=0,this.parse()}},Parser.prototype.error=function(e){return this.buffer="",this.i=0,this.emit("error",e),this};