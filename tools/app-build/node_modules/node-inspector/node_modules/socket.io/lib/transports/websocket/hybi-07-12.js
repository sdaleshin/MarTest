/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function WebSocket(e,t,n){var r=this;this.manager=e,this.parser=new Parser,this.parser.on("data",function(e){r.onMessage(parser.decodePacket(e))}),this.parser.on("ping",function(){try{r.socket.write("ÂŠ\0")}catch(e){r.end();return}}),this.parser.on("close",function(){r.end()}),this.parser.on("error",function(e){r.log.warn(r.name+" parser error: "+e),r.end()}),Transport.call(this,e,t,n)}function Parser(){this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0},this.overflow=null,this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.currentMessage="";var e=this;this.opcodeHandlers={1:function(t){var n=function(t,n){e.currentMessage+=e.unmask(t,n),e.state.lastFragment&&(e.emit("data",e.currentMessage),e.currentMessage=""),e.endPacket()},r=function(t){e.state.masked?e.expect("Mask",4,function(r){var i=r;e.expect("Data",t,function(e){n(i,e)})}):e.expect("Data",t,function(e){n(null,e)})},i=t[1]&127;i<126?r(i):i==126?e.expect("Length",2,function(e){r(util.unpack(e))}):i==127&&e.expect("Length",8,function(t){if(util.unpack(t.slice(0,4))!=0){e.error("packets with length spanning more than 32 bit is currently not supported");return}var n=t.slice(4);r(util.unpack(t))})},2:function(t){var n=function(t,n){typeof e.currentMessage=="string"&&(e.currentMessage=[]),e.currentMessage.push(e.unmask(t,n,!0)),e.state.lastFragment&&(e.emit("binary",e.concatBuffers(e.currentMessage)),e.currentMessage=""),e.endPacket()},r=function(t){e.state.masked?e.expect("Mask",4,function(r){var i=r;e.expect("Data",t,function(e){n(i,e)})}):e.expect("Data",t,function(e){n(null,e)})},i=t[1]&127;i<126?r(i):i==126?e.expect("Length",2,function(e){r(util.unpack(e))}):i==127&&e.expect("Length",8,function(t){if(util.unpack(t.slice(0,4))!=0){e.error("packets with length spanning more than 32 bit is currently not supported");return}var n=t.slice(4);r(util.unpack(t))})},8:function(t){e.emit("close"),e.reset()},9:function(t){if(e.state.lastFragment==0){e.error("fragmented ping is not supported");return}var n=function(t,n){e.emit("ping",e.unmask(t,n)),e.endPacket()},r=function(t){e.state.masked?e.expect("Mask",4,function(r){var i=r;e.expect("Data",t,function(e){n(i,e)})}):e.expect("Data",t,function(e){n(null,e)})},i=t[1]&127;i==0?n(null,null):i<126?r(i):i==126?e.expect("Length",2,function(e){r(util.unpack(e))}):i==127&&e.expect("Length",8,function(e){r(util.unpack(e))})}},this.expect("Opcode",2,this.processPacket)}var Transport=require("../../transport"),EventEmitter=process.EventEmitter,crypto=require("crypto"),url=require("url"),parser=require("../../parser"),util=require("../../util");exports=module.exports=WebSocket,exports.Parser=Parser,WebSocket.prototype.__proto__=Transport.prototype,WebSocket.prototype.name="websocket",WebSocket.prototype.protocolVersion="07-12",WebSocket.prototype.onSocketConnect=function(){var e=this;if(typeof this.req.headers.upgrade=="undefined"||this.req.headers.upgrade.toLowerCase()!=="websocket"){this.log.warn(this.name+" connection invalid"),this.end();return}var t=this.req.headers["sec-websocket-origin"],n=((this.manager.settings["match origin protocol"]?t.match(/^https/):this.socket.encrypted)?"wss":"ws")+"://"+this.req.headers.host+this.req.url;if(!this.verifyOrigin(t)){this.log.warn(this.name+" connection invalid: origin mismatch"),this.end();return}if(!this.req.headers["sec-websocket-key"]){this.log.warn(this.name+" connection invalid: received no key"),this.end();return}var r=this.req.headers["sec-websocket-key"],i=crypto.createHash("sha1");i.update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),r=i.digest("base64");var s=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r];try{this.socket.write(s.concat("","").join("\r\n")),this.socket.setTimeout(0),this.socket.setNoDelay(!0)}catch(o){this.end();return}this.socket.on("data",function(t){e.parser.add(t)})},WebSocket.prototype.verifyOrigin=function(e){var t=this.manager.get("origins");e==="null"&&(e="*");if(t.indexOf("*:*")!==-1)return!0;if(e)try{var n=url.parse(e);n.port=n.port||80;var r=~t.indexOf(n.hostname+":"+n.port)||~t.indexOf(n.hostname+":*")||~t.indexOf("*:"+n.port);return r||this.log.warn("illegal origin: "+e),r}catch(i){this.log.warn("error parsing origin")}else this.log.warn("origin missing from websocket call, yet required by config");return!1},WebSocket.prototype.write=function(e){if(this.open){var t=this.frame(129,e);try{this.socket.write(t,"binary")}catch(n){this.end();return}this.log.debug(this.name+" writing",e)}},WebSocket.prototype.payload=function(e){for(var t=0,n=e.length;t<n;t++)this.write(e[t]);return this},WebSocket.prototype.frame=function(e,t){var n=new Buffer(t),r=n.length,i=2,s=r;r>65536?(i=10,s=127):r>125&&(i=4,s=126);var o=new Buffer(r+i);o[0]=e,o[1]=s,n.copy(o,i);switch(s){case 126:o[2]=r>>>8,o[3]=r%256;break;case 127:var u=r;for(var a=1;a<=8;++a)o[i-a]=u&255,u>>>=8}return o},WebSocket.prototype.doClose=function(){this.socket.end()},Parser.prototype.__proto__=EventEmitter.prototype,Parser.prototype.add=function(e){if(this.expectBuffer==null){this.addToOverflow(e);return}var t=Math.min(e.length,this.expectBuffer.length-this.expectOffset);e.copy(this.expectBuffer,this.expectOffset,0,t),this.expectOffset+=t,t<e.length&&(this.overflow=new Buffer(e.length-t),e.copy(this.overflow,0,t,t+this.overflow.length));if(this.expectOffset==this.expectBuffer.length){var n=this.expectBuffer;this.expectBuffer=null,this.expectOffset=0,this.expectHandler.call(this,n)}},Parser.prototype.addToOverflow=function(e){if(this.overflow==null)this.overflow=e;else{var t=this.overflow;this.overflow=new Buffer(this.overflow.length+e.length),t.copy(this.overflow,0),e.copy(this.overflow,t.length)}},Parser.prototype.expect=function(e,t,n){this.expectBuffer=new Buffer(t),this.expectOffset=0,this.expectHandler=n;if(this.overflow!=null){var r=this.overflow;this.overflow=null,this.add(r)}},Parser.prototype.processPacket=function(e){(e[0]&112)!=0&&this.error("reserved fields must be empty"),this.state.lastFragment=(e[0]&128)==128,this.state.masked=(e[1]&128)==128;var t=e[0]&15;if(t==0){this.state.opcode=this.state.activeFragmentedOperation;if(this.state.opcode!=1&&this.state.opcode!=2){this.error("continuation frame cannot follow current opcode");return}}else this.state.opcode=t,this.state.lastFragment===!1&&(this.state.activeFragmentedOperation=t);var n=this.opcodeHandlers[this.state.opcode];typeof n=="undefined"?this.error("no handler for opcode "+this.state.opcode):n(e)},Parser.prototype.endPacket=function(){this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.state.lastFragment&&this.state.opcode==this.state.activeFragmentedOperation&&(this.state.activeFragmentedOperation=null),this.state.lastFragment=!1,this.state.opcode=this.state.activeFragmentedOperation!=null?this.state.activeFragmentedOperation:0,this.state.masked=!1,this.expect("Opcode",2,this.processPacket)},Parser.prototype.reset=function(){this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0},this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.overflow=null,this.currentMessage=""},Parser.prototype.unmask=function(e,t,n){if(e!=null)for(var r=0,i=t.length;r<i;r++)t[r]^=e[r%4];return n?t:t!=null?t.toString("utf8"):""},Parser.prototype.concatBuffers=function(e){var t=0;for(var n=0,r=e.length;n<r;++n)t+=e[n].length;var i=new Buffer(t),s=0;for(var n=0,r=e.length;n<r;++n)e[n].copy(i,s),s+=e[n].length;return i},Parser.prototype.error=function(e){return this.reset(),this.emit("error",e),this};