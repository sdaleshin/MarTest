/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function HTTPTransport(e,t,n){Transport.call(this,e,t,n)}var Transport=require("../transport"),parser=require("../parser"),qs=require("querystring");exports=module.exports=HTTPTransport,HTTPTransport.prototype.__proto__=Transport.prototype,HTTPTransport.prototype.handleRequest=function(e){this.response=e.res;if(e.method=="POST"){var t="",n=e.res,r=e.headers.origin,i={"Content-Length":1,"Content-Type":"text/plain; charset=UTF-8"},s=this;e.on("data",function(n){t+=n,Buffer.byteLength(t)>=s.manager.get("destroy buffer size")&&(t="",e.connection.destroy())}),e.on("end",function(){n.writeHead(200,i),n.end("1"),s.onData(s.postEncoded?qs.parse(t).d:t)}),e.on("close",function(){t="",s.onClose()}),r&&(i["Access-Control-Allow-Origin"]=r,i["Access-Control-Allow-Credentials"]="true")}else Transport.prototype.handleRequest.call(this,e)},HTTPTransport.prototype.onData=function(e){var t=parser.decodePayload(e);this.log.debug(this.name+" received data packet",e);for(var n=0,r=t.length;n<r;n++)this.onMessage(t[n])},HTTPTransport.prototype.doClose=function(){this.response.end()},HTTPTransport.prototype.payload=function(e){this.write(parser.encodePayload(e))};