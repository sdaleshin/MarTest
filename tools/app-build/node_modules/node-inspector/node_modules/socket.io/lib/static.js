/*!
* socket.io-node
* Copyright(c) 2011 LearnBoost <dev@learnboost.com>
* MIT Licensed
*/

function Static(e){this.manager=e,this.cache={},this.paths={},this.init()}var client=require("socket.io-client"),cp=require("child_process"),fs=require("fs"),util=require("./util"),mime={js:{type:"application/javascript",encoding:"utf8",gzip:!0},swf:{type:"application/x-shockwave-flash",encoding:"binary",gzip:!1}},bundle=/\+((?:\+)?[\w\-]+)*(?:\.v\d+\.\d+\.\d+)?(?:\.js)$/,versioning=/\.v\d+\.\d+\.\d+(?:\.js)$/;exports=module.exports=Static,Static.prototype.init=function(){function e(e){var t=e.join("").split("").map(function(e){return(""+e.charCodeAt(0)).split("").pop()}).reduce(function(e,t){return e+t});return client.version+":"+t}function t(t,r){client.builder(t,{minify:n.manager.enabled("browser client minification")},function(n,i){r(n,i?new Buffer(i):null,e(t))})}var n=this;this.add("/static/flashsocket/WebSocketMain.swf",{file:client.dist+"/WebSocketMain.swf"}),this.add("/static/flashsocket/WebSocketMainInsecure.swf",{file:client.dist+"/WebSocketMainInsecure.swf"}),this.add("/socket.io.js",function(e,r){t(n.manager.get("transports"),r)}),this.add("/socket.io.v",{mime:mime.js},function(e,r){t(n.manager.get("transports"),r)}),this.add("/socket.io+",{mime:mime.js},function(e,r){var i=n.manager.get("transports"),s=e.match(bundle),o=[];if(!s)return r("No valid transports");s[0].split(".")[0].split("+").slice(1).forEach(function(e){!~i.indexOf(e)||o.push(e)});if(!o.length)return r("No valid transports");t(o,r)}),this.manager.on("set:transports",function(e,t){delete n.cache["/socket.io.js"],Object.keys(n.cache).forEach(function(e){bundle.test(e)&&delete n.cache[e]})})},Static.prototype.gzip=function(e,t){var n=cp.spawn("gzip",["-9","-c","-f","-n"]),r=Buffer.isBuffer(e)?"binary":"utf8",i=[],s;n.stdout.on("data",function(e){i.push(e)}),n.stderr.on("data",function(e){s=e+"",i.length=0}),n.on("close",function(){if(s)return t(s);var e=0,n=0,r=i.length,o;while(r--)e+=i[r].length;o=new Buffer(e),r=i.length,i.forEach(function(e){var t=e.length;e.copy(o,n,0,t),n+=t}),i.length=0,t(null,o)}),n.stdin.end(e,r)},Static.prototype.has=function(e){if(this.paths[e])return this.paths[e];var t=Object.keys(this.paths),n=t.length;while(n--)if(-~e.indexOf(t[n]))return this.paths[t[n]];return!1},Static.prototype.add=function(e,t,n){var r=/(?:\.(\w{1,4}))$/.exec(e);return!n&&typeof t=="function"&&(n=t,t={}),t.mime=t.mime||(r?mime[r[1]]:!1),n&&(t.callback=n),!t.file&&!t.callback||!t.mime?!1:(this.paths[e]=t,!0)},Static.prototype.write=function(e,t,n){function r(e,r,i,s){try{n.writeHead(e,r||undefined),n.end(t.method!=="HEAD"&&i?i:"",s||undefined)}catch(o){}}function i(n){var i=t.headers["if-none-match"]===n.etag;if(i&&s.manager.enabled("browser client etag"))return r(304);var o=t.headers["accept-encoding"]||"",u=!!~o.toLowerCase().indexOf("gzip"),a=n.mime,f=n.versioned,l={"Content-Type":a.type};s.manager.enabled("browser client etag")&&n.etag&&!f&&(l.Etag=n.etag);if(f){var c=s.manager.get("browser client expires");l["Cache-Control"]='private, x-gzip-ok="", max-age='+c,l.Date=(new Date).toUTCString(),l.Expires=(new Date(Date.now()+c*1e3)).toUTCString()}u&&n.gzip?(l["Content-Length"]=n.gzip.length,l["Content-Encoding"]="gzip",l.Vary="Accept-Encoding",r(200,l,n.gzip.content,a.encoding)):(l["Content-Length"]=n.length,r(200,l,n.content,a.encoding)),s.manager.log.debug("served static content "+e)}var s=this,o;if(this.manager.enabled("browser client cache")&&this.cache[e])return i(this.cache[e]);if(this.manager.get("browser client handler"))return this.manager.get("browser client handler").call(this,t,n);if(o=this.has(e)){function u(t,n,u){if(t)return s.manager.log.warn("Unable to serve file. "+(t.message||t)),r(500,null,"Error serving static "+e);var a=s.cache[e]={content:n,length:n.length,mime:o.mime,etag:u||client.version,versioned:versioning.test(e)};o.mime.gzip&&s.manager.enabled("browser client gzip")?s.gzip(n,function(e,t){e||(a.gzip={content:t,length:t.length}),i(a)}):i(a)}o.file?fs.readFile(o.file,u):o.callback?o.callback.call(this,e,u):r(404,null,"File handle not found")}else r(404,null,"File not found")};