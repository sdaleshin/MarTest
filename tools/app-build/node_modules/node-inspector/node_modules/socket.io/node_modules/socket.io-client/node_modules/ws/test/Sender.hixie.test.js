var assert=require("assert"),Sender=require("../lib/Sender.hixie");require("should"),require("./hybi-common"),describe("Sender",function(){describe("#send",function(){it("frames and sends a text message",function(e){var t="Hello world",n,r={write:function(e,t,r){n=e,process.nextTick(r)}},i=new Sender(r,{});i.send(t,{},function(){n.toString("utf8").should.eql("\0"+t+"�"),e()})}),it("frames and sends an empty message",function(e){var t={write:function(t,n,r){e()}},n=new Sender(t,{});n.send("",{},function(){})}),it("frames and sends a buffer",function(e){var t,n={write:function(e,n,r){t=e,process.nextTick(r)}},r=new Sender(n,{});r.send(new Buffer("foobar"),{},function(){t.toString("utf8").should.eql("\0foobar�"),e()})}),it("frames and sends a binary message",function(e){var t="Hello world",n,r={write:function(e,t,r){n=e,process.nextTick(r)}},i=new Sender(r,{});i.send(t,{binary:!0},function(){n.toString("hex").should.eql("800b48656c6c6f20776f726c64"),e()})}),it("can fauxe stream data",function(e){var t=[],n={write:function(e,n,r){t.push(e),process.nextTick(r)}},r=new Sender(n,{});r.send(new Buffer("foobar"),{fin:!1},function(){}),r.send("bazbar",{fin:!1},function(){}),r.send(new Buffer("end"),{fin:!0},function(){t[0].toString("utf8").should.eql("\0foobar"),t[1].toString("utf8").should.eql("bazbar"),t[2].toString("utf8").should.eql("end�"),e()})})}),describe("#close",function(){it("sends a hixie close frame",function(e){var t,n={write:function(e,n,r){t=e,process.nextTick(r)}},r=new Sender(n,{});r.close(null,null,null,function(){t.toString("utf8").should.eql("�\0"),e()})}),it("sends a message end marker if fauxe streaming has started, before hixie close frame",function(e){var t=[],n={write:function(e,n,r){t.push(e),r&&process.nextTick(r)}},r=new Sender(n,{});r.send(new Buffer("foobar"),{fin:!1},function(){}),r.close(null,null,null,function(){t[0].toString("utf8").should.eql("\0foobar"),t[1].toString("utf8").should.eql("�"),t[2].toString("utf8").should.eql("�\0"),e()})})})});