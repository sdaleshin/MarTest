/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function WebSocketServer(e,t){e=(new Options({host:"0.0.0.0",port:null,server:null,verifyClient:null,handleProtocols:null,path:null,noServer:!1,disableHixie:!1,clientTracking:!0})).merge(e);if(!e.isDefinedAndNonNull("port")&&!e.isDefinedAndNonNull("server")&&!e.value.noServer)throw new TypeError("`port` or a `server` must be provided");var n=this;if(e.isDefinedAndNonNull("port"))this._server=http.createServer(function(e,t){t.writeHead(200,{"Content-Type":"text/plain"}),t.end("Not implemented")}),this._server.listen(e.value.port,e.value.host,t),this._closeServer=function(){n._server.close()};else if(e.value.server){this._server=e.value.server;if(e.value.path){if(this._server._webSocketPaths&&e.value.server._webSocketPaths[e.value.path])throw new Error("two instances of WebSocketServer cannot listen on the same http server path");typeof this._server._webSocketPaths!="object"&&(this._server._webSocketPaths={}),this._server._webSocketPaths[e.value.path]=1}}this._server&&this._server.once("listening",function(){n.emit("listening")}),typeof this._server!="undefined"&&(this._server.on("error",function(e){n.emit("error",e)}),this._server.on("upgrade",function(e,t,r){var i=new Buffer(r.length);r.copy(i),n.handleUpgrade(e,t,i,function(t){n.emit("connection"+e.url,t),n.emit("connection",t)})})),this.options=e.value,this.path=e.value.path,this.clients=[]}function handleHybiUpgrade(e,t,n,r){var i=function(){try{t.destroy()}catch(e){}};t.on("error",i);if(!e.headers["sec-websocket-key"]){abortConnection(t,400,"Bad Request");return}var s=parseInt(e.headers["sec-websocket-version"]);if([8,13].indexOf(s)===-1){abortConnection(t,400,"Bad Request");return}var o=e.headers["sec-websocket-protocol"],u=s<13?e.headers["sec-websocket-origin"]:e.headers.origin,a=this,f=function(o){var u=e.headers["sec-websocket-key"],f=crypto.createHash("sha1");f.update(u+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),u=f.digest("base64");var l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+u];typeof o!="undefined"&&l.push("Sec-WebSocket-Protocol: "+o),a.emit("headers",l),t.setTimeout(0),t.setNoDelay(!0);try{t.write(l.concat("","").join("\r\n"))}catch(c){try{t.destroy()}catch(c){}return}var h=new WebSocket([e,t,n],{protocolVersion:s,protocol:o});a.options.clientTracking&&(a.clients.push(h),h.on("close",function(){var e=a.clients.indexOf(h);e!=-1&&a.clients.splice(e,1)})),t.removeListener("error",i),r(h)},l=function(){if(typeof a.options.handleProtocols=="function"){var e=(o||"").split(/, */),n=!1,r=a.options.handleProtocols(e,function(e,r){n=!0,e?f(r):abortConnection(t,404,"Unauthorized")});n||abortConnection(t,501,"Could not process protocols");return}typeof o!="undefined"?f(o.split(/, */)[0]):f()};if(typeof this.options.verifyClient=="function"){var c={origin:u,secure:typeof e.connection.authorized!="undefined"||typeof e.connection.encrypted!="undefined",req:e};if(this.options.verifyClient.length==2){this.options.verifyClient(c,function(e){e?l():abortConnection(t,401,"Unauthorized")});return}if(!this.options.verifyClient(c)){abortConnection(t,401,"Unauthorized");return}}l()}function handleHixieUpgrade(e,t,n,r){var i=function(){try{t.destroy()}catch(e){}};t.on("error",i);if(this.options.disableHixie){abortConnection(t,401,"Hixie support disabled");return}if(!e.headers["sec-websocket-key2"]){abortConnection(t,400,"Bad Request");return}var s=e.headers.origin,o=this,u=function(){var u;e.headers["x-forwarded-host"]?u=e.headers["x-forwarded-host"]:u=e.headers.host;var a=(e.headers["x-forwarded-proto"]==="https"||t.encrypted?"wss":"ws")+"://"+u+e.url,f=e.headers["sec-websocket-protocol"],l=function(n,u){var l=e.headers["sec-websocket-key1"],c=e.headers["sec-websocket-key2"],h=crypto.createHash("md5");[l,c].forEach(function(e){var n=parseInt(e.replace(/[^\d]/g,"")),r=e.replace(/[^ ]/g,"").length;if(r===0||n%r!==0){abortConnection(t,400,"Bad Request");return}n/=r,h.update(String.fromCharCode(n>>24&255,n>>16&255,n>>8&255,n&255))}),h.update(n.toString("binary"));var p=["HTTP/1.1 101 Switching Protocols","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Location: "+a];typeof f!="undefined"&&p.push("Sec-WebSocket-Protocol: "+f),typeof s!="undefined"&&p.push("Sec-WebSocket-Origin: "+s),t.setTimeout(0),t.setNoDelay(!0);try{var d=new Buffer(p.concat("","").join("\r\n")),v=new Buffer(h.digest("binary"),"binary"),m=new Buffer(d.length+v.length);d.copy(m,0),v.copy(m,d.length),t.write(m,"binary",function(n){if(n)return;var s=new WebSocket([e,t,u],{protocolVersion:"hixie-76",protocol:f});o.options.clientTracking&&(o.clients.push(s),s.on("close",function(){var e=o.clients.indexOf(s);e!=-1&&o.clients.splice(e,1)})),t.removeListener("error",i),r(s)})}catch(g){try{t.destroy()}catch(g){}return}},c=8;if(n&&n.length>=c){var h=n.slice(0,c),p=n.length>c?n.slice(c):null;l.call(o,h,p)}else{var h=new Buffer(c);n.copy(h,0);var d=n.length,p=null,v=function(e){var n=Math.min(e.length,c-d);if(n===0)return;e.copy(h,d,0,n),d+=n,d==c&&(t.removeListener("data",v),n<e.length&&(p=e.slice(n)),l.call(o,h,p))};t.on("data",v)}};if(typeof this.options.verifyClient=="function"){var a={origin:s,secure:typeof e.connection.authorized!="undefined"||typeof e.connection.encrypted!="undefined",req:e};if(this.options.verifyClient.length==2){var o=this;this.options.verifyClient(a,function(e){e?u.apply(o):abortConnection(t,401,"Unauthorized")});return}if(!this.options.verifyClient(a)){abortConnection(t,401,"Unauthorized");return}}u()}function abortConnection(e,t,n){try{var r=["HTTP/1.1 "+t+" "+n,"Content-type: text/html"];e.write(r.concat("","").join("\r\n"))}catch(i){}finally{try{e.destroy()}catch(i){}}}var util=require("util"),events=require("events"),http=require("http"),crypto=require("crypto"),url=require("url"),Options=require("options"),WebSocket=require("./WebSocket"),tls=require("tls"),url=require("url");util.inherits(WebSocketServer,events.EventEmitter),WebSocketServer.prototype.close=function(){var e=null;try{for(var t=0,n=this.clients.length;t<n;++t)this.clients[t].terminate()}catch(r){e=r}this.path&&this._server._webSocketPaths&&(delete this._server._webSocketPaths[this.path],Object.keys(this._server._webSocketPaths).length==0&&delete this._server._webSocketPaths);try{typeof this._closeServer!="undefined"&&this._closeServer()}finally{delete this._server}if(e)throw e},WebSocketServer.prototype.handleUpgrade=function(e,t,n,r){if(this.options.path){var i=url.parse(e.url);if(i&&i.pathname!==this.options.path)return}if(typeof e.headers.upgrade=="undefined"||e.headers.upgrade.toLowerCase()!=="websocket"){abortConnection(t,400,"Bad Request");return}e.headers["sec-websocket-key1"]?handleHixieUpgrade.apply(this,arguments):handleHybiUpgrade.apply(this,arguments)},module.exports=WebSocketServer;