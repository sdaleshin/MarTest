/**
 * Wrapper for built-in http.js to emulate the browser XMLHttpRequest object.
 *
 * This can be used with JS designed for browsers to improve reuse of code and
 * allow the use of existing libraries.
 *
 * Usage: include("XMLHttpRequest.js") and use XMLHttpRequest per W3C specs.
 *
 * @author Dan DeFelippi <dan@driverdan.com>
 * @contributor David Ellis <d.f.ellis@ieee.org>
 * @license MIT
 */

var Url=require("url"),spawn=require("child_process").spawn,fs=require("fs");exports.XMLHttpRequest=function(){var e=this,t=require("http"),n=require("https"),r,i,s,o={},u={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},a=u,f=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],l=["TRACE","TRACK","CONNECT"],c=!1,h=!1,p={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null;var d=function(e){return e&&f.indexOf(e.toLowerCase())===-1},v=function(e){return e&&l.indexOf(e)===-1};this.open=function(e,t,n,r,i){this.abort(),h=!1;if(!v(e))throw"SecurityError: Request method not allowed";o={method:e,url:t.toString(),async:typeof n!="boolean"?!0:n,user:r||null,password:i||null},m(this.OPENED)},this.setRequestHeader=function(e,t){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(!d(e)){console.warn('Refused to set unsafe header "'+e+'"');return}if(c)throw"INVALID_STATE_ERR: send flag is true";a[e]=t},this.getResponseHeader=function(e){return typeof e=="string"&&this.readyState>this.OPENED&&s.headers[e.toLowerCase()]&&!h?s.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||h)return"";var e="";for(var t in s.headers)t!=="set-cookie"&&t!=="set-cookie2"&&(e+=t+": "+s.headers[t]+"\r\n");return e.substr(0,e.length-2)},this.getRequestHeader=function(e){return typeof e=="string"&&a[e]?a[e]:""},this.send=function(r){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(c)throw"INVALID_STATE_ERR: send has already been called";var u=!1,f=!1,l=Url.parse(o.url);switch(l.protocol){case"https:":u=!0;case"http:":var p=l.hostname;break;case"file:":f=!0;break;case undefined:case"":var p="localhost";break;default:throw"Protocol not supported."}if(f){if(o.method!=="GET")throw"XMLHttpRequest: Only GET method is supported";if(o.async)fs.readFile(l.pathname,"utf8",function(t,n){t?e.handleError(t):(e.status=200,e.responseText=n,m(e.DONE))});else try{this.responseText=fs.readFileSync(l.pathname,"utf8"),this.status=200,m(e.DONE)}catch(d){this.handleError(d)}return}var v=l.port||(u?443:80),g=l.pathname+(l.search?l.search:"");a.Host=p,u&&v===443||v===80||(a.Host+=":"+l.port);if(o.user){typeof o.password=="undefined"&&(o.password="");var y=new Buffer(o.user+":"+o.password);a.Authorization="Basic "+y.toString("base64")}o.method==="GET"||o.method==="HEAD"?r=null:r?(a["Content-Length"]=Buffer.byteLength(r),a["Content-Type"]||(a["Content-Type"]="text/plain;charset=UTF-8")):o.method==="POST"&&(a["Content-Length"]=0);var b={host:p,port:v,path:g,method:o.method,headers:a};h=!1;if(o.async){var w=u?n.request:t.request;c=!0,e.dispatchEvent("readystatechange"),i=w(b,function(t){s=t,s.setEncoding("utf8"),m(e.HEADERS_RECEIVED),e.status=s.statusCode,s.on("data",function(t){t&&(e.responseText+=t),c&&m(e.LOADING)}),s.on("end",function(){c&&(m(e.DONE),c=!1)}),s.on("error",function(t){e.handleError(t)})}).on("error",function(t){e.handleError(t)}),r&&i.write(r),i.end(),e.dispatchEvent("loadstart")}else{var E=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(E,"","utf8");var S="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(u?"s":"")+".request;"+"var options = "+JSON.stringify(b)+";"+"var responseText = '';"+"var req = doRequest(options, function(response) {"+"response.setEncoding('utf8');"+"response.on('data', function(chunk) {"+"responseText += chunk;"+"});"+"response.on('end', function() {"+"fs.writeFileSync('"+E+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');"+"});"+"response.on('error', function(error) {"+"fs.writeFileSync('"+E+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"});"+"}).on('error', function(error) {"+"fs.writeFileSync('"+E+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"});"+(r?"req.write('"+r.replace(/'/g,"\\'")+"');":"")+"req.end();";syncProc=spawn(process.argv[0],["-e",S]);while((e.responseText=fs.readFileSync(E,"utf8"))=="");syncProc.stdin.end(),fs.unlinkSync(E);if(e.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){var x=e.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,"");e.handleError(x)}else e.status=e.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),e.responseText=e.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),m(e.DONE)}},this.handleError=function(e){this.status=503,this.statusText=e,this.responseText=e.stack,h=!0,m(this.DONE)},this.abort=function(){i&&(i.abort(),i=null),a=u,this.responseText="",this.responseXML="",h=!0,this.readyState!==this.UNSENT&&(this.readyState!==this.OPENED||c)&&this.readyState!==this.DONE&&(c=!1,m(this.DONE)),this.readyState=this.UNSENT},this.addEventListener=function(e,t){e in p||(p[e]=[]),p[e].push(t)},this.removeEventListener=function(e,t){e in p&&(p[e]=p[e].filter(function(e){return e!==t}))},this.dispatchEvent=function(t){typeof e["on"+t]=="function"&&e["on"+t]();if(t in p)for(var n=0,r=p[t].length;n<r;n++)p[t][n].call(e)};var m=function(t){e.readyState!==t&&(e.readyState=t,(o.async||e.readyState<e.OPENED||e.readyState===e.DONE)&&e.dispatchEvent("readystatechange"),e.readyState===e.DONE&&!h&&(e.dispatchEvent("load"),e.dispatchEvent("loadend")))}};