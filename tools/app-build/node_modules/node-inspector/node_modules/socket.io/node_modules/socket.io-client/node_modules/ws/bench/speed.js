function roundPrec(e,t){var n=Math.pow(10,t);return Math.round(e*n)/n}function humanSize(e){return e>=1048576?roundPrec(e/1048576,2)+" MB":e>=1024?roundPrec(e/1024,2)+" kB":roundPrec(e,2)+" B"}function generateRandomData(e){var t=new Buffer(e);for(var n=0;n<e;++n)t[n]=~~(Math.random()*127);return t}var cluster=require("cluster"),WebSocket=require("../"),WebSocketServer=WebSocket.Server,crypto=require("crypto"),util=require("util"),ansi=require("ansi");require("tinycolor");if(cluster.isMaster){var wss=new WebSocketServer({port:8181},function(){cluster.fork()});wss.on("connection",function(e){e.on("message",function(t,n){e.send(t,{binary:n&&n.binary})}),e.on("close",function(){})}),cluster.on("death",function(e){wss.close()})}else{var cursor=ansi(process.stdout),configs=[[!0,1e4,64],[!0,5e3,16384],[!0,1e3,131072],[!0,100,1048576],[!0,1,524288e3],[!1,1e4,64],[!1,5e3,16384],[!1,1e3,131072],[!1,100,1048576]],largest=configs[0][1];for(var i=0,l=configs.length;i<l;++i)configs[i][2]>largest&&(largest=configs[i][2]);console.log("Generating %s of test data ...",humanSize(largest));var randomBytes=generateRandomData(largest);function roundtrip(e,t,n,r){function f(){o.send(i,{binary:e})}var i=randomBytes.slice(0,n),s=util.format("Running %d roundtrips of %s %s data",t,humanSize(n),e?"binary":"text");console.log(s);var o=new WebSocket("ws://localhost:8181"),u,a=0;o.on("error",function(e){console.error(e),process.exit()}),o.on("open",function(){u=Date.now(),f()}),o.on("message",function(i,l){if(++a==t){var c=Date.now()-u;cursor.up(),console.log("%s:	%ss	%s",e?s.green:s.cyan,roundPrec(c/1e3,1).toString().green.bold,(humanSize(n*t/c*1e3)+"/s").blue.bold),o.close(),r();return}process.nextTick(f)})}(function e(){configs.length==0&&process.exit();var t=configs.shift();t.push(e),roundtrip.apply(null,t)})()};