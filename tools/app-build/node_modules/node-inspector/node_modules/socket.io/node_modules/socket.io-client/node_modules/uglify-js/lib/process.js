/***********************************************************************

  A JavaScript tokenizer / parser / beautifier / compressor.

  This version is suitable for Node.js.  With minimal changes (the
  exports stuff) it should work on any JS platform.

  This file implements some AST processors.  They work on data built
  by parse-js.

  Exported functions:

    - ast_mangle(ast, options) -- mangles the variable/function names
      in the AST.  Returns an AST.

    - ast_squeeze(ast) -- employs various optimizations to make the
      final generated code even smaller.  Returns an AST.

    - gen_code(ast, options) -- generates JS code from the AST.  Pass
      true (or an object, see the code for some options) as second
      argument to get "pretty" (indented) code.

  -------------------------------- (C) ---------------------------------

                           Author: Mihai Bazon
                         <mihai.bazon@gmail.com>
                       http://mihai.bazon.net/blog

  Distributed under the BSD license:

    Copyright 2010 (c) Mihai Bazon <mihai.bazon@gmail.com>

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions
    are met:

        * Redistributions of source code must retain the above
          copyright notice, this list of conditions and the following
          disclaimer.

        * Redistributions in binary form must reproduce the above
          copyright notice, this list of conditions and the following
          disclaimer in the documentation and/or other materials
          provided with the distribution.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER “AS IS” AND ANY
    EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
    PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER BE
    LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
    OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
    PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
    PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
    THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
    SUCH DAMAGE.

 ***********************************************************************/

function ast_walker(){function e(e){return[this[0],MAP(e,function(e){var t=[e[0]];return e.length>1&&(t[1]=s(e[1])),t})]}function t(e){var t=[this[0]];return e!=null&&t.push(MAP(e,s)),t}function s(e){if(e==null)return null;try{i.push(e);var t=e[0],s=r[t];if(s){var o=s.apply(e,e.slice(1));if(o!=null)return o}return s=n[t],s.apply(e,e.slice(1))}finally{i.pop()}}function o(e){if(e==null)return null;try{return i.push(e),n[e[0]].apply(e,e.slice(1))}finally{i.pop()}}function u(e,t){var n={},i;for(i in e)HOP(e,i)&&(n[i]=r[i],r[i]=e[i]);var s=t();for(i in n)HOP(n,i)&&(n[i]?r[i]=n[i]:delete r[i]);return s}var n={string:function(e){return[this[0],e]},num:function(e){return[this[0],e]},name:function(e){return[this[0],e]},toplevel:function(e){return[this[0],MAP(e,s)]},block:t,splice:t,"var":e,"const":e,"try":function(e,t,n){return[this[0],MAP(e,s),t!=null?[t[0],MAP(t[1],s)]:null,n!=null?MAP(n,s):null]},"throw":function(e){return[this[0],s(e)]},"new":function(e,t){return[this[0],s(e),MAP(t,s)]},"switch":function(e,t){return[this[0],s(e),MAP(t,function(e){return[e[0]?s(e[0]):null,MAP(e[1],s)]})]},"break":function(e){return[this[0],e]},"continue":function(e){return[this[0],e]},conditional:function(e,t,n){return[this[0],s(e),s(t),s(n)]},assign:function(e,t,n){return[this[0],e,s(t),s(n)]},dot:function(e){return[this[0],s(e)].concat(slice(arguments,1))},call:function(e,t){return[this[0],s(e),MAP(t,s)]},"function":function(e,t,n){return[this[0],e,t.slice(),MAP(n,s)]},"debugger":function(){return[this[0]]},defun:function(e,t,n){return[this[0],e,t.slice(),MAP(n,s)]},"if":function(e,t,n){return[this[0],s(e),s(t),s(n)]},"for":function(e,t,n,r){return[this[0],s(e),s(t),s(n),s(r)]},"for-in":function(e,t,n,r){return[this[0],s(e),s(t),s(n),s(r)]},"while":function(e,t){return[this[0],s(e),s(t)]},"do":function(e,t){return[this[0],s(e),s(t)]},"return":function(e){return[this[0],s(e)]},binary:function(e,t,n){return[this[0],e,s(t),s(n)]},"unary-prefix":function(e,t){return[this[0],e,s(t)]},"unary-postfix":function(e,t){return[this[0],e,s(t)]},sub:function(e,t){return[this[0],s(e),s(t)]},object:function(e){return[this[0],MAP(e,function(e){return e.length==2?[e[0],s(e[1])]:[e[0],s(e[1]),e[2]]})]},regexp:function(e,t){return[this[0],e,t]},array:function(e){return[this[0],MAP(e,s)]},stat:function(e){return[this[0],s(e)]},seq:function(){return[this[0]].concat(MAP(slice(arguments),s))},label:function(e,t){return[this[0],e,s(t)]},"with":function(e,t){return[this[0],s(e),s(t)]},atom:function(e){return[this[0],e]}},r={},i=[];return{walk:s,dive:o,with_walkers:u,parent:function(){return i[i.length-2]},stack:function(){return i}}}function Scope(e){this.names={},this.mangled={},this.rev_mangled={},this.cname=-1,this.refs={},this.uses_with=!1,this.uses_eval=!1,this.parent=e,this.children=[],e?(this.level=e.level+1,e.children.push(this)):this.level=0}function ast_add_scope(e){function s(e){t=new Scope(t),t.labels=new Scope;var n=t.body=e();return n.scope=t,t=t.parent,n}function o(e,n){return t.define(e,n)}function u(e){t.refs[e]=!0}function a(e,t,n){var i=this[0]=="defun";return[this[0],i?o(e,"defun"):e,t,s(function(){return i||o(e,"lambda"),MAP(t,function(e){o(e,"arg")}),MAP(n,r)})]}function f(e){return function(t){MAP(t,function(t){o(t[0],e),t[1]&&u(t[0])})}}function l(e){e&&(t.labels.refs[e]=!0)}var t=null,n=ast_walker(),r=n.walk,i=[];return s(function(){function c(e,t){for(t=e.children.length;--t>=0;)c(e.children[t]);for(t in e.refs)if(HOP(e.refs,t))for(var n=e.has(t),r=e;r;r=r.parent){r.refs[t]=n;if(r===n)break}}var s=n.with_walkers({"function":a,defun:a,label:function(e,n){t.labels.define(e)},"break":l,"continue":l,"with":function(e,n){for(var r=t;r;r=r.parent)r.uses_with=!0},"var":f("var"),"const":f("const"),"try":function(e,t,n){if(t!=null)return[this[0],MAP(e,r),[o(t[0],"catch"),MAP(t[1],r)],n!=null?MAP(n,r):null]},name:function(e){e=="eval"&&i.push(t),u(e)}},function(){return r(e)});return MAP(i,function(e){if(!e.has("eval"))while(e)e.uses_eval=!0,e=e.parent}),c(t),s})}function ast_mangle(e,t){function s(e,n){return!t.toplevel&&!i.parent?e:t.except&&member(e,t.except)?e:i.get_mangled(e,n)}function o(e){if(t.defines)return!i.has(e)&&HOP(t.defines,e)?t.defines[e]:null}function u(e,n,o){if(!t.no_functions){var u=this[0]=="defun",f;e&&(u?e=s(e):o.scope.references(e)?(f={},!i.uses_eval&&!i.uses_with?e=f[e]=i.next_mangled():f[e]=e):e=null)}return o=a(o.scope,function(){return n=MAP(n,function(e){return s(e)}),MAP(o,r)},f),[this[0],e,n,o]}function a(e,t,n){var r=i;i=e;if(n)for(var o in n)HOP(n,o)&&e.set_mangle(o,n[o]);for(var o in e.names)HOP(e.names,o)&&s(o,!0);var u=t();return u.scope=e,i=r,u}function f(e){return[this[0],MAP(e,function(e){return[s(e[0]),r(e[1])]})]}function l(e){if(e)return[this[0],i.labels.get_mangled(e)]}var n=ast_walker(),r=n.walk,i;return t=t||{},n.with_walkers({"function":u,defun:function(){var e=u.apply(this,arguments);switch(n.parent()[0]){case"toplevel":case"function":case"defun":return MAP.at_top(e)}return e},label:function(e,t){return i.labels.refs[e]?[this[0],i.labels.get_mangled(e,!0),r(t)]:r(t)},"break":l,"continue":l,"var":f,"const":f,name:function(e){return o(e)||[this[0],s(e)]},"try":function(e,t,n){return[this[0],MAP(e,r),t!=null?[s(t[0]),MAP(t[1],r)]:null,n!=null?MAP(n,r):null]},toplevel:function(e){var t=this;return a(t.scope,function(){return[t[0],MAP(e,r)]})}},function(){return r(ast_add_scope(e))})}function best_of(e,t){return gen_code(e).length>gen_code(t[0]=="stat"?t[1]:t).length?t:e}function last_stat(e){return e[0]=="block"&&e[1]&&e[1].length>0?e[1][e[1].length-1]:e}function aborts(e){if(e)switch(last_stat(e)[0]){case"return":case"break":case"continue":case"throw":return!0}}function boolean_expr(e){return e[0]=="unary-prefix"&&member(e[1],["!","delete"])||e[0]=="binary"&&member(e[1],["in","instanceof","==","!=","===","!==","<","<=",">=",">"])||e[0]=="binary"&&member(e[1],["&&","||"])&&boolean_expr(e[2])&&boolean_expr(e[3])||e[0]=="conditional"&&boolean_expr(e[2])&&boolean_expr(e[3])||e[0]=="assign"&&e[1]===!0&&boolean_expr(e[3])||e[0]=="seq"&&boolean_expr(e[e.length-1])}function empty(e){return!e||e[0]=="block"&&(!e[1]||e[1].length==0)}function is_string(e){return e[0]=="string"||e[0]=="unary-prefix"&&e[1]=="typeof"||e[0]=="binary"&&e[1]=="+"&&(is_string(e[2])||is_string(e[3]))}function warn_unreachable(e){empty(e)||warn("Dropping unreachable code: "+gen_code(e,!0))}function prepare_ifs(e){function r(e){e=MAP(e,n);for(var t=0;t<e.length;++t){var i=e[t];if(i[0]!="if")continue;if(i[3]&&n(i[3]))continue;var s=n(i[2]);if(!aborts(s))continue;var o=n(i[1]),u=r(e.slice(t+1)),a=u.length==1?u[0]:["block",u];return e.slice(0,t).concat([[i[0],o,s,a]])}return e}function i(e,t,n){return n=r(n),[this[0],e,t,n]}function s(e){return[this[0],e!=null?r(e):null]}var t=ast_walker(),n=t.walk;return t.with_walkers({defun:i,"function":i,block:s,splice:s,toplevel:function(e){return[this[0],r(e)]},"try":function(e,t,n){return[this[0],r(e),t!=null?[t[0],r(t[1])]:null,n!=null?r(n):null]}},function(){return n(e)})}function for_side_effects(e,t){function o(){throw i}function u(){throw s}function a(){return t.call(this,this,n,o,u)}function f(e){if(e=="++"||e=="--")return a.apply(this,arguments)}var n=ast_walker(),r=n.walk,i={},s={};return n.with_walkers({"try":a,"throw":a,"return":a,"new":a,"switch":a,"break":a,"continue":a,assign:a,call:a,"if":a,"for":a,"for-in":a,"while":a,"do":a,"return":a,"unary-prefix":f,"unary-postfix":f,defun:a},function(){for(;;)try{r(e);break}catch(t){if(t===i)break;if(t===s)continue;throw t}})}function ast_lift_variables(e){function i(e,t){var i=r;r=t,e=MAP(e,n);var s={},o=MAP(t.names,function(e,n){return e!="var"?MAP.skip:t.references(n)?(s[n]=!0,[n]):MAP.skip});return o.length>0&&(for_side_effects(["block",e],function(e,t,n,r){if(e[0]=="assign"&&e[1]===!0&&e[2][0]=="name"&&HOP(s,e[2][1])){for(var i=o.length;--i>=0;)if(o[i][0]==e[2][1]){o[i][1]&&n(),o[i][1]=e[3],o.push(o.splice(i,1)[0]);break}var u=t.parent();if(u[0]=="seq"){var a=u[2];a.unshift(0,u.length),u.splice.apply(u,a)}else u[0]=="stat"?u.splice(0,u.length,"block"):n();r()}n()}),e.unshift(["var",o])),r=i,e}function s(e){var n=null;for(var r=e.length;--r>=0;){var i=e[r];if(!i[1])continue;i=["assign",!0,["name",i[0]],i[1]],n==null?n=i:n=["seq",i,n]}return n==null?t.parent()[0]=="for-in"?["name",e[0][0]]:MAP.skip:["stat",n]}function o(e){return[this[0],i(e,this.scope)]}var t=ast_walker(),n=t.walk,r;return t.with_walkers({"function":function(e,t,n){for(var r=t.length;--r>=0&&!n.scope.references(t[r]);)t.pop();return n.scope.references(e)||(e=null),[this[0],e,t,i(n,n.scope)]},defun:function(e,t,n){if(!r.references(e))return MAP.skip;for(var s=t.length;--s>=0&&!n.scope.references(t[s]);)t.pop();return[this[0],e,t,i(n,n.scope)]},"var":s,toplevel:o},function(){return n(ast_add_scope(e))})}function ast_squeeze(e,t){function i(e){var n=["unary-prefix","!",e];switch(e[0]){case"unary-prefix":return e[1]=="!"&&boolean_expr(e[2])?e[2]:n;case"seq":return e=slice(e),e[e.length-1]=i(e[e.length-1]),e;case"conditional":return best_of(n,["conditional",e[1],i(e[2]),i(e[3])]);case"binary":var r=e[1],s=e[2],o=e[3];if(!t.keep_comps)switch(r){case"<=":return["binary",">",s,o];case"<":return["binary",">=",s,o];case">=":return["binary","<",s,o];case">":return["binary","<=",s,o]}switch(r){case"==":return["binary","!=",s,o];case"!=":return["binary","==",s,o];case"===":return["binary","!==",s,o];case"!==":return["binary","===",s,o];case"&&":return best_of(n,["binary","||",i(s),i(o)]);case"||":return best_of(n,["binary","&&",i(s),i(o)])}}return n}function s(e,t,n){var r=function(){return e[0]=="unary-prefix"&&e[1]=="!"?n?["conditional",e[2],n,t]:["binary","||",e[2],t]:n?best_of(["conditional",e,t,n],["conditional",i(e),n,t]):["binary","&&",e,t]};return when_constant(e,function(e,r){return warn_unreachable(r?n:t),r?t:n},r)}function o(e){return e!=null&&e[0]=="block"&&e[1]&&(e[1].length==1?e=e[1][0]:e[1].length==0&&(e=["block"])),e}function u(e,t,n){return[this[0],e,t,a(n,"lambda")]}function a(e,n){return e=MAP(e,r),e=e.reduce(function(e,t){return t[0]=="block"?t[1]&&e.push.apply(e,t[1]):e.push(t),e},[]),e=function(t,n){return e.forEach(function(e){n&&(e[0]=="var"&&n[0]=="var"||e[0]=="const"&&n[0]=="const")?n[1]=n[1].concat(e[1]):(t.push(e),n=e)}),t}([]),t.dead_code&&(e=function(n,r){return e.forEach(function(e){r?e[0]=="function"||e[0]=="defun"?n.push(e):e[0]=="var"||e[0]=="const"?(t.no_warnings||warn("Variables declared in unreachable code"),e[1]=MAP(e[1],function(e){return e[1]&&!t.no_warnings&&warn_unreachable(["assign",!0,["name",e[0]],e[1]]),[e[0]]}),n.push(e)):t.no_warnings||warn_unreachable(e):(n.push(e),member(e[0],["return","throw","break","continue"])&&(r=!0))}),n}([])),t.make_seqs&&(e=function(t,n){return e.forEach(function(e){n&&n[0]=="stat"&&e[0]=="stat"?n[1]=["seq",n[1],e[1]]:(t.push(e),n=e)}),t.length>=2&&t[t.length-2][0]=="stat"&&(t[t.length-1][0]=="return"||t[t.length-1][0]=="throw")&&t[t.length-1][1]&&t.splice(t.length-2,2,[t[t.length-1][0],["seq",t[t.length-2][1],t[t.length-1][1]]]),t}([])),e}function f(e,t,n){return when_constant(e,function(e,i){return i?(t=r(t),warn_unreachable(n),t||["block"]):(n=r(n),warn_unreachable(t),n||["block"])},function(){return c(e,t,n)})}function l(e,t,n){var s=[["if",i(e),n]];return t[0]=="block"?t[1]&&(s=s.concat(t[1])):s.push(t),r(["block",s])}function c(e,t,n){e=r(e),t=r(t),n=r(n),empty(t)?(e=i(e),t=n,n=null):empty(n)?n=null:function(){var r=gen_code(e),s=i(e),o=gen_code(s);if(o.length<r.length){var u=t;t=n,n=u,e=s}}();if(empty(n)&&empty(t))return["stat",e];var o=["if",e,t,n];return t[0]=="if"&&empty(t[3])&&empty(n)?o=best_of(o,r(["if",["binary","&&",e,t[1]],t[2]])):t[0]=="stat"?n?n[0]=="stat"?o=best_of(o,["stat",s(e,t[1],n[1])]):aborts(n)&&(o=l(e,t,n)):o=best_of(o,["stat",s(e,t[1])]):n&&t[0]==n[0]&&(t[0]=="return"||t[0]=="throw")&&t[1]&&n[1]?o=best_of(o,[t[0],s(e,t[1],n[1])]):n&&aborts(t)?(o=[["if",e,t]],n[0]=="block"?n[1]&&(o=o.concat(n[1])):o.push(n),o=r(["block",o])):t&&aborts(n)&&(o=l(e,t,n)),o}function h(e,t){return when_constant(e,function(e,n){return n?["for",null,null,null,r(t)]:(warn_unreachable(t),["block"])})}t=defaults(t,{make_seqs:!0,dead_code:!0,no_warnings:!1,keep_comps:!0});var n=ast_walker(),r=n.walk;return n.with_walkers({sub:function(e,t){if(t[0]=="string"){var n=t[1];if(is_identifier(n))return["dot",r(e),n];if(/^[1-9][0-9]*$/.test(n)||n==="0")return["sub",r(e),["num",parseInt(n,10)]]}},"if":f,toplevel:function(e){return["toplevel",a(e)]},"switch":function(e,t){var n=t.length-1;return["switch",r(e),MAP(t,function(e,t){var i=a(e[1]);if(t==n&&i.length>0){var s=i[i.length-1];s[0]=="break"&&!s[1]&&i.pop()}return[e[0]?r(e[0]):null,i]})]},"function":u,defun:u,block:function(e){if(e)return o(["block",a(e)])},binary:function(e,t,n){return when_constant(["binary",e,r(t),r(n)],function(t){return best_of(r(t),this)},function(){return function(){if(e!="=="&&e!="!=")return;var i=r(t),s=r(n);return i&&i[0]=="unary-prefix"&&i[1]=="!"&&i[2][0]=="num"?t=["num",+!i[2][1]]:s&&s[0]=="unary-prefix"&&s[1]=="!"&&s[2][0]=="num"&&(n=["num",+!s[2][1]]),["binary",e,t,n]}()||this})},conditional:function(e,t,n){return s(r(e),r(t),r(n))},"try":function(e,t,n){return["try",a(e),t!=null?[t[0],a(t[1])]:null,n!=null?a(n):null]},"unary-prefix":function(e,t){t=r(t);var n=["unary-prefix",e,t];return e=="!"&&(n=best_of(n,i(t))),when_constant(n,function(e,t){return r(e)},function(){return n})},name:function(e){switch(e){case"true":return["unary-prefix","!",["num",0]];case"false":return["unary-prefix","!",["num",1]]}},"while":h,assign:function(e,t,n){t=r(t),n=r(n);var i=["+","-","/","*","%",">>","<<",">>>","|","^","&"];return e===!0&&t[0]==="name"&&n[0]==="binary"&&~i.indexOf(n[1])&&n[2][0]==="name"&&n[2][1]===t[1]?[this[0],n[1],t,n[3]]:[this[0],e,t,n]}},function(){for(var t=0;t<2;++t)e=prepare_ifs(e),e=r(e);return e})}function make_string(e,t){var n=0,r=0;return e=e.replace(/[\\\b\f\n\r\t\x22\x27\u2028\u2029\0]/g,function(e){switch(e){case"\\":return"\\\\";case"\b":return"\\b";case"\f":return"\\f";case"\n":return"\\n";case"\r":return"\\r";case"	":return"\\t";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";case'"':return++n,'"';case"'":return++r,"'";case"\0":return"\\0"}return e}),t&&(e=to_ascii(e)),n>r?"'"+e.replace(/\x27/g,"\\'")+"'":'"'+e.replace(/\x22/g,'\\"')+'"'}function to_ascii(e){return e.replace(/[\u0080-\uffff]/g,function(e){var t=e.charCodeAt(0).toString(16);while(t.length<4)t="0"+t;return"\\u"+t})}function gen_code(e,t){function o(e){var n=make_string(e,t.ascii_only);return t.inline_script&&(n=n.replace(/<\x2fscript([>\/\t\n\f\r ])/gi,"<\\/script$1")),n}function u(e){return e=e.toString(),t.ascii_only&&(e=to_ascii(e)),e}function a(e){return e==null&&(e=""),n&&(e=repeat_string(" ",t.indent_start+r*t.indent_level)+e),e}function f(e,t){t==null&&(t=1),r+=t;try{return e.apply(null,slice(arguments,1))}finally{r-=t}}function l(e){if(n)return e.join(" ");var t=[];for(var r=0;r<e.length;++r){var i=e[r+1];t.push(e[r]),i&&(/[a-z0-9_\x24]$/i.test(e[r].toString())&&/^[a-z0-9_\x24]/i.test(i.toString())||/[\+\-]$/.test(e[r].toString())&&/^[\+\-]/.test(i.toString()))&&t.push(" ")}return t.join("")}function c(e){return e.join(","+s)}function h(e){var t=g(e);for(var n=1;n<arguments.length;++n){var r=arguments[n];if(r instanceof Function&&r(e)||e[0]==r)return"("+t+")"}return t}function p(e){if(e.length==1)return e[0];if(e.length==2){var t=e[1];return e=e[0],e.length<=t.length?e:t}return p([e[0],p(e.slice(1))])}function d(e){if(e[0]=="function"||e[0]=="object"){var t=slice(m.stack()),n=t.pop(),r=t.pop();while(r){if(r[0]=="stat")return!0;if((r[0]!="seq"&&r[0]!="call"&&r[0]!="dot"&&r[0]!="sub"&&r[0]!="conditional"||r[1]!==n)&&(r[0]!="binary"&&r[0]!="assign"&&r[0]!="unary-postfix"||r[2]!==n))return!1;n=r,r=t.pop()}}return!HOP(DOT_CALL_NO_PARENS,e[0])}function v(e){var t=e.toString(10),n=[t.replace(/^0\./,".")],r;return Math.floor(e)===e?(e>=0?n.push("0x"+e.toString(16).toLowerCase(),"0"+e.toString(8)):n.push("-0x"+(-e).toString(16).toLowerCase(),"-0"+(-e).toString(8)),(r=/^(.*?)(0+)$/.exec(e))&&n.push(r[1]+"e"+r[2].length)):(r=/^0?\.(0+)(.*)$/.exec(e))&&n.push(r[2]+"e-"+(r[1].length+r[2].length),t.substr(t.indexOf("."))),p(n)}function y(e){if(e==null)return";";if(e[0]=="do")return x([e]);var t=e;for(;;){var n=t[0];if(n=="if"){if(!t[3])return g(["block",[e]]);t=t[3]}else if(n=="while"||n=="do")t=t[2];else{if(n!="for"&&n!="for-in")break;t=t[4]}}return g(e)}function b(e,t,n,r){var i=r||"function";return e&&(i+=" "+u(e)),i+="("+c(MAP(t,u))+")",i=l([i,x(n)]),d(this)?"("+i+")":i}function w(e){switch(e[0]){case"with":case"while":return empty(e[2]);case"for":case"for-in":return empty(e[4]);case"if":if(empty(e[2])&&!e[3])return!0;if(e[3])return empty(e[3])?!0:w(e[3]);return w(e[2])}}function E(e,t){for(var r=[],i=e.length-1,s=0;s<=i;++s){var o=e[s],u=g(o);u!=";"&&(!n&&s==i&&!w(o)&&(u=u.replace(/;+\s*$/,"")),r.push(u))}return t?r:MAP(r,a)}function S(e){var t=e.length;return t==0?"{}":"{"+i+MAP(e,function(e,r){var s=e[1].length>0,o=f(function(){return a(e[0]?l(["case",g(e[0])+":"]):"default:")},.5)+(s?i+f(function(){return E(e[1]).join(i)}):"");return!n&&s&&r<t-1&&(o+=";"),o}).join(i)+i+a("}")}function x(e){return e?e.length==0?"{}":"{"+i+f(function(){return E(e).join(i)})+i+a("}"):";"}function T(e){var t=e[0],n=e[1];return n!=null&&(t=l([u(t),"=",h(n,"seq")])),t}t=defaults(t,{indent_start:0,indent_level:4,quote_keys:!1,space_colon:!1,beautify:!1,ascii_only:!1,inline_script:!1});var n=!!t.beautify,r=0,i=n?"\n":"",s=n?" ":"",m=ast_walker(),g=m.walk;return m.with_walkers({string:o,num:v,name:u,"debugger":function(){return"debugger"},toplevel:function(e){return E(e).join(i+i)},splice:function(e){var t=m.parent();return HOP(SPLICE_NEEDS_BRACKETS,t)?x.apply(this,arguments):MAP(E(e,!0),function(e,t){return t>0?a(e):e}).join(i)},block:x,"var":function(e){return"var "+c(MAP(e,T))+";"},"const":function(e){return"const "+c(MAP(e,T))+";"},"try":function(e,t,n){var r=["try",x(e)];return t&&r.push("catch","("+t[0]+")",x(t[1])),n&&r.push("finally",x(n)),l(r)},"throw":function(e){return l(["throw",g(e)])+";"},"new":function(e,t){return t=t.length>0?"("+c(MAP(t,function(e){return h(e,"seq")}))+")":"",l(["new",h(e,"seq","binary","conditional","assign",function(e){var t=ast_walker(),n={};try{t.with_walkers({call:function(){throw n},"function":function(){return this}},function(){t.walk(e)})}catch(r){if(r===n)return!0;throw r}})+t])},"switch":function(e,t){return l(["switch","("+g(e)+")",S(t)])},"break":function(e){var t="break";return e!=null&&(t+=" "+u(e)),t+";"},"continue":function(e){var t="continue";return e!=null&&(t+=" "+u(e)),t+";"},conditional:function(e,t,n){return l([h(e,"assign","seq","conditional"),"?",h(t,"seq"),":",h(n,"seq")])},assign:function(e,t,n){return e&&e!==!0?e+="=":e="=",l([g(t),e,h(n,"seq")])},dot:function(e){var t=g(e),n=1;e[0]=="num"?/\./.test(e[1])||(t+="."):d(e)&&(t="("+t+")");while(n<arguments.length)t+="."+u(arguments[n++]);return t},call:function(e,t){var n=g(e);return n.charAt(0)!="("&&d(e)&&(n="("+n+")"),n+"("+c(MAP(t,function(e){return h(e,"seq")}))+")"},"function":b,defun:b,"if":function(e,t,n){var r=["if","("+g(e)+")",n?y(t):g(t)];return n&&r.push("else",g(n)),l(r)},"for":function(e,t,n,r){var i=["for"];e=(e!=null?g(e):"").replace(/;*\s*$/,";"+s),t=(t!=null?g(t):"").replace(/;*\s*$/,";"+s),n=(n!=null?g(n):"").replace(/;*\s*$/,"");var o=e+t+n;return o=="; ; "&&(o=";;"),i.push("("+o+")",g(r)),l(i)},"for-in":function(e,t,n,r){return l(["for","("+(e?g(e).replace(/;+$/,""):g(t)),"in",g(n)+")",g(r)])},"while":function(e,t){return l(["while","("+g(e)+")",g(t)])},"do":function(e,t){return l(["do",g(t),"while","("+g(e)+")"])+";"},"return":function(e){var t=["return"];return e!=null&&t.push(g(e)),l(t)+";"},binary:function(e,r,i){var s=g(r),o=g(i);if(member(r[0],["assign","conditional","seq"])||r[0]=="binary"&&PRECEDENCE[e]>PRECEDENCE[r[1]]||r[0]=="function"&&d(this))s="("+s+")";return member(i[0],["assign","conditional","seq"])||i[0]=="binary"&&PRECEDENCE[e]>=PRECEDENCE[i[1]]&&(i[1]!=e||!member(e,["&&","||","*"]))?o="("+o+")":!n&&t.inline_script&&(e=="<"||e=="<<")&&i[0]=="regexp"&&/^script/i.test(i[1])&&(o=" "+o),l([s,e,o])},"unary-prefix":function(e,t){var n=g(t);return t[0]=="num"||t[0]=="unary-prefix"&&!HOP(OPERATORS,e+t[1])||!d(t)||(n="("+n+")"),e+(jsp.is_alphanumeric_char(e.charAt(0))?" ":"")+n},"unary-postfix":function(e,t){var n=g(t);return t[0]=="num"||t[0]=="unary-postfix"&&!HOP(OPERATORS,e+t[1])||!d(t)||(n="("+n+")"),n+e},sub:function(e,t){var n=g(e);return d(e)&&(n="("+n+")"),n+"["+g(t)+"]"},object:function(e){var r=d(this);if(e.length==0)return r?"({})":"{}";var s="{"+i+f(function(){return MAP(e,function(e){if(e.length==3)return a(b(e[0],e[1][2],e[1][3],e[2]));var r=e[0],i=h(e[1],"seq");return t.quote_keys?r=o(r):(typeof r=="number"||!n&&+r+""==r)&&parseFloat(r)>=0?r=v(+r):is_identifier(r)||(r=o(r)),a(l(n&&t.space_colon?[r,":",i]:[r+":",i]))}).join(","+i)})+i+a("}");return r?"("+s+")":s},regexp:function(e,t){return"/"+e+"/"+t},array:function(e){return e.length==0?"[]":l(["[",c(MAP(e,function(t,r){return!n&&t[0]=="atom"&&t[1]=="undefined"?r===e.length-1?",":"":h(t,"seq")})),"]"])},stat:function(e){return g(e).replace(/;*\s*$/,";")},seq:function(){return c(MAP(slice(arguments),g))},label:function(e,t){return l([u(e),":",g(t)])},"with":function(e,t){return l(["with","("+g(e)+")",g(t)])},atom:function(e){return u(e)}},function(){return g(e)})}function split_lines(e,t){var n=[0];return jsp.parse(function(){function o(e){return e.pos-i}function u(e){i=e.pos,n.push(i)}function a(){var e=r.apply(this,arguments);e:{if(s&&s.type=="keyword")break e;if(o(e)>t)switch(e.type){case"keyword":case"atom":case"name":case"punc":u(e);break e}}return s=e,e}var r=jsp.tokenizer(e),i=0,s;return a.context=function(){return r.context.apply(this,arguments)},a}()),n.map(function(t,r){return e.substring(t,n[r+1]||e.length)}).join("\n")}function repeat_string(e,t){if(t<=0)return"";if(t==1)return e;var n=repeat_string(e,t>>1);return n+=n,t&1&&(n+=e),n}function defaults(e,t){var n={};e===!0&&(e={});for(var r in t)HOP(t,r)&&(n[r]=e&&HOP(e,r)?e[r]:t[r]);return n}function is_identifier(e){return/^[a-z_$][a-z0-9_$]*$/i.test(e)&&e!="this"&&!HOP(jsp.KEYWORDS_ATOM,e)&&!HOP(jsp.RESERVED_WORDS,e)&&!HOP(jsp.KEYWORDS,e)}function HOP(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var jsp=require("./parse-js"),slice=jsp.slice,member=jsp.member,PRECEDENCE=jsp.PRECEDENCE,OPERATORS=jsp.OPERATORS,base54=function(){var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_";return function(t){var n="";do n=e.charAt(t%54)+n,t=Math.floor(t/54);while(t>0);return n}}();Scope.prototype={has:function(e){for(var t=this;t;t=t.parent)if(HOP(t.names,e))return t},has_mangled:function(e){for(var t=this;t;t=t.parent)if(HOP(t.rev_mangled,e))return t},toJSON:function(){return{names:this.names,uses_eval:this.uses_eval,uses_with:this.uses_with}},next_mangled:function(){for(;;){var e=base54(++this.cname),t;t=this.has_mangled(e);if(t&&this.refs[t.rev_mangled[e]]===t)continue;t=this.has(e);if(t&&t!==this&&this.refs[e]===t&&!t.has_mangled(e))continue;if(HOP(this.refs,e)&&this.refs[e]==null)continue;if(!is_identifier(e))continue;return e}},set_mangle:function(e,t){return this.rev_mangled[t]=e,this.mangled[e]=t},get_mangled:function(e,t){if(this.uses_eval||this.uses_with)return e;var n=this.has(e);return n?HOP(n.mangled,e)?n.mangled[e]:t?n.set_mangle(e,n.next_mangled()):e:e},references:function(e){return e&&!this.parent||this.uses_with||this.uses_eval||this.refs[e]},define:function(e,t){if(e!=null){if(t=="var"||!HOP(this.names,e))this.names[e]=t||"var";return e}}};var warn=function(){},when_constant=function(){function t(n){switch(n[0]){case"string":case"num":return n[1];case"name":case"atom":switch(n[1]){case"true":return!0;case"false":return!1;case"null":return null}break;case"unary-prefix":switch(n[1]){case"!":return!t(n[2]);case"typeof":return typeof t(n[2]);case"~":return~t(n[2]);case"-":return-t(n[2]);case"+":return+t(n[2])}break;case"binary":var r=n[2],i=n[3];switch(n[1]){case"&&":return t(r)&&t(i);case"||":return t(r)||t(i);case"|":return t(r)|t(i);case"&":return t(r)&t(i);case"^":return t(r)^t(i);case"+":return t(r)+t(i);case"*":return t(r)*t(i);case"/":return t(r)/t(i);case"%":return t(r)%t(i);case"-":return t(r)-t(i);case"<<":return t(r)<<t(i);case">>":return t(r)>>t(i);case">>>":return t(r)>>>t(i);case"==":return t(r)==t(i);case"===":return t(r)===t(i);case"!=":return t(r)!=t(i);case"!==":return t(r)!==t(i);case"<":return t(r)<t(i);case"<=":return t(r)<=t(i);case">":return t(r)>t(i);case">=":return t(r)>=t(i);case"in":return t(r)in t(i);case"instanceof":return t(r)instanceof t(i)}}throw e}var e={};return function(n,r,i){try{var s=t(n),o;switch(typeof s){case"string":o=["string",s];break;case"number":o=["num",s];break;case"boolean":o=["name",String(s)];break;default:if(s===null){o=["atom","null"];break}throw new Error("Can't handle constant of type: "+typeof s)}return r.call(n,o,s)}catch(u){if(u===e){if(n[0]!="binary"||n[1]!="==="&&n[1]!="!=="||!(is_string(n[2])&&is_string(n[3])||boolean_expr(n[2])&&boolean_expr(n[3]))){if(i&&n[0]=="binary"&&(n[1]=="||"||n[1]=="&&"))try{var a=t(n[2]);n=n[1]=="&&"&&(a?n[3]:a)||n[1]=="||"&&(a?a:n[3])||n}catch(f){}}else n[1]=n[1].substr(0,2);return i?i.call(n,n):null}throw u}}}(),DOT_CALL_NO_PARENS=jsp.array_to_hash(["name","array","object","string","dot","sub","call","regexp","defun"]),SPLICE_NEEDS_BRACKETS=jsp.array_to_hash(["if","while","do","for","for-in","with"]),MAP;(function(){function t(e){this.v=e}function n(e){this.v=e}MAP=function(r,i,s){function f(){var f=i.call(s,r[a],a);f instanceof t?(f=f.v,f instanceof n?u.push.apply(u,f.v):u.push(f)):f!=e&&(f instanceof n?o.push.apply(o,f.v):o.push(f))}var o=[],u=[],a;if(r instanceof Array)for(a=0;a<r.length;++a)f();else for(a in r)HOP(r,a)&&f();return u.concat(o)},MAP.at_top=function(e){return new t(e)},MAP.splice=function(e){return new n(e)};var e=MAP.skip={}})(),exports.ast_walker=ast_walker,exports.ast_mangle=ast_mangle,exports.ast_squeeze=ast_squeeze,exports.ast_lift_variables=ast_lift_variables,exports.gen_code=gen_code,exports.ast_add_scope=ast_add_scope,exports.set_logger=function(e){warn=e},exports.make_string=make_string,exports.split_lines=split_lines,exports.MAP=MAP,exports.ast_squeeze_more=require("./squeeze-more").ast_squeeze_more;