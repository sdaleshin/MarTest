/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function Sender(e){this.socket=e,this.continuationFrame=!1,this.isClosed=!1}var events=require("events"),util=require("util"),EventEmitter=events.EventEmitter;module.exports=Sender,util.inherits(Sender,events.EventEmitter),Sender.prototype.send=function(e,t,n){if(this.isClosed)return;var r=typeof e=="string",i=r?Buffer.byteLength(e):e.length,s=i>127?2:1,o=this.continuationFrame==0,u=!t||typeof t.fin=="undefined"||!!t.fin,a=new Buffer((o?t&&t.binary?1+s:1:0)+i+(u&&(!t||!t.binary)?1:0)),f=o?1:0;o&&(t&&t.binary?(a.write("","binary"),s>1&&a.write(String.fromCharCode(128+i/128),f++,"binary"),a.write(String.fromCharCode(i&127),f++,"binary")):a.write("\0","binary")),r?a.write(e,f,"utf8"):e.copy(a,f,0),u?((!t||!t.binary)&&a.write("ÿ",f+i,"binary"),this.continuationFrame=!1):this.continuationFrame=!0;try{this.socket.write(a,"binary",n)}catch(l){this.error(l.toString())}},Sender.prototype.close=function(e,t,n,r){if(this.isClosed)return;this.isClosed=!0;try{this.continuationFrame&&this.socket.write(new Buffer([255],"binary")),this.socket.write(new Buffer([255,0]),"binary",r)}catch(i){this.error(i.toString())}},Sender.prototype.ping=function(e,t){},Sender.prototype.pong=function(e,t){},Sender.prototype.error=function(e){return this.emit("error",e),this};