/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function WebSocket(e,t,n){t&&!Array.isArray(t)&&"object"==typeof t&&(n=t,t=null),"string"==typeof t&&(t=[t]),Array.isArray(t)||(t=[]),this._socket=null,this.bytesReceived=0,this.readyState=null,this.supports={},Array.isArray(e)?initAsServerClient.apply(this,e.concat(n)):initAsClient.apply(this,[e,t,n])}function MessageEvent(e,t,n){this.data=e,this.type=t,this.target=n}function CloseEvent(e,t,n){this.wasClean=typeof e=="undefined"||e==1e3,this.code=e,this.reason=t,this.target=n}function OpenEvent(e){this.target=e}function initAsServerClient(e,t,n,r){r=(new Options({protocolVersion:protocolVersion,protocol:null})).merge(r),this.protocol=r.value.protocol,this.protocolVersion=r.value.protocolVersion,this.supports.binary=this.protocolVersion!="hixie-76",this.upgradeReq=e,this.readyState=WebSocket.CONNECTING,this._isServer=!0,r.value.protocolVersion=="hixie-76"?establishConnection.call(this,ReceiverHixie,SenderHixie,t,n):establishConnection.call(this,Receiver,Sender,t,n)}function initAsClient(e,t,n){n=(new Options({origin:null,protocolVersion:protocolVersion,host:null,headers:null,protocol:null,agent:null,pfx:null,key:null,passphrase:null,cert:null,ca:null,ciphers:null,rejectUnauthorized:null})).merge(n);if(n.value.protocolVersion!=8&&n.value.protocolVersion!=13)throw new Error("unsupported protocol version");var r=url.parse(e),i=r.protocol==="ws+unix:";if(!r.host&&!i)throw new Error("invalid url");var s=r.protocol==="wss:"||r.protocol==="https:",o=s?https:http,u=r.port||(s?443:80),a=r.auth;this._isServer=!1,this.url=e,this.protocolVersion=n.value.protocolVersion,this.supports.binary=this.protocolVersion!="hixie-76";var f=(new Buffer(n.value.protocolVersion+"-"+Date.now())).toString("base64"),l=crypto.createHash("sha1");l.update(f+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");var c=l.digest("base64"),h=n.value.agent;!h&&isNodeV4&&(isNodeV4=!0,h=new o.Agent({host:r.hostname,port:u}));var p=r.hostname;r.port&&(s&&u!=443||!s&&u!=80)&&(p=p+":"+u);var d={port:u,host:r.hostname,headers:{Connection:"Upgrade",Upgrade:"websocket",Host:p,Origin:p,"Sec-WebSocket-Version":n.value.protocolVersion,"Sec-WebSocket-Key":f}};a&&(d.headers.Authorization="Basic "+(new Buffer(a)).toString("base64")),n.value.protocol&&(d.headers["Sec-WebSocket-Protocol"]=n.value.protocol),n.value.host&&(d.headers.Host=n.value.host);if(n.value.headers)for(var v in n.value.headers)n.value.headers.hasOwnProperty(v)&&(d.headers[v]=n.value.headers[v]);if(n.isDefinedAndNonNull("pfx")||n.isDefinedAndNonNull("key")||n.isDefinedAndNonNull("passphrase")||n.isDefinedAndNonNull("cert")||n.isDefinedAndNonNull("ca")||n.isDefinedAndNonNull("ciphers")||n.isDefinedAndNonNull("rejectUnauthorized")){if(isNodeV4)throw new Error("Client side certificates are not supported on Node 0.4.x");n.isDefinedAndNonNull("pfx")&&(d.pfx=n.value.pfx),n.isDefinedAndNonNull("key")&&(d.key=n.value.key),n.isDefinedAndNonNull("passphrase")&&(d.passphrase=n.value.passphrase),n.isDefinedAndNonNull("cert")&&(d.cert=n.value.cert),n.isDefinedAndNonNull("ca")&&(d.ca=n.value.ca),n.isDefinedAndNonNull("ciphers")&&(d.ciphers=n.value.ciphers),n.isDefinedAndNonNull("rejectUnauthorized")&&(d.rejectUnauthorized=n.value.rejectUnauthorized),h||(h=new o.Agent(d))}isNodeV4?d.path=(r.pathname||"/")+(r.search||""):d.path=r.path||"/",h&&(d.agent=h),i&&(d.socketPath=r.pathname),n.value.origin&&(n.value.protocolVersion<13?d.headers["Sec-WebSocket-Origin"]=n.value.origin:d.headers.Origin=n.value.origin);var m=this,g=o.request(d);(isNodeV4?h:g).on("error",function(e){m.emit("error",e),cleanupWebsocketResources.call(this,e)}),(isNodeV4?h:g).once("response",function(e){var t=new Error("unexpected server response ("+e.statusCode+")");m.emit("error",t),cleanupWebsocketResources.call(this,t)}),(isNodeV4?h:g).once("upgrade",function(e,t,r){if(m.readyState==WebSocket.CLOSED){m.emit("close"),removeAllListeners(m),t.end();return}var i=e.headers["sec-websocket-accept"];if(typeof i=="undefined"||i!==c){m.emit("error","invalid server key"),removeAllListeners(m),t.end();return}var s=e.headers["sec-websocket-protocol"],o=(n.value.protocol||"").split(/, */),u=null;!n.value.protocol&&s?u="server sent a subprotocol even though none requested":n.value.protocol&&!s?u="server sent no subprotocol even though requested":s&&o.indexOf(s)===-1&&(u="server responded with an invalid protocol");if(u){m.emit("error",u),removeAllListeners(m),t.end();return}s&&(m.protocol=s),establishConnection.call(m,Receiver,Sender,t,r),removeAllListeners(isNodeV4?h:g),g=null,h=null}),g.end(),this.readyState=WebSocket.CONNECTING}function establishConnection(e,t,n,r){function s(e){if(i.readyState!=WebSocket.OPEN)return;if(r&&r.length>0){i.bytesReceived+=r.length;var t=r;r=null,i._receiver.add(t)}u=o,e&&(i.bytesReceived+=e.length,i._receiver.add(e))}function o(e){e&&(i.bytesReceived+=e.length),i._receiver.add(e)}this._socket=n,n.setTimeout(0),n.setNoDelay(!0);var i=this;this._receiver=new e,n.on("end",cleanupWebsocketResources.bind(this)),n.on("close",cleanupWebsocketResources.bind(this)),n.on("error",cleanupWebsocketResources.bind(this));var u=s;process.nextTick(s),i._receiver.ontext=function(e,t){t=t||{},i.emit("message",e,t)},i._receiver.onbinary=function(e,t){t=t||{},t.binary=!0,i.emit("message",e,t)},i._receiver.onping=function(e,t){t=t||{},i.pong(e,{mask:!i._isServer,binary:t.binary===!0},!0),i.emit("ping",e,t)},i._receiver.onpong=function(e,t){i.emit("pong",e,t)},i._receiver.onclose=function(e,t,n){n=n||{},i.close(e,t)},i._receiver.onerror=function(e,t){i.close(typeof t!="undefined"?t:1002,""),i.emit("error",e,t)},this._sender=new t(n),this._sender.on("error",function(e){i.close(1002,""),i.emit("error",e)}),this.readyState=WebSocket.OPEN,this.emit("open"),n.on("data",u)}function startQueue(e){e._queue=e._queue||[]}function executeQueueSends(e){var t=e._queue;if(typeof t=="undefined")return;delete e._queue;for(var n=0,r=t.length;n<r;++n)t[n]()}function sendStream(e,t,n,r){t.on("data",function(t){if(e.readyState!=WebSocket.OPEN){typeof r=="function"?r(new Error("not opened")):(delete e._queue,e.emit("error",new Error("not opened")));return}n.fin=!1,e._sender.send(t,n)}),t.on("end",function(){if(e.readyState!=WebSocket.OPEN){typeof r=="function"?r(new Error("not opened")):(delete e._queue,e.emit("error",new Error("not opened")));return}n.fin=!0,e._sender.send(null,n),typeof r=="function"&&r(null)})}function cleanupWebsocketResources(e){if(this.readyState==WebSocket.CLOSED)return;var t=this.readyState!=WebSocket.CONNECTING;this.readyState=WebSocket.CLOSED,clearTimeout(this._closeTimer),this._closeTimer=null,t&&this.emit("close",this._closeCode||1e3,this._closeMessage||"");if(this._socket){removeAllListeners(this._socket);var n=this._socket;this._socket.on("error",function(){try{n.destroy()}catch(e){}});try{e?this._socket.destroy():this._socket.end()}catch(r){}this._socket=null}this._sender&&(removeAllListeners(this._sender),this._sender=null),this._receiver&&(this._receiver.cleanup(),this._receiver=null),removeAllListeners(this),this.on("error",function(){}),delete this._queue}function removeAllListeners(e){isNodeV4?e._events={}:e.removeAllListeners()}var util=require("util"),events=require("events"),http=require("http"),https=require("https"),crypto=require("crypto"),url=require("url"),fs=require("fs"),Options=require("options"),Sender=require("./Sender"),Receiver=require("./Receiver"),SenderHixie=require("./Sender.hixie"),ReceiverHixie=require("./Receiver.hixie"),protocolVersion=13,closeTimeout=3e4,isNodeV4=/^v0\.4/.test(process.version);util.inherits(WebSocket,events.EventEmitter),["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e,t){WebSocket.prototype[e]=WebSocket[e]=t}),WebSocket.prototype.close=function(e,t){if(this.readyState==WebSocket.CLOSING||this.readyState==WebSocket.CLOSED)return;if(this.readyState==WebSocket.CONNECTING){this.readyState=WebSocket.CLOSED;return}try{this.readyState=WebSocket.CLOSING,this._closeCode=e,this._closeMessage=t;var n=!this._isServer;this._sender.close(e,t,n)}catch(r){this.emit("error",r)}finally{this.terminate()}},WebSocket.prototype.pause=function(){if(this.readyState!=WebSocket.OPEN)throw new Error("not opened");return this._socket.pause()},WebSocket.prototype.ping=function(e,t,n){if(this.readyState!=WebSocket.OPEN){if(n===!0)return;throw new Error("not opened")}t=t||{},typeof t.mask=="undefined"&&(t.mask=!this._isServer),this._sender.ping(e,t)},WebSocket.prototype.pong=function(e,t,n){if(this.readyState!=WebSocket.OPEN){if(n===!0)return;throw new Error("not opened")}t=t||{},typeof t.mask=="undefined"&&(t.mask=!this._isServer),this._sender.pong(e,t)},WebSocket.prototype.resume=function(){if(this.readyState!=WebSocket.OPEN)throw new Error("not opened");return this._socket.resume()},WebSocket.prototype.send=function(e,t,n){typeof t=="function"&&(n=t,t={});if(this.readyState!=WebSocket.OPEN){if(typeof n!="function")throw new Error("not opened");n(new Error("not opened"));return}e||(e="");if(this._queue){var r=this;this._queue.push(function(){r.send(e,t,n)});return}t=t||{},t.fin=!0,typeof t.binary=="undefined"&&(t.binary=e instanceof ArrayBuffer||e instanceof Buffer||e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array),typeof t.mask=="undefined"&&(t.mask=!this._isServer);if(e instanceof fs.ReadStream){startQueue(this);var r=this;sendStream(this,e,t,function(e){process.nextTick(function(){executeQueueSends(r)}),typeof n=="function"&&n(e)})}else this._sender.send(e,t,n)},WebSocket.prototype.stream=function(e,t){typeof e=="function"&&(t=e,e={});var n=this;if(typeof t!="function")throw new Error("callback must be provided");if(this.readyState!=WebSocket.OPEN){if(typeof t!="function")throw new Error("not opened");t(new Error("not opened"));return}if(this._queue){this._queue.push(function(){n.stream(e,t)});return}e=e||{},typeof e.mask=="undefined"&&(e.mask=!this._isServer),startQueue(this);var r=function(i,s){try{if(n.readyState!=WebSocket.OPEN)throw new Error("not opened");e.fin=s===!0,n._sender.send(i,e),s?executeQueueSends(n):process.nextTick(t.bind(null,null,r))}catch(o){typeof t=="function"?t(o):(delete n._queue,n.emit("error",o))}};process.nextTick(t.bind(null,null,r))},WebSocket.prototype.terminate=function(){if(this.readyState==WebSocket.CLOSED)return;if(this._socket){try{this._socket.end()}catch(e){cleanupWebsocketResources.call(this,!0);return}this._closeTimer=setTimeout(cleanupWebsocketResources.bind(this,!0),closeTimeout)}else this.readyState==WebSocket.CONNECTING&&cleanupWebsocketResources.call(this,!0)},Object.defineProperty(WebSocket.prototype,"bufferedAmount",{get:function(){var t=0;return this._socket&&(t=this._socket.bufferSize||0),t}}),["open","error","close","message"].forEach(function(e){Object.defineProperty(WebSocket.prototype,"on"+e,{get:function(){var n=this.listeners(e)[0];return n?n._listener?n._listener:n:undefined},set:function(n){this.removeAllListeners(e),this.addEventListener(e,n)}})}),WebSocket.prototype.addEventListener=function(e,t){var n=this;if(typeof t=="function")if(e==="message"){function r(e,r){t.call(this,new MessageEvent(e,r.binary?"Binary":"Text",n))}r._listener=t,this.on(e,r)}else if(e==="close"){function i(e,r){t.call(this,new CloseEvent(e,r,n))}i._listener=t,this.on(e,i)}else if(e==="error"){function s(e){e.target=n,t.call(this,e)}s._listener=t,this.on(e,s)}else if(e==="open"){function o(){t.call(this,new OpenEvent(n))}o._listener=t,this.on(e,o)}else this.on(e,t)},module.exports=WebSocket;