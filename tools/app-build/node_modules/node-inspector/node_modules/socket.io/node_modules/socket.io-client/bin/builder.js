/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

// start with the license header

var fs=require("fs"),socket=require("../lib/io"),uglify=require("uglify-js"),activeXObfuscator=require("active-x-obfuscator"),template="/*! Socket.IO.%ext% build:"+socket.version+", %type%. Copyright(c) 2011 LearnBoost <dev@learnboost.com> MIT Licensed */\n",development=template.replace("%type%","development").replace("%ext%","js"),production=template.replace("%type%","production").replace("%ext%","min.js"),starttagIF="// if node",endtagIF="// end node",base=["io.js","util.js","events.js","json.js","parser.js","transport.js","socket.js","namespace.js"],baseTransports={websocket:["transports/websocket.js"],flashsocket:["transports/websocket.js","transports/flashsocket.js","vendor/web-socket-js/swfobject.js","vendor/web-socket-js/web_socket.js"],htmlfile:["transports/xhr.js","transports/htmlfile.js"],"xhr-polling":["transports/xhr.js","transports/xhr-polling.js"],"jsonp-polling":["transports/xhr.js","transports/xhr-polling.js","transports/jsonp-polling.js"]},wrapperPre="\nvar io = ('undefined' === typeof module ? {} : module.exports);\n(function() {\n",wrapperPost='\nif (typeof define === "function" && define.amd) {\n  define([], function () { return io; });\n}\n})();',builder=module.exports=function(){var e,t,n,r=null,i=Array.prototype.slice.call(arguments,0),s={minify:!0,node:!1,custom:[]};i.forEach(function(r){var i=Object.prototype.toString.call(r).replace(/\[object\s(\w+)\]/gi,"$1").toLowerCase();switch(i){case"array":return e=r;case"object":return t=r;case"function":return n=r}}),t=t||{},e=e||Object.keys(baseTransports);for(var o in t)s[o]=t[o];var u=[];base.forEach(function(e){u.push(__dirname+"/../lib/"+e)}),e.forEach(function(e){var t=baseTransports[e];if(!t){r="Unsupported transport `"+e+"` supplied as argument.";return}t.forEach(function(e){var t=__dirname+"/../lib/"+e;~u.indexOf(t)||u.push(t)})});if(r)return n(r);var a={};u.forEach(function(e){fs.readFile(e,function(t,i){t&&(r=t),a[e]=i;if(Object.keys(a).length!==u.length)return;if(r)return n(r);var o=development,f=0;s.node||(o+=wrapperPre),u.forEach(function(e){o+=a[e]}),s.custom.length&&s.custom.forEach(function(e){o+=e}),s.node||(o+=wrapperPost),o=activeXObfuscator(o),s.node||(o=o.split("\n").filter(function(e){var t=e.indexOf(starttagIF)>=0,n=e.indexOf(endtagIF)>=0,r=f;return t&&(f++,r=f),n&&f--,r==0}).join("\n"));if(s.minify){var l=uglify.parser.parse(o);l=uglify.uglify.ast_mangle(l),l=uglify.uglify.ast_squeeze(l),o=production+uglify.uglify.gen_code(l,{ascii_only:!0})}n(r,o)})})};builder.version=socket.version,builder.transports=baseTransports;if(!module.parent){var args=process.argv.slice(2);builder(args.length?args:!1,{minify:!1},function(e,t){if(e)return console.error(e);fs.write(fs.openSync(__dirname+"/../dist/socket.io.js","w"),t,0,"utf8"),console.log("Successfully generated the development build: socket.io.js")}),builder(args.length?args:!1,function(e,t){if(e)return console.error(e);fs.write(fs.openSync(__dirname+"/../dist/socket.io.min.js","w"),t,0,"utf8"),console.log("Successfully generated the production build: socket.io.min.js")})};