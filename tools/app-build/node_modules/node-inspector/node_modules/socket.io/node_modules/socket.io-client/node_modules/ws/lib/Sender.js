/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function Sender(e){this._socket=e,this.firstFragment=!0}function writeUInt16BE(e,t){this[t]=(e&65280)>>8,this[t+1]=e&255}function writeUInt32BE(e,t){this[t]=(e&4278190080)>>24,this[t+1]=(e&16711680)>>16,this[t+2]=(e&65280)>>8,this[t+3]=e&255}function getArrayBuffer(e){var t=new Uint8Array(e.buffer||e),n=e.byteLength||e.length,r=e.byteOffset||0,i=new Buffer(n);for(var s=0;s<n;++s)i[s]=t[r+s];return i}function getRandomMask(){return new Buffer([~~(Math.random()*255),~~(Math.random()*255),~~(Math.random()*255),~~(Math.random()*255)])}var events=require("events"),util=require("util"),EventEmitter=events.EventEmitter,ErrorCodes=require("./ErrorCodes"),bufferUtil=require("./BufferUtil").BufferUtil;util.inherits(Sender,events.EventEmitter),Sender.prototype.close=function(e,t,n){if(typeof e!="undefined")if(typeof e!="number"||!ErrorCodes.isValidErrorCode(e))throw new Error("first argument must be a valid error code number");e=e||1e3;var r=new Buffer(2+(t?Buffer.byteLength(t):0));writeUInt16BE.call(r,e,0),r.length>2&&r.write(t,2),this.frameAndSend(8,r,!0,n)},Sender.prototype.ping=function(e,t){var n=t&&t.mask;this.frameAndSend(9,e||"",!0,n)},Sender.prototype.pong=function(e,t){var n=t&&t.mask;this.frameAndSend(10,e||"",!0,n)},Sender.prototype.send=function(e,t,n){var r=t&&t.fin===!1?!1:!0,i=t&&t.mask,s=t&&t.binary?2:1;this.firstFragment===!1?s=0:this.firstFragment=!1,r&&(this.firstFragment=!0),this.frameAndSend(s,e,r,i,n)},Sender.prototype.frameAndSend=function(e,t,n,r,i){var s=!1;if(!t){try{this._socket.write(new Buffer([e|(n?128:0),0|(r?128:0)].concat(r?[0,0,0,0]:[])),"binary",i)}catch(o){typeof i=="function"?i(o):this.emit("error",o)}return}Buffer.isBuffer(t)||(s=!0,!t||typeof t.byteLength=="undefined"&&typeof t.buffer=="undefined"?t=new Buffer(t):t=getArrayBuffer(t));var u=t.length,a=r?6:2,f=u;u>=65536?(a+=8,f=127):u>125&&(a+=2,f=126);var l=u<32768||r&&!s,c=l?u+a:a,h=new Buffer(c);h[0]=n?e|128:e;switch(f){case 126:writeUInt16BE.call(h,u,2);break;case 127:writeUInt32BE.call(h,0,2),writeUInt32BE.call(h,u,6)}if(r){h[1]=f|128;var p=this._randomMask||(this._randomMask=getRandomMask());h[a-4]=p[0],h[a-3]=p[1],h[a-2]=p[2],h[a-1]=p[3];if(l){bufferUtil.mask(t,p,h,a,u);try{this._socket.write(h,"binary",i)}catch(o){typeof i=="function"?i(o):this.emit("error",o)}}else{bufferUtil.mask(t,p,t,0,u);try{this._socket.write(h,"binary"),this._socket.write(t,"binary",i)}catch(o){typeof i=="function"?i(o):this.emit("error",o)}}}else{h[1]=f;if(l){t.copy(h,a);try{this._socket.write(h,"binary",i)}catch(o){typeof i=="function"?i(o):this.emit("error",o)}}else try{this._socket.write(h,"binary"),this._socket.write(t,"binary",i)}catch(o){typeof i=="function"?i(o):this.emit("error",o)}}},module.exports=Sender;