var assert=require("assert"),Receiver=require("../lib/Receiver");require("should"),require("./hybi-common"),describe("Receiver",function(){it("can parse unmasked text message",function(){var e=new Receiver,t="81 05 48 65 6c 6c 6f",n=!1;e.ontext=function(e){n=!0,assert.equal("Hello",e)},e.add(getBufferFromHexString(t)),n.should.be.ok}),it("can parse close message",function(){var e=new Receiver,t="88 00",n=!1;e.onclose=function(e){n=!0},e.add(getBufferFromHexString(t)),n.should.be.ok}),it("can parse masked text message",function(){var e=new Receiver,t="81 93 34 83 a8 68 01 b9 92 52 4f a1 c6 09 59 e6 8a 52 16 e6 cb 00 5b a1 d5",n=!1;e.ontext=function(e){n=!0,assert.equal('5:::{"name":"echo"}',e)},e.add(getBufferFromHexString(t)),n.should.be.ok}),it("can parse a masked text message longer than 125 bytes",function(){var e=new Receiver,t="A";for(var n=0;n<300;++n)t+=(n%5).toString();var r="81 FE "+pack(4,t.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(t,"34 83 a8 68")),i=!1;e.ontext=function(e){i=!0,assert.equal(t,e)},e.add(getBufferFromHexString(r)),i.should.be.ok}),it("can parse a really long masked text message",function(){var e=new Receiver,t="A";for(var n=0;n<65536;++n)t+=(n%5).toString();var r="81 FF "+pack(16,t.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(t,"34 83 a8 68")),i=!1;e.ontext=function(e){i=!0,assert.equal(t,e)},e.add(getBufferFromHexString(r)),i.should.be.ok}),it("can parse a fragmented masked text message of 300 bytes",function(){var e=new Receiver,t="A";for(var n=0;n<300;++n)t+=(n%5).toString();var r=t.substr(0,150),i=t.substr(150),s="01 FE "+pack(4,r.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(r,"34 83 a8 68")),o="80 FE "+pack(4,i.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(i,"34 83 a8 68")),u=!1;e.ontext=function(e){u=!0,assert.equal(t,e)},e.add(getBufferFromHexString(s)),e.add(getBufferFromHexString(o)),u.should.be.ok}),it("can parse a ping message",function(){var e=new Receiver,t="Hello",n="89 "+getHybiLengthAsHexString(t.length,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(t,"34 83 a8 68")),r=!1;e.onping=function(e){r=!0,assert.equal(t,e)},e.add(getBufferFromHexString(n)),r.should.be.ok}),it("can parse a ping with no data",function(){var e=new Receiver,t="89 00",n=!1;e.onping=function(e){n=!0},e.add(getBufferFromHexString(t)),n.should.be.ok}),it("can parse a fragmented masked text message of 300 bytes with a ping in the middle",function(){var e=new Receiver,t="A";for(var n=0;n<300;++n)t+=(n%5).toString();var r=t.substr(0,150),i="01 FE "+pack(4,r.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(r,"34 83 a8 68")),s="Hello",o="89 "+getHybiLengthAsHexString(s.length,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(s,"34 83 a8 68")),u=t.substr(150),a="80 FE "+pack(4,u.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(u,"34 83 a8 68")),f=!1;e.ontext=function(e){f=!0,assert.equal(t,e)};var l=!1;e.onping=function(e){l=!0,assert.equal(s,e)},e.add(getBufferFromHexString(i)),e.add(getBufferFromHexString(o)),e.add(getBufferFromHexString(a)),f.should.be.ok,l.should.be.ok}),it("can parse a fragmented masked text message of 300 bytes with a ping in the middle, which is delievered over sevaral tcp packets",function(){var e=new Receiver,t="A";for(var n=0;n<300;++n)t+=(n%5).toString();var r=t.substr(0,150),i="01 FE "+pack(4,r.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(r,"34 83 a8 68")),s="Hello",o="89 "+getHybiLengthAsHexString(s.length,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(s,"34 83 a8 68")),u=t.substr(150),a="80 FE "+pack(4,u.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(u,"34 83 a8 68")),f=!1;e.ontext=function(e){f=!0,assert.equal(t,e)};var l=!1;e.onping=function(e){l=!0,assert.equal(s,e)};var c=[];c=c.concat(splitBuffer(getBufferFromHexString(i))),c=c.concat(splitBuffer(getBufferFromHexString(o))),c=c.concat(splitBuffer(getBufferFromHexString(a)));for(var n=0;n<c.length;++n)e.add(c[n]);f.should.be.ok,l.should.be.ok}),it("can parse a 100 byte long masked binary message",function(){var e=new Receiver,t=100,n=new Buffer(t);for(var r=0;r<t;++r)n[r]=r%256;var i=getHexStringFromBuffer(n),s="82 "+getHybiLengthAsHexString(t,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(n,"34 83 a8 68")),o=!1;e.onbinary=function(e){o=!0,assert.equal(i,getHexStringFromBuffer(e))},e.add(getBufferFromHexString(s)),o.should.be.ok}),it("can parse a 256 byte long masked binary message",function(){var e=new Receiver,t=256,n=new Buffer(t);for(var r=0;r<t;++r)n[r]=r%256;var i=getHexStringFromBuffer(n),s="82 "+getHybiLengthAsHexString(t,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(n,"34 83 a8 68")),o=!1;e.onbinary=function(e){o=!0,assert.equal(i,getHexStringFromBuffer(e))},e.add(getBufferFromHexString(s)),o.should.be.ok}),it("can parse a 200kb long masked binary message",function(){var e=new Receiver,t=204800,n=new Buffer(t);for(var r=0;r<t;++r)n[r]=r%256;var i=getHexStringFromBuffer(n),s="82 "+getHybiLengthAsHexString(t,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(n,"34 83 a8 68")),o=!1;e.onbinary=function(e){o=!0,assert.equal(i,getHexStringFromBuffer(e))},e.add(getBufferFromHexString(s)),o.should.be.ok}),it("can parse a 200kb long unmasked binary message",function(){var e=new Receiver,t=204800,n=new Buffer(t);for(var r=0;r<t;++r)n[r]=r%256;var i=getHexStringFromBuffer(n),s="82 "+getHybiLengthAsHexString(t,!1)+" "+getHexStringFromBuffer(n),o=!1;e.onbinary=function(e){o=!0,assert.equal(i,getHexStringFromBuffer(e))},e.add(getBufferFromHexString(s)),o.should.be.ok})});