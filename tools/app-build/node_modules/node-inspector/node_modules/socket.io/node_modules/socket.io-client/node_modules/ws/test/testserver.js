function validServer(e,t,n){if(typeof t.headers.upgrade=="undefined"||t.headers.upgrade.toLowerCase()!=="websocket")throw new Error("invalid headers");if(!t.headers["sec-websocket-key"])throw n.end(),new Error("websocket key is missing");var r=t.headers["sec-websocket-key"],i=crypto.createHash("sha1");i.update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),r=i.digest("base64");var s=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r];n.write(s.concat("","").join("\r\n")),n.setTimeout(0),n.setNoDelay(!0);var o=new Sender(n),u=new Receiver;u.ontext=function(t,n){e.emit("message",t,n),o.send(t)},u.onbinary=function(t,n){n=n||{},n.binary=!0,e.emit("message",t,n),o.send(t,{binary:!0})},u.onping=function(t,n){n=n||{},e.emit("ping",t,n)},u.onpong=function(t,n){n=n||{},e.emit("pong",t,n)},u.onclose=function(t,n,r){r=r||{},e.emit("close",t,n,r)},n.on("data",function(e){u.add(e)}),n.on("end",function(){n.end()})}function invalidRequestHandler(e,t,n){if(typeof t.headers.upgrade=="undefined"||t.headers.upgrade.toLowerCase()!=="websocket")throw new Error("invalid headers");if(!t.headers["sec-websocket-key"])throw n.end(),new Error("websocket key is missing");var r=t.headers["sec-websocket-key"],i=crypto.createHash("sha1");i.update(r+"bogus"),r=i.digest("base64");var s=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r];n.write(s.concat("","").join("\r\n")),n.end()}function closeAfterConnectHandler(e,t,n){if(typeof t.headers.upgrade=="undefined"||t.headers.upgrade.toLowerCase()!=="websocket")throw new Error("invalid headers");if(!t.headers["sec-websocket-key"])throw n.end(),new Error("websocket key is missing");var r=t.headers["sec-websocket-key"],i=crypto.createHash("sha1");i.update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),r=i.digest("base64");var s=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r];n.write(s.concat("","").join("\r\n")),n.end()}function return401(e,t,n){var r=["HTTP/1.1 401 Unauthorized","Content-type: text/html"];n.write(r.concat("","").join("\r\n")),n.end()}function Server(e){this.webServer=e}var http=require("http"),util=require("util"),crypto=require("crypto"),events=require("events"),Sender=require("../lib/Sender"),Receiver=require("../lib/Receiver");module.exports={handlers:{valid:validServer,invalidKey:invalidRequestHandler,closeAfterConnect:closeAfterConnectHandler,return401:return401},createServer:function(e,t,n){t&&!n&&(n=t,t=null);var r=http.createServer(function(e,t){t.writeHead(200,{"Content-Type":"text/plain"}),t.end("okay")}),i=new Server(r);r.on("upgrade",function(e,n){r._socket=n,(t||validServer)(i,e,n)}),r.listen(e,"127.0.0.1",function(){n(i)})}},util.inherits(Server,events.EventEmitter),Server.prototype.close=function(){this.webServer.close(),this._socket&&this._socket.end()};