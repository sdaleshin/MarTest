/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function Receiver(){this.state=EMPTY,this.buffers=[],this.messageEnd=-1,this.spanLength=0,this.dead=!1,this.onerror=function(){},this.ontext=function(){},this.onbinary=function(){},this.onclose=function(){},this.onping=function(){},this.onpong=function(){}}function bufferIndex(e,t){for(var n=0,r=e.length;n<r;++n)if(e[n]===t)return n;return-1}var util=require("util"),EMPTY=0,BODY=1,BINARYLENGTH=2,BINARYBODY=3;module.exports=Receiver,Receiver.prototype.add=function(e){function n(){if(t.state===EMPTY){if(e.length==2&&e[0]==255&&e[1]==0){t.reset(),t.onclose();return}if(e[0]===128)t.messageEnd=0,t.state=BINARYLENGTH,e=e.slice(1);else{if(e[0]!==0){t.error("payload must start with 0x00 byte",!0);return}e=e.slice(1),t.state=BODY}}if(t.state===BINARYLENGTH){var n=0;while(n<e.length&&e[n]&128)t.messageEnd=128*t.messageEnd+(e[n]&127),++n;n<e.length&&(t.messageEnd=128*t.messageEnd+(e[n]&127),t.state=BINARYBODY,++n),n>0&&(e=e.slice(n))}if(t.state===BINARYBODY){var r=t.messageEnd-t.spanLength;if(e.length>=r)return t.buffers.push(e),t.spanLength+=r,t.messageEnd=r,t.parse();t.buffers.push(e),t.spanLength+=e.length;return}t.buffers.push(e);if((t.messageEnd=bufferIndex(e,255))!=-1)return t.spanLength+=t.messageEnd,t.parse();t.spanLength+=e.length}var t=this;while(e)e=n()},Receiver.prototype.cleanup=function(){this.dead=!0,this.state=EMPTY,this.buffers=[]},Receiver.prototype.parse=function(){var e=new Buffer(this.spanLength),t=0;for(var n=0,r=this.buffers.length;n<r-1;++n){var i=this.buffers[n];i.copy(e,t),t+=i.length}var s=this.buffers[this.buffers.length-1];this.messageEnd>0&&s.copy(e,t,0,this.messageEnd),this.state!==BODY&&--this.messageEnd;var o=null;return this.messageEnd<s.length-1&&(o=s.slice(this.messageEnd+1)),this.reset(),this.ontext(e.toString("utf8")),o},Receiver.prototype.error=function(e,t){return this.reset(),this.onerror(e,t),this},Receiver.prototype.reset=function(e){if(this.dead)return;this.state=EMPTY,this.buffers=[],this.messageEnd=-1,this.spanLength=0};