/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function Receiver(){var e=-1;this.fragmentedBufferPool=new BufferPool(1024,function(e,t){return e.used+t},function(t){return e=e>=0?(e+t.used)/2:t.used});var t=-1;this.unfragmentedBufferPool=new BufferPool(1024,function(e,t){return e.used+t},function(e){return t=t>=0?(t+e.used)/2:e.used}),this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0,fragmentedOperation:!1},this.overflow=[],this.headerBuffer=new Buffer(10),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.currentMessage=[],this.expectHeader(2,this.processPacket),this.dead=!1,this.onerror=function(){},this.ontext=function(){},this.onbinary=function(){},this.onclose=function(){},this.onping=function(){},this.onpong=function(){}}function readUInt16BE(e){return(this[e]<<8)+this[e+1]}function readUInt32BE(e){return(this[e]<<24)+(this[e+1]<<16)+(this[e+2]<<8)+this[e+3]}function fastCopy(e,t,n,r){switch(e){default:t.copy(n,r,0,e);break;case 16:n[r+15]=t[15];case 15:n[r+14]=t[14];case 14:n[r+13]=t[13];case 13:n[r+12]=t[12];case 12:n[r+11]=t[11];case 11:n[r+10]=t[10];case 10:n[r+9]=t[9];case 9:n[r+8]=t[8];case 8:n[r+7]=t[7];case 7:n[r+6]=t[6];case 6:n[r+5]=t[5];case 5:n[r+4]=t[4];case 4:n[r+3]=t[3];case 3:n[r+2]=t[2];case 2:n[r+1]=t[1];case 1:n[r]=t[0]}}var util=require("util"),Validation=require("./Validation").Validation,ErrorCodes=require("./ErrorCodes"),BufferPool=require("./BufferPool"),bufferUtil=require("./BufferUtil").BufferUtil,isNodeV4=/^v0\.4/.test(process.version);module.exports=Receiver,Receiver.prototype.add=function(e){var t=e.length;if(t==0)return;if(this.expectBuffer==null){this.overflow.push(e);return}var n=Math.min(t,this.expectBuffer.length-this.expectOffset);fastCopy(n,e,this.expectBuffer,this.expectOffset),this.expectOffset+=n,n<t&&this.overflow.push(e.slice(n));while(this.expectBuffer&&this.expectOffset==this.expectBuffer.length){var r=this.expectBuffer;this.expectBuffer=null,this.expectOffset=0,this.expectHandler.call(this,r)}},Receiver.prototype.cleanup=function(){this.dead=!0,this.overflow=null,this.headerBuffer=null,this.expectBuffer=null,this.expectHandler=null,this.unfragmentedBufferPool=null,this.fragmentedBufferPool=null,this.state=null,this.currentMessage=null,this.onerror=null,this.ontext=null,this.onbinary=null,this.onclose=null,this.onping=null,this.onpong=null},Receiver.prototype.expectHeader=function(e,t){if(e==0){t(null);return}this.expectBuffer=this.headerBuffer.slice(this.expectOffset,this.expectOffset+e),this.expectHandler=t;var n=e;while(n>0&&this.overflow.length>0){var r=this.overflow.pop();n<r.length&&this.overflow.push(r.slice(n));var i=Math.min(r.length,n);fastCopy(i,r,this.expectBuffer,this.expectOffset),this.expectOffset+=i,n-=i}},Receiver.prototype.expectData=function(e,t){if(e==0){t(null);return}this.expectBuffer=this.allocateFromPool(e,this.state.fragmentedOperation),this.expectHandler=t;var n=e;while(n>0&&this.overflow.length>0){var r=this.overflow.pop();n<r.length&&this.overflow.push(r.slice(n));var i=Math.min(r.length,n);fastCopy(i,r,this.expectBuffer,this.expectOffset),this.expectOffset+=i,n-=i}},Receiver.prototype.allocateFromPool=isNodeV4?function(e){return new Buffer(e)}:function(e,t){return(t?this.fragmentedBufferPool:this.unfragmentedBufferPool).get(e)},Receiver.prototype.processPacket=function(e){if((e[0]&112)!=0){this.error("reserved fields must be empty",1002);return}this.state.lastFragment=(e[0]&128)==128,this.state.masked=(e[1]&128)==128;var t=e[0]&15;if(t===0){this.state.fragmentedOperation=!0,this.state.opcode=this.state.activeFragmentedOperation;if(this.state.opcode!=1&&this.state.opcode!=2){this.error("continuation frame cannot follow current opcode",1002);return}}else{if(t<3&&this.state.activeFragmentedOperation!=null){this.error("data frames after the initial data frame must have opcode 0",1002);return}this.state.opcode=t,this.state.lastFragment===!1?(this.state.fragmentedOperation=!0,this.state.activeFragmentedOperation=t):this.state.fragmentedOperation=!1}var n=opcodes[this.state.opcode];typeof n=="undefined"?this.error("no handler for opcode "+this.state.opcode,1002):n.start.call(this,e)},Receiver.prototype.endPacket=function(){this.state.fragmentedOperation?this.state.lastFragment&&this.fragmentedBufferPool.reset(!1):this.unfragmentedBufferPool.reset(!0),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.state.lastFragment&&this.state.opcode===this.state.activeFragmentedOperation&&(this.state.activeFragmentedOperation=null),this.state.lastFragment=!1,this.state.opcode=this.state.activeFragmentedOperation!=null?this.state.activeFragmentedOperation:0,this.state.masked=!1,this.expectHeader(2,this.processPacket)},Receiver.prototype.reset=function(){if(this.dead)return;this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0,fragmentedOperation:!1},this.fragmentedBufferPool.reset(!0),this.unfragmentedBufferPool.reset(!0),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.overflow=[],this.currentMessage=[]},Receiver.prototype.unmask=function(e,t,n){return e!=null&&t!=null&&bufferUtil.unmask(t,e),n?t:t!=null?t.toString("utf8"):""},Receiver.prototype.concatBuffers=function(e){var t=0;for(var n=0,r=e.length;n<r;++n)t+=e[n].length;var i=new Buffer(t);return bufferUtil.merge(i,e),i},Receiver.prototype.error=function(e,t){return this.reset(),this.onerror(e,t),this};var opcodes={1:{start:function(e){var t=this,n=e[1]&127;n<126?opcodes[1].getData.call(t,n):n==126?t.expectHeader(2,function(e){opcodes[1].getData.call(t,readUInt16BE.call(e,0))}):n==127&&t.expectHeader(8,function(e){if(readUInt32BE.call(e,0)!=0){t.error("packets with length spanning more than 32 bit is currently not supported",1008);return}opcodes[1].getData.call(t,readUInt32BE.call(e,4))})},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(n){var r=n;t.expectData(e,function(e){opcodes[1].finish.call(t,r,e)})}):t.expectData(e,function(e){opcodes[1].finish.call(t,null,e)})},finish:function(e,t){var n=this.unmask(e,t,!0);n!=null&&this.currentMessage.push(n);if(this.state.lastFragment){var r=this.concatBuffers(this.currentMessage);if(!Validation.isValidUTF8(r)){this.error("invalid utf8 sequence",1007);return}this.ontext(r.toString("utf8"),{masked:this.state.masked,buffer:r}),this.currentMessage=[]}this.endPacket()}},2:{start:function(e){var t=this,n=e[1]&127;n<126?opcodes[2].getData.call(t,n):n==126?t.expectHeader(2,function(e){opcodes[2].getData.call(t,readUInt16BE.call(e,0))}):n==127&&t.expectHeader(8,function(e){if(readUInt32BE.call(e,0)!=0){t.error("packets with length spanning more than 32 bit is currently not supported",1008);return}opcodes[2].getData.call(t,readUInt32BE.call(e,4,!0))})},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(n){var r=n;t.expectData(e,function(e){opcodes[2].finish.call(t,r,e)})}):t.expectData(e,function(e){opcodes[2].finish.call(t,null,e)})},finish:function(e,t){var n=this.unmask(e,t,!0);n!=null&&this.currentMessage.push(n);if(this.state.lastFragment){var r=this.concatBuffers(this.currentMessage);this.onbinary(r,{masked:this.state.masked,buffer:r}),this.currentMessage=[]}this.endPacket()}},8:{start:function(e){var t=this;if(t.state.lastFragment==0){t.error("fragmented close is not supported",1002);return}var n=e[1]&127;n<126?opcodes[8].getData.call(t,n):t.error("control frames cannot have more than 125 bytes of data",1002)},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(n){var r=n;t.expectData(e,function(e){opcodes[8].finish.call(t,r,e)})}):t.expectData(e,function(e){opcodes[8].finish.call(t,null,e)})},finish:function(e,t){var n=this;t=n.unmask(e,t,!0);if(t&&t.length==1){n.error("close packets with data must be at least two bytes long",1002);return}var r=t&&t.length>1?readUInt16BE.call(t,0):1e3;if(!ErrorCodes.isValidErrorCode(r)){n.error("invalid error code",1002);return}var i="";if(t&&t.length>2){var s=t.slice(2);if(!Validation.isValidUTF8(s)){n.error("invalid utf8 sequence",1007);return}i=s.toString("utf8")}this.onclose(r,i,{masked:n.state.masked}),this.reset()}},9:{start:function(e){var t=this;if(t.state.lastFragment==0){t.error("fragmented ping is not supported",1002);return}var n=e[1]&127;n<126?opcodes[9].getData.call(t,n):t.error("control frames cannot have more than 125 bytes of data",1002)},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(n){var r=n;t.expectData(e,function(e){opcodes[9].finish.call(t,r,e)})}):t.expectData(e,function(e){opcodes[9].finish.call(t,null,e)})},finish:function(e,t){this.onping(this.unmask(e,t,!0),{masked:this.state.masked,binary:!0}),this.endPacket()}},10:{start:function(e){var t=this;if(t.state.lastFragment==0){t.error("fragmented pong is not supported",1002);return}var n=e[1]&127;n<126?opcodes[10].getData.call(t,n):t.error("control frames cannot have more than 125 bytes of data",1002)},getData:function(e){var t=this;this.state.masked?this.expectHeader(4,function(n){var r=n;t.expectData(e,function(e){opcodes[10].finish.call(t,r,e)})}):this.expectData(e,function(e){opcodes[10].finish.call(t,null,e)})},finish:function(e,t){this.onpong(this.unmask(e,t,!0),{masked:this.state.masked,binary:!0}),this.endPacket()}}};