function BandwidthSampler(e,t){t=t||2e3;var n=0,r=this,i=setInterval(function(){var i=e.bytesReceived,s=(i-n)/(t/1e3);n=i,r.emit("sample",s)},t);e.on("close",function(){clearInterval(i)})}function makePathForFile(e,t,n){function s(e){if(e)return n(e);if(r.length==0)return n(null,i);i+="/"+r.shift(),fs.exists(i,function(e){e?process.nextTick(s):fs.mkdir(i,s)})}if(typeof n!="function")throw new Error("callback is required");e=path.dirname(path.normalize(e)).replace(/^(\/|\\)+/,"");var r=e.split(/(\\|\/)/),i=t;s()}var WebSocketServer=require("../../").Server,express=require("express"),fs=require("fs"),http=require("http"),util=require("util"),path=require("path"),app=express.createServer(),events=require("events"),ansi=require("ansi"),cursor=ansi(process.stdout);util.inherits(BandwidthSampler,events.EventEmitter),cursor.eraseData(2).goto(1,1),app.use(express.static(__dirname+"/public"));var clientId=0,wss=new WebSocketServer({server:app});wss.on("connection",function(e){var t=++clientId;cursor.goto(1,4+t).eraseLine(),console.log("Client #%d connected",t);var n=new BandwidthSampler(e);n.on("sample",function(e){cursor.goto(1,4+t).eraseLine(),console.log("WebSocket #%d incoming bandwidth: %d MB/s",t,Math.round(e/1048576))});var r=0,i=null;e.on("message",function(t,n){if(!n.binary)i=JSON.parse(t);else{if(i==null)return;makePathForFile(i.path,__dirname+"/uploaded",function(n,s){if(n){console.log(n),e.send(JSON.stringify({event:"error",path:i.path,message:n.message}));return}fs.writeFile(s+"/"+i.name,t,function(t){++r,e.send(JSON.stringify({event:"complete",path:i.path})),i=null})})}}),e.on("close",function(){cursor.goto(1,4+t).eraseLine(),console.log("Client #%d disconnected. %d files received.",t,r)}),e.on("error",function(e){cursor.goto(1,4+t).eraseLine(),console.log("Client #%d error: %s",t,e.message)})}),fs.mkdir(__dirname+"/uploaded",function(e){console.log("Uploaded files will be saved to %s/uploaded.",__dirname),console.log("Remember to wipe this directory if you upload lots and lots."),app.listen(8080),console.log("Listening on http://localhost:8080")});