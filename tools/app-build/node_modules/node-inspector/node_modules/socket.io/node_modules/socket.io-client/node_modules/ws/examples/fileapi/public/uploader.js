function Uploader(e,t){this.ws=new WebSocket(e),t&&(this.ws.onopen=t),this.sendQueue=[],this.sending=null,this.sendCallback=null,this.ondone=null;var n=this;this.ws.onmessage=function(e){var t=JSON.parse(e.data);if(t.event=="complete"){if(t.path!=n.sending.path)throw n.sendQueue=[],n.sending=null,n.sendCallback=null,new Error("Got message for wrong file!");n.sending=null;var r=n.sendCallback;n.sendCallback=null,r&&r(),n.sendQueue.length===0&&n.ondone&&n.ondone(null);if(n.sendQueue.length>0){var i=n.sendQueue.pop();setTimeout(function(){n.sendFile.apply(n,i)},0)}}else if(t.event=="error"){n.sendQueue=[],n.sending=null;var r=n.sendCallback;n.sendCallback=null;var s=new Error("Server reported send error for file "+t.path);r&&r(s),n.ondone&&n.ondone(s)}}}Uploader.prototype.sendFile=function(e,t){if(this.ws.readyState!=WebSocket.OPEN)throw new Error("Not connected");if(this.sending){this.sendQueue.push(arguments);return}var n={name:e.name,path:e.webkitRelativePath};this.sending=n,this.sendCallback=t,this.ws.send(JSON.stringify(n)),this.ws.send(e)},Uploader.prototype.close=function(){this.ws.close()};