function empty(){}function XHR(e){Polling.call(this,e),global.location&&(this.xd=e.host!=global.location.hostname||global.location.port!=e.port)}function Request(e){this.method=e.method||"GET",this.uri=e.uri,this.xd=!!e.xd,this.async=!1!==e.async,this.data=undefined!=e.data?e.data:null,this.create()}var Polling=require("./polling"),util=require("../util"),Emitter=require("../emitter"),debug=require("debug")("engine.io-client:polling-xhr");module.exports=XHR,module.exports.Request=Request;var global="undefined"!=typeof window?window:global,xobject=global[["Active"].concat("Object").join("X")];util.inherits(XHR,Polling),XHR.prototype.doOpen=function(){var e=this;util.defer(function(){Polling.prototype.doOpen.call(e)})},XHR.prototype.request=function(e){return e=e||{},e.uri=this.uri(),e.xd=this.xd,new Request(e)},XHR.prototype.doWrite=function(e,t){var n=this.request({method:"POST",data:e}),r=this;n.on("success",t),n.on("error",function(e){r.onError("xhr post error",e)}),this.sendXhr=n},XHR.prototype.doPoll=function(){debug("xhr poll");var e=this.request(),t=this;e.on("data",function(e){t.onData(e)}),e.on("error",function(e){t.onError("xhr poll error",e)}),this.pollXhr=e},Emitter(Request.prototype),Request.prototype.create=function(){var e=this.xhr=util.request(this.xd),t=this;e.open(this.method,this.uri,this.async);if("POST"==this.method)try{e.setRequestHeader?e.setRequestHeader("Content-type","text/plain;charset=UTF-8"):e.contentType="text/plain"}catch(n){}this.xd&&global.XDomainRequest&&e instanceof XDomainRequest?(e.onerror=function(e){t.onError(e)},e.onload=function(){t.onData(e.responseText)},e.onprogress=empty):("withCredentials"in e&&(e.withCredentials=!0),e.onreadystatechange=function(){var n;try{if(4!=e.readyState)return;200==e.status||1223==e.status?n=e.responseText:t.onError(e.status)}catch(r){t.onError(r)}undefined!==n&&t.onData(n)}),debug("sending xhr with url %s | data %s",this.uri,this.data),e.send(this.data),xobject&&(this.index=Request.requestsCount++,Request.requests[this.index]=this)},Request.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Request.prototype.onData=function(e){this.emit("data",e),this.onSuccess()},Request.prototype.onError=function(e){this.emit("error",e),this.cleanup()},Request.prototype.cleanup=function(){this.xhr.onreadystatechange=empty,this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(e){}xobject&&delete Request.requests[this.index],this.xhr=null},Request.prototype.abort=function(){this.cleanup()},xobject&&(Request.requestsCount=0,Request.requests={},global.attachEvent("onunload",function(){for(var e in Request.requests)Request.requests.hasOwnProperty(e)&&Request.requests[e].abort()}));