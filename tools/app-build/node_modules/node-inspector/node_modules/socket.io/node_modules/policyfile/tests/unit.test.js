var fspfs=require("../"),fs=require("fs"),http=require("http"),https=require("https"),net=require("net"),should=require("should"),assert=require("assert");module.exports={"Library version":function(){fspfs.version.should.match(/^\d+\.\d+\.\d+$/)},"Create Server instance":function(){var e=fspfs.createServer(),t=new fspfs.Server({log:!1},["blog.3rd-Eden.com:1337"]);t.log.should.be.false,t.origins.length.should.equal(1),t.origins[0].should.equal("blog.3rd-Eden.com:1337"),(typeof e.log).should.be.equal("function"),e.origins.length.should.equal(1),e.origins[0].should.equal("*:*"),assert.ok(e instanceof fspfs.Server),assert.ok(!!e.buffer),e=fspfs.createServer(["blog.3rd-Eden.com:80"]),e.origins.length.should.equal(1),e.origins[0].should.equal("blog.3rd-Eden.com:80"),e=fspfs.createServer({log:!1},["blog.3rd-Eden.com:80"]),e.log.should.be.false,e.origins.length.should.equal(1),e.origins[0].should.equal("blog.3rd-Eden.com:80")},"Add origin":function(){var e=fspfs.createServer();e.add("google.com:80","blog.3rd-Eden.com:1337"),e.origins.length.should.equal(3),e.origins.indexOf("google.com:80").should.be.above(0),e.add("google.com:80","google.com:80");var t=e.origins.length,n=0;while(t--)e.origins[t]==="google.com:80"&&n++;n.should.equal(1)},"Remove origin":function(){var e=fspfs.createServer();e.add("google.com:80","blog.3rd-Eden.com:1337"),e.origins.length.should.equal(3),e.remove("google.com:80"),e.origins.length.should.equal(2),e.origins.indexOf("google.com:80").should.equal(-1)},Buffer:function(){var e=fspfs.createServer();Buffer.isBuffer(e.buffer).should.be.true,e.buffer.toString().indexOf('to-ports="*"').should.be.above(0),e.buffer.toString().indexOf('domain="*"').should.be.above(0),e.buffer.toString().indexOf('domain="google.com"').should.equal(-1),e.add("google.com:80"),e.buffer.toString().indexOf('to-ports="80"').should.be.above(0),e.buffer.toString().indexOf('domain="google.com"').should.be.above(0),e.remove("google.com:80"),e.buffer.toString().indexOf('to-ports="80"').should.equal(-1),e.buffer.toString().indexOf('domain="google.com"').should.equal(-1)},Responder:function(){var e=fspfs.createServer(),t=0,n={readyState:"open",end:function(n){t++,Buffer.isBuffer(n).should.be.true,n.toString().should.equal(e.buffer.toString())}};e.responder(n),t.should.equal(1)},"Event proxy":function(){var e=fspfs.createServer(),t=0;Object.keys(process.EventEmitter.prototype).forEach(function(n){assert.ok(!!e[n]&&typeof e[n]=="function")}),e.on("pew",function(){t++}),e.emit("pew"),t.should.equal(1)},"inline response http":function(){var e=1335,t=http.createServer(function(e,t){t.writeHead(200),t.end(":3")}),n=fspfs.createServer();t.listen(e,function(){n.listen(e+1,t,function(){var r=net.createConnection(e);r.write("<policy-file-request/>\0"),r.on("error",function(e){assert.ok(!e,e)}),r.on("data",function(e){var i=e.toString();console.log(i),i.indexOf('to-ports="*"').should.be.above(0),i.indexOf('domain="*"').should.be.above(0),i.indexOf('domain="google.com"').should.equal(-1),r.destroy(),n.close(),t.close()})})})},"server response":function(){var e=1340,t=fspfs.createServer();t.listen(e,function(){var n=net.createConnection(e);n.write("<policy-file-request/>\0"),n.on("error",function(e){assert.ok(!e,e)}),n.on("data",function(e){var r=e.toString();r.indexOf('to-ports="*"').should.be.above(0),r.indexOf('domain="*"').should.be.above(0),r.indexOf('domain="google.com"').should.equal(-1),n.destroy(),t.close()})})},"inline response https":function(){var e=1345,t={key:fs.readFileSync(__dirname+"/ssl/ssl.private.key").toString(),cert:fs.readFileSync(__dirname+"/ssl/ssl.crt").toString()},n=https.createServer(t,function(e,t){t.writeHead(200),t.end(":3")}),r=fspfs.createServer();n.listen(e,function(){r.listen(e+1,n,function(){var t=net.createConnection(e);t.write("<policy-file-request/>\0"),t.on("error",function(e){assert.ok(!e,e)}),t.on("data",function(e){var i=e.toString();i.indexOf('to-ports="*"').should.be.above(0),i.indexOf('domain="*"').should.be.above(0),i.indexOf('domain="google.com"').should.equal(-1),t.destroy(),r.close(),n.close()})})})},connect_failed:function(){var e=fspfs.createServer();e.on("connect_failed",function(){assert.ok(!0)}),e.listen(function(){assert.ok(!1,"Run this test without root access"),e.close()})}};