function RedisReplyParser(e){this.name=exports.name,this.options=e||{},this.reset(),events.EventEmitter.call(this)}function small_toString(e,t){var n="",r;for(r=0;r<t;r+=1)n+=String.fromCharCode(e[r]);return n}var events=require("events"),util=require("../util");exports.debug_mode=!1,exports.name="javascript",util.inherits(RedisReplyParser,events.EventEmitter),exports.Parser=RedisReplyParser,RedisReplyParser.prototype.reset=function(){this.return_buffer=new Buffer(16384),this.return_string="",this.tmp_string="",this.multi_bulk_length=0,this.multi_bulk_replies=null,this.multi_bulk_pos=0,this.multi_bulk_nested_length=0,this.multi_bulk_nested_replies=null,this.states={TYPE:1,SINGLE_LINE:2,MULTI_BULK_COUNT:3,INTEGER_LINE:4,BULK_LENGTH:5,ERROR_LINE:6,BULK_DATA:7,UNKNOWN_TYPE:8,FINAL_CR:9,FINAL_LF:10,MULTI_BULK_COUNT_LF:11,BULK_LF:12},this.state=this.states.TYPE},RedisReplyParser.prototype.parser_error=function(e){this.emit("error",e),this.reset()},RedisReplyParser.prototype.execute=function(e){var t=0,n,r,i,s,o=this.states;while(t<e.length)switch(this.state){case 1:this.type=e[t],t+=1;switch(this.type){case 43:this.state=o.SINGLE_LINE,this.return_buffer.end=0,this.return_string="";break;case 42:this.state=o.MULTI_BULK_COUNT,this.tmp_string="";break;case 58:this.state=o.INTEGER_LINE,this.return_buffer.end=0,this.return_string="";break;case 36:this.state=o.BULK_LENGTH,this.tmp_string="";break;case 45:this.state=o.ERROR_LINE,this.return_buffer.end=0,this.return_string="";break;default:this.state=o.UNKNOWN_TYPE}break;case 4:e[t]===13?(this.send_reply(+small_toString(this.return_buffer,this.return_buffer.end)),this.state=o.FINAL_LF):(this.return_buffer[this.return_buffer.end]=e[t],this.return_buffer.end+=1),t+=1;break;case 6:e[t]===13?(this.send_error(this.return_buffer.toString("ascii",0,this.return_buffer.end)),this.state=o.FINAL_LF):(this.return_buffer[this.return_buffer.end]=e[t],this.return_buffer.end+=1),t+=1;break;case 2:e[t]===13?(this.send_reply(this.return_string),this.state=o.FINAL_LF):this.return_string+=String.fromCharCode(e[t]),t+=1;break;case 3:e[t]===13?this.state=o.MULTI_BULK_COUNT_LF:this.tmp_string+=String.fromCharCode(e[t]),t+=1;break;case 11:if(e[t]!==10){this.parser_error(new Error("didn't see LF after NL reading multi bulk count"));return}this.multi_bulk_length&&(this.multi_bulk_nested_length=this.multi_bulk_length,this.multi_bulk_nested_replies=this.multi_bulk_replies,this.multi_bulk_nested_pos=this.multi_bulk_pos),this.multi_bulk_length=+this.tmp_string,this.multi_bulk_pos=0,this.state=o.TYPE,this.multi_bulk_length<0?(this.send_reply(null),this.multi_bulk_length=0):this.multi_bulk_length===0?(this.multi_bulk_pos=0,this.multi_bulk_replies=null,this.send_reply([])):this.multi_bulk_replies=new Array(this.multi_bulk_length),t+=1;break;case 5:e[t]===13?this.state=o.BULK_LF:this.tmp_string+=String.fromCharCode(e[t]),t+=1;break;case 12:if(e[t]!==10){this.parser_error(new Error("didn't see LF after NL while reading bulk length"));return}this.bulk_length=+this.tmp_string,this.bulk_length===-1?(this.send_reply(null),this.state=o.TYPE):this.bulk_length===0?(this.send_reply(new Buffer("")),this.state=o.FINAL_CR):(this.state=o.BULK_DATA,this.bulk_length>this.return_buffer.length&&(exports.debug_mode&&console.log("Growing return_buffer from "+this.return_buffer.length+" to "+this.bulk_length),this.return_buffer=new Buffer(this.bulk_length)),this.return_buffer.end=0),t+=1;break;case 7:this.return_buffer[this.return_buffer.end]=e[t],this.return_buffer.end+=1,t+=1;if(this.return_buffer.end===this.bulk_length){n=new Buffer(this.bulk_length);if(this.bulk_length>10)this.return_buffer.copy(n,0,0,this.bulk_length);else for(i=0,s=this.bulk_length;i<s;i+=1)n[i]=this.return_buffer[i];this.send_reply(n),this.state=o.FINAL_CR}break;case 9:if(e[t]!==13){this.parser_error(new Error("saw "+e[t]+" when expecting final CR"));return}this.state=o.FINAL_LF,t+=1;break;case 10:if(e[t]!==10){this.parser_error(new Error("saw "+e[t]+" when expecting final LF"));return}this.state=o.TYPE,t+=1;break;default:this.parser_error(new Error("invalid state "+this.state))}},RedisReplyParser.prototype.send_error=function(e){this.multi_bulk_length>0||this.multi_bulk_nested_length>0?this.add_multi_bulk_reply(e):this.emit("reply error",e)},RedisReplyParser.prototype.send_reply=function(e){this.multi_bulk_length>0||this.multi_bulk_nested_length>0?!this.options.return_buffers&&Buffer.isBuffer(e)?this.add_multi_bulk_reply(e.toString("utf8")):this.add_multi_bulk_reply(e):!this.options.return_buffers&&Buffer.isBuffer(e)?this.emit("reply",e.toString("utf8")):this.emit("reply",e)},RedisReplyParser.prototype.add_multi_bulk_reply=function(e){if(this.multi_bulk_replies){this.multi_bulk_replies[this.multi_bulk_pos]=e,this.multi_bulk_pos+=1;if(this.multi_bulk_pos<this.multi_bulk_length)return}else this.multi_bulk_replies=e;this.multi_bulk_nested_length>0?(this.multi_bulk_nested_replies[this.multi_bulk_nested_pos]=this.multi_bulk_replies,this.multi_bulk_nested_pos+=1,this.multi_bulk_length=0,this.multi_bulk_replies=null,this.multi_bulk_pos=0,this.multi_bulk_nested_length===this.multi_bulk_nested_pos&&(this.emit("reply",this.multi_bulk_nested_replies),this.multi_bulk_nested_length=0,this.multi_bulk_nested_pos=0,this.multi_bulk_nested_replies=null)):(this.emit("reply",this.multi_bulk_replies),this.multi_bulk_length=0,this.multi_bulk_replies=null,this.multi_bulk_pos=0)};