function DebuggerAgent(e,t,n,r,i){this._saveLiveEdit=e.saveLiveEdit,this._frontendClient=t,this._debuggerClient=n,this._breakEventHandler=r,this._scriptManager=i,this._scriptStorage=new ScriptFileStorage(e.isScriptHidden)}var convert=require("./convert.js"),format=require("util").format,path=require("path"),async=require("async"),ScriptFileStorage=require("./ScriptFileStorage").ScriptFileStorage;DebuggerAgent.prototype={canSetScriptSource:function(e,t){t(null,{result:!0})},enable:function(e,t){this._debuggerClient.on("connect",function(){t(),this._onDebuggerConnect()}.bind(this)),this._debuggerClient.connect()},_onDebuggerConnect:function(){async.waterfall([this._removeAllBreakpoints.bind(this),this._reloadScripts.bind(this),this._sendBacktraceIfPaused.bind(this)])},_removeAllBreakpoints:function(e){this._debuggerClient.request("listbreakpoints",{},function(t,n){function r(e,t){this._debuggerClient.clearBreakpoint(e.number,function(n){n&&console.log("Warning: cannot remove old breakpoint %d. %s",e.number,n),t()})}if(t){console.log("Warning: cannot remove old breakpoints. %s",t),e();return}async.eachSeries(n.breakpoints,r.bind(this),e)}.bind(this))},_reloadScripts:function(e){this._scriptManager.reset(),this._debuggerClient.request("scripts",{includeSource:!1,types:4},function(n,r){if(n){e(n);return}r.forEach(this._scriptManager.addScript.bind(this._scriptManager)),e()}.bind(this))},_sendBacktraceIfPaused:function(e){this._debuggerClient.isRunning||this._breakEventHandler.sendBacktraceToFrontend(null),e()},disable:function(e,t){this._debuggerClient.close(),t()},resume:function(e,t){this._sendContinue(undefined,t)},_sendContinue:function(e,t){var n=e?{stepaction:e}:undefined;this._debuggerClient.request("continue",n,function(e,n){t(e),e||this._frontendClient.sendEvent("Debugger.resumed")}.bind(this))},pause:function(e,t){this._debuggerClient.request("suspend",{},function(e,n){t(e),e||this._breakEventHandler.sendBacktraceToFrontend(null)}.bind(this))},stepOver:function(e,t){this._sendContinue("next",t)},stepInto:function(e,t){this._sendContinue("in",t)},stepOut:function(e,t){this._sendContinue("out",t)},continueToLocation:function(e,t){var n={type:"scriptId",target:convert.inspectorScriptIdToV8Id(e.location.scriptId),line:e.location.lineNumber,column:e.location.columnNumber};this._debuggerClient.request("setbreakpoint",n,function(e,n){if(e!=null){t(e);return}this._breakEventHandler.continueToLocationBreakpointId=n.breakpoint,this._debuggerClient.request("continue",undefined,function(e,n){t(e)})}.bind(this))},getScriptSource:function(e,t){this._debuggerClient.getScriptSourceById(Number(e.scriptId),function(e,n){return e?t(e):t(null,{scriptSource:n})})},setScriptSource:function(e,t){this._debuggerClient.request("changelive",{script_id:convert.inspectorScriptIdToV8Id(e.scriptId),new_source:e.scriptSource,preview_only:!1},function(n,r){this._handleChangeLiveOrRestartFrameResponse(t,n,r),this._persistScriptChanges(e.scriptId,e.scriptSource)}.bind(this))},_handleChangeLiveOrRestartFrameResponse:function(e,t,n){function s(t){e(null,{callFrames:t||[],result:n.result})}function o(){i.fetchCallFrames(function(e,t){var n=[];e?r.sendLogToConsole("error","Cannot update stack trace after a script changed: "+e):n=t,s(n)})}if(t){e(t);return}var r=this._frontendClient,i=this._breakEventHandler,u=n.result;u.stack_modified&&!u.stack_update_needs_step_in?o():s()},_persistScriptChanges:function(e,t){if(!this._saveLiveEdit){this._warn('Saving of live-edit changes back to source files is disabled by configuration.\nChange the option "saveLiveEdit" in config.json to enable this feature.');return}var n=this._scriptManager.findScriptByID(e);if(!n){this._warn("Cannot save changes to disk: unknown script id %s",e);return}var r=n.v8name;if(!r||r.indexOf(path.sep)==-1){this._warn('Cannot save changes to disk: script id %s "%s" was not loaded from a file.',e,r||"null");return}this._scriptStorage.save(r,t,function(e){e&&this._warn("Cannot save changes to disk. %s",e)}.bind(this))},_warn:function(){this._frontendClient.sendLogToConsole("warning",format.apply(this,arguments))},setPauseOnExceptions:function(e,t){var n=[{type:"all",enabled:e.state=="all"},{type:"uncaught",enabled:e.state=="uncaught"}];async.eachSeries(n,function(e,t){this._debuggerClient.request("setexceptionbreak",e,t)}.bind(this),t)},setBreakpointByUrl:function(e,t){if(e.urlRegex!==undefined){t("Error: setBreakpointByUrl using urlRegex is not implemented.");return}var n={type:"script",target:convert.inspectorUrlToV8Name(e.url),line:e.lineNumber,column:e.columnNumber,condition:e.condition};this._debuggerClient.request("setbreakpoint",n,function(e,n){if(e!=null){t(e);return}t(null,{breakpointId:n.breakpoint.toString(),locations:n.actual_locations.map(convert.v8LocationToInspectorLocation)})})},removeBreakpoint:function(e,t){this._debuggerClient.clearBreakpoint(e.breakpointId,function(e,n){t(e,null)})},setBreakpointsActive:function(e,t){this._debuggerClient.request("listbreakpoints",{},function(n,r){function i(t,n){var r={breakpoint:t.number,enabled:e.active};this._debuggerClient.request("changebreakpoint",r,n)}if(n){t(n);return}async.eachSeries(r.breakpoints,i.bind(this),t)}.bind(this))},setOverlayMessage:function(e,t){t()},evaluateOnCallFrame:function(e,t){var n=this,r=e.expression,i=Number(e.callFrameId);n._debuggerClient.request("evaluate",{expression:e.expression,frame:i},function(e,n){e&&(e=convert.v8ErrorToInspectorError(e)),t(null,{result:e||convert.v8ResultToInspectorResult(n),wasThrown:!!e})})},getFunctionDetails:function(e,t){var n=e.functionId;this._debuggerClient.request("lookup",{handles:[n],includeSource:!1},function(e,r){e?t(e):t(null,convert.v8FunctionLookupToFunctionDetails(r[n]))}.bind(this))},restartFrame:function(e,t){this._debuggerClient.request("restartframe",{frame:Number(e.callFrameId)},this._handleChangeLiveOrRestartFrameResponse.bind(this,t))},setVariableValue:function(e,t){this._debuggerClient.evaluateGlobal("process.version",function(n,r){DebuggerAgent.nodeVersionHasSetVariableValue(r)?this._doSetVariableValue(e,t):t("V8 engine in node version "+r+" does not support setting variable value from debugger.\n"+" Please upgrade to version v0.10.12 (stable) or v0.11.2 (unstable)"+" or newer.")}.bind(this))},_doSetVariableValue:function(e,t){var n=e.newValue;n.value===undefined&&n.objectId===undefined&&(n.type="undefined"),this._debuggerClient.request("setVariableValue",{name:e.variableName,scope:{number:Number(e.scopeNumber),frameNumber:Number(e.callFrameId)},newValue:n},function(e,n){t(e,n)})}},DebuggerAgent.nodeVersionHasSetVariableValue=function(e){var t=/^v(\d+)\.(\d+)\.(\d+)$/.exec(e);return t?t[1]>0||t[2]==10&&t[3]>=12||t[2]==11&&t[3]>=2||t[2]>=12:!1},exports.DebuggerAgent=DebuggerAgent;