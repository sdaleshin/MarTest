function makeMessage(){return{headersDone:!1,headers:null,contentLength:0}}var Net=require("net"),EventEmitter=require("events").EventEmitter,Buffer=require("buffer").Buffer,debugProtocol=require("debug")("node-inspector:protocol:v8-debug");callbackHandler=require("./callback").create(),exports.attachDebugger=function(e){function f(){var e,t;if(r&&r.headersDone){Buffer.byteLength(n)>=r.contentLength&&(e=new Buffer(n),r.body=e.toString("utf8",0,r.contentLength),n=e.toString("utf8",r.contentLength,e.length),r.body.length>0&&(t=JSON.parse(r.body),typeof t.running=="boolean"&&(s.isRunning=t.running),t.type==="response"&&t.request_seq>0?(debugProtocol("response: "+r.body),callbackHandler.processResponse(t.request_seq,[t])):t.type==="event"?(debugProtocol("event: "+r.body),s.emit(t.event,t)):debugProtocol("unknown: "+r.body)),r=!1,f());return}r||(r=makeMessage()),o=n.indexOf("\r\n\r\n"),o>0&&(r.headersDone=!0,r.headers=n.substr(0,o+4),u=/Content-Length: (\d+)/.exec(r.headers),u[1]?r.contentLength=parseInt(u[1],10):console.warn("no Content-Length"),n=n.slice(o+4),f())}var t=!1,n="",r=!1,i=Net.createConnection(e),s,o,u,a;return i.setEncoding("utf8"),s=Object.create(EventEmitter.prototype,{isRunning:{writable:!0,value:!0},send:{value:function(e){debugProtocol("request: "+e),t&&i.write("Content-Length: "+e.length+"\r\n\r\n"+e)}},request:{value:function(e,t,n){var r={seq:0,type:"request",command:e};typeof n=="function"&&(r.seq=callbackHandler.wrap(n)),t&&Object.keys(t).forEach(function(e){r[e]=t[e]}),this.send(JSON.stringify(r))}},close:{value:function(){i.end()}},connected:{get:function(){return t}}}),i.on("connect",function(){t=!0,s.emit("connect")}),i.on("data",function(e){n+=e,f()}),i.on("error",function(t){t.code=="ECONNREFUSED"?t.helpString="Is node running with --debug port "+e+"?":t.code=="ECONNRESET"&&(t.helpString="Check there is no other debugger client attached to port "+e+"."),a=t.toString(),t.helpString&&(a+=". "+t.helpString),s.emit("error",t)}),i.on("end",function(){s.close()}),i.on("close",function(){t=!1,s.emit("close",a||"Debugged process exited.")}),s};