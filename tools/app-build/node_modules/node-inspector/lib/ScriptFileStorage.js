function escapeRegex(e){return e.replace(/([/\\.?*()^${}|[\]])/g,"\\$1")}function ScriptFileStorage(e){this._isHidden=e||function(){return!1}}var fs=require("fs"),path=require("path"),async=require("async"),glob=require("glob"),MODULE_HEADER="(function (exports, require, module, __filename, __dirname) { ",MODULE_TRAILER="\n});",MODULE_WRAP_REGEX=new RegExp("^"+escapeRegex(MODULE_HEADER)+"([\\s\\S]*)"+escapeRegex(MODULE_TRAILER)+"$"),$class=ScriptFileStorage.prototype;$class.save=function(e,t,n){var r=MODULE_WRAP_REGEX.exec(t);if(!r){n(new Error("The new content is not a valid node.js script."));return}var i=r[1];fs.writeFile(e,i,function(e){n(e)})},$class.load=function(e,t){fs.readFile(e,{encoding:"utf-8"},function(e,n){if(e)return t(e);var r=MODULE_HEADER+n+MODULE_TRAILER;return t(null,r)})},$class.findApplicationRoot=function(e,t){fs.realpath(e,function(n,r){n&&(console.log("Cannot resolve real path of %s: %s",e,n),r=e),this._findApplicationRootForRealFile(r,t)}.bind(this))},$class._findApplicationRootForRealFile=function(e,t){var n=path.dirname(e),r=path.dirname(n);async.detect([n,r],this._isApplicationRoot.bind(this),function(e){t(null,e||n)})},$class._isApplicationRoot=function(e,t){fs.exists(path.join(e,"package.json"),t)},$class.listScripts=function(e,t){glob("**/*.js",{cwd:e},function(n,r){if(n)return t(n);r=r.map(function(t){var n=t.split("/").join(path.sep);return path.join(e,n)}),t(null,r)})},$class._findScriptsOfRunningApp=function(e,t){if(!e)return process.nextTick(t.bind(null,null,[]));async.waterfall([this.findApplicationRoot.bind(this,e),this.listScripts.bind(this)],t)},$class._findScriptsOfStartDirectoryApp=function(e,t){this._isApplicationRoot(e,function(r){r?this.listScripts(e,t):t(null,[])}.bind(this))},$class.findAllApplicationScripts=function(e,t,n){async.series([this._findScriptsOfRunningApp.bind(this,t),this._findScriptsOfStartDirectoryApp.bind(this,e)],function(e,t){if(e)return n(e);var r=t[0].concat(t[1]);return r=r.filter(function(e,t,n){return n.indexOf(e)>=t&&!this._isHidden(e)}.bind(this)),n(null,r)}.bind(this))},exports.ScriptFileStorage=ScriptFileStorage;