/*!
 * Module dependencies.
 */

/*!
 * Inherit from Stream
 */

/*!
 * Emit a data event and manage the trampoline state
 */

/*!
 * Module exports
 */

function QueryStream(e,t){Stream.call(this),this.query=e,this.readable=!0,this.paused=!1,this._cursor=null,this._destroyed=null,this._fields=null,this._buffer=null,this._inline=T_INIT,this._running=!1,this._transform=t&&"function"==typeof t.transform?t.transform:K;var n=this;process.nextTick(function(){n._init()})}function createAndEmit(e,t){var n=helpers.createModel(e.query.model,t,e._fields);n.init(t,function(t){if(t)return e.destroy(t);emit(e,n)})}function emit(e,t){e.emit("data",e._transform(t)),T_IDLE===e._inline?e._next():e._inline=T_CONT}var Stream=require("stream").Stream,utils=require("./utils"),helpers=require("./queryhelpers"),K=function(e){return e};QueryStream.prototype.__proto__=Stream.prototype,QueryStream.prototype.readable,QueryStream.prototype.paused;var T_INIT=0,T_IDLE=1,T_CONT=2;QueryStream.prototype._init=function(){if(this._destroyed)return;var e=this.query,t=e.model,n=e._optionsForExec(t),r=this;try{e.cast(t)}catch(i){return r.destroy(i)}r._fields=utils.clone(e._fields),n.fields=e._castFields(r._fields),t.collection.find(e._conditions,n,function(e,t){if(e)return r.destroy(e);r._cursor=t,r._next()})},QueryStream.prototype._next=function(){if(this.paused||this._destroyed)return this._running=!1;this._running=!0;if(this._buffer&&this._buffer.length){var t;while(!this.paused&&!this._destroyed&&(t=this._buffer.shift()))this._onNextObject.apply(this,t)}while(this.__next());},QueryStream.prototype.__next=function(){if(this.paused||this._destroyed)return this._running=!1;var e=this;e._inline=T_INIT,e._cursor.nextObject(function(n,r){e._onNextObject(n,r)});if(T_CONT===this._inline)return!0;this._inline=T_IDLE},QueryStream.prototype._onNextObject=function(t,n){if(this._destroyed)return;if(this.paused)return this._buffer||(this._buffer=[]),this._buffer.push([t,n]),this._running=!1;if(t)return this.destroy(t);if(!n)return this.emit("end"),this.destroy();var r=this.query._mongooseOptions;if(!r.populate)return!0===r.lean?emit(this,n):createAndEmit(this,n);var i=this,s=helpers.preparePopulationOptionsMQ(i.query,i.query._mongooseOptions);i.query.model.populate(n,s,function(e,t){return e?i.destroy(e):!0===r.lean?emit(i,t):createAndEmit(i,t)})},QueryStream.prototype.pause=function(){this.paused=!0},QueryStream.prototype.resume=function(){this.paused=!1;if(!this._cursor)return;if(T_INIT===this._inline)return;if(!this._running)return this._next()},QueryStream.prototype.destroy=function(e){if(this._destroyed)return;this._destroyed=!0,this._running=!1,this.readable=!1,this._cursor&&this._cursor.close(),e&&this.emit("error",e),this.emit("close")},module.exports=exports=QueryStream;