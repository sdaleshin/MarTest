/*!
 * Module dependencies.
 */

/*!
 * Returns this documents _id cast to a string.
 */

/*!
 * Inherit from EventEmitter.
 */

/*!
 * ignore
 */

/*!
   * Checks for indexes added to subdocs using Schema.index().
   * These indexes need their paths prefixed properly.
   *
   * schema._indexes = [ [indexObj, options], [indexObj, options] ..]
   */

/*!
 * Module exports.
 */

function Schema(e,t){if(!(this instanceof Schema))return new Schema(e,t);this.paths={},this.subpaths={},this.virtuals={},this.nested={},this.inherits={},this.callQueue=[],this._indexes=[],this.methods={},this.statics={},this.tree={},this._requiredpaths=undefined,this.discriminatorMapping=undefined,this._indexedpaths=undefined,this.options=this.defaultOptions(t),e&&this.add(e);var n=!this.paths._id&&!this.options.noId&&this.options._id;n&&this.add({_id:{type:Schema.ObjectId,auto:!0}});var r=!this.paths.id&&!this.options.noVirtualId&&this.options.id;r&&this.virtual("id").get(idGetter)}function idGetter(){return this.$__._id?this.$__._id:this.$__._id=null==this._id?null:String(this._id)}function getPositionalPath(e,t){var n=t.split(/\.(\d+)\.|\.(\d+)$/).filter(Boolean);if(n.length<2)return e.paths[n[0]];var r=e.path(n[0]);if(!r)return r;var i=n.length-1,s,o=1;for(;o<n.length;++o){s=n[o];if(o===i&&r&&!r.schema&&!/\D/.test(s)){r instanceof Types.Array?r=r.caster:r=undefined;break}if(!/\D/.test(s))continue;if(!r||!r.schema){r=undefined;break}r=r.schema.path(s)}return e.subpaths[t]=r}var EventEmitter=require("events").EventEmitter,VirtualType=require("./virtualtype"),utils=require("./utils"),mquery=require("mquery"),Query,Types;Schema.prototype.__proto__=EventEmitter.prototype,Schema.prototype.paths,Schema.prototype.tree,Schema.prototype.defaultOptions=function(e){return e&&!1===e.safe&&(e.safe={w:0}),e&&e.safe&&0===e.safe.w&&(e.versionKey=!1),e=utils.options({strict:!0,bufferCommands:!0,capped:!1,versionKey:"__v",discriminatorKey:"__t",minimize:!0,autoIndex:!0,shardKey:null,read:null,noId:!1,_id:!0,noVirtualId:!1,id:!0},e),e.read&&(e.read=mquery.utils.readPref(e.read)),e},Schema.prototype.add=function(t,n){n=n||"";var r=Object.keys(t);for(var i=0;i<r.length;++i){var s=r[i];if(null==t[s])throw new TypeError("Invalid value for schema path `"+n+s+"`");utils.isObject(t[s])&&(!t[s].constructor||"Object"==t[s].constructor.name)&&(!t[s].type||t[s].type.type)?Object.keys(t[s]).length?(this.nested[n+s]=!0,this.add(t[s],n+s+".")):this.path(n+s,t[s]):this.path(n+s,t[s])}},Schema.reserved=Object.create(null);var reserved=Schema.reserved;reserved.on=reserved.db=reserved.init=reserved.isNew=reserved.errors=reserved.schema=reserved.options=reserved.modelName=reserved.collection=reserved.toObject=reserved.emit=reserved._events=reserved._pres=reserved._posts=1,Schema.prototype.path=function(e,t){if(t==undefined)return this.paths[e]?this.paths[e]:this.subpaths[e]?this.subpaths[e]:/\.\d+\.?.*$/.test(e)?getPositionalPath(this,e):undefined;if(reserved[e])throw new Error("`"+e+"` may not be used as a schema pathname");var n=e.split(/\./),r=n.pop(),i=this.tree;return n.forEach(function(t,r){i[t]||(i[t]={});if("object"!=typeof i[t]){var s="Cannot set nested path `"+e+"`. "+"Parent path `"+n.slice(0,r).concat([t]).join(".")+"` already set to type "+i[t].name+".";throw new Error(s)}i=i[t]}),i[r]=utils.clone(t),this.paths[e]=Schema.interpretAsType(e,t),this},Schema.interpretAsType=function(e,t){t.constructor&&t.constructor.name!="Object"&&(t={type:t});var n=t.type&&!t.type.type?t.type:{};if("Object"==n.constructor.name||"mixed"==n)return new Types.Mixed(e,t);if(Array.isArray(n)||Array==n||"array"==n){var r=Array==n||"array"==n?t.cast:n[0];if(r instanceof Schema)return new Types.DocumentArray(e,r,t);if("string"==typeof r)r=Types[r.charAt(0).toUpperCase()+r.substring(1)];else if(r&&(!r.type||r.type.type)&&"Object"==r.constructor.name&&Object.keys(r).length)return new Types.DocumentArray(e,new Schema(r),t);return new Types.Array(e,r||Types.Mixed,t)}var i="string"==typeof n?n:n.name;i&&(i=i.charAt(0).toUpperCase()+i.substring(1));if(undefined==Types[i])throw new TypeError("Undefined type at `"+e+"`\n  Did you try nesting Schemas? "+"You can only nest using refs or arrays.");return new Types[i](e,t)},Schema.prototype.eachPath=function(e){var t=Object.keys(this.paths),n=t.length;for(var r=0;r<n;++r)e(t[r],this.paths[t[r]]);return this},Schema.prototype.requiredPaths=function(){if(this._requiredpaths)return this._requiredpaths;var t=Object.keys(this.paths),n=t.length,r=[];while(n--){var i=t[n];this.paths[i].isRequired&&r.push(i)}return this._requiredpaths=r},Schema.prototype.indexedPaths=function(){return this._indexedpaths?this._indexedpaths:this._indexedpaths=this.indexes()},Schema.prototype.pathType=function(e){return e in this.paths?"real":e in this.virtuals?"virtual":e in this.nested?"nested":e in this.subpaths?"real":/\.\d+\.|\.\d+$/.test(e)&&getPositionalPath(this,e)?"real":"adhocOrUndefined"},Schema.prototype.queue=function(e,t){return this.callQueue.push([e,t]),this},Schema.prototype.pre=function(){return this.queue("pre",arguments)},Schema.prototype.post=function(e,t){return this.queue("on",arguments)},Schema.prototype.plugin=function(e,t){return e(this,t),this},Schema.prototype.method=function(e,t){if("string"!=typeof e)for(var n in e)this.methods[n]=e[n];else this.methods[e]=t;return this},Schema.prototype.static=function(e,t){if("string"!=typeof e)for(var n in e)this.statics[n]=e[n];else this.statics[e]=t;return this},Schema.prototype.index=function(e,t){return t||(t={}),t.expires&&utils.expires(t),this._indexes.push([e,t]),this},Schema.prototype.set=function(e,t,n){if(1===arguments.length)return this.options[e];switch(e){case"read":this.options[e]=mquery.utils.readPref(t,n);break;case"safe":this.options[e]=!1===t?{w:0}:t;break;default:this.options[e]=t}return this},Schema.prototype.get=function(e){return this.options[e]};var indexTypes="2d 2dsphere hashed text".split(" ");Object.defineProperty(Schema,"indexTypes",{get:function(){return indexTypes},set:function(){throw new Error("Cannot overwrite Schema.indexTypes")}}),Schema.prototype.indexes=function(){function n(i,s){if(~t.indexOf(i))return;t.push(i),s=s||"";var o,u,a,f,l,c,h,p=Object.keys(i.paths);for(var d=0;d<p.length;++d)o=p[d],u=i.paths[o],u instanceof Types.DocumentArray?n(u.schema,o+"."):(a=u._index,!1!==a&&null!=a&&(f={},l=utils.isObject(a),c=l?a:{},h="string"==typeof a?a:l?a.type:!1,h&&~Schema.indexTypes.indexOf(h)?f[s+o]=h:f[s+o]=1,delete c.type,"background"in c||(c.background=!0),e.push([f,c])));s?r(i,s):(i._indexes.forEach(function(e){"background"in e[1]||(e[1].background=!0)}),e=e.concat(i._indexes))}function r(t,n){var r=t._indexes,i=r.length,s,o,u,a,f,l=0,c;for(l=0;l<i;++l){s=r[l][0],a=Object.keys(s),u=a.length,o={};for(c=0;c<u;++c)f=a[c],o[n+f]=s[f];e.push([o,r[l][1]])}}var e=[],t=[];return n(this),e},Schema.prototype.virtual=function(e,t){var n=this.virtuals,r=e.split(".");return n[e]=r.reduce(function(n,i,s){return n[i]||(n[i]=s===r.length-1?new VirtualType(t,e):{}),n[i]},this.tree)},Schema.prototype.virtualpath=function(e){return this.virtuals[e]},module.exports=exports=Schema,Schema.Types=require("./schema/index"),Types=Schema.Types,Query=require("./query");var ObjectId=exports.ObjectId=Types.ObjectId;