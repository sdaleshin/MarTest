/*!
 * Module dependencies.
 */

/*!
 * Produces a collection name from model `name`.
 *
 * @param {String} name a model name
 * @return {String} a collection name
 * @api private
 */

/*!
 * Pluralize function.
 *
 * @author TJ Holowaychuk (extracted from _ext.js_)
 * @param {String} string to pluralize
 * @api private
 */

/*!
 * Determines if `a` and `b` are deep equal.
 *
 * Modified from node/lib/assert.js
 *
 * @param {any} a a value to compare to `b`
 * @param {any} b a value to compare to `a`
 * @return {Boolean}
 * @api private
 */

/*!
 * Object clone with Mongoose natives support.
 *
 * If options.minimize is true, creates a minimal data object. Empty objects and undefined values will not be cloned. This makes the data payload sent to MongoDB as small as possible.
 *
 * Functions are never cloned.
 *
 * @param {Object} obj the object to clone
 * @param {Object} options
 * @return {Object} the cloned object
 * @api private
 */

/*!
 * ignore
 */

/*!
 * Shallow copies defaults into options.
 *
 * @param {Object} defaults
 * @param {Object} options
 * @return {Object} the merged object
 * @api private
 */

/*!
 * Generates a random string
 *
 * @api private
 */

/*!
 * Merges `from` into `to` without overwriting existing properties.
 *
 * @param {Object} to
 * @param {Object} from
 * @api private
 */

/*!
 * toString helper
 */

/*!
 * Determines if `arg` is an object.
 *
 * @param {Object|Array|String|Function|RegExp|any} arg
 * @api private
 * @return {Boolean}
 */

/*!
 * A faster Array.prototype.slice.call(arguments) alternative
 * @api private
 */

/*!
 * process.nextTick helper.
 *
 * Wraps `callback` in a try/catch + nextTick.
 *
 * node-mongodb-native has a habit of state corruption when an error is immediately thrown from within a collection callback.
 *
 * @param {Function} callback
 * @api private
 */

/*!
 * Returns if `v` is a mongoose object that has a `toObject()` method we can use.
 *
 * This is for compatibility with libs like Date.js which do foolish things to Natives.
 *
 * @param {any} v
 * @api private
 */

/*!
 * Converts `expires` options of index objects to `expiresAfterSeconds` options for MongoDB.
 *
 * @param {Object} object
 * @api private
 */

/*!
 * Converts arguments to ReadPrefs the driver
 * can understand.
 *
 * @TODO move this into the driver layer
 * @param {String|Array} pref
 * @param {Array} [tags]
 */

/*!
 * Populate options constructor
 */

/*!
 * populate helper
 */

/*!
 * Return the value of `obj` at the given `path`.
 *
 * @param {String} path
 * @param {Object} obj
 */

/*!
 * Sets the value of `obj` at the given `path`.
 *
 * @param {String} path
 * @param {Anything} val
 * @param {Object} obj
 */

/*!
 * Returns an array of values from object `o`.
 *
 * @param {Object} o
 * @return {Array}
 * @private
 */

/*!
 * @see exports.options
 */

/*!
 * Safer helper for hasOwnProperty checks
 *
 * @param {Object} obj
 * @param {String} prop
 */

/*!
 * Determine if `val` is null or undefined
 *
 * @return {Boolean}
 */

/*!
 * Flattens an array.
 *
 * [ 1, [ 2, 3, [4] ]] -> [1,2,3,4]
 *
 * @param {Array} arr
 * @param {Function} [filter] If passed, will be invoked with each item in the array. If `filter` returns a falsey value, the item will not be included in the results.
 * @return {Array}
 * @private
 */

/*!
 * Determines if two buffers are equal.
 *
 * @param {Buffer} a
 * @param {Object} b
 */

function pluralize(e){var t,n;if(!~uncountables.indexOf(e.toLowerCase())){n=rules.filter(function(t){return e.match(t[0])});if(n[0])return e.replace(n[0][0],n[0][1])}return e}function cloneObject(e,t){var n=t&&t.retainKeyOrder,r=t&&t.minimize,i={},s,o,u,a,f;if(n)for(a in e){u=clone(e[a],t);if(!r||"undefined"!=typeof u)s||(s=!0),i[a]=u}else{o=Object.keys(e),f=o.length;while(f--){a=o[f],u=clone(e[a],t);if(!r||"undefined"!=typeof u)s||(s=!0),i[a]=u}}return r?s&&i:i}function cloneArray(e,t){var n=[];for(var r=0,i=e.length;r<i;r++)n.push(clone(e[r],t));return n}function PopulateOptions(e,t,n,r,i){this.path=e,this.match=n,this.select=t,this.options=r,this.model=i,this._docs={}}var ReadPref=require("mongodb").ReadPreference,ObjectId=require("./types/objectid"),cloneRegExp=require("regexp-clone"),sliced=require("sliced"),mpath=require("mpath"),ms=require("ms"),MongooseBuffer,MongooseArray,Document;exports.toCollectionName=function(e,t){return t=t||{},"system.profile"===e?e:"system.indexes"===e?e:t.pluralization===!1?e:pluralize(e.toLowerCase())},exports.pluralization=[[/(m)an$/gi,"$1en"],[/(pe)rson$/gi,"$1ople"],[/(child)$/gi,"$1ren"],[/^(ox)$/gi,"$1en"],[/(ax|test)is$/gi,"$1es"],[/(octop|vir)us$/gi,"$1i"],[/(alias|status)$/gi,"$1es"],[/(bu)s$/gi,"$1ses"],[/(buffal|tomat|potat)o$/gi,"$1oes"],[/([ti])um$/gi,"$1a"],[/sis$/gi,"ses"],[/(?:([^f])fe|([lr])f)$/gi,"$1$2ves"],[/(hive)$/gi,"$1s"],[/([^aeiouy]|qu)y$/gi,"$1ies"],[/(x|ch|ss|sh)$/gi,"$1es"],[/(matr|vert|ind)ix|ex$/gi,"$1ices"],[/([m|l])ouse$/gi,"$1ice"],[/(quiz)$/gi,"$1zes"],[/s$/gi,"s"],[/([^a-z])$/,"$1"],[/$/gi,"s"]];var rules=exports.pluralization;exports.uncountables=["advice","energy","excretion","digestion","cooperation","health","justice","labour","machinery","equipment","information","pollution","sewage","paper","money","species","series","rain","rice","fish","sheep","moose","deer","news","expertise","status","media"];var uncountables=exports.uncountables;exports.deepEqual=function e(t,n){if(t===n)return!0;if(t instanceof Date&&n instanceof Date)return t.getTime()===n.getTime();if(t instanceof ObjectId&&n instanceof ObjectId)return t.toString()===n.toString();if(t instanceof RegExp&&n instanceof RegExp)return t.source==n.source&&t.ignoreCase==n.ignoreCase&&t.multiline==n.multiline&&t.global==n.global;if(typeof t!="object"&&typeof n!="object")return t==n;if(t===null||n===null||t===undefined||n===undefined)return!1;if(t.prototype!==n.prototype)return!1;if(t instanceof Number&&n instanceof Number)return t.valueOf()===n.valueOf();if(Buffer.isBuffer(t))return exports.buffer.areEqual(t,n);isMongooseObject(t)&&(t=t.toObject()),isMongooseObject(n)&&(n=n.toObject());try{var r=Object.keys(t),i=Object.keys(n),s,o}catch(u){return!1}if(r.length!=i.length)return!1;r.sort(),i.sort();for(o=r.length-1;o>=0;o--)if(r[o]!=i[o])return!1;for(o=r.length-1;o>=0;o--){s=r[o];if(!e(t[s],n[s]))return!1}return!0},exports.clone=function(t,n){if(t===undefined||t===null)return t;if(Array.isArray(t))return cloneArray(t,n);if(isMongooseObject(t))return n&&n.json&&"function"==typeof t.toJSON?t.toJSON(n):t.toObject(n);if(t.constructor)switch(t.constructor.name){case"Object":return cloneObject(t,n);case"Date":return new t.constructor(+t);case"RegExp":return cloneRegExp(t);default:}if(t instanceof ObjectId)return new ObjectId(t.id);if(!t.constructor&&exports.isObject(t))return cloneObject(t,n);if(t.valueOf)return t.valueOf()};var clone=exports.clone;exports.options=function(e,t){var n=Object.keys(e),r=n.length,i;t=t||{};while(r--)i=n[r],i in t||(t[i]=e[i]);return t},exports.random=function(){return Math.random().toString().substr(3)},exports.merge=function t(e,n){var r=Object.keys(n),i=r.length,s;while(i--)s=r[i],"undefined"==typeof e[s]?e[s]=n[s]:exports.isObject(n[s])&&t(e[s],n[s])};var toString=Object.prototype.toString;exports.isObject=function(e){return"[object Object]"==toString.call(e)},exports.args=sliced,exports.tick=function(t){if("function"!=typeof t)return;return function(){try{t.apply(this,arguments)}catch(e){process.nextTick(function(){throw e})}}},exports.isMongooseObject=function(e){return Document||(Document=require("./document")),MongooseArray||(MongooseArray=require("./types").Array),MongooseBuffer||(MongooseBuffer=require("./types").Buffer),e instanceof Document||e instanceof MongooseArray||e instanceof MongooseBuffer};var isMongooseObject=exports.isMongooseObject;exports.expires=function(t){if(!t||"Object"!=t.constructor.name)return;if(!("expires"in t))return;var n;"string"!=typeof t.expires?n=t.expires:n=Math.round(ms(t.expires)/1e3),t.expireAfterSeconds=n,delete t.expires},exports.readPref=function(t,n){Array.isArray(t)&&(n=t[1],t=t[0]);switch(t){case"p":t="primary";break;case"pp":t="primaryPreferred";break;case"s":t="secondary";break;case"sp":t="secondaryPreferred";break;case"n":t="nearest"}return new ReadPref(t,n)},PopulateOptions.prototype.constructor=Object,exports.PopulateOptions=PopulateOptions,exports.populate=function(t,n,r,i,s){if(1===arguments.length){if(t instanceof PopulateOptions)return[t];if(Array.isArray(t))return t.map(function(e){return exports.populate(e)[0]});exports.isObject(t)&&(i=t.match,s=t.options,n=t.select,r=t.model,t=t.path)}else"string"!=typeof r&&(s=i,i=r,r=undefined);if("string"!=typeof t)throw new TypeError("utils.populate: invalid path. Expected string. Got typeof `"+typeof t+"`");var o=[],u=t.split(" ");for(var a=0;a<u.length;++a)o.push(new PopulateOptions(u[a],n,i,s,r));return o},exports.getValue=function(e,t,n){return mpath.get(e,t,"_doc",n)},exports.setValue=function(e,t,n,r){mpath.set(e,t,n,"_doc",r)},exports.object={},exports.object.vals=function(t){var n=Object.keys(t),r=n.length,i=[];while(r--)i.push(t[n[r]]);return i},exports.object.shallowCopy=exports.options;var hop=Object.prototype.hasOwnProperty;exports.object.hasOwnProperty=function(e,t){return hop.call(e,t)},exports.isNullOrUndefined=function(e){return null==e},exports.array={},exports.array.flatten=function n(e,t,r){return r||(r=[]),e.forEach(function(e){Array.isArray(e)?n(e,t,r):(!t||t(e))&&r.push(e)}),r},exports.buffer={},exports.buffer.areEqual=function(e,t){if(!Buffer.isBuffer(e))return!1;if(!Buffer.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var n=0,r=e.length;n<r;++n)if(e[n]!==t[n])return!1;return!0};