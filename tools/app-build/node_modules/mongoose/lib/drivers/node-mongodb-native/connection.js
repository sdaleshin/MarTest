/*!
 * Module dependencies.
 */

/*!
 * Inherits from Connection.
 */

/*!
 * Register listeners for important events and bubble appropriately.
 */

/*!
 * Remove listeners registered in `listen`
 */

/*!
 * Validates the driver db options.
 *
 * @param {Object} o
 */

/*!
 * Module exports.
 */

function NativeConnection(){MongooseConnection.apply(this,arguments),this._listening=!1}function listen(e){if(e._listening)return;e._listening=!0,e.db.on("close",function(){if(e._closeCalled)return;if(e.db.serverConfig.autoReconnect){e.readyState=STATES.disconnected,e.emit("close");return}e.onClose()}),e.db.on("error",function(t){e.emit("error",t)}),e.db.on("timeout",function(t){var n=new Error(t&&t.err||"connection timeout");e.emit("error",n)}),e.db.on("open",function(t,n){STATES.disconnected===e.readyState&&n&&n.databaseName&&(e.readyState=STATES.connected,e.emit("reconnected"))})}function mute(e){if(!e.db)throw new Error("missing db");e.db.removeAllListeners("close"),e.db.removeAllListeners("error"),e.db.removeAllListeners("timeout"),e.db.removeAllListeners("open"),e.db.removeAllListeners("fullsetup"),e._listening=!1}function validate(e){if(-1===e.db.w||0===e.db.w)if(e.db.journal||e.db.fsync||e.db.safe)throw new Error("Invalid writeConcern: w set to -1 or 0 cannot be combined with safe|fsync|journal")}var MongooseConnection=require("../../connection"),mongo=require("mongodb"),Db=mongo.Db,Server=mongo.Server,Mongos=mongo.Mongos,STATES=require("../../connectionstate"),ReplSetServers=mongo.ReplSetServers,utils=require("../../utils");NativeConnection.STATES=STATES,NativeConnection.prototype.__proto__=MongooseConnection.prototype,NativeConnection.prototype.doOpen=function(e){this.db&&mute(this);var t=new Server(this.host,this.port,this.options.server);this.db=new Db(this.name,t,this.options.db);var n=this;return this.db.open(function(t){if(t)return e(t);listen(n),e()}),this},NativeConnection.prototype.useDb=function(e){function r(){t.db=n.db.db(e),t.onOpen(),listen(t)}var t=new this.constructor;t.name=e,t.base=this.base,t.collections={},t.models={},t.replica=this.replica,t.hosts=this.hosts,t.host=this.host,t.port=this.port,t.user=this.user,t.pass=this.pass,t.options=this.options,t._readyState=this._readyState,t._closeCalled=this._closeCalled,t._hasOpened=this._hasOpened,t._listening=!1;var n=this;return this.db&&this.db._state=="connected"?r():this.once("connected",r),t.name=e,this.otherDbs.push(t),t.otherDbs.push(this),t},NativeConnection.prototype.doOpenSet=function(e){this.db&&mute(this);var t=[],n=this;this.hosts.forEach(function(e){var r=e.host||e.ipc,i=e.port||27017;t.push(new Server(r,i,n.options.server))});var r=this.options.mongos?new Mongos(t,this.options.mongos):new ReplSetServers(t,this.options.replset);return this.db=new Db(this.name,r,this.options.db),this.db.on("fullsetup",function(){n.emit("fullsetup")}),this.db.open(function(t){if(t)return e(t);e(),listen(n)}),this},NativeConnection.prototype.doClose=function(e){return this.db.close(),e&&e(),this},NativeConnection.prototype.parseOptions=function(e,t){var n=e||{};n.db||(n.db={}),n.auth||(n.auth={}),n.server||(n.server={}),n.replset||(n.replset={}),n.server.socketOptions||(n.server.socketOptions={}),n.replset.socketOptions||(n.replset.socketOptions={});var r=t||{};return Object.keys(r).forEach(function(e){switch(e){case"poolSize":"undefined"==typeof n.server.poolSize&&(n.server.poolSize=n.replset.poolSize=r[e]);break;case"slaveOk":"undefined"==typeof n.server.slave_ok&&(n.server.slave_ok=r[e]);break;case"autoReconnect":"undefined"==typeof n.server.auto_reconnect&&(n.server.auto_reconnect=r[e]);break;case"ssl":case"socketTimeoutMS":case"connectTimeoutMS":"undefined"==typeof n.server.socketOptions[e]&&(n.server.socketOptions[e]=n.replset.socketOptions[e]=r[e]);break;case"authdb":"undefined"==typeof n.auth.authdb&&(n.auth.authdb=r[e]);break;case"authSource":"undefined"==typeof n.auth.authSource&&(n.auth.authSource=r[e]);break;case"retries":case"reconnectWait":case"rs_name":"undefined"==typeof n.replset[e]&&(n.replset[e]=r[e]);break;case"replicaSet":"undefined"==typeof n.replset.rs_name&&(n.replset.rs_name=r[e]);break;case"readSecondary":"undefined"==typeof n.replset.read_secondary&&(n.replset.read_secondary=r[e]);break;case"nativeParser":"undefined"==typeof n.db.native_parser&&(n.db.native_parser=r[e]);break;case"w":case"safe":case"fsync":case"journal":case"wtimeoutMS":"undefined"==typeof n.db[e]&&(n.db[e]=r[e]);break;case"readPreference":"undefined"==typeof n.db.read_preference&&(n.db.read_preference=r[e]);break;case"readPreferenceTags":"undefined"==typeof n.db.read_preference_tags&&(n.db.read_preference_tags=r[e])}}),"auto_reconnect"in n.server||(n.server.auto_reconnect=!0),n.db.read_preference||(n.db.read_preference="primary"),n.db.forceServerObjectId=!1,"journal"in n.db||"j"in n.db||"fsync"in n.db||"safe"in n.db||"w"in n.db||(n.db.w=1),validate(n),n},module.exports=NativeConnection;