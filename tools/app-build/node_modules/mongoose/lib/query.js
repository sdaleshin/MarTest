/*!
 * Module dependencies.
 */

/*!
 * inherit mquery
 */

/*!
 * hydrates many documents
 *
 * @param {Model} model
 * @param {Array} docs
 * @param {Object} fields
 * @param {Query} self
 * @param {Array} [pop] array of paths used in population
 * @param {Promise} promise
 */

/*!
 * hydrates a document
 *
 * @param {Model} model
 * @param {Document} doc
 * @param {Object} fields
 * @param {Query} self
 * @param {Array} [pop] array of paths used in population
 * @param {Promise} promise
 */

/*!
 * If the model is a discriminator type and not root, then add the key & value to the criteria.
 */

/*!
 * These operators require casting docs
 * to real Documents for Update operations.
 */

/*!
 * These operators should be cast to numbers instead
 * of their path schema type.
 */

/*!
 * castQuery
 * @api private
 */

/*!
 * castDoc
 * @api private
 */

/*!
 * Overwriting mquery is needed to support a couple different near() forms found in older
 * versions of mongoose
 * near([1,1])
 * near(1,1)
 * near(field, [1,2])
 * near(field, 1, 2)
 * In addition to all of the normal forms supported by mquery
 */

/*!
 * this is needed to support the mongoose syntax of:
 * box(field, { ll : [x,y], ur : [x2,y2] })
 * box({ ll : [x,y], ur : [x2,y2] })
 */

/*!
 * Export
 */

function Query(e,t,n,r){if(!this._mongooseOptions)this._mongooseOptions=t||{};else if(t){var i=Object.keys(t);for(var s=0;s<i.length;s++){var o=i[s];this._mongooseOptions[o]=t[o]}}r&&(this.mongooseCollection=r),n&&(this.model=n),this.model&&this.model._mapreduce&&this.lean(),mquery.call(this,this.mongooseCollection,t),e&&this.find(e)}function completeMany(e,t,n,r,i,s){var o=[],u=t.length,a=u,f=i?{populated:i}:undefined;for(var l=0;l<a;++l)o[l]=helpers.createModel(e,t[l],n),o[l].init(t[l],f,function(e){if(e)return s.error(e);--u||s.complete(o)})}function completeOne(e,t,n,r,i,s){var o=i?{populated:i}:undefined,u=helpers.createModel(e,t,n);u.init(t,o,function(e){if(e)return s.error(e);s.complete(u)})}function prepareDiscriminatorCriteria(e){if(!e||!e.model||!e.model.schema)return;var t=e.model.schema;t&&t.discriminatorMapping&&!t.discriminatorMapping.isRoot&&(e._conditions[t.discriminatorMapping.key]=t.discriminatorMapping.value)}function castQuery(e){try{return e.cast(e.model)}catch(t){return t}}function castDoc(e){try{return e._castUpdate(e._update)}catch(t){return t}}var mquery=require("mquery"),util=require("util"),events=require("events"),utils=require("./utils"),Promise=require("./promise"),helpers=require("./queryhelpers"),Types=require("./schema/index"),Document=require("./document"),QueryStream=require("./querystream");Query.prototype=new mquery,Query.prototype.constructor=Query,Query.base=mquery.prototype,Query.use$geoWithin=mquery.use$geoWithin,Query.prototype.toConstructor=function(){function t(e,n){if(!(this instanceof t))return new t(e,n);Query.call(this,e,n||null)}util.inherits(t,Query);var n=t.prototype;return n.options={},n.setOptions(this.options),n.op=this.op,n._conditions=utils.clone(this._conditions),n._fields=utils.clone(this._fields),n._update=utils.clone(this._update),n._path=this._path,n._distict=this._distinct,n._collection=this._collection,n.model=this.model,n.mongooseCollection=this.mongooseCollection,n._mongooseOptions=this._mongooseOptions,t},Query.prototype.setOptions=function(e,t){return t?(this._mongooseOptions=e&&utils.clone(e)||{},this.options=e||{},"populate"in e&&this.populate(this._mongooseOptions),this):!e||"Object"!=e.constructor.name?this:Query.base.setOptions.call(this,e)},Query.prototype._optionsForExec=function(e){var t=Query.base._optionsForExec.call(this);return delete t.populate,e?(!("safe"in t)&&e.schema.options.safe&&(t.safe=e.schema.options.safe),!("readPreference"in t)&&e.schema.options.read&&(t.readPreference=e.schema.options.read),t):t},Query.prototype.lean=function(e){return this._mongooseOptions.lean=arguments.length?!!e:!0,this},Query.prototype.find=function(e,t){function u(e,t){if(e)return r.error(e);if(0===t.length)return r.complete(t);if(!s.populate)return!0===s.lean?r.complete(t):completeMany(o.model,t,i,o,null,r);var n=helpers.preparePopulationOptionsMQ(o,s);o.model.populate(t,n,function(e,t){return e?r.error(e):!0===s.lean?r.complete(t):completeMany(o.model,t,i,o,n,r)})}"function"==typeof e?(t=e,e={}):e instanceof Document&&(e=e.toObject()),mquery.canMerge(e)&&this.merge(e),prepareDiscriminatorCriteria(this);try{this.cast(this.model),this._castError=null}catch(n){this._castError=n}if(!t)return Query.base.find.call(this);var r=new Promise(t);if(this._castError)return r.error(this._castError),this;this._applyPaths(),this._fields=this._castFields(this._fields);var i=this._fieldsForExec(),s=this._mongooseOptions,o=this;return Query.base.find.call(this,{},u)},Query.prototype.findOne=function(e,t,n,r){"function"==typeof e&&(r=e,e=null,t=null,n=null),"function"==typeof t&&(r=t,n=null,t=null),"function"==typeof n&&(r=n,n=null),e instanceof Document&&(e=e.toObject()),n&&this.setOptions(n),t&&this.select(t),mquery.canMerge(e)&&this.merge(e),prepareDiscriminatorCriteria(this);try{this.cast(this.model),this._castError=null}catch(i){this._castError=i}if(!r)return Query.base.findOne.call(this);var s=new Promise(r);if(this._castError)return s.error(this._castError),this;this._applyPaths(),this._fields=this._castFields(this._fields);var n=this._mongooseOptions,t=this._fieldsForExec(),o=this;return Query.base.findOne.call(this,{},function(r,i){if(r)return s.error(r);if(!i)return s.complete(null);if(!n.populate)return!0===n.lean?s.complete(i):completeOne(o.model,i,t,o,null,s);var u=helpers.preparePopulationOptionsMQ(o,n);o.model.populate(i,u,function(e,r){return e?s.error(e):!0===n.lean?s.complete(r):completeOne(o.model,r,t,o,u,s)})}),this},Query.prototype.count=function(e,t){"function"==typeof e&&(t=e,e=undefined),mquery.canMerge(e)&&this.merge(e);try{this.cast(this.model)}catch(n){return t(n),this}return Query.base.count.call(this,{},t)},Query.prototype.distinct=function(e,t,n){if(!n){"function"==typeof t&&(n=t,"string"==typeof e&&(t=e,e=undefined));switch(typeof e){case"string":t=e,e=undefined;break;case"function":n=e,t=undefined,e=undefined}}e instanceof Document&&(e=e.toObject()),mquery.canMerge(e)&&this.merge(e);try{this.cast(this.model)}catch(r){return n(r),this}return Query.base.distinct.call(this,{},t,n)},Query.prototype.sort=function(e){var t={};if(arguments.length>1)throw new Error("sort() only takes 1 Argument");if(Array.isArray(e))for(var n=0;n<e.length;n++){if(!Array.isArray(e[n]))throw new Error("Invalid sort() argument.");t[e[n][0]]=e[n][1]}else t=e;return Query.base.sort.call(this,t)},Query.prototype.remove=function(e,t){"function"==typeof e&&(t=e,e=null);var n="function"==typeof t;try{this.cast(this.model)}catch(r){return n?process.nextTick(t.bind(null,r)):this}return Query.base.remove.call(this,e,t)},Query.prototype._findAndModify=function(e,t){function l(e,t){if(e)return r.error(e);if(!t||utils.isObject(t)&&Object.keys(t).length===0)return r.complete(null);if(!f.populate)return!0===f.lean?r.complete(t):completeOne(i.model,t,u,i,null,r);var n=helpers.preparePopulationOptionsMQ(i,f);i.model.populate(t,n,function(e,t){return e?r.error(e):!0===f.lean?r.complete(t):completeOne(i.model,t,u,i,n,r)})}if("function"!=typeof t)throw new Error("Expected callback in _findAndModify");var n=this.model,r=new Promise(t),i=this,s,o,u,a;s=castQuery(this);if(s instanceof Error)return process.nextTick(r.error.bind(r,s)),r;a=this._optionsForExec(n);if("remove"==e)a.remove=!0;else{"new"in a||(a.new=!0),"upsert"in a||(a.upsert=!1),o=castDoc(this);if(!o){if(!a.upsert)return this.findOne(t);o={$set:{}}}else if(o instanceof Error)return process.nextTick(r.error.bind(r,o)),r}this._applyPaths();var i=this,f=this._mongooseOptions;if(this._fields){u=utils.clone(this._fields),a.fields=this._castFields(u);if(a.fields instanceof Error)return process.nextTick(r.error.bind(r,a.fields)),r}return this._collection.findAndModify(s,o,a,utils.tick(l)),r},Query.prototype.update=function(e,t,n,r){"function"==typeof n?(r=n,n=null):"function"==typeof t?(r=t,t=e,e={},n=null):"function"==typeof e&&(r=e,e=undefined,t=undefined,n=undefined),e instanceof Document&&(e=e.toObject()),n&&"strict"in n&&(this._mongooseOptions.strict=n.strict),!t&&this._update&&(t=this._updateForExec()),e&&(this._conditions=e);var i=castQuery(this);if(i instanceof Error){if(r)return r(i),this;throw i}var s;try{s=this._castUpdate(t,n&&n.overwrite)}catch(o){if(r)return r(o),this;throw o}return s?Query.base.update.call(this,i,s,n,r):(r&&r(null,0),this)},Query.prototype.exec=function(t,n){var r=new Promise;return"function"==typeof t?(n=t,t=null):"string"==typeof t&&(this.op=t),n&&r.addBack(n),this.op?(Query.base.exec.call(this,t,r.resolve.bind(r)),r):(r.complete(),r)},Query.prototype._getSchema=function(t){return this.model._getSchema(t)};var castOps={$push:1,$pushAll:1,$addToSet:1,$set:1},numberOps={$pop:1,$unset:1,$inc:1};Query.prototype._castUpdate=function(t,n){if(!t)return undefined;var r=Object.keys(t),i=r.length,s={},o,u;while(i--){var a=r[i];"$"!==a[0]&&!n?(s.$set||(t.$set?s.$set=t.$set:s.$set={}),s.$set[a]=t[a],r.splice(i,1),~r.indexOf("$set")||r.push("$set")):"$set"===a?s.$set||(s[a]=t[a]):s[a]=t[a]}i=r.length,n&&(o=!0);while(i--){a=r[i],u=s[a];if("Object"===u.constructor.name&&!n)o|=this._walkUpdatePath(u,a);else{if(!n||"Object"!==s.constructor.name){var f="Invalid atomic update value for "+a+". "+"Expected an object, received "+typeof u;throw new Error(f)}this._walkUpdatePath(s,"$set")}}return o&&s},Query.prototype._walkUpdatePath=function(t,n,r){var i=r?r+".":"",s=Object.keys(t),o=s.length,u=!1,a,f,l,c="strict"in this._mongooseOptions?this._mongooseOptions.strict:this.model.schema.options.strict;while(o--){f=s[o],l=t[f];if(l&&"Object"===l.constructor.name){a=this._getSchema(i+f);if(a&&a.caster&&n in castOps)if(c&&!a){if("throw"==c)throw new Error("Field `"+f+"` is not in schema.");delete t[f]}else u=!0,"$each"in l?(t[f]={$each:this._castUpdateVal(a,l.$each,n)},l.$slice&&(t[f].$slice=l.$slice|0),l.$sort&&(t[f].$sort=l.$sort)):t[f]=this._castUpdateVal(a,l,n);else u|=this._walkUpdatePath(l,n,i+f)}else{a="$each"===f?this._getSchema(r):this._getSchema(i+f);var h=c&&!a&&!/real|nested/.test(this.model.schema.pathType(i+f));if(h){if("throw"==c)throw new Error("Field `"+i+f+"` is not in schema.");delete t[f]}else u=!0,t[f]=this._castUpdateVal(a,l,n,f)}}return u},Query.prototype._castUpdateVal=function(t,n,r,i){if(!t)return r in numberOps?Number(n):n;if(t.caster&&r in castOps&&(utils.isObject(n)||Array.isArray(n))){var s=t.cast(n);Array.isArray(n)?n=s:n=s[0]}return r in numberOps?Number(n):/^\$/.test(i)?t.castForQuery(i,n):t.castForQuery(n)},Query.prototype.populate=function(){var e=utils.populate.apply(null,arguments),t=this._mongooseOptions;utils.isObject(t.populate)||(t.populate={});for(var n=0;n<e.length;++n)t.populate[e[n].path]=e[n];return this},Query.prototype.cast=function(e,t){t||(t=this._conditions);var n=e.schema,r=Object.keys(t),i=r.length,s,o,u,a,f,l;while(i--){a=r[i],l=t[a];if("$or"===a||"$nor"===a||"$and"===a){var c=l.length,h;while(c--)h=new Query(l[c],{},null,this.mongooseCollection),h.cast(e),l[c]=h._conditions}else{if(a==="$where"){f=typeof l;if("string"!==f&&"function"!==f)throw new Error("Must have a string or function for $where");"function"===f&&(t[a]=l.toString());continue}if(!n)continue;o=n.path(a);if(!o){var p=a.split("."),d=p.length,v,m,g,y;while(d--){v=p.slice(0,d).join("."),o=n.path(v);if(o)break}if(o){o.caster&&o.caster.schema?(g={},m=p.slice(d).join("."),g[m]=l,y=new Query(g,{},null,this.mongooseCollection),y.cast(o.caster),t[a]=y._conditions[m]):t[a]=l;continue}if(utils.isObject(l)){var b=l.$near?"$near":l.$nearSphere?"$nearSphere":l.$within?"$within":l.$geoIntersects?"$geoIntersects":"";if(!b)continue;var w=new Types.Number("__QueryCasting__"),E=l[b];l.$maxDistance&&(l.$maxDistance=w.castForQuery(l.$maxDistance));if("$within"==b){var S=E.$center||E.$centerSphere||E.$box||E.$polygon;if(!S)throw new Error("Bad $within paramater: "+JSON.stringify(l));E=S}else"$near"==b&&"string"==typeof E.type&&Array.isArray(E.coordinates)?E=E.coordinates:("$near"==b||"$geoIntersects"==b)&&E.$geometry&&"string"==typeof E.$geometry.type&&Array.isArray(E.$geometry.coordinates)&&(E=E.$geometry.coordinates);(function N(e){if(Array.isArray(e))e.forEach(function(t,n){if(Array.isArray(t)||utils.isObject(t))return N(t);e[n]=w.castForQuery(t)});else{var t=Object.keys(e),n=t.length;while(n--){var r=t[n],i=e[r];Array.isArray(i)||utils.isObject(i)?(N(i),e[r]=i):e[r]=w.castForQuery(i)}}})(E)}}else{if(l===null||l===undefined)continue;if("Object"===l.constructor.name){s=Object.keys(l).some(function(e){return e.charAt(0)==="$"&&e!=="$id"&&e!=="$ref"});if(!s)t[a]=o.castForQuery(l);else{var x=Object.keys(l),c=x.length,T;while(c--){T=x[c],u=l[T];if("$exists"===T){if("boolean"!=typeof u)throw new Error("$exists parameter must be Boolean");continue}if("$type"===T){if("number"!=typeof u)throw new Error("$type parameter must be Number");continue}"$not"===T?this.cast(e,u):l[T]=o.castForQuery(T,u)}}}else t[a]=o.castForQuery(l)}}}return t},Query.prototype._castFields=function(t){var n,r,i,s,o,u;if(t){i=Object.keys(t),r=[],u=i.length;while(u--)s=i[u],t[s].$elemMatch&&(n||(n={}),n[s]=t[s],r.push(s))}if(n){try{o=this.cast(this.model,n)}catch(a){return a}u=r.length;while(u--)s=r[u],t[s]=o[s]}return t},Query.prototype._applyPaths=function(){function a(e,t){t||(t="");if(~u.indexOf(e))return;u.push(e),e.eachPath(function(e,n){t&&(e=t+"."+e),f(e,n),n.schema&&a(n.schema,e)})}function f(e,i){if("boolean"!=typeof i.selected)return;var u="+"+e;if(t&&u in t){delete t[u],!1===n&&r.length>1&&!~r.indexOf(e)&&(t[e]=1);return}var a=e.split(".")[0];if(~o.indexOf(a))return;(i.selected?s:o).push(e)}var t=this._fields,n,r,i;if(t){r=Object.keys(t),i=r.length;while(i--){if("+"==r[i][0])continue;n=0===t[r[i]];break}}var s=[],o=[],u=[];a(this.model.schema);switch(n){case!0:o.length&&this.select("-"+o.join(" -"));break;case!1:s.length&&this.select(s.join(" "));break;case undefined:o.length&&this.select("-"+o.join(" -"))}return u=o=s=r=t=null},Query.prototype._castFields=function(t){var n,r,i,s,o,u;if(t){i=Object.keys(t),r=[],u=i.length;while(u--)s=i[u],t[s].$elemMatch&&(n||(n={}),n[s]=t[s],r.push(s))}if(n){try{o=this.cast(this.model,n)}catch(a){return a}u=r.length;while(u--)s=r[u],t[s]=o[s]}return t},Query.prototype.stream=function(t){return new QueryStream(this,t)},Query.prototype.maxscan=Query.base.maxScan,Query.prototype.tailable=function(e,t){return e&&e.constructor.name=="Object"&&(t=e,e=!0),e===undefined&&(e=!0),t&&t.awaitdata&&(this.options.awaitdata=!0),Query.base.tailable.call(this,e)},Query.prototype.near=function(){var e=[],t=this._mongooseOptions.nearSphere;if(arguments.length===1)if(Array.isArray(arguments[0]))e.push({center:arguments[0],spherical:t});else if("string"==typeof arguments[0])e.push(arguments[0]);else{if(!utils.isObject(arguments[0]))throw new TypeError("invalid argument");"boolean"!=typeof arguments[0].spherical&&(arguments[0].spherical=t),e.push(arguments[0])}else if(arguments.length===2)if("number"==typeof arguments[0]&&"number"==typeof arguments[1])e.push({center:[arguments[0],arguments[1]],spherical:t});else if("string"==typeof arguments[0]&&Array.isArray(arguments[1]))e.push(arguments[0]),e.push({center:arguments[1],spherical:t});else{if("string"!=typeof arguments[0]||!utils.isObject(arguments[1]))throw new TypeError("invalid argument");e.push(arguments[0]),"boolean"!=typeof arguments[1].spherical&&(arguments[1].spherical=t),e.push(arguments[1])}else{if(arguments.length!==3)throw new TypeError("invalid argument");if("string"!=typeof arguments[0]||"number"!=typeof arguments[1]||"number"!=typeof arguments[2])throw new TypeError("invalid argument");e.push(arguments[0]),e.push({center:[arguments[1],arguments[2]],spherical:t})}return Query.base.near.apply(this,e)},Query.prototype.nearSphere=function(){return this._mongooseOptions.nearSphere=!0,this.near.apply(this,arguments),this},Query.prototype.box=function(e,t){return!Array.isArray(e)&&utils.isObject(e)&&(t=e.ur,e=e.ll),Query.base.box.call(this,e,t)},Query.prototype.center=Query.base.circle,Query.prototype.centerSphere=function(){arguments[0]&&arguments[0].constructor.name=="Object"&&(arguments[0].spherical=!0),arguments[1]&&arguments[1].constructor.name=="Object"&&(arguments[1].spherical=!0),Query.base.circle.apply(this,arguments)},module.exports=Query;