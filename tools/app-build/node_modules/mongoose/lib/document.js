/*!
 * Module dependencies.
 */

/*!
 * Inherit from EventEmitter.
 */

/*!
 * Init helper.
 *
 * @param {Object} self document instance
 * @param {Object} obj raw mongodb doc
 * @param {Object} doc object we are initializing
 * @api private
 */

/*!
 * Set up middleware support
 */

/*!
 * Compiles schemas.
 */

/*!
 * Defines the accessor named prop on the incoming prototype.
 */

/*!
 * Minimizes an object, removing undefined values and empty objects
 *
 * @param {Object} object to minimize
 * @return {Object}
 */

/*!
 * Applies virtuals properties to `json`.
 *
 * @param {Document} self
 * @param {Object} json
 * @param {String} type either `virtuals` or `paths`
 * @return {Object} `json`
 */

/*!
 * Module exports.
 */

function Document(e,t,n){this.$__=new InternalCache,this.isNew=!0,this.errors=undefined;var r=this.schema;"boolean"==typeof t?(this.$__.strictMode=t,t=undefined):(this.$__.strictMode=r.options&&r.options.strict,this.$__.selected=t);var i=r.requiredPaths();for(var s=0;s<i.length;++s)this.$__.activePaths.require(i[s]);setMaxListeners.call(this,0),this._doc=this.$__buildDoc(e,t,n),e&&this.set(e,undefined,!0),this.$__registerHooks()}function init(e,t,n,r){r=r||"";var i=Object.keys(t),s=i.length,o,u,a;while(s--)a=i[s],u=r+a,o=e.schema.path(u),!o&&utils.isObject(t[a])&&(!t[a].constructor||"Object"==t[a].constructor.name)?(n[a]||(n[a]={}),init(e,t[a],n[a],u+".")):(t[a]===null?n[a]=null:t[a]!==undefined&&(o?e.$__try(function(){n[a]=o.cast(t[a],e,!0)}):n[a]=t[a]),e.$__.activePaths.init(u))}function compile(e,t,n){var r=Object.keys(e),i=r.length,s,o;while(i--)o=r[i],s=e[o],define(o,"Object"===s.constructor.name&&Object.keys(s).length&&(!s.type||s.type.type)?s:null,t,n,r)}function define(e,t,n,r,i){var r=r||"",s=(r?r+".":"")+e;t?Object.defineProperty(n,e,{enumerable:!0,get:function(){this.$__.getters||(this.$__.getters={});if(!this.$__.getters[s]){var e=Object.create(this);r||(e.$__.scope=this);var n=0,o=i.length;for(;n<o;++n)Object.defineProperty(e,i[n],{enumerable:!1,writable:!0,configurable:!0,value:undefined});e.toObject=function(){return this.get(s)},compile(t,e,s),this.$__.getters[s]=e}return this.$__.getters[s]},set:function(e){return e instanceof Document&&(e=e.toObject()),(this.$__.scope||this).set(s,e)}}):Object.defineProperty(n,e,{enumerable:!0,get:function(){return this.get.call(this.$__.scope||this,s)},set:function(e){return this.set.call(this.$__.scope||this,s,e)}})}function minimize(e){var t=Object.keys(e),n=t.length,r,i,s;while(n--){i=t[n],s=e[i],utils.isObject(s)&&(e[i]=minimize(s));if(undefined===e[i]){delete e[i];continue}r=!0}return r?e:undefined}function applyGetters(e,t,n,r){var i=e.schema,s=Object.keys(i[n]),o=s.length,u;while(o--){u=s[o];var a=u.split("."),f=a.length,l=f-1,c=t,h;for(var p=0;p<f;++p)h=a[p],p===l?c[h]=clone(e.get(u),r):c=c[h]||(c[h]={})}return t}var EventEmitter=require("events").EventEmitter,setMaxListeners=EventEmitter.prototype.setMaxListeners,MongooseError=require("./error"),MixedSchema=require("./schema/mixed"),Schema=require("./schema"),ValidatorError=require("./schematype").ValidatorError,utils=require("./utils"),clone=utils.clone,isMongooseObject=utils.isMongooseObject,inspect=require("util").inspect,ElemMatchError=MongooseError.ElemMatchError,ValidationError=MongooseError.ValidationError,InternalCache=require("./internal"),deepEqual=utils.deepEqual,hooks=require("hooks"),DocumentArray,MongooseArray,Embedded;Document.prototype.__proto__=EventEmitter.prototype,Document.prototype.schema,Document.prototype.isNew,Document.prototype.id,Document.prototype.errors,Document.prototype.$__buildDoc=function(e,t,n){var r={},i=this,s,o,u,a;if(t&&"Object"===t.constructor.name){o=Object.keys(t),a=o.length;while(a--)if("_id"!==o[a]){s=0===t[o[a]];break}}var f=Object.keys(this.schema.paths),l=f.length,c=0;for(;c<l;++c){var h=f[c];if("_id"==h){if(n)continue;if(e&&"_id"in e)continue}var p=this.schema.paths[h],d=h.split("."),v=d.length,m=v-1,g="",y=r,b=0;for(;b<v;++b){var w=d[b],E;if(s){g+=w;if(g in t)break;g+="."}if(b===m)if(t)if(s){if(h in t)continue;E=p.getDefault(i,!0),"undefined"!=typeof E&&(y[w]=E,i.$__.activePaths.default(h))}else h in t&&(E=p.getDefault(i,!0),"undefined"!=typeof E&&(y[w]=E,i.$__.activePaths.default(h)));else E=p.getDefault(i,!0),"undefined"!=typeof E&&(y[w]=E,i.$__.activePaths.default(h));else y=y[w]||(y[w]={})}}return r},Document.prototype.init=function(e,t,n){"function"==typeof t&&(n=t,t=null),this.isNew=!1;if(e._id&&t&&t.populated&&t.populated.length){var r=String(e._id);for(var i=0;i<t.populated.length;++i){var s=t.populated[i];this.populated(s.path,s._docs[r],s)}}return init(this,e,this._doc),this.$__storeShard(),this.emit("init",this),n&&n(null),this},Document.prototype.$__storeShard=function(){var e=this.schema.options.shardKey||this.schema.options.shardkey;if(!e||"Object"!=e.constructor.name)return;var t=this.$__.shardval={},n=Object.keys(e),r=n.length,i;for(var s=0;s<r;++s)i=this.getValue(n[s]),isMongooseObject(i)?t[n[s]]=i.toObject({depopulate:!0}):null!=i&&i.valueOf?t[n[s]]=i.valueOf():t[n[s]]=i};for(var k in hooks)Document.prototype[k]=Document[k]=hooks[k];Document.prototype.update=function(){var t=utils.args(arguments);return t.unshift({_id:this._id}),this.constructor.update.apply(this.constructor,t)},Document.prototype.set=function(e,t,n,r){n&&"Object"==n.constructor.name&&(r=n,n=undefined);var i=r&&r.merge,s=n&&!0!==n,o=!0===n,u,a=r&&"strict"in r?r.strict:this.$__.strictMode;s&&(u=this.$__.adhocPaths||(this.$__.adhocPaths={}),u[e]=Schema.interpretAsType(e,n));if("string"!=typeof e){if(null!==e&&undefined!==e){var l=t?t+".":"";e instanceof Document&&(e=e._doc);var c=Object.keys(e),h=c.length,p,d;while(h--){d=c[h],p=this.schema.pathType(l+d);if(null==e[d]||!utils.isObject(e[d])||!!e[d].constructor&&"Object"!=e[d].constructor.name||"virtual"==p||this.$__path(l+d)instanceof MixedSchema||!!this.schema.paths[d]&&!!this.schema.paths[d].options.ref)if(a){if("real"===p||"virtual"===p)this.set(l+d,e[d],o);else if("throw"==a)throw new Error("Field `"+d+"` is not in schema.")}else undefined!==e[d]&&this.set(l+d,e[d],o);else this.set(e[d],l+d,o)}return this}var f=e;e=t,t=f}var v=this.schema.pathType(e);if("nested"==v&&t&&utils.isObject(t)&&(!t.constructor||"Object"==t.constructor.name))return i||this.setValue(e,null),this.set(t,e,o),this;var m,g=e.split(".");if("adhocOrUndefined"==v&&a){var y;for(var h=0;h<g.length;++h){var b=g.slice(0,h+1).join(".");m=this.schema.path(b);if(m instanceof MixedSchema){y=!0;break}}if(!y){if("throw"==a)throw new Error("Field `"+e+"` is not in schema.");return this}}else{if("virtual"==v)return m=this.schema.virtualpath(e),m.applySetters(t,this),this;m=this.$__path(e)}var w;if(g.length<=1)w=e;else{for(var h=0;h<g.length;++h){var b=g.slice(0,h+1).join(".");if(this.isDirectModified(b)||this.get(b)===null){w=b;break}}w||(w=e)}var E=o?undefined:this.get(e);if(!m||undefined===t)return this.$__set(w,e,o,g,m,t,E),this;var S=this,x=this.$__try(function(){t=m.applySetters(t,S,!1,E)});return x&&this.$__set(w,e,o,g,m,t,E),this},Document.prototype.$__shouldModify=function(e,t,n,r,i,s,o){return this.isNew?!0:this.isDirectModified(e)?!1:undefined===s&&!this.isSelected(t)?!0:undefined===s&&t in this.$__.activePaths.states.default?!1:deepEqual(s,o||this.get(t))?!n&&null!=s&&t in this.$__.activePaths.states.default&&deepEqual(s,i.getDefault(this,n))?!0:!1:!0},Document.prototype.$__set=function(e,t,n,r,i,s,o){var u=this.$__shouldModify.apply(this,arguments);u&&(this.markModified(e,s),MongooseArray||(MongooseArray=require("./types/array")),s instanceof MongooseArray&&s._registerAtomic("$set",s));var a=this._doc,f=0,l=r.length;for(;f<l;f++){var c=f+1,h=c===l;h?a[r[f]]=s:a[r[f]]&&"Object"===a[r[f]].constructor.name?a=a[r[f]]:a[r[f]]&&Array.isArray(a[r[f]])?a=a[r[f]]:a=a[r[f]]={}}},Document.prototype.getValue=function(e){return utils.getValue(e,this._doc)},Document.prototype.setValue=function(e,t){return utils.setValue(e,t,this._doc),this},Document.prototype.get=function(e,t){var n;t&&(n=this.$__.adhocPaths||(this.$__.adhocPaths={}),n[e]=Schema.interpretAsType(e,t));var r=this.$__path(e)||this.schema.virtualpath(e),i=e.split("."),s=this._doc;for(var o=0,u=i.length;o<u;o++)s=undefined===s||null===s?undefined:s[i[o]];return r&&(s=r.applyGetters(s,this)),s},Document.prototype.$__path=function(e){var t=this.$__.adhocPaths,n=t&&t[e];return n?n:this.schema.path(e)},Document.prototype.markModified=function(e){this.$__.activePaths.modify(e)},Document.prototype.$__try=function(e,t){var n;try{e.call(t),n=!0}catch(r){this.$__error(r),n=!1}return n},Document.prototype.modifiedPaths=function(){var e=Object.keys(this.$__.activePaths.states.modify);return e.reduce(function(e,t){var n=t.split(".");return e.concat(n.reduce(function(e,t,r){return e.concat(n.slice(0,r).concat(t).join("."))},[]))},[])},Document.prototype.isModified=function(e){return e?!!~this.modifiedPaths().indexOf(e):this.$__.activePaths.some("modify")},Document.prototype.isDirectModified=function(e){return e in this.$__.activePaths.states.modify},Document.prototype.isInit=function(e){return e in this.$__.activePaths.states.init},Document.prototype.isSelected=function(t){if(this.$__.selected){if("_id"===t)return 0!==this.$__.selected._id;var n=Object.keys(this.$__.selected),r=n.length,i=!1,s;if(1===r&&"_id"===n[0])return 0===this.$__.selected._id;while(r--){s=n[r];if("_id"==s)continue;i=!!this.$__.selected[s];break}if(t in this.$__.selected)return i;r=n.length;var o=t+".";while(r--){s=n[r];if("_id"==s)continue;if(0===s.indexOf(o))return i;if(0===o.indexOf(s+"."))return i}return!i}return!0},Document.prototype.validate=function(e){function s(e){if(r[e])return;r[e]=!0,i++,process.nextTick(function(){var n=t.schema.path(e);if(!n)return--i||o();var r=t.getValue(e);n.doValidate(r,function(n){n&&t.invalidate(e,n,undefined,!0),--i||o()},t)})}function o(){var n=t.$__.validationError;t.$__.validationError=undefined,t.emit("validate",t),e(n)}var t=this,n=Object.keys(this.$__.activePaths.states.require).filter(function(e){return!t.isSelected(e)&&!t.isModified(e)?!1:!0});n=n.concat(Object.keys(this.$__.activePaths.states.init)),n=n.concat(Object.keys(this.$__.activePaths.states.modify)),n=n.concat(Object.keys(this.$__.activePaths.states.default));if(0===n.length)return o(),this;var r={},i=0;return n.forEach(s),this},Document.prototype.invalidate=function(e,t,n){this.$__.validationError||(this.$__.validationError=new ValidationError(this));if(!t||"string"==typeof t)t=new ValidatorError(e,t,"user defined",n);this.$__.validationError.errors[e]=t},Document.prototype.$__reset=function(){var t=this;DocumentArray||(DocumentArray=require("./types/documentarray")),this.$__.activePaths.map("init","modify",function(e){return t.getValue(e)}).filter(function(e){return e&&e instanceof DocumentArray&&e.length}).forEach(function(e){var t=e.length;while(t--){var n=e[t];if(!n)continue;n.$__reset()}}),this.$__dirty().forEach(function(e){var t=e.value;t&&t._atomics&&(t._atomics={})}),this.$__.activePaths.clear("modify"),this.$__.validationError=undefined,this.errors=undefined;var t=this;return this.schema.requiredPaths().forEach(function(e){t.$__.activePaths.require(e)}),this},Document.prototype.$__dirty=function(){var e=this,t=this.$__.activePaths.map("modify",function(t){return{path:t,value:e.getValue(t),schema:e.$__path(t)}});t.sort(function(e,t){return e.path<t.path?-1:e.path>t.path?1:0});var n=[],r,i;return t.forEach(function(e,t){e.path.indexOf(r)!==0?(r=e.path+".",n.push(e),i=e):i.value&&i.value._atomics&&i.value.hasAtomics()&&(i.value._atomics={},i.value._atomics.$set=i.value)}),i=r=null,n},Document.prototype.$__setSchema=function(e){compile(e.tree,this),this.schema=e},Document.prototype.$__registerHooks=function(){if(!this.save)return;DocumentArray||(DocumentArray=require("./types/documentarray")),this.pre("save",function(e){function s(i){if(n)return;if(i)return r.$__.validationError=undefined,e(n=i);--t||e()}var t=0,n=!1,r=this,i=this.$__.activePaths.map("init","modify",function(e){return r.getValue(e)}).filter(function(e){return e&&e instanceof DocumentArray&&e.length});if(!i.length)return e();i.forEach(function(r){if(n)return;var i=r.length;t+=i;for(var o=0;o<i;++o){if(n)break;var u=r[o];if(!u){--t||e();continue}u.save(s)}})},function(e){this.constructor.listeners("error").length?this.constructor.emit("error",e):(this.db.listeners("error").length||(e.stack="No listeners detected, throwing. Consider adding an error listener to your connection.\n"+e.stack),this.db.emit("error",e))}).pre("save",function(t){var n=this.$__.saveError;n?(this.$__.saveError=null,t(n)):t()}).pre("save",function(t){return this.validate(t)}),this.$__doQueue()},Document.prototype.$__error=function(e){return this.$__.saveError=e,this},Document.prototype.$__doQueue=function(){var e=this.schema&&this.schema.callQueue;if(e)for(var t=0,n=e.length;t<n;t++)this[e[t][0]].apply(this,e[t][1]);return this},Document.prototype.toObject=function(e){if(e&&e.depopulate&&this.$__.wasPopulated)return clone(this._id,e);if(!e||"Object"!=e.constructor.name)e=this.schema.options.toObject?clone(this.schema.options.toObject):{};"minimize"in e||(e.minimize=this.schema.options.minimize);var t=clone(this._doc,e);(e.virtuals||e.getters&&!1!==e.virtuals)&&applyGetters(this,t,"virtuals",e),e.getters&&(applyGetters(this,t,"paths",e),e.minimize&&(t=minimize(t)||{}));if(!0===e.transform||this.schema.options.toObject&&e.transform){var n=e.json?this.schema.options.toJSON:this.schema.options.toObject;n&&(e.transform=n.transform)}if("function"==typeof e.transform){var r=e.transform(this,t,e);"undefined"!=typeof r&&(t=r)}return t},Document.prototype.toJSON=function(e){if(!e||"Object"!=e.constructor.name||(!e||e.json)&&this.schema.options.toJSON)e=this.schema.options.toJSON?clone(this.schema.options.toJSON):{};return e.json=!0,this.toObject(e)},Document.prototype.inspect=function(e){var t=e&&"Object"==e.constructor.name?e:this.schema.options.toObject?clone(this.schema.options.toObject):{};return t.minimize=!1,inspect(this.toObject(t))},Document.prototype.toString=Document.prototype.inspect,Document.prototype.equals=function(e){var t=this.get("_id"),n=e.get("_id");return t&&t.equals?t.equals(n):t===n},Document.prototype.populate=function(){if(0===arguments.length)return this;var t=this.$__.populate||(this.$__.populate={}),n=utils.args(arguments),r;"function"==typeof n[n.length-1]&&(r=n.pop());if(n.length){var i=utils.populate.apply(null,n);for(var s=0;s<i.length;++s)t[i[s].path]=i[s]}if(r){var o=utils.object.vals(t);this.$__.populate=undefined,this.constructor.populate(this,o,r)}return this},Document.prototype.populated=function(e,t,n){if(null==t){if(!this.$__.populated)return undefined;var r=this.$__.populated[e];return r?r.value:undefined}return!0===t?this.$__.populated?this.$__.populated[e]:undefined:(this.$__.populated||(this.$__.populated={}),this.$__.populated[e]={value:t,options:n},t)},Document.prototype.$__fullPath=function(e){return e||""},Document.ValidationError=ValidationError,module.exports=exports=Document;