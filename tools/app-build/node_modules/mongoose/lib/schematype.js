/*!
 * Module dependencies.
 */

/*!
 * Module exports.
 */

function SchemaType(e,t,n){this.path=e,this.instance=n,this.validators=[],this.setters=[],this.getters=[],this.options=t,this._index=null,this.selected;for(var r in t)if(this[r]&&"function"==typeof this[r]){if("index"==r&&this._index)continue;var i=Array.isArray(t[r])?t[r]:[t[r]];this[r].apply(this,i)}}var utils=require("./utils"),error=require("./error"),errorMessages=error.messages,CastError=error.CastError,ValidatorError=error.ValidatorError;SchemaType.prototype.default=function(e){return 1===arguments.length?(this.defaultValue=typeof e=="function"?e:this.cast(e),this):(arguments.length>1&&(this.defaultValue=utils.args(arguments)),this.defaultValue)},SchemaType.prototype.index=function(e){return this._index=e,utils.expires(this._index),this},SchemaType.prototype.unique=function(e){return null==this._index||"boolean"==typeof this._index?this._index={}:"string"==typeof this._index&&(this._index={type:this._index}),this._index.unique=e,this},SchemaType.prototype.sparse=function(e){return null==this._index||"boolean"==typeof this._index?this._index={}:"string"==typeof this._index&&(this._index={type:this._index}),this._index.sparse=e,this},SchemaType.prototype.set=function(e){if("function"!=typeof e)throw new TypeError("A setter must be a function.");return this.setters.push(e),this},SchemaType.prototype.get=function(e){if("function"!=typeof e)throw new TypeError("A getter must be a function.");return this.getters.push(e),this},SchemaType.prototype.validate=function(e,t){if("function"==typeof e||e&&"RegExp"===e.constructor.name)return t||(t=errorMessages.general.default),this.validators.push([e,t,"user defined"]),this;var n=arguments.length,r;while(n--){r=arguments[n];if(!r||"Object"!=r.constructor.name){var i="Invalid validator. Received ("+typeof r+") "+r+". See http://mongoosejs.com/docs/api.html#schematype_SchemaType-validate";throw new Error(i)}this.validate(r.validator,r.msg)}return this},SchemaType.prototype.required=function(e,t){if(!1===e)return this.validators=this.validators.filter(function(e){return e[0]!=this.requiredValidator},this),this.isRequired=!1,this;var n=this;this.isRequired=!0,this.requiredValidator=function(e){return"isSelected"in this&&!this.isSelected(n.path)&&!this.isModified(n.path)?!0:n.checkRequired(e,this)},"string"==typeof e&&(t=e,e=undefined);var r=t||errorMessages.general.required;return this.validators.push([this.requiredValidator,r,"required"]),this},SchemaType.prototype.getDefault=function(e,t){var n="function"==typeof this.defaultValue?this.defaultValue.call(e):this.defaultValue;return null!==n&&undefined!==n?this.cast(n,e,t):n},SchemaType.prototype.applySetters=function(e,t,n,r){if(SchemaType._isRef(this,e,t,n))return n?e:this.cast(e,t,n,r);var i=e,s=this.setters,o=s.length;if(!o)return null===i||undefined===i?i:this.cast(i,t,n,r);while(o--)i=s[o].call(t,i,this);return null===i||undefined===i?i:(i=this.cast(i,t,n,r),i)},SchemaType.prototype.applyGetters=function(e,t){if(SchemaType._isRef(this,e,t,!0))return e;var n=e,r=this.getters,i=r.length;if(!i)return n;while(i--)n=r[i].call(t,n,this);return n},SchemaType.prototype.select=function(t){return this.selected=!!t,this},SchemaType.prototype.doValidate=function(e,t,n){function o(e,n,o,u){if(r)return;e===undefined||e?--s||t(null):t(r=new ValidatorError(i,n,o,u))}var r=!1,i=this.path,s=this.validators.length;if(!s)return t(null);this.validators.forEach(function(t){var r=t[0],i=t[1],s=t[2];r instanceof RegExp?o(r.test(e),i,s,e):"function"==typeof r&&(2===r.length?r.call(n,e,function(t){o(t,i,s,e)}):o(r.call(n,e),i,s,e))})},SchemaType._isRef=function(e,t,n,r){var i=r&&e.options&&e.options.ref;if(!i&&n&&n.$__fullPath){var s=n.$__fullPath(e.path),o=n.ownerDocument?n.ownerDocument():n;i=o.populated(s)}if(i){if(null==t)return!0;if(!Buffer.isBuffer(t)&&"Binary"!=t._bsontype&&utils.isObject(t))return!0}return!1},module.exports=exports=SchemaType,exports.CastError=CastError,exports.ValidatorError=ValidatorError;