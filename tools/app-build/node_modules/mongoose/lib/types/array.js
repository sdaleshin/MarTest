/*!
 * Module dependencies.
 */

/*!
 * Inherit from Array
 */

/*!
 * Module exports.
 */

function MongooseArray(e,t,n){var r=[];return r.push.apply(r,e),r.__proto__=MongooseArray.prototype,r._atomics={},r.validators=[],r._path=t,n&&(r._parent=n,r._schema=n.schema.path(t)),r}var EmbeddedDocument=require("./embedded"),Document=require("../document"),ObjectId=require("./objectid"),utils=require("../utils"),isMongooseObject=utils.isMongooseObject;MongooseArray.prototype=new Array,MongooseArray.prototype._atomics,MongooseArray.prototype._parent,MongooseArray.prototype._cast=function(e){var t=this._owner,n=!1,r;this._parent&&(t||(t=this._owner=this._parent.ownerDocument?this._parent.ownerDocument():this._parent),n=t.populated(this._path,!0));if(n&&null!=e){var r=n.options.model;if(Buffer.isBuffer(e)||e instanceof ObjectId||!utils.isObject(e))e={_id:e};return e=new r(e),this._schema.caster.cast(e,this._parent,!0)}return this._schema.caster.cast(e,this._parent,!1)},MongooseArray.prototype._markModified=function(e,t){var n=this._parent,r;return n&&(r=this._path,arguments.length&&(null!=t?r=r+"."+this.indexOf(e)+"."+t:r=r+"."+e),n.markModified(r)),this},MongooseArray.prototype._registerAtomic=function(e,t){if("$set"==e)return this._atomics={$set:t},this;var n=this._atomics;if("$pop"==e&&!("$pop"in n)){var r=this;this._parent.once("save",function(){r._popped=r._shifted=null})}if(this._atomics.$set||Object.keys(n).length&&!(e in n))return this._atomics={$set:this},this;if(e==="$pullAll"||e==="$pushAll"||e==="$addToSet")n[e]||(n[e]=[]),n[e]=n[e].concat(t);else if(e==="$pullDocs"){var i=n.$pull||(n.$pull={}),s=i._id||(i._id={$in:[]});s.$in=s.$in.concat(t)}else n[e]=t;return this},MongooseArray.prototype.$__getAtomics=function(){var e=[],t=Object.keys(this._atomics),n=t.length;if(0===n)return e[0]=["$set",this.toObject({depopulate:1})],e;while(n--){var r=t[n],i=this._atomics[r];isMongooseObject(i)?i=i.toObject({depopulate:1}):Array.isArray(i)?i=this.toObject.call(i,{depopulate:1}):i.valueOf&&(i=i.valueOf()),"$addToSet"==r&&(i={$each:i}),e.push([r,i])}return e},MongooseArray.prototype.hasAtomics=function(){return!this._atomics||"Object"!==this._atomics.constructor.name?0:Object.keys(this._atomics).length},MongooseArray.prototype.push=function(){var e=[].map.call(arguments,this._cast,this),t=[].push.apply(this,e);return this._registerAtomic("$pushAll",e),this._markModified(),t},MongooseArray.prototype.nonAtomicPush=function(){var e=[].map.call(arguments,this._cast,this),t=[].push.apply(this,e);return this._registerAtomic("$set",this),this._markModified(),t},MongooseArray.prototype.$pop=function(){this._registerAtomic("$pop",1),this._markModified();if(this._popped)return;return this._popped=!0,[].pop.call(this)},MongooseArray.prototype.pop=function(){var e=[].pop.call(this);return this._registerAtomic("$set",this),this._markModified(),e},MongooseArray.prototype.$shift=function(){this._registerAtomic("$pop",-1),this._markModified();if(this._shifted)return;return this._shifted=!0,[].shift.call(this)},MongooseArray.prototype.shift=function(){var e=[].shift.call(this);return this._registerAtomic("$set",this),this._markModified(),e},MongooseArray.prototype.pull=function(){var e=[].map.call(arguments,this._cast,this),t=this._parent.get(this._path),n=t.length,r;while(n--)r=t[n],r instanceof EmbeddedDocument?e.some(function(e){return e.equals(r)})&&[].splice.call(t,n,1):~t.indexOf.call(e,r)&&[].splice.call(t,n,1);return e[0]instanceof EmbeddedDocument?this._registerAtomic("$pullDocs",e.map(function(e){return e._id})):this._registerAtomic("$pullAll",e),this._markModified(),this},MongooseArray.prototype.remove=MongooseArray.prototype.pull,MongooseArray.prototype.splice=function(){var t,n,r;if(arguments.length){n=[];for(r=0;r<arguments.length;++r)n[r]=r<2?arguments[r]:this._cast(arguments[r]);t=[].splice.apply(this,n),this._registerAtomic("$set",this),this._markModified()}return t},MongooseArray.prototype.unshift=function(){var e=[].map.call(arguments,this._cast,this);return[].unshift.apply(this,e),this._registerAtomic("$set",this),this._markModified(),this.length},MongooseArray.prototype.sort=function(){var e=[].sort.apply(this,arguments);return this._registerAtomic("$set",this),this._markModified(),e},MongooseArray.prototype.addToSet=function(){var t=[].map.call(arguments,this._cast,this),n=[],r=t[0]instanceof EmbeddedDocument?"doc":t[0]instanceof Date?"date":"";return t.forEach(function(e){var t;switch(r){case"doc":t=this.some(function(t){return t.equals(e)});break;case"date":var i=+e;t=this.some(function(e){return+e===i});break;default:t=~this.indexOf(e)}t||([].push.call(this,e),this._registerAtomic("$addToSet",e),this._markModified(),[].push.call(n,e))},this),n},MongooseArray.prototype.set=function(t,n){return this[t]=this._cast(n),this._markModified(t),this},MongooseArray.prototype.toObject=function(e){return e&&e.depopulate?this.map(function(t){return t instanceof Document?t.toObject(e):t}):this.slice()},MongooseArray.prototype.inspect=function(){return"["+this.map(function(e){return" "+e})+" ]"},MongooseArray.prototype.indexOf=function(t){t instanceof ObjectId&&(t=t.toString());for(var n=0,r=this.length;n<r;++n)if(t==this[n])return n;return-1},module.exports=exports=MongooseArray;