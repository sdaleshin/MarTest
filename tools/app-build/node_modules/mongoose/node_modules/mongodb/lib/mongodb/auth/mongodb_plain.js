var DbCommand=require("../commands/db_command").DbCommand,utils=require("../utils"),Binary=require("bson").Binary,format=require("util").format,authenticate=function(e,t,n,r,i){var s=0,o=null;r["connection"]!=null?s=1:(s=e.serverConfig.allRawConnections().length,r.onAll=!0);var u=new Binary(format("\0%s\0%s",t,n)),a={saslStart:1,mechanism:"PLAIN",payload:u,autoAuthorize:1},f=r["connection"]!=null?[r.connection]:e.serverConfig.allRawConnections();for(var l=0;l<s;l++){var c=f[l];e._executeQueryCommand(DbCommand.createDbCommand(e,a,{},"$external"),{connection:c},function(r,u){s-=1;if(r)o=r;else if(u.documents[0].err!=null||u.documents[0].errmsg!=null)o=utils.toError(u.documents[0]);if(s<=0&&typeof i=="function"){var a=i;i=null,o==null&&u.documents[0].ok==1?(e.serverConfig.auth.add("PLAIN",e.databaseName,t,n),a(o,!0)):a(o,!1)}})}};exports.authenticate=authenticate;