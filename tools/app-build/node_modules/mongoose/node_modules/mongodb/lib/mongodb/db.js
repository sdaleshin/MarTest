function Db(e,t,n){if(!(this instanceof Db))return new Db(e,t,n);EventEmitter.call(this);var r=this;this.databaseName=e,this.serverConfig=t,this.options=n==null?{}:n,this._applicationClosed=!1;var i=this.options["override_used_flag"]==null?!1:this.options.override_used_flag;if(!i&&this.serverConfig!=null&&typeof this.serverConfig=="object"&&this.serverConfig._isUsed&&this.serverConfig._isUsed())throw new Error("A Server or ReplSet instance cannot be shared across multiple Db instances");!i&&typeof this.serverConfig=="object"&&(this.serverConfig._used=!0),this.slaveOk=this.options["slave_ok"]==null?!1:this.options.slave_ok,this.slaveOk=this.options["slaveOk"]==null?this.slaveOk:this.options.slaveOk,validateDatabaseName(e);try{this.native_parser=this.options.native_parser;var s=this.bsonLib=this.options.native_parser?require("bson").BSONNative:require("bson").BSONPure,o=s.BSON;this.bson=new o([s.Long,s.ObjectID,s.Binary,s.Code,s.DBRef,s.Symbol,s.Double,s.Timestamp,s.MaxKey,s.MinKey]),this.bson.promoteLongs=this.options.promoteLongs==null?!0:this.options.promoteLongs,this.bson_deserializer=s,this.bson_serializer=s,this.bson_deserializer.promoteLongs=this.options.promoteLongs==null?!0:this.options.promoteLongs}catch(u){var a="Native bson parser not compiled, please compile or avoid using native_parser=true";throw Error(a)}this._state="disconnected",this.pkFactory=this.options.pk==null?s.ObjectID:this.options.pk,this.forceServerObjectId=this.options.forceServerObjectId!=null?this.options.forceServerObjectId:!1,this.safe=this.options.safe==null?!1:this.options.safe,this.options.safe==null&&this.options.w==null&&this.options.journal==null&&this.options.fsync==null&&(console.log("========================================================================================"),console.log("=  Please ensure that you set the default write concern for the database by setting    ="),console.log("=   one of the options                                                                 ="),console.log("=                                                                                      ="),console.log("=     w: (value of > -1 or the string 'majority'), where < 1 means                     ="),console.log("=        no write acknowlegement                                                       ="),console.log("=     journal: true/false, wait for flush to journal before acknowlegement             ="),console.log("=     fsync: true/false, wait for flush to file system before acknowlegement           ="),console.log("=                                                                                      ="),console.log("=  For backward compatibility safe is still supported and                              ="),console.log("=   allows values of [true | false | {j:true} | {w:n, wtimeout:n} | {fsync:true}]      ="),console.log("=   the default value is false which means the driver receives does not                ="),console.log("=   return the information of the success/error of the insert/update/remove            ="),console.log("=                                                                                      ="),console.log("=   ex: new Db(new Server('localhost', 27017), {safe:false})                           ="),console.log("=                                                                                      ="),console.log("=   http://www.mongodb.org/display/DOCS/getLastError+Command                           ="),console.log("=                                                                                      ="),console.log("=  The default of no acknowlegement will change in the very near future                ="),console.log("=                                                                                      ="),console.log("=  This message will disappear when the default safe is set on the driver Db           ="),console.log("========================================================================================")),this.notReplied={},this.isInitializing=!0,this.openCalled=!1,this.commands=[],this.logger=this.options.logger!=null&&typeof this.options.logger.debug=="function"&&typeof this.options.logger.error=="function"&&typeof this.options.logger.log=="function"?this.options.logger:{error:function(e,t){},log:function(e,t){},debug:function(e,t){}},this.serverConfig.logger=this.logger,this.serverConfig.strategyInstance&&(this.serverConfig.strategyInstance.logger=this.logger),this.tag=(new Date).getTime(),this.eventHandlers={error:[],parseError:[],poolReady:[],message:[],close:[]},this.serializeFunctions=this.options.serializeFunctions!=null?this.options.serializeFunctions:!1,this.raw=this.options.raw!=null?this.options.raw:!1,this.recordQueryStats=this.options.recordQueryStats!=null?this.options.recordQueryStats:!1,this.recordQueryStats==1&&this.serverConfig.enableRecordQueryStats(!0),this.retryMiliSeconds=this.options.retryMiliSeconds!=null?this.options.retryMiliSeconds:1e3,this.numberOfRetries=this.options.numberOfRetries!=null?this.options.numberOfRetries:60,this.readPreference=this.options.readPreference,this.serverConfig.options.readPreference==null&&this.readPreference!=null&&this.serverConfig.setReadPreference(this.readPreference),this.serverConfig._dbStore.add(this)}function validateDatabaseName(e){if(typeof e!="string")throw new Error("database name must be a string");if(e.length===0)throw new Error("database name cannot be the empty string");if(e=="$external")return;var t=[" ",".","$","/","\\"];for(var n=0;n<t.length;n++)if(e.indexOf(t[n])!=-1)throw new Error("database names cannot contain the character '"+t[n]+"'")}var QueryCommand=require("./commands/query_command").QueryCommand,DbCommand=require("./commands/db_command").DbCommand,MongoReply=require("./responses/mongo_reply").MongoReply,Admin=require("./admin").Admin,Collection=require("./collection").Collection,Server=require("./connection/server").Server,ReplSet=require("./connection/repl_set/repl_set").ReplSet,ReadPreference=require("./connection/read_preference").ReadPreference,Mongos=require("./connection/mongos").Mongos,Cursor=require("./cursor").Cursor,EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,crypto=require("crypto"),timers=require("timers"),utils=require("./utils"),mongodb_cr_authenticate=require("./auth/mongodb_cr.js").authenticate,mongodb_gssapi_authenticate=require("./auth/mongodb_gssapi.js").authenticate,mongodb_sspi_authenticate=require("./auth/mongodb_sspi.js").authenticate,mongodb_plain_authenticate=require("./auth/mongodb_plain.js").authenticate,hasKerberos=!1;try{require("kerberos"),hasKerberos=!0}catch(err){}var processor=require("./utils").processor();inherits(Db,EventEmitter),Db.prototype.open=function(e){var t=this;if(this.openCalled)throw this.close(),new Error("db object already connecting, open cannot be called multiple times");this.readPreference!=null&&this.serverConfig.setReadPreference(this.readPreference),this.openCalled=!0,t._state="connecting";if(t.serverConfig instanceof Server||t.serverConfig instanceof ReplSet||t.serverConfig instanceof Mongos){var n={};for(var r in t.serverConfig.options)n[r]=t.serverConfig.options[r];n.firstCall=!0,t.serverConfig.connect(t,n,function(n,r){if(n!=null)return t.openCalled=!1,e(n,null);t._state="connected",t.commands.length>0&&_execute_queued_command(t),process.nextTick(function(){try{e(null,t)}catch(n){throw t.close(),n}})})}else try{e(Error("Server parameter must be of type Server, ReplSet or Mongos"),null)}catch(i){throw t.close(),i}},Db.prototype.db=function(e){var t={};for(var n in this.options)t[n]=this.options[n];t.override_used_flag=!0;var r=this.serverConfig._dbStore.fetch(e);return r||(r=new Db(e,this.serverConfig,t)),r},Db.prototype.close=function(e,t){var n=this;this._applicationClosed=!1,typeof e=="function"?t=e:typeof e=="boolean"&&(this._applicationClosed=e),this.serverConfig.close(function(e,r){n.openCalled=!1,t&&t(e,r)})},Db.prototype.admin=function(e){if(e==null)return new Admin(this);e(null,new Admin(this))},Db.prototype.collectionsInfo=function(e,t){t==null&&typeof e=="function"&&(t=e,e=null);var n={};e!=null&&(n.name=this.databaseName+"."+e);if(!t)return new Cursor(this,new Collection(this,DbCommand.SYSTEM_NAMESPACE_COLLECTION),n);t(null,new Cursor(this,new Collection(this,DbCommand.SYSTEM_NAMESPACE_COLLECTION),n))},Db.prototype.collectionNames=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,0);n=i.pop(),e=i.length?i.shift():null,t=i.length?i.shift()||{}:{},e!=null&&typeof e=="object"&&(t=e,e=null),r.collectionsInfo(e,function(e,i){if(e!=null)return n(e,null);i.toArray(function(e,i){if(e!=null)return n(e,null);var s=i.filter(function(e){return e.name.indexOf(r.databaseName)!=-1&&e.name.indexOf("$")==-1});t.namesOnly&&(s=s.map(function(e){return e.name})),n(null,s)})})},Db.prototype.collection=function(e,t,n){var r=this;typeof t=="function"&&(n=t,t={});if(!t||!t.strict){try{var i=new Collection(r,e,r.pkFactory,t)}catch(s){if(n==null)throw s;return n(s,null)}return n==null?i:n(null,i)}r.collectionNames(e,function(i,s){if(i!=null)return n(i,null);if(s.length==0)return n(new Error("Collection "+e+" does not exist. Currently in safe mode."),null);try{var o=new Collection(r,e,r.pkFactory,t)}catch(i){return n(i,null)}return n(null,o)})},Db.prototype.collections=function(e){var t=this;t.collectionNames(function(n,r){if(n!=null)return e(n,null);var i=[];r.forEach(function(e){i.push(new Collection(t,e.name.replace(t.databaseName+".",""),t.pkFactory))}),e(null,i)})},Db.prototype.eval=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop(),t=i.length?i.shift():t,n=i.length?i.shift()||{}:{};var s=e,o=[];s instanceof this.bsonLib.Code||(s=new this.bsonLib.Code(s)),t!=null&&t.constructor!=Array&&typeof t!="function"?o=[t]:t!=null&&t.constructor==Array&&typeof t!="function"&&(o=t);var u={$eval:s,args:o};n.nolock&&(u.nolock=n.nolock),n.readPreference=ReadPreference.PRIMARY,this.collection(DbCommand.SYSTEM_COMMAND_COLLECTION).findOne(u,n,function(e,t){if(e)return r(e);if(t&&t.ok==1)r(null,t.retval);else{if(t){r(new Error("eval failed: "+t.errmsg),null);return}r(e,t)}})},Db.prototype.dereference=function(e,t){var n=this;e.db!=null&&(n=this.db(e.db));var r=n.collection(e.namespace);r.findOne({_id:e.oid},function(e,n){t(e,n)})},Db.prototype.logout=function(e,t){var n=this,r=Array.prototype.slice.call(arguments,0);t=r.pop(),e=r.length?r.shift()||{}:{};var i=this.serverConfig.allRawConnections().length,s=DbCommand.logoutCommand(n,{logout:1},e);n._executeQueryCommand(s,{onAll:!0},function(e,r){i-=1;if(i<=0&&typeof t=="function"){var s=t;t=null,n.serverConfig.auth.remove(n.databaseName),utils.handleSingleCommandResultReturn(!0,!1,s)(e,r)}})},Db.prototype.authenticate=function(e,t,n,r){var i=this;typeof r=="undefined"&&(r=n,n={});if(!n.authMechanism)n.authMechanism="MONGODB-CR";else if(n.authMechanism!="GSSAPI"&&n.authMechanism!="MONGODB-CR"&&n.authMechanism!="PLAIN")return r(new Error("only GSSAPI, PLAIN or MONGODB-CR is supported by authMechanism"));var s=n.authdb?n.authdb:i.databaseName;s=n.authSource?n.authSource:s;var o=function(e,t){i.listeners("authenticated").length>9&&i.emit("authenticated",e,t),r(e,t)};if(n.authMechanism=="MONGODB-CR")mongodb_cr_authenticate(i,e,t,s,n,o);else if(n.authMechanism=="PLAIN")mongodb_plain_authenticate(i,e,t,n,o);else if(n.authMechanism=="GSSAPI"){if(hasKerberos==0)throw console.log("========================================================================================"),console.log("=  Please make sure that you install the Kerberos library to use GSSAPI                ="),console.log("=                                                                                      ="),console.log("=  npm install -g kerberos                                                             ="),console.log("=                                                                                      ="),console.log("=  The Kerberos package is not installed by default for simplicities sake              ="),console.log("=  and needs to be global install                                                      ="),console.log("========================================================================================"),new Error("Kerberos library not installed");process.platform=="win32"?mongodb_sspi_authenticate(i,e,t,s,n,o):mongodb_gssapi_authenticate(i,e,t,s,n,o)}},Db.prototype.addUser=function(e,t,n,r){var i=this,s=Array.prototype.slice.call(arguments,2);r=s.pop(),n=s.length?s.shift()||{}:{};var o=_getWriteConcern(this,n,r);o.w=o.w==null?1:o.w;var u=crypto.createHash("md5");u.update(e+":mongo:"+t);var a=u.digest("hex"),f=this.collection(DbCommand.SYSTEM_USER_COLLECTION);f.count({},function(t,i){if(t!=null)return r(t,null);f.find({user:e},{dbName:n.dbName}).toArray(function(t,s){if(t!=null)return r(t,null);var u=o;u.dbName=n.dbName,u.upsert=!0,f.update({user:e},{$set:{user:e,pwd:a}},u,function(t,n){i==0&&t?r(null,[{user:e,pwd:a}]):t?r(t,null):r(null,[{user:e,pwd:a}])})})})},Db.prototype.removeUser=function(e,t,n){var r=this,i=Array.prototype.slice.call(arguments,1);n=i.pop(),t=i.length?i.shift()||{}:{};var s=r.safe!=null&&r.safe==0?{w:1}:r.safe;s=t!=null&&t["safe"]!=null?t.safe:s,s=s==null?{w:1}:s;var o=this.collection(DbCommand.SYSTEM_USER_COLLECTION);o.findOne({user:e},{dbName:t.dbName},function(r,i){if(i!=null){var u=s;u.dbName=t.dbName,o.remove({user:e},u,function(e,t){n(e,!0)})}else n(r,!1)})},Db.prototype.createCollection=function(e,t,n){var r=Array.prototype.slice.call(arguments,1);n=r.pop(),t=r.length?r.shift():null;var i=this,s=i.safe!=null&&i.safe==0?{w:1}:i.safe;s=t!=null&&t["safe"]!=null?t.safe:s,s=s==null?{w:1}:s,this.collectionNames(e,function(r,o){if(r!=null)return n(r,null);var u=!1;o.forEach(function(t){t.name==i.databaseName+"."+e&&(u=!0)});if(u&&t&&t.strict)return n(new Error("Collection "+e+" already exists. Currently in safe mode."),null);if(u){try{var a=new Collection(i,e,i.pkFactory,t)}catch(r){return n(r,null)}return n(null,a)}i._executeQueryCommand(DbCommand.createCreateCollectionCommand(i,e,t),{read:!1,safe:s},utils.handleSingleCommandResultReturn(null,null,function(r,s){if(r)return n(r,null);try{return n(null,new Collection(i,e,i.pkFactory,t))}catch(r){return n(r,null)}}))})};var _getReadConcern=function(e,t){return t.readPreference?t.readPreference:e.readPreference?e.readPreference:"primary"};Db.prototype.command=function(e,t,n){var r=Array.prototype.slice.call(arguments,1);n=r.pop(),t=r.length?r.shift()||{}:{};var i=t.ignoreCommandFilter?t.ignoreCommandFilter:!1,s=new Cursor(this,new Collection(this,DbCommand.SYSTEM_COMMAND_COLLECTION),e,{},{limit:-1,timeout:QueryCommand.OPTS_NO_CURSOR_TIMEOUT,dbName:t.dbName}),o=t.readPreference?t.readPreference:!1;s.connection=t.connection,o!=0&&i==0?e.group||e.aggregate||e.collStats||e.dbStats||e.count||e.distinct||e.geoNear||e.geoSearch||e.geoWalk||e.text||e.mapreduce&&(e.out=="inline"||e.out.inline)?s.setReadPreference(o):s.setReadPreference(ReadPreference.PRIMARY):o!=0&&s.setReadPreference(o),s.nextObject(function(e,t){if(e)return n(e,null);if(t==null)return n(new Error("no result returned from command"),null);n(null,t)})},Db.prototype.dropCollection=function(e,t){var n=this;t||(t=function(){}),this._executeQueryCommand(DbCommand.createDropCollectionCommand(this,e),utils.handleSingleCommandResultReturn(!0,!1,t))},Db.prototype.renameCollection=function(e,t,n,r){var i=this;typeof n=="function"&&(r=n,n={}),n.new_collection=!0,this.collection(e).rename(t,n,r)},Db.prototype.lastError=function(e,t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop(),e=r.length?r.shift()||{}:{},t=r.length?r.shift()||{}:{},this._executeQueryCommand(DbCommand.createGetLastErrorCommand(e,this),t,function(e,t){n(e,t&&t.documents)})},Db.prototype.error=Db.prototype.lastError,Db.prototype.lastStatus=Db.prototype.lastError,Db.prototype.previousErrors=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop(),e=n.length?n.shift()||{}:{},this._executeQueryCommand(DbCommand.createGetPreviousErrorsCommand(this),e,function(e,n){t(e,n.documents)})},Db.prototype.executeDbCommand=function(e,t,n){n==null&&(n=t,t={}),this._executeQueryCommand(DbCommand.createDbSlaveOkCommand(this,e,t),t,function(e,t){n&&n(e,t)})},Db.prototype.executeDbAdminCommand=function(e,t,n){typeof t=="function"&&(n=t,t={}),t.readPreference&&(t.read=t.readPreference),this._executeQueryCommand(DbCommand.createAdminDbCommand(this,e),t,function(e,t){n&&n(e,t)})},Db.prototype.resetErrorHistory=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop(),e=n.length?n.shift()||{}:{},this._executeQueryCommand(DbCommand.createResetErrorHistoryCommand(this),e,function(e,n){t&&t(e,n&&n.documents)})},Db.prototype.createIndex=function(e,t,n,r){var i=this,s=Array.prototype.slice.call(arguments,2);r=s.pop(),n=s.length?s.shift()||{}:{},n=typeof r=="function"?n:r,n=n==null?{}:n;var o=_getWriteConcern(this,n,r),u=DbCommand.createCreateIndexCommand(this,e,t,n),a={};if(!_hasWriteConcern(o)||typeof r!="function"){if(_hasWriteConcern(o)&&r==null)throw new Error("Cannot use a writeConcern without a provided callback");var c=this._executeInsertCommand(u,a);if(!r)return;return c instanceof Error?r(c):r(null,null)}a.read=!1,o==null&&(a.async=!0),a.safe=o;if(typeof o=="object"){var f=Object.keys(o);for(var l=0;l<f.length;l++)a[f[l]]=o[f[l]]}this._executeInsertCommand(u,a,function(e,t){if(e!=null)return r(e,null);t=t&&t.documents,t[0].err?r(utils.toError(t[0])):r(null,u.documents[0].name)})},Db.prototype.ensureIndex=function(e,t,n,r){var i=this;typeof r=="undefined"&&typeof n=="function"&&(r=n,n={}),n==null&&(n={});var s=_getWriteConcern(this,n,r);if(_hasWriteConcern(s)&&r==null)throw new Error("Cannot use a writeConcern without a provided callback");var o=DbCommand.createCreateIndexCommand(this,e,t,n),u=o.documents[0].name,a={};this.indexInformation(e,function(e,t){if(e!=null)return r(e,null);if(!t[u]){if(!_hasWriteConcern(s)||typeof r!="function"){var l=i._executeInsertCommand(o,a);if(!r)return;return l instanceof Error?r(l):r(null,u)}a.read=!1,s==null&&(a.async=!0);if(typeof s=="object"){var n=Object.keys(s);for(var f=0;f<n.length;f++)a[n[f]]=s[n[f]]}typeof r=="function"&&a.w<1&&!a.fsync&&!a.journal&&(a.w=1),i._executeInsertCommand(o,a,function(e,t){if(typeof r=="function"){if(e!=null)return r(e,null);t=t&&t.documents,t[0].err?r(utils.toError(t[0])):r(null,o.documents[0].name)}})}else if(typeof r=="function")return r(null,u)})},Db.prototype.cursorInfo=function(e,t){var n=Array.prototype.slice.call(arguments,0);t=n.pop(),e=n.length?n.shift()||{}:{},this._executeQueryCommand(DbCommand.createDbSlaveOkCommand(this,{cursorInfo:1}),e,utils.handleSingleCommandResultReturn(null,null,t))},Db.prototype.dropIndex=function(e,t,n){this._executeQueryCommand(DbCommand.createDropIndexCommand(this,e,t),utils.handleSingleCommandResultReturn(null,null,n))},Db.prototype.reIndex=function(e,t){this._executeQueryCommand(DbCommand.createReIndexCommand(this,e),utils.handleSingleCommandResultReturn(!0,!1,t))},Db.prototype.indexInformation=function(e,t,n){typeof n=="undefined"&&(typeof t=="undefined"?(n=e,e=null):n=t,t={});var r=t["full"]==null?!1:t.full,i=e!=null?{ns:this.databaseName+"."+e}:{},s=t.readPreference?t.readPreference:ReadPreference.PRIMARY;this.collection(DbCommand.SYSTEM_INDEX_COLLECTION,function(e,t){t.find(i).setReadPreference(s).toArray(function(e,t){if(e!=null)return n(e,null);var i={};if(r)return n(null,t);for(var s=0;s<t.length;s++){var o=t[s];i[o.name]=[];for(var u in o.key)i[o.name].push([u,o.key[u]])}n(null,i)})})},Db.prototype.dropDatabase=function(e){this._executeQueryCommand(DbCommand.createDropDatabaseCommand(this),utils.handleSingleCommandResultReturn(!0,!1,e))},Db.prototype.stats=function(t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop(),t=r.length?r.shift()||{}:{};var i={dbStats:this.collectionName};t["scale"]!=null&&(i.scale=t.scale),this.command(i,t,n)};var __executeQueryCommand=function(e,t,n,r){var i=n["read"]!=null?n.read:!1,s=n["raw"]!=null?n.raw:e.raw,o=n["onAll"]!=null?n.onAll:!1,u=n["connection"]!=null?n.connection:null;if(typeof i!="object"&&i._type=="ReadPreference"){i=i==null||i=="primary"||i==0?ReadPreference.PRIMARY:i;if(!ReadPreference.isValid(i))return r(new Error("Illegal readPreference mode specified, "+i))}else if(typeof i=="object"&&i._type=="ReadPreference"&&!i.isValid())return r(new Error("Illegal readPreference mode specified, "+i.mode));e.serverConfig.isMongos()&&i!=null&&i!=0&&t.setMongosReadPreference(i);if(typeof r=="function"&&!o){var a=u!=null?u:null;if(a instanceof Error)return r(a,null);a==null&&(a=e.serverConfig.checkoutReader(i));if(a==null)return r(new Error("no open connections"));if(a instanceof Error||a["message"]!=null)return r(a);var f=n.exhaust||!1;e.serverConfig._registerHandler(t,s,a,f,r),a.isConnected()||(i==ReadPreference.PRIMARY||i==ReadPreference.PRIMARY_PREFERRED||i!=null&&typeof i=="object"&&i.mode||i==null?e.serverConfig._commandsStore.read_from_writer({type:"query",db_command:t,options:n,callback:r,db:e,executeQueryCommand:__executeQueryCommand,executeInsertCommand:__executeInsertCommand}):e.serverConfig._commandsStore.read({type:"query",db_command:t,options:n,callback:r,db:e,executeQueryCommand:__executeQueryCommand,executeInsertCommand:__executeInsertCommand})),a.write(t,function(n){n!=null&&(Array.isArray(t)?e.serverConfig._callHandler(t[0].getRequestId(),null,n):e.serverConfig._callHandler(t.getRequestId(),null,n))})}else if(typeof r=="function"&&o){var l=e.serverConfig.allRawConnections(),c=l.length;for(var h=0;h<l.length;h++){var a=l[h];if(a==null)return r(new Error("no open connections"));if(a instanceof Error)return r(a);e.serverConfig._registerHandler(t,s,a,r),a.write(t,function(n){c-=1,n!=null&&e.serverConfig._removeHandler(t.getRequestId()),c<=0&&r(n)}),t.updateRequestId()}}else{var a=e.serverConfig.checkoutReader(i);a=u!=null?u:a;if(a==null||a instanceof Error||a["message"]!=null)return null;a.write(t,function(t){t!=null&&e.emit("error",t)})}};Db.prototype._executeQueryCommand=function(e,t,n){var r=this;typeof n=="undefined"&&(n=t,t={});var i=t["failFast"]!=null?t.failFast:!1;if(this._applicationClosed){var s=new Error("db closed by application");if("function"==typeof n)return n(s,null);throw s}if(this.serverConfig.isDestroyed())return n(new Error("Connection was destroyed by application"));var o=t.connection;o&&(!o.isConnected||!o.isConnected())&&(o=null);var u=this.serverConfig,a=t.read;if(!o&&!u.canRead(a)&&!u.canWrite()&&u.isAutoReconnect())a==ReadPreference.PRIMARY||a==ReadPreference.PRIMARY_PREFERRED||a!=null&&typeof a=="object"&&a.mode||a==null?r.serverConfig._commandsStore.read_from_writer({type:"query",db_command:e,options:t,callback:n,db:r,executeQueryCommand:__executeQueryCommand,executeInsertCommand:__executeInsertCommand}):r.serverConfig._commandsStore.read({type:"query",db_command:e,options:t,callback:n,db:r,executeQueryCommand:__executeQueryCommand,executeInsertCommand:__executeInsertCommand});else{if(!o&&!u.canRead(a)&&!u.canWrite()&&!u.isAutoReconnect())return n(new Error("no open connections"),null);typeof n=="function"?__executeQueryCommand(r,e,t,function(e,t,r){n(e,t,r)}):__executeQueryCommand(r,e,t)}};var __executeInsertCommand=function(e,t,n,r){var i=e.serverConfig.checkoutWriter(),s=n["safe"]!=null?n.safe:!1,o=n["raw"]!=null?n.raw:e.raw,u=n["connection"]!=null?n.connection:null;i=u!=null?u:i;if(typeof r=="function"){if(i==null)return r(new Error("no open connections"));if(i instanceof Error)return r(i);var a=_getWriteConcern(e,n,r);if(a.w>0||a.w=="majority"||a.j||a.journal||a.fsync)t=[t,DbCommand.createGetLastErrorCommand(s,e)],e.serverConfig._registerHandler(t[1],o,i,r)}if(i==null)return null;if(i instanceof Error&&typeof r=="function")return r(i,null);if(i instanceof Error)return null;if(i==null&&typeof r=="function")return r(new Error("no primary server found"),null);if(!i.isConnected())return e.serverConfig._commandsStore.write({type:"insert",db_command:t,options:n,callback:r,db:e,executeQueryCommand:__executeQueryCommand,executeInsertCommand:__executeInsertCommand});i.write(t,function(n){typeof r!="function"||s!=null&&s!=0?typeof r=="function"?e.serverConfig._callHandler(t[1].getRequestId(),null,n):typeof r=="function"&&s&&s.w==-1?e.serverConfig._callHandler(t[1].getRequestId(),null,null):(!s||s.w==-1)&&e.emit("error",n):r(n,null)})};Db.prototype._executeInsertCommand=function(e,t,n){var r=this;n==null&&typeof t=="function"&&(n=t,t={}),t=t==null?{}:t;if(this._applicationClosed){if(typeof n=="function")return n(new Error("db closed by application"),null);throw new Error("db closed by application")}if(this.serverConfig.isDestroyed())return n(new Error("Connection was destroyed by application"));var i=t.connection;i&&(!i.isConnected||!i.isConnected())&&(i=null);var s=r.serverConfig;if(!i&&!s.canWrite()&&s.isAutoReconnect())r.serverConfig._commandsStore.write({type:"insert",db_command:e,options:t,callback:n,db:r,executeQueryCommand:__executeQueryCommand,executeInsertCommand:__executeInsertCommand});else{if(!i&&!s.canWrite()&&!s.isAutoReconnect())return n(new Error("no open connections"),null);__executeInsertCommand(r,e,t,n)}},Db.prototype._executeUpdateCommand=Db.prototype._executeInsertCommand,Db.prototype._executeRemoveCommand=Db.prototype._executeInsertCommand,Db.prototype.wrap=utils.toError,Db.DEFAULT_URL="mongodb://localhost:27017/default",Db.connect=function(e,t,n){typeof t=="function"&&(n=t,t={}),e.indexOf("safe")==-1&&e.indexOf("w")==-1&&e.indexOf("journal")==-1&&e.indexOf("j")==-1&&e.indexOf("fsync")==-1&&(t.w=0);var r=require("./mongo_client.js").MongoClient;r.connect.call(r,e,t,n)},Object.defineProperty(Db.prototype,"state",{enumerable:!0,get:function(){return this.serverConfig._serverState}});var _hasWriteConcern=function(e){return e==1||e.w>0||e.w=="majority"||e.j==1||e.journal==1||e.fsync==1},_setWriteConcernHash=function(e){var t={};return e.w!=null&&(t.w=e.w),e.journal==1&&(t.j=e.journal),e.j==1&&(t.j=e.j),e.fsync==1&&(t.fsync=e.fsync),e.wtimeout!=null&&(t.wtimeout=e.wtimeout),t},_getWriteConcern=function(e,t,n){var r={w:1};t.w!=null||typeof t.j=="boolean"||typeof t.journal=="boolean"||typeof t.fsync=="boolean"?r=_setWriteConcernHash(t):t.safe!=null&&typeof t.safe=="object"?r=_setWriteConcernHash(t.safe):typeof t.safe=="boolean"?r={w:t.safe?1:0}:e.options.w!=null||typeof e.options.j=="boolean"||typeof e.options.journal=="boolean"||typeof e.options.fsync=="boolean"?r=_setWriteConcernHash(e.options):e.safe.w!=null||typeof e.safe.j=="boolean"||typeof e.safe.journal=="boolean"||typeof e.safe.fsync=="boolean"?r=_setWriteConcernHash(e.safe):typeof e.safe=="boolean"&&(r={w:e.safe?1:0});if(r.w<1&&(r.journal==1||r.j==1||r.fsync==1))throw new Error("No acknowlegement using w < 1 cannot be combined with journal:true or fsync:true");return r};exports.connect=Db.connect,exports.Db=Db,Db.prototype.removeAllEventListeners=function(){this.removeAllListeners("close"),this.removeAllListeners("error"),this.removeAllListeners("timeout"),this.removeAllListeners("parseError"),this.removeAllListeners("poolReady"),this.removeAllListeners("message")};