var Binary=require("bson").Binary,ObjectID=require("bson").ObjectID,Chunk=exports.Chunk=function(e,t,n){if(!(this instanceof Chunk))return new Chunk(e,t);this.file=e;var r=this,i=t==null?{}:t;this.writeConcern=n||{w:1},this.objectId=i._id==null?new ObjectID:i._id,this.chunkNumber=i.n==null?0:i.n,this.data=new Binary;if(i.data!=null)if(typeof i.data=="string"){var s=new Buffer(i.data.length);s.write(i.data,"binary",0),this.data=new Binary(s)}else if(Array.isArray(i.data)){var s=new Buffer(i.data.length);s.write(i.data.join(""),"binary",0),this.data=new Binary(s)}else if(i.data instanceof Binary||Object.prototype.toString.call(i.data)=="[object Binary]")this.data=i.data;else if(!Buffer.isBuffer(i.data))throw Error("Illegal chunk format");this.internalPosition=0};Chunk.prototype.write=function(e,t){return this.data.write(e,this.internalPosition),this.internalPosition=this.data.length(),t!=null?t(null,this):this},Chunk.prototype.read=function(e){e=e==null||e==0?this.length():e;if(this.length()-this.internalPosition+1>=e){var t=this.data.read(this.internalPosition,e);return this.internalPosition=this.internalPosition+e,t}return""},Chunk.prototype.readSlice=function(e){if(this.length()-this.internalPosition>=e){var t=null;return this.data.buffer!=null?t=this.data.buffer.slice(this.internalPosition,this.internalPosition+e):(t=new Buffer(e),e=this.data.readInto(t,this.internalPosition)),this.internalPosition=this.internalPosition+e,t}return null},Chunk.prototype.eof=function(){return this.internalPosition==this.length()?!0:!1},Chunk.prototype.getc=function(){return this.read(1)},Chunk.prototype.rewind=function(){this.internalPosition=0,this.data=new Binary},Chunk.prototype.save=function(e){var t=this;t.file.chunkCollection(function(n,r){if(n)return e(n);r.remove({_id:t.objectId},t.writeConcern,function(n,i){if(n)return e(n);t.data.length()>0?t.buildMongoObject(function(n){var i={forceServerObjectId:!0};for(var s in t.writeConcern)i[s]=t.writeConcern[s];r.insert(n,i,function(n,r){e(n,t)})}):e(null,t)})})},Chunk.prototype.buildMongoObject=function(e){var t={files_id:this.file.fileId,n:this.chunkNumber,data:this.data};this.objectId!=null&&(t._id=this.objectId),e(t)},Chunk.prototype.length=function(){return this.data.length()},Object.defineProperty(Chunk.prototype,"position",{enumerable:!0,get:function(){return this.internalPosition},set:function(e){this.internalPosition=e}}),Chunk.DEFAULT_CHUNK_SIZE=262144;