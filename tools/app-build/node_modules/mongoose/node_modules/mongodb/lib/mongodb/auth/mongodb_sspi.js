var DbCommand=require("../commands/db_command").DbCommand,utils=require("../utils"),format=require("util").format,Kerberos=null,MongoAuthProcess=null;try{Kerberos=require("kerberos").Kerberos,MongoAuthProcess=require("kerberos").processes.MongoAuthProcess}catch(err){}var authenticate=function(e,t,n,r,i,s){var o=0,u=null;if(Kerberos==null)return s(new Error("Kerberos library is not installed"));i["connection"]!=null?o=1:(o=e.serverConfig.allRawConnections().length,i.onAll=!0);var a=i.gssapiServiceName||"mongodb",f=e.serverConfig.allRawConnections(),l=null;for(var c=0;c<o;c++)SSIPAuthenticate(e,t,n,r,a,f[c],function(i,u){o-=1,i&&(l=i);if(o==0)return i?s(i,!1):(e.serverConfig.auth.add("GSSAPI",e.databaseName,t,n,r,a),s(null,!0))})},SSIPAuthenticate=function(e,t,n,r,i,s,o){var u={saslStart:1,mechanism:"GSSAPI",payload:"",autoAuthorize:1},a=new MongoAuthProcess(s.socketOptions.host,s.socketOptions.port,i);e._executeQueryCommand(DbCommand.createDbCommand(e,u,{},"$external"),{connection:s},function(r,i){if(r)return o(r);i=i.documents[0],a.init(t,n,function(t){if(t)return o(t);a.transition(i.payload,function(t,n){if(t)return o(t);var r={saslContinue:1,conversationId:i.conversationId,payload:n};e._executeQueryCommand(DbCommand.createDbCommand(e,r,{},"$external"),{connection:s},function(t,n){if(t)return o(t);n=n.documents[0],a.transition(n.payload,function(t,r){if(t)return o(t);var i={saslContinue:1,conversationId:n.conversationId,payload:r};e._executeQueryCommand(DbCommand.createDbCommand(e,i,{},"$external"),{connection:s},function(t,n){if(t)return o(t);n=n.documents[0],a.transition(n.payload,function(t,r){var i={saslContinue:1,conversationId:n.conversationId,payload:r};e._executeQueryCommand(DbCommand.createDbCommand(e,i,{},"$external"),{connection:s},function(e,t){if(e)return o(e);t=t.documents[0];if(t.done)return o(null,!0);o(new Error("Authentication failed"),!1)})})})})})})})})};exports.authenticate=authenticate;