var EventEmitter=require("events").EventEmitter,inherits=require("util").inherits,mongodb_cr_authenticate=require("../auth/mongodb_cr.js").authenticate,mongodb_gssapi_authenticate=require("../auth/mongodb_gssapi.js").authenticate,mongodb_sspi_authenticate=require("../auth/mongodb_sspi.js").authenticate,id=0,CallbackStore=function(){EventEmitter.call(this),this._notReplied={},this.id=id++};inherits(CallbackStore,EventEmitter),CallbackStore.prototype.notRepliedToIds=function(){return Object.keys(this._notReplied)},CallbackStore.prototype.callbackInfo=function(e){return this._notReplied[e]};var NonExecutedOperationStore=function(e){this.config=e,this.commands={read:[],write_reads:[],write:[]}};NonExecutedOperationStore.prototype.write=function(e){this.commands.write.push(e)},NonExecutedOperationStore.prototype.read_from_writer=function(e){this.commands.write_reads.push(e)},NonExecutedOperationStore.prototype.read=function(e){this.commands.read.push(e)},NonExecutedOperationStore.prototype.execute_queries=function(e){var t=this.config.checkoutReader();if(t==null||t instanceof Error)return;while(this.commands.read.length>0){var n=this.commands.read.shift();n.options.connection=t,n.executeQueryCommand(n.db,n.db_command,n.options,n.callback)}},NonExecutedOperationStore.prototype.execute_writes=function(){var e=this.config.checkoutWriter();if(e==null||e instanceof Error)return;while(this.commands.write_reads.length>0){var t=this.commands.write_reads.shift();t.options.connection=e,t.executeQueryCommand(t.db,t.db_command,t.options,t.callback)}while(this.commands.write.length>0){var t=this.commands.write.shift();t.options.connection=e,t.executeInsertCommand(t.db,t.db_command,t.options,t.callback)}};var AuthStore=function(){this._auths=[]};AuthStore.prototype.add=function(e,t,n,r,i,s){if(!this.contains(t)){var o={username:n,password:r,db:t,authMechanism:e,gssapiServiceName:s};typeof i=="string"&&(o.authdb=i),this._auths.push(o)}},AuthStore.prototype.contains=function(e){for(var t=0;t<this._auths.length;t++)if(this._auths[t].db==e)return!0;return!1},AuthStore.prototype.remove=function(e){var t=[];for(var n=0;n<this._auths.length;n++)this._auths[n].db!=e&&t.push(this._auths[n]);this._auths=t},AuthStore.prototype.get=function(e){return this._auths[e]},AuthStore.prototype.length=function(){return this._auths.length},AuthStore.prototype.toArray=function(){return this._auths.slice(0)};var DbStore=function(){this._dbs=[]};DbStore.prototype.add=function(e){var t=!1;for(var n=0;n<this._dbs.length;n++)e.databaseName==this._dbs[n].databaseName&&(t=!0);t||this._dbs.push(e)},DbStore.prototype.reset=function(){this._dbs=[]},DbStore.prototype.fetch=function(e){for(var t=0;t<this._dbs.length;t++)if(e==this._dbs[t].databaseName)return this._dbs[t];return null},DbStore.prototype.emit=function(e,t,n,r,i,s){var o=!1;for(var u=0;u<this._dbs.length;u++)this._dbs[u].listeners(e).length>0&&(i==null||i.databaseName!==this._dbs[u].databaseName||i.tag!==this._dbs[u].tag)&&(this._dbs[u].emit(e,t,n==null?this._dbs[u]:n),o=!0);t&&e=="error"&&!o&&s&&n&&n.db&&process.nextTick(function(){n.db.emit(e,t,null)});if(!o&&s)throw t};var Base=function e(){EventEmitter.call(this),e._callBackStore==null&&(e._callBackStore=new CallbackStore),this._callBackStore=new CallbackStore,this._commandsStore=new NonExecutedOperationStore(this),this.auth=new AuthStore,this._dbStore=new DbStore};inherits(Base,EventEmitter),Base.prototype._apply_auths=function(e,t){_apply_auths_serially(this,e,this.auth.toArray(),t)};var _apply_auths_serially=function(e,t,n,r){if(n.length==0)return r(null,null);var i=n.shift(),s=e.allRawConnections(),o=s.length,u={};i.authMechanism=="GSSAPI"?process.platform=="win32"?mongodb_sspi_authenticate(t,i.username,i.password,i.authdb,u,r):mongodb_gssapi_authenticate(t,i.username,i.password,i.authdb,u,r):i.authMechanism=="MONGODB-CR"&&mongodb_cr_authenticate(t,i.username,i.password,i.authdb,u,r)};Base.prototype.__executeAllCallbacksWithError=function(e){var t=Object.keys(this._callBackStore._notReplied);for(var n=0;n<t.length;n++){var r=this._callBackStore._notReplied[t[n]];this._callBackStore.emit(t[n],e,null),delete this._callBackStore._notReplied[t[n]],this._callBackStore._events&&delete this._callBackStore._events[t[n]]}},Base.prototype.__executeAllServerSpecificErrorCallbacks=function(e,t,n){var r=Object.keys(this._callBackStore._notReplied);for(var i=0;i<r.length;i++){var s=this._callBackStore._notReplied[r[i]];if(s.connection){var o=s.connection.socketOptions.host,u=s.connection.socketOptions.port;u==t&&o==e&&(this._callBackStore.emit(r[i],n,null),delete this._callBackStore._notReplied[r[i]],this._callBackStore._events&&delete this._callBackStore._events[r[i]])}}},Base.prototype._registerHandler=function(e,t,n,r,i){typeof r=="function"&&(i=r,r=!1),this._callBackStore.once(e.getRequestId(),i),this._callBackStore._notReplied[e.getRequestId().toString()]={start:(new Date).getTime(),raw:t,connection:n,exhaust:r}},Base.prototype._reRegisterHandler=function(e,t,n){this._callBackStore.once(e,t.callback.listener),this._callBackStore._notReplied[e]=t.info},Base.prototype._callHandler=function(e,t,n){var r=this;if(this._callBackStore.listeners(e).length>=1){var i=this._callBackStore._notReplied[e];delete this._callBackStore._notReplied[e];var s=this._callBackStore.listeners(e)[0].listener;this._callBackStore.removeAllListeners(e),this._callBackStore._events&&delete this._callBackStore._events[e];try{typeof s=="function"&&s(n,t,i.connection)}catch(n){r._emitAcrossAllDbInstances(r,null,"error",n,r,!0,!0)}}},Base.prototype._hasHandler=function(e){return this._callBackStore.listeners(e).length>=1},Base.prototype._removeHandler=function(e){this._callBackStore._notReplied[e]!=null&&delete this._callBackStore._notReplied[e],this._callBackStore.removeAllListeners(e),this._callBackStore._events&&delete this._callBackStore._events[e]},Base.prototype._findHandler=function(e){var t=this._callBackStore._notReplied[e];return{info:t,callback:this._callBackStore.listeners(e).length>=1?this._callBackStore.listeners(e)[0]:null}},Base.prototype._emitAcrossAllDbInstances=function(e,t,n,r,i,s,o){if(s)for(var u=0;u<this._dbStore._dbs.length;u++)typeof this._dbStore._dbs[u].openCalled!="undefined"&&(this._dbStore._dbs[u].openCalled=!1);this._dbStore.emit(n,r,i,s,t,o)},exports.Base=Base;