function MongoClient(e,t){e!=null&&(t=t==null?{}:t,t!=null&&!t.journal&&!t.w&&!t.fsync&&(t.w=1),this._db=new Db("test",e,t))}var Db=require("./db").Db,Server=require("./connection/server").Server,Mongos=require("./connection/mongos").Mongos,ReplSet=require("./connection/repl_set/repl_set").ReplSet,ReadPreference=require("./connection/read_preference").ReadPreference,inherits=require("util").inherits,EventEmitter=require("events").EventEmitter,parse=require("./connection/url_parser").parse;inherits(MongoClient,EventEmitter),MongoClient.prototype.connect=function(e,t,n){var r=this;typeof t=="function"&&(n=t,t={}),MongoClient.connect(e,t,function(e,t){if(e)return n(e,t);r._db=t,r.emit("open",e,t),n(e,t)})},MongoClient.prototype.open=function(e){var t=this;this._db.open(function(n,r){if(n)return e(n,null);t.emit("open",n,r),e(null,t)})},MongoClient.prototype.close=function(e){this._db.close(e)},MongoClient.prototype.db=function(e){return this._db.db(e)},MongoClient.connect=function(e,t,n){var r=Array.prototype.slice.call(arguments,1);n=typeof r[r.length-1]=="function"?r.pop():null,t=r.length?r.shift():null,t=t||{};var i=t.server||{},s=t.mongos||{},o=t.replSet||t.replSetServers||{},u=t.db||{};if(n==null)throw new Error("no callback function provided");var a=parse(e,t);if(u)for(var f in u)a.db_options[f]=u[f];a.db_options.url=e;if(i)for(var f in i)a.server_options[f]=i[f];if(o)for(var f in o)a.rs_options[f]=o[f];if(s)for(var f in s)a.mongos_options[f]=s[f];var l=a.servers.length,c=0,h=0,p=null,d={};if(a.servers.length==0)throw new Error("connection string must contain at least one seed host");a.db_options.native_parser=_setNativeParser(a.db_options),typeof a.server_options.auto_reconnect!="boolean"&&(a.server_options.auto_reconnect=!0);for(var v=0;v<a.servers.length;v++){var m={poolSize:1,socketOptions:{connectTimeoutMS:1e3},auto_reconnect:!1};a.rs_options.ssl?(m.ssl=a.rs_options.ssl,m.sslValidate=a.rs_options.sslValidate,m.sslCA=a.rs_options.sslCA,m.sslCert=a.rs_options.sslCert,m.sslKey=a.rs_options.sslKey,m.sslPass=a.rs_options.sslPass):a.server_options.ssl&&(m.ssl=a.server_options.ssl,m.sslValidate=a.server_options.sslValidate,m.sslCA=a.server_options.sslCA,m.sslCert=a.server_options.sslCert,m.sslKey=a.server_options.sslKey,m.sslPass=a.server_options.sslPass);var g=a.servers[v].domain_socket?new Server(a.servers[v].domain_socket,m):new Server(a.servers[v].host,a.servers[v].port,m),y=function(e){(new Db(a.dbName,e,{safe:!1,native_parser:!1})).open(function(r,i){l-=1;if(!r){i.close(!0);var s=i.serverConfig.isMasterDoc;s.setName&&h++,s.msg&&s.msg=="isdbgrid"&&c++}else d[e.host+":"+e.port]=e;if(l==0){if(c>0&&h>0)return process.nextTick(function(){try{n(new Error("cannot combine a list of replicaset seeds and mongos seeds"))}catch(e){throw i&&i.close(),e}});if(h==0&&a.servers.length==1){var o=a.servers[0];p=o.domain_socket?new Server(o.domain_socket,a.server_options):new Server(o.host,o.port,a.server_options)}else if(h>0||c>0){var u=a.servers.filter(function(e){return d[e.host+":"+e.port]==null}).map(function(e){return new Server(e.host,e.port,a.server_options)});d={},h>0?p=new ReplSet(u,a.rs_options):p=new Mongos(u,a.mongos_options)}if(p==null)return process.nextTick(function(){try{n(new Error("Could not locate any valid servers in initial seed list"))}catch(e){throw i&&i.close(),e}});p.emitOpen=!1,_finishConnecting(p,a,t,n)}})};y(g)}};var _setNativeParser=function(e){if(typeof e.native_parser=="boolean")return e.native_parser;try{return require("bson").BSONNative.BSON,!0}catch(t){return!1}},_finishConnecting=function(e,t,n,r){var i={};t.db_options.journal&&(i.j=t.db_options.journal),t.db_options.w&&(i.w=t.db_options.w),t.db_options.fsync&&(i.fsync=t.db_options.fsync),t.db_options.wtimeoutMS&&(i.wtimeout=t.db_options.wtimeoutMS);if(t.db_options.read_preference){var s=new ReadPreference(t.db_options.read_preference);t.db_options.read_preference_tags&&(s=new ReadPreference(t.db_options.read_preference,t.db_options.read_preference_tags)),t.db_options.readPreference=s}Object.keys(i).length==0&&(i=!1),t.db_options.safe=i;var o=new Db(t.dbName,e,t.db_options);o.open(function(e,n){if(e)return process.nextTick(function(){try{r(e,null)}catch(e){throw n&&n.close(),e}});n.options!==null&&!n.options.safe&&!n.options.journal&&!n.options.w&&!n.options.fsync&&typeof n.options.w!="number"&&n.options.safe==0&&t.db_options.url.indexOf("safe=")==-1&&(n.options.w=1);if(e==null&&t.auth){var i=n;t.db_options&&t.db_options.authSource&&(i=n.db(t.db_options.authSource));var s={};t.db_options.authMechanism&&(s.authMechanism=t.db_options.authMechanism),t.db_options.gssapiServiceName&&(s.gssapiServiceName=t.db_options.gssapiServiceName),i.authenticate(t.auth.user,t.auth.password,s,function(e,t){t?process.nextTick(function(){try{r(null,n)}catch(e){throw n&&n.close(),e}}):(n&&n.close(),process.nextTick(function(){try{r(e?e:new Error("Could not authenticate user "+auth[0]),null)}catch(e){throw n&&n.close(),e}}))})}else process.nextTick(function(){try{r(e,n)}catch(e){throw n&&n.close(),e}})})};exports.MongoClient=MongoClient;