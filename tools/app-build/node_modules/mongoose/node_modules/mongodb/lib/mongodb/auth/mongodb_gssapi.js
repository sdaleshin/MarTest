var DbCommand=require("../commands/db_command").DbCommand,utils=require("../utils"),format=require("util").format,Kerberos=null,MongoAuthProcess=null;try{Kerberos=require("kerberos").Kerberos,MongoAuthProcess=require("kerberos").processes.MongoAuthProcess}catch(err){}var authenticate=function(e,t,n,r,i,s){var o=0,u=null;if(Kerberos==null)return s(new Error("Kerberos library is not installed"));i["connection"]!=null?o=1:(o=e.serverConfig.allRawConnections().length,i.onAll=!0);var a=i["connection"]!=null?[i.connection]:e.serverConfig.allRawConnections(),f=i.gssapiServiceName||"mongodb",l=null;for(var c=0;c<o;c++)GSSAPIInitialize(e,t,n,r,f,a[c],function(i,u){o-=1,i&&(l=i);if(o==0)return i?s(l,!1):(e.serverConfig.auth.add("GSSAPI",e.databaseName,t,n,r,f),s(null,!0))})},GSSAPIInitialize=function(e,t,n,r,i,s,o){var u=new MongoAuthProcess(s.socketOptions.host,s.socketOptions.port,i);u.init(t,n,function(i,a){if(i)return o(i,!1);u.transition("",function(i,a){if(i)return o(i,!1);MongoDBGSSAPIFirstStep(u,a,e,t,n,r,s,o)})})},MongoDBGSSAPIFirstStep=function(e,t,n,r,i,s,o,u){var a={saslStart:1,mechanism:"GSSAPI",payload:t,autoAuthorize:1};n._executeQueryCommand(DbCommand.createDbCommand(n,a,{},"$external"),{connection:o},function(t,a){if(t)return u(t,!1);a=a.documents[0];var f=a.payload;e.transition(a.payload,function(t,f){if(t)return u(t,!1);MongoDBGSSAPISecondStep(e,f,a,n,r,i,s,o,u)})})},MongoDBGSSAPISecondStep=function(e,t,n,r,i,s,o,u,a){var f={saslContinue:1,conversationId:n.conversationId,payload:t};r._executeQueryCommand(DbCommand.createDbCommand(r,f,{},"$external"),{connection:u},function(t,n){if(t)return a(t,!1);n=n.documents[0],e.transition(n.payload,function(t,f){if(t)return a(t,!1);MongoDBGSSAPIThirdStep(e,f,n,r,i,s,o,u,a)})})},MongoDBGSSAPIThirdStep=function(e,t,n,r,i,s,o,u,a){var f={saslContinue:1,conversationId:n.conversationId,payload:t};r._executeQueryCommand(DbCommand.createDbCommand(r,f,{},"$external"),{connection:u},function(t,n){if(t)return a(t,!1);e.transition(null,function(e,t){if(e)return a(e,!1);a(null,!0)})})};exports.authenticate=authenticate;