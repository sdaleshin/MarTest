function Cursor(e,t,n,r,i){this.db=e,this.collection=t,this.selector=n,this.fields=r,i=i?i:{},this.skipValue=i.skip==null?0:i.skip,this.limitValue=i.limit==null?0:i.limit,this.sortValue=i.sort,this.hint=i.hint,this.explainValue=i.explain,this.snapshot=i.snapshot,this.timeout=i.timeout==null?!0:i.timeout,this.tailable=i.tailable,this.awaitdata=i.awaitdata,this.numberOfRetries=i.numberOfRetries==null?5:i.numberOfRetries,this.currentNumberOfRetries=this.numberOfRetries,this.batchSizeValue=i.batchSize==null?0:i.batchSize,this.raw=i.raw==null?!1:i.raw,this.read=i.read==null?ReadPreference.PRIMARY:i.read,this.returnKey=i.returnKey,this.maxScan=i.maxScan,this.min=i.min,this.max=i.max,this.showDiskLoc=i.showDiskLoc,this.comment=i.comment,this.tailableRetryInterval=i.tailableRetryInterval||100,this.exhaust=i.exhaust||!1,this.partial=i.partial||!1,this.slaveOk=i.slaveOk||!1,this.totalNumberOfRecords=0,this.items=[],this.cursorId=Long.fromInt(0),this.dbName=i.dbName,this.state=Cursor.INIT,this.queryRun=!1,this.getMoreTimer=!1,this.dbName!=null?this.collectionName=this.dbName+"."+this.collection.collectionName:this.collectionName=(this.db.databaseName?this.db.databaseName+".":"")+this.collection.collectionName}var QueryCommand=require("./commands/query_command").QueryCommand,GetMoreCommand=require("./commands/get_more_command").GetMoreCommand,KillCursorCommand=require("./commands/kill_cursor_command").KillCursorCommand,Long=require("bson").Long,ReadPreference=require("./connection/read_preference").ReadPreference,CursorStream=require("./cursorstream"),timers=require("timers"),utils=require("./utils"),processor=require("./utils").processor();Cursor.prototype.rewind=function(){var e=this;return e.state!=Cursor.INIT&&(e.state!=Cursor.CLOSED&&e.close(function(){}),e.numberOfReturned=0,e.totalNumberOfRecords=0,e.items=[],e.cursorId=Long.fromInt(0),e.state=Cursor.INIT,e.queryRun=!1),e},Cursor.prototype.toArray=function(e){var t=this;if(!e)throw new Error("callback is mandatory");if(this.tailable)e(new Error("Tailable cursor cannot be converted to array"),null);else if(this.state!=Cursor.CLOSED){if(t.exhaust)return toArrayExhaust(t,e);t.nextObject({noReturn:!0},function(n,r){if(n)return e(utils.toError(n),null);if(t.cursorId.toString()=="0")return t.state=Cursor.CLOSED,e(null,t.items);getAllByGetMore(t,function(n,r){t.state=Cursor.CLOSED;if(n)return e(utils.toError(n),null);var i=t.items;t.items=null,e(null,i)})})}else e(new Error("Cursor is closed"),null)};var toArrayExhaust=function(e,t){var n=[];e.each(function(r,i){if(r!=null)return t(utils.toError(r),null);if(i!=null&&Array.isArray(n))n.push(i);else{var s=n;n=null,e.items=[],t(null,s)}})},getAllByGetMore=function(e,t){getMore(e,{noReturn:!0},function(n,r){if(n)return t(utils.toError(n));if(r==null)return t(null,null);if(e.cursorId.toString()=="0")return t(null,null);getAllByGetMore(e,t)})};Cursor.prototype.each=function(e){var t=this,n;if(!e)throw new Error("callback is mandatory");if(this.state!=Cursor.CLOSED){if(t.exhaust)return eachExhaust(t,e);if(this.items.length>0){while(n=loop(t,e))n(t,e);t.each(e)}else t.nextObject(function(n,r){if(n)return t.state=Cursor.CLOSED,e(utils.toError(n),r);if(r==null)return e(null,null);e(null,r),t.each(e)})}else e(new Error("Cursor is closed"),null)};var eachExhaust=function(e,t){processor(function(){e.nextObject(function(n,r){if(n!=null)return t(n,null);r!=null?(t(null,r),eachExhaust(e,t)):(e.state=Cursor.CLOSED,t(n,null))})})},loop=function(e,t){if(e.items.length==0)return;var n=e.items.shift();return t(null,n),loop};Cursor.prototype.count=function(e,t){typeof e=="function"&&(t=e,e=!1);var n={};e&&(typeof this.skipValue=="number"&&(n.skip=this.skipValue),typeof this.limitValue=="number"&&(n.limit=this.limitValue)),this.collection.count(this.selector,n,t)},Cursor.prototype.sort=function(e,t,n){n=n||function(){},typeof t=="function"&&(n=t,t=null);if(this.tailable)n(new Error("Tailable cursor doesn't support sorting"),null);else if(this.queryRun==1||this.state==Cursor.CLOSED)n(new Error("Cursor is closed"),null);else{var r=e;t!=null&&(r=[[e,t]]),this.sortValue=r,n(null,this)}return this},Cursor.prototype.limit=function(e,t){if(this.tailable){if(!t)throw new Error("Tailable cursor doesn't support limit");t(new Error("Tailable cursor doesn't support limit"),null)}else if(this.queryRun==1||this.state==Cursor.CLOSED){if(!t)throw new Error("Cursor is closed");t(new Error("Cursor is closed"),null)}else if(e!=null&&e.constructor!=Number){if(!t)throw new Error("limit requires an integer");t(new Error("limit requires an integer"),null)}else{this.limitValue=e;if(t)return t(null,this)}return this},Cursor.prototype.setReadPreference=function(e,t,n){typeof t=="function"&&(n=t);var r=e!=null&&typeof e=="object"?e.mode:e;if(this.queryRun==1||this.state==Cursor.CLOSED){if(n==null)throw new Error("Cannot change read preference on executed query or closed cursor");n(new Error("Cannot change read preference on executed query or closed cursor"))}else if(r!=null&&r!="primary"&&r!="secondaryOnly"&&r!="secondary"&&r!="nearest"&&r!="primaryPreferred"&&r!="secondaryPreferred"){if(n==null)throw new Error("only readPreference of primary, secondary, secondaryPreferred, primaryPreferred or nearest supported");n(new Error("only readPreference of primary, secondary, secondaryPreferred, primaryPreferred or nearest supported"))}else this.read=e,n!=null&&n(null,this);return this},Cursor.prototype.skip=function(e,t){return t=t||function(){},this.tailable?t(new Error("Tailable cursor doesn't support skip"),null):this.queryRun==1||this.state==Cursor.CLOSED?t(new Error("Cursor is closed"),null):e!=null&&e.constructor!=Number?t(new Error("skip requires an integer"),null):(this.skipValue=e,t(null,this)),this},Cursor.prototype.batchSize=function(e,t){if(this.state==Cursor.CLOSED){if(t!=null)return t(new Error("Cursor is closed"),null);throw new Error("Cursor is closed")}if(e!=null&&e.constructor!=Number){if(t!=null)return t(new Error("batchSize requires an integer"),null);throw new Error("batchSize requires an integer")}return this.batchSizeValue=e,t!=null?t(null,this):this};var limitRequest=function(e){var t=e.limitValue,n=Math.abs(e.limitValue),r=Math.abs(e.batchSizeValue);return n>0?r>0&&(t=Math.min(n,r)):t=e.batchSizeValue,t},generateQueryCommand=function(e){var t=QueryCommand.OPTS_NONE;e.timeout||(t|=QueryCommand.OPTS_NO_CURSOR_TIMEOUT),e.tailable!=null&&(t|=QueryCommand.OPTS_TAILABLE_CURSOR,e.skipValue=e.limitValue=0,e.awaitdata!=null&&(t|=QueryCommand.OPTS_AWAIT_DATA)),e.exhaust&&(t|=QueryCommand.OPTS_EXHAUST);var n=e.read instanceof ReadPreference?e.read.mode:e.read;if(n==ReadPreference.PRIMARY_PREFERRED||n==ReadPreference.SECONDARY||n==ReadPreference.SECONDARY_PREFERRED||n==ReadPreference.NEAREST)t|=QueryCommand.OPTS_SLAVE;e.slaveOk&&(t|=QueryCommand.OPTS_SLAVE),e.partial&&(t|=QueryCommand.OPTS_PARTIAL);var r=e.limitValue==-1?-1:limitRequest(e);if(e.sortValue!=null||e.explainValue!=null||e.hint!=null||e.snapshot!=null||e.returnKey!=null||e.maxScan!=null||e.min!=null||e.max!=null||e.showDiskLoc!=null||e.comment!=null){var i={$query:e.selector};return e.sortValue!=null&&(i.orderby=utils.formattedOrderClause(e.sortValue)),e.hint!=null&&e.hint.constructor==Object&&(i.$hint=e.hint),e.snapshot!=null&&(i.$snapshot=!0),e.returnKey!=null&&(i.$returnKey=e.returnKey),e.maxScan!=null&&(i.$maxScan=e.maxScan),e.min!=null&&(i.$min=e.min),e.max!=null&&(i.$max=e.max),e.showDiskLoc!=null&&(i.$showDiskLoc=e.showDiskLoc),e.comment!=null&&(i.$comment=e.comment),e.explainValue!=null&&(r=-1*Math.abs(r),i.$explain=!0),new QueryCommand(e.db,e.collectionName,t,e.skipValue,r,i,e.fields)}return new QueryCommand(e.db,e.collectionName,t,e.skipValue,r,e.selector,e.fields)};Cursor.prototype.formattedOrderClause=function(){return utils.formattedOrderClause(this.sortValue)},Cursor.prototype.formatSortValue=function(e){return utils.formatSortValue(e)},Cursor.prototype.nextObject=function(e,t){var n=this;typeof e=="function"&&(t=e,e={});if(n.state==Cursor.INIT){var r;try{r=generateQueryCommand(n)}catch(i){return t(i,null)}var s={exhaust:n.exhaust,raw:n.raw,read:n.read,connection:n.connection},o=function(r,i){n.connection=s.connection,n.state=Cursor.OPEN;if(r!=null&&i==null)return t(utils.toError(r),null);if(r==null&&(i==null||i.documents==null||!Array.isArray(i.documents)))return n.close(function(){t(new Error("command failed to return results"),null)});if(r==null&&i&&i.documents[0]&&i.documents[0].$err)return n.close(function(){t(utils.toError(i.documents[0].$err),null)});n.queryRun=!0,n.state=Cursor.OPEN,n.cursorId=i.cursorId,n.totalNumberOfRecords=i.numberReturned;for(var o=0;o<i.documents.length;o++)n.items.push(i.documents[o]);if(e.noReturn)return t(null,!0);n.exhaust&&i.cursorId.toString()=="0"?n.nextObject(t):(n.exhaust==0||n.exhaust==null)&&n.nextObject(t)};if(n.connection==null)try{n.connection=n.db.serverConfig.checkoutReader(this.read),s.connection=n.connection}catch(i){return t(utils.toError(i),null)}n.db._executeQueryCommand(r,s,o),o=null}else if(n.items.length)t(null,n.items.shift());else{if(!n.cursorId.greaterThan(Long.fromInt(0)))return n.close(function(){t(null,null)});getMore(n,t)}};var getMore=function(e,t,n){var r=0;typeof t=="function"&&(n=t,t={});if(e.state==Cursor.GET_MORE)return n(null,null);e.state=Cursor.GET_MORE;if(!e.tailable&&e.limitValue>0){r=e.limitValue-e.totalNumberOfRecords;if(r<1){e.close(function(){n(null,null)});return}}try{var i=new GetMoreCommand(e.db,e.collectionName,limitRequest(e),e.cursorId),s={read:e.read,raw:e.raw,connection:e.connection};e.db._executeQueryCommand(i,s,function(r,i){var s;e.state=Cursor.OPEN;if(r!=null)return e.state=Cursor.CLOSED,n(utils.toError(r),null);if(!i||!i.documents)return e.state=Cursor.CLOSED,n(utils.toError("command failed to return results"),null);if((i.responseFlag&1<<1)!=0)return e.state=Cursor.CLOSED,n(utils.toError("QueryFailure flag set on getmore command"),null);try{var o=1===i.responseFlag&&i.cursorId.isZero();e.cursorId=i.cursorId,e.totalNumberOfRecords+=i.numberReturned;if(i.numberReturned>0){if(e.limitValue>0){var u=e.totalNumberOfRecords-e.limitValue;u>0&&i.documents.splice(-1*u,u)}e.currentNumberOfRetries=e.numberOfRetries;for(var a=0;a<i.documents.length;a++)e.items.push(i.documents[a]);t.noReturn?s=!0:s=e.items.shift()}else e.tailable&&!o&&e.awaitdata?(e.currentNumberOfRetries=e.currentNumberOfRetries-1,e.currentNumberOfRetries==0?e.close(function(){n(new Error("tailable cursor timed out"),null)}):getMore(e,n)):e.tailable&&!o?e.getMoreTimer=setTimeout(function(){getMore(e,n)},e.tailableRetryInterval):e.close(function(){n(null,null)});i=null}catch(r){n(utils.toError(r),null)}s!=null&&n(null,s)}),i=null}catch(o){e.state=Cursor.OPEN;var u=function(){n(utils.toError(o),null)};e.close(u),u=null}};Cursor.prototype.explain=function(e){var t=-1*Math.abs(this.limitValue),n=new Cursor(this.db,this.collection,this.selector,this.fields,{skip:this.skipValue,limit:t,sort:this.sortValue,hint:this.hint,explain:!0,snapshot:this.snapshot,timeout:this.timeout,tailable:this.tailable,batchSize:this.batchSizeValue,slaveOk:this.slaveOk,raw:this.raw,read:this.read,returnKey:this.returnKey,maxScan:this.maxScan,min:this.min,max:this.max,showDiskLoc:this.showDiskLoc,comment:this.comment,awaitdata:this.awaitdata,numberOfRetries:this.numberOfRetries,dbName:this.dbName});n.nextObject(function(t,r){if(t!=null)return e(utils.toError(t),null);n.close(function(t,n){if(t!=null)return e(utils.toError(t),null);e(null,r)})})},Cursor.prototype.stream=function(t){return new CursorStream(this,t)},Cursor.prototype.close=function(e){var t=this;this.getMoreTimer&&clearTimeout(this.getMoreTimer);if(this.cursorId instanceof Long&&this.cursorId.greaterThan(Long.fromInt(0)))try{var n=new KillCursorCommand(this.db,[this.cursorId]);this.db._executeQueryCommand(n,{read:t.read,raw:t.raw,connection:t.connection})}catch(r){}return t.connection=null,this.cursorId=Long.fromInt(0),this.state=Cursor.CLOSED,e&&(e(null,t),t.items=[]),this},Cursor.prototype.isClosed=function(){return this.state==Cursor.CLOSED?!0:!1},Cursor.INIT=0,Cursor.OPEN=1,Cursor.CLOSED=2,Cursor.GET_MORE=3,exports.Cursor=Cursor;