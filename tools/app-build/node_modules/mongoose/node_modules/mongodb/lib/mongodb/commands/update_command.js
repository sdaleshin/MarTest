var BaseCommand=require("./base_command").BaseCommand,inherits=require("util").inherits,UpdateCommand=exports.UpdateCommand=function(e,t,n,r,i){BaseCommand.call(this);var s=n;if(Buffer.isBuffer(s)){var o=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(o!=s.length){var u=new Error("update spec raw message size does not match message header size ["+s.length+"] != ["+o+"]");throw u.name="MongoError",u}}var s=r;if(Buffer.isBuffer(s)){var o=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(o!=s.length){var u=new Error("update document raw message size does not match message header size ["+s.length+"] != ["+o+"]");throw u.name="MongoError",u}}this.collectionName=t,this.spec=n,this.document=r,this.db=e,this.serializeFunctions=!1,this.checkKeys=typeof i.checkKeys!="boolean"?!1:i.checkKeys;var a=0,f=0;a=i!=null&&i["upsert"]!=null?i["upsert"]==1?1:0:a,f=i!=null&&i["multi"]!=null?i["multi"]==1?1:0:f,this.flags=parseInt(f.toString()+a.toString(),2),i["serializeFunctions"]!=null&&i.serializeFunctions&&(this.serializeFunctions=!0)};inherits(UpdateCommand,BaseCommand),UpdateCommand.OP_UPDATE=2001,UpdateCommand.prototype.toBinary=function(e){if(!~this.collectionName.indexOf("\0")){var t=4+Buffer.byteLength(this.collectionName)+1+4+this.db.bson.calculateObjectSize(this.spec,!1,!0)+this.db.bson.calculateObjectSize(this.document,this.serializeFunctions,!0)+16;if(!e.disableDriverBSONSizeCheck&&t>e.maxBsonSize)throw new Error("Document exceeds maximum allowed bson size of "+e.maxBsonSize+" bytes");if(e.disableDriverBSONSizeCheck&&t>e.maxMessageSizeBytes)throw new Error("Command exceeds maximum message size of "+e.maxMessageSizeBytes+" bytes");var n=0,r=new Buffer(t);r[n+3]=t>>24&255,r[n+2]=t>>16&255,r[n+1]=t>>8&255,r[n]=t&255,n+=4,r[n+3]=this.requestId>>24&255,r[n+2]=this.requestId>>16&255,r[n+1]=this.requestId>>8&255,r[n]=this.requestId&255,n+=4,r[n++]=0,r[n++]=0,r[n++]=0,r[n++]=0,r[n+3]=UpdateCommand.OP_UPDATE>>24&255,r[n+2]=UpdateCommand.OP_UPDATE>>16&255,r[n+1]=UpdateCommand.OP_UPDATE>>8&255,r[n]=UpdateCommand.OP_UPDATE&255,n+=4,r[n++]=0,r[n++]=0,r[n++]=0,r[n++]=0,n=n+r.write(this.collectionName,n,"utf8")+1,r[n-1]=0,r[n+3]=this.flags>>24&255,r[n+2]=this.flags>>16&255,r[n+1]=this.flags>>8&255,r[n]=this.flags&255,n+=4;var i=0,s=this.spec;if(Buffer.isBuffer(s)){var o=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(o!=s.length)throw new Error("raw message size does not match message header size ["+s.length+"] != ["+o+"]");i=s.length,s.copy(r,n)}else i=this.db.bson.serializeWithBufferAndIndex(s,this.checkKeys,r,n,!1)-n+1;r[n+3]=i>>24&255,r[n+2]=i>>16&255,r[n+1]=i>>8&255,r[n]=i&255,n+=i,r[n-1]=0;var i=0,s=this.document;if(Buffer.isBuffer(s)){var o=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(o!=s.length)throw new Error("raw message size does not match message header size ["+s.length+"] != ["+o+"]");i=s.length,s.copy(r,n)}else i=this.db.bson.serializeWithBufferAndIndex(s,!1,r,n,this.serializeFunctions)-n+1;return r[n+3]=i>>24&255,r[n+2]=i>>16&255,r[n+1]=i>>8&255,r[n]=i&255,n+=i,r[n-1]=0,r}throw new Error("namespace cannot contain a null character")},UpdateCommand.DB_UPSERT=0,UpdateCommand.DB_MULTI_UPDATE=1;