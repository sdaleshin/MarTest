var fs=require("fs"),ReadPreference=require("./read_preference").ReadPreference;exports.parse=function(e,t){t=t||{};var n="",r="",i="",s="admin";if(e.indexOf("mongodb://")!=0)throw Error("URL must be in the format mongodb://user:pass@host:port/dbname");e.indexOf("?")!=-1?(i=e.substr(e.indexOf("?")+1),n=e.substring("mongodb://".length,e.indexOf("?"))):n=e.substring("mongodb://".length),n.indexOf("@")!=-1&&(r=n.split("@")[0],n=n.split("@")[1]),n.indexOf(".sock")!=-1?n.indexOf(".sock/")!=-1&&(s=n.split(".sock/")[1],n=n.split("/",n.indexOf(".sock")+".sock".length)):n.indexOf("/")!=-1&&(s=n.split("/")[1],n=n.split("/")[0]);var o={},u=r||"",a=u.split(":",2);t.uri_decode_auth&&(a[0]=decodeURIComponent(a[0]),a[1]&&(a[1]=decodeURIComponent(a[1]))),a.length==2&&(o.auth={user:a[0],password:a[1]});var f,l,c,h={socketOptions:{}},p={read_preference_tags:[]},d={socketOptions:{}};o.server_options=h,o.db_options=p,o.rs_options=d,o.mongos_options={};if(e.match(/\.sock/)){var v=e.substring(e.indexOf("mongodb://")+"mongodb://".length,e.lastIndexOf(".sock")+".sock".length);v.indexOf("@")!=-1&&(v=v.split("@")[1]),c=[{domain_socket:v}]}else f=n,c=f.split(",").map(function(e){var t=e.split(":",2),n=t[0]||"localhost",r=t[1]!=null?parseInt(t[1],10):27017;return n.indexOf("?")!=-1&&(n=n.split(/\?/)[0]),{host:n,port:r}});o.dbName=s||"admin",l=(i||"").split(/[&;]/),l.forEach(function(e){if(!e)return;var t=e.split("="),n=t[0],r=t[1];switch(n){case"slaveOk":case"slave_ok":h.slave_ok=r=="true",p.slaveOk=r=="true";break;case"maxPoolSize":case"poolSize":h.poolSize=parseInt(r,10),d.poolSize=parseInt(r,10);break;case"autoReconnect":case"auto_reconnect":h.auto_reconnect=r=="true";break;case"minPoolSize":throw new Error("minPoolSize not supported");case"maxIdleTimeMS":throw new Error("maxIdleTimeMS not supported");case"waitQueueMultiple":throw new Error("waitQueueMultiple not supported");case"waitQueueTimeoutMS":throw new Error("waitQueueTimeoutMS not supported");case"uuidRepresentation":throw new Error("uuidRepresentation not supported");case"ssl":if(r=="prefer"){h.ssl=r,d.ssl=r;break}h.ssl=r=="true",d.ssl=r=="true";break;case"replicaSet":case"rs_name":d.rs_name=r;break;case"reconnectWait":d.reconnectWait=parseInt(r,10);break;case"retries":d.retries=parseInt(r,10);break;case"readSecondary":case"read_secondary":d.read_secondary=r=="true";break;case"fsync":p.fsync=r=="true";break;case"journal":p.journal=r=="true";break;case"safe":p.safe=r=="true";break;case"nativeParser":case"native_parser":p.native_parser=r=="true";break;case"connectTimeoutMS":h.socketOptions.connectTimeoutMS=parseInt(r,10),d.socketOptions.connectTimeoutMS=parseInt(r,10);break;case"socketTimeoutMS":h.socketOptions.socketTimeoutMS=parseInt(r,10),d.socketOptions.socketTimeoutMS=parseInt(r,10);break;case"w":p.w=parseInt(r,10);break;case"authSource":p.authSource=r;break;case"gssapiServiceName":p.gssapiServiceName=r;break;case"authMechanism":if(r=="GSSAPI")if(o.auth==null){var i=decodeURIComponent(u);if(i.indexOf("@")==-1)throw new Error("GSSAPI requires a provided principal");o.auth={user:i,password:null}}else o.auth.user=decodeURIComponent(o.auth.user);if(r!="GSSAPI"&&r!="MONGODB-CR"&&r!="PLAIN")throw new Error("only GSSAPI, PLAIN or MONGODB-CR is supported by authMechanism");p.authMechanism=r;break;case"wtimeoutMS":p.wtimeoutMS=parseInt(r,10);break;case"readPreference":if(!ReadPreference.isValid(r))throw new Error("readPreference must be either primary/primaryPreferred/secondary/secondaryPreferred/nearest");p.read_preference=r;break;case"readPreferenceTags":var s={};if(r==null||r==""){p.read_preference_tags.push(s);break}var a=r.split(/\,/);for(var f=0;f<a.length;f++){var l=a[f].trim().split(/\:/);s[l[0]]=l[1]}p.read_preference_tags.push(s);break;default:}}),p.read_preference_tags.length===0&&(p.read_preference_tags=null);if(p.w!=-1&&p.w!=0||p.journal!=1&&p.fsync!=1&&p.safe!=1)return p.read_preference||(p.read_preference="primary"),o.servers=c,o;throw new Error("w set to -1 or 0 cannot be combined with safe/w/journal/fsync")};