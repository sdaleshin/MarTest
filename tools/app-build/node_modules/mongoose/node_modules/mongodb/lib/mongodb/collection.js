function Collection(e,t,n,r){if(!(this instanceof Collection))return new Collection(e,t,n,r);checkCollectionName(t),this.db=e,this.collectionName=t,this.internalHint=null,this.opts=r!=null&&"object"==typeof r?r:{},this.slaveOk=r==null||r.slaveOk==null?e.slaveOk:r.slaveOk,this.serializeFunctions=r==null||r.serializeFunctions==null?e.serializeFunctions:r.serializeFunctions,this.raw=r==null||r.raw==null?e.raw:r.raw,this.readPreference=r==null||r.readPreference==null?e.serverConfig.options.readPreference:r.readPreference,this.readPreference=this.readPreference==null?"primary":this.readPreference,this.pkFactory=n==null?ObjectID:n;var i=this}function processScope(e){if(!utils.isObject(e))return e;var t=Object.keys(e),n=t.length,r;while(n--)r=t[n],"function"==typeof e[r]&&(e[r]=new Code(String(e[r])));return e}var InsertCommand=require("./commands/insert_command").InsertCommand,QueryCommand=require("./commands/query_command").QueryCommand,DeleteCommand=require("./commands/delete_command").DeleteCommand,UpdateCommand=require("./commands/update_command").UpdateCommand,DbCommand=require("./commands/db_command").DbCommand,ObjectID=require("bson").ObjectID,Code=require("bson").Code,Cursor=require("./cursor").Cursor,utils=require("./utils");const eErrorMessages=/No matching object found/;var toString=Object.prototype.toString;Collection.prototype.insert=function(t,n,r){"function"==typeof n&&(r=n,n={}),n==null&&(n={}),"function"!=typeof r&&(r=null);var i=this;return insertAll(i,Array.isArray(t)?t:[t],n,r),this};var checkCollectionName=function(t){if("string"!=typeof t)throw Error("collection name must be a String");if(!t||t.indexOf("..")!=-1)throw Error("collection names cannot be empty");if(t.indexOf("$")!=-1&&t.match(/((^\$cmd)|(oplog\.\$main))/)==null)throw Error("collection names must not contain '$'");if(t.match(/^\.|\.$/)!=null)throw Error("collection names must not start or end with '.'");if(!!~t.indexOf("\0"))throw new Error("collection names cannot contain a null character")};Collection.prototype.remove=function(t,n,r){"function"==typeof t?(r=t,t=n={}):"function"==typeof n&&(r=n,n={}),n==null&&(n={}),"function"!=typeof r&&(r=null),t=t==null?{}:t;var i=0|(n.single?1:0),s=n.dbName;s==null&&(s=this.db.databaseName);var o=new DeleteCommand(this.db,s+"."+this.collectionName,t,i),u=this,a=_getWriteConcern(u,n,r);if(!_hasWriteConcern(a)||typeof r!="function"){if(_hasWriteConcern(a)&&r==null)throw new Error("Cannot use a writeConcern without a provided callback");var h=this.db._executeRemoveCommand(o);if(!r)return;return h instanceof Error?r(h):r()}var f={read:!1};a==null&&(f.async=!0),f.safe=!0;if(typeof a=="object"){var l=Object.keys(a);for(var c=0;c<l.length;c++)f[l[c]]=a[l[c]]}this.db._executeRemoveCommand(o,f,function(e,t){t=t&&t.documents;if(!r)return;e?r(e):t[0].err||t[0].errmsg?r(utils.toError(t[0])):r(null,t[0].n)})},Collection.prototype.rename=function(t,n,r){var i=this;typeof n=="function"&&(r=n,n={}),checkCollectionName(t),i.db._executeQueryCommand(DbCommand.createRenameCollectionCommand(i.db,i.collectionName,t,n),utils.handleSingleCommandResultReturn(!0,!1,function(e,s){if(e)return r(e,null);try{if(n.new_collection)return r(null,new Collection(i.db,t,i.db.pkFactory));i.collectionName=t,r(null,i)}catch(e){r(e,null)}}))};var insertAll=function(t,n,r,i){"function"==typeof r&&(i=r,r={}),r==null&&(r={}),"function"!=typeof i&&(i=null);var s={};r["keepGoing"]!=null&&(s.keepGoing=r.keepGoing),r["continueOnError"]!=null&&(s.continueOnError=r.continueOnError);var o=r.dbName;o==null&&(o=t.db.databaseName),r["serializeFunctions"]!=null?s.serializeFunctions=r.serializeFunctions:s.serializeFunctions=t.serializeFunctions;var u=typeof r.checkKeys!="boolean"?!0:r.checkKeys,a=new InsertCommand(t.db,o+"."+t.collectionName,u,s);for(var f=0,l=n.length;f<l;++f){var c=n[f];!Buffer.isBuffer(c)&&c["_id"]==null&&t.db.forceServerObjectId!=1&&r.forceServerObjectId!=1&&(c._id=t.pkFactory.createPk()),a.add(c)}var h=_getWriteConcern(t,r,i),p={};if(!_hasWriteConcern(h)||typeof i!="function"){if(_hasWriteConcern(h)&&i==null)throw new Error("Cannot use a writeConcern without a provided callback");var m=t.db._executeInsertCommand(a,p);if(!i)return;return m instanceof Error?i(m):i(null,n)}p.read=!1,h==null&&(p.async=!0),p.safe=h;if(typeof h=="object"){var d=Object.keys(h);for(var v=0;v<d.length;v++)p[d[v]]=h[d[v]]}t.db._executeInsertCommand(a,p,function(e,t){t=t&&t.documents;if(!i)return;e?i(e):t[0].err||t[0].errmsg?i(utils.toError(t[0])):i(null,n)})};Collection.prototype.save=function(t,n,r){"function"==typeof n&&(r=n,n=null),n==null&&(n={}),"function"!=typeof r&&(r=null);if(Array.isArray(t))throw new Error("doc parameter must be a single document");var i=t._id,s=_getWriteConcern(this,n,r);i?(s.upsert=!0,this.update({_id:i},t,s,r)):this.insert(t,s,r&&function(e,t){if(e)return r(e,null);Array.isArray(t)?r(e,t[0]):r(e,t)})},Collection.prototype.update=function(t,n,r,i){"function"==typeof r&&(i=r,r=null),r==null&&(r={}),"function"!=typeof i&&(i=null);var s=r.dbName;s==null&&(s=this.db.databaseName);if(t==null||typeof t!="object")return i(new Error("selector must be a valid JavaScript object"));if(n==null||typeof n!="object")return i(new Error("document must be a valid JavaScript object"));r["serializeFunctions"]!=null?r.serializeFunctions=r.serializeFunctions:r.serializeFunctions=this.serializeFunctions;var o=new UpdateCommand(this.db,s+"."+this.collectionName,t,n,r),u=this,a=_getWriteConcern(this,r,i);if(!_hasWriteConcern(a)||typeof i!="function"){if(_hasWriteConcern(a)&&i==null)throw new Error("Cannot use a writeConcern without a provided callback");var h=this.db._executeUpdateCommand(o);if(!i)return;return h instanceof Error?i(h):i()}var f={read:!1};a==null&&(f.async=!0),f.safe=a;if(typeof a=="object"){var l=Object.keys(a);for(var c=0;c<l.length;c++)f[l[c]]=a[l[c]]}this.db._executeUpdateCommand(o,f,function(e,t){t=t&&t.documents;if(!i)return;e?i(e):t[0].err||t[0].errmsg?i(utils.toError(t[0])):i(null,t[0].n,t[0])})},Collection.prototype.distinct=function(t,n,r,i){var s=Array.prototype.slice.call(arguments,1);i=s.pop(),n=s.length?s.shift()||{}:{},r=s.length?s.shift()||{}:{};var o={distinct:this.collectionName,query:n,key:t},u=r.readPreference?r.readPreference:!1;this.db._executeQueryCommand(DbCommand.createDbSlaveOkCommand(this.db,o),{read:u},utils.handleSingleCommandResultReturn(null,null,function(e,t){if(e)return i(e,null);i(null,t.values)}))},Collection.prototype.count=function(t,n,r){var i=Array.prototype.slice.call(arguments,0);r=i.pop(),t=i.length?i.shift()||{}:{},n=i.length?i.shift()||{}:{};var s=n.skip,o=n.limit,u={count:this.collectionName,query:t,fields:null};typeof s=="number"&&(u.skip=s),typeof o=="number"&&(u.limit=o);var a=_getReadConcern(this,n);this.db._executeQueryCommand(DbCommand.createDbSlaveOkCommand(this.db,u),{read:a},utils.handleSingleCommandResultReturn(null,null,function(e,t){if(e)return r(e,null);if(t==null)return r(new Error("no result returned for count"),null);r(null,t.n)}))},Collection.prototype.drop=function(t){this.db.dropCollection(this.collectionName,t)},Collection.prototype.findAndModify=function(t,n,r,i,s){var o=Array.prototype.slice.call(arguments,1);s=o.pop(),n=o.length?o.shift()||[]:[],r=o.length?o.shift():null,i=o.length?o.shift()||{}:{};var u=this,a={findandmodify:this.collectionName,query:t,sort:utils.formattedOrderClause(n)};a.new=i.new?1:0,a.remove=i.remove?1:0,a.upsert=i.upsert?1:0,i.fields&&(a.fields=i.fields),r&&!i.remove&&(a.update=r),i["serializeFunctions"]!=null?i.serializeFunctions=i.serializeFunctions:i.serializeFunctions=this.serializeFunctions;var f=DbCommand.createDbCommand(this.db,a,i);this.db._executeQueryCommand(f,{read:!1},utils.handleSingleCommandResultReturn(null,null,function(e,t){return e?s(e,null):s(null,t.value,t)}))},Collection.prototype.findAndRemove=function(e,t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop(),t=i.length?i.shift()||[]:[],n=i.length?i.shift()||{}:{},n.remove=!0,this.findAndModify(e,t,null,n,r)};var testForFields={limit:1,sort:1,fields:1,skip:1,hint:1,explain:1,snapshot:1,timeout:1,tailable:1,tailableRetryInterval:1,numberOfRetries:1,awaitdata:1,exhaust:1,batchSize:1,returnKey:1,maxScan:1,min:1,max:1,showDiskLoc:1,comment:1,raw:1,readPreference:1,partial:1,read:1,dbName:1};Collection.prototype.find=function(){var t,n=Array.prototype.slice.call(arguments,0),r=typeof n[n.length-1]=="function",i=typeof n[0]=="function",s=r?n.pop():i?n.shift():null,o=n.length,u=o>=1?n[0]:{},a=o>=2?n[1]:undefined;o===1&&i&&(u={},t=n[0]);if(o===2&&!Array.isArray(a)){var f=Object.getOwnPropertyNames(a),l=!1;for(var c=0;c<f.length;c++)if(testForFields[f[c]]!=null){l=!0;break}l?(t=a,a=undefined):t={}}else if(o===2&&Array.isArray(a)&&!Array.isArray(a[0])){var h={};for(var c=0;c<a.length;c++)h[a[c]]=1;a=h}3===o&&(t=n[2]),u=u==null?{}:u;var p=u;if(Buffer.isBuffer(p)){var d=p[0]|p[1]<<8|p[2]<<16|p[3]<<24;if(d!=p.length){var v=new Error("query selector raw message size does not match message header size ["+p.length+"] != ["+d+"]");throw v.name="MongoError",v}}var p=a;if(Buffer.isBuffer(p)){var d=p[0]|p[1]<<8|p[2]<<16|p[3]<<24;if(d!=p.length){var v=new Error("query fields raw message size does not match message header size ["+p.length+"] != ["+d+"]");throw v.name="MongoError",v}}if(u instanceof ObjectID||u!=null&&u._bsontype=="ObjectID")u={_id:u};if(t&&t.fields&&!Buffer.isBuffer(t.fields)){a={};if(Array.isArray(t.fields))if(!t.fields.length)a._id=1;else for(var c=0,m=t.fields.length;c<m;c++)a[t.fields[c]]=1;else a=t.fields}t||(t={}),t.skip=o>3?n[2]:t.skip?t.skip:0,t.limit=o>3?n[3]:t.limit?t.limit:0,t.raw=t.raw!=null&&typeof t.raw=="boolean"?t.raw:this.raw,t.hint=t.hint!=null?normalizeHintField(t.hint):this.internalHint,t.timeout=o==5?n[4]:typeof t.timeout=="undefined"?undefined:t.timeout,t.slaveOk=t.slaveOk!=null?t.slaveOk:this.db.slaveOk;var g=t;g["read"]!=null&&(g.readPreference=g.read),g.read=g.readPreference?g.readPreference:this.readPreference;if(g.read=="secondary"||g.read=="secondaryOnly")t.slaveOk=!0;if(!s)return new Cursor(this.db,this,u,a,g);s(null,new Cursor(this.db,this,u,a,g))};var normalizeHintField=function(t){var n=null;if(typeof t=="string")n=t;else if(Array.isArray(t))n={},t.forEach(function(e){n[e]=1});else if(t!=null&&typeof t=="object"){n={};for(var r in t)n[r]=t[r]}return n};Collection.prototype.findOne=function(){var t=this,n=Array.prototype.slice.call(arguments,0),r=n.pop(),i=this.find.apply(this,n).limit(-1).batchSize(1);i.nextObject(function(e,t){if(e!=null)return r(utils.toError(e),null);r(null,t)})},Collection.prototype.createIndex=function(t,n,r){var i=Array.prototype.slice.call(arguments,1);r=i.pop(),n=i.length?i.shift()||{}:{},n=typeof r=="function"?n:r,n=n==null?{}:n;var s=_getWriteConcern(this,n,r);this.db.createIndex(this.collectionName,t,n,r)},Collection.prototype.ensureIndex=function(t,n,r){typeof r=="undefined"&&typeof n=="function"&&(r=n,n={}),n==null&&(n={}),this.db.ensureIndex(this.collectionName,t,n,r)},Collection.prototype.indexInformation=function(t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop(),t=r.length?r.shift()||{}:{},this.db.indexInformation(this.collectionName,t,n)},Collection.prototype.dropIndex=function(t,n){this.db.dropIndex(this.collectionName,t,n)},Collection.prototype.dropAllIndexes=function(t){this.db.dropIndex(this.collectionName,"*",function(e,n){if(e)return t(e,!1);t(null,!0)})},Collection.prototype.dropIndexes=Collection.prototype.dropAllIndexes,Collection.prototype.reIndex=function(e){this.db.reIndex(this.collectionName,e)},Collection.prototype.mapReduce=function(t,n,r,i){"function"==typeof r&&(i=r,r={});if(null==r.out)throw new Error("the out option parameter must be defined, see mongodb docs for possible values");"function"==typeof t&&(t=t.toString()),"function"==typeof n&&(n=n.toString()),"function"==typeof r.finalize&&(r.finalize=r.finalize.toString());var s={mapreduce:this.collectionName,map:t,reduce:n};for(var o in r)"scope"==o?s[o]=processScope(r[o]):s[o]=r[o];var u=_getReadConcern(this,r);if(u!=0&&u!="primary"&&r.out&&r["out"].inline!=1&&r["out"]!="inline")throw new Error("a readPreference can only be provided when performing an inline mapReduce");var a=this,f=DbCommand.createDbCommand(this.db,s);this.db._executeQueryCommand(f,{read:u},function(e,t){if(e)return i(e);if(!t||!t.documents||t.documents.length==0)return i(Error("command failed to return results"),null);if(1!=t.documents[0].ok||t.documents[0].err||t.documents[0].errmsg)return i(utils.toError(t.documents[0]));var n={};t.documents[0].timeMillis&&(n.processtime=t.documents[0].timeMillis),t.documents[0].counts&&(n.counts=t.documents[0].counts),t.documents[0].timing&&(n.timing=t.documents[0].timing);if(t.documents[0].results)return i(null,t.documents[0].results,n);var s=null;if(t.documents[0].result!=null&&typeof t.documents[0].result=="object"){var o=t.documents[0].result;s=a.db.db(o.db).collection(o.collection)}else s=a.db.collection(t.documents[0].result);if(r["verbose"]==null||!r.verbose)return i(e,s);i(e,s,n)})};var groupFunction=function(){var e=db[ns].find(condition),t=new Map,n=reduce;while(e.hasNext()){var r=e.next(),i={};for(var s=0,o=keys.length;s<o;++s){var u=keys[s];i[u]=r[u]}var a=t.get(i);if(a==null){var f=Object.extend({},i);a=Object.extend(f,initial),t.put(i,a)}n(r,a)}return{result:t.values()}}.toString();Collection.prototype.group=function(t,n,r,i,s,o,u,a){var f=Array.prototype.slice.call(arguments,3);a=f.pop(),i=f.length?f.shift():null,s=f.length?f.shift():null,o=f.length?f.shift():null,u=f.length?f.shift()||{}:{},typeof s!="function"&&(o=s,s=null),!Array.isArray(t)&&t instanceof Object&&typeof t!="function"&&!(t instanceof Code)&&(t=Object.keys(t)),typeof i=="function"&&(i=i.toString()),typeof s=="function"&&(s=s.toString()),o=o==null?!0:o;if(o){var l=i instanceof Code?i:new Code(i),c={group:{ns:this.collectionName,$reduce:l,cond:n,initial:r,out:"inline"}};s!=null&&(c.group.finalize=s);if("function"==typeof t||t instanceof Code)c.group.$keyf=t instanceof Code?t:new Code(t);else{var h={};t.forEach(function(e){h[e]=1}),c.group.key=h}var p=DbCommand.createDbSlaveOkCommand(this.db,c),d=_getReadConcern(this,u);this.db._executeQueryCommand(p,{read:d},utils.handleSingleCommandResultReturn(null,null,function(e,t){if(e)return a(e,null);a(null,t.retval)}))}else{var v=i!=null&&i instanceof Code?i.scope:{};v.ns=this.collectionName,v.keys=t,v.condition=n,v.initial=r;var m=groupFunction.replace(/ reduce;/,i.toString()+";");this.db.eval(new Code(m,v),function(e,t){if(e)return a(e,null);a(null,t.result||t)})}},Collection.prototype.options=function(t){this.db.collectionsInfo(this.collectionName,function(e,n){if(e)return t(e);n.nextObject(function(e,n){t(e,n&&n.options||null)})})},Collection.prototype.isCapped=function(t){this.options(function(e,n){e!=null?t(e):t(null,n&&n.capped)})},Collection.prototype.indexExists=function(t,n){this.indexInformation(function(e,r){if(e!=null)return n(e,null);if(Array.isArray(t)){for(var i=0;i<t.length;i++)if(r[t[i]]==null)return n(null,!1);return n(null,!0)}return n(null,r[t]!=null)})},Collection.prototype.geoNear=function(t,n,r,i){var s=Array.prototype.slice.call(arguments,2);i=s.pop(),r=s.length?s.shift()||{}:{};var o={geoNear:this.collectionName,near:[t,n]};r["num"]!=null&&(o.num=r.num),r["maxDistance"]!=null&&(o.maxDistance=r.maxDistance),r["distanceMultiplier"]!=null&&(o.distanceMultiplier=r.distanceMultiplier),r["query"]!=null&&(o.query=r.query),r["spherical"]!=null&&(o.spherical=r.spherical),r["uniqueDocs"]!=null&&(o.uniqueDocs=r.uniqueDocs),r["includeLocs"]!=null&&(o.includeLocs=r.includeLocs),r.readPreference=_getReadConcern(this,r),this.db.command(o,r,function(e,t){e?i(e):t.err||t.errmsg?i(utils.toError(t)):i(null,t)})},Collection.prototype.geoHaystackSearch=function(t,n,r,i){var s=Array.prototype.slice.call(arguments,2);i=s.pop(),r=s.length?s.shift()||{}:{};var o={geoSearch:this.collectionName,near:[t,n]};r["maxDistance"]!=null&&(o.maxDistance=r.maxDistance),r["query"]!=null&&(o.search=r.query),r["search"]!=null&&(o.search=r.search),r["limit"]!=null&&(o.limit=r.limit),r.readPreference=_getReadConcern(this,r),this.db.command(o,r,function(e,t){e?i(e):t.err||t.errmsg?i(utils.toError(t)):i(null,t)})},Collection.prototype.indexes=function(t){this.db.indexInformation(this.collectionName,{full:!0},t)},Collection.prototype.aggregate=function(e,t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop();var i=this,s=r[r.length-1];t=s.readPreference||s.explain?r.pop():{};if(!Array.isArray(r[0])){e=[];for(var o=0;o<r.length;o++)e.push(r[o])}var u={aggregate:this.collectionName,pipeline:e};t.readPreference=_getReadConcern(this,t),this.db.command(u,t,function(e,t){e?n(e):t.err||t.errmsg?n(utils.toError(t)):typeof t=="object"&&t.serverPipeline?n(null,t):n(null,t.result)})},Collection.prototype.stats=function(t,n){var r=Array.prototype.slice.call(arguments,0);n=r.pop(),t=r.length?r.shift()||{}:{};var i={collStats:this.collectionName};t["scale"]!=null&&(i.scale=t.scale),t.readPreference=_getReadConcern(this,t),this.db.command(i,t,n)},Object.defineProperty(Collection.prototype,"hint",{enumerable:!0,get:function(){return this.internalHint},set:function(e){this.internalHint=normalizeHintField(e)}});var _getReadConcern=function(e,t){return t.readPreference?t.readPreference:e.readPreference?e.readPreference:e.db.readPreference?e.readPreference:"primary"},_hasWriteConcern=function(e){return e==1||e.w>0||e.w=="majority"||e.j==1||e.journal==1||e.fsync==1},_setWriteConcernHash=function(e){var t={};return e.w!=null&&(t.w=e.w),e.journal==1&&(t.j=e.journal),e.j==1&&(t.j=e.j),e.fsync==1&&(t.fsync=e.fsync),e.wtimeout!=null&&(t.wtimeout=e.wtimeout),t},_getWriteConcern=function(e,t,n){var r={w:1};t.w!=null||typeof t.j=="boolean"||typeof t.journal=="boolean"||typeof t.fsync=="boolean"?r=_setWriteConcernHash(t):typeof t.safe=="boolean"?r={w:t.safe?1:0}:t.safe!=null&&typeof t.safe=="object"?r=_setWriteConcernHash(t.safe):e.opts.w!=null||typeof e.opts.j=="boolean"||typeof e.opts.journal=="boolean"||typeof e.opts.fsync=="boolean"?r=_setWriteConcernHash(e.opts):typeof e.opts.safe=="boolean"?r={w:e.opts.safe?1:0}:e.db.safe.w!=null||typeof e.db.safe.j=="boolean"||typeof e.db.safe.journal=="boolean"||typeof e.db.safe.fsync=="boolean"?r=_setWriteConcernHash(e.db.safe):e.db.options.w!=null||typeof e.db.options.j=="boolean"||typeof e.db.options.journal=="boolean"||typeof e.db.options.fsync=="boolean"?r=_setWriteConcernHash(e.db.options):typeof e.db.safe=="boolean"&&(r={w:e.db.safe?1:0});if(r.w<1&&(r.journal==1||r.j==1||r.fsync==1))throw new Error("No acknowlegement using w < 1 cannot be combined with journal:true or fsync:true");return r};exports.Collection=Collection;