var format=require("util").format,MongoAuthProcess=function(e,t,n){process.platform=="win32"?this._processor=new Win32MongoProcessor(e,t,n):this._processor=new UnixMongoProcessor(e,t,n)};MongoAuthProcess.prototype.init=function(e,t,n){this._processor.init(e,t,n)},MongoAuthProcess.prototype.transition=function(e,t){this._processor.transition(e,t)};var Win32MongoProcessor=function(e,t,n){this.host=e,this.port=t,this.ssip=require("../kerberos").SSIP,this._transition=Win32MongoProcessor.first_transition(this),n=n||"mongodb",this.target=format("%s/%s",n,e),this.retries=10};Win32MongoProcessor.prototype.init=function(e,t,n){var r=this;this.username=e,this.password=t,this.ssip.SecurityCredentials.aquire_kerberos(e,t,function(e,t){if(e)return n(e);r.security_credentials=t,n(null)})},Win32MongoProcessor.prototype.transition=function(e,t){if(this._transition==null)return t(new Error("Transition finished"));this._transition(e,t)},Win32MongoProcessor.first_transition=function(e){return function(t,n){e.ssip.SecurityContext.initialize(e.security_credentials,e.target,t,function(r,i){if(r)return n(r);if(!i.hasContext)return e.retries==0?n(new Error("Failed to initialize security context")):(e.retries=e.retries-1,e.transition(t,n));e._transition=Win32MongoProcessor.second_transition(e),e.security_context=i,n(null,i.payload)})}},Win32MongoProcessor.second_transition=function(e){return function(t,n){e.security_context.initialize(e.target,t,function(r,i){if(r)return n(r);if(!i.hasContext)return e.retries==0?n(new Error("Failed to initialize security context")):(e.retries=e.retries-1,e._transition=Win32MongoProcessor.first_transition(e),e.transition(t,n));e._transition=Win32MongoProcessor.third_transition(e),n(null,i.payload)})}},Win32MongoProcessor.third_transition=function(e){return function(t,n){var r=0,i=new Buffer(t,"base64"),s=new Buffer(r);i.copy(s,0,0,r);var o=i.length-r,u=new Buffer(o);i.copy(u,0,r,o);var a=e.ssip.SecurityBuffer,f=e.ssip.SecurityBufferDescriptor,l=[new a(a.DATA,i),new a(a.STREAM,u)],c=new f(l);e.security_context.decryptMessage(c,function(t,r){if(t)return n(t);var i=4;e.username!=null&&(i+=e.username.length);var s=new Buffer(i);s[0]=1,s[1]=0,s[2]=0,s[3]=0;if(e.username!=null){var o=new Buffer(e.username,"utf8");o.copy(s,4,0)}e.security_context.queryContextAttributes(0,function(t,r){if(t)return n(t);var i=[new a(a.TOKEN,new Buffer(r.securityTrailer)),new a(a.DATA,s),new a(a.PADDING,new Buffer(r.blockSize))],o=new f(i);e.security_context.encryptMessage(o,2147483649,function(e,t){if(e)return n(e);n(null,t.payload)})})})}};var UnixMongoProcessor=function(e,t,n){this.host=e,this.port=t,this.Kerberos=require("../kerberos").Kerberos,this.kerberos=new this.Kerberos,n=n||"mongodb",this._transition=UnixMongoProcessor.first_transition(this),this.target=format("%s@%s",n,e),this.retries=10};UnixMongoProcessor.prototype.init=function(e,t,n){var r=this;this.username=e,this.password=t,this.kerberos.authGSSClientInit(r.target,this.Kerberos.GSS_C_MUTUAL_FLAG,function(e,t){r.context=t,n(null,t)})},UnixMongoProcessor.prototype.transition=function(e,t){if(this._transition==null)return t(new Error("Transition finished"));this._transition(e,t)},UnixMongoProcessor.first_transition=function(e){return function(t,n){e.kerberos.authGSSClientStep(e.context,"",function(t,r){if(t)return n(t);e._transition=UnixMongoProcessor.second_transition(e),n(null,e.context.response)})}},UnixMongoProcessor.second_transition=function(e){return function(t,n){e.kerberos.authGSSClientStep(e.context,t,function(r,i){if(r&&e.retries==0)return n(r);if(r)return e.retries=e.retries-1,e.transition(t,n);e._transition=UnixMongoProcessor.third_transition(e),n(null,e.context.response||"")})}},UnixMongoProcessor.third_transition=function(e){return function(t,n){e.kerberos.authGSSClientUnwrap(e.context,t,function(t,r){if(t)return n(t,!1);e.kerberos.authGSSClientWrap(e.context,e.context.response,e.username,function(t,r){if(t)return n(t,!1);e._transition=UnixMongoProcessor.fourth_transition(e),n(null,e.context.response)})})}},UnixMongoProcessor.fourth_transition=function(e){return function(t,n){e.kerberos.authGSSClientClean(e.context,function(t,r){if(t)return n(t,!1);e._transition=null,n(null,!0)})}},exports.MongoAuthProcess=MongoAuthProcess;