/*!
 * gt, gte, lt, lte, ne, in, nin, all, regex, size, maxDistance
 *
 *     Thing.where('type').nin(array)
 */

/*!
 * @ignore
 */

/*!
 * limit, skip, maxScan, batchSize, comment
 *
 * Sets these associated options.
 *
 *     query.comment('feed query');
 */

/*!
 * Permissions
 */

/*!
 * Exports.
 */

function Query(e,t){if(!(this instanceof Query))return new Query(e,t);var n=this.constructor.prototype;this.op=n.op||undefined,this.options={},this.setOptions(n.options),this._conditions=n._conditions?utils.clone(n._conditions):{},this._fields=n._fields?utils.clone(n._fields):undefined,this._update=n._update?utils.clone(n._update):undefined,this._path=n._path||undefined,this._distinct=n._distinct||undefined,this._collection=n._collection||undefined,t&&this.setOptions(t),e&&(e.find&&e.remove&&e.update?this.collection(e):this.find(e))}function push(e,t,n){var r=String(n||1).toLowerCase();if(!/^(?:ascending|asc|descending|desc|1|-1)$/.test(r))throw utils.isArray(n)&&(n="["+n+"]"),new TypeError("Invalid sort value: {"+t+": "+n+" }");var i=e.sort||(e.sort={}),s=n.toString().replace("asc","1").replace("ascending","1").replace("desc","-1").replace("descending","-1");i[t]=parseInt(s)}var slice=require("sliced"),assert=require("assert"),util=require("util"),utils=require("./utils"),debug=require("debug")("mquery"),$withinCmd="$geoWithin";Object.defineProperty(Query,"use$geoWithin",{get:function(){return $withinCmd=="$geoWithin"},set:function(e){!0===e?$withinCmd="$geoWithin":$withinCmd="$within"}}),Query.prototype.toConstructor=function(){function t(e,n){if(!(this instanceof t))return new t(e,n);Query.call(this,e,n)}utils.inherits(t,Query);var n=t.prototype;return n.options={},n.setOptions(this.options),n.op=this.op,n._conditions=utils.clone(this._conditions),n._fields=utils.clone(this._fields),n._update=utils.clone(this._update),n._path=this._path,n._distict=this._distinct,n._collection=this._collection,t},Query.prototype.setOptions=function(e){if(!e||!utils.isObject(e))return this;var t=utils.keys(e),n;for(var r=0;r<t.length;++r){n=t[r];if("function"==typeof this[n]){var i=utils.isArray(e[n])?e[n]:[e[n]];this[n].apply(this,i)}else this.options[n]=e[n]}return this},Query.prototype.collection=function(t){return this._collection=new Query.Collection(t),this},Query.prototype.$where=function(e){return this._conditions.$where=e,this},Query.prototype.where=function(){if(!arguments.length)return this;this.op||(this.op="find");var e=typeof arguments[0];if("string"==e)return this._path=arguments[0],2===arguments.length&&(this._conditions[this._path]=arguments[1]),this;if("object"==e&&!Array.isArray(arguments[0]))return this.merge(arguments[0]);throw new TypeError("path must be a string or object")},Query.prototype.equals=function(t){this._ensurePath("equals");var n=this._path;return this._conditions[n]=t,this},Query.prototype.or=function e(t){var e=this._conditions.$or||(this._conditions.$or=[]);return utils.isArray(t)||(t=[t]),e.push.apply(e,t),this},Query.prototype.nor=function t(e){var t=this._conditions.$nor||(this._conditions.$nor=[]);return utils.isArray(e)||(e=[e]),t.push.apply(t,e),this},Query.prototype.and=function n(e){var n=this._conditions.$and||(this._conditions.$and=[]);return Array.isArray(e)||(e=[e]),n.push.apply(n,e),this},"gt gte lt lte ne in nin all regex size maxDistance".split(" ").forEach(function(e){Query.prototype[e]=function(){var t,n;1===arguments.length?(this._ensurePath(e),n=arguments[0],t=this._path):(n=arguments[1],t=arguments[0]);var r=this._conditions[t]||(this._conditions[t]={});return r["$"+e]=n,this}}),Query.prototype.mod=function(){var e,t;1===arguments.length?(this._ensurePath("mod"),e=arguments[0],t=this._path):2===arguments.length&&!utils.isArray(arguments[1])?(this._ensurePath("mod"),e=slice(arguments),t=this._path):3===arguments.length?(e=slice(arguments,1),t=arguments[0]):(e=arguments[1],t=arguments[0]);var n=this._conditions[t]||(this._conditions[t]={});return n.$mod=e,this},Query.prototype.exists=function(){var e,t;0===arguments.length?(this._ensurePath("exists"),e=this._path,t=!0):1===arguments.length?"boolean"==typeof arguments[0]?(this._ensurePath("exists"),e=this._path,t=arguments[0]):(e=arguments[0],t=!0):2===arguments.length&&(e=arguments[0],t=arguments[1]);var n=this._conditions[e]||(this._conditions[e]={});return n.$exists=t,this},Query.prototype.elemMatch=function(){if(null==arguments[0])throw new TypeError("Invalid argument");var e,t,n;if("function"==typeof arguments[0])this._ensurePath("elemMatch"),t=this._path,e=arguments[0];else if(utils.isObject(arguments[0]))this._ensurePath("elemMatch"),t=this._path,n=arguments[0];else if("function"==typeof arguments[1])t=arguments[0],e=arguments[1];else{if(!arguments[1]||!utils.isObject(arguments[1]))throw new TypeError("Invalid argument");t=arguments[0],n=arguments[1]}e&&(n=new Query,e(n),n=n._conditions);var r=this._conditions[t]||(this._conditions[t]={});return r.$elemMatch=n,this},Query.prototype.within=function(){this._ensurePath("within"),this._geoComparison=$withinCmd;if(0===arguments.length)return this;if(2===arguments.length)return this.box.apply(this,arguments);if(2<arguments.length)return this.polygon.apply(this,arguments);var t=arguments[0];if(!t)throw new TypeError("Invalid argument");if(t.center)return this.circle(t);if(t.box)return this.box.apply(this,t.box);if(t.polygon)return this.polygon.apply(this,t.polygon);if(t.type&&t.coordinates)return this.geometry(t);throw new TypeError("Invalid argument")},Query.prototype.box=function(){var e,t;if(3===arguments.length)e=arguments[0],t=[arguments[1],arguments[2]];else{if(2!==arguments.length)throw new TypeError("Invalid argument");this._ensurePath("box"),e=this._path,t=[arguments[0],arguments[1]]}var n=this._conditions[e]||(this._conditions[e]={});return n[this._geoComparison||$withinCmd]={$box:t},this},Query.prototype.polygon=function(){var e,t;"string"==typeof arguments[0]?(t=arguments[0],e=slice(arguments,1)):(this._ensurePath("polygon"),t=this._path,e=slice(arguments));var n=this._conditions[t]||(this._conditions[t]={});return n[this._geoComparison||$withinCmd]={$polygon:e},this},Query.prototype.circle=function(){var e,t;if(1===arguments.length)this._ensurePath("circle"),e=this._path,t=arguments[0];else{if(2!==arguments.length)throw new TypeError("Invalid argument");e=arguments[0],t=arguments[1]}if(!("radius"in t&&t.center))throw new Error("center and radius are required");var n=this._conditions[e]||(this._conditions[e]={}),r=t.spherical?"$centerSphere":"$center",i=this._geoComparison||$withinCmd;return n[i]={},n[i][r]=[t.center,t.radius],"unique"in t&&(n[i].$uniqueDocs=!!t.unique),this},Query.prototype.near=function(){var t,n;this._geoComparison="$near";if(0===arguments.length)return this;if(1===arguments.length)this._ensurePath("near"),t=this._path,n=arguments[0];else{if(2!==arguments.length)throw new TypeError("Invalid argument");t=arguments[0],n=arguments[1]}if(!n.center)throw new Error("center is required");var r=this._conditions[t]||(this._conditions[t]={}),i=n.spherical?"$nearSphere":"$near";if(Array.isArray(n.center))r[i]=n.center;else{if(n.center.type!="Point"||!Array.isArray(n.center.coordinates))throw new Error(util.format("Invalid GeoJSON specified for %s",i));r[i]={$geometry:n.center}}var s="maxDistance"in n?n.maxDistance:null;return null!=s&&(r.$maxDistance=s),this},Query.prototype.intersects=function(){this._ensurePath("intersects"),this._geoComparison="$geoIntersects";if(0===arguments.length)return this;var t=arguments[0];if(null!=t&&t.type&&t.coordinates)return this.geometry(t);throw new TypeError("Invalid argument")},Query.prototype.geometry=function(){if("$within"!=this._geoComparison&&"$geoWithin"!=this._geoComparison&&"$near"!=this._geoComparison&&"$geoIntersects"!=this._geoComparison)throw new Error("geometry() must come after `within()`, `intersects()`, or `near()");var t,n;if(1!==arguments.length)throw new TypeError("Invalid argument");this._ensurePath("geometry"),n=this._path,t=arguments[0];if(!t.type||!Array.isArray(t.coordinates))throw new TypeError("Invalid argument");var r=this._conditions[n]||(this._conditions[n]={});return r[this._geoComparison]={$geometry:t},this},Query.prototype.select=function(){var t=arguments[0];if(!t)return this;if(arguments.length!==1)throw new Error("Invalid select: select only takes 1 argument");this._validate("select");var n=this._fields||(this._fields={}),r=typeof t;if("string"==r||"object"==r&&"number"==typeof t.length&&!Array.isArray(t)){"string"==r&&(t=t.split(/\s+/));for(var i=0,s=t.length;i<s;++i){var o=t[i];if(!o)continue;var u="-"==o[0]?0:1;u===0&&(o=o.substring(1)),n[o]=u}return this}if(utils.isObject(t)&&!Array.isArray(t)){var a=utils.keys(t);for(var i=0;i<a.length;++i)n[a[i]]=t[a[i]];return this}throw new TypeError("Invalid select() argument. Must be string or object.")},Query.prototype.slice=function(){if(0===arguments.length)return this;this._validate("slice");var e,t;1===arguments.length?(this._ensurePath("slice"),e=this._path,t=arguments[0]):2===arguments.length?"number"==typeof arguments[0]?(this._ensurePath("slice"),e=this._path,t=slice(arguments)):(e=arguments[0],t=arguments[1]):3===arguments.length&&(e=arguments[0],t=slice(arguments,1));var n=this._fields||(this._fields={});return n[e]={$slice:t},this},Query.prototype.sort=function(e){if(!e)return this;this._validate("sort");var t=typeof e;if(1===arguments.length&&"string"==t){e=e.split(/\s+/);for(var n=0,r=e.length;n<r;++n){var i=e[n];if(!i)continue;var s="-"==i[0]?-1:1;s===-1&&(i=i.substring(1)),push(this.options,i,s)}return this}if(utils.isObject(e)){var o=utils.keys(e);for(var n=0;n<o.length;++n){var i=o[n];push(this.options,i,e[i])}return this}throw new TypeError("Invalid sort() argument. Must be a string or object.")},["limit","skip","maxScan","batchSize","comment"].forEach(function(e){Query.prototype[e]=function(t){return this._validate(e),this.options[e]=t,this}}),Query.prototype.snapshot=function(){return this._validate("snapshot"),this.options.snapshot=arguments.length?!!arguments[0]:!0,this},Query.prototype.hint=function(){if(0===arguments.length)return this;this._validate("hint");var e=arguments[0];if(utils.isObject(e)){var t=this.options.hint||(this.options.hint={});for(var n in e)t[n]=e[n];return this}throw new TypeError("Invalid hint. "+e)},Query.prototype.slaveOk=function(e){return this.options.slaveOk=arguments.length?!!e:!0,this},Query.prototype.read=function(e,t){return this.options.readPreference=utils.readPref(e,t),this},Query.prototype.tailable=function(){return this._validate("tailable"),this.options.tailable=arguments.length?!!arguments[0]:!0,this},Query.prototype.merge=function(e){if(!e)return this;if(!Query.canMerge(e))throw new TypeError("Invalid argument. Expected instanceof mquery or plain object");return e instanceof Query?(e._conditions&&utils.merge(this._conditions,e._conditions),e._fields&&(this._fields||(this._fields={}),utils.merge(this._fields,e._fields)),e.options&&(this.options||(this.options={}),utils.merge(this.options,e.options)),e._update&&(this._update||(this._update={}),utils.mergeClone(this._update,e._update)),e._distinct&&(this._distinct=e._distinct),this):(utils.merge(this._conditions,e),this)},Query.prototype.find=function(e,t){this.op="find","function"==typeof e?(t=e,e=undefined):Query.canMerge(e)&&this.merge(e);if(!t)return this;var n=this,r=this._conditions,i=this._optionsForExec();return i.fields=this._fieldsForExec(),debug("find",r,i),this._collection.find(r,i,utils.tick(t)),this},Query.prototype.findOne=function(e,t){this.op="findOne","function"==typeof e?(t=e,e=undefined):Query.canMerge(e)&&this.merge(e);if(!t)return this;var n=this,r=this._conditions,i=this._optionsForExec();return i.fields=this._fieldsForExec(),debug("findOne",r,i),this._collection.findOne(r,i,utils.tick(t)),this},Query.prototype.count=function(e,t){this.op="count",this._validate(),"function"==typeof e?(t=e,e=undefined):Query.canMerge(e)&&this.merge(e);if(!t)return this;var n=this._conditions,r=this._optionsForExec();return debug("count",n,r),this._collection.count(n,r,utils.tick(t)),this},Query.prototype.distinct=function(e,t,n){this.op="distinct",this._validate();if(!n){switch(typeof t){case"function":n=t,"string"==typeof e&&(t=e,e=undefined);break;case"undefined":case"string":break;default:throw new TypeError("Invalid `field` argument. Must be string or function")}switch(typeof e){case"function":n=e,e=t=undefined;break;case"string":t=e,e=undefined}}"string"==typeof t&&(this._distinct=t),Query.canMerge(e)&&this.merge(e);if(!n)return this;if(!this._distinct)throw new Error("No value for `distinct` has been declared");var r=this._conditions,i=this._optionsForExec();return debug("distinct",r,i),this._collection.distinct(this._distinct,r,i,utils.tick(n)),this},Query.prototype.update=function(t,n,r,i){this.op="update";var s;switch(arguments.length){case 3:"function"==typeof r&&(i=r,r=undefined);break;case 2:"function"==typeof n&&(i=n,n=t,t=undefined);break;case 1:switch(typeof t){case"function":i=t,t=r=n=undefined;break;case"boolean":s=t,t=undefined;break;default:n=t,t=r=undefined}}Query.canMerge(t)&&this.merge(t),n&&this._mergeUpdate(n),utils.isObject(r)&&this.setOptions(r);if(!s&&!i)return this;if(!this._update||!this.options.overwrite&&0===utils.keys(this._update).length)return i&&utils.soon(i.bind(null,null,0)),this;r=this._optionsForExec(),i||(r.safe=!1);var t=this._conditions;return n=this._updateForExec(),debug("update",t,n,r),this._collection.update(t,n,r,utils.tick(i)),this},Query.prototype.remove=function(e,t){this.op="remove";var n;"function"==typeof e?(t=e,e=undefined):Query.canMerge(e)?this.merge(e):!0===e&&(n=e,e=undefined);if(!n&&!t)return this;var r=this._optionsForExec();t||(r.safe=!1);var i=this._conditions;return debug("remove",i,r),this._collection.remove(i,r,utils.tick(t)),this},Query.prototype.findOneAndUpdate=function(e,t,n,r){this.op="findOneAndUpdate",this._validate();switch(arguments.length){case 3:"function"==typeof n&&(r=n,n={});break;case 2:"function"==typeof t&&(r=t,t=e,e=undefined),n=undefined;break;case 1:"function"==typeof e?(r=e,e=n=t=undefined):(t=e,e=n=undefined)}return Query.canMerge(e)&&this.merge(e),t&&this._mergeUpdate(t),n&&this.setOptions(n),r?this._findAndModify("update",r):this},Query.prototype.findOneAndRemove=function(e,t,n){return this.op="findOneAndRemove",this._validate(),"function"==typeof t?(n=t,t=undefined):"function"==typeof e&&(n=e,e=undefined),Query.canMerge(e)&&this.merge(e),t&&this.setOptions(t),n?this._findAndModify("remove",n):this},Query.prototype._findAndModify=function(e,t){assert.equal("function",typeof t);var n=this._optionsForExec(),r=this,i,s,o;if("remove"==e)n.remove=!0;else{"new"in n||(n.new=!0),"upsert"in n||(n.upsert=!1),o=this._updateForExec();if(!o){if(!n.upsert)return this.findOne(t);o={$set:{}}}}var i=this._fieldsForExec();i&&(n.fields=i);var u=this._conditions;return debug("findAndModify",u,o,n),this._collection.findAndModify(u,o,n,utils.tick(t)),this},Query.prototype.exec=function(t,n){switch(typeof t){case"function":n=t,t=null;break;case"string":this.op=t}assert.ok(this.op,"Missing query type: (find, update, etc)");if("update"==this.op||"remove"==this.op)n||(n=!0);this[this.op](n)},Query.prototype._mergeUpdate=function(e){this._update||(this._update={}),e instanceof Query?e._update&&utils.mergeClone(this._update,e._update):utils.mergeClone(this._update,e)},Query.prototype._optionsForExec=function(){var e=utils.clone(this.options,{retainKeyOrder:!0});return e},Query.prototype._fieldsForExec=function(){return utils.clone(this._fields)},Query.prototype._updateForExec=function(){var e=utils.clone(this._update,{retainKeyOrder:!0}),t=utils.keys(e),n=t.length,r={},i,s;while(n--){var o=t[n];if(this.options.overwrite){r[o]=e[o];continue}"$"!==o[0]?(r.$set||(e.$set?r.$set=e.$set:r.$set={}),r.$set[o]=e[o],t.splice(n,1),~t.indexOf("$set")||t.push("$set")):"$set"===o?r.$set||(r[o]=e[o]):r[o]=e[o]}return r},Query.prototype._ensurePath=function(e){if(!this._path){var t=e+"() must be used after where() "+"when called with these arguments";throw new Error(t)}},Query.permissions=require("./permissions"),Query._isPermitted=function(e,t){var n=Query.permissions[t];return n?!0!==n[e]:!0},Query.prototype._validate=function(e){var t,n;if(undefined===e){n=Query.permissions[this.op];if("function"!=typeof n)return!0;t=n(this)}else Query._isPermitted(e,this.op)||(t=e);if(t)throw new Error(t+" cannot be used with "+this.op)},Query.canMerge=function(e){return e instanceof Query||utils.isObject(e)},Query.utils=utils,Query.env=require("./env"),Query.Collection=require("./collection"),Query.BaseCollection=require("./collection/collection"),module.exports=exports=Query;