/*!
 * Module dependencies.
 */

/*!
 * event names
 */

/*!
 * Inherits from EventEmitter.
 */

/*!
 * Module exports.
 */

function Promise(e){this.emitted={},this.ended=!1,"function"==typeof e&&this.onResolve(e)}function handler(e,t){return function(){var r;try{r=t.apply(undefined,arguments)}catch(i){if(e.ended)throw i;return e.reject(i)}var s=typeof r;if("undefined"==s)return e.fulfill(r);resolve(e,r)}}function resolve(e,t){var n,r,i,s,o;if(null!=t){r=typeof t;if("object"==r||"function"==r){try{n=t.then}catch(u){if(e.ended)throw u;return e.reject(u)}if("function"==typeof n)try{return o=resolve.bind(this,e),s=e.reject.bind(e),i=!1,n.call(t,function(){if(i)return;return i=!0,o.apply(this,arguments)},function(){if(i)return;return i=!0,s.apply(this,arguments)})}catch(u){if(i)return;i=!0;if(e.ended)throw u;return e.reject(u)}}}e.fulfill(t)}var slice=require("sliced"),EventEmitter=require("events").EventEmitter,next="function"==typeof setImmediate?setImmediate:process.nextTick;Promise.SUCCESS="fulfill",Promise.FAILURE="reject",Promise.prototype.__proto__=EventEmitter.prototype,Promise.prototype.on=function(e,t){return this.emitted[e]?t.apply(this,this.emitted[e]):EventEmitter.prototype.on.call(this,e,t),this},Promise.prototype.emit=function(e){var t=this.constructor.SUCCESS,n=this.constructor.FAILURE;if(e==t||e==n){if(this.emitted[t]||this.emitted[n])return this;this.emitted[e]=slice(arguments,1)}return EventEmitter.prototype.emit.apply(this,arguments)},Promise.prototype.fulfill=function(){var e=slice(arguments);return this.emit.apply(this,[this.constructor.SUCCESS].concat(e))},Promise.prototype.reject=function(e){return this.emit(this.constructor.FAILURE,e)},Promise.prototype.resolve=function(e,t){return e?this.reject(e):this.fulfill(t)},Promise.prototype.onFulfill=function(e){return this.on(this.constructor.SUCCESS,e)},Promise.prototype.onReject=function(e){return this.on(this.constructor.FAILURE,e)},Promise.prototype.onResolve=function(e){return this.on(this.constructor.FAILURE,function(t){e.call(this,t)}),this.on(this.constructor.SUCCESS,function(){var t=slice(arguments);e.apply(this,[null].concat(t))}),this},Promise.prototype.then=function(e,t){var n=this,r=new Promise;return next(function(){"function"==typeof t?n.onReject(handler(r,t)):n.onReject(r.reject.bind(r)),"function"==typeof e?n.onFulfill(handler(r,e)):n.onFulfill(r.fulfill.bind(r))}),r},Promise.prototype.end=function(){this.ended=!0},module.exports=Promise;