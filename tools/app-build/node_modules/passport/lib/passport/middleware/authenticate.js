function augment(e,t,n){for(var r in t)e[r]=t[r].bind(n)}var util=require("util"),actions=require("../context/http/actions"),Context=require("../context/http/context");module.exports=function(t,n,r){return!r&&typeof n=="function"&&(r=n,n={}),n=n||{},Array.isArray(t)||(t=[t]),function(i,s,o){function f(){if(r){if(a.length==1)return r(null,!1,a[0].challenge,a[0].status);var e=a.map(function(e){return e.challenge}),t=a.map(function(e){return e.status});return r(null,!1,e,t)}var o=a[0]||{},u=o.challenge||{};if(n.failureFlash){var f=n.failureFlash;typeof f=="string"&&(f={type:"error",message:f}),f.type=f.type||"error";var l=f.type||u.type||"error",c=f.message||u.message||u;typeof c=="string"&&i.flash(l,c)}if(n.failureMessage){var c=n.failureMessage;typeof c=="boolean"&&(c=u.message||u),typeof c=="string"&&(i.session.messages=i.session.messages||[],i.session.messages.push(c))}if(n.failureRedirect)return s.redirect(n.failureRedirect);var h=[],p;for(var d=0,v=a.length;d<v;d++){var o=a[d],u=o.challenge||{},m=o.status;typeof u=="number"&&(m=u,u=null),p=p||m,typeof u=="string"&&h.push(u)}s.statusCode=p||401,h.length&&s.setHeader("WWW-Authenticate",h),s.end("Unauthorized")}var u=this,a=[];(function l(e){var c={};c.success=function(e,t){if(r)return r(null,e,t);t=t||{};if(n.successFlash){var a=n.successFlash;typeof a=="string"&&(a={type:"success",message:a}),a.type=a.type||"success";var f=a.type||t.type||"success",l=a.message||t.message||t;typeof l=="string"&&i.flash(f,l)}if(n.successMessage){var l=n.successMessage;typeof l=="boolean"&&(l=t.message||t),typeof l=="string"&&(i.session.messages=i.session.messages||[],i.session.messages.push(l))}if(n.assignProperty)return i[n.assignProperty]=e,o();i.logIn(e,n,function(e){function r(){if(n.successReturnToOrRedirect){var e=n.successReturnToOrRedirect;return i.session&&i.session.returnTo&&(e=i.session.returnTo,delete i.session.returnTo),s.redirect(e)}if(n.successRedirect)return s.redirect(n.successRedirect);o()}if(e)return o(e);n.authInfo||n.authInfo===undefined?u.transformAuthInfo(t,function(e,t){if(e)return o(e);i.authInfo=t,r()}):r()})},c.fail=function(t,n){a.push({challenge:t,status:n}),l(e+1)};var h=t[e];if(!h)return f();var p=u._strategy(h);if(!p)return o(new Error("no strategy registered under name: "+h));var d=Object.create(p),v=new Context(c,i,s,o);augment(d,actions,v),d.authenticate(i,n)})(0)}};