module.exports=function(e,t){var n=require("fs"),r=require("imagemagick"),i=t.models,s=t.db,o=require("base64-js"),u=i.User;e.get("/api/users",function(e,t){var n=e.query.skip,r=e.query.take,i=e.query.sort,s=e.query.filter;return u.find().select("Name Email Age Avatar").sort(i).skip(n).limit(r).exec(function(e,n){t.send(n)})}),e.post("/api/upload/:id",function(e,t){return n.readFile(e.files.file.path,"binary",function(i,s){r.resize({srcData:s,height:180,quality:1},function(r,i,s){n.writeFileSync("temp.jpg",i,"binary");var a=n.readFileSync("temp.jpg");if(r)throw r;return u.findById(e.params.id,function(e,n){n.Avatar.data=o.fromByteArray(a),n.Avatar.contentType="image/png",n.save(function(e){t.send(n)})})})}),t.send({result:"ok"})}),e.post("/api/users",function(e,t){var n;return n=new u({text:e.body.text,done:e.body.done,order:e.body.order}),n.save(function(e){}),t.send(n)}),e.get("/api/users/:id",function(e,t){return u.find({_id:e.params.id}).select("Name Email Age Avatar").exec(function(e,n){n.length==1?t.send(n[0]):t.json({err:"not found"})})}),e.put("/api/users/:id",function(e,t){return u.findById(e.params.id,function(n,r){r.Age=e.body.Age,r.Name=e.body.Name,r.Email=e.body.Email,r.save(function(e){t.send(r)})})}),e.delete("/api/users/:id",function(e,t){return u.findById(e.params.id,function(e,t){return t.remove(function(e){})})})};